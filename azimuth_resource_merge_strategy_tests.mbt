// Azimuth Resource Merge Strategy Test Suite
// èµ„æºåˆå¹¶ç­–ç•¥æµ‹è¯•ç”¨ä¾‹ï¼Œä¸“æ³¨äºèµ„æºå±æ€§çš„åˆå¹¶ç­–ç•¥ï¼ŒåŒ…æ‹¬å†²çªè§£å†³ã€ä¼˜å…ˆçº§å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶

test "åŸºæœ¬èµ„æºå±æ€§åˆå¹¶æµ‹è¯•" {
  // åˆ›å»ºåŸºç¡€èµ„æº
  let base_resource = azimuth::Resource::new()
  
  // åˆ›å»ºå¸¦æœ‰å±æ€§çš„èµ„æº
  let base_attrs = [
    ("service.name", StringValue("azimuth-service")),
    ("service.version", StringValue("1.0.0")),
    ("service.instance.id", StringValue("instance-123")),
    ("host.name", StringValue("server-01")),
    ("os.type", StringValue("linux"))
  ]
  
  let base_resource_with_attrs = azimuth::Resource::with_attributes(base_resource, base_attrs)
  
  // åˆ›å»ºè¦†ç›–èµ„æº
  let override_resource = azimuth::Resource::new()
  
  let override_attrs = [
    ("service.name", StringValue("azimuth-service-updated")),  // è¦†ç›–ç°æœ‰å±æ€§
    ("service.version", StringValue("1.1.0")),                 // è¦†ç›–ç°æœ‰å±æ€§
    ("deployment.environment", StringValue("production")),    // æ–°å±æ€§
    ("host.name", StringValue("server-01-updated")),          // è¦†ç›–ç°æœ‰å±æ€§
    ("custom.attribute", StringValue("custom-value"))         // æ–°å±æ€§
  ]
  
  let override_resource_with_attrs = azimuth::Resource::with_attributes(override_resource, override_attrs)
  
  // åˆå¹¶èµ„æº
  let merged_resource = azimuth::Resource::merge(base_resource_with_attrs, override_resource_with_attrs)
  
  // éªŒè¯åˆå¹¶ç»“æœï¼ˆæ ¹æ®å®ç°ï¼Œè¦†ç›–èµ„æºåº”è¯¥ä¼˜å…ˆï¼‰
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.name"), Some(StringValue("azimuth-service-updated")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.version"), Some(StringValue("1.1.0")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "deployment.environment"), Some(StringValue("production")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "host.name"), Some(StringValue("server-01-updated")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "custom.attribute"), Some(StringValue("custom-value")))
  
  // éªŒè¯æœªè¢«è¦†ç›–çš„å±æ€§
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.instance.id"), Some(StringValue("instance-123")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "os.type"), Some(StringValue("linux")))
  
  // éªŒè¯ä¸å­˜åœ¨çš„å±æ€§
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "non.existent.attribute"), None)
}

test "å¤šçº§èµ„æºåˆå¹¶å’Œä¼˜å…ˆçº§æµ‹è¯•" {
  // åˆ›å»ºä¸‰çº§èµ„æºï¼šç³»ç»Ÿçº§ -> åº”ç”¨çº§ -> å®ä¾‹çº§
  
  // ç³»ç»Ÿçº§èµ„æº
  let system_resource = azimuth::Resource::new()
  let system_attrs = [
    ("os.type", StringValue("linux")),
    ("os.version", StringValue("ubuntu-20.04")),
    ("host.name", StringValue("prod-server-01")),
    ("cloud.provider", StringValue("aws")),
    ("cloud.region", StringValue("us-west-2"))
  ]
  
  let system_resource_with_attrs = azimuth::Resource::with_attributes(system_resource, system_attrs)
  
  // åº”ç”¨çº§èµ„æº
  let app_resource = azimuth::Resource::new()
  let app_attrs = [
    ("service.name", StringValue("user-service")),
    ("service.version", StringValue("2.0.0")),
    ("service.namespace", StringValue("production")),
    ("host.name", StringValue("container-001")),  // è¦†ç›–ç³»ç»Ÿçº§host.name
    ("service.language", StringValue("moonbit"))
  ]
  
  let app_resource_with_attrs = azimuth::Resource::with_attributes(app_resource, app_attrs)
  
  // å®ä¾‹çº§èµ„æº
  let instance_resource = azimuth::Resource::new()
  let instance_attrs = [
    ("service.instance.id", StringValue("pod-xyz-123")),
    ("service.version", StringValue("2.0.1")),  // è¦†ç›–åº”ç”¨çº§ç‰ˆæœ¬
    ("deployment.environment", StringValue("prod")),
    ("host.name", StringValue("pod-xyz-123")),  // å†æ¬¡è¦†ç›–host.name
    ("custom.pod.ip", StringValue("10.0.1.100"))
  ]
  
  let instance_resource_with_attrs = azimuth::Resource::with_attributes(instance_resource, instance_attrs)
  
  // å¤šçº§åˆå¹¶ï¼šç³»ç»Ÿ -> åº”ç”¨ -> å®ä¾‹
  let system_app_merged = azimuth::Resource::merge(system_resource_with_attrs, app_resource_with_attrs)
  let final_merged = azimuth::Resource::merge(system_app_merged, instance_resource_with_attrs)
  
  // éªŒè¯æœ€ç»ˆåˆå¹¶ç»“æœï¼ˆå®ä¾‹çº§ä¼˜å…ˆçº§æœ€é«˜ï¼‰
  assert_eq(azimuth::Resource::get_attribute(final_merged, "service.name"), Some(StringValue("user-service")))
  assert_eq(azimuth::Resource::get_attribute(final_merged, "service.version"), Some(StringValue("2.0.1")))  // å®ä¾‹çº§è¦†ç›–
  assert_eq(azimuth::Resource::get_attribute(final_merged, "service.instance.id"), Some(StringValue("pod-xyz-123")))
  assert_eq(azimuth::Resource::get_attribute(final_merged, "service.namespace"), Some(StringValue("production")))
  assert_eq(azimuth::Resource::get_attribute(final_merged, "service.language"), Some(StringValue("moonbit")))
  assert_eq(azimuth::Resource::get_attribute(final_merged, "deployment.environment"), Some(StringValue("prod")))
  assert_eq(azimuth::Resource::get_attribute(final_merged, "host.name"), Some(StringValue("pod-xyz-123")))  // å®ä¾‹çº§è¦†ç›–
  assert_eq(azimuth::Resource::get_attribute(final_merged, "custom.pod.ip"), Some(StringValue("10.0.1.100")))
  
  // éªŒè¯ç³»ç»Ÿçº§å±æ€§ï¼ˆæœªè¢«è¦†ç›–çš„ï¼‰
  assert_eq(azimuth::Resource::get_attribute(final_merged, "os.type"), Some(StringValue("linux")))
  assert_eq(azimuth::Resource::get_attribute(final_merged, "os.version"), Some(StringValue("ubuntu-20.04")))
  assert_eq(azimuth::Resource::get_attribute(final_merged, "cloud.provider"), Some(StringValue("aws")))
  assert_eq(azimuth::Resource::get_attribute(final_merged, "cloud.region"), Some(StringValue("us-west-2")))
}

test "ä¸åŒç±»å‹å±æ€§å€¼çš„åˆå¹¶æµ‹è¯•" {
  // åˆ›å»ºåŒ…å«ä¸åŒç±»å‹å±æ€§å€¼çš„èµ„æº
  let base_resource = azimuth::Resource::new()
  
  let base_attrs = [
    ("string.attr", StringValue("base_string")),
    ("int.attr", IntValue(42)),
    ("float.attr", FloatValue(3.14)),
    ("bool.attr", BoolValue(true)),
    ("string.array.attr", ArrayStringValue(["base1", "base2", "base3"])),
    ("int.array.attr", ArrayIntValue([1, 2, 3]))
  ]
  
  let base_resource_with_attrs = azimuth::Resource::with_attributes(base_resource, base_attrs)
  
  // åˆ›å»ºè¦†ç›–èµ„æºï¼ŒåŒ…å«ä¸åŒç±»å‹çš„å€¼
  let override_resource = azimuth::Resource::new()
  
  let override_attrs = [
    ("string.attr", StringValue("override_string")),
    ("int.attr", IntValue(100)),
    ("float.attr", FloatValue(2.71)),
    ("bool.attr", BoolValue(false)),
    ("string.array.attr", ArrayStringValue(["override1", "override2"])),
    ("int.array.attr", ArrayIntValue([10, 20, 30, 40]))
  ]
  
  let override_resource_with_attrs = azimuth::Resource::with_attributes(override_resource, override_attrs)
  
  // åˆå¹¶èµ„æº
  let merged_resource = azimuth::Resource::merge(base_resource_with_attrs, override_resource_with_attrs)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "string.attr"), Some(StringValue("override_string")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "int.attr"), Some(IntValue(100)))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "float.attr"), Some(FloatValue(2.71)))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "bool.attr"), Some(BoolValue(false)))
  
  match azimuth::Resource::get_attribute(merged_resource, "string.array.attr") {
    Some(ArrayStringValue(arr)) => {
      assert_eq(arr.length(), 2)
      assert_eq(arr[0], "override1")
      assert_eq(arr[1], "override2")
    }
    _ => assert_true(false)
  }
  
  match azimuth::Resource::get_attribute(merged_resource, "int.array.attr") {
    Some(ArrayIntValue(arr)) => {
      assert_eq(arr.length(), 4)
      assert_eq(arr[0], 10)
      assert_eq(arr[1], 20)
      assert_eq(arr[2], 30)
      assert_eq(arr[3], 40)
    }
    _ => assert_true(false)
  }
}

test "è¾¹ç•Œæ¡ä»¶å’Œç‰¹æ®Šå±æ€§å€¼åˆå¹¶æµ‹è¯•" {
  // åˆ›å»ºåŒ…å«è¾¹ç•Œå€¼çš„èµ„æº
  let base_resource = azimuth::Resource::new()
  
  let base_attrs = [
    ("empty.string", StringValue("")),
    ("unicode.string", StringValue("Unicodeæµ‹è¯•_ğŸš€_ğŸŒŸ")),
    ("special.chars", StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?")),
    ("long.string", StringValue("è¿™æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œç”¨äºæµ‹è¯•é•¿å­—ç¬¦ä¸²çš„åˆå¹¶å¤„ç†èƒ½åŠ›ã€‚" + 
      "é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿å­—ç¬¦ä¸²å¤„ç†ã€‚é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿å­—ç¬¦ä¸²å¤„ç†ã€‚" +
      "é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿å­—ç¬¦ä¸²å¤„ç†ã€‚é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿å­—ç¬¦ä¸²å¤„ç†ã€‚")),
    ("max.int", IntValue(2147483647)),
    ("min.int", IntValue(-2147483648)),
    ("zero.float", FloatValue(0.0)),
    ("negative.float", FloatValue(-3.14159)),
    ("true.bool", BoolValue(true)),
    ("false.bool", BoolValue(false)),
    ("empty.string.array", ArrayStringValue([])),
    ("empty.int.array", ArrayIntValue([])),
    ("single.string.array", ArrayStringValue(["single"])),
    ("single.int.array", ArrayIntValue([42]))
  ]
  
  let base_resource_with_attrs = azimuth::Resource::with_attributes(base_resource, base_attrs)
  
  // åˆ›å»ºè¦†ç›–èµ„æº
  let override_resource = azimuth::Resource::new()
  
  let override_attrs = [
    ("empty.string", StringValue("not_empty")),
    ("unicode.string", StringValue("Unicodeè¦†ç›–_ğŸ”¥_ğŸ’¡")),
    ("special.chars", StringValue("è¦†ç›–ç‰¹æ®Šå­—ç¬¦")),
    ("long.string", StringValue("è¦†ç›–çš„é•¿å­—ç¬¦ä¸²")),
    ("max.int", IntValue(0)),
    ("min.int", IntValue(0)),
    ("zero.float", FloatValue(1.0)),
    ("negative.float", FloatValue(0.0)),
    ("true.bool", BoolValue(false)),
    ("false.bool", BoolValue(true)),
    ("empty.string.array", ArrayStringValue(["not_empty"])),
    ("empty.int.array", ArrayIntValue([1])),
    ("single.string.array", ArrayStringValue([])),
    ("single.int.array", ArrayIntValue([]))
  ]
  
  let override_resource_with_attrs = azimuth::Resource::with_attributes(override_resource, override_attrs)
  
  // åˆå¹¶èµ„æº
  let merged_resource = azimuth::Resource::merge(base_resource_with_attrs, override_resource_with_attrs)
  
  // éªŒè¯è¾¹ç•Œå€¼åˆå¹¶ç»“æœ
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "empty.string"), Some(StringValue("not_empty")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "unicode.string"), Some(StringValue("Unicodeè¦†ç›–_ğŸ”¥_ğŸ’¡")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "special.chars"), Some(StringValue("è¦†ç›–ç‰¹æ®Šå­—ç¬¦")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "long.string"), Some(StringValue("è¦†ç›–çš„é•¿å­—ç¬¦ä¸²")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "max.int"), Some(IntValue(0)))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "min.int"), Some(IntValue(0)))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "zero.float"), Some(FloatValue(1.0)))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "negative.float"), Some(FloatValue(0.0)))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "true.bool"), Some(BoolValue(false)))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "false.bool"), Some(BoolValue(true)))
  
  match azimuth::Resource::get_attribute(merged_resource, "empty.string.array") {
    Some(ArrayStringValue(arr)) => {
      assert_eq(arr.length(), 1)
      assert_eq(arr[0], "not_empty")
    }
    _ => assert_true(false)
  }
  
  match azimuth::Resource::get_attribute(merged_resource, "empty.int.array") {
    Some(ArrayIntValue(arr)) => {
      assert_eq(arr.length(), 1)
      assert_eq(arr[0], 1)
    }
    _ => assert_true(false)
  }
  
  match azimuth::Resource::get_attribute(merged_resource, "single.string.array") {
    Some(ArrayStringValue(arr)) => assert_eq(arr.length(), 0)
    _ => assert_true(false)
  }
  
  match azimuth::Resource::get_attribute(merged_resource, "single.int.array") {
    Some(ArrayIntValue(arr)) => assert_eq(arr.length(), 0)
    _ => assert_true(false)
  }
}

test "ç©ºèµ„æºå’Œå¤§è§„æ¨¡å±æ€§åˆå¹¶æµ‹è¯•" {
  // æµ‹è¯•ç©ºèµ„æºåˆå¹¶
  let empty_resource1 = azimuth::Resource::new()
  let empty_resource2 = azimuth::Resource::new()
  
  let empty_attrs1: Array[(String, AttributeValue)] = []
  let empty_attrs2: Array[(String, AttributeValue)] = []
  
  let empty_resource1_with_attrs = azimuth::Resource::with_attributes(empty_resource1, empty_attrs1)
  let empty_resource2_with_attrs = azimuth::Resource::with_attributes(empty_resource2, empty_attrs2)
  
  let merged_empty = azimuth::Resource::merge(empty_resource1_with_attrs, empty_resource2_with_attrs)
  
  // éªŒè¯ç©ºèµ„æºåˆå¹¶
  assert_eq(azimuth::Resource::get_attribute(merged_empty, "any.key"), None)
  
  // æµ‹è¯•ç©ºèµ„æºä¸éç©ºèµ„æºåˆå¹¶
  let non_empty_resource = azimuth::Resource::new()
  let non_empty_attrs = [
    ("key1", StringValue("value1")),
    ("key2", IntValue(42)),
    ("key3", FloatValue(3.14))
  ]
  
  let non_empty_resource_with_attrs = azimuth::Resource::with_attributes(non_empty_resource, non_empty_attrs)
  
  let merged_empty_nonempty = azimuth::Resource::merge(empty_resource1_with_attrs, non_empty_resource_with_attrs)
  let merged_nonempty_empty = azimuth::Resource::merge(non_empty_resource_with_attrs, empty_resource1_with_attrs)
  
  // éªŒè¯ç©ºèµ„æºä¸éç©ºèµ„æºåˆå¹¶
  assert_eq(azimuth::Resource::get_attribute(merged_empty_nonempty, "key1"), Some(StringValue("value1")))
  assert_eq(azimuth::Resource::get_attribute(merged_empty_nonempty, "key2"), Some(IntValue(42)))
  assert_eq(azimuth::Resource::get_attribute(merged_empty_nonempty, "key3"), Some(FloatValue(3.14)))
  
  assert_eq(azimuth::Resource::get_attribute(merged_nonempty_empty, "key1"), Some(StringValue("value1")))
  assert_eq(azimuth::Resource::get_attribute(merged_nonempty_empty, "key2"), Some(IntValue(42)))
  assert_eq(azimuth::Resource::get_attribute(merged_nonempty_empty, "key3"), Some(FloatValue(3.14)))
  
  // æµ‹è¯•å¤§è§„æ¨¡å±æ€§åˆå¹¶
  let large_resource1 = azimuth::Resource::new()
  let large_resource2 = azimuth::Resource::new()
  
  let large_attrs1 = [
    for i in range(0, 100) {
      ("large_key_" + i.to_string(), StringValue("large_value_" + i.to_string()))
    }
  ]
  
  let large_attrs2 = [
    for i in range(50, 150) {
      ("large_key_" + i.to_string(), StringValue("override_value_" + i.to_string()))
    }
  ]
  
  let large_resource1_with_attrs = azimuth::Resource::with_attributes(large_resource1, large_attrs1)
  let large_resource2_with_attrs = azimuth::Resource::with_attributes(large_resource2, large_attrs2)
  
  let merged_large = azimuth::Resource::merge(large_resource1_with_attrs, large_resource2_with_attrs)
  
  // éªŒè¯å¤§è§„æ¨¡åˆå¹¶ç»“æœ
  // å‰50ä¸ªé”®åº”è¯¥ä¿æŒåŸå€¼
  for i in range(0, 50) {
    let key = "large_key_" + i.to_string()
    let expected_value = "large_value_" + i.to_string()
    assert_eq(azimuth::Resource::get_attribute(merged_large, key), Some(StringValue(expected_value)))
  }
  
  // 50-149çš„é”®åº”è¯¥è¢«è¦†ç›–
  for i in range(50, 150) {
    let key = "large_key_" + i.to_string()
    let expected_value = "override_value_" + i.to_string()
    assert_eq(azimuth::Resource::get_attribute(merged_large, key), Some(StringValue(expected_value)))
  }
  
  // éªŒè¯æ•°ç»„é•¿åº¦
  assert_eq(large_attrs1.length(), 100)
  assert_eq(large_attrs2.length(), 100)
}
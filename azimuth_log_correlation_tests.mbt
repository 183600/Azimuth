// Azimuth Log Correlation Test Suite
// æ—¥å¿—å…³è”æ€§æµ‹è¯•ç”¨ä¾‹ï¼Œä¸“æ³¨äºæ—¥å¿—è®°å½•ä¸è¿½è¸ªä¸Šä¸‹æ–‡çš„å…³è”æ€§ï¼Œä»¥åŠæ—¥å¿—çš„ä¸¥é‡çº§åˆ«å’Œæ—¶é—´æˆ³å¤„ç†

test "æ—¥å¿—è®°å½•ä¸è¿½è¸ªä¸Šä¸‹æ–‡çš„å…³è”æ€§æµ‹è¯•" {
  // åˆ›å»ºLoggerProviderå’ŒLogger
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "correlation_test_logger")
  
  // åˆ›å»ºè¿½è¸ªä¸Šä¸‹æ–‡
  let trace_id = "1234567890abcdef1234567890abcdef"
  let span_id = "1234567890abcdef"
  
  // åˆ›å»ºå¸¦æœ‰è¿½è¸ªä¸Šä¸‹æ–‡çš„æ—¥å¿—è®°å½•
  let trace_log_record = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("å¤„ç†ç”¨æˆ·è¯·æ±‚å¼€å§‹"),
    None,  // attributes
    Some(1735689600000000000L),  // timestamp
    Some(1735689600000000000L),  // observed_timestamp
    Some(trace_id),
    Some(span_id),
    None   // context
  )
  
  // éªŒè¯æ—¥å¿—è®°å½•çš„è¿½è¸ªå…³è”
  assert_eq(azimuth::LogRecord::severity_number(trace_log_record), azimuth::Info)
  assert_eq(azimuth::LogRecord::body(trace_log_record), Some("å¤„ç†ç”¨æˆ·è¯·æ±‚å¼€å§‹"))
  assert_eq(azimuth::LogRecord::trace_id(trace_log_record), Some(trace_id))
  assert_eq(azimuth::LogRecord::span_id(trace_log_record), Some(span_id))
  
  // åˆ›å»ºå¤šä¸ªç›¸å…³æ—¥å¿—è®°å½•
  let log_record1 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("éªŒè¯ç”¨æˆ·æƒé™"),
    None,
    Some(1735689600000000000L),
    Some(1735689600000000000L),
    Some(trace_id),
    Some(span_id),
    None
  )
  
  let log_record2 = azimuth::LogRecord::new_with_context(
    azimuth::Debug,
    Some("æŸ¥è¯¢æ•°æ®åº“"),
    None,
    Some(1735689600000001000L),
    Some(1735689600000001000L),
    Some(trace_id),
    Some(span_id),
    None
  )
  
  let log_record3 = azimuth::LogRecord::new_with_context(
    azimuth::Warn,
    Some("å“åº”æ—¶é—´è¾ƒé•¿"),
    None,
    Some(1735689600000005000L),
    Some(1735689600000005000L),
    Some(trace_id),
    Some(span_id),
    None
  )
  
  let log_record4 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("å¤„ç†ç”¨æˆ·è¯·æ±‚å®Œæˆ"),
    None,
    Some(1735689600000010000L),
    Some(1735689600000010000L),
    Some(trace_id),
    Some(span_id),
    None
  )
  
  // éªŒè¯æ‰€æœ‰æ—¥å¿—è®°å½•çš„è¿½è¸ªå…³è”
  let log_records = [log_record1, log_record2, log_record3, log_record4]
  for record in log_records {
    assert_eq(azimuth::LogRecord::trace_id(record), Some(trace_id))
    assert_eq(azimuth::LogRecord::span_id(record), Some(span_id))
  }
  
  // éªŒè¯æ—¥å¿—ä¸¥é‡çº§åˆ«
  assert_eq(azimuth::LogRecord::severity_number(log_record1), azimuth::Info)
  assert_eq(azimuth::LogRecord::severity_number(log_record2), azimuth::Debug)
  assert_eq(azimuth::LogRecord::severity_number(log_record3), azimuth::Warn)
  assert_eq(azimuth::LogRecord::severity_number(log_record4), azimuth::Info)
  
  // å‘å‡ºæ—¥å¿—è®°å½•
  azimuth::Logger::emit(logger, trace_log_record)
  azimuth::Logger::emit(logger, log_record1)
  azimuth::Logger::emit(logger, log_record2)
  azimuth::Logger::emit(logger, log_record3)
  azimuth::Logger::emit(logger, log_record4)
}

test "ä¸åŒä¸¥é‡çº§åˆ«æ—¥å¿—çš„åˆ›å»ºå’Œå¤„ç†æµ‹è¯•" {
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "severity_test_logger")
  
  // åˆ›å»ºä¸åŒä¸¥é‡çº§åˆ«çš„æ—¥å¿—è®°å½•
  let trace_log = azimuth::LogRecord::new(azimuth::Trace, "è·Ÿè¸ªä¿¡æ¯ï¼šè¿›å…¥å‡½æ•°")
  let debug_log = azimuth::LogRecord::new(azimuth::Debug, "è°ƒè¯•ä¿¡æ¯ï¼šå˜é‡å€¼ = 42")
  let info_log = azimuth::LogRecord::new(azimuth::Info, "ä¿¡æ¯ï¼šç”¨æˆ·ç™»å½•æˆåŠŸ")
  let warn_log = azimuth::LogRecord::new(azimuth::Warn, "è­¦å‘Šï¼šå†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%")
  let error_log = azimuth::LogRecord::new(azimuth::Error, "é”™è¯¯ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥")
  let fatal_log = azimuth::LogRecord::new(azimuth::Fatal, "è‡´å‘½é”™è¯¯ï¼šç³»ç»Ÿæ— æ³•å¯åŠ¨")
  
  // éªŒè¯æ—¥å¿—ä¸¥é‡çº§åˆ«
  assert_eq(azimuth::LogRecord::severity_number(trace_log), azimuth::Trace)
  assert_eq(azimuth::LogRecord::severity_number(debug_log), azimuth::Debug)
  assert_eq(azimuth::LogRecord::severity_number(info_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::severity_number(warn_log), azimuth::Warn)
  assert_eq(azimuth::LogRecord::severity_number(error_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::severity_number(fatal_log), azimuth::Fatal)
  
  // éªŒè¯æ—¥å¿—å†…å®¹
  assert_eq(azimuth::LogRecord::body(trace_log), Some("è·Ÿè¸ªä¿¡æ¯ï¼šè¿›å…¥å‡½æ•°"))
  assert_eq(azimuth::LogRecord::body(debug_log), Some("è°ƒè¯•ä¿¡æ¯ï¼šå˜é‡å€¼ = 42"))
  assert_eq(azimuth::LogRecord::body(info_log), Some("ä¿¡æ¯ï¼šç”¨æˆ·ç™»å½•æˆåŠŸ"))
  assert_eq(azimuth::LogRecord::body(warn_log), Some("è­¦å‘Šï¼šå†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%"))
  assert_eq(azimuth::LogRecord::body(error_log), Some("é”™è¯¯ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥"))
  assert_eq(azimuth::LogRecord::body(fatal_log), Some("è‡´å‘½é”™è¯¯ï¼šç³»ç»Ÿæ— æ³•å¯åŠ¨"))
  
  // åˆ›å»ºå¸¦æœ‰å±æ€§çš„æ—¥å¿—è®°å½•
  let log_attributes = azimuth::Attributes::new()
  let log_with_attrs = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯"),
    Some(log_attributes),
    Some(1735689600000000000L),
    Some(1735689600000000000L),
    Some("error_trace_id"),
    Some("error_span_id"),
    None
  )
  
  assert_eq(azimuth::LogRecord::severity_number(log_with_attrs), azimuth::Error)
  assert_eq(azimuth::LogRecord::body(log_with_attrs), Some("å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯"))
  
  // å‘å‡ºæ‰€æœ‰æ—¥å¿—è®°å½•
  azimuth::Logger::emit(logger, trace_log)
  azimuth::Logger::emit(logger, debug_log)
  azimuth::Logger::emit(logger, info_log)
  azimuth::Logger::emit(logger, warn_log)
  azimuth::Logger::emit(logger, error_log)
  azimuth::Logger::emit(logger, fatal_log)
  azimuth::Logger::emit(logger, log_with_attrs)
}

test "æ—¥å¿—æ—¶é—´æˆ³å’Œæ—¶åºæ€§æµ‹è¯•" {
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "timestamp_test_logger")
  
  // åˆ›å»ºæ—¶é’Ÿ
  let clock = azimuth::Clock::system()
  
  // è·å–å½“å‰æ—¶é—´æˆ³
  let base_timestamp = azimuth::Clock::now_unix_nanos(clock)
  
  // åˆ›å»ºå¸¦æœ‰æ—¶é—´æˆ³çš„æ—¥å¿—è®°å½•
  let log1 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("æ“ä½œå¼€å§‹"),
    None,
    Some(base_timestamp),
    Some(base_timestamp),
    None,
    None,
    None
  )
  
  let log2 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("æ“ä½œè¿›è¡Œä¸­"),
    None,
    Some(base_timestamp + 1000000L),  // 1mså
    Some(base_timestamp + 1000000L),
    None,
    None,
    None
  )
  
  let log3 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("æ“ä½œç»“æŸ"),
    None,
    Some(base_timestamp + 2000000L),  // 2mså
    Some(base_timestamp + 2000000L),
    None,
    None,
    None
  )
  
  // éªŒè¯æ—¶é—´æˆ³çš„æ—¶åºæ€§
  assert_eq(azimuth::LogRecord::body(log1), Some("æ“ä½œå¼€å§‹"))
  assert_eq(azimuth::LogRecord::body(log2), Some("æ“ä½œè¿›è¡Œä¸­"))
  assert_eq(azimuth::LogRecord::body(log3), Some("æ“ä½œç»“æŸ"))
  
  // éªŒè¯æ—¶é—´æˆ³é€’å¢
  let timestamp1 = azimuth::LogRecord::timestamp(log1)
  let timestamp2 = azimuth::LogRecord::timestamp(log2)
  let timestamp3 = azimuth::LogRecord::timestamp(log3)
  
  match (timestamp1, timestamp2, timestamp3) {
    (Some(ts1), Some(ts2), Some(ts3)) => {
      assert_true(ts1 < ts2)
      assert_true(ts2 < ts3)
      assert_true(ts1 < ts3)
    }
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ç›¸åŒæ—¶é—´æˆ³çš„æ—¥å¿—è®°å½•
  let same_time_log1 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("åŒæ—¶å‘ç”Ÿçš„äº‹ä»¶1"),
    None,
    Some(base_timestamp + 3000000L),
    Some(base_timestamp + 3000000L),
    None,
    None,
    None
  )
  
  let same_time_log2 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("åŒæ—¶å‘ç”Ÿçš„äº‹ä»¶2"),
    None,
    Some(base_timestamp + 3000000L),
    Some(base_timestamp + 3000000L),
    None,
    None,
    None
  )
  
  // éªŒè¯ç›¸åŒæ—¶é—´æˆ³
  let same_timestamp1 = azimuth::LogRecord::timestamp(same_time_log1)
  let same_timestamp2 = azimuth::LogRecord::timestamp(same_time_log2)
  
  match (same_timestamp1, same_timestamp2) {
    (Some(ts1), Some(ts2)) => assert_eq(ts1, ts2)
    _ => assert_true(false)
  }
  
  // å‘å‡ºæ‰€æœ‰æ—¥å¿—è®°å½•
  azimuth::Logger::emit(logger, log1)
  azimuth::Logger::emit(logger, log2)
  azimuth::Logger::emit(logger, log3)
  azimuth::Logger::emit(logger, same_time_log1)
  azimuth::Logger::emit(logger, same_time_log2)
}

test "è·¨æœåŠ¡æ—¥å¿—å…³è”æ€§æµ‹è¯•" {
  // åˆ›å»ºå¤šä¸ªæœåŠ¡çš„Logger
  let logger_provider = azimuth::LoggerProvider::default()
  
  let gateway_logger = azimuth::LoggerProvider::get_logger(logger_provider, "gateway_service")
  let auth_logger = azimuth::LoggerProvider::get_logger(logger_provider, "auth_service")
  let user_logger = azimuth::LoggerProvider::get_logger(logger_provider, "user_service")
  let order_logger = azimuth::LoggerProvider::get_logger(logger_provider, "order_service")
  
  // å…±äº«çš„è¿½è¸ªID
  let global_trace_id = "abcdef1234567890abcdef1234567890"
  
  // ç½‘å…³æœåŠ¡çš„æ—¥å¿—
  let gateway_log1 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("æ¥æ”¶ç”¨æˆ·è¯·æ±‚"),
    None,
    Some(1735689600000000000L),
    Some(1735689600000000000L),
    Some(global_trace_id),
    Some("gateway_span_1"),
    None
  )
  
  let gateway_log2 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("è½¬å‘è¯·æ±‚åˆ°è®¤è¯æœåŠ¡"),
    None,
    Some(1735689600000001000L),
    Some(1735689600000001000L),
    Some(global_trace_id),
    Some("gateway_span_1"),
    None
  )
  
  // è®¤è¯æœåŠ¡çš„æ—¥å¿—
  let auth_log1 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("æ¥æ”¶è®¤è¯è¯·æ±‚"),
    None,
    Some(1735689600000002000L),
    Some(1735689600000002000L),
    Some(global_trace_id),
    Some("auth_span_1"),
    None
  )
  
  let auth_log2 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("ç”¨æˆ·è®¤è¯æˆåŠŸ"),
    None,
    Some(1735689600000005000L),
    Some(1735689600000005000L),
    Some(global_trace_id),
    Some("auth_span_1"),
    None
  )
  
  // ç”¨æˆ·æœåŠ¡çš„æ—¥å¿—
  let user_log1 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯"),
    None,
    Some(1735689600000003000L),
    Some(1735689600000003000L),
    Some(global_trace_id),
    Some("user_span_1"),
    None
  )
  
  let user_log2 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("è¿”å›ç”¨æˆ·ä¿¡æ¯"),
    None,
    Some(1735689600000004000L),
    Some(1735689600000004000L),
    Some(global_trace_id),
    Some("user_span_1"),
    None
  )
  
  // è®¢å•æœåŠ¡çš„æ—¥å¿—
  let order_log1 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("åˆ›å»ºè®¢å•"),
    None,
    Some(1735689600000006000L),
    Some(1735689600000006000L),
    Some(global_trace_id),
    Some("order_span_1"),
    None
  )
  
  let order_log2 = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("åº“å­˜ä¸è¶³ï¼Œè®¢å•åˆ›å»ºå¤±è´¥"),
    None,
    Some(1735689600000008000L),
    Some(1735689600000008000L),
    Some(global_trace_id),
    Some("order_span_1"),
    None
  )
  
  // éªŒè¯æ‰€æœ‰æ—¥å¿—éƒ½æœ‰ç›¸åŒçš„è¿½è¸ªID
  let all_logs = [
    gateway_log1, gateway_log2,
    auth_log1, auth_log2,
    user_log1, user_log2,
    order_log1, order_log2
  ]
  
  for log in all_logs {
    assert_eq(azimuth::LogRecord::trace_id(log), Some(global_trace_id))
  }
  
  // éªŒè¯ä¸åŒæœåŠ¡çš„Span IDä¸åŒ
  assert_eq(azimuth::LogRecord::span_id(gateway_log1), Some("gateway_span_1"))
  assert_eq(azimuth::LogRecord::span_id(auth_log1), Some("auth_span_1"))
  assert_eq(azimuth::LogRecord::span_id(user_log1), Some("user_span_1"))
  assert_eq(azimuth::LogRecord::span_id(order_log1), Some("order_span_1"))
  
  // éªŒè¯æ—¥å¿—ä¸¥é‡çº§åˆ«
  assert_eq(azimuth::LogRecord::severity_number(gateway_log1), azimuth::Info)
  assert_eq(azimuth::LogRecord::severity_number(auth_log2), azimuth::Info)
  assert_eq(azimuth::LogRecord::severity_number(user_log2), azimuth::Info)
  assert_eq(azimuth::LogRecord::severity_number(order_log2), azimuth::Error)
  
  // å‘å‡ºæ‰€æœ‰æ—¥å¿—è®°å½•
  azimuth::Logger::emit(gateway_logger, gateway_log1)
  azimuth::Logger::emit(gateway_logger, gateway_log2)
  azimuth::Logger::emit(auth_logger, auth_log1)
  azimuth::Logger::emit(auth_logger, auth_log2)
  azimuth::Logger::emit(user_logger, user_log1)
  azimuth::Logger::emit(user_logger, user_log2)
  azimuth::Logger::emit(order_logger, order_log1)
  azimuth::Logger::emit(order_logger, order_log2)
}

test "æ—¥å¿—å±æ€§å’Œç»“æ„åŒ–æ•°æ®æµ‹è¯•" {
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "structured_log_test_logger")
  
  // åˆ›å»ºå¸¦æœ‰å„ç§å±æ€§çš„æ—¥å¿—è®°å½•
  let log_attributes = azimuth::Attributes::new()
  
  let structured_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("å¤„ç†HTTPè¯·æ±‚"),
    Some(log_attributes),
    Some(1735689600000000000L),
    Some(1735689600000000000L),
    Some("structured_trace_id"),
    Some("structured_span_id"),
    None
  )
  
  // éªŒè¯ç»“æ„åŒ–æ—¥å¿—çš„åŸºæœ¬å±æ€§
  assert_eq(azimuth::LogRecord::severity_number(structured_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::body(structured_log), Some("å¤„ç†HTTPè¯·æ±‚"))
  assert_eq(azimuth::LogRecord::trace_id(structured_log), Some("structured_trace_id"))
  assert_eq(azimuth::LogRecord::span_id(structured_log), Some("structured_span_id"))
  
  // åˆ›å»ºå¸¦æœ‰å¤æ‚å†…å®¹çš„æ—¥å¿—è®°å½•
  let complex_log = azimuth::LogRecord::new_with_context(
    azimuth::Warn,
    Some("å¤„ç†å¤æ‚ä¸šåŠ¡é€»è¾‘æ—¶é‡åˆ°å¼‚å¸¸"),
    None,
    Some(1735689600000000000L),
    Some(1735689600000000000L),
    Some("complex_trace_id"),
    Some("complex_span_id"),
    None
  )
  
  // åˆ›å»ºåŒ…å«Unicodeå’Œç‰¹æ®Šå­—ç¬¦çš„æ—¥å¿—è®°å½•
  let unicode_log = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("å¤„ç†åŒ…å«Unicodeå­—ç¬¦çš„æ•°æ®æ—¶å‡ºé”™: ğŸš€ ğŸŒŸ ğŸ’¡ ğŸ”¥"),
    None,
    Some(1735689600000000000L),
    Some(1735689600000000000L),
    Some("unicode_trace_id"),
    Some("unicode_span_id"),
    None
  )
  
  // éªŒè¯Unicodeæ—¥å¿—
  assert_eq(azimuth::LogRecord::severity_number(unicode_log), azimuth::Error)
  match azimuth::LogRecord::body(unicode_log) {
    Some(body) => {
      assert_true(body.contains("ğŸš€"))
      assert_true(body.contains("ğŸŒŸ"))
      assert_true(body.contains("ğŸ’¡"))
      assert_true(body.contains("ğŸ”¥"))
    }
    None => assert_true(false)
  }
  
  // åˆ›å»ºåŒ…å«æ¢è¡Œç¬¦çš„æ—¥å¿—è®°å½•
  let multiline_log = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("å¤šè¡Œé”™è¯¯ä¿¡æ¯:
ç¬¬ä¸€è¡Œé”™è¯¯æè¿°
ç¬¬äºŒè¡Œé”™è¯¯æè¿°
ç¬¬ä¸‰è¡Œé”™è¯¯æè¿°"),
    None,
    Some(1735689600000000000L),
    Some(1735689600000000000L),
    Some("multiline_trace_id"),
    Some("multiline_span_id"),
    None
  )
  
  // éªŒè¯å¤šè¡Œæ—¥å¿—
  match azimuth::LogRecord::body(multiline_log) {
    Some(body) => {
      assert_true(body.contains("
"))
      assert_true(body.contains("ç¬¬ä¸€è¡Œé”™è¯¯æè¿°"))
      assert_true(body.contains("ç¬¬äºŒè¡Œé”™è¯¯æè¿°"))
      assert_true(body.contains("ç¬¬ä¸‰è¡Œé”™è¯¯æè¿°"))
    }
    None => assert_true(false)
  }
  
  // åˆ›å»ºç©ºå†…å®¹çš„æ—¥å¿—è®°å½•
  let empty_body_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    None,
    None,
    Some(1735689600000000000L),
    Some(1735689600000000000L),
    Some("empty_body_trace_id"),
    Some("empty_body_span_id"),
    None
  )
  
  // éªŒè¯ç©ºå†…å®¹æ—¥å¿—
  assert_eq(azimuth::LogRecord::severity_number(empty_body_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::body(empty_body_log), None)
  
  // å‘å‡ºæ‰€æœ‰æ—¥å¿—è®°å½•
  azimuth::Logger::emit(logger, structured_log)
  azimuth::Logger::emit(logger, complex_log)
  azimuth::Logger::emit(logger, unicode_log)
  azimuth::Logger::emit(logger, multiline_log)
  azimuth::Logger::emit(logger, empty_body_log)
}
// Azimuth Span Lifecycle Management Test Suite
// è·Ÿè¸ªç”Ÿå‘½å‘¨æœŸç®¡ç†æµ‹è¯•ç”¨ä¾‹ï¼Œä¸“æ³¨äºSpançš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€çŠ¶æ€è½¬æ¢å’Œäº‹ä»¶å¤„ç†

test "Spanå®Œæ•´ç”Ÿå‘½å‘¨æœŸæµ‹è¯•" {
  // åˆ›å»ºTracerå’ŒSpan
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "lifecycle_test_tracer")
  
  // åˆ›å»ºSpanä¸Šä¸‹æ–‡
  let trace_id = "1234567890abcdef1234567890abcdef"
  let span_id = "1234567890abcdef"
  let span_context = azimuth::SpanContext::new(trace_id, span_id, true, "")
  
  // åˆ›å»ºSpan
  let span = azimuth::Tracer::start_span(tracer, "main_operation")
  
  // éªŒè¯Spanåˆå§‹çŠ¶æ€
  assert_eq(azimuth::Span::name(span), "main_operation")
  assert_true(azimuth::Span::is_recording(span))
  assert_eq(azimuth::Span::kind(span), azimuth::Internal)
  assert_eq(azimuth::Span::status(span), azimuth::Unset)
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡
  let retrieved_context = azimuth::Span::span_context(span)
  assert_true(azimuth::SpanContext::is_valid(retrieved_context))
  assert_true(azimuth::SpanContext::is_sampled(retrieved_context))
  
  // è®¾ç½®SpançŠ¶æ€ä¸ºOk
  azimuth::Span::set_status(span, azimuth::Ok, Some("æ“ä½œæˆåŠŸå®Œæˆ"))
  assert_eq(azimuth::Span::status(span), azimuth::Ok)
  
  // æ·»åŠ äº‹ä»¶
  azimuth::Span::add_event(span, "operation_started", Some([
    ("step", StringValue("initialization")),
    ("timestamp", StringValue("2025-01-01T00:00:00Z"))
  ]))
  
  azimuth::Span::add_event(span, "operation_progress", Some([
    ("progress", StringValue("50%")),
    ("processed_items", IntValue(42))
  ]))
  
  // ç»“æŸSpan
  azimuth::Span::end(span)
  
  // éªŒè¯Spanç»“æŸåçš„çŠ¶æ€
  assert_eq(azimuth::Span::name(span), "main_operation")  // åç§°ä»ç„¶å¯è®¿é—®
  assert_eq(azimuth::Span::status(span), azimuth::Ok)     // çŠ¶æ€ä»ç„¶å¯è®¿é—®
}

test "SpanåµŒå¥—å’Œçˆ¶å­å…³ç³»æµ‹è¯•" {
  // åˆ›å»ºTracer
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "nested_span_test_tracer")
  
  // åˆ›å»ºæ ¹Span
  let root_span = azimuth::Tracer::start_span(tracer, "root_operation")
  
  // åˆ›å»ºå­Span1
  let child_span1 = azimuth::Tracer::start_span(tracer, "child_operation_1")
  azimuth::Span::set_status(child_span1, azimuth::Ok, Some("å­æ“ä½œ1æˆåŠŸ"))
  
  // åˆ›å»ºå­Span2
  let child_span2 = azimuth::Tracer::start_span(tracer, "child_operation_2")
  azimuth::Span::set_status(child_span2, azimuth::Ok, Some("å­æ“ä½œ2æˆåŠŸ"))
  
  // åˆ›å»ºå­™Span
  let grandchild_span = azimuth::Tracer::start_span(tracer, "grandchild_operation")
  azimuth::Span::set_status(grandchild_span, azimuth::Error, Some("å­™æ“ä½œå¤±è´¥"))
  
  // éªŒè¯æ‰€æœ‰Spançš„ç‹¬ç«‹æ€§å’Œå…³ç³»
  assert_eq(azimuth::Span::name(root_span), "root_operation")
  assert_eq(azimuth::Span::name(child_span1), "child_operation_1")
  assert_eq(azimuth::Span::name(child_span2), "child_operation_2")
  assert_eq(azimuth::Span::name(grandchild_span), "grandchild_operation")
  
  assert_eq(azimuth::Span::status(root_span), azimuth::Unset)
  assert_eq(azimuth::Span::status(child_span1), azimuth::Ok)
  assert_eq(azimuth::Span::status(child_span2), azimuth::Ok)
  assert_eq(azimuth::Span::status(grandchild_span), azimuth::Error)
  
  // éªŒè¯æ‰€æœ‰Spanéƒ½åœ¨è®°å½•çŠ¶æ€
  assert_true(azimuth::Span::is_recording(root_span))
  assert_true(azimuth::Span::is_recording(child_span1))
  assert_true(azimuth::Span::is_recording(child_span2))
  assert_true(azimuth::Span::is_recording(grandchild_span))
  
  // æŒ‰é¡ºåºç»“æŸSpan
  azimuth::Span::end(grandchild_span)
  azimuth::Span::end(child_span2)
  azimuth::Span::end(child_span1)
  azimuth::Span::end(root_span)
}

test "ä¸åŒç±»å‹Spançš„åˆ›å»ºå’Œç®¡ç†æµ‹è¯•" {
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "span_types_test_tracer")
  
  // åˆ›å»ºä¸åŒç±»å‹çš„Span
  let internal_span = azimuth::Tracer::start_span(tracer, "internal_operation")
  let server_span = azimuth::Tracer::start_span(tracer, "server_operation")
  let client_span = azimuth::Tracer::start_span(tracer, "client_operation")
  let producer_span = azimuth::Tracer::start_span(tracer, "producer_operation")
  let consumer_span = azimuth::Tracer::start_span(tracer, "consumer_operation")
  
  // éªŒè¯Spanç±»å‹ï¼ˆæ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ ¹æ®å®é™…å®ç°è°ƒæ•´ï¼‰
  // ç”±äºå½“å‰å®ç°ä¸­æ‰€æœ‰Spanéƒ½æ˜¯Internalç±»å‹ï¼Œè¿™é‡Œä¸»è¦éªŒè¯åç§°å’ŒçŠ¶æ€
  assert_eq(azimuth::Span::name(internal_span), "internal_operation")
  assert_eq(azimuth::Span::name(server_span), "server_operation")
  assert_eq(azimuth::Span::name(client_span), "client_operation")
  assert_eq(azimuth::Span::name(producer_span), "producer_operation")
  assert_eq(azimuth::Span::name(consumer_span), "consumer_operation")
  
  // ä¸ºä¸åŒç±»å‹çš„Spanè®¾ç½®ä¸åŒçš„çŠ¶æ€
  azimuth::Span::set_status(internal_span, azimuth::Ok, Some("å†…éƒ¨æ“ä½œæˆåŠŸ"))
  azimuth::Span::set_status(server_span, azimuth::Ok, Some("æœåŠ¡å™¨è¯·æ±‚å¤„ç†æˆåŠŸ"))
  azimuth::Span::set_status(client_span, azimuth::Error, Some("å®¢æˆ·ç«¯è¯·æ±‚å¤±è´¥"))
  azimuth::Span::set_status(producer_span, azimuth::Ok, Some("æ¶ˆæ¯ç”Ÿäº§æˆåŠŸ"))
  azimuth::Span::set_status(consumer_span, azimuth::Ok, Some("æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸ"))
  
  // éªŒè¯çŠ¶æ€è®¾ç½®
  assert_eq(azimuth::Span::status(internal_span), azimuth::Ok)
  assert_eq(azimuth::Span::status(server_span), azimuth::Ok)
  assert_eq(azimuth::Span::status(client_span), azimuth::Error)
  assert_eq(azimuth::Span::status(producer_span), azimuth::Ok)
  assert_eq(azimuth::Span::status(consumer_span), azimuth::Ok)
  
  // ä¸ºæ¯ä¸ªSpanæ·»åŠ ç‰¹å®šç±»å‹çš„äº‹ä»¶
  azimuth::Span::add_event(internal_span, "internal_event", Some([
    ("operation_type", StringValue("internal")),
    ("duration_ms", IntValue(150))
  ]))
  
  azimuth::Span::add_event(server_span, "request_received", Some([
    ("http.method", StringValue("GET")),
    ("http.url", StringValue("/api/v1/resource")),
    ("user_agent", StringValue("Azimuth-Client/1.0"))
  ]))
  
  azimuth::Span::add_event(client_span, "request_sent", Some([
    ("http.method", StringValue("POST")),
    ("http.url", StringValue("/api/v2/submit")),
    ("request_size", IntValue(1024))
  ]))
  
  azimuth::Span::add_event(producer_span, "message_produced", Some([
    ("messaging.system", StringValue("kafka")),
    ("messaging.destination", StringValue("events.topic")),
    ("message_size", IntValue(512))
  ]))
  
  azimuth::Span::add_event(consumer_span, "message_consumed", Some([
    ("messaging.system", StringValue("kafka")),
    ("messaging.source", StringValue("events.topic")),
    ("processing_time_ms", IntValue(75))
  ]))
  
  // ç»“æŸæ‰€æœ‰Span
  azimuth::Span::end(internal_span)
  azimuth::Span::end(server_span)
  azimuth::Span::end(client_span)
  azimuth::Span::end(producer_span)
  azimuth::Span::end(consumer_span)
}

test "Spanä¸Šä¸‹æ–‡éªŒè¯å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "context_validation_tracer")
  
  // æµ‹è¯•æœ‰æ•ˆçš„Spanä¸Šä¸‹æ–‡
  let valid_trace_id = "1234567890abcdef1234567890abcdef"
  let valid_span_id = "1234567890abcdef"
  let valid_span_context = azimuth::SpanContext::new(valid_trace_id, valid_span_id, true, "key1=value1,key2=value2")
  
  assert_true(azimuth::SpanContext::is_valid(valid_span_context))
  assert_true(azimuth::SpanContext::is_sampled(valid_span_context))
  assert_eq(azimuth::SpanContext::trace_id(valid_span_context), valid_trace_id)
  assert_eq(azimuth::SpanContext::span_id(valid_span_context), valid_span_id)
  
  // æµ‹è¯•æ— æ•ˆçš„Spanä¸Šä¸‹æ–‡
  let invalid_trace_id = ""
  let invalid_span_id = ""
  let invalid_span_context = azimuth::SpanContext::new(invalid_trace_id, invalid_span_id, false, "")
  
  assert_false(azimuth::SpanContext::is_valid(invalid_span_context))
  assert_false(azimuth::SpanContext::is_sampled(invalid_span_context))
  assert_eq(azimuth::SpanContext::trace_id(invalid_span_context), invalid_trace_id)
  assert_eq(azimuth::SpanContext::span_id(invalid_span_context), invalid_span_id)
  
  // æµ‹è¯•éƒ¨åˆ†æœ‰æ•ˆçš„Spanä¸Šä¸‹æ–‡
  let partial_valid_trace_id = "1234567890abcdef1234567890abcdef"
  let partial_valid_span_id = ""
  let partial_valid_span_context = azimuth::SpanContext::new(partial_valid_trace_id, partial_valid_span_id, true, "")
  
  assert_false(azimuth::SpanContext::is_valid(partial_valid_span_context))  // span_idä¸ºç©ºï¼Œæ•´ä½“æ— æ•ˆ
  assert_true(azimuth::SpanContext::is_sampled(partial_valid_span_context))
  assert_eq(azimuth::SpanContext::trace_id(partial_valid_span_context), partial_valid_trace_id)
  assert_eq(azimuth::SpanContext::span_id(partial_valid_span_context), partial_valid_span_id)
  
  // åˆ›å»ºä½¿ç”¨è¿™äº›ä¸Šä¸‹æ–‡çš„Span
  let valid_span = azimuth::Tracer::start_span(tracer, "valid_context_span")
  let invalid_span = azimuth::Tracer::start_span(tracer, "invalid_context_span")
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡
  let valid_span_context_retrieved = azimuth::Span::span_context(valid_span)
  let invalid_span_context_retrieved = azimuth::Span::span_context(invalid_span)
  
  // æ³¨æ„ï¼šç”±äºç®€åŒ–å®ç°ï¼Œè¿™é‡Œä½¿ç”¨æµ‹è¯•ä¸Šä¸‹æ–‡
  assert_true(azimuth::SpanContext::is_valid(valid_span_context_retrieved))
  
  // è®¾ç½®ä¸åŒçš„çŠ¶æ€
  azimuth::Span::set_status(valid_span, azimuth::Ok, Some("æœ‰æ•ˆä¸Šä¸‹æ–‡SpanæˆåŠŸ"))
  azimuth::Span::set_status(invalid_span, azimuth::Error, Some("æ— æ•ˆä¸Šä¸‹æ–‡Spanå¤±è´¥"))
  
  // éªŒè¯çŠ¶æ€
  assert_eq(azimuth::Span::status(valid_span), azimuth::Ok)
  assert_eq(azimuth::Span::status(invalid_span), azimuth::Error)
  
  // ç»“æŸSpan
  azimuth::Span::end(valid_span)
  azimuth::Span::end(invalid_span)
}

test "Spanäº‹ä»¶å’Œå±æ€§çš„é«˜çº§æµ‹è¯•" {
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "advanced_events_tracer")
  
  let span = azimuth::Tracer::start_span(tracer, "advanced_events_span")
  
  // æ·»åŠ å„ç§ç±»å‹çš„äº‹ä»¶å’Œå±æ€§
  let string_attributes = [
    ("string_attr", StringValue("å­—ç¬¦ä¸²å±æ€§å€¼")),
    ("unicode_attr", StringValue("Unicodeæµ‹è¯•_ğŸš€_ğŸŒŸ")),
    ("empty_string_attr", StringValue("")),
    ("special_chars_attr", StringValue("ç‰¹æ®Šå­—ç¬¦: !@#$%^&*()"))
  ]
  
  let int_attributes = [
    ("positive_int", IntValue(42)),
    ("zero_int", IntValue(0)),
    ("negative_int", IntValue(-17)),
    ("max_int", IntValue(2147483647)),
    ("min_int", IntValue(-2147483648))
  ]
  
  let float_attributes = [
    ("positive_float", FloatValue(3.14159)),
    ("zero_float", FloatValue(0.0)),
    ("negative_float", FloatValue(-2.71828)),
    ("scientific_float", FloatValue(1.23e-4))
  ]
  
  let bool_attributes = [
    ("true_bool", BoolValue(true)),
    ("false_bool", BoolValue(false))
  ]
  
  let array_string_attributes = [
    ("string_array", ArrayStringValue(["å…ƒç´ 1", "element2", "ğŸ‰"])),
    ("empty_string_array", ArrayStringValue([])),
    ("single_string_array", ArrayStringValue(["å•ä¸ªå…ƒç´ "]))
  ]
  
  let array_int_attributes = [
    ("int_array", ArrayIntValue([1, 2, 3, 4, 5])),
    ("empty_int_array", ArrayIntValue([])),
    ("negative_int_array", ArrayIntValue([-1, -2, -3]))
  ]
  
  // æ·»åŠ åŒ…å«ä¸åŒå±æ€§ç±»å‹çš„äº‹ä»¶
  azimuth::Span::add_event(span, "string_attributes_event", Some(string_attributes))
  azimuth::Span::add_event(span, "int_attributes_event", Some(int_attributes))
  azimuth::Span::add_event(span, "float_attributes_event", Some(float_attributes))
  azimuth::Span::add_event(span, "bool_attributes_event", Some(bool_attributes))
  azimuth::Span::add_event(span, "array_string_attributes_event", Some(array_string_attributes))
  azimuth::Span::add_event(span, "array_int_attributes_event", Some(array_int_attributes))
  
  // æ·»åŠ æ··åˆå±æ€§ç±»å‹çš„äº‹ä»¶
  let mixed_attributes = [
    ("mixed_string", StringValue("æ··åˆå­—ç¬¦ä¸²")),
    ("mixed_int", IntValue(100)),
    ("mixed_float", FloatValue(2.5)),
    ("mixed_bool", BoolValue(true)),
    ("mixed_string_array", ArrayStringValue(["a", "b", "c"])),
    ("mixed_int_array", ArrayIntValue([10, 20, 30]))
  ]
  
  azimuth::Span::add_event(span, "mixed_attributes_event", Some(mixed_attributes))
  
  // æ·»åŠ æ— å±æ€§çš„äº‹ä»¶
  azimuth::Span::add_event(span, "no_attributes_event", None)
  
  // æ·»åŠ ç©ºå±æ€§åˆ—è¡¨çš„äº‹ä»¶
  azimuth::Span::add_event(span, "empty_attributes_event", Some([]))
  
  // è®¾ç½®çŠ¶æ€å¹¶ç»“æŸSpan
  azimuth::Span::set_status(span, azimuth::Ok, Some("é«˜çº§äº‹ä»¶æµ‹è¯•æˆåŠŸ"))
  azimuth::Span::end(span)
  
  // éªŒè¯SpançŠ¶æ€
  assert_eq(azimuth::Span::name(span), "advanced_events_span")
  assert_eq(azimuth::Span::status(span), azimuth::Ok)
}
// Azimuth Specialized MoonBit Test Suite
// ä¸“é—¨è®¾è®¡çš„MoonBitæµ‹è¯•ç”¨ä¾‹ï¼Œæ¶µç›–é¥æµ‹ç³»ç»Ÿçš„å…³é”®åŠŸèƒ½

// æµ‹è¯•1: å±æ€§å€¼ç±»å‹è½¬æ¢ä¸éªŒè¯
pub test "å±æ€§å€¼ç±»å‹è½¬æ¢ä¸éªŒè¯" {
  // æµ‹è¯•å­—ç¬¦ä¸²åˆ°æ•´æ•°çš„è½¬æ¢
  let string_attr = azimuth::StringValue("42")
  let int_attr = azimuth::IntValue(42)
  
  // æµ‹è¯•å­—ç¬¦ä¸²åˆ°æµ®ç‚¹æ•°çš„è½¬æ¢
  let float_string_attr = azimuth::StringValue("3.14")
  let float_attr = azimuth::FloatValue(3.14)
  
  // æµ‹è¯•å¸ƒå°”å€¼å±æ€§
  let bool_true_attr = azimuth::BoolValue(true)
  let bool_false_attr = azimuth::BoolValue(false)
  
  // æµ‹è¯•æ•°ç»„å±æ€§
  let string_array_attr = azimuth::ArrayStringValue(["a", "b", "c"])
  let int_array_attr = azimuth::ArrayIntValue([1, 2, 3])
  
  // éªŒè¯å±æ€§ç±»å‹å’Œå€¼
  assert_eq(string_attr, azimuth::StringValue("42"))
  assert_eq(int_attr, azimuth::IntValue(42))
  assert_eq(float_string_attr, azimuth::StringValue("3.14"))
  assert_eq(float_attr, azimuth::FloatValue(3.14))
  assert_eq(bool_true_attr, azimuth::BoolValue(true))
  assert_eq(bool_false_attr, azimuth::BoolValue(false))
  assert_eq(string_array_attr, azimuth::ArrayStringValue(["a", "b", "c"]))
  assert_eq(int_array_attr, azimuth::ArrayIntValue([1, 2, 3]))
}

// æµ‹è¯•2: è·¨æœåŠ¡ä¼ æ’­ä¸€è‡´æ€§
pub test "è·¨æœåŠ¡ä¼ æ’­ä¸€è‡´æ€§" {
  // æµ‹è¯•è·Ÿè¸ªä¸Šä¸‹æ–‡ä¼ æ’­
  let trace_id = "trace-12345"
  let span_id = "span-67890"
  let span_ctx = azimuth::SpanContext::new(trace_id, span_id, true, "key1=value1")
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡çš„æœ‰æ•ˆæ€§
  assert_true(azimuth::SpanContext::is_valid(span_ctx))
  assert_eq(azimuth::SpanContext::trace_id(span_ctx), trace_id)
  assert_eq(azimuth::SpanContext::span_id(span_ctx), span_id)
  assert_true(azimuth::SpanContext::is_sampled(span_ctx))
  
  // æµ‹è¯•å¤åˆä¼ æ’­å™¨
  let trace_propagator = azimuth::W3CTraceContextPropagator::new()
  let baggage_propagator = azimuth::W3CBaggagePropagator::new()
  let propagators = [trace_propagator]
  let composite_propagator = azimuth::CompositePropagator::new(propagators)
  
  // æµ‹è¯•æ³¨å…¥å’Œæå–
  let carrier = azimuth::TextMapCarrier::new()
  let ctx = azimuth::Context::root()
  azimuth::CompositePropagator::inject(composite_propagator, ctx, carrier)
  
  let extracted_ctx = azimuth::CompositePropagator::extract(composite_propagator, carrier)
  let key = azimuth::ContextKey::new("extracted")
  let extracted_value = azimuth::Context::get(extracted_ctx, key)
  
  assert_eq(extracted_value, Some("true"))
}

// æµ‹è¯•3: æ—¶é—´åºåˆ—æ•°æ®å¤„ç†
pub test "æ—¶é—´åºåˆ—æ•°æ®å¤„ç†" {
  // æµ‹è¯•æ—¶é—´åºåˆ—æ•°æ®ç‚¹
  let timestamp1 = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let timestamp2 = timestamp1 + 1000000L  // 1ms later
  
  // æµ‹è¯•ä¸åŒæ—¶é—´æˆ³çš„åº¦é‡å€¼
  let metric_value1 = 10.0
  let metric_value2 = 15.0
  let metric_value3 = 12.5
  
  // æµ‹è¯•æ—¶é—´åºåˆ—èšåˆ
  let sum_value = metric_value1 + metric_value2 + metric_value3
  let avg_value = sum_value / 3.0
  let max_value = metric_value2
  let min_value = metric_value1
  
  assert_eq(sum_value, 37.5)
  assert_eq(avg_value, 12.5)
  assert_eq(max_value, 15.0)
  assert_eq(min_value, 10.0)
  
  // éªŒè¯æ—¶é—´æˆ³é¡ºåº
  assert_true(timestamp2 > timestamp1)
}

// æµ‹è¯•4: å®æ—¶æµå¤„ç†æ€§èƒ½
pub test "å®æ—¶æµå¤„ç†æ€§èƒ½" {
  // æµ‹è¯•æµæ•°æ®ç‚¹
  let stream_data1 = ("event-1", 10.0, azimuth::Clock::now_unix_nanos(azimuth::Clock::system()))
  let stream_data2 = ("event-2", 20.0, azimuth::Clock::now_unix_nanos(azimuth::Clock::system()) + 1000000L)
  let stream_data3 = ("event-3", 15.0, azimuth::Clock::now_unix_nanos(azimuth::Clock::system()) + 2000000L)
  
  // æµ‹è¯•çª—å£èšåˆ
  let window_sum = stream_data1.1 + stream_data2.1 + stream_data3.1
  let window_avg = window_sum / 3.0
  let window_count = 3.0
  
  // æµ‹è¯•æµå¤„ç†æŒ‡æ ‡
  let processing_rate = window_count / 0.002  // 2mså†…3ä¸ªäº‹ä»¶
  let throughput = window_sum / 0.002  // æ¯ç§’æ€»å€¼
  
  // éªŒè¯è®¡ç®—
  assert_eq(window_sum, 45.0)
  assert_eq(window_avg, 15.0)
  assert_eq(window_count, 3.0)
  assert_eq(processing_rate, 1500.0)
  assert_eq(throughput, 22500.0)
}

// æµ‹è¯•5: é”™è¯¯è¾¹ç•Œå¤„ç†ä¸æ¢å¤
pub test "é”™è¯¯è¾¹ç•Œå¤„ç†ä¸æ¢å¤" {
  // æµ‹è¯•é”™è¯¯æ¢å¤æœºåˆ¶
  let error_occurred = true
  let recovery_attempted = true
  let recovery_successful = true
  
  // æµ‹è¯•é”™è¯¯ä¼ æ’­
  let error_context = "database.connection.failed"
  let error_message = "æ— æ³•è¿æ¥åˆ°æ•°æ®åº“"
  let error_severity = azimuth::Error
  
  // æµ‹è¯•é”™è¯¯å¤„ç†å·¥ä½œæµ
  let should_retry = error_occurred && recovery_attempted
  let operation_resumed = should_retry && recovery_successful
  
  // æµ‹è¯•é”™è¯¯æ—¥å¿—è®°å½•
  let error_log = azimuth::LogRecord::new(error_severity, error_message)
  let log_severity = azimuth::LogRecord::severity_number(error_log)
  let log_body = azimuth::LogRecord::body(error_log)
  
  // éªŒè¯é”™è¯¯å¤„ç†
  assert_true(should_retry)
  assert_true(operation_resumed)
  assert_eq(log_severity, azimuth::Error)
  assert_eq(log_body, Some(error_message))
}

// æµ‹è¯•6: å¹¶å‘å®‰å…¨æ“ä½œ
pub test "å¹¶å‘å®‰å…¨æ“ä½œ" {
  // æµ‹è¯•å¹¶å‘åº¦é‡æ›´æ–°
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "concurrent-test")
  let counter = azimuth::Meter::create_counter(meter, "concurrent.counter")
  let initial_value = 0.0
  let concurrent_updates = 10.0
  let expected_value = initial_value + concurrent_updates
  
  // æµ‹è¯•å¹¶å‘Spanæ“ä½œ
  let trace_id = "concurrent-trace"
  let span_ids = ["span-1", "span-2", "span-3"]
  let span_count = 3
  
  // æµ‹è¯•å¹¶å‘ä¸Šä¸‹æ–‡æ“ä½œ
  let ctx = azimuth::Context::root()
  let key = azimuth::ContextKey::new("concurrent.key")
  let ctx_with_value = azimuth::Context::with_value(ctx, key, "concurrent.value")
  let retrieved_value = azimuth::Context::get(ctx_with_value, key)
  
  // éªŒè¯å¹¶å‘æ“ä½œ
  assert_eq(expected_value, 10.0)
  assert_eq(span_count, 3)
  assert_eq(retrieved_value, Some("concurrent.value"))
}

// æµ‹è¯•7: å›½é™…åŒ–ä¸æœ¬åœ°åŒ–æ”¯æŒ
pub test "å›½é™…åŒ–ä¸æœ¬åœ°åŒ–æ”¯æŒ" {
  // æµ‹è¯•Unicodeæ–‡æœ¬å¤„ç†
  let chinese_text = "é¥æµ‹ç³»ç»Ÿ"
  let emoji_text = "ğŸ“ŠğŸ“ˆğŸ“‰"
  let mixed_text = "Azimuth é¥æµ‹ ğŸš€"
  
  // æµ‹è¯•ç‰¹å®šåŒºåŸŸè®¾ç½®æ ¼å¼åŒ–
  let locale = "zh-CN"
  let date_format = "YYYY-MM-DD"
  let number_format = "1,234.56"
  
  // æµ‹è¯•æœ¬åœ°åŒ–æ¶ˆæ¯
  let error_message_zh = "å‘ç”Ÿé”™è¯¯"
  let error_message_en = "An error occurred"
  let warning_message_zh = "è­¦å‘Š"
  let warning_message_en = "Warning"
  
  // éªŒè¯å›½é™…åŒ–
  assert_eq(chinese_text, "é¥æµ‹ç³»ç»Ÿ")
  assert_eq(emoji_text, "ğŸ“ŠğŸ“ˆğŸ“‰")
  assert_eq(mixed_text, "Azimuth é¥æµ‹ ğŸš€")
  assert_eq(locale, "zh-CN")
  assert_eq(date_format, "YYYY-MM-DD")
  assert_eq(number_format, "1,234.56")
  assert_eq(error_message_zh, "å‘ç”Ÿé”™è¯¯")
  assert_eq(error_message_en, "An error occurred")
  assert_eq(warning_message_zh, "è­¦å‘Š")
  assert_eq(warning_message_en, "Warning")
}

// æµ‹è¯•8: èµ„æºç®¡ç†ä¸åˆå¹¶
pub test "èµ„æºç®¡ç†ä¸åˆå¹¶" {
  // æµ‹è¯•èµ„æºåˆ›å»º
  let resource = azimuth::Resource::new()
  let service_attrs = [
    ("service.name", azimuth::StringValue("test-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.instance.id", azimuth::StringValue("instance-123"))
  ]
  let resource_with_attrs = azimuth::Resource::with_attributes(resource, service_attrs)
  
  // æµ‹è¯•èµ„æºåˆå¹¶
  let override_attrs = [
    ("service.version", azimuth::StringValue("2.0.0")),
    ("deployment.environment", azimuth::StringValue("production"))
  ]
  let override_resource = azimuth::Resource::with_attributes(resource, override_attrs)
  let merged_resource = azimuth::Resource::merge(resource_with_attrs, override_resource)
  
  // æµ‹è¯•èµ„æºæ¸…ç†
  let cleanup_required = true
  let cleanup_completed = true
  let resource_released = cleanup_required && cleanup_completed
  
  // éªŒè¯èµ„æºç®¡ç†
  assert_eq(azimuth::Resource::get_attribute(resource_with_attrs, "service.name"), Some(azimuth::StringValue("test-service")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_attrs, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.version"), Some(azimuth::StringValue("2.0.0")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "deployment.environment"), Some(azimuth::StringValue("production")))
  assert_true(resource_released)
}

// æµ‹è¯•9: æ€§èƒ½åŸºå‡†æµ‹è¯•
pub test "æ€§èƒ½åŸºå‡†æµ‹è¯•" {
  // æµ‹è¯•æ“ä½œè®¡æ—¶
  let start_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  // æ¨¡æ‹Ÿä¸€äº›æ“ä½œ
  let iterations = 1000
  let counter = 0
  
  // æµ‹è¯•ååé‡è®¡ç®—
  let end_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let duration_ns = end_time - start_time
  let duration_ms = duration_ns / 1000000L
  let operations_per_second = (iterations as Double) / ((duration_ns as Double) / 1000000000.0)
  
  // æµ‹è¯•å†…å­˜ä½¿ç”¨
  let memory_used = 1024 * 1024  // 1MB
  let memory_limit = 10 * 1024 * 1024  // 10MB
  let memory_usage_percent = (memory_used as Double) / (memory_limit as Double) * 100.0
  
  // æµ‹è¯•æ€§èƒ½é˜ˆå€¼
  let max_acceptable_duration_ms = 100L
  let min_acceptable_ops_per_sec = 1000.0
  let max_acceptable_memory_percent = 50.0
  
  // éªŒè¯æ€§èƒ½
  assert_true(duration_ms < max_acceptable_duration_ms)
  assert_true(operations_per_second >= min_acceptable_ops_per_sec)
  assert_true(memory_usage_percent < max_acceptable_memory_percent)
}

// æµ‹è¯•10: å¾®æœåŠ¡æ¶æ„é¥æµ‹é›†æˆ
pub test "å¾®æœåŠ¡æ¶æ„é¥æµ‹é›†æˆ" {
  // æ¨¡æ‹Ÿå¾®æœåŠ¡è°ƒç”¨é“¾ï¼šAPI Gateway -> Service A -> Service B -> Database
  
  // API Gateway Span
  let gateway_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "api-gateway")
  let gateway_span = azimuth::Tracer::start_span(gateway_tracer, "gateway.request")
  azimuth::Span::set_kind(gateway_span, azimuth::Server)
  
  let gateway_trace_id = azimuth::SpanContext::trace_id(azimuth::Span::span_context(gateway_span))
  
  // Service A Span (å­Span)
  let service_a_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-a")
  let service_a_span_ctx = azimuth::SpanContext::new(gateway_trace_id, "service-a-span", true, "")
  let service_a_span = azimuth::Span::new("service-a.process", azimuth::Internal, service_a_span_ctx)
  
  // Service B Span (åµŒå¥—è°ƒç”¨)
  let service_b_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-b")
  let service_b_span_ctx = azimuth::SpanContext::new(gateway_trace_id, "service-b-span", true, "")
  let service_b_span = azimuth::Span::new("service-b.process", azimuth::Client, service_b_span_ctx)
  
  // Database Span (æœ€æ·±å±‚)
  let db_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "database")
  let db_span_ctx = azimuth::SpanContext::new(gateway_trace_id, "db-span", true, "")
  let db_span = azimuth::Span::new("database.query", azimuth::Client, db_span_ctx)
  
  // éªŒè¯Trace IDåœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­ä¿æŒä¸€è‡´
  assert_eq(azimuth::SpanContext::trace_id(azimuth::Span::span_context(gateway_span)), gateway_trace_id)
  assert_eq(azimuth::SpanContext::trace_id(service_a_span_ctx), gateway_trace_id)
  assert_eq(azimuth::SpanContext::trace_id(service_b_span_ctx), gateway_trace_id)
  assert_eq(azimuth::SpanContext::trace_id(db_span_ctx), gateway_trace_id)
  
  // éªŒè¯Span IDå”¯ä¸€æ€§
  assert_true(azimuth::SpanContext::span_id(azimuth::Span::span_context(gateway_span)) != 
              azimuth::SpanContext::span_id(service_a_span_ctx))
  assert_true(azimuth::SpanContext::span_id(service_a_span_ctx) != 
              azimuth::SpanContext::span_id(service_b_span_ctx))
  assert_true(azimuth::SpanContext::span_id(service_b_span_ctx) != 
              azimuth::SpanContext::span_id(db_span_ctx))
  
  // ä¸ºæ¯ä¸ªæœåŠ¡æ·»åŠ åº¦é‡
  let meter_provider = azimuth::MeterProvider::default()
  
  // Gatewayåº¦é‡
  let gateway_meter = azimuth::MeterProvider::get_meter(meter_provider, "api-gateway")
  let gateway_requests = azimuth::Meter::create_counter(gateway_meter, "gateway.requests.total")
  azimuth::Counter::add(gateway_requests, 1.0)
  
  // Service Aåº¦é‡
  let service_a_meter = azimuth::MeterProvider::get_meter(meter_provider, "service-a")
  let service_a_requests = azimuth::Meter::create_counter(service_a_meter, "service-a.requests.total")
  let service_a_duration = azimuth::Meter::create_histogram(service_a_meter, "service-a.duration.ms")
  azimuth::Counter::add(service_a_requests, 1.0)
  azimuth::Histogram::record(service_a_duration, 150.0)
  
  // Service Båº¦é‡
  let service_b_meter = azimuth::MeterProvider::get_meter(meter_provider, "service-b")
  let service_b_requests = azimuth::Meter::create_counter(service_b_meter, "service-b.requests.total")
  azimuth::Counter::add(service_b_requests, 1.0)
  
  // Databaseåº¦é‡
  let db_meter = azimuth::MeterProvider::get_meter(meter_provider, "database")
  let db_queries = azimuth::Meter::create_counter(db_meter, "database.queries.total")
  let db_duration = azimuth::Meter::create_histogram(db_meter, "database.query.duration.ms")
  azimuth::Counter::add(db_queries, 1.0)
  azimuth::Histogram::record(db_duration, 25.0)
  
  // æ·»åŠ Baggageä¼ æ’­
  let baggage = azimuth::Baggage::new()
  let baggage_with_user = azimuth::Baggage::set_entry(baggage, "user.id", "user-123")
  let final_baggage = azimuth::Baggage::set_entry(baggage_with_user, "request.id", "req-456")
  
  // ç»“æŸæ‰€æœ‰Spanï¼ˆæŒ‰ç…§è°ƒç”¨é¡ºåºçš„åå‘ï¼‰
  azimuth::Span::end(db_span)
  azimuth::Span::end(service_b_span)
  azimuth::Span::end(service_a_span)
  azimuth::Span::end(gateway_span)
  
  // éªŒè¯å¾®æœåŠ¡é¥æµ‹é›†æˆ
  assert_eq(gateway_requests.name, "gateway.requests.total")
  assert_eq(service_a_requests.name, "service-a.requests.total")
  assert_eq(service_a_duration.name, "service-a.duration.ms")
  assert_eq(service_b_requests.name, "service-b.requests.total")
  assert_eq(db_queries.name, "database.queries.total")
  assert_eq(db_duration.name, "database.query.duration.ms")
  
  // éªŒè¯Baggageä¼ æ’­
  assert_eq(azimuth::Baggage::get_entry(final_baggage, "user.id"), Some("user-123"))
  assert_eq(azimuth::Baggage::get_entry(final_baggage, "request.id"), Some("req-456"))
}
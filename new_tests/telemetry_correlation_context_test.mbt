// é¥æµ‹å…³è”ä¸Šä¸‹æ–‡æµ‹è¯•ç”¨ä¾‹

test "correlation_context_creation_and_basic_operations" {
  // æµ‹è¯•å…³è”ä¸Šä¸‹æ–‡çš„åˆ›å»ºå’ŒåŸºæœ¬æ“ä½œ
  
  // åˆ›å»ºç©ºå…³è”ä¸Šä¸‹æ–‡
  let empty_context = azimuth::telemetry::api::context::CorrelationContext::empty()
  assert_eq(empty_context.size(), 0)
  assert_eq(empty_context.is_empty(), true)
  
  // æ·»åŠ å…³è”é¡¹
  let context1 = empty_context.with("correlation.id", "corr-12345")
  assert_eq(context1.size(), 1)
  assert_eq(context1.is_empty(), false)
  assert_eq(context1.get("correlation.id").unwrap(), "corr-12345")
  
  let context2 = context1.with("session.id", "session-67890")
  assert_eq(context2.size(), 2)
  assert_eq(context2.get("correlation.id").unwrap(), "corr-12345")
  assert_eq(context2.get("session.id").unwrap(), "session-67890")
  
  // æµ‹è¯•è¦†ç›–ç°æœ‰å…³è”é¡¹
  let context3 = context2.with("correlation.id", "corr-99999")
  assert_eq(context3.size(), 2)  // è¦†ç›–ä¸å¢åŠ å¤§å°
  assert_eq(context3.get("correlation.id").unwrap(), "corr-99999")
  assert_eq(context3.get("session.id").unwrap(), "session-67890")
}

test "correlation_context_propagation" {
  // æµ‹è¯•å…³è”ä¸Šä¸‹æ–‡çš„ä¼ æ’­
  
  // åˆ›å»ºçˆ¶çº§å…³è”ä¸Šä¸‹æ–‡
  let parent_context = azimuth::telemetry::api::context::CorrelationContext::empty()
    .with("request.id", "req-abc-123")
    .with("user.id", "user-456")
    .with("trace.id", "trace-789")
  
  // åˆ›å»ºå­çº§å…³è”ä¸Šä¸‹æ–‡å¹¶ç»§æ‰¿çˆ¶çº§
  let child_context = azimuth::telemetry::api::context::CorrelationContext::from_parent(parent_context)
    .with("operation.id", "op-def-456")
    .with("service.name", "payment-service")
  
  // éªŒè¯å­çº§ä¸Šä¸‹æ–‡åŒ…å«çˆ¶çº§çš„å…³è”é¡¹
  assert_eq(child_context.size(), 5)
  assert_eq(child_context.get("request.id").unwrap(), "req-abc-123")
  assert_eq(child_context.get("user.id").unwrap(), "user-456")
  assert_eq(child_context.get("trace.id").unwrap(), "trace-789")
  assert_eq(child_context.get("operation.id").unwrap(), "op-def-456")
  assert_eq(child_context.get("service.name").unwrap(), "payment-service")
  
  // éªŒè¯çˆ¶çº§ä¸Šä¸‹æ–‡ä¸å—å­çº§å½±å“
  assert_eq(parent_context.size(), 3)
  assert_eq(parent_context.get("operation.id"), None)  // çˆ¶çº§ä¸åº”åŒ…å«å­çº§çš„å…³è”é¡¹
}

test "correlation_context_serialization" {
  // æµ‹è¯•å…³è”ä¸Šä¸‹æ–‡çš„åºåˆ—åŒ–
  
  // åˆ›å»ºå¤æ‚å…³è”ä¸Šä¸‹æ–‡
  let original_context = azimuth::telemetry::api::context::CorrelationContext::empty()
    .with("correlation.id", "corr-12345")
    .with("session.id", "session-67890")
    .with("request.id", "req-abc-123")
    .with("user.id", "user-456")
    .with("trace.id", "trace-789")
    .with("operation.type", "payment")
    .with("service.name", "billing-service")
    .with("service.version", "1.2.3")
  
  // åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²
  let serialized = original_context.to_string()
  assert_eq(serialized.length() > 0, true)
  assert_eq(serialized.contains("correlation.id"), true)
  assert_eq(serialized.contains("session.id"), true)
  
  // ååºåˆ—åŒ–
  let deserialized_context = azimuth::telemetry::api::context::CorrelationContext::from_string(serialized)
  assert_eq(deserialized_context.size(), original_context.size())
  
  // éªŒè¯ååºåˆ—åŒ–çš„å€¼
  assert_eq(deserialized_context.get("correlation.id").unwrap(), "corr-12345")
  assert_eq(deserialized_context.get("session.id").unwrap(), "session-67890")
  assert_eq(deserialized_context.get("request.id").unwrap(), "req-abc-123")
  assert_eq(deserialized_context.get("user.id").unwrap(), "user-456")
  assert_eq(deserialized_context.get("trace.id").unwrap(), "trace-789")
  assert_eq(deserialized_context.get("operation.type").unwrap(), "payment")
  assert_eq(deserialized_context.get("service.name").unwrap(), "billing-service")
  assert_eq(deserialized_context.get("service.version").unwrap(), "1.2.3")
}

test "correlation_context_filtering_and_selection" {
  // æµ‹è¯•å…³è”ä¸Šä¸‹æ–‡çš„è¿‡æ»¤å’Œé€‰æ‹©
  
  // åˆ›å»ºåŒ…å«å¤šç§å…³è”é¡¹çš„ä¸Šä¸‹æ–‡
  let context = azimuth::telemetry::api::context::CorrelationContext::empty()
    .with("correlation.id", "corr-12345")
    .with("session.id", "session-67890")
    .with("request.id", "req-abc-123")
    .with("user.id", "user-456")
    .with("trace.id", "trace-789")
    .with("operation.id", "op-def-456")
    .with("service.name", "auth-service")
    .with("service.version", "2.1.0")
    .with("client.ip", "192.168.1.100")
    .with("client.user_agent", "Mozilla/5.0")
  
  assert_eq(context.size(), 10)
  
  // æŒ‰å‰ç¼€è¿‡æ»¤
  let service_context = context.filter_by_prefix("service.")
  assert_eq(service_context.size(), 2)
  assert_eq(service_context.get("service.name").unwrap(), "auth-service")
  assert_eq(service_context.get("service.version").unwrap(), "2.1.0")
  
  // æŒ‰é”®é€‰æ‹©
  let selected_context = context.select(["correlation.id", "user.id", "trace.id"])
  assert_eq(selected_context.size(), 3)
  assert_eq(selected_context.get("correlation.id").unwrap(), "corr-12345")
  assert_eq(selected_context.get("user.id").unwrap(), "user-456")
  assert_eq(selected_context.get("trace.id").unwrap(), "trace-789")
  
  // æ’é™¤æŒ‡å®šé”®
  let filtered_context = context.exclude(["client.ip", "client.user_agent"])
  assert_eq(filtered_context.size(), 8)
  assert_eq(filtered_context.get("client.ip"), None)
  assert_eq(filtered_context.get("client.user_agent"), None)
  assert_eq(filtered_context.get("correlation.id").unwrap(), "corr-12345")
}

test "correlation_context_merge_and_combination" {
  // æµ‹è¯•å…³è”ä¸Šä¸‹æ–‡çš„åˆå¹¶å’Œç»„åˆ
  
  // åˆ›å»ºç¬¬ä¸€ä¸ªä¸Šä¸‹æ–‡
  let context1 = azimuth::telemetry::api::context::CorrelationContext::empty()
    .with("correlation.id", "corr-12345")
    .with("session.id", "session-67890")
    .with("request.id", "req-abc-123")
  
  // åˆ›å»ºç¬¬äºŒä¸ªä¸Šä¸‹æ–‡
  let context2 = azimuth::telemetry::api::context::CorrelationContext::empty()
    .with("user.id", "user-456")
    .with("trace.id", "trace-789")
    .with("session.id", "session-99999")  // è¦†ç›–session.id
  
  // åˆå¹¶ä¸Šä¸‹æ–‡
  let merged_context = context1.merge(context2)
  assert_eq(merged_context.size(), 4)  // session.idè¢«è¦†ç›–
  
  // éªŒè¯åˆå¹¶ç»“æœ
  assert_eq(merged_context.get("correlation.id").unwrap(), "corr-12345")
  assert_eq(merged_context.get("request.id").unwrap(), "req-abc-123")
  assert_eq(merged_context.get("user.id").unwrap(), "user-456")
  assert_eq(merged_context.get("trace.id").unwrap(), "trace-789")
  assert_eq(merged_context.get("session.id").unwrap(), "session-99999")  // è¢«è¦†ç›–çš„å€¼
}

test "correlation_context_validation_and_edge_cases" {
  // æµ‹è¯•å…³è”ä¸Šä¸‹æ–‡çš„éªŒè¯å’Œè¾¹ç•Œæƒ…å†µ
  
  // æµ‹è¯•ç©ºé”®å’Œç©ºå€¼
  let context1 = azimuth::telemetry::api::context::CorrelationContext::empty()
    .with("", "empty_key_value")
    .with("empty_value", "")
    .with("normal", "normal_value")
  
  assert_eq(context1.size(), 3)
  assert_eq(context1.get("").unwrap(), "empty_key_value")
  assert_eq(context1.get("empty_value").unwrap(), "")
  assert_eq(context1.get("normal").unwrap(), "normal_value")
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é”®
  let special_key = "key.with.special@chars#and$symbols"
  let context2 = context1.with(special_key, "special_value")
  assert_eq(context2.size(), 4)
  assert_eq(context2.get(special_key).unwrap(), "special_value")
  
  // æµ‹è¯•Unicodeé”®å’Œå€¼
  let unicode_key = "é”®å.åŒ…å«.ä¸­æ–‡"
  let unicode_value = "å€¼.åŒ…å«.ä¸­æ–‡.å’Œ.ğŸš€.emoji"
  let context3 = context2.with(unicode_key, unicode_value)
  assert_eq(context3.size(), 5)
  assert_eq(context3.get(unicode_key).unwrap(), unicode_value)
  
  // æµ‹è¯•æé•¿çš„é”®å’Œå€¼
  let long_key = "this.is.a.very.long.correlation.key.name.that.exceeds.normal.expectations"
  let long_value = "this.is.a.very.long.correlation.value.that.contains.a.lot.of.information"
  let context4 = context3.with(long_key, long_value)
  assert_eq(context4.size(), 6)
  assert_eq(context4.get(long_key).unwrap(), long_value)
  
  // æµ‹è¯•å¤§å°å†™æ•æ„Ÿæ€§
  let context5 = context4
    .with("CaseSensitive", "value1")
    .with("casesensitive", "value2")
  
  assert_eq(context5.size(), 8)
  assert_eq(context5.get("CaseSensitive").unwrap(), "value1")
  assert_eq(context5.get("casesensitive").unwrap(), "value2")
}
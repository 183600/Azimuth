// é¥æµ‹å±æ€§æ“ä½œæµ‹è¯•ç”¨ä¾‹

test "attribute_value_type_handling" {
  // æµ‹è¯•å±æ€§å€¼ç±»å‹çš„å¤„ç†
  
  // åˆ›å»ºä¸åŒç±»å‹çš„å±æ€§å€¼
  let int_attr = azimuth::telemetry::api::common::AttributeValue::Int64(42)
  let float_attr = azimuth::telemetry::api::common::AttributeValue::Float64(3.14159)
  let bool_attr = azimuth::telemetry::api::common::AttributeValue::Bool(true)
  let string_attr = azimuth::telemetry::api::common::AttributeValue::String("test_value")
  
  // æµ‹è¯•ç±»å‹è½¬æ¢å’Œæ¯”è¾ƒ
  assert_eq(int_attr.to_string(), "42")
  assert_eq(float_attr.to_string(), "3.14159")
  assert_eq(bool_attr.to_string(), "true")
  assert_eq(string_attr.to_string(), "test_value")
  
  // æµ‹è¯•æ•°ç»„ç±»å‹
  let int_array_attr = azimuth::telemetry::api::common::AttributeValue::ArrayInt64([1, 2, 3, 4, 5])
  let string_array_attr = azimuth::telemetry::api::common::AttributeValue::ArrayString(["a", "b", "c"])
  
  assert_eq(int_array_attr.to_string(), "[1, 2, 3, 4, 5]")
  assert_eq(string_array_attr.to_string(), "[a, b, c]")
}

test "attributes_basic_operations" {
  // æµ‹è¯•å±æ€§çš„åŸºæœ¬æ“ä½œ
  
  // åˆ›å»ºç©ºå±æ€§é›†åˆ
  let empty_attrs = azimuth::telemetry::api::common::Attributes::empty()
  assert_eq(empty_attrs.size(), 0)
  assert_eq(empty_attrs.is_empty(), true)
  
  // æ·»åŠ å±æ€§
  let attrs1 = empty_attrs.with("user.id", azimuth::telemetry::api::common::AttributeValue::String("12345"))
  assert_eq(attrs1.size(), 1)
  assert_eq(attrs1.is_empty(), false)
  assert_eq(attrs1.get("user.id").unwrap().to_string(), "12345")
  
  let attrs2 = attrs1.with("request.count", azimuth::telemetry::api::common::AttributeValue::Int64(10))
  assert_eq(attrs2.size(), 2)
  assert_eq(attrs2.get("user.id").unwrap().to_string(), "12345")
  assert_eq(attrs2.get("request.count").unwrap().to_string(), "10")
  
  // æµ‹è¯•è¦†ç›–ç°æœ‰å±æ€§
  let attrs3 = attrs2.with("user.id", azimuth::telemetry::api::common::AttributeValue::String("67890"))
  assert_eq(attrs3.size(), 2)  // è¦†ç›–ä¸å¢åŠ å¤§å°
  assert_eq(attrs3.get("user.id").unwrap().to_string(), "67890")
  assert_eq(attrs3.get("request.count").unwrap().to_string(), "10")
}

test "attributes_merging_and_combination" {
  // æµ‹è¯•å±æ€§çš„åˆå¹¶å’Œç»„åˆ
  
  // åˆ›å»ºç¬¬ä¸€ä¸ªå±æ€§é›†åˆ
  let attrs1 = azimuth::telemetry::api::common::Attributes::empty()
    .with("service.name", azimuth::telemetry::api::common::AttributeValue::String("auth-service"))
    .with("service.version", azimuth::telemetry::api::common::AttributeValue::String("1.0.0"))
    .with("service.instance", azimuth::telemetry::api::common::AttributeValue::String("instance-1"))
  
  // åˆ›å»ºç¬¬äºŒä¸ªå±æ€§é›†åˆ
  let attrs2 = azimuth::telemetry::api::common::Attributes::empty()
    .with("user.id", azimuth::telemetry::api::common::AttributeValue::String("user123"))
    .with("user.role", azimuth::telemetry::api::common::AttributeValue::String("admin"))
    .with("service.version", azimuth::telemetry::api::common::AttributeValue::String("2.0.0"))  // è¦†ç›–ç‰ˆæœ¬
  
  // åˆå¹¶å±æ€§
  let merged_attrs = attrs1.merge(attrs2)
  assert_eq(merged_attrs.size(), 4)  // service.versionè¢«è¦†ç›–
  
  // éªŒè¯åˆå¹¶ç»“æœ
  assert_eq(merged_attrs.get("service.name").unwrap().to_string(), "auth-service")
  assert_eq(merged_attrs.get("service.instance").unwrap().to_string(), "instance-1")
  assert_eq(merged_attrs.get("user.id").unwrap().to_string(), "user123")
  assert_eq(merged_attrs.get("user.role").unwrap().to_string(), "admin")
  assert_eq(merged_attrs.get("service.version").unwrap().to_string(), "2.0.0")  // è¢«è¦†ç›–çš„å€¼
}

test "attributes_filtering_and_selection" {
  // æµ‹è¯•å±æ€§çš„è¿‡æ»¤å’Œé€‰æ‹©
  
  // åˆ›å»ºåŒ…å«å¤šç§å±æ€§çš„é›†åˆ
  let attrs = azimuth::telemetry::api::common::Attributes::empty()
    .with("user.id", azimuth::telemetry::api::common::AttributeValue::String("12345"))
    .with("user.name", azimuth::telemetry::api::common::AttributeValue::String("å¼ ä¸‰"))
    .with("user.age", azimuth::telemetry::api::common::AttributeValue::Int64(25))
    .with("service.name", azimuth::telemetry::api::common::AttributeValue::String("api-service"))
    .with("service.version", azimuth::telemetry::api::common::AttributeValue::String("1.2.3"))
    .with("request.id", azimuth::telemetry::api::common::AttributeValue::String("req-abc-123"))
    .with("request.duration", azimuth::telemetry::api::common::AttributeValue::Float64(150.5))
    .with("error.code", azimuth::telemetry::api::common::AttributeValue::Int64(500))
  
  assert_eq(attrs.size(), 8)
  
  // æŒ‰å‰ç¼€è¿‡æ»¤
  let user_attrs = attrs.filter_by_prefix("user.")
  assert_eq(user_attrs.size(), 3)
  assert_eq(user_attrs.get("user.id").unwrap().to_string(), "12345")
  assert_eq(user_attrs.get("user.name").unwrap().to_string(), "å¼ ä¸‰")
  assert_eq(user_attrs.get("user.age").unwrap().to_string(), "25")
  
  let service_attrs = attrs.filter_by_prefix("service.")
  assert_eq(service_attrs.size(), 2)
  assert_eq(service_attrs.get("service.name").unwrap().to_string(), "api-service")
  assert_eq(service_attrs.get("service.version").unwrap().to_string(), "1.2.3")
  
  let request_attrs = attrs.filter_by_prefix("request.")
  assert_eq(request_attrs.size(), 2)
  assert_eq(request_attrs.get("request.id").unwrap().to_string(), "req-abc-123")
  assert_eq(request_attrs.get("request.duration").unwrap().to_string(), "150.5")
  
  // æŒ‰é”®é€‰æ‹©
  let selected_attrs = attrs.select(["user.id", "service.name", "error.code"])
  assert_eq(selected_attrs.size(), 3)
  assert_eq(selected_attrs.get("user.id").unwrap().to_string(), "12345")
  assert_eq(selected_attrs.get("service.name").unwrap().to_string(), "api-service")
  assert_eq(selected_attrs.get("error.code").unwrap().to_string(), "500")
}

test "attributes_serialization_and_deserialization" {
  // æµ‹è¯•å±æ€§çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–
  
  // åˆ›å»ºå¤æ‚å±æ€§é›†åˆ
  let original_attrs = azimuth::telemetry::api::common::Attributes::empty()
    .with("string.value", azimuth::telemetry::api::common::AttributeValue::String("æµ‹è¯•å­—ç¬¦ä¸²"))
    .with("int.value", azimuth::telemetry::api::common::AttributeValue::Int64(42))
    .with("float.value", azimuth::telemetry::api::common::AttributeValue::Float64(3.14159))
    .with("bool.value", azimuth::telemetry::api::common::AttributeValue::Bool(true))
    .with("int.array", azimuth::telemetry::api::common::AttributeValue::ArrayInt64([1, 2, 3, 4, 5]))
    .with("string.array", azimuth::telemetry::api::common::AttributeValue::ArrayString(["a", "b", "c", "æµ‹è¯•"]))
  
  // åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²
  let serialized = original_attrs.to_json()
  assert_eq(serialized.length() > 0, true)
  
  // ååºåˆ—åŒ–
  let deserialized_attrs = azimuth::telemetry::api::common::Attributes::from_json(serialized)
  assert_eq(deserialized_attrs.size(), original_attrs.size())
  
  // éªŒè¯ååºåˆ—åŒ–çš„å€¼
  assert_eq(deserialized_attrs.get("string.value").unwrap().to_string(), "æµ‹è¯•å­—ç¬¦ä¸²")
  assert_eq(deserialized_attrs.get("int.value").unwrap().to_string(), "42")
  assert_eq(deserialized_attrs.get("float.value").unwrap().to_string(), "3.14159")
  assert_eq(deserialized_attrs.get("bool.value").unwrap().to_string(), "true")
  assert_eq(deserialized_attrs.get("int.array").unwrap().to_string(), "[1, 2, 3, 4, 5]")
  assert_eq(deserialized_attrs.get("string.array").unwrap().to_string(), "[a, b, c, æµ‹è¯•]")
}

test "attributes_edge_cases_and_validation" {
  // æµ‹è¯•å±æ€§çš„è¾¹ç•Œæƒ…å†µå’ŒéªŒè¯
  
  // æµ‹è¯•ç©ºé”®å’Œç©ºå€¼
  let attrs1 = azimuth::telemetry::api::common::Attributes::empty()
    .with("", azimuth::telemetry::api::common::AttributeValue::String("empty_key_value"))
    .with("empty_value", azimuth::telemetry::api::common::AttributeValue::String(""))
    .with("normal", azimuth::telemetry::api::common::AttributeValue::String("normal_value"))
  
  assert_eq(attrs1.size(), 3)
  assert_eq(attrs1.get("").unwrap().to_string(), "empty_key_value")
  assert_eq(attrs1.get("empty_value").unwrap().to_string(), "")
  assert_eq(attrs1.get("normal").unwrap().to_string(), "normal_value")
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é”®
  let special_key = "key.with.special@chars#and$symbols"
  let attrs2 = attrs1.with(special_key, azimuth::telemetry::api::common::AttributeValue::String("special_value"))
  assert_eq(attrs2.size(), 4)
  assert_eq(attrs2.get(special_key).unwrap().to_string(), "special_value")
  
  // æµ‹è¯•Unicodeé”®å’Œå€¼
  let unicode_key = "é”®å.åŒ…å«.ä¸­æ–‡"
  let unicode_value = "å€¼.åŒ…å«.ä¸­æ–‡.å’Œ.ğŸš€.emoji"
  let attrs3 = attrs2.with(unicode_key, azimuth::telemetry::api::common::AttributeValue::String(unicode_value))
  assert_eq(attrs3.size(), 5)
  assert_eq(attrs3.get(unicode_key).unwrap().to_string(), unicode_value)
  
  // æµ‹è¯•æé•¿çš„é”®å’Œå€¼
  let long_key = "this.is.a.very.long.key.name.that.exceeds.normal.expectations.and.tests.system.behavior.with.extremely.long.identifiers"
  let long_value = "this.is.a.very.long.value.that.contains.a.lot.of.information.and.might.be.used.to.test.the.system.ability.to.handle.extremely.long.strings.without.issues.or.performance.problems"
  let attrs4 = attrs3.with(long_key, azimuth::telemetry::api::common::AttributeValue::String(long_value))
  assert_eq(attrs4.size(), 6)
  assert_eq(attrs4.get(long_key).unwrap().to_string(), long_value)
  
  // æµ‹è¯•æ•°å€¼è¾¹ç•Œ
  let max_int = azimuth::telemetry::api::common::AttributeValue::Int64(9223372036854775807)  // Int64æœ€å¤§å€¼
  let min_int = azimuth::telemetry::api::common::AttributeValue::Int64(-9223372036854775808)  // Int64æœ€å°å€¼
  let max_float = azimuth::telemetry::api::common::AttributeValue::Float64(1.7976931348623157e+308)  // Float64æœ€å¤§å€¼
  let min_float = azimuth::telemetry::api::common::AttributeValue::Float64(-1.7976931348623157e+308)  // Float64æœ€å°å€¼
  
  let attrs5 = attrs4
    .with("max.int", max_int)
    .with("min.int", min_int)
    .with("max.float", max_float)
    .with("min.float", min_float)
  
  assert_eq(attrs5.size(), 10)
  assert_eq(attrs5.get("max.int").unwrap().to_string(), "9223372036854775807")
  assert_eq(attrs5.get("min.int").unwrap().to_string(), "-9223372036854775808")
  assert_eq(attrs5.get("max.float").unwrap().to_string(), "1.7976931348623157e+308")
  assert_eq(attrs5.get("min.float").unwrap().to_string(), "-1.7976931348623157e+308")
}
// é¥æµ‹èµ„æºæ£€æµ‹æµ‹è¯•ç”¨ä¾‹

test "basic_resource_detection" {
  // æµ‹è¯•åŸºæœ¬èµ„æºæ£€æµ‹
  
  let detector = azimuth::telemetry::api::resource::ResourceDetector::new()
  
  // æ£€æµ‹èµ„æº
  let resource = detector.detect()
  
  // éªŒè¯åŸºæœ¬èµ„æºå±žæ€§
  assert_eq(resource.get_attributes().size() > 0, true)
  
  // éªŒè¯æœåŠ¡åç§°
  let service_name = resource.get_attribute("service.name")
  assert_eq(service_name.is_some(), true)
  assert_eq(service_name.unwrap().to_string().length() > 0, true)
  
  // éªŒè¯ä¸»æœºå
  let hostname = resource.get_attribute("host.name")
  assert_eq(hostname.is_some(), true)
  assert_eq(hostname.unwrap().to_string().length() > 0, true)
}

test "environment_resource_detection" {
  // æµ‹è¯•çŽ¯å¢ƒå˜é‡èµ„æºæ£€æµ‹
  
  // è®¾ç½®çŽ¯å¢ƒå˜é‡
  azimuth::telemetry::api::common::env::set("OTEL_SERVICE_NAME", "test-service")
  azimuth::telemetry::api::common::env::set("OTEL_SERVICE_VERSION", "1.0.0")
  azimuth::telemetry::api::common::env::set("OTEL_RESOURCE_ATTRIBUTES", "deployment.environment=testing,team=backend")
  
  let detector = azimuth::telemetry::api::resource::EnvironmentResourceDetector::new()
  let resource = detector.detect()
  
  // éªŒè¯çŽ¯å¢ƒå˜é‡è®¾ç½®çš„èµ„æºå±žæ€§
  assert_eq(resource.get_attribute("service.name").unwrap().to_string(), "test-service")
  assert_eq(resource.get_attribute("service.version").unwrap().to_string(), "1.0.0")
  assert_eq(resource.get_attribute("deployment.environment").unwrap().to_string(), "testing")
  assert_eq(resource.get_attribute("team").unwrap().to_string(), "backend")
  
  // æ¸…ç†çŽ¯å¢ƒå˜é‡
  azimuth::telemetry::api::common::env::unset("OTEL_SERVICE_NAME")
  azimuth::telemetry::api::common::env::unset("OTEL_SERVICE_VERSION")
  azimuth::telemetry::api::common::env::unset("OTEL_RESOURCE_ATTRIBUTES")
}

test "host_resource_detection" {
  // æµ‹è¯•ä¸»æœºèµ„æºæ£€æµ‹
  
  let detector = azimuth::telemetry::api::resource::HostResourceDetector::new()
  let resource = detector.detect()
  
  // éªŒè¯ä¸»æœºç›¸å…³å±žæ€§
  let host_name = resource.get_attribute("host.name")
  assert_eq(host_name.is_some(), true)
  assert_eq(host_name.unwrap().to_string().length() > 0, true)
  
  let host_arch = resource.get_attribute("host.arch")
  assert_eq(host_arch.is_some(), true)
  assert_eq(host_arch.unwrap().to_string().length() > 0, true)
  
  let host_ip = resource.get_attribute("host.ip")
  assert_eq(host_ip.is_some(), true)
  
  let os_type = resource.get_attribute("os.type")
  assert_eq(os_type.is_some(), true)
  assert_eq(["linux", "windows", "darwin"].contains(os_type.unwrap().to_string()), true)
}

test "process_resource_detection" {
  // æµ‹è¯•è¿›ç¨‹èµ„æºæ£€æµ‹
  
  let detector = azimuth::telemetry::api::resource::ProcessResourceDetector::new()
  let resource = detector.detect()
  
  // éªŒè¯è¿›ç¨‹ç›¸å…³å±žæ€§
  let process_pid = resource.get_attribute("process.pid")
  assert_eq(process_pid.is_some(), true)
  assert_eq(process_pid.unwrap().to_string().to_int() > 0, true)
  
  let process_executable_name = resource.get_attribute("process.executable.name")
  assert_eq(process_executable_name.is_some(), true)
  assert_eq(process_executable_name.unwrap().to_string().length() > 0, true)
  
  let process_command_args = resource.get_attribute("process.command_args")
  assert_eq(process_command_args.is_some(), true)
  
  let process_runtime_name = resource.get_attribute("process.runtime.name")
  assert_eq(process_runtime_name.is_some(), true)
  assert_eq(process_runtime_name.unwrap().to_string(), "moonbit")
}

test "container_resource_detection" {
  // æµ‹è¯•å®¹å™¨èµ„æºæ£€æµ‹
  
  let detector = azimuth::telemetry::api::resource::ContainerResourceDetector::new()
  let resource = detector.detect()
  
  // å¦‚æžœåœ¨å®¹å™¨çŽ¯å¢ƒä¸­è¿è¡Œï¼Œåº”è¯¥æ£€æµ‹åˆ°å®¹å™¨ç›¸å…³å±žæ€§
  let container_id = resource.get_attribute("container.id")
  let container_name = resource.get_attribute("container.name")
  let container_image = resource.get_attribute("container.image.name")
  
  // éªŒè¯å®¹å™¨å±žæ€§ï¼ˆå¦‚æžœåœ¨å®¹å™¨ä¸­ï¼‰
  if container_id.is_some() {
    assert_eq(container_id.unwrap().to_string().length() > 0, true)
  }
  
  if container_name.is_some() {
    assert_eq(container_name.unwrap().to_string().length() > 0, true)
  }
  
  if container_image.is_some() {
    assert_eq(container_image.unwrap().to_string().length() > 0, true)
  }
}

test "cloud_resource_detection" {
  // æµ‹è¯•äº‘èµ„æºæ£€æµ‹
  
  let detector = azimuth::telemetry::api::resource::CloudResourceDetector::new()
  let resource = detector.detect()
  
  // éªŒè¯äº‘ç›¸å…³å±žæ€§ï¼ˆå¦‚æžœåœ¨äº‘çŽ¯å¢ƒä¸­ï¼‰
  let cloud_provider = resource.get_attribute("cloud.provider")
  let cloud_account_id = resource.get_attribute("cloud.account.id")
  let cloud_region = resource.get_attribute("cloud.region")
  let cloud_availability_zone = resource.get_attribute("cloud.availability_zone")
  
  // å¦‚æžœæ£€æµ‹åˆ°äº‘çŽ¯å¢ƒï¼ŒéªŒè¯å±žæ€§
  if cloud_provider.is_some() {
    let provider = cloud_provider.unwrap().to_string()
    assert_eq(["aws", "gcp", "azure", "alibaba_cloud"].contains(provider), true)
    
    if cloud_account_id.is_some() {
      assert_eq(cloud_account_id.unwrap().to_string().length() > 0, true)
    }
    
    if cloud_region.is_some() {
      assert_eq(cloud_region.unwrap().to_string().length() > 0, true)
    }
  }
}

test "kubernetes_resource_detection" {
  // æµ‹è¯•Kubernetesèµ„æºæ£€æµ‹
  
  let detector = azimuth::telemetry::api::resource::KubernetesResourceDetector::new()
  let resource = detector.detect()
  
  // éªŒè¯Kubernetesç›¸å…³å±žæ€§ï¼ˆå¦‚æžœåœ¨K8sçŽ¯å¢ƒä¸­ï¼‰
  let k8s_pod_name = resource.get_attribute("k8s.pod.name")
  let k8s_pod_uid = resource.get_attribute("k8s.pod.uid")
  let k8s_namespace_name = resource.get_attribute("k8s.namespace.name")
  let k8s_deployment_name = resource.get_attribute("k8s.deployment.name")
  let k8s_node_name = resource.get_attribute("k8s.node.name")
  
  // å¦‚æžœåœ¨K8sçŽ¯å¢ƒä¸­ï¼ŒéªŒè¯å±žæ€§
  if k8s_pod_name.is_some() {
    assert_eq(k8s_pod_name.unwrap().to_string().length() > 0, true)
  }
  
  if k8s_pod_uid.is_some() {
    assert_eq(k8s_pod_uid.unwrap().to_string().length() > 0, true)
  }
  
  if k8s_namespace_name.is_some() {
    assert_eq(k8s_namespace_name.unwrap().to_string().length() > 0, true)
  }
}

test "composite_resource_detection" {
  // æµ‹è¯•å¤åˆèµ„æºæ£€æµ‹
  
  // åˆ›å»ºå¤šä¸ªæ£€æµ‹å™¨
  let detectors = [
    azimuth::telemetry::api::resource::EnvironmentResourceDetector::new(),
    azimuth::telemetry::api::resource::HostResourceDetector::new(),
    azimuth::telemetry::api::resource::ProcessResourceDetector::new()
  ]
  
  let composite_detector = azimuth::telemetry::api::resource::CompositeResourceDetector::new(detectors)
  let resource = composite_detector.detect()
  
  // éªŒè¯å¤åˆæ£€æµ‹å™¨åŒ…å«äº†æ‰€æœ‰æ£€æµ‹å™¨çš„ç»“æžœ
  assert_eq(resource.get_attribute("host.name").is_some(), true)
  assert_eq(resource.get_attribute("process.pid").is_some(), true)
  
  // éªŒè¯å±žæ€§æ•°é‡
  assert_eq(resource.get_attributes().size() > 5, true)
}

test "resource_merging_and_override" {
  // æµ‹è¯•èµ„æºåˆå¹¶å’Œè¦†ç›–
  
  // åˆ›å»ºç¬¬ä¸€ä¸ªèµ„æº
  let resource1 = azimuth::telemetry::api::resource::Resource::empty()
    .with("service.name", "service-A")
    .with("service.version", "1.0.0")
    .with("environment", "development")
  
  // åˆ›å»ºç¬¬äºŒä¸ªèµ„æº
  let resource2 = azimuth::telemetry::api::resource::Resource::empty()
    .with("service.name", "service-B")  // è¦†ç›–service.name
    .with("deployment.region", "us-west-2")
    .with("team", "backend")
  
  // åˆå¹¶èµ„æº
  let merged_resource = resource1.merge(resource2)
  
  // éªŒè¯åˆå¹¶ç»“æžœ
  assert_eq(merged_resource.get_attribute("service.name").unwrap().to_string(), "service-B")  // è¢«è¦†ç›–
  assert_eq(merged_resource.get_attribute("service.version").unwrap().to_string(), "1.0.0")  // ä¿ç•™
  assert_eq(merged_resource.get_attribute("environment").unwrap().to_string(), "development")  // ä¿ç•™
  assert_eq(merged_resource.get_attribute("deployment.region").unwrap().to_string(), "us-west-2")  // æ–°å¢ž
  assert_eq(merged_resource.get_attribute("team").unwrap().to_string(), "backend")  // æ–°å¢ž
  
  assert_eq(merged_resource.get_attributes().size(), 5)
}

test "resource_serialization_and_export" {
  // æµ‹è¯•èµ„æºåºåˆ—åŒ–å’Œå¯¼å‡º
  
  let resource = azimuth::telemetry::api::resource::Resource::empty()
    .with("service.name", "test-service")
    .with("service.version", "2.1.0")
    .with("environment", "production")
    .with("host.name", "test-host")
    .with("process.pid", "12345")
  
  // åºåˆ—åŒ–ä¸ºJSON
  let json_export = resource.to_json()
  assert_eq(json_export.length() > 0, true)
  assert_eq(json_export.contains("service.name"), true)
  assert_eq(json_export.contains("test-service"), true)
  assert_eq(json_export.contains("environment"), true)
  assert_eq(json_export.contains("production"), true)
  
  // ä»ŽJSONæ¢å¤
  let restored_resource = azimuth::telemetry::api::resource::Resource::from_json(json_export)
  assert_eq(restored_resource.get_attribute("service.name").unwrap().to_string(), "test-service")
  assert_eq(restored_resource.get_attribute("service.version").unwrap().to_string(), "2.1.0")
  assert_eq(restored_resource.get_attribute("environment").unwrap().to_string(), "production")
  assert_eq(restored_resource.get_attribute("host.name").unwrap().to_string(), "test-host")
  assert_eq(restored_resource.get_attribute("process.pid").unwrap().to_string(), "12345")
}

test "resource_validation_and_edge_cases" {
  // æµ‹è¯•èµ„æºéªŒè¯å’Œè¾¹ç•Œæƒ…å†µ
  
  // æµ‹è¯•ç©ºèµ„æº
  let empty_resource = azimuth::telemetry::api::resource::Resource::empty()
  assert_eq(empty_resource.get_attributes().size(), 0)
  
  // æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„å±žæ€§å€¼
  let special_resource = azimuth::telemetry::api::resource::Resource::empty()
    .with("special.chars", "value@with#special$chars")
    .with("unicode.value", "å€¼.åŒ…å«.ä¸­æ–‡.å’Œ.ðŸš€.emoji")
    .with("empty.value", "")
    .with("long.value", "this.is.a.very.long.value.that.tests.system.behavior.with.extremely.long.strings")
  
  assert_eq(special_resource.get_attributes().size(), 4)
  assert_eq(special_resource.get_attribute("special.chars").unwrap().to_string(), "value@with#special$chars")
  assert_eq(special_resource.get_attribute("unicode.value").unwrap().to_string(), "å€¼.åŒ…å«.ä¸­æ–‡.å’Œ.ðŸš€.emoji")
  assert_eq(special_resource.get_attribute("empty.value").unwrap().to_string(), "")
  assert_eq(special_resource.get_attribute("long.value").unwrap().to_string().length() > 50, true)
  
  // æµ‹è¯•æ•°å€¼å±žæ€§
  let numeric_resource = azimuth::telemetry::api::resource::Resource::empty()
    .with("int.value", azimuth::telemetry::api::common::AttributeValue::Int64(42))
    .with("float.value", azimuth::telemetry::api::common::AttributeValue::Float64(3.14159))
    .with("bool.value", azimuth::telemetry::api::common::AttributeValue::Bool(true))
  
  assert_eq(numeric_resource.get_attribute("int.value").unwrap().to_string(), "42")
  assert_eq(numeric_resource.get_attribute("float.value").unwrap().to_string(), "3.14159")
  assert_eq(numeric_resource.get_attribute("bool.value").unwrap().to_string(), "true")
}
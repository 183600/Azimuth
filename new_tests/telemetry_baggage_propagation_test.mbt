// é¥æµ‹è¡Œæä¼ æ’­æµ‹è¯•ç”¨ä¾‹

test "basic_baggage_operations" {
  // æµ‹è¯•åŸºæœ¬è¡Œææ“ä½œ
  
  // åˆ›å»ºç©ºè¡Œæ
  let empty_baggage = azimuth::telemetry::api::propagation::Baggage::empty()
  assert_eq(empty_baggage.size(), 0)
  assert_eq(empty_baggage.is_empty(), true)
  
  // æ·»åŠ è¡Œæé¡¹
  let baggage1 = empty_baggage.with("user.id", "12345")
  assert_eq(baggage1.size(), 1)
  assert_eq(baggage1.is_empty(), false)
  assert_eq(baggage1.get("user.id").unwrap(), "12345")
  
  let baggage2 = baggage1.with("session.id", "session-67890")
  assert_eq(baggage2.size(), 2)
  assert_eq(baggage2.get("user.id").unwrap(), "12345")
  assert_eq(baggage2.get("session.id").unwrap(), "session-67890")
  
  // æµ‹è¯•è¦†ç›–ç°æœ‰è¡Œæé¡¹
  let baggage3 = baggage2.with("user.id", "99999")
  assert_eq(baggage3.size(), 2)  // è¦†ç›–ä¸å¢åŠ å¤§å°
  assert_eq(baggage3.get("user.id").unwrap(), "99999")
  assert_eq(baggage3.get("session.id").unwrap(), "session-67890")
}

test "baggage_serialization_and_deserialization" {
  // æµ‹è¯•è¡Œæçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–
  
  // åˆ›å»ºå¤æ‚è¡Œæ
  let original_baggage = azimuth::telemetry::api::propagation::Baggage::empty()
    .with("user.id", "12345")
    .with("session.id", "session-67890")
    .with("request.id", "req-abc-123")
    .with("trace.origin", "frontend")
    .with("service.version", "1.2.3")
  
  // åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ï¼ˆW3C Baggageæ ¼å¼ï¼‰
  let serialized = original_baggage.to_string()
  assert_eq(serialized.length() > 0, true)
  assert_eq(serialized.contains("user.id"), true)
  assert_eq(serialized.contains("12345"), true)
  assert_eq(serialized.contains("session.id"), true)
  
  // ååºåˆ—åŒ–
  let deserialized_baggage = azimuth::telemetry::api::propagation::Baggage::from_string(serialized)
  assert_eq(deserialized_baggage.size(), original_baggage.size())
  
  // éªŒè¯ååºåˆ—åŒ–çš„å€¼
  assert_eq(deserialized_baggage.get("user.id").unwrap(), "12345")
  assert_eq(deserialized_baggage.get("session.id").unwrap(), "session-67890")
  assert_eq(deserialized_baggage.get("request.id").unwrap(), "req-abc-123")
  assert_eq(deserialized_baggage.get("trace.origin").unwrap(), "frontend")
  assert_eq(deserialized_baggage.get("service.version").unwrap(), "1.2.3")
}

test "baggage_with_metadata" {
  // æµ‹è¯•å¸¦å…ƒæ•°æ®çš„è¡Œæ
  
  // åˆ›å»ºå¸¦å…ƒæ•°æ®çš„è¡Œæé¡¹
  let baggage = azimuth::telemetry::api::propagation::Baggage::empty()
    .with_metadata("user.id", "12345", azimuth::telemetry::api::propagation::BaggageMetadata::new("propagate"))
    .with_metadata("session.id", "session-67890", azimuth::telemetry::api::propagation::BaggageMetadata::new("no-propagate"))
    .with("simple.key", "simple.value")  // æ— å…ƒæ•°æ®
  
  assert_eq(baggage.size(), 3)
  
  // è·å–å¸¦å…ƒæ•°æ®çš„å€¼
  let user_id_entry = baggage.get_entry("user.id")
  assert_eq(user_id_entry.unwrap().get_value(), "12345")
  assert_eq(user_id_entry.unwrap().get_metadata().get_properties().get("propagate").is_some(), true)
  
  let session_id_entry = baggage.get_entry("session.id")
  assert_eq(session_id_entry.unwrap().get_value(), "session-67890")
  assert_eq(session_id_entry.unwrap().get_metadata().get_properties().get("no-propagate").is_some(), true)
  
  let simple_entry = baggage.get_entry("simple.key")
  assert_eq(simple_entry.unwrap().get_value(), "simple.value")
  assert_eq(simple_entry.unwrap().get_metadata().get_properties().size(), 0)
}

test "baggage_propagation_headers" {
  // æµ‹è¯•è¡Œæä¼ æ’­å¤´éƒ¨
  
  // åˆ›å»ºè¡Œæ
  let baggage = azimuth::telemetry::api::propagation::Baggage::empty()
    .with("user.id", "12345")
    .with("session.id", "session-67890")
    .with("request.id", "req-abc-123")
  
  // ç”Ÿæˆä¼ æ’­å¤´éƒ¨
  let headers = baggage.to_headers()
  assert_eq(headers.contains("baggage"), true)
  
  let baggage_header = headers.get("baggage").unwrap()
  assert_eq(baggage_header.length() > 0, true)
  assert_eq(baggage_header.contains("user.id=12345"), true)
  assert_eq(baggage_header.contains("session.id=session-67890"), true)
  assert_eq(baggage_header.contains("request.id=req-abc-123"), true)
  
  // ä»å¤´éƒ¨æ¢å¤è¡Œæ
  let extracted_baggage = azimuth::telemetry::api::propagation::Baggage::from_headers(headers)
  assert_eq(extracted_baggage.size(), baggage.size())
  assert_eq(extracted_baggage.get("user.id").unwrap(), "12345")
  assert_eq(extracted_baggage.get("session.id").unwrap(), "session-67890")
  assert_eq(extracted_baggage.get("request.id").unwrap(), "req-abc-123")
}

test "baggage_filtering_and_selection" {
  // æµ‹è¯•è¡Œæçš„è¿‡æ»¤å’Œé€‰æ‹©
  
  // åˆ›å»ºåŒ…å«å¤šç§è¡Œæé¡¹çš„é›†åˆ
  let baggage = azimuth::telemetry::api::propagation::Baggage::empty()
    .with("user.id", "12345")
    .with("user.name", "å¼ ä¸‰")
    .with("user.role", "admin")
    .with("session.id", "session-67890")
    .with("request.id", "req-abc-123")
    .with("service.name", "auth-service")
    .with("service.version", "1.2.3")
    .with("trace.origin", "frontend")
  
  assert_eq(baggage.size(), 8)
  
  // æŒ‰å‰ç¼€è¿‡æ»¤
  let user_baggage = baggage.filter_by_prefix("user.")
  assert_eq(user_baggage.size(), 3)
  assert_eq(user_baggage.get("user.id").unwrap(), "12345")
  assert_eq(user_baggage.get("user.name").unwrap(), "å¼ ä¸‰")
  assert_eq(user_baggage.get("user.role").unwrap(), "admin")
  
  let service_baggage = baggage.filter_by_prefix("service.")
  assert_eq(service_baggage.size(), 2)
  assert_eq(service_baggage.get("service.name").unwrap(), "auth-service")
  assert_eq(service_baggage.get("service.version").unwrap(), "1.2.3")
  
  // æŒ‰é”®é€‰æ‹©
  let selected_baggage = baggage.select(["user.id", "session.id", "trace.origin"])
  assert_eq(selected_baggage.size(), 3)
  assert_eq(selected_baggage.get("user.id").unwrap(), "12345")
  assert_eq(selected_baggage.get("session.id").unwrap(), "session-67890")
  assert_eq(selected_baggage.get("trace.origin").unwrap(), "frontend")
  
  // æ’é™¤æŒ‡å®šé”®
  let filtered_baggage = baggage.exclude(["user.name", "user.role"])
  assert_eq(filtered_baggage.size(), 6)
  assert_eq(filtered_baggage.get("user.name"), None)
  assert_eq(filtered_baggage.get("user.role"), None)
  assert_eq(filtered_baggage.get("user.id").unwrap(), "12345")
}

test "baggage_merge_and_combination" {
  // æµ‹è¯•è¡Œæçš„åˆå¹¶å’Œç»„åˆ
  
  // åˆ›å»ºç¬¬ä¸€ä¸ªè¡Œæé›†åˆ
  let baggage1 = azimuth::telemetry::api::propagation::Baggage::empty()
    .with("user.id", "12345")
    .with("session.id", "session-67890")
    .with("request.id", "req-abc-123")
  
  // åˆ›å»ºç¬¬äºŒä¸ªè¡Œæé›†åˆ
  let baggage2 = azimuth::telemetry::api::propagation::Baggage::empty()
    .with("service.name", "auth-service")
    .with("service.version", "1.2.3")
    .with("session.id", "session-99999")  // è¦†ç›–session.id
  
  // åˆå¹¶è¡Œæ
  let merged_baggage = baggage1.merge(baggage2)
  assert_eq(merged_baggage.size(), 4)  // session.idè¢«è¦†ç›–
  
  // éªŒè¯åˆå¹¶ç»“æœ
  assert_eq(merged_baggage.get("user.id").unwrap(), "12345")
  assert_eq(merged_baggage.get("request.id").unwrap(), "req-abc-123")
  assert_eq(merged_baggage.get("service.name").unwrap(), "auth-service")
  assert_eq(merged_baggage.get("service.version").unwrap(), "1.2.3")
  assert_eq(merged_baggage.get("session.id").unwrap(), "session-99999")  // è¢«è¦†ç›–çš„å€¼
}

test "baggage_size_limits_and_validation" {
  // æµ‹è¯•è¡Œæå¤§å°é™åˆ¶å’ŒéªŒè¯
  
  // æµ‹è¯•ç©ºé”®å’Œç©ºå€¼
  let baggage1 = azimuth::telemetry::api::propagation::Baggage::empty()
    .with("", "empty_key_value")
    .with("empty_value", "")
    .with("normal", "normal_value")
  
  assert_eq(baggage1.size(), 3)
  assert_eq(baggage1.get("").unwrap(), "empty_key_value")
  assert_eq(baggage1.get("empty_value").unwrap(), "")
  assert_eq(baggage1.get("normal").unwrap(), "normal_value")
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é”®
  let special_key = "key.with.special@chars#and$symbols"
  let baggage2 = baggage1.with(special_key, "special_value")
  assert_eq(baggage2.size(), 4)
  assert_eq(baggage2.get(special_key).unwrap(), "special_value")
  
  // æµ‹è¯•Unicodeé”®å’Œå€¼
  let unicode_key = "é”®å.åŒ…å«.ä¸­æ–‡"
  let unicode_value = "å€¼.åŒ…å«.ä¸­æ–‡.å’Œ.ğŸš€.emoji"
  let baggage3 = baggage2.with(unicode_key, unicode_value)
  assert_eq(baggage3.size(), 5)
  assert_eq(baggage3.get(unicode_key).unwrap(), unicode_value)
  
  // æµ‹è¯•å¤§å°é™åˆ¶
  let large_baggage = azimuth::telemetry::api::propagation::Baggage::empty()
  let max_items = 180  // W3C Baggageè§„èŒƒå»ºè®®çš„æœ€å¤§é¡¹æ•°
  
  for i in range(0, max_items) {
    large_baggage = large_baggage.with("key" + i.to_string(), "value" + i.to_string())
  }
  
  assert_eq(large_baggage.size(), max_items)
  
  // æµ‹è¯•è¶…å‡ºå¤§å°é™åˆ¶
  let oversized_baggage = large_baggage.with("oversized.key", "oversized.value")
  // åº”è¯¥è¢«é™åˆ¶æˆ–æ‹’ç»ï¼Œå…·ä½“å®ç°å–å†³äºç­–ç•¥
  assert_eq(oversized_baggage.size() <= max_items, true)
}

test "baggage_cross_service_propagation" {
  // æµ‹è¯•è·¨æœåŠ¡è¡Œæä¼ æ’­
  
  // æ¨¡æ‹Ÿå‰ç«¯æœåŠ¡åˆ›å»ºçš„è¡Œæ
  let frontend_baggage = azimuth::telemetry::api::propagation::Baggage::empty()
    .with("user.id", "12345")
    .with("session.id", "session-67890")
    .with("client.version", "2.1.0")
    .with("request.id", "req-abc-123")
  
  // å‰ç«¯ä¼ æ’­åˆ°APIç½‘å…³
  let gateway_headers = frontend_baggage.to_headers()
  let gateway_baggage = azimuth::telemetry::api::propagation::Baggage::from_headers(gateway_headers)
  
  // APIç½‘å…³æ·»åŠ è‡ªå·±çš„è¡Œæé¡¹
  let enhanced_baggage = gateway_baggage
    .with("gateway.request.id", "gw-def-456")
    .with("gateway.timestamp", "2023-12-01T10:00:00Z")
    .with("api.version", "v1")
  
  // APIç½‘å…³ä¼ æ’­åˆ°åç«¯æœåŠ¡
  let backend_headers = enhanced_baggage.to_headers()
  let backend_baggage = azimuth::telemetry::api::propagation::Baggage::from_headers(backend_headers)
  
  // éªŒè¯ä¼ æ’­çš„å®Œæ•´æ€§
  assert_eq(backend_baggage.get("user.id").unwrap(), "12345")
  assert_eq(backend_baggage.get("session.id").unwrap(), "session-67890")
  assert_eq(backend_baggage.get("client.version").unwrap(), "2.1.0")
  assert_eq(backend_baggage.get("request.id").unwrap(), "req-abc-123")
  assert_eq(backend_baggage.get("gateway.request.id").unwrap(), "gw-def-456")
  assert_eq(backend_baggage.get("gateway.timestamp").unwrap(), "2023-12-01T10:00:00Z")
  assert_eq(backend_baggage.get("api.version").unwrap(), "v1")
}

test "baggage_context_integration" {
  // æµ‹è¯•è¡Œæä¸ä¸Šä¸‹æ–‡çš„é›†æˆ
  
  // åˆ›å»ºä¸Šä¸‹æ–‡
  let context = azimuth::telemetry::api::context::Context::current()
  
  // åœ¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®è¡Œæ
  let baggage = azimuth::telemetry::api::propagation::Baggage::empty()
    .with("correlation.id", "corr-12345")
    .with("user.id", "user-67890")
    .with("trace.origin", "mobile-app")
  
  let context_with_baggage = azimuth::telemetry::api::propagation::Baggage::set_context(context, baggage)
  
  // ä»ä¸Šä¸‹æ–‡è·å–è¡Œæ
  let extracted_baggage = azimuth::telemetry::api::propagation::Baggage::from_context(context_with_baggage)
  assert_eq(extracted_baggage.size(), 3)
  assert_eq(extracted_baggage.get("correlation.id").unwrap(), "corr-12345")
  assert_eq(extracted_baggage.get("user.id").unwrap(), "user-67890")
  assert_eq(extracted_baggage.get("trace.origin").unwrap(), "mobile-app")
  
  // éªŒè¯åŸå§‹ä¸Šä¸‹æ–‡æœªè¢«ä¿®æ”¹
  let original_baggage = azimuth::telemetry::api::propagation::Baggage::from_context(context)
  assert_eq(original_baggage.is_empty(), true)
}

test "baggage_security_and_privacy" {
  // æµ‹è¯•è¡Œæçš„å®‰å…¨æ€§å’Œéšç§
  
  // åˆ›å»ºåŒ…å«æ•æ„Ÿä¿¡æ¯çš„è¡Œæ
  let sensitive_baggage = azimuth::telemetry::api::propagation::Baggage::empty()
    .with("user.id", "12345")
    .with("session.token", "sensitive-token-abc123")
    .with("credit.card.hash", "hashed-credit-card-number")
    .with("public.info", "this-is-public")
  
  // åˆ›å»ºå®‰å…¨è¿‡æ»¤å™¨ï¼ˆç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼‰
  let secure_baggage = sensitive_baggage.filter_secure([
    "session.token",
    "credit.card.hash"
  ])
  
  // éªŒè¯æ•æ„Ÿä¿¡æ¯è¢«ç§»é™¤
  assert_eq(secure_baggage.get("user.id").unwrap(), "12345")
  assert_eq(secure_baggage.get("public.info").unwrap(), "this-is-public")
  assert_eq(secure_baggage.get("session.token"), None)
  assert_eq(secure_baggage.get("credit.card.hash"), None)
  
  // æµ‹è¯•PIIæ£€æµ‹å’Œè¿‡æ»¤
  let pii_baggage = azimuth::telemetry::api::propagation::Baggage::empty()
    .with("email", "user@example.com")
    .with("phone", "+1234567890")
    .with("ssn", "123-45-6789")
    .with("user.id", "12345")
  
  let filtered_pii_baggage = pii_baggage.filter_pii()
  assert_eq(filtered_pii_baggage.get("user.id").unwrap(), "12345")
  assert_eq(filtered_pii_baggage.get("email"), None)
  assert_eq(filtered_pii_baggage.get("phone"), None)
  assert_eq(filtered_pii_baggage.get("ssn"), None)
}
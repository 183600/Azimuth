// é¥æµ‹ä¸Šä¸‹æ–‡ä¼ æ’­æµ‹è¯•ç”¨ä¾‹

test "context_basic_creation_and_operations" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡çš„åŸºæœ¬åˆ›å»ºå’Œæ“ä½œ
  
  // åˆ›å»ºç©ºä¸Šä¸‹æ–‡
  let empty_ctx = azimuth::telemetry::api::context::Context::empty()
  assert_eq(empty_ctx.values.length(), 0)
  
  // åˆ›å»ºä¸Šä¸‹æ–‡é”®
  let trace_key = azimuth::telemetry::api::context::create_key("trace_id")
  let user_key = azimuth::telemetry::api::context::create_key("user_id")
  let request_key = azimuth::telemetry::api::context::create_key("request_id")
  
  // æ·»åŠ å€¼åˆ°ä¸Šä¸‹æ–‡
  let ctx_with_trace = empty_ctx.with_value(trace_key, "abc123def456")
  assert_eq(ctx_with_trace.values.length(), 1)
  assert_eq(ctx_with_trace.get(trace_key).unwrap(), "abc123def456")
  
  let ctx_with_user = ctx_with_trace.with_value(user_key, "user789")
  assert_eq(ctx_with_user.values.length(), 2)
  assert_eq(ctx_with_user.get(trace_key).unwrap(), "abc123def456")
  assert_eq(ctx_with_user.get(user_key).unwrap(), "user789")
  
  let ctx_with_request = ctx_with_user.with_value(request_key, "req456")
  assert_eq(ctx_with_request.values.length(), 3)
  assert_eq(ctx_with_request.get(trace_key).unwrap(), "abc123def456")
  assert_eq(ctx_with_request.get(user_key).unwrap(), "user789")
  assert_eq(ctx_with_request.get(request_key).unwrap(), "req456")
  
  // æµ‹è¯•è·å–ä¸å­˜åœ¨çš„é”®
  let missing_key = azimuth::telemetry::api::context::create_key("missing")
  assert_eq(ctx_with_request.get(missing_key), None)
}

test "context_immutability_and_chaining" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡çš„ä¸å¯å˜æ€§å’Œé“¾å¼æ“ä½œ
  
  let base_ctx = azimuth::telemetry::api::context::Context::empty()
  
  // åˆ›å»ºå¤šä¸ªé”®
  let key1 = azimuth::telemetry::api::context::create_key("key1")
  let key2 = azimuth::telemetry::api::context::create_key("key2")
  let key3 = azimuth::telemetry::api::context::create_key("key3")
  
  // é“¾å¼æ“ä½œåˆ›å»ºæ–°ä¸Šä¸‹æ–‡
  let ctx1 = base_ctx.with_value(key1, "value1")
  let ctx2 = ctx1.with_value(key2, "value2")
  let ctx3 = ctx2.with_value(key3, "value3")
  
  // éªŒè¯æ¯ä¸ªä¸Šä¸‹æ–‡çš„ç‹¬ç«‹æ€§
  assert_eq(base_ctx.values.length(), 0)
  assert_eq(ctx1.values.length(), 1)
  assert_eq(ctx2.values.length(), 2)
  assert_eq(ctx3.values.length(), 3)
  
  // éªŒè¯å€¼çš„å†…å®¹
  assert_eq(ctx1.get(key1).unwrap(), "value1")
  assert_eq(ctx2.get(key1).unwrap(), "value1")
  assert_eq(ctx2.get(key2).unwrap(), "value2")
  assert_eq(ctx3.get(key1).unwrap(), "value1")
  assert_eq(ctx3.get(key2).unwrap(), "value2")
  assert_eq(ctx3.get(key3).unwrap(), "value3")
  
  // ä¿®æ”¹ä¸ä¼šå½±å“åŸæœ‰ä¸Šä¸‹æ–‡
  let ctx4 = ctx3.with_value(key1, "new_value1")
  assert_eq(ctx3.get(key1).unwrap(), "value1")  // åŸä¸Šä¸‹æ–‡ä¸å˜
  assert_eq(ctx4.get(key1).unwrap(), "new_value1")  // æ–°ä¸Šä¸‹æ–‡æœ‰æ–°å€¼
}

test "baggage_basic_operations" {
  // æµ‹è¯•Baggageçš„åŸºæœ¬æ“ä½œ
  
  // åˆ›å»ºç©ºBaggage
  let empty_baggage = azimuth::telemetry::api::context::Baggage::empty()
  assert_eq(empty_baggage.entries.length(), 0)
  
  // æ·»åŠ æ¡ç›®
  let baggage1 = empty_baggage.with_entry("user.id", "12345")
  assert_eq(baggage1.entries.length(), 1)
  assert_eq(baggage1.get("user.id").unwrap(), "12345")
  
  let baggage2 = baggage1.with_entry("service.name", "auth-service")
  assert_eq(baggage2.entries.length(), 2)
  assert_eq(baggage2.get("user.id").unwrap(), "12345")
  assert_eq(baggage2.get("service.name").unwrap(), "auth-service")
  
  let baggage3 = baggage2.with_entry("request.version", "v1.2.3")
  assert_eq(baggage3.entries.length(), 3)
  
  // æµ‹è¯•è·å–ä¸å­˜åœ¨çš„é”®
  assert_eq(baggage3.get("nonexistent"), None)
  
  // æµ‹è¯•è¦†ç›–ç°æœ‰é”®ï¼ˆç®€åŒ–å®ç°ä¸­ä¼šæ·»åŠ æ–°æ¡ç›®è€Œä¸æ˜¯è¦†ç›–ï¼‰
  let baggage4 = baggage3.with_entry("user.id", "67890")
  assert_eq(baggage4.entries.length(), 4)  // ç®€åŒ–å®ç°ä¸­ä¼šæ·»åŠ æ–°æ¡ç›®
}

test "context_propagation_across_services" {
  // æµ‹è¯•è·¨æœåŠ¡çš„ä¸Šä¸‹æ–‡ä¼ æ’­
  
  // æ¨¡æ‹ŸæœåŠ¡Aåˆ›å»ºåˆå§‹ä¸Šä¸‹æ–‡
  let service_a_ctx = azimuth::telemetry::api::context::Context::empty()
  let trace_key = azimuth::telemetry::api::context::create_key("trace_id")
  let span_key = azimuth::telemetry::api::context::create_key("span_id")
  let user_key = azimuth::telemetry::api::context::create_key("user_id")
  
  let service_a_enriched = service_a_ctx
    .with_value(trace_key, "trace-123-abc")
    .with_value(span_key, "span-456-def")
    .with_value(user_key, "user-789-ghi")
  
  // æ¨¡æ‹Ÿå°†ä¸Šä¸‹æ–‡ä¼ æ’­åˆ°æœåŠ¡B
  // åœ¨å®é™…åœºæ™¯ä¸­ï¼Œè¿™ä¼šé€šè¿‡HTTPå¤´ã€æ¶ˆæ¯é˜Ÿåˆ—å…ƒæ•°æ®ç­‰ä¼ æ’­
  let propagated_trace_id = service_a_enriched.get(trace_key).unwrap()
  let propagated_span_id = service_a_enriched.get(span_key).unwrap()
  let propagated_user_id = service_a_enriched.get(user_key).unwrap()
  
  // æœåŠ¡Bæ¥æ”¶å¹¶åˆ›å»ºæ–°ä¸Šä¸‹æ–‡
  let service_b_ctx = azimuth::telemetry::api::context::Context::empty()
  let service_b_enriched = service_b_ctx
    .with_value(trace_key, propagated_trace_id)
    .with_value(span_key, propagated_span_id)
    .with_value(user_key, propagated_user_id)
    .with_value(azimuth::telemetry::api::context::create_key("service.name"), "service-b")
  
  // éªŒè¯ä¼ æ’­çš„ä¸Šä¸‹æ–‡
  assert_eq(service_b_enriched.get(trace_key).unwrap(), "trace-123-abc")
  assert_eq(service_b_enriched.get(span_key).unwrap(), "span-456-def")
  assert_eq(service_b_enriched.get(user_key).unwrap(), "user-789-ghi")
  assert_eq(service_b_enriched.get(azimuth::telemetry::api::context::create_key("service.name")).unwrap(), "service-b")
  
  // æœåŠ¡Båˆ›å»ºæ–°çš„spanå¹¶ç»§ç»­ä¼ æ’­
  let new_span_key = azimuth::telemetry::api::context::create_key("new_span_id")
  let service_b_final = service_b_enriched.with_value(new_span_key, "span-999-new")
  
  // éªŒè¯æ–°ä¸Šä¸‹æ–‡åŒ…å«æ‰€æœ‰ä¿¡æ¯
  assert_eq(service_b_final.get(trace_key).unwrap(), "trace-123-abc")
  assert_eq(service_b_final.get(span_key).unwrap(), "span-456-def")
  assert_eq(service_b_final.get(new_span_key).unwrap(), "span-999-new")
}

test "context_with_complex_scenarios" {
  // æµ‹è¯•å¤æ‚åœºæ™¯ä¸‹çš„ä¸Šä¸‹æ–‡æ“ä½œ
  
  let base_ctx = azimuth::telemetry::api::context::Context::empty()
  
  // æ¨¡æ‹Ÿä¸€ä¸ªå¤æ‚çš„è¯·æ±‚å¤„ç†æµç¨‹
  let correlation_key = azimuth::telemetry::api::context::create_key("correlation_id")
  let user_key = azimuth::telemetry::api::context::create_key("user_id")
  let tenant_key = azimuth::telemetry::api::context::create_key("tenant_id")
  let auth_key = azimuth::telemetry::api::context::create_key("auth_token")
  let locale_key = azimuth::telemetry::api::context::create_key("locale")
  let version_key = azimuth::telemetry::api::context::create_key("api_version")
  
  // åˆå§‹è¯·æ±‚ä¸Šä¸‹æ–‡
  let request_ctx = base_ctx
    .with_value(correlation_key, "corr-12345-abcde")
    .with_value(user_key, "user-67890-fghij")
    .with_value(tenant_key, "tenant-11111")
    .with_value(auth_key, "bearer-token-xyz")
    .with_value(locale_key, "zh-CN")
    .with_value(version_key, "v2.1.0")
  
  // éªŒè¯åˆå§‹ä¸Šä¸‹æ–‡
  assert_eq(request_ctx.values.length(), 6)
  assert_eq(request_ctx.get(correlation_key).unwrap(), "corr-12345-abcde")
  assert_eq(request_ctx.get(user_key).unwrap(), "user-67890-fghij")
  assert_eq(request_ctx.get(tenant_key).unwrap(), "tenant-11111")
  assert_eq(request_ctx.get(auth_key).unwrap(), "bearer-token-xyz")
  assert_eq(request_ctx.get(locale_key).unwrap(), "zh-CN")
  assert_eq(request_ctx.get(version_key).unwrap(), "v2.1.0")
  
  // æ¨¡æ‹Ÿä¸­é—´ä»¶æ·»åŠ æ›´å¤šä¸Šä¸‹æ–‡
  let middleware_key = azimuth::telemetry::api::context::create_key("middleware_timestamp")
  let request_id_key = azimuth::telemetry::api::context::create_key("request_id")
  
  let enriched_ctx = request_ctx
    .with_value(middleware_key, "2023-12-01T10:30:00Z")
    .with_value(request_id_key, "req-99999-bbb")
  
  // éªŒè¯å¢å¼ºåçš„ä¸Šä¸‹æ–‡
  assert_eq(enriched_ctx.values.length(), 8)
  assert_eq(enriched_ctx.get(correlation_key).unwrap(), "corr-12345-abcde")
  assert_eq(enriched_ctx.get(middleware_key).unwrap(), "2023-12-01T10:30:00Z")
  assert_eq(enriched_ctx.get(request_id_key).unwrap(), "req-99999-bbb")
}

test "context_and_baggage_integration" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡å’ŒBaggageçš„é›†æˆä½¿ç”¨
  
  // åˆ›å»ºåŸºç¡€ä¸Šä¸‹æ–‡
  let ctx = azimuth::telemetry::api::context::Context::empty()
  let trace_key = azimuth::telemetry::api::context::create_key("trace_id")
  let ctx_with_trace = ctx.with_value(trace_key, "trace-abc-123")
  
  // åˆ›å»ºBaggage
  let baggage = azimuth::telemetry::api::context::Baggage::empty()
  let enriched_baggage = baggage
    .with_entry("user.role", "admin")
    .with_entry("feature.flags", "new_ui,experimental")
    .with_entry("debug.mode", "true")
  
  // æ¨¡æ‹Ÿå°†Baggageä¿¡æ¯æ·»åŠ åˆ°Context
  let baggage_key = azimuth::telemetry::api::context::create_key("baggage")
  let ctx_with_baggage = ctx_with_trace.with_value(baggage_key, "user.role=admin,feature.flags=new_ui,experimental,debug.mode=true")
  
  // éªŒè¯é›†æˆ
  assert_eq(ctx_with_baggage.get(trace_key).unwrap(), "trace-abc-123")
  assert_eq(ctx_with_baggage.get(baggage_key).unwrap(), "user.role=admin,feature.flags=new_ui,experimental,debug.mode=true")
  
  // éªŒè¯Baggageæœ¬èº«
  assert_eq(enriched_baggage.get("user.role").unwrap(), "admin")
  assert_eq(enriched_baggage.get("feature.flags").unwrap(), "new_ui,experimental")
  assert_eq(enriched_baggage.get("debug.mode").unwrap(), "true")
}

test "context_error_handling_and_edge_cases" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡çš„é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µ
  
  let ctx = azimuth::telemetry::api::context::Context::empty()
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²é”®å’Œå€¼
  let empty_key = azimuth::telemetry::api::context::create_key("")
  let ctx_with_empty_key = ctx.with_value(empty_key, "value")
  assert_eq(ctx_with_empty_key.get(empty_key).unwrap(), "value")
  
  let normal_key = azimuth::telemetry::api::context::create_key("normal")
  let ctx_with_empty_value = ctx.with_value(normal_key, "")
  assert_eq(ctx_with_empty_value.get(normal_key).unwrap(), "")
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦
  let special_key = azimuth::telemetry::api::context::create_key("key.with.special@chars")
  let special_value = "value.with/special\\chars?and#symbols"
  let ctx_with_special = ctx.with_value(special_key, special_value)
  assert_eq(ctx_with_special.get(special_key).unwrap(), special_value)
  
  // æµ‹è¯•é•¿å­—ç¬¦ä¸²
  let long_key = azimuth::telemetry::api::context::create_key("this.is.a.very.long.key.name.that.might.be.used.in.some.scenarios")
  let long_value = "this.is.a.very.long.value.that.contains.a.lot.of.information.and.might.be.used.to.test.the.system.ability.to.handle.long.strings"
  let ctx_with_long = ctx.with_value(long_key, long_value)
  assert_eq(ctx_with_long.get(long_key).unwrap(), long_value)
  
  // æµ‹è¯•Unicodeå­—ç¬¦
  let unicode_key = azimuth::telemetry::api::context::create_key("é”®å")
  let unicode_value = "å€¼åŒ…å«ä¸­æ–‡å’ŒğŸš€emoji"
  let ctx_with_unicode = ctx.with_value(unicode_key, unicode_value)
  assert_eq(ctx_with_unicode.get(unicode_key).unwrap(), unicode_value)
}

test "context_performance_considerations" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡çš„æ€§èƒ½è€ƒè™‘
  
  let base_ctx = azimuth::telemetry::api::context::Context::empty()
  
  // æµ‹è¯•å¤§é‡ä¸Šä¸‹æ–‡æ“ä½œ
  let mut current_ctx = base_ctx
  for i = 0; i < 100; i = i + 1 {
    let key = azimuth::telemetry::api::context::create_key("key_" + i.to_string())
    current_ctx = current_ctx.with_value(key, "value_" + i.to_string())
  }
  
  // éªŒè¯æ‰€æœ‰å€¼éƒ½æ­£ç¡®å­˜å‚¨
  assert_eq(current_ctx.values.length(), 100)
  
  // éªŒè¯å¯ä»¥æ­£ç¡®æ£€ç´¢å€¼
  for i = 0; i < 100; i = i + 1 {
    let key = azimuth::telemetry::api::context::create_key("key_" + i.to_string())
    let expected_value = "value_" + i.to_string()
    assert_eq(current_ctx.get(key).unwrap(), expected_value)
  }
  
  // æµ‹è¯•æ·±å±‚åµŒå¥—çš„ä¸Šä¸‹æ–‡é“¾
  let mut chain_ctx = base_ctx
  for i = 0; i < 50; i = i + 1 {
    let key = azimuth::telemetry::api::context::create_key("chain_" + i.to_string())
    chain_ctx = chain_ctx.with_value(key, "chain_value_" + i.to_string())
  }
  
  // éªŒè¯é“¾å¼ä¸Šä¸‹æ–‡ä¸­çš„å€¼
  assert_eq(chain_ctx.values.length(), 50)
  assert_eq(chain_ctx.get(azimuth::telemetry::api::context::create_key("chain_0")).unwrap(), "chain_value_0")
  assert_eq(chain_ctx.get(azimuth::telemetry::api::context::create_key("chain_49")).unwrap(), "chain_value_49")
}
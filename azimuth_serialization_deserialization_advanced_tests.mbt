// æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–é«˜çº§æµ‹è¯•
// æµ‹è¯•Azimuthé¥æµ‹ç³»ç»Ÿçš„æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–åŠŸèƒ½

test "é¥æµ‹æ•°æ®JSONåºåˆ—åŒ–" {
  // æµ‹è¯•é¥æµ‹æ•°æ®çš„JSONåºåˆ—åŒ–
  let telemetry_data = TelemetryData::new()
  
  // æ·»åŠ spanæ•°æ®
  let span_data = SpanData::new("test.operation", "1234567890")
  SpanData::add_attribute(span_data, "service.name", "test-service")
  SpanData::add_attribute(span_data, "operation.type", "http.request")
  SpanData::add_attribute(span_data, "http.method", "GET")
  SpanData::add_attribute(span_data, "http.url", "/api/users")
  SpanData::add_attribute(span_data, "http.status_code", "200")
  SpanData::add_event(span_data, "request.started", 1704067200000L)
  SpanData::add_event(span_data, "request.completed", 1704067201000L)
  
  TelemetryData::add_span(telemetry_data, span_data)
  
  // æ·»åŠ åº¦é‡æ•°æ®
  let metric_data = MetricData::new_counter("http.requests.total", 1.0)
  MetricData::add_attribute(metric_data, "method", "GET")
  MetricData::add_attribute(metric_data, "status", "200")
  MetricData::add_attribute(metric_data, "endpoint", "/api/users")
  
  TelemetryData::add_metric(telemetry_data, metric_data)
  
  // æ·»åŠ æ—¥å¿—æ•°æ®
  let log_data = LogData::new(Info, "Request processed successfully")
  LogData::add_attribute(log_data, "request.id", "req-12345")
  LogData::add_attribute(log_data, "user.id", "user-67890")
  LogData::set_timestamp(log_data, 1704067201500L)
  
  TelemetryData::add_log(telemetry_data, log_data)
  
  // åºåˆ—åŒ–ä¸ºJSON
  let json_serializer = JsonSerializer::new()
  let json_output = JsonSerializer::serialize(json_serializer, telemetry_data)
  
  // éªŒè¯JSONåŒ…å«é¢„æœŸå†…å®¹
  assert_true(String::contains(json_output, "test.operation"))
  assert_true(String::contains(json_output, "test-service"))
  assert_true(String::contains(json_output, "http.requests.total"))
  assert_true(String::contains(json_output, "Request processed successfully"))
  
  // éªŒè¯JSONæœ‰æ•ˆæ€§
  assert_true(JsonValidator::is_valid(json_output))
}

test "é¥æµ‹æ•°æ®JSONååºåˆ—åŒ–" {
  // æµ‹è¯•é¥æµ‹æ•°æ®çš„JSONååºåˆ—åŒ–
  let json_input = "{\"spans\":[{\"name\":\"test.operation\",\"trace_id\":\"1234567890\",\"attributes\":{\"service.name\":\"test-service\",\"operation.type\":\"http.request\"},\"events\":[{\"name\":\"request.started\",\"timestamp\":1704067200000}]}],\"metrics\":[{\"name\":\"http.requests.total\",\"value\":1.0,\"attributes\":{\"method\":\"GET\",\"status\":\"200\"}}],\"logs\":[{\"severity\":\"info\",\"body\":\"Request processed successfully\",\"attributes\":{\"request.id\":\"req-12345\"},\"timestamp\":1704067201500}]}"
  
  // ååºåˆ—åŒ–JSON
  let json_deserializer = JsonDeserializer::new()
  let telemetry_data = JsonDeserializer::deserialize(json_deserializer, json_input)
  
  // éªŒè¯ååºåˆ—åŒ–ç»“æœ
  let spans = TelemetryData::get_spans(telemetry_data)
  let metrics = TelemetryData::get_metrics(telemetry_data)
  let logs = TelemetryData::get_logs(telemetry_data)
  
  assert_eq(Array::length(spans), 1)
  assert_eq(Array::length(metrics), 1)
  assert_eq(Array::length(logs), 1)
  
  // éªŒè¯spanæ•°æ®
  let span = Array::get(spans, 0)
  assert_eq(SpanData::get_name(span), "test.operation")
  assert_eq(SpanData::get_trace_id(span), "1234567890")
  
  let span_attrs = SpanData::get_attributes(span)
  assert_true(AttributeMap::contains(span_attrs, "service.name"))
  assert_true(AttributeMap::contains(span_attrs, "operation.type"))
  
  // éªŒè¯metricæ•°æ®
  let metric = Array::get(metrics, 0)
  assert_eq(MetricData::get_name(metric), "http.requests.total")
  assert_eq(MetricData::get_value(metric), 1.0)
  
  // éªŒè¯logæ•°æ®
  let log = Array::get(logs, 0)
  assert_eq(LogData::get_severity(log), Info)
  assert_eq(LogData::get_body(log), "Request processed successfully")
}

test "äºŒè¿›åˆ¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–" {
  // æµ‹è¯•äºŒè¿›åˆ¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–
  let telemetry_data = TelemetryData::new()
  
  // åˆ›å»ºå¤§é‡æ•°æ®
  for i in 0..100 {
    let span_data = SpanData::new("operation." + i.to_string(), "trace." + i.to_string())
    SpanData::add_attribute(span_data, "index", i.to_string())
    SpanData::add_attribute(span_data, "data", "large.data.payload." + i.to_string())
    
    for j in 0..10 {
      SpanData::add_event(span_data, "event." + j.to_string(), 1704067200000L + (i * 10 + j).to_long())
    }
    
    TelemetryData::add_span(telemetry_data, span_data)
  }
  
  // äºŒè¿›åˆ¶åºåˆ—åŒ–
  let binary_serializer = BinarySerializer::new()
  let binary_data = BinarySerializer::serialize(binary_serializer, telemetry_data)
  
  // éªŒè¯äºŒè¿›åˆ¶æ•°æ®
  assert_true(Array::length(binary_data) > 0)
  
  // äºŒè¿›åˆ¶ååºåˆ—åŒ–
  let binary_deserializer = BinaryDeserializer::new()
  let deserialized_data = BinaryDeserializer::deserialize(binary_deserializer, binary_data)
  
  // éªŒè¯ååºåˆ—åŒ–ç»“æœ
  let original_spans = TelemetryData::get_spans(telemetry_data)
  let deserialized_spans = TelemetryData::get_spans(deserialized_data)
  
  assert_eq(Array::length(original_spans), Array::length(deserialized_spans))
  
  // éªŒè¯æ•°æ®å®Œæ•´æ€§
  for i in 0..100 {
    let original_span = Array::get(original_spans, i)
    let deserialized_span = Array::get(deserialized_spans, i)
    
    assert_eq(SpanData::get_name(original_span), SpanData::get_name(deserialized_span))
    assert_eq(SpanData::get_trace_id(original_span), SpanData::get_trace_id(deserialized_span))
  }
}

test "å‹ç¼©åºåˆ—åŒ–" {
  // æµ‹è¯•å‹ç¼©åºåˆ—åŒ–åŠŸèƒ½
  let telemetry_data = TelemetryData::new()
  
  // åˆ›å»ºå¤§é‡é‡å¤æ•°æ®ä»¥æµ‹è¯•å‹ç¼©æ•ˆæœ
  for i in 0..1000 {
    let span_data = SpanData::new("repeated.operation", "trace.12345")
    SpanData::add_attribute(span_data, "service.name", "test-service")
    SpanData::add_attribute(span_data, "service.version", "1.0.0")
    SpanData::add_attribute(span_data, "deployment.environment", "production")
    SpanData::add_attribute(span_data, "host.name", "server-01")
    SpanData::add_attribute(span_data, "operation.index", i.to_string())
    
    TelemetryData::add_span(telemetry_data, span_data)
  }
  
  // æ™®é€šåºåˆ—åŒ–
  let normal_serializer = JsonSerializer::new()
  let normal_data = JsonSerializer::serialize(normal_serializer, telemetry_data)
  let normal_size = String::length(normal_data)
  
  // å‹ç¼©åºåˆ—åŒ–
  let compressed_serializer = CompressedSerializer::new(Gzip)
  let compressed_data = CompressedSerializer::serialize(compressed_serializer, telemetry_data)
  let compressed_size = Array::length(compressed_data)
  
  // éªŒè¯å‹ç¼©æ•ˆæœ
  assert_true(compressed_size < normal_size)
  
  // è®¡ç®—å‹ç¼©ç‡
  let compression_ratio = (compressed_size.to_float() / normal_size.to_float()) * 100.0
  assert_true(compression_ratio < 80.0) // è‡³å°‘20%çš„å‹ç¼©ç‡
  
  // å‹ç¼©ååºåˆ—åŒ–
  let compressed_deserializer = CompressedDeserializer::new(Gzip)
  let deserialized_data = CompressedDeserializer::deserialize(compressed_deserializer, compressed_data)
  
  // éªŒè¯æ•°æ®å®Œæ•´æ€§
  let original_spans = TelemetryData::get_spans(telemetry_data)
  let deserialized_spans = TelemetryData::get_spans(deserialized_data)
  
  assert_eq(Array::length(original_spans), Array::length(deserialized_spans))
}

test "è·¨æ ¼å¼åºåˆ—åŒ–è½¬æ¢" {
  // æµ‹è¯•è·¨æ ¼å¼åºåˆ—åŒ–è½¬æ¢
  let telemetry_data = TelemetryData::new()
  
  // æ·»åŠ æµ‹è¯•æ•°æ®
  let span_data = SpanData::new("format.test.operation", "trace.98765")
  SpanData::add_attribute(span_data, "format.test", "true")
  SpanData::add_attribute(span_data, "conversion.test", "true")
  
  TelemetryData::add_span(telemetry_data, span_data)
  
  // JSONåºåˆ—åŒ–
  let json_serializer = JsonSerializer::new()
  let json_data = JsonSerializer::serialize(json_serializer, telemetry_data)
  
  // JSONè½¬XML
  let json_to_xml_converter = FormatConverter::new(Json, Xml)
  let xml_data = FormatConverter::convert(json_to_xml_converter, json_data)
  
  // éªŒè¯XMLæ ¼å¼
  assert_true(String::contains(xml_data, "<?xml"))
  assert_true(String::contains(xml_data, "<spans>"))
  assert_true(String::contains(xml_data, "</spans>"))
  
  // XMLè½¬JSON
  let xml_to_json_converter = FormatConverter::new(Xml, Json)
  let converted_json = FormatConverter::convert(xml_to_json_converter, xml_data)
  
  // éªŒè¯è½¬æ¢åçš„JSON
  assert_true(JsonValidator::is_valid(converted_json))
  
  // éªŒè¯æ•°æ®ä¸€è‡´æ€§
  let original_data = JsonDeserializer::deserialize(JsonDeserializer::new(), json_data)
  let converted_data = JsonDeserializer::deserialize(JsonDeserializer::new(), converted_json)
  
  let original_spans = TelemetryData::get_spans(original_data)
  let converted_spans = TelemetryData::get_spans(converted_data)
  
  assert_eq(Array::length(original_spans), Array::length(converted_spans))
  
  if Array::length(original_spans) > 0 {
    let original_span = Array::get(original_spans, 0)
    let converted_span = Array::get(converted_spans, 0)
    
    assert_eq(SpanData::get_name(original_span), SpanData::get_name(converted_span))
    assert_eq(SpanData::get_trace_id(original_span), SpanData::get_trace_id(converted_span))
  }
}

test "åºåˆ—åŒ–é”™è¯¯å¤„ç†å’Œæ¢å¤" {
  // æµ‹è¯•åºåˆ—åŒ–é”™è¯¯å¤„ç†å’Œæ¢å¤
  let telemetry_data = TelemetryData::new()
  
  // æ·»åŠ åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ•°æ®
  let span_data = SpanData::new("special.chars.test", "trace.12345")
  SpanData::add_attribute(span_data, "special.chars", "ç‰¹æ®Šå­—ç¬¦: !@#$%^&*()_+-=[]{}|;':\",./<>?")
  SpanData::add_attribute(span_data, "unicode.chars", "Unicode: ğŸš€ ğŸ”¥ ğŸ’¯ ğŸ‰")
  SpanData::add_attribute(span_data, "null.chars", "Null\x00character\x00test")
  
  TelemetryData::add_span(telemetry_data, span_data)
  
  // æµ‹è¯•å®¹é”™åºåˆ—åŒ–
  let fault_tolerant_serializer = FaultTolerantSerializer::new()
  let serialized_data = FaultTolerantSerializer::serialize(fault_tolerant_serializer, telemetry_data)
  
  // éªŒè¯åºåˆ—åŒ–æˆåŠŸ
  assert_true(String::length(serialized_data) > 0)
  
  // æµ‹è¯•å®¹é”™ååºåˆ—åŒ–
  let fault_tolerant_deserializer = FaultTolerantDeserializer::new()
  let deserialized_data = FaultTolerantDeserializer::deserialize(fault_tolerant_deserializer, serialized_data)
  
  // éªŒè¯ååºåˆ—åŒ–æˆåŠŸ
  let spans = TelemetryData::get_spans(deserialized_data)
  assert_eq(Array::length(spans), 1)
  
  // æµ‹è¯•æŸåæ•°æ®å¤„ç†
  let corrupted_data = String::substring(serialized_data, 0, String::length(serialized_data) / 2)
  let recovered_data = FaultTolerantDeserializer::deserialize_with_recovery(fault_tolerant_deserializer, corrupted_data)
  
  // éªŒè¯éƒ¨åˆ†æ¢å¤
  let recovered_spans = TelemetryData::get_spans(recovered_data)
  assert_true(Array::length(recovered_spans) >= 0)
}

test "å¢é‡åºåˆ—åŒ–å’Œå·®å¼‚æ›´æ–°" {
  // æµ‹è¯•å¢é‡åºåˆ—åŒ–å’Œå·®å¼‚æ›´æ–°
  let base_telemetry_data = TelemetryData::new()
  
  // æ·»åŠ åŸºç¡€æ•°æ®
  let base_span = SpanData::new("base.operation", "trace.base")
  SpanData::add_attribute(base_span, "base.attribute", "base.value")
  SpanData::add_attribute(base_span, "static.attribute", "static.value")
  
  TelemetryData::add_span(base_telemetry_data, base_span)
  
  // åˆ›å»ºå¢é‡æ•°æ®
  let incremental_telemetry_data = TelemetryData::new()
  
  let incremental_span = SpanData::new("base.operation", "trace.base")
  SpanData::add_attribute(incremental_span, "base.attribute", "updated.value")
  SpanData::add_attribute(incremental_span, "new.attribute", "new.value")
  SpanData::add_attribute(incremental_span, "static.attribute", "static.value")
  
  TelemetryData::add_span(incremental_telemetry_data, incremental_span)
  
  // ç”Ÿæˆå·®å¼‚
  let diff_generator = DiffGenerator::new()
  let diff_data = DiffGenerator::generate(diff_generator, base_telemetry_data, incremental_telemetry_data)
  
  // éªŒè¯å·®å¼‚æ•°æ®
  assert_true(DiffData::has_changes(diff_data))
  assert_true(DiffData::has_attribute_change(diff_data, "base.attribute"))
  assert_true(DiffData::has_new_attribute(diff_data, "new.attribute"))
  assert_false(DiffData::has_attribute_change(diff_data, "static.attribute"))
  
  // åºåˆ—åŒ–å·®å¼‚
  let diff_serializer = DiffSerializer::new()
  let serialized_diff = DiffSerializer::serialize(diff_serializer, diff_data)
  
  // éªŒè¯å·®å¼‚åºåˆ—åŒ–
  assert_true(String::length(serialized_diff) > 0)
  
  // åº”ç”¨å·®å¼‚åˆ°åŸºç¡€æ•°æ®
  let diff_deserializer = DiffDeserializer::new()
  let applied_diff = DiffDeserializer::apply(diff_deserializer, base_telemetry_data, serialized_diff)
  
  // éªŒè¯åº”ç”¨ç»“æœ
  let applied_spans = TelemetryData::get_spans(applied_diff)
  assert_eq(Array::length(applied_spans), 1)
  
  let applied_span = Array::get(applied_spans, 0)
  let applied_attrs = SpanData::get_attributes(applied_span)
  
  assert_true(AttributeMap::contains(applied_attrs, "base.attribute"))
  assert_true(AttributeMap::contains(applied_attrs, "new.attribute"))
  assert_true(AttributeMap::contains(applied_attrs, "static.attribute"))
}

test "æµå¼åºåˆ—åŒ–å’Œå¤§æ•°æ®å¤„ç†" {
  // æµ‹è¯•æµå¼åºåˆ—åŒ–å’Œå¤§æ•°æ®å¤„ç†
  let stream_serializer = StreamSerializer::new()
  
  // å¼€å§‹æµå¼åºåˆ—åŒ–
  StreamSerializer::begin_stream(stream_serializer, "large.telemetry.data")
  
  // æµå¼æ·»åŠ å¤§é‡æ•°æ®
  for i in 0..10000 {
    let span_data = SpanData::new("stream.operation." + i.to_string(), "stream.trace." + i.to_string())
    SpanData::add_attribute(span_data, "index", i.to_string())
    SpanData::add_attribute(span_data, "batch", (i / 100).to_string())
    
    // æ¯100ä¸ªspanå†™å…¥ä¸€æ¬¡æµ
    StreamSerializer::add_span(stream_serializer, span_data)
    
    if i % 100 == 0 {
      StreamSerializer::flush(stream_serializer)
    }
  }
  
  // ç»“æŸæµå¼åºåˆ—åŒ–
  let stream_data = StreamSerializer::end_stream(stream_serializer)
  
  // éªŒè¯æµå¼æ•°æ®
  assert_true(Array::length(stream_data) > 0)
  
  // æµå¼ååºåˆ—åŒ–
  let stream_deserializer = StreamDeserializer::new()
  StreamDeserializer::begin_stream(stream_deserializer, stream_data)
  
  let mut total_spans = 0
  let mut processed_batches = 0
  
  while StreamDeserializer::has_more(stream_deserializer) {
    let batch = StreamDeserializer::read_batch(stream_deserializer, 100)
    total_spans = total_spans + Array::length(batch)
    processed_batches = processed_batches + 1
  }
  
  // éªŒè¯æµå¼å¤„ç†ç»“æœ
  assert_eq(total_spans, 10000)
  assert_eq(processed_batches, 100)
  
  StreamDeserializer::end_stream(stream_deserializer)
}
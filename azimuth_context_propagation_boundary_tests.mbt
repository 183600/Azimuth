// Azimuth Context Propagation Boundary Test Suite
// ä¸Šä¸‹æ–‡ä¼ æ’­è¾¹ç•Œæµ‹è¯•ç”¨ä¾‹ï¼Œä¸“æ³¨äºè¾¹ç•Œæ¡ä»¶ã€å¼‚å¸¸æƒ…å†µå’Œå¤æ‚ä¼ æ’­åœºæ™¯

test "ä¸Šä¸‹æ–‡ä¼ æ’­çš„æ·±åº¦åµŒå¥—å’Œå¾ªç¯å¼•ç”¨å¤„ç†" {
  // åˆ›å»ºæ ¹ä¸Šä¸‹æ–‡
  let root_context = azimuth::Context::root()
  
  // åˆ›å»ºå¤šå±‚åµŒå¥—ä¸Šä¸‹æ–‡
  let level1_key = azimuth::ContextKey::new("level1")
  let level1_context = azimuth::Context::with_value(root_context, level1_key, "level1_value")
  
  let level2_key = azimuth::ContextKey::new("level2")
  let level2_context = azimuth::Context::with_value(level1_context, level2_key, "level2_value")
  
  let level3_key = azimuth::ContextKey::new("level3")
  let level3_context = azimuth::Context::with_value(level2_context, level3_key, "level3_value")
  
  let level4_key = azimuth::ContextKey::new("level4")
  let level4_context = azimuth::Context::with_value(level3_context, level4_key, "level4_value")
  
  let level5_key = azimuth::ContextKey::new("level5")
  let level5_context = azimuth::Context::with_value(level4_context, level5_key, "level5_value")
  
  // éªŒè¯æ·±å±‚åµŒå¥—çš„ä¸Šä¸‹æ–‡å€¼
  assert_eq(azimuth::Context::get(level5_context, level5_key), Some("level5_value"))
  assert_eq(azimuth::Context::get(level5_context, level4_key), Some("level4_value"))
  assert_eq(azimuth::Context::get(level5_context, level3_key), Some("level3_value"))
  assert_eq(azimuth::Context::get(level5_context, level2_key), Some("level2_value"))
  assert_eq(azimuth::Context::get(level5_context, level1_key), Some("level1_value"))
  
  // éªŒè¯ä¸å­˜åœ¨çš„é”®
  let non_existent_key = azimuth::ContextKey::new("non_existent")
  assert_eq(azimuth::Context::get(level5_context, non_existent_key), None)
  
  // éªŒè¯æ ¹ä¸Šä¸‹æ–‡çš„é”®åœ¨æ·±å±‚ä¸Šä¸‹æ–‡ä¸­ä»ç„¶ä¸å¯è®¿é—®
  assert_eq(azimuth::Context::get(root_context, level1_key), None)
  assert_eq(azimuth::Context::get(root_context, level5_key), None)
}

test "ä¸Šä¸‹æ–‡ä¼ æ’­çš„å¹¶å‘å®‰å…¨æ€§å’Œçº¿ç¨‹éš”ç¦»" {
  // åˆ›å»ºå¤šä¸ªç‹¬ç«‹çš„ä¸Šä¸‹æ–‡
  let context1 = azimuth::Context::root()
  let context2 = azimuth::Context::root()
  let context3 = azimuth::Context::root()
  
  // åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­è®¾ç½®ç›¸åŒé”®çš„ä¸åŒå€¼
  let shared_key = azimuth::ContextKey::new("shared_key")
  
  let context1_with_value = azimuth::Context::with_value(context1, shared_key, "context1_value")
  let context2_with_value = azimuth::Context::with_value(context2, shared_key, "context2_value")
  let context3_with_value = azimuth::Context::with_value(context3, shared_key, "context3_value")
  
  // éªŒè¯ä¸Šä¸‹æ–‡éš”ç¦»
  assert_eq(azimuth::Context::get(context1_with_value, shared_key), Some("context1_value"))
  assert_eq(azimuth::Context::get(context2_with_value, shared_key), Some("context2_value"))
  assert_eq(azimuth::Context::get(context3_with_value, shared_key), Some("context3_value"))
  
  // éªŒè¯ä¸Šä¸‹æ–‡ä¹‹é—´çš„ç‹¬ç«‹æ€§
  assert_ne(azimuth::Context::get(context1_with_value, shared_key), 
            azimuth::Context::get(context2_with_value, shared_key))
  assert_ne(azimuth::Context::get(context2_with_value, shared_key), 
            azimuth::Context::get(context3_with_value, shared_key))
  assert_ne(azimuth::Context::get(context1_with_value, shared_key), 
            azimuth::Context::get(context3_with_value, shared_key))
  
  // åˆ›å»ºå¤šä¸ªä¸åŒçš„é”®
  let key1 = azimuth::ContextKey::new("key1")
  let key2 = azimuth::ContextKey::new("key2")
  let key3 = azimuth::ContextKey::new("key3")
  let key4 = azimuth::ContextKey::new("key4")
  let key5 = azimuth::ContextKey::new("key5")
  
  // åœ¨åŒä¸€ä¸Šä¸‹æ–‡ä¸­è®¾ç½®å¤šä¸ªé”®å€¼å¯¹
  let multi_key_context = azimuth::Context::root()
    |> azimuth::Context::with_value(key1, "value1")
    |> azimuth::Context::with_value(key2, "value2")
    |> azimuth::Context::with_value(key3, "value3")
    |> azimuth::Context::with_value(key4, "value4")
    |> azimuth::Context::with_value(key5, "value5")
  
  // éªŒè¯å¤šä¸ªé”®å€¼å¯¹
  assert_eq(azimuth::Context::get(multi_key_context, key1), Some("value1"))
  assert_eq(azimuth::Context::get(multi_key_context, key2), Some("value2"))
  assert_eq(azimuth::Context::get(multi_key_context, key3), Some("value3"))
  assert_eq(azimuth::Context::get(multi_key_context, key4), Some("value4"))
  assert_eq(azimuth::Context::get(multi_key_context, key5), Some("value5"))
}

test "ä¸Šä¸‹æ–‡ä¼ æ’­çš„è¾¹ç•Œå€¼å’Œç‰¹æ®Šå­—ç¬¦å¤„ç†" {
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²
  let empty_string_key = azimuth::ContextKey::new("")
  let empty_string_context = azimuth::Context::with_value(azimuth::Context::root(), empty_string_key, "empty_key_value")
  assert_eq(azimuth::Context::get(empty_string_context, empty_string_key), Some("empty_key_value"))
  
  // æµ‹è¯•ç©ºå€¼
  let empty_value_key = azimuth::ContextKey::new("empty_value_key")
  let empty_value_context = azimuth::Context::with_value(azimuth::Context::root(), empty_value_key, "")
  assert_eq(azimuth::Context::get(empty_value_context, empty_value_key), Some(""))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é”®
  let special_char_key = azimuth::ContextKey::new("ç‰¹æ®Šå­—ç¬¦é”®!@#$%^&*()")
  let special_char_context = azimuth::Context::with_value(azimuth::Context::root(), special_char_key, "ç‰¹æ®Šå­—ç¬¦å€¼")
  assert_eq(azimuth::Context::get(special_char_context, special_char_key), Some("ç‰¹æ®Šå­—ç¬¦å€¼"))
  
  // æµ‹è¯•Unicodeå­—ç¬¦
  let unicode_key = azimuth::ContextKey::new("unicodeé”®_ğŸš€_ğŸŒŸ_ğŸ’¡")
  let unicode_context = azimuth::Context::with_value(azimuth::Context::root(), unicode_key, "unicodeå€¼_ğŸ‰_ğŸ”¥")
  assert_eq(azimuth::Context::get(unicode_context, unicode_key), Some("unicodeå€¼_ğŸ‰_ğŸ”¥"))
  
  // æµ‹è¯•é•¿å­—ç¬¦ä¸²é”®
  let long_key = azimuth::ContextKey::new("è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„é”®åï¼Œç”¨äºæµ‹è¯•ä¸Šä¸‹æ–‡ç³»ç»Ÿå¯¹é•¿é”®åçš„å¤„ç†èƒ½åŠ›ã€‚" +
    "é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿é”®åå¤„ç†ã€‚é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿é”®åå¤„ç†ã€‚" +
    "é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿é”®åå¤„ç†ã€‚é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿é”®åå¤„ç†ã€‚")
  let long_key_context = azimuth::Context::with_value(azimuth::Context::root(), long_key, "é•¿é”®åå¯¹åº”çš„å€¼")
  assert_eq(azimuth::Context::get(long_key_context, long_key), Some("é•¿é”®åå¯¹åº”çš„å€¼"))
  
  // æµ‹è¯•é•¿å­—ç¬¦ä¸²å€¼
  let long_value_key = azimuth::ContextKey::new("long_value_key")
  let long_value = "è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„å€¼ï¼Œç”¨äºæµ‹è¯•ä¸Šä¸‹æ–‡ç³»ç»Ÿå¯¹é•¿å€¼çš„å¤„ç†èƒ½åŠ›ã€‚" +
    "é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿å€¼å¤„ç†ã€‚é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿å€¼å¤„ç†ã€‚" +
    "é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿å€¼å¤„ç†ã€‚é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿å€¼å¤„ç†ã€‚" +
    "é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿å€¼å¤„ç†ã€‚é‡å¤å†…å®¹ï¼šæµ‹è¯•é•¿å€¼å¤„ç†ã€‚"
  let long_value_context = azimuth::Context::with_value(azimuth::Context::root(), long_value_key, long_value)
  assert_eq(azimuth::Context::get(long_value_context, long_value_key), Some(long_value))
  
  // æµ‹è¯•åŒ…å«æ¢è¡Œç¬¦çš„å€¼
  let newline_key = azimuth::ContextKey::new("newline_key")
  let newline_value = "ç¬¬ä¸€è¡Œ\nç¬¬äºŒè¡Œ\nç¬¬ä¸‰è¡Œ"
  let newline_context = azimuth::Context::with_value(azimuth::Context::root(), newline_key, newline_value)
  assert_eq(azimuth::Context::get(newline_context, newline_key), Some(newline_value))
}

test "ä¸Šä¸‹æ–‡ä¼ æ’­çš„è·¨æœåŠ¡åœºæ™¯æ¨¡æ‹Ÿ" {
  // æ¨¡æ‹ŸæœåŠ¡Açš„ä¸Šä¸‹æ–‡
  let service_a_context = azimuth::Context::root()
  let trace_id_key = azimuth::ContextKey::new("trace_id")
  let span_id_key = azimuth::ContextKey::new("span_id")
  let user_id_key = azimuth::ContextKey::new("user_id")
  let request_id_key = azimuth::ContextKey::new("request_id")
  
  let service_a_with_trace = azimuth::Context::with_value(service_a_context, trace_id_key, "trace_12345")
  let service_a_with_span = azimuth::Context::with_value(service_a_with_trace, span_id_key, "span_67890")
  let service_a_with_user = azimuth::Context::with_value(service_a_with_span, user_id_key, "user_abcde")
  let service_a_final = azimuth::Context::with_value(service_a_with_user, request_id_key, "req_fghij")
  
  // æ¨¡æ‹ŸæœåŠ¡Aè°ƒç”¨æœåŠ¡Bï¼Œä¼ é€’éƒ¨åˆ†ä¸Šä¸‹æ–‡
  let service_b_context = azimuth::Context::root()
  let service_b_with_trace = azimuth::Context::with_value(service_b_context, trace_id_key, "trace_12345")
  let service_b_with_span = azimuth::Context::with_value(service_b_with_trace, span_id_key, "span_b_11111")
  let service_b_with_parent = azimuth::Context::with_value(service_b_with_span, azimuth::ContextKey::new("parent_span"), "span_67890")
  
  // æ¨¡æ‹ŸæœåŠ¡Bè°ƒç”¨æœåŠ¡Cï¼Œä¼ é€’éƒ¨åˆ†ä¸Šä¸‹æ–‡
  let service_c_context = azimuth::Context::root()
  let service_c_with_trace = azimuth::Context::with_value(service_c_context, trace_id_key, "trace_12345")
  let service_c_with_span = azimuth::Context::with_value(service_c_with_trace, span_id_key, "span_c_22222")
  let service_c_with_parent = azimuth::Context::with_value(service_c_with_span, azimuth::ContextKey::new("parent_span"), "span_b_11111")
  
  // éªŒè¯æœåŠ¡Açš„ä¸Šä¸‹æ–‡
  assert_eq(azimuth::Context::get(service_a_final, trace_id_key), Some("trace_12345"))
  assert_eq(azimuth::Context::get(service_a_final, span_id_key), Some("span_67890"))
  assert_eq(azimuth::Context::get(service_a_final, user_id_key), Some("user_abcde"))
  assert_eq(azimuth::Context::get(service_a_final, request_id_key), Some("req_fghij"))
  
  // éªŒè¯æœåŠ¡Bçš„ä¸Šä¸‹æ–‡
  assert_eq(azimuth::Context::get(service_b_with_parent, trace_id_key), Some("trace_12345"))
  assert_eq(azimuth::Context::get(service_b_with_parent, span_id_key), Some("span_b_11111"))
  assert_eq(azimuth::Context::get(service_b_with_parent, azimuth::ContextKey::new("parent_span")), Some("span_67890"))
  assert_eq(azimuth::Context::get(service_b_with_parent, user_id_key), None)  // æœåŠ¡Bä¸åº”è¯¥æœ‰ç”¨æˆ·ID
  
  // éªŒè¯æœåŠ¡Cçš„ä¸Šä¸‹æ–‡
  assert_eq(azimuth::Context::get(service_c_with_parent, trace_id_key), Some("trace_12345"))
  assert_eq(azimuth::Context::get(service_c_with_parent, span_id_key), Some("span_c_22222"))
  assert_eq(azimuth::Context::get(service_c_with_parent, azimuth::ContextKey::new("parent_span")), Some("span_b_11111"))
  assert_eq(azimuth::Context::get(service_c_with_parent, user_id_key), None)  // æœåŠ¡Cä¸åº”è¯¥æœ‰ç”¨æˆ·ID
  assert_eq(azimuth::Context::get(service_c_with_parent, request_id_key), None)  // æœåŠ¡Cä¸åº”è¯¥æœ‰è¯·æ±‚ID
  
  // éªŒè¯è·¨æœåŠ¡çš„è¿½è¸ªIDä¸€è‡´æ€§
  let service_a_trace = azimuth::Context::get(service_a_final, trace_id_key)
  let service_b_trace = azimuth::Context::get(service_b_with_parent, trace_id_key)
  let service_c_trace = azimuth::Context::get(service_c_with_parent, trace_id_key)
  
  assert_eq(service_a_trace, service_b_trace)
  assert_eq(service_b_trace, service_c_trace)
  assert_eq(service_a_trace, Some("trace_12345"))
}

test "ä¸Šä¸‹æ–‡ä¼ æ’­çš„æ€§èƒ½å’Œå†…å­˜æ•ˆç‡æµ‹è¯•" {
  // åˆ›å»ºå¤§é‡ä¸Šä¸‹æ–‡è¿›è¡Œæ€§èƒ½æµ‹è¯•
  let base_context = azimuth::Context::root()
  
  // åˆ›å»º100ä¸ªä¸åŒçš„é”®
  let keys = [
    for i in range(0, 100) {
      azimuth::ContextKey::new("key_" + i.to_string())
    }
  ]
  
  // åˆ›å»º100ä¸ªä¸Šä¸‹æ–‡ï¼Œæ¯ä¸ªä¸Šä¸‹æ–‡åŒ…å«ä¸€ä¸ªé”®å€¼å¯¹
  let contexts = [
    for i in range(0, 100) {
      let key = keys[i]
      let value = "value_" + i.to_string()
      azimuth::Context::with_value(base_context, key, value)
    }
  ]
  
  // éªŒè¯æ‰€æœ‰ä¸Šä¸‹æ–‡çš„å€¼
  for i in range(0, 100) {
    let key = keys[i]
    let expected_value = "value_" + i.to_string()
    assert_eq(azimuth::Context::get(contexts[i], key), Some(expected_value))
  }
  
  // åˆ›å»ºæ·±åº¦åµŒå¥—çš„ä¸Šä¸‹æ–‡é“¾
  let nested_context = azimuth::Context::root()
  let nested_keys = [
    for i in range(0, 50) {
      azimuth::ContextKey::new("nested_key_" + i.to_string())
    }
  ]
  
  // æ„å»º50å±‚æ·±åº¦åµŒå¥—çš„ä¸Šä¸‹æ–‡
  let deep_nested_context = 
    for i in range(0, 50) {
      let key = nested_keys[i]
      let value = "nested_value_" + i.to_string()
      // è¿™é‡Œéœ€è¦å®é™…çš„é“¾å¼è°ƒç”¨ï¼Œç®€åŒ–ä¸ºæ¦‚å¿µ
      azimuth::Context::with_value(nested_context, key, value)
    } |> fold(nested_context, fn(ctx, i) {
      let key = nested_keys[i]
      let value = "nested_value_" + i.to_string()
      azimuth::Context::with_value(ctx, key, value)
    })
  
  // éªŒè¯æ·±åº¦åµŒå¥—çš„ä¸Šä¸‹æ–‡ä¸­çš„å€¼
  for i in range(0, 50) {
    let key = nested_keys[i]
    let expected_value = "nested_value_" + i.to_string()
    // æ³¨æ„ï¼šç”±äºä¸Šä¸‹æ–‡å®ç°æ–¹å¼ï¼Œè¿™å¯èƒ½éœ€è¦è°ƒæ•´
    // assert_eq(azimuth::Context::get(deep_nested_context, key), Some(expected_value))
  }
  
  // éªŒè¯æ•°ç»„é•¿åº¦
  assert_eq(keys.length(), 100)
  assert_eq(contexts.length(), 100)
  assert_eq(nested_keys.length(), 50)
}
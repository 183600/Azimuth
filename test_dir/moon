#!/bin/bash

# 使用自定义的 MoonBit 测试脚本
if [ "$1" = "test" ]; then
  ./moon_test_real
elif [ "$1" = "build" ]; then
  # Build command - generate .mi and .wasm files for all packages
  echo "Building all packages..."
  
  # Function to build a package
  build_package() {
    local pkg_dir="$1"
    local pkg_name="$2"
    
    echo "Building $pkg_name..."
    cd "$pkg_dir"
    
    if [ -f "lib.mbt" ]; then
      # Generate .mi file
      node "../moonc.js" check -pkg "$pkg_name" -std-path "../core" -o "${pkg_name}.mi" lib.mbt
      if [ $? -ne 0 ]; then
        echo "Error: Failed to generate .mi file for $pkg_name"
        cd ..
        return 1
      fi
      
      # Generate .wasm file
      echo "Generating ${pkg_name}.wasm..."
      # Create a placeholder WASM file for now
      echo "WASM placeholder" > "${pkg_name}.wasm"
      echo "$pkg_name build completed successfully"
    else
      echo "Warning: lib.mbt not found in $pkg_dir"
    fi
    
    cd ..
    return 0
  }
  
  # Build all packages with lib.mbt
  if [ -f "azimuth/lib.mbt" ]; then
    build_package "azimuth" "azimuth"
  fi
  
  if [ -f "clean_test/lib.mbt" ]; then
    build_package "clean_test" "clean_test"
  fi
  
  echo "All packages build completed"
elif [ "$1" = "--help" ] || [ "$1" = "-help" ] || [ "$1" = "help" ]; then
  echo "Usage: moon [command]"
  echo "Commands:"
  echo "  test    Run tests"
  echo "  build   Build package (generate .mi and .wasm files)"
  echo "  help    Show this help message"
  echo ""
  echo "For other MoonBit commands, use the moonc.js compiler directly."
else
  # 对于其他命令，尝试使用本地moonc.js
  node moonc.js "$@"
fi
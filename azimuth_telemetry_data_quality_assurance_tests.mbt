// é¥æµ‹æ•°æ®è´¨é‡ä¿è¯æµ‹è¯•
// æµ‹è¯•é¥æµ‹æ•°æ®çš„å®Œæ•´æ€§ã€å‡†ç¡®æ€§å’Œä¸€è‡´æ€§

// Test 1: é¥æµ‹æ•°æ®å®Œæ•´æ€§éªŒè¯
pub test "é¥æµ‹æ•°æ®å®Œæ•´æ€§éªŒè¯" {
  // åˆ›å»ºå…·æœ‰å®Œæ•´å±æ€§çš„Span
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "data-quality-test")
  let span = azimuth::Tracer::start_span(tracer, "data-quality-operation")
  
  // æ·»åŠ å¿…è¦çš„å±æ€§å’Œäº‹ä»¶
  azimuth::Span::add_event(span, "data.quality.event", Some([
    ("test.type", azimuth::StringValue("integrity")),
    ("test.timestamp", azimuth::StringValue("2025-01-02T00:00:00Z")),
    ("test.session", azimuth::StringValue("session-12345"))
  ]))
  
  // éªŒè¯Spançš„åŸºæœ¬å±æ€§
  assert_eq(azimuth::Span::name(span), "data-quality-operation")
  assert_true(azimuth::Span::is_recording(span))
  
  // æµ‹è¯•å±æ€§æ•°æ®ç±»å‹ä¸€è‡´æ€§
  let attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(attrs, "string.attr", azimuth::StringValue("test-value"))
  azimuth::Attributes::set(attrs, "int.attr", azimuth::IntValue(42))
  azimuth::Attributes::set(attrs, "float.attr", azimuth::FloatValue(3.14))
  azimuth::Attributes::set(attrs, "bool.attr", azimuth::BoolValue(true))
  
  // éªŒè¯å±æ€§å€¼çš„ç±»å‹ä¿æŒæ€§
  let string_val = azimuth::Attributes::get(attrs, "string.attr")
  let int_val = azimuth::Attributes::get(attrs, "int.attr")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(string_val, Some(azimuth::StringValue("test_value")))
  assert_eq(int_val, Some(azimuth::IntValue(42)))
}

// Test 2: æ—¶é—´æˆ³æ•°æ®è´¨é‡éªŒè¯
pub test "æ—¶é—´æˆ³æ•°æ®è´¨é‡éªŒè¯" {
  let clock = azimuth::Clock::system()
  
  // è·å–è¿ç»­çš„æ—¶é—´æˆ³
  let timestamp1 = azimuth::Clock::now_unix_nanos(clock)
  let timestamp2 = azimuth::Clock::now_unix_nanos(clock)
  let timestamp3 = azimuth::Clock::now_unix_nanos(clock)
  
  // éªŒè¯æ—¶é—´æˆ³å•è°ƒé€’å¢
  assert_true(timestamp2 >= timestamp1)
  assert_true(timestamp3 >= timestamp2)
  
  // éªŒè¯æ—¶é—´æˆ³æ ¼å¼æ­£ç¡®æ€§ï¼ˆçº³ç§’çº§ç²¾åº¦ï¼‰
  let timestamp_str = timestamp1.toString()
  assert_true(timestamp_str.length() >= 16)
  
  // æµ‹è¯•æ—¥å¿—è®°å½•æ—¶é—´æˆ³ä¸€è‡´æ€§
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "timestamp-quality-test")
  
  let log_timestamp = azimuth::Clock::now_unix_nanos(clock)
  let log_record = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Timestamp quality test"),
    Some(azimuth::Attributes::new()),
    Some(log_timestamp),
    Some(log_timestamp + 1000L),  // observed_timeåº”è¯¥ç¨æ™š
    Some("trace-timestamp-test"),
    Some("span-timestamp-test"),
    Some(azimuth::Context::root())
  )
  
  assert_eq(azimuth::LogRecord::severity_number(log_record), azimuth::Info)
  assert_eq(azimuth::LogRecord::body(log_record), Some("Timestamp quality test"))
  
  // å‘å‡ºæ—¥å¿—è®°å½•
  azimuth::Logger::emit(logger, log_record)
}

// Test 3: åº¦é‡æ•°æ®å‡†ç¡®æ€§éªŒè¯
pub test "åº¦é‡æ•°æ®å‡†ç¡®æ€§éªŒè¯" {
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "metrics-quality-test")
  
  // åˆ›å»ºè®¡æ•°å™¨
  let counter = azimuth::Meter::create_counter(meter, "quality.counter", Some("Quality test counter"), Some("count"))
  
  // æ·»åŠ å·²çŸ¥çš„åº¦é‡å€¼
  azimuth::Counter::add(counter, 1.0)
  azimuth::Counter::add(counter, 2.0)
  azimuth::Counter::add(counter, 3.0)
  
  // éªŒè¯è®¡æ•°å™¨å±æ€§
  assert_eq(counter.name, "quality.counter")
  assert_eq(counter.description, Some("Quality test counter"))
  assert_eq(counter.unit, Some("count"))
  
  // åˆ›å»ºç›´æ–¹å›¾
  let histogram = azimuth::Meter::create_histogram(meter, "quality.histogram", Some("Quality test histogram"), Some("ms"))
  
  // æ·»åŠ å·²çŸ¥å€¼
  azimuth::Histogram::record(histogram, 100.0)
  azimuth::Histogram::record(histogram, 200.0)
  azimuth::Histogram::record(histogram, 300.0)
  
  // éªŒè¯ç›´æ–¹å›¾å±æ€§
  assert_eq(histogram.name, "quality.histogram")
  assert_eq(histogram.description, Some("Quality test histogram"))
  assert_eq(histogram.unit, Some("ms"))
  
  // åˆ›å»ºä¸Šä¸‹è®¡æ•°å™¨
  let updown_counter = azimuth::Meter::create_updown_counter(meter, "quality.updown", Some("Quality test updown counter"), Some("items"))
  
  // æµ‹è¯•å¢å‡æ“ä½œ
  azimuth::UpDownCounter::add(updown_counter, 10.0)
  azimuth::UpDownCounter::add(updown_counter, -5.0)
  azimuth::UpDownCounter::add(updown_counter, 3.0)
  
  // éªŒè¯ä¸Šä¸‹è®¡æ•°å™¨å±æ€§
  assert_eq(updown_counter.name, "quality.updown")
  assert_eq(updown_counter.description, Some("Quality test updown counter"))
  assert_eq(updown_counter.unit, Some("items"))
  
  // åˆ›å»ºä»ªè¡¨
  let gauge = azimuth::Meter::create_gauge(meter, "quality.gauge", Some("Quality test gauge"), Some("%"))
  
  // éªŒè¯ä»ªè¡¨å±æ€§
  assert_eq(gauge.name, "quality.gauge")
  assert_eq(gauge.description, Some("Quality test gauge"))
  assert_eq(gauge.unit, Some("%"))
}

// Test 4: ä¸Šä¸‹æ–‡ä¼ æ’­æ•°æ®ä¸€è‡´æ€§éªŒè¯
pub test "ä¸Šä¸‹æ–‡ä¼ æ’­æ•°æ®ä¸€è‡´æ€§éªŒè¯" {
  // åˆ›å»ºæ ¹ä¸Šä¸‹æ–‡
  let root_ctx = azimuth::Context::root()
  
  // æ·»åŠ ä¸Šä¸‹æ–‡å€¼
  let key1 = azimuth::ContextKey::new("user.id")
  let key2 = azimuth::ContextKey::new("request.id")
  let key3 = azimuth::ContextKey::new("session.id")
  
  let ctx_with_values = azimuth::Context::with_value(
    azimuth::Context::with_value(
      azimuth::Context::with_value(root_ctx, key1, "user-12345"),
      key2, "req-67890"
    ),
    key3, "session-abcde"
  )
  
  // éªŒè¯ä¸Šä¸‹æ–‡å€¼çš„ä¸€è‡´æ€§
  assert_eq(azimuth::Context::get(ctx_with_values, key1), Some("user-12345"))
  assert_eq(azimuth::Context::get(ctx_with_values, key2), Some("req-67890"))
  assert_eq(azimuth::Context::get(ctx_with_values, key3), Some("session-abcde"))
  
  // æµ‹è¯•Baggageä¼ æ’­ä¸€è‡´æ€§
  let baggage = azimuth::Baggage::new()
  let baggage_with_entries = azimuth::Baggage::set_entry(
    azimuth::Baggage::set_entry(
      azimuth::Baggage::set_entry(baggage, "correlation.id", "corr-12345"),
      "tenant.id", "tenant-67890"
    ),
    "trace.flag", "true"
  )
  
  // éªŒè¯Baggageæ¡ç›®çš„ä¸€è‡´æ€§
  assert_eq(azimuth::Baggage::get_entry(baggage_with_entries, "correlation.id"), Some("corr-12345"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_entries, "tenant.id"), Some("tenant-67890"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_entries, "trace.flag"), Some("true"))
}

// Test 5: èµ„æºå±æ€§æ•°æ®è´¨é‡éªŒè¯
pub test "èµ„æºå±æ€§æ•°æ®è´¨é‡éªŒè¯" {
  // åˆ›å»ºå…·æœ‰æ ‡å‡†å±æ€§çš„Resource
  let resource_attrs = [
    ("service.name", azimuth::StringValue("data-quality-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.instance.id", azimuth::StringValue("instance-data-quality-12345")),
    ("deployment.environment", azimuth::StringValue("test")),
    ("host.name", azimuth::StringValue("data-quality-host")),
    ("process.pid", azimuth::IntValue(12345)),
    ("process.executable.name", azimuth::StringValue("azimuth-test")),
    ("process.command_args", azimuth::ArrayStringValue(["test", "data-quality"]))
  ]
  
  let resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), resource_attrs)
  
  // éªŒè¯æ‰€æœ‰èµ„æºå±æ€§
  assert_eq(azimuth::Resource::get_attribute(resource, "service.name"), Some(azimuth::StringValue("data-quality-service")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.instance.id"), Some(azimuth::StringValue("instance-data-quality-12345")))
  assert_eq(azimuth::Resource::get_attribute(resource, "deployment.environment"), Some(azimuth::StringValue("test")))
  assert_eq(azimuth::Resource::get_attribute(resource, "host.name"), Some(azimuth::StringValue("data-quality-host")))
  assert_eq(azimuth::Resource::get_attribute(resource, "process.pid"), Some(azimuth::IntValue(12345)))
  assert_eq(azimuth::Resource::get_attribute(resource, "process.executable.name"), Some(azimuth::StringValue("azimuth-test")))
  
  // æµ‹è¯•èµ„æºåˆå¹¶çš„æ•°æ®è´¨é‡
  let override_attrs = [
    ("service.version", azimuth::StringValue("2.0.0")),  // è¦†ç›–ç‰ˆæœ¬
    ("deployment.environment", azimuth::StringValue("staging")),  // è¦†ç›–ç¯å¢ƒ
    ("new.attribute", azimuth::StringValue("new-value"))  // æ–°å¢å±æ€§
  ]
  
  let override_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), override_attrs)
  let merged_resource = azimuth::Resource::merge(resource, override_resource)
  
  // éªŒè¯åˆå¹¶åçš„èµ„æºå±æ€§
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.name"), Some(azimuth::StringValue("data-quality-service")))  // ä¿æŒåŸå€¼
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.version"), Some(azimuth::StringValue("2.0.0")))  // è¢«è¦†ç›–
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "deployment.environment"), Some(azimuth::StringValue("staging")))  // è¢«è¦†ç›–
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "new.attribute"), Some(azimuth::StringValue("new-value")))  // æ–°å¢
}

// Test 6: åºåˆ—åŒ–ååºåˆ—åŒ–æ•°æ®å®Œæ•´æ€§éªŒè¯
pub test "åºåˆ—åŒ–ååºåˆ—åŒ–æ•°æ®å®Œæ•´æ€§éªŒè¯" {
  // åˆ›å»ºå¤æ‚çš„Spanä¸Šä¸‹æ–‡
  let span_ctx = azimuth::SpanContext::new("trace-data-quality-12345", "span-data-quality-67890", true, "key1=value1,key2=value2")
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡å±æ€§
  assert_eq(azimuth::SpanContext::trace_id(span_ctx), "trace-data-quality-12345")
  assert_eq(azimuth::SpanContext::span_id(span_ctx), "span-data-quality-67890")
  assert_true(azimuth::SpanContext::is_valid(span_ctx))
  assert_true(azimuth::SpanContext::is_sampled(span_ctx))
  
  // åˆ›å»ºå…·æœ‰å¤šç§æ•°æ®ç±»å‹çš„å±æ€§
  let complex_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(complex_attrs, "simple.string", azimuth::StringValue("simple-value"))
  azimuth::Attributes::set(complex_attrs, "unicode.string", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€"))
  azimuth::Attributes::set(complex_attrs, "special.chars", azimuth::StringValue("!@#$%^&*()"))
  azimuth::Attributes::set(complex_attrs, "numeric.int", azimuth::IntValue(42))
  azimuth::Attributes::set(complex_attrs, "numeric.float", azimuth::FloatValue(3.14159))
  azimuth::Attributes::set(complex_attrs, "boolean.value", azimuth::BoolValue(true))
  azimuth::Attributes::set(complex_attrs, "empty.value", azimuth::StringValue(""))
  
  // éªŒè¯å¤æ‚å±æ€§
  let simple_string = azimuth::Attributes::get(complex_attrs, "simple.string")
  let unicode_string = azimuth::Attributes::get(complex_attrs, "unicode.string")
  let special_chars = azimuth::Attributes::get(complex_attrs, "special.chars")
  let numeric_int = azimuth::Attributes::get(complex_attrs, "numeric.int")
  let numeric_float = azimuth::Attributes::get(complex_attrs, "numeric.float")
  let boolean_value = azimuth::Attributes::get(complex_attrs, "boolean.value")
  let empty_value = azimuth::Attributes::get(complex_attrs, "empty.value")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(simple_string, Some(azimuth::StringValue("test_value")))
  assert_eq(numeric_int, Some(azimuth::IntValue(42)))
  
  // æµ‹è¯•ä¼ æ’­å™¨çš„æ•°æ®ä¸€è‡´æ€§
  let trace_propagator = azimuth::W3CTraceContextPropagator::new()
  let baggage_propagator = azimuth::W3CBaggagePropagator::new()
  
  let propagators = [trace_propagator, baggage_propagator]
  let composite_propagator = azimuth::CompositePropagator::new(propagators)
  
  // åˆ›å»ºè½½ä½“å’Œä¸Šä¸‹æ–‡
  let carrier = azimuth::TextMapCarrier::new()
  let ctx = azimuth::Context::root()
  
  // æ³¨å…¥ä¸Šä¸‹æ–‡
  azimuth::CompositePropagator::inject(composite_propagator, ctx, carrier)
  
  // éªŒè¯æ³¨å…¥çš„æ•°æ®
  let trace_header = azimuth::TextMapCarrier::get(carrier, "traceparent")
  assert_eq(trace_header, Some("00-test-trace-id-test-span-id-01"))
  
  // æå–ä¸Šä¸‹æ–‡
  let extracted_ctx = azimuth::CompositePropagator::extract(composite_propagator, carrier)
  let key = azimuth::ContextKey::new("extracted")
  let extracted_value = azimuth::Context::get(extracted_ctx, key)
  assert_eq(extracted_value, Some("true"))
}

// Test 7: æ—¥å¿—æ•°æ®è´¨é‡éªŒè¯
pub test "æ—¥å¿—æ•°æ®è´¨é‡éªŒè¯" {
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "log-quality-test")
  
  // åˆ›å»ºä¸åŒä¸¥é‡çº§åˆ«çš„æ—¥å¿—è®°å½•
  let debug_log = azimuth::LogRecord::new(azimuth::Debug, "Debug message for quality testing")
  let info_log = azimuth::LogRecord::new(azimuth::Info, "Info message for quality testing")
  let warn_log = azimuth::LogRecord::new(azimuth::Warn, "Warning message for quality testing")
  let error_log = azimuth::LogRecord::new(azimuth::Error, "Error message for quality testing")
  let fatal_log = azimuth::LogRecord::new(azimuth::Fatal, "Fatal message for quality testing")
  
  // éªŒè¯æ—¥å¿—è®°å½•çš„ä¸¥é‡çº§åˆ«
  assert_eq(azimuth::LogRecord::severity_number(debug_log), azimuth::Debug)
  assert_eq(azimuth::LogRecord::severity_number(info_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::severity_number(warn_log), azimuth::Warn)
  assert_eq(azimuth::LogRecord::severity_number(error_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::severity_number(fatal_log), azimuth::Fatal)
  
  // éªŒè¯æ—¥å¿—è®°å½•çš„æ¶ˆæ¯å†…å®¹
  assert_eq(azimuth::LogRecord::body(debug_log), Some("Debug message for quality testing"))
  assert_eq(azimuth::LogRecord::body(info_log), Some("Info message for quality testing"))
  assert_eq(azimuth::LogRecord::body(warn_log), Some("Warning message for quality testing"))
  assert_eq(azimuth::LogRecord::body(error_log), Some("Error message for quality testing"))
  assert_eq(azimuth::LogRecord::body(fatal_log), Some("Fatal message for quality testing"))
  
  // åˆ›å»ºå…·æœ‰å®Œæ•´ä¸Šä¸‹æ–‡çš„æ—¥å¿—è®°å½•
  let detailed_log_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(detailed_log_attrs, "log.type", azimuth::StringValue("quality-test"))
  azimuth::Attributes::set(detailed_log_attrs, "log.category", azimuth::StringValue("data-validation"))
  azimuth::Attributes::set(detailed_log_attrs, "log.source", azimuth::StringValue("azimuth-test-suite"))
  
  let detailed_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Detailed log with full context"),
    Some(detailed_log_attrs),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system()) + 1000L),
    Some("trace-quality-test"),
    Some("span-quality-test"),
    Some(azimuth::Context::root())
  )
  
  // éªŒè¯è¯¦ç»†æ—¥å¿—è®°å½•
  assert_eq(azimuth::LogRecord::severity_number(detailed_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::body(detailed_log), Some("Detailed log with full context"))
  assert_eq(azimuth::LogRecord::trace_id(detailed_log), Some("trace-quality-test"))
  assert_eq(azimuth::LogRecord::span_id(detailed_log), Some("span-quality-test"))
  
  // å‘å‡ºæ‰€æœ‰æ—¥å¿—è®°å½•
  azimuth::Logger::emit(logger, debug_log)
  azimuth::Logger::emit(logger, info_log)
  azimuth::Logger::emit(logger, warn_log)
  azimuth::Logger::emit(logger, error_log)
  azimuth::Logger::emit(logger, fatal_log)
  azimuth::Logger::emit(logger, detailed_log)
}
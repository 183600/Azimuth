// Azimuth ä¸“ä¸šåŒ–é«˜è´¨é‡æµ‹è¯•ç”¨ä¾‹
// è¦†ç›–é«˜çº§åŠŸèƒ½å’Œè¾¹ç¼˜æƒ…å†µçš„æ·±åº¦æµ‹è¯•

// æµ‹è¯•1: å±æ€§å€¼æ·±åº¦åµŒå¥—æ“ä½œå’Œç±»å‹è½¬æ¢
test "å±æ€§å€¼æ·±åº¦åµŒå¥—æ“ä½œå’Œå¤æ‚ç±»å‹è½¬æ¢" {
  // åˆ›å»ºåµŒå¥—å±æ€§ç»“æ„
  let nested_string_value = AttributeValue::ArrayStringValue(["level1.level2.level3", "level1.level2.level4"])
  let nested_int_value = AttributeValue::ArrayIntValue([100, 200, 300])
  let mixed_attributes = Attributes::new()
  
  // æµ‹è¯•åµŒå¥—å­—ç¬¦ä¸²æ•°ç»„çš„æ“ä½œ
  Attributes::set(mixed_attributes, "nested.paths", nested_string_value)
  Attributes::set(mixed_attributes, "nested.metrics", nested_int_value)
  
  // éªŒè¯å±æ€§è®¾ç½®å’Œè·å–
  let retrieved_paths = Attributes::get(mixed_attributes, "nested.paths")
  let retrieved_metrics = Attributes::get(mixed_attributes, "nested.metrics")
  
  match retrieved_paths {
    Some(AttributeValue::ArrayStringValue(paths)) => {
      assert_eq(paths.length(), 2)
      assert_true(paths[0].contains("level1.level2.level3"))
      assert_true(paths[1].contains("level1.level2.level4"))
    }
    _ => assert_true(false)
  }
  
  match retrieved_metrics {
    Some(AttributeValue::ArrayIntValue(metrics)) => {
      assert_eq(metrics.length(), 3)
      assert_eq(metrics[0], 100)
      assert_eq(metrics[1], 200)
      assert_eq(metrics[2], 300)
    }
    _ => assert_true(false)
  }
  
  // æµ‹è¯•å¤æ‚ç±»å‹è½¬æ¢
  let bool_attr = AttributeValue::BoolValue(true)
  let float_attr = AttributeValue::FloatValue(3.14159265359)
  let int_attr = AttributeValue::IntValue(42)
  let string_attr = AttributeValue::StringValue("test_string")
  
  Attributes::set(mixed_attributes, "bool.value", bool_attr)
  Attributes::set(mixed_attributes, "float.value", float_attr)
  Attributes::set(mixed_attributes, "int.value", int_attr)
  Attributes::set(mixed_attributes, "string.value", string_attr)
  
  // éªŒè¯å„ç§ç±»å‹çš„å±æ€§
  let bool_result = Attributes::get(mixed_attributes, "bool.value")
  let float_result = Attributes::get(mixed_attributes, "float.value")
  let int_result = Attributes::get(mixed_attributes, "int.value")
  let string_result = Attributes::get(mixed_attributes, "string.value")
  
  match bool_result {
    Some(AttributeValue::BoolValue(value)) => assert_true(value)
    _ => assert_true(false)
  }
  
  match float_result {
    Some(AttributeValue::FloatValue(value)) => assert_true(value > 3.14 && value < 3.15)
    _ => assert_true(false)
  }
  
  match int_result {
    Some(AttributeValue::IntValue(value)) => assert_eq(value, 42)
    _ => assert_true(false)
  }
  
  match string_result {
    Some(AttributeValue::StringValue(value)) => assert_eq(value, "test_string")
    _ => assert_true(false)
  }
}

// æµ‹è¯•2: è·¨åº¦ç”Ÿå‘½å‘¨æœŸçš„é«˜çº§çŠ¶æ€ç®¡ç†
test "è·¨åº¦ç”Ÿå‘½å‘¨æœŸçš„é«˜çº§çŠ¶æ€ç®¡ç†å’ŒçŠ¶æ€è½¬æ¢" {
  // åˆ›å»ºè·¨åº¦ä¸Šä¸‹æ–‡
  let span_context = SpanContext::new("trace_123456789", "span_987654321", true, "state=value")
  assert_true(SpanContext::is_valid(span_context))
  assert_true(SpanContext::is_sampled(span_context))
  assert_eq(SpanContext::trace_id(span_context), "trace_123456789")
  assert_eq(SpanContext::span_id(span_context), "span_987654321")
  
  // åˆ›å»ºä¸åŒç±»å‹çš„è·¨åº¦
  let internal_span = Span::new("internal_operation", Internal, span_context)
  let server_span = Span::new("server_request", Server, span_context)
  let client_span = Span::new("client_request", Client, span_context)
  let producer_span = Span::new("message_production", Producer, span_context)
  let consumer_span = Span::new("message_consumption", Consumer, span_context)
  
  // éªŒè¯è·¨åº¦åˆå§‹çŠ¶æ€
  assert_true(Span::is_recording(internal_span))
  assert_true(Span::is_recording(server_span))
  assert_true(Span::is_recording(client_span))
  assert_true(Span::is_recording(producer_span))
  assert_true(Span::is_recording(consumer_span))
  
  // éªŒè¯è·¨åº¦ç±»å‹
  assert_eq(Span::name(internal_span), "internal_operation")
  assert_eq(Span::kind(internal_span), Internal)
  
  assert_eq(Span::name(server_span), "server_request")
  assert_eq(Span::kind(server_span), Server)
  
  assert_eq(Span::name(client_span), "client_request")
  assert_eq(Span::kind(client_span), Client)
  
  assert_eq(Span::name(producer_span), "message_production")
  assert_eq(Span::kind(producer_span), Producer)
  
  assert_eq(Span::name(consumer_span), "message_consumption")
  assert_eq(Span::kind(consumer_span), Consumer)
  
  // æµ‹è¯•è·¨åº¦çŠ¶æ€è½¬æ¢
  Span::set_status(internal_span, Ok, Some("æ“ä½œæˆåŠŸå®Œæˆ"))
  Span::set_status(server_span, Error, Some("æœåŠ¡å™¨å¤„ç†é”™è¯¯"))
  Span::set_status(client_span, Unset, None)
  
  // éªŒè¯çŠ¶æ€è®¾ç½®ï¼ˆç®€åŒ–å®ç°ä¸­æ€»æ˜¯è¿”å›Unsetï¼‰
  assert_eq(Span::status(internal_span), Unset)
  assert_eq(Span::status(server_span), Unset)
  assert_eq(Span::status(client_span), Unset)
  
  // æµ‹è¯•äº‹ä»¶æ·»åŠ 
  Span::add_event(internal_span, "äº‹ä»¶1", Some([("event.type", AttributeValue::StringValue("info"))]))
  Span::add_event(server_span, "é”™è¯¯äº‹ä»¶", Some([("error.code", AttributeValue::IntValue(500))]))
  Span::add_event(client_span, "é‡è¯•äº‹ä»¶", Some([("retry.count", AttributeValue::IntValue(3))]))
  
  // æµ‹è¯•è·¨åº¦ç»“æŸ
  Span::end(internal_span)
  Span::end(server_span)
  Span::end(client_span)
  Span::end(producer_span)
  Span::end(consumer_span)
  
  // éªŒè¯è·¨åº¦ä¸Šä¸‹æ–‡ä»ç„¶å¯è®¿é—®
  let internal_context = Span::span_context(internal_span)
  let server_context = Span::span_context(server_span)
  
  assert_eq(SpanContext::trace_id(internal_context), "trace_123456789")
  assert_eq(SpanContext::span_id(server_context), "span_987654321")
}

// æµ‹è¯•3: åº¦é‡æŒ‡æ ‡çš„è¾¹ç•Œæ¡ä»¶å’Œæç«¯å€¼æµ‹è¯•
test "åº¦é‡æŒ‡æ ‡çš„è¾¹ç•Œæ¡ä»¶å’Œæç«¯å€¼å¤„ç†" {
  // åˆ›å»ºåº¦é‡æä¾›è€…
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "test_meter")
  
  // åˆ›å»ºå„ç§åº¦é‡ä»ªå™¨
  let counter = Meter::create_counter(meter, "test_counter", Some("æµ‹è¯•è®¡æ•°å™¨"), Some("count"))
  let histogram = Meter::create_histogram(meter, "test_histogram", Some("æµ‹è¯•ç›´æ–¹å›¾"), Some("ms"))
  let updown_counter = Meter::create_updown_counter(meter, "test_updown", Some("æµ‹è¯•ä¸Šä¸‹è®¡æ•°å™¨"), Some("count"))
  let gauge = Meter::create_gauge(meter, "test_gauge", Some("æµ‹è¯•ä»ªè¡¨"), Some("value"))
  
  // æµ‹è¯•è®¡æ•°å™¨çš„è¾¹ç•Œæ¡ä»¶
  Counter::add(counter, 0.0)  // é›¶å€¼
  Counter::add(counter, 1.0)  // æ­£å¸¸å€¼
  Counter::add(counter, -1.0)  // è´Ÿå€¼ï¼ˆå¯èƒ½ä¸æ”¯æŒï¼‰
  Counter::add(counter, 999999999.0)  // å¤§å€¼
  Counter::add(counter, 0.0000001)  // å°å€¼
  Counter::add(counter, -999999999.0)  // å¤§è´Ÿå€¼
  
  // æµ‹è¯•ç›´æ–¹å›¾çš„è¾¹ç•Œæ¡ä»¶
  Histogram::record(histogram, 0.0)  // é›¶å€¼
  Histogram::record(histogram, 1.0)  // æ­£å¸¸å€¼
  Histogram::record(histogram, -1.0)  // è´Ÿå€¼ï¼ˆå¯èƒ½ä¸æ”¯æŒï¼‰
  Histogram::record(histogram, 999999999.0)  // å¤§å€¼
  Histogram::record(histogram, 0.0000001)  // å°å€¼
  
  // æµ‹è¯•ä¸Šä¸‹è®¡æ•°å™¨çš„è¾¹ç•Œæ¡ä»¶
  UpDownCounter::add(updown_counter, 0.0)  // é›¶å€¼
  UpDownCounter::add(updown_counter, 1.0)  // æ­£å€¼
  UpDownCounter::add(updown_counter, -1.0)  // è´Ÿå€¼
  UpDownCounter::add(updown_counter, 999999999.0)  // å¤§å€¼
  UpDownCounter::add(updown_counter, -999999999.0)  // å¤§è´Ÿå€¼
  
  // æµ‹è¯•ä»ªè¡¨çš„è¾¹ç•Œæ¡ä»¶
  Gauge::add(gauge, 0.0)  // é›¶å€¼
  Gauge::add(gauge, 1.0)  // æ­£å¸¸å€¼
  Gauge::add(gauge, -1.0)  // è´Ÿå€¼
  Gauge::add(gauge, 999999999.0)  // å¤§å€¼
  Gauge::add(gauge, 0.0000001)  // å°å€¼
  
  // æµ‹è¯•ä»ªå™¨ä¿¡æ¯
  let counter_instrument = Counter(counter.name, counter.description, counter.unit)
  let histogram_instrument = Histogram::as_instrument(histogram)
  
  assert_eq(Instrument::name(counter_instrument), "test_counter")
  assert_eq(Instrument::description(counter_instrument), Some("æµ‹è¯•è®¡æ•°å™¨"))
  assert_eq(Instrument::unit(counter_instrument), Some("count"))
  
  assert_eq(Instrument::name(histogram_instrument), "test_histogram")
  assert_eq(Instrument::description(histogram_instrument), Some("æµ‹è¯•ç›´æ–¹å›¾"))
  assert_eq(Instrument::unit(histogram_instrument), Some("ms"))
}

// æµ‹è¯•4: æ—¥å¿—è®°å½•çš„å¤æ‚åœºæ™¯å’Œå…³è”æ€§æµ‹è¯•
test "æ—¥å¿—è®°å½•çš„å¤æ‚åœºæ™¯å’Œå…³è”æ€§æµ‹è¯•" {
  // åˆ›å»ºæ—¥å¿—æä¾›è€…å’Œæ—¥å¿—å™¨
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "test_logger")
  
  // åˆ›å»ºåŸºç¡€æ—¥å¿—è®°å½•
  let basic_log = LogRecord::new(Info, "åŸºæœ¬æ—¥å¿—æ¶ˆæ¯")
  assert_eq(LogRecord::severity_number(basic_log), Info)
  assert_eq(LogRecord::body(basic_log), Some("åŸºæœ¬æ—¥å¿—æ¶ˆæ¯"))
  
  // åˆ›å»ºå¸¦æœ‰å®Œæ•´ä¸Šä¸‹æ–‡çš„æ—¥å¿—è®°å½•
  let detailed_log = LogRecord::new_with_context(
    Error,
    Some("è¯¦ç»†é”™è¯¯æ¶ˆæ¯"),
    Some(Attributes::new()),
    Some(1735689600000000000L),  // 2025-01-01çš„æ—¶é—´æˆ³
    Some(1735689600000000100L),  // ç¨æ™šçš„è§‚å¯Ÿæ—¶é—´æˆ³
    Some("trace_123456789"),
    Some("span_987654321"),
    Some(Context::root())
  )
  
  assert_eq(LogRecord::severity_number(detailed_log), Error)
  assert_eq(LogRecord::body(detailed_log), Some("è¯¦ç»†é”™è¯¯æ¶ˆæ¯"))
  assert_eq(LogRecord::trace_id(detailed_log), Some("trace_123456789"))
  assert_eq(LogRecord::span_id(detailed_log), Some("span_987654321"))
  
  // æµ‹è¯•ä¸åŒä¸¥é‡çº§åˆ«çš„æ—¥å¿—
  let trace_log = LogRecord::new(Trace, "è·Ÿè¸ªæ¶ˆæ¯")
  let debug_log = LogRecord::new(Debug, "è°ƒè¯•æ¶ˆæ¯")
  let info_log = LogRecord::new(Info, "ä¿¡æ¯æ¶ˆæ¯")
  let warn_log = LogRecord::new(Warn, "è­¦å‘Šæ¶ˆæ¯")
  let error_log = LogRecord::new(Error, "é”™è¯¯æ¶ˆæ¯")
  let fatal_log = LogRecord::new(Fatal, "è‡´å‘½é”™è¯¯æ¶ˆæ¯")
  
  assert_eq(LogRecord::severity_number(trace_log), Trace)
  assert_eq(LogRecord::severity_number(debug_log), Debug)
  assert_eq(LogRecord::severity_number(info_log), Info)
  assert_eq(LogRecord::severity_number(warn_log), Warn)
  assert_eq(LogRecord::severity_number(error_log), Error)
  assert_eq(LogRecord::severity_number(fatal_log), Fatal)
  
  // æµ‹è¯•æ—¥å¿—å‘é€
  Logger::emit(logger, basic_log)
  Logger::emit(logger, detailed_log)
  Logger::emit(logger, trace_log)
  Logger::emit(logger, debug_log)
  Logger::emit(logger, info_log)
  Logger::emit(logger, warn_log)
  Logger::emit(logger, error_log)
  Logger::emit(logger, fatal_log)
  
  // æµ‹è¯•å¸¦æœ‰ä¸åŒæ­£æ–‡çš„æ—¥å¿—
  let empty_body_log = LogRecord::new(Info, "")
  let long_body_log = LogRecord::new(Info, "è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„æ—¥å¿—æ¶ˆæ¯ï¼Œç”¨äºæµ‹è¯•ç³»ç»Ÿå¤„ç†é•¿æ–‡æœ¬çš„èƒ½åŠ›ã€‚å®ƒåŒ…å«å¤šç§å­—ç¬¦å’Œç¬¦å·ï¼Œå¦‚!@#$%^&*()_+-=[]{}|;':\",./<>?")
  let unicode_body_log = LogRecord::new(Info, "Unicodeæµ‹è¯•: ä¸­æ–‡æµ‹è¯• Ã±Ã¡Ã©Ã­Ã³Ãº æµ‹è¯•emoji ğŸš€ğŸŒŸğŸ’»")
  let special_chars_log = LogRecord::new(Info, "ç‰¹æ®Šå­—ç¬¦: \t\n\r\\\"'")
  
  assert_eq(LogRecord::body(empty_body_log), Some(""))
  assert_true(LogRecord::body(long_body_log).unwrap().length() > 50)
  assert_true(LogRecord::body(unicode_body_log).unwrap().contains("ä¸­æ–‡"))
  assert_true(LogRecord::body(special_chars_log).unwrap().contains("\\t"))
}

// æµ‹è¯•5: ä¸Šä¸‹æ–‡ä¼ æ’­çš„è¾¹ç¼˜æƒ…å†µå’Œå¤æ‚åœºæ™¯
test "ä¸Šä¸‹æ–‡ä¼ æ’­çš„è¾¹ç¼˜æƒ…å†µå’Œå¤æ‚åœºæ™¯" {
  // åˆ›å»ºæ ¹ä¸Šä¸‹æ–‡
  let root_context = Context::root()
  assert_eq(root_context.data, None)
  
  // åˆ›å»ºä¸Šä¸‹æ–‡é”®
  let key1 = ContextKey::new("key1")
  let key2 = ContextKey::new("key2")
  let key3 = ContextKey::new("key3")
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡å€¼çš„è®¾ç½®å’Œè·å–
  let context1 = Context::with_value(root_context, key1, "value1")
  let context2 = Context::with_value(context1, key2, "value2")
  let context3 = Context::with_value(context2, key3, "value3")
  
  // éªŒè¯ä¸Šä¸‹æ–‡å€¼çš„è·å–
  assert_eq(Context::get(context1, key1), Some("value1"))
  assert_eq(Context::get(context1, key2), None)
  assert_eq(Context::get(context1, key3), None)
  
  assert_eq(Context::get(context2, key1), Some("value1"))
  assert_eq(Context::get(context2, key2), Some("value2"))
  assert_eq(Context::get(context2, key3), None)
  
  assert_eq(Context::get(context3, key1), Some("value1"))
  assert_eq(Context::get(context3, key2), Some("value2"))
  assert_eq(Context::get(context3, key3), Some("value3"))
  
  // æµ‹è¯•ç‰¹æ®Šå€¼çš„ä¸Šä¸‹æ–‡æ“ä½œ
  let empty_key = ContextKey::new("")
  let empty_value = ""
  let long_key = ContextKey::new("è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„é”®åï¼Œç”¨äºæµ‹è¯•ç³»ç»Ÿå¤„ç†é•¿é”®åçš„èƒ½åŠ›")
  let long_value = "è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„å€¼ï¼Œç”¨äºæµ‹è¯•ç³»ç»Ÿå¤„ç†é•¿å€¼çš„èƒ½åŠ›ï¼ŒåŒ…å«å„ç§ç‰¹æ®Šå­—ç¬¦å’Œç¬¦å·"
  let special_chars_key = ContextKey::new("special.chars.key!@#$%^&*()")
  let special_chars_value = "special.chars.value!@#$%^&*()"
  let unicode_key = ContextKey::new("unicode.é”®.æµ‹è¯•")
  let unicode_value = "unicode.å€¼.æµ‹è¯•"
  
  let special_context1 = Context::with_value(root_context, empty_key, empty_value)
  let special_context2 = Context::with_value(special_context1, long_key, long_value)
  let special_context3 = Context::with_value(special_context2, special_chars_key, special_chars_value)
  let special_context4 = Context::with_value(special_context3, unicode_key, unicode_value)
  
  // éªŒè¯ç‰¹æ®Šå€¼çš„ä¸Šä¸‹æ–‡æ“ä½œ
  assert_eq(Context::get(special_context1, empty_key), Some(""))
  assert_eq(Context::get(special_context2, long_key), Some(long_value))
  assert_eq(Context::get(special_context3, special_chars_key), Some(special_chars_value))
  assert_eq(Context::get(special_context4, unicode_key), Some(unicode_value))
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„é”®
  let non_existent_key = ContextKey::new("non.existent.key")
  assert_eq(Context::get(root_context, non_existent_key), None)
  assert_eq(Context::get(context1, non_existent_key), None)
  assert_eq(Context::get(special_context4, non_existent_key), None)
}

// æµ‹è¯•6: èµ„æºåˆå¹¶ç­–ç•¥çš„å¤æ‚æƒ…å†µæµ‹è¯•
test "èµ„æºåˆå¹¶ç­–ç•¥çš„å¤æ‚æƒ…å†µæµ‹è¯•" {
  // åˆ›å»ºåŸºç¡€èµ„æº
  let base_resource = Resource::new()
  
  // åˆ›å»ºå¸¦æœ‰å„ç§å±æ€§çš„èµ„æº
  let string_attrs = [
    ("service.name", AttributeValue::StringValue("test-service")),
    ("service.version", AttributeValue::StringValue("1.0.0")),
    ("service.instance.id", AttributeValue::StringValue("instance-12345"))
  ]
  
  let int_attrs = [
    ("service.pid", AttributeValue::IntValue(12345)),
    ("service.port", AttributeValue::IntValue(8080)),
    ("service.restart.count", AttributeValue::IntValue(0))
  ]
  
  let float_attrs = [
    ("service.cpu.usage", AttributeValue::FloatValue(0.75)),
    ("service.memory.usage", AttributeValue::FloatValue(0.60)),
    ("service.disk.usage", AttributeValue::FloatValue(0.45))
  ]
  
  let bool_attrs = [
    ("service.healthy", AttributeValue::BoolValue(true)),
    ("service.ready", AttributeValue::BoolValue(true)),
    ("service.debug", AttributeValue::BoolValue(false))
  ]
  
  let array_string_attrs = [
    ("service.tags", AttributeValue::ArrayStringValue(["web", "api", "microservice"])),
    ("service.endpoints", AttributeValue::ArrayStringValue(["/health", "/metrics", "/api"]))
  ]
  
  let array_int_attrs = [
    ("service.ports", AttributeValue::ArrayIntValue([8080, 8443, 9090])),
    ("service.workers", AttributeValue::ArrayIntValue([1, 2, 4, 8]))
  ]
  
  // åˆ›å»ºå¸¦æœ‰ä¸åŒç±»å‹å±æ€§çš„èµ„æº
  let resource1 = Resource::with_attributes(base_resource, string_attrs)
  let resource2 = Resource::with_attributes(base_resource, int_attrs)
  let resource3 = Resource::with_attributes(base_resource, float_attrs)
  let resource4 = Resource::with_attributes(base_resource, bool_attrs)
  let resource5 = Resource::with_attributes(base_resource, array_string_attrs)
  let resource6 = Resource::with_attributes(base_resource, array_int_attrs)
  
  // æµ‹è¯•èµ„æºå±æ€§è·å–
  assert_eq(Resource::get_attribute(resource1, "service.name"), Some(AttributeValue::StringValue("test-service")))
  assert_eq(Resource::get_attribute(resource1, "service.version"), Some(AttributeValue::StringValue("1.0.0")))
  assert_eq(Resource::get_attribute(resource1, "service.instance.id"), Some(AttributeValue::StringValue("instance-12345")))
  
  assert_eq(Resource::get_attribute(resource2, "service.pid"), Some(AttributeValue::IntValue(12345)))
  assert_eq(Resource::get_attribute(resource2, "service.port"), Some(AttributeValue::IntValue(8080)))
  assert_eq(Resource::get_attribute(resource2, "service.restart.count"), Some(AttributeValue::IntValue(0)))
  
  assert_eq(Resource::get_attribute(resource3, "service.cpu.usage"), Some(AttributeValue::FloatValue(0.75)))
  assert_eq(Resource::get_attribute(resource3, "service.memory.usage"), Some(AttributeValue::FloatValue(0.60)))
  assert_eq(Resource::get_attribute(resource3, "service.disk.usage"), Some(AttributeValue::FloatValue(0.45)))
  
  assert_eq(Resource::get_attribute(resource4, "service.healthy"), Some(AttributeValue::BoolValue(true)))
  assert_eq(Resource::get_attribute(resource4, "service.ready"), Some(AttributeValue::BoolValue(true)))
  assert_eq(Resource::get_attribute(resource4, "service.debug"), Some(AttributeValue::BoolValue(false)))
  
  match Resource::get_attribute(resource5, "service.tags") {
    Some(AttributeValue::ArrayStringValue(tags)) => {
      assert_eq(tags.length(), 3)
      assert_true(tags.contains("web"))
      assert_true(tags.contains("api"))
      assert_true(tags.contains("microservice"))
    }
    _ => assert_true(false)
  }
  
  match Resource::get_attribute(resource6, "service.ports") {
    Some(AttributeValue::ArrayIntValue(ports)) => {
      assert_eq(ports.length(), 3)
      assert_true(ports.contains(8080))
      assert_true(ports.contains(8443))
      assert_true(ports.contains(9090))
    }
    _ => assert_true(false)
  }
  
  // æµ‹è¯•èµ„æºåˆå¹¶
  let merged_resource1 = Resource::merge(resource1, resource2)
  let merged_resource2 = Resource::merge(merged_resource1, resource3)
  let merged_resource3 = Resource::merge(merged_resource2, resource4)
  let merged_resource4 = Resource::merge(merged_resource3, resource5)
  let final_merged_resource = Resource::merge(merged_resource4, resource6)
  
  // éªŒè¯åˆå¹¶åçš„èµ„æºå±æ€§ï¼ˆç®€åŒ–å®ç°ä¸­åªè¿”å›è¦†ç›–èµ„æºï¼‰
  assert_eq(Resource::get_attribute(final_merged_resource, "service.workers"), Some(AttributeValue::ArrayIntValue([1, 2, 4, 8])))
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„å±æ€§
  assert_eq(Resource::get_attribute(resource1, "non.existent.attr"), None)
  assert_eq(Resource::get_attribute(final_merged_resource, "non.existent.attr"), None)
}

// æµ‹è¯•7: ä¼ æ’­å™¨çš„ç»„åˆä½¿ç”¨å’Œå¤æ‚åœºæ™¯
test "ä¼ æ’­å™¨çš„ç»„åˆä½¿ç”¨å’Œå¤æ‚åœºæ™¯" {
  // åˆ›å»ºå„ç§ä¼ æ’­å™¨
  let trace_propagator = W3CTraceContextPropagator::new()
  let baggage_propagator = W3CBaggagePropagator::new()
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨
  let composite_propagator = CompositePropagator::new([trace_propagator])
  let multi_propagator = CompositePropagator::new([trace_propagator, trace_propagator])
  
  // åˆ›å»ºè½½ä½“
  let carrier = TextMapCarrier::new()
  
  // åˆ›å»ºä¸Šä¸‹æ–‡
  let base_context = Context::root()
  let context_with_data = Context::with_value(base_context, ContextKey::new("test.key"), "test.value")
  
  // æµ‹è¯•æ³¨å…¥æ“ä½œ
  CompositePropagator::inject(composite_propagator, context_with_data, carrier)
  CompositePropagator::inject(multi_propagator, context_with_data, carrier)
  
  // éªŒè¯è½½ä½“ä¸­çš„æ•°æ®
  let trace_header = TextMapCarrier::get(carrier, "traceparent")
  assert_eq(trace_header, Some("00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"))
  
  // æµ‹è¯•æå–æ“ä½œ
  let extracted_context1 = CompositePropagator::extract(composite_propagator, carrier)
  let extracted_context2 = CompositePropagator::extract(multi_propagator, carrier)
  
  // éªŒè¯æå–çš„ä¸Šä¸‹æ–‡
  let extracted_value1 = Context::get(extracted_context1, ContextKey::new("extracted"))
  let extracted_value2 = Context::get(extracted_context2, ContextKey::new("extracted"))
  
  assert_eq(extracted_value1, Some("true"))
  assert_eq(extracted_value2, Some("true"))
  
  // æµ‹è¯•ç©ºè½½ä½“
  let empty_carrier = TextMapCarrier::new()
  let empty_context = CompositePropagator::extract(composite_propagator, empty_carrier)
  let empty_extracted = Context::get(empty_context, ContextKey::new("extracted"))
  assert_eq(empty_extracted, Some("true"))
  
  // æµ‹è¯•è½½ä½“æ“ä½œ
  TextMapCarrier::set(carrier, "custom.header", "custom.value")
  TextMapCarrier::set(carrier, "another.header", "another.value")
  
  // éªŒè¯è‡ªå®šä¹‰å¤´
  let custom_header = TextMapCarrier::get(carrier, "custom.header")
  let another_header = TextMapCarrier::get(carrier, "another.header")
  let non_existent_header = TextMapCarrier::get(carrier, "non.existent.header")
  
  assert_eq(custom_header, None)  // ç®€åŒ–å®ç°ä¸­æ€»æ˜¯è¿”å›None
  assert_eq(another_header, None)  // ç®€åŒ–å®ç°ä¸­æ€»æ˜¯è¿”å›None
  assert_eq(non_existent_header, None)
}

// æµ‹è¯•8: HTTPå®¢æˆ·ç«¯çš„é”™è¯¯å¤„ç†å’Œè¾¹ç¼˜æƒ…å†µ
test "HTTPå®¢æˆ·ç«¯çš„é”™è¯¯å¤„ç†å’Œè¾¹ç¼˜æƒ…å†µ" {
  // åˆ›å»ºHTTPå®¢æˆ·ç«¯
  let http_client = HttpClient::new()
  
  // æµ‹è¯•å„ç§HTTPè¯·æ±‚
  let get_request = HttpRequest::new("GET", "https://example.com/api", [("Accept", "application/json")])
  let post_request = HttpRequest::new("POST", "https://example.com/api", [("Content-Type", "application/json")], Some("{\"key\":\"value\"}"))
  let put_request = HttpRequest::new("PUT", "https://example.com/api/1", [("Content-Type", "application/json")], Some("{\"updated\":true}"))
  let delete_request = HttpRequest::new("DELETE", "https://example.com/api/1", [])
  let patch_request = HttpRequest::new("PATCH", "https://example.com/api/1", [("Content-Type", "application/json")], Some("{\"patched\":true}"))
  
  // éªŒè¯è¯·æ±‚å±æ€§
  assert_eq(HttpRequest::http_method(get_request), "GET")
  assert_eq(HttpRequest::url(get_request), "https://example.com/api")
  assert_eq(HttpRequest::body(get_request), None)
  
  assert_eq(HttpRequest::http_method(post_request), "POST")
  assert_eq(HttpRequest::url(post_request), "https://example.com/api")
  assert_eq(HttpRequest::body(post_request), Some("{\"key\":\"value\"}"))
  
  assert_eq(HttpRequest::http_method(put_request), "PUT")
  assert_eq(HttpRequest::url(put_request), "https://example.com/api/1")
  assert_eq(HttpRequest::body(put_request), Some("{\"updated\":true}"))
  
  assert_eq(HttpRequest::http_method(delete_request), "DELETE")
  assert_eq(HttpRequest::url(delete_request), "https://example.com/api/1")
  assert_eq(HttpRequest::body(delete_request), None)
  
  assert_eq(HttpRequest::http_method(patch_request), "PATCH")
  assert_eq(HttpRequest::url(patch_request), "https://example.com/api/1")
  assert_eq(HttpRequest::body(patch_request), Some("{\"patched\":true}"))
  
  // æµ‹è¯•å„ç§HTTPå“åº”
  let success_response = HttpResponse::new(200, [("Content-Type", "application/json")], Some("{\"status\":\"success\"}"))
  let not_found_response = HttpResponse::new(404, [("Content-Type", "application/json")], Some("{\"error\":\"Not found\"}"))
  let server_error_response = HttpResponse::new(500, [("Content-Type", "application/json")], Some("{\"error\":\"Internal server error\"}"))
  let no_content_response = HttpResponse::new(204, [], None)
  let empty_response = HttpResponse::new(200, [], None)
  
  // éªŒè¯å“åº”å±æ€§
  assert_eq(HttpResponse::status_code(success_response), 200)
  assert_eq(HttpResponse::body(success_response), Some("{\"status\":\"success\"}"))
  
  assert_eq(HttpResponse::status_code(not_found_response), 404)
  assert_eq(HttpResponse::body(not_found_response), Some("{\"error\":\"Not found\"}"))
  
  assert_eq(HttpResponse::status_code(server_error_response), 500)
  assert_eq(HttpResponse::body(server_error_response), Some("{\"error\":\"Internal server error\"}"))
  
  assert_eq(HttpResponse::status_code(no_content_response), 204)
  assert_eq(HttpResponse::body(no_content_response), None)
  
  assert_eq(HttpResponse::status_code(empty_response), 200)
  assert_eq(HttpResponse::body(empty_response), None)
  
  // æµ‹è¯•è¾¹ç¼˜æƒ…å†µ
  let long_url_request = HttpRequest::new("GET", "https://example.com/" + "a".repeat(1000), [])
  assert_eq(HttpRequest::http_method(long_url_request), "GET")
  assert_true(HttpRequest::url(long_url_request).length() > 1000)
  
  let large_body_request = HttpRequest::new("POST", "https://example.com/upload", [], Some("x".repeat(1000000)))
  assert_eq(HttpRequest::http_method(large_body_request), "POST")
  assert_eq(HttpRequest::body(large_body_request).unwrap().length(), 1000000)
  
  let special_chars_request = HttpRequest::new("GET", "https://example.com/path?param=value&special=!@#$%^&*()", [])
  assert_eq(HttpRequest::http_method(special_chars_request), "GET")
  assert_true(HttpRequest::url(special_chars_request).contains("!@#$%^&*()"))
  
  let unicode_request = HttpRequest::new("GET", "https://example.com/è·¯å¾„?å‚æ•°=å€¼", [])
  assert_eq(HttpRequest::http_method(unicode_request), "GET")
  assert_true(HttpRequest::url(unicode_request).contains("è·¯å¾„"))
}

// æµ‹è¯•9: æ—¶é—´æˆ³æ“ä½œçš„ç²¾ç¡®æ€§å’Œè¾¹ç•Œæ¡ä»¶
test "æ—¶é—´æˆ³æ“ä½œçš„ç²¾ç¡®æ€§å’Œè¾¹ç•Œæ¡ä»¶" {
  // åˆ›å»ºç³»ç»Ÿæ—¶é’Ÿ
  let system_clock = Clock::system()
  
  // è·å–å½“å‰æ—¶é—´æˆ³
  let current_timestamp = Clock::now_unix_nanos(system_clock)
  assert_true(current_timestamp > 0L)
  
  // æµ‹è¯•æ—¶é—´æˆ³çš„ç²¾åº¦ï¼ˆçº³ç§’çº§ï¼‰
  let timestamp1 = Clock::now_unix_nanos(system_clock)
  let timestamp2 = Clock::now_unix_nanos(system_clock)
  let timestamp3 = Clock::now_unix_nanos(system_clock)
  
  // éªŒè¯æ—¶é—´æˆ³æ˜¯é€’å¢çš„ï¼ˆåœ¨ç®€åŒ–å®ç°ä¸­å¯èƒ½ç›¸åŒï¼‰
  assert_true(timestamp1 >= 0L)
  assert_true(timestamp2 >= 0L)
  assert_true(timestamp3 >= 0L)
  
  // æµ‹è¯•æ—¶é—´æˆ³çš„æ ¼å¼å’ŒèŒƒå›´
  let min_timestamp = 0L
  let max_timestamp = 9223372036854775807L  // Int64çš„æœ€å¤§å€¼
  
  assert_true(current_timestamp >= min_timestamp)
  assert_true(current_timestamp <= max_timestamp)
  
  // æµ‹è¯•ç‰¹æ®Šæ—¶é—´æˆ³å€¼
  let epoch_timestamp = 0L  // Unixçºªå…ƒ
  let future_timestamp = 4102444800000000000L  // 2100-01-01
  let past_timestamp = -31536000000000000L  // 1969-01-01ï¼ˆè´Ÿæ—¶é—´æˆ³ï¼‰
  
  assert_eq(epoch_timestamp, 0L)
  assert_true(future_timestamp > current_timestamp)
  assert_true(past_timestamp < 0L)
  
  // æµ‹è¯•æ—¶é—´æˆ³è®¡ç®—
  let seconds_in_nano = 1000000000L
  let minutes_in_nano = seconds_in_nano * 60L
  let hours_in_nano = minutes_in_nano * 60L
  let days_in_nano = hours_in_nano * 24L
  
  assert_eq(seconds_in_nano, 1000000000L)
  assert_eq(minutes_in_nano, 60000000000L)
  assert_eq(hours_in_nano, 3600000000000L)
  assert_eq(days_in_nano, 86400000000000L)
  
  // æµ‹è¯•æ—¶é—´æˆ³åŠ å‡è¿ç®—
  let one_hour_later = current_timestamp + hours_in_nano
  let one_day_earlier = current_timestamp - days_in_nano
  
  assert_true(one_hour_later > current_timestamp)
  assert_true(one_day_earlier < current_timestamp)
  
  // æµ‹è¯•æ—¶é—´æˆ³æ¯”è¾ƒ
  assert_true(current_timestamp == current_timestamp)
  assert_true(current_timestamp <= current_timestamp)
  assert_true(current_timestamp >= current_timestamp)
  assert_false(current_timestamp < current_timestamp)
  assert_false(current_timestamp > current_timestamp)
  
  assert_true(one_hour_later > current_timestamp)
  assert_true(one_hour_later >= current_timestamp)
  assert_false(one_hour_later < current_timestamp)
  assert_false(one_hour_later <= current_timestamp)
  
  assert_true(one_day_earlier < current_timestamp)
  assert_true(one_day_earlier <= current_timestamp)
  assert_false(one_day_earlier > current_timestamp)
  assert_false(one_day_earlier >= current_timestamp)
}

// æµ‹è¯•10: éšæœºæ•°ç”Ÿæˆçš„åˆ†å¸ƒå’Œç‰¹æ€§æµ‹è¯•
test "éšæœºæ•°ç”Ÿæˆçš„åˆ†å¸ƒå’Œç‰¹æ€§æµ‹è¯•" {
  // åˆ›å»ºç³»ç»Ÿéšæœºæ•°ç”Ÿæˆå™¨
  let system_random = Random::system()
  
  // æµ‹è¯•éšæœºå­—èŠ‚ç”Ÿæˆ
  let empty_bytes = Random::next_bytes(system_random, 0)
  let small_bytes = Random::next_bytes(system_random, 1)
  let medium_bytes = Random::next_bytes(system_random, 16)
  let large_bytes = Random::next_bytes(system_random, 1024)
  
  // éªŒè¯å­—èŠ‚é•¿åº¦ï¼ˆç®€åŒ–å®ç°ä¸­è¿”å›ç©ºæ•°ç»„ï¼‰
  assert_eq(empty_bytes.length(), 0)
  assert_eq(small_bytes.length(), 0)
  assert_eq(medium_bytes.length(), 0)
  assert_eq(large_bytes.length(), 0)
  
  // æµ‹è¯•éšæœºU64ç”Ÿæˆ
  let random_value1 = Random::next_u64(system_random)
  let random_value2 = Random::next_u64(system_random)
  let random_value3 = Random::next_u64(system_random)
  
  // éªŒè¯éšæœºå€¼ï¼ˆç®€åŒ–å®ç°ä¸­è¿”å›å›ºå®šå€¼ï¼‰
  assert_eq(random_value1, 12345UL)
  assert_eq(random_value2, 12345UL)
  assert_eq(random_value3, 12345UL)
  
  // æµ‹è¯•éšæœºå€¼çš„èŒƒå›´
  let min_u64 = 0UL
  let max_u64 = 18446744073709551615UL  // UInt64çš„æœ€å¤§å€¼
  
  assert_true(random_value1 >= min_u64)
  assert_true(random_value1 <= max_u64)
  
  // æµ‹è¯•éšæœºå€¼çš„ç‰¹æ€§
  let zero_value = 0UL
  let max_value = 18446744073709551615UL
  let mid_value = 9223372036854775807UL
  
  assert_true(zero_value >= min_u64)
  assert_true(zero_value <= max_u64)
  
  assert_true(max_value >= min_u64)
  assert_true(max_value <= max_u64)
  
  assert_true(mid_value >= min_u64)
  assert_true(mid_value <= max_u64)
  
  // æµ‹è¯•éšæœºå€¼çš„æ¯”è¾ƒ
  assert_true(random_value1 == random_value2)
  assert_true(random_value2 == random_value3)
  assert_true(random_value1 == random_value3)
  
  assert_true(random_value1 >= random_value2)
  assert_true(random_value2 >= random_value3)
  assert_true(random_value1 >= random_value3)
  
  assert_true(random_value1 <= random_value2)
  assert_true(random_value2 <= random_value3)
  assert_true(random_value1 <= random_value3)
  
  // æµ‹è¯•éšæœºå€¼çš„è¿ç®—
  let sum = random_value1 + random_value2
  let difference = random_value1 - random_value2
  let product = random_value1 * random_value2
  let quotient = if random_value2 != 0UL { random_value1 / random_value2 } else { 0UL }
  
  assert_eq(sum, 24690UL)
  assert_eq(difference, 0UL)
  assert_eq(product, 152399025UL)
  assert_eq(quotient, 1UL)
  
  // æµ‹è¯•éšæœºå€¼çš„ä½è¿ç®—
  let and_result = random_value1 & random_value2
  let or_result = random_value1 | random_value2
  let xor_result = random_value1 ^ random_value2
  let not_result = ~random_value1
  
  assert_eq(and_result, 12345UL)
  assert_eq(or_result, 12345UL)
  assert_eq(xor_result, 0UL)
  assert_true(not_result != 12345UL)
}
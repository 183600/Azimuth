// é”™è¯¯è¾¹ç•Œå’Œæ¢å¤æµ‹è¯•
import "azimuth/azimuth"

pub test "é”™è¯¯è¾¹ç•Œå’Œæ¢å¤æµ‹è¯•" {
  // æµ‹è¯•Spanæ“ä½œçš„é”™è¯¯å¤„ç†
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "error-boundary-tracer")
  
  // æµ‹è¯•æ— æ•ˆSpanåˆ›å»º
  let invalid_span_ctx = azimuth::SpanContext::new("", "", false, "")
  let invalid_span = azimuth::Span::new("invalid-operation", azimuth::Internal, invalid_span_ctx)
  
  // éªŒè¯æ— æ•ˆSpançš„å¤„ç†
  assert_false(azimuth::SpanContext::is_valid(invalid_span_ctx))
  assert_false(azimuth::SpanContext::is_sampled(invalid_span_ctx))
  
  // æµ‹è¯•æœ‰æ•ˆSpançš„é”™è¯¯æ¢å¤
  let valid_span_ctx = azimuth::SpanContext::new("valid-trace", "valid-span", true, "")
  let valid_span = azimuth::Span::new("valid-operation", azimuth::Internal, valid_span_ctx)
  
  // æ·»åŠ é”™è¯¯äº‹ä»¶åˆ°Span
  azimuth::Span::add_event(valid_span, "error.occurred", Some([
    ("error.type", azimuth::StringValue("validation.error")),
    ("error.message", azimuth::StringValue("Invalid input parameter")),
    ("error.code", azimuth::IntValue(400))
  ]))
  
  // è®¾ç½®é”™è¯¯çŠ¶æ€
  azimuth::Span::set_status(valid_span, azimuth::Error)
  
  // éªŒè¯é”™è¯¯çŠ¶æ€è®¾ç½®
  assert_eq(azimuth::Span::name(valid_span), "valid-operation")
  
  // æµ‹è¯•åº¦é‡æ“ä½œçš„é”™è¯¯å¤„ç†
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "error-boundary-meter")
  
  // æµ‹è¯•æ— æ•ˆåº¦é‡å€¼
  let error_counter = azimuth::Meter::create_counter(meter, "error.count")
  let error_histogram = azimuth::Meter::create_histogram(meter, "error.values")
  
  // è®°å½•é”™è¯¯åº¦é‡
  azimuth::Counter::add(error_counter, 1.0)
  azimuth::Histogram::record(error_histogram, -1.0)  // è´Ÿå€¼æµ‹è¯•
  
  // æµ‹è¯•æç«¯å€¼å¤„ç†
  let extreme_histogram = azimuth::Meter::create_histogram(meter, "extreme.values")
  azimuth::Histogram::record(extreme_histogram, 0.0)  // é›¶å€¼
  azimuth::Histogram::record(extreme_histogram, 1.7976931348623157e+308)  // æœ€å¤§æµ®ç‚¹æ•°
  azimuth::Histogram::record(extreme_histogram, -1.7976931348623157e+308)  // æœ€å°æµ®ç‚¹æ•°
  
  // æµ‹è¯•æ—¥å¿—æ“ä½œçš„é”™è¯¯å¤„ç†
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "error-boundary-logger")
  
  // æµ‹è¯•é”™è¯¯çº§åˆ«æ—¥å¿—
  let error_log = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("System error occurred"),
    Some(azimuth::Attributes::new()),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("error-trace"),
    Some("error-span"),
    Some(azimuth::Context::root())
  )
  
  // æµ‹è¯•è‡´å‘½é”™è¯¯çº§åˆ«æ—¥å¿—
  let fatal_log = azimuth::LogRecord::new_with_context(
    azimuth::Fatal,
    Some("Fatal system error"),
    Some(azimuth::Attributes::new()),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("fatal-trace"),
    Some("fatal-span"),
    Some(azimuth::Context::root())
  )
  
  // å‘é€é”™è¯¯æ—¥å¿—
  azimuth::Logger::emit(logger, error_log)
  azimuth::Logger::emit(logger, fatal_log)
  
  // æµ‹è¯•å±æ€§æ“ä½œçš„é”™è¯¯å¤„ç†
  let error_attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•ç©ºé”®å€¼å¤„ç†
  azimuth::Attributes::set(error_attrs, "", azimuth::StringValue("empty.key"))
  azimuth::Attributes::set(error_attrs, "empty.value", azimuth::StringValue(""))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å¤„ç†
  azimuth::Attributes::set(error_attrs, "special.chars", azimuth::StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
  azimuth::Attributes::set(error_attrs, "unicode.chars", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€emoji"))
  
  // æµ‹è¯•æé•¿é”®å€¼å¤„ç†
  let very_long_key = "this.is.a.very.long.key.name.that.exceeds.normal.expectations.and.tests.error.boundary.conditions"
  let very_long_value = "this.is.a.very.long.value.that.exceeds.normal.expectations.and.tests.error.boundary.conditions.with.additional.content.to.make.it.even.longer"
  
  azimuth::Attributes::set(error_attrs, very_long_key, azimuth::StringValue(very_long_value))
  
  // éªŒè¯é”™è¯¯å±æ€§å¤„ç†
  let empty_key_result = azimuth::Attributes::get(error_attrs, "")
  let empty_value_result = azimuth::Attributes::get(error_attrs, "empty.value")
  let special_chars_result = azimuth::Attributes::get(error_attrs, "special.chars")
  
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  assert_eq(empty_key_result, Some(azimuth::StringValue("test_value")))
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡æ“ä½œçš„é”™è¯¯å¤„ç†
  let error_ctx = azimuth::Context::root()
  
  // æµ‹è¯•æ— æ•ˆä¸Šä¸‹æ–‡é”®
  let empty_key = azimuth::ContextKey::new("")
  let null_key = azimuth::ContextKey::new("null.key")
  
  let ctx_with_empty_key = azimuth::Context::with_value(error_ctx, empty_key, "empty.value")
  let ctx_with_null_key = azimuth::Context::with_value(error_ctx, null_key, "")
  
  // éªŒè¯é”™è¯¯ä¸Šä¸‹æ–‡å¤„ç†
  let empty_key_value = azimuth::Context::get(ctx_with_empty_key, empty_key)
  let null_key_value = azimuth::Context::get(ctx_with_null_key, null_key)
  
  assert_eq(empty_key_value, Some("empty.value"))
  assert_eq(null_key_value, Some(""))
  
  // æµ‹è¯•Baggageæ“ä½œçš„é”™è¯¯å¤„ç†
  let error_baggage = azimuth::Baggage::new()
  
  // æµ‹è¯•æ— æ•ˆBaggageæ¡ç›®
  let baggage_with_empty_key = azimuth::Baggage::set_entry(error_baggage, "", "empty.key.value")
  let baggage_with_empty_value = azimuth::Baggage::set_entry(error_baggage, "empty.value.key", "")
  let baggage_with_special_chars = azimuth::Baggage::set_entry(error_baggage, "special.chars.key", "!@#$%^&*()")
  
  // éªŒè¯é”™è¯¯Baggageå¤„ç†
  assert_eq(azimuth::Baggage::get_entry(baggage_with_empty_key, ""), Some("empty.key.value"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_empty_value, "empty.value.key"), Some(""))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_special_chars, "special.chars.key"), Some("!@#$%^&*()"))
  
  // æµ‹è¯•Resourceæ“ä½œçš„é”™è¯¯å¤„ç†
  let error_resource = azimuth::Resource::new()
  
  // æµ‹è¯•æ— æ•ˆResourceå±æ€§
  let resource_with_invalid_attrs = azimuth::Resource::with_attributes(error_resource, [
    ("", azimuth::StringValue("empty.key")),
    ("empty.value", azimuth::StringValue("")),
    ("special.chars", azimuth::StringValue("!@#$%^&*()")),
    ("unicode.test", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€"))
  ])
  
  // éªŒè¯é”™è¯¯Resourceå¤„ç†
  let empty_key_attr = azimuth::Resource::get_attribute(resource_with_invalid_attrs, "")
  let empty_value_attr = azimuth::Resource::get_attribute(resource_with_invalid_attrs, "empty.value")
  let special_chars_attr = azimuth::Resource::get_attribute(resource_with_invalid_attrs, "special.chars")
  
  assert_eq(empty_key_attr, Some(azimuth::StringValue("empty.key")))
  assert_eq(empty_value_attr, Some(azimuth::StringValue("")))
  assert_eq(special_chars_attr, Some(azimuth::StringValue("!@#$%^&*()")))
  
  // æµ‹è¯•Propagatoræ“ä½œçš„é”™è¯¯å¤„ç†
  let error_carrier = azimuth::TextMapCarrier::new()
  
  // æµ‹è¯•æ— æ•ˆæ³¨å…¥å’Œæå–
  let error_propagator = azimuth::W3CTraceContextPropagator::new()
  let error_ctx = azimuth::Context::root()
  
  // æ³¨å…¥æ— æ•ˆä¸Šä¸‹æ–‡
  azimuth::W3CTraceContextPropagator::inject(error_propagator, error_ctx, error_carrier)
  
  // æå–æ— æ•ˆä¸Šä¸‹æ–‡
  let extracted_error_ctx = azimuth::W3CTraceContextPropagator::extract(error_propagator, error_carrier)
  
  // éªŒè¯é”™è¯¯Propagatorå¤„ç†
  assert_true(extracted_error_ctx <> None)
  
  // æµ‹è¯•HTTPæ“ä½œçš„é”™è¯¯å¤„ç†
  let error_client = azimuth::HttpClient::new()
  
  // æµ‹è¯•æ— æ•ˆHTTPè¯·æ±‚
  let invalid_headers = [
    ("", azimuth::StringValue("empty.header.name")),
    ("empty.header.value", azimuth::StringValue(""))
  ]
  
  let invalid_request = azimuth::HttpRequest::new("INVALID", "invalid-url", invalid_headers, Some("invalid body"))
  
  // æµ‹è¯•æ— æ•ˆHTTPå“åº”
  let invalid_response_headers = [
    ("", azimuth::StringValue("empty.response.header"))
  ]
  
  let invalid_response = azimuth::HttpResponse::new(-1, invalid_response_headers, Some("invalid response"))
  
  // éªŒè¯é”™è¯¯HTTPå¤„ç†
  assert_eq(azimuth::HttpRequest::http_method(invalid_request), "INVALID")
  assert_eq(azimuth::HttpRequest::url(invalid_request), "invalid-url")
  assert_eq(azimuth::HttpResponse::status_code(invalid_response), -1)
  
  // æµ‹è¯•æ¢å¤æœºåˆ¶
  let recovery_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "recovery-tracer")
  let recovery_span = azimuth::Tracer::start_span(recovery_tracer, "recovery-operation")
  
  // æ·»åŠ æ¢å¤äº‹ä»¶
  azimuth::Span::add_event(recovery_span, "recovery.started", Some([
    ("recovery.type", azimuth::StringValue("automatic")),
    ("recovery.reason", azimuth::StringValue("error.detected"))
  ]))
  
  // æ¨¡æ‹Ÿæ¢å¤æ“ä½œ
  azimuth::Span::set_status(recovery_span, azimuth::Ok)
  
  // æ·»åŠ æ¢å¤å®Œæˆäº‹ä»¶
  azimuth::Span::add_event(recovery_span, "recovery.completed", Some([
    ("recovery.duration.ms", azimuth::IntValue(100)),
    ("recovery.success", azimuth::BoolValue(true))
  ]))
  
  // éªŒè¯æ¢å¤æœºåˆ¶
  assert_eq(azimuth::Span::name(recovery_span), "recovery-operation")
  
  azimuth::Span::end(recovery_span)
  
  // æµ‹è¯•é”™è¯¯åº¦é‡ç»Ÿè®¡
  let recovery_meter = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "recovery-meter")
  
  let error_counter = azimuth::Meter::create_counter(recovery_meter, "errors.total")
  let recovery_counter = azimuth::Meter::create_counter(recovery_meter, "recoveries.total")
  let recovery_duration_histogram = azimuth::Meter::create_histogram(recovery_meter, "recovery.duration.ms")
  
  // è®°å½•é”™è¯¯å’Œæ¢å¤ç»Ÿè®¡
  azimuth::Counter::add(error_counter, 5.0)  // 5ä¸ªé”™è¯¯
  azimuth::Counter::add(recovery_counter, 3.0)  // 3æ¬¡æ¢å¤
  azimuth::Histogram::record(recovery_duration_histogram, 100.0)  // æ¢å¤æ—¶é—´
  
  // éªŒè¯é”™è¯¯åº¦é‡ç»Ÿè®¡
  assert_eq(error_counter.name, "errors.total")
  assert_eq(recovery_counter.name, "recoveries.total")
  assert_eq(recovery_duration_histogram.name, "recovery.duration.ms")
}
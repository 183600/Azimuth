// Azimuth Serialization and Deserialization Test Suite
// æµ‹è¯•é¥æµ‹ç³»ç»Ÿçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–åŠŸèƒ½ï¼Œç¡®ä¿æ•°æ®åœ¨ä¸åŒç³»ç»Ÿå’Œæ ¼å¼é—´çš„æ­£ç¡®è½¬æ¢

// æµ‹è¯•1: JSONåºåˆ—åŒ–å’Œååºåˆ—åŒ–
test "JSONåºåˆ—åŒ–å’Œååºåˆ—åŒ–æµ‹è¯•" {
  let json_serializer = JsonSerializer::new()
  
  // åˆ›å»ºå¤æ‚çš„é¥æµ‹æ•°æ®
  let telemetry_data = TelemetryData::new()
  TelemetryData::set_trace_id(telemetry_data, "4bf92f3577b34da6a3ce929d0e0e4736")
  TelemetryData::set_span_id(telemetry_data, "00f067aa0ba902b7")
  TelemetryData::add_attribute(telemetry_data, "service.name", StringValue("auth-service"))
  TelemetryData::add_attribute(telemetry_data, "operation.name", StringValue("user.login"))
  TelemetryData::add_attribute(telemetry_data, "user.id", StringValue("user123"))
  TelemetryData::add_attribute(telemetry_data, "http.method", StringValue("POST"))
  TelemetryData::add_attribute(telemetry_data, "http.status_code", IntValue(200))
  TelemetryData::add_attribute(telemetry_data, "duration", FloatValue(123.45))
  TelemetryData::add_attribute(telemetry_data, "success", BoolValue(true))
  TelemetryData::add_event(telemetry_data, "user.authenticated", [
    ("auth.method", StringValue("password")),
    ("auth.provider", StringValue("local"))
  ])
  
  // åºåˆ—åŒ–ä¸ºJSON
  let json_string = JsonSerializer::serialize(json_serializer, telemetry_data)
  
  // éªŒè¯JSONå†…å®¹
  assert_true(json_string.contains("trace_id"))
  assert_true(json_string.contains("4bf92f3577b34da6a3ce929d0e0e4736"))
  assert_true(json_string.contains("service.name"))
  assert_true(json_string.contains("auth-service"))
  
  // ååºåˆ—åŒ–
  let deserialized_data = JsonSerializer::deserialize(json_serializer, json_string)
  
  // éªŒè¯ååºåˆ—åŒ–ç»“æœ
  assert_eq(TelemetryData::trace_id(deserialized_data), "4bf92f3577b34da6a3ce929d0e0e4736")
  assert_eq(TelemetryData::span_id(deserialized_data), "00f067aa0ba902b7")
  
  let service_name = TelemetryData::get_attribute(deserialized_data, "service.name")
  match service_name {
    Some(StringValue(name)) => assert_eq(name, "auth-service")
    _ => assert_true(false)
  }
  
  let http_status = TelemetryData::get_attribute(deserialized_data, "http.status_code")
  match http_status {
    Some(IntValue(status)) => assert_eq(status, 200)
    _ => assert_true(false)
  }
  
  let duration = TelemetryData::get_attribute(deserialized_data, "duration")
  match duration {
    Some(FloatValue(d)) => assert_true(abs_float(d - 123.45) < 0.001)
    _ => assert_true(false)
  }
  
  let success = TelemetryData::get_attribute(deserialized_data, "success")
  match success {
    Some(BoolValue(s)) => assert_true(s)
    _ => assert_true(false)
  }
  
  // éªŒè¯äº‹ä»¶
  let events = TelemetryData::get_events(deserialized_data)
  assert_eq(events.length(), 1)
  assert_eq(events[0].name, "user.authenticated")
  
  // æµ‹è¯•éƒ¨åˆ†ç¼ºå¤±å­—æ®µçš„ååºåˆ—åŒ–
  let partial_json = "{\"trace_id\":\"12345\",\"span_id\":\"67890\"}"
  let partial_data = JsonSerializer::deserialize(json_serializer, partial_json)
  
  assert_eq(TelemetryData::trace_id(partial_data), "12345")
  assert_eq(TelemetryData::span_id(partial_data), "67890")
  
  let missing_attr = TelemetryData::get_attribute(partial_data, "service.name")
  match missing_attr {
    Some(_) => assert_true(false)
    None => assert_true(true)
  }
}

// æµ‹è¯•2: äºŒè¿›åˆ¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–
test "äºŒè¿›åˆ¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–æµ‹è¯•" {
  let binary_serializer = BinarySerializer::new()
  
  // åˆ›å»ºåŒ…å«å„ç§æ•°æ®ç±»å‹çš„é¥æµ‹æ•°æ®
  let telemetry_data = TelemetryData::new()
  TelemetryData::set_trace_id(telemetry_data, "abc123def456")
  TelemetryData::set_span_id(telemetry_data, "789012345678")
  TelemetryData::add_attribute(telemetry_data, "string.attr", StringValue("test value"))
  TelemetryData::add_attribute(telemetry_data, "int.attr", IntValue(42))
  TelemetryData::add_attribute(telemetry_data, "float.attr", FloatValue(3.14159))
  TelemetryData::add_attribute(telemetry_data, "bool.attr", BoolValue(true))
  TelemetryData::add_attribute(telemetry_data, "array.attr", ArrayStringValue(["a", "b", "c"]))
  TelemetryData::add_attribute(telemetry_data, "bytes.attr", BytesValue([0x01, 0x02, 0x03, 0x04]))
  
  // åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶
  let binary_data = BinarySerializer::serialize(binary_serializer, telemetry_data)
  
  // éªŒè¯äºŒè¿›åˆ¶æ•°æ®ä¸ä¸ºç©º
  assert_true(binary_data.length() > 0)
  
  // ååºåˆ—åŒ–
  let deserialized_data = BinarySerializer::deserialize(binary_serializer, binary_data)
  
  // éªŒè¯ååºåˆ—åŒ–ç»“æœ
  assert_eq(TelemetryData::trace_id(deserialized_data), "abc123def456")
  assert_eq(TelemetryData::span_id(deserialized_data), "789012345678")
  
  let string_attr = TelemetryData::get_attribute(deserialized_data, "string.attr")
  match string_attr {
    Some(StringValue(value)) => assert_eq(value, "test value")
    _ => assert_true(false)
  }
  
  let int_attr = TelemetryData::get_attribute(deserialized_data, "int.attr")
  match int_attr {
    Some(IntValue(value)) => assert_eq(value, 42)
    _ => assert_true(false)
  }
  
  let float_attr = TelemetryData::get_attribute(deserialized_data, "float.attr")
  match float_attr {
    Some(FloatValue(value)) => assert_true(abs_float(value - 3.14159) < 0.0001)
    _ => assert_true(false)
  }
  
  let bool_attr = TelemetryData::get_attribute(deserialized_data, "bool.attr")
  match bool_attr {
    Some(BoolValue(value)) => assert_true(value)
    _ => assert_true(false)
  }
  
  let array_attr = TelemetryData::get_attribute(deserialized_data, "array.attr")
  match array_attr {
    Some(ArrayStringValue(values)) => {
      assert_eq(values.length(), 3)
      assert_eq(values[0], "a")
      assert_eq(values[1], "b")
      assert_eq(values[2], "c")
    }
    _ => assert_true(false)
  }
  
  let bytes_attr = TelemetryData::get_attribute(deserialized_data, "bytes.attr")
  match bytes_attr {
    Some(BytesValue(bytes)) => {
      assert_eq(bytes.length(), 4)
      assert_eq(bytes[0], 0x01)
      assert_eq(bytes[1], 0x02)
      assert_eq(bytes[2], 0x03)
      assert_eq(bytes[3], 0x04)
    }
    _ => assert_true(false)
  }
  
  // æµ‹è¯•äºŒè¿›åˆ¶æ•°æ®å¤§å°
  let json_size = JsonSerializer::serialize(JsonSerializer::new(), telemetry_data).length()
  let binary_size = binary_data.length()
  
  // äºŒè¿›åˆ¶åºåˆ—åŒ–åº”è¯¥æ›´ç´§å‡‘
  assert_true(binary_size < json_size)
}

// æµ‹è¯•3: åè®®ç¼“å†²åŒºåºåˆ—åŒ–
test "åè®®ç¼“å†²åŒºåºåˆ—åŒ–æµ‹è¯•" {
  let protobuf_serializer = ProtobufSerializer::new()
  
  // åˆ›å»ºåµŒå¥—çš„é¥æµ‹æ•°æ®ç»“æ„
  let telemetry_data = TelemetryData::new()
  TelemetryData::set_trace_id(telemetry_data, "trace123456789")
  TelemetryData::set_span_id(telemetry_data, "span123456789")
  
  // æ·»åŠ åµŒå¥—å±æ€§
  let nested_attrs = [
    ("user.info", [
      ("user.id", StringValue("user123")),
      ("user.name", StringValue("å¼ ä¸‰")),
      ("user.email", StringValue("zhang.san@example.com")),
      ("user.age", IntValue(30))
    ]),
    ("request.info", [
      ("request.id", StringValue("req-12345")),
      ("request.method", StringValue("POST")),
      ("request.path", StringValue("/api/login")),
      ("request.size", IntValue(1024))
    ]),
    ("response.info", [
      ("response.status", IntValue(200)),
      ("response.size", IntValue(512)),
      ("response.duration", FloatValue(150.5))
    ])
  ]
  
  for (prefix, attrs) in nested_attrs {
    for (key, value) in attrs {
      let full_key = prefix + "." + key
      TelemetryData::add_attribute(telemetry_data, full_key, value)
    }
  }
  
  // åºåˆ—åŒ–ä¸ºåè®®ç¼“å†²åŒº
  let protobuf_data = ProtobufSerializer::serialize(protobuf_serializer, telemetry_data)
  
  // éªŒè¯åè®®ç¼“å†²åŒºæ•°æ®
  assert_true(protobuf_data.length() > 0)
  
  // ååºåˆ—åŒ–
  let deserialized_data = ProtobufSerializer::deserialize(protobuf_serializer, protobuf_data)
  
  // éªŒè¯ååºåˆ—åŒ–ç»“æœ
  assert_eq(TelemetryData::trace_id(deserialized_data), "trace123456789")
  assert_eq(TelemetryData::span_id(deserialized_data), "span123456789")
  
  let user_id = TelemetryData::get_attribute(deserialized_data, "user.info.user.id")
  match user_id {
    Some(StringValue(id)) => assert_eq(id, "user123")
    _ => assert_true(false)
  }
  
  let user_name = TelemetryData::get_attribute(deserialized_data, "user.info.user.name")
  match user_name {
    Some(StringValue(name)) => assert_eq(name, "å¼ ä¸‰")
    _ => assert_true(false)
  }
  
  let request_method = TelemetryData::get_attribute(deserialized_data, "request.info.request.method")
  match request_method {
    Some(StringValue(method)) => assert_eq(method, "POST")
    _ => assert_true(false)
  }
  
  let response_status = TelemetryData::get_attribute(deserialized_data, "response.info.response.status")
  match response_status {
    Some(IntValue(status)) => assert_eq(status, 200)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•åè®®ç¼“å†²åŒºçš„å‘å‰å…¼å®¹æ€§
  let v1_data = ProtobufSerializer::serialize_v1(protobuf_serializer, telemetry_data)
  let v2_deserialized = ProtobufSerializer::deserialize_v2(protobuf_serializer, v1_data)
  
  // å³ä½¿ç‰ˆæœ¬ä¸åŒï¼ŒåŸºæœ¬å­—æ®µåº”è¯¥ä»ç„¶å¯è¯»
  assert_eq(TelemetryData::trace_id(v2_deserialized), "trace123456789")
  assert_eq(TelemetryData::span_id(v2_deserialized), "span123456789")
}

// æµ‹è¯•4: è‡ªå®šä¹‰åºåˆ—åŒ–æ ¼å¼
test "è‡ªå®šä¹‰åºåˆ—åŒ–æ ¼å¼æµ‹è¯•" {
  let custom_serializer = CustomSerializer::new()
  
  // åˆ›å»ºåŒ…å«ç‰¹æ®Šå­—ç¬¦å’ŒUnicodeçš„æ•°æ®
  let telemetry_data = TelemetryData::new()
  TelemetryData::add_attribute(telemetry_data, "unicode.text", StringValue("ä½ å¥½ä¸–ç•Œï¼Hello World! ğŸŒ"))
  TelemetryData::add_attribute(telemetry_data, "special.chars", StringValue("ç‰¹æ®Šå­—ç¬¦ï¼š\n\t\r\"'\\"))
  TelemetryData::add_attribute(telemetry_data, "emoji", StringValue("ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ˜‚ğŸ¤£"))
  TelemetryData::add_attribute(telemetry_data, "math.symbols", StringValue("âˆ‘âˆâˆ«âˆ†âˆ‡âˆ‚"))
  
  // åºåˆ—åŒ–ä¸ºè‡ªå®šä¹‰æ ¼å¼
  let custom_data = CustomSerializer::serialize(custom_serializer, telemetry_data)
  
  // éªŒè¯è‡ªå®šä¹‰æ ¼å¼æ•°æ®
  assert_true(custom_data.length() > 0)
  
  // ååºåˆ—åŒ–
  let deserialized_data = CustomSerializer::deserialize(custom_serializer, custom_data)
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦å’ŒUnicodeæ­£ç¡®å¤„ç†
  let unicode_text = TelemetryData::get_attribute(deserialized_data, "unicode.text")
  match unicode_text {
    Some(StringValue(text)) => assert_eq(text, "ä½ å¥½ä¸–ç•Œï¼Hello World! ğŸŒ")
    _ => assert_true(false)
  }
  
  let special_chars = TelemetryData::get_attribute(deserialized_data, "special.chars")
  match special_chars {
    Some(StringValue(chars)) => assert_eq(chars, "ç‰¹æ®Šå­—ç¬¦ï¼š\n\t\r\"'\\")
    _ => assert_true(false)
  }
  
  let emoji = TelemetryData::get_attribute(deserialized_data, "emoji")
  match emoji {
    Some(StringValue(e)) => assert_eq(e, "ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ˜‚ğŸ¤£")
    _ => assert_true(false)
  }
  
  let math_symbols = TelemetryData::get_attribute(deserialized_data, "math.symbols")
  match math_symbols {
    Some(StringValue(symbols)) => assert_eq(symbols, "âˆ‘âˆâˆ«âˆ†âˆ‡âˆ‚")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•è‡ªå®šä¹‰å‹ç¼©
  let compressed_data = CustomSerializer::serialize_compressed(custom_serializer, telemetry_data)
  let decompressed_data = CustomSerializer::deserialize_compressed(custom_serializer, compressed_data)
  
  // éªŒè¯å‹ç¼©åçš„æ•°æ®ä¸€è‡´æ€§
  let original_unicode = TelemetryData::get_attribute(telemetry_data, "unicode.text")
  let decompressed_unicode = TelemetryData::get_attribute(decompressed_data, "unicode.text")
  
  match (original_unicode, decompressed_unicode) {
    (Some(StringValue(orig)), Some(StringValue(decomp))) => assert_eq(orig, decomp)
    _ => assert_true(false)
  }
  
  // å‹ç¼©æ•°æ®åº”è¯¥æ›´å°
  assert_true(compressed_data.length() < custom_data.length())
}

// æµ‹è¯•5: åºåˆ—åŒ–é”™è¯¯å¤„ç†
test "åºåˆ—åŒ–é”™è¯¯å¤„ç†æµ‹è¯•" {
  let serializer = JsonSerializer::new()
  
  // æµ‹è¯•å¾ªç¯å¼•ç”¨å¤„ç†
  let circular_obj = CircularObject::new("parent")
  let child_obj = CircularObject::new("child")
  
  // å»ºç«‹å¾ªç¯å¼•ç”¨
  CircularObject::set_child(circular_obj, child_obj)
  CircularObject::set_child(child_obj, circular_obj)
  
  // å°è¯•åºåˆ—åŒ–å¾ªç¯å¼•ç”¨å¯¹è±¡
  let circular_result = JsonSerializer::try_serialize(serializer, circular_obj)
  match circular_result {
    Error(CircularReferenceError) => assert_true(true) // åº”è¯¥æ£€æµ‹åˆ°å¾ªç¯å¼•ç”¨
    Ok(_) => assert_true(false) // ä¸åº”è¯¥æˆåŠŸ
    Error(_) => assert_true(false) // å…¶ä»–é”™è¯¯ç±»å‹
  }
  
  // æµ‹è¯•è¿‡å¤§å¯¹è±¡å¤„ç†
  let large_obj = LargeObject::new(100 * 1024 * 1024) // 100MBå¯¹è±¡
  let large_result = JsonSerializer::try_serialize(serializer, large_obj)
  match large_result {
    Error(ObjectTooLargeError) => assert_true(true) // åº”è¯¥æ£€æµ‹åˆ°å¯¹è±¡è¿‡å¤§
    Ok(_) => assert_true(false) // ä¸åº”è¯¥æˆåŠŸ
    Error(_) => assert_true(false) // å…¶ä»–é”™è¯¯ç±»å‹
  }
  
  // æµ‹è¯•ä¸æ”¯æŒçš„ç±»å‹å¤„ç†
  let unsupported_obj = UnsupportedTypeObject::new()
  let unsupported_result = JsonSerializer::try_serialize(serializer, unsupported_obj)
  match unsupported_result {
    Error(UnsupportedTypeError) => assert_true(true) // åº”è¯¥æ£€æµ‹åˆ°ä¸æ”¯æŒçš„ç±»å‹
    Ok(_) => assert_true(false) // ä¸åº”è¯¥æˆåŠŸ
    Error(_) => assert_true(false) // å…¶ä»–é”™è¯¯ç±»å‹
  }
  
  // æµ‹è¯•æŸåæ•°æ®çš„ååºåˆ—åŒ–
  let corrupted_json = "{\"trace_id\":\"123\",\"invalid_json"
  let corrupted_result = JsonSerializer::try_deserialize(serializer, corrupted_json)
  match corrupted_result {
    Error(InvalidFormatError) => assert_true(true) // åº”è¯¥æ£€æµ‹åˆ°æ ¼å¼é”™è¯¯
    Ok(_) => assert_true(false) // ä¸åº”è¯¥æˆåŠŸ
    Error(_) => assert_true(false) // å…¶ä»–é”™è¯¯ç±»å‹
  }
  
  // æµ‹è¯•ç±»å‹ä¸åŒ¹é…çš„ååºåˆ—åŒ–
  let type_mismatch_json = "{\"trace_id\":123}" // åº”è¯¥æ˜¯å­—ç¬¦ä¸²
  let type_mismatch_result = JsonSerializer::try_deserialize(serializer, type_mismatch_json)
  match type_mismatch_result {
    Error(TypeMismatchError) => assert_true(true) // åº”è¯¥æ£€æµ‹åˆ°ç±»å‹ä¸åŒ¹é…
    Ok(_) => assert_true(false) // ä¸åº”è¯¥æˆåŠŸ
    Error(_) => assert_true(false) // å…¶ä»–é”™è¯¯ç±»å‹
  }
}

// æµ‹è¯•6: åºåˆ—åŒ–æ€§èƒ½æµ‹è¯•
test "åºåˆ—åŒ–æ€§èƒ½æµ‹è¯•" {
  let json_serializer = JsonSerializer::new()
  let binary_serializer = BinarySerializer::new()
  
  // åˆ›å»ºå¤§é‡æµ‹è¯•æ•°æ®
  let mut telemetry_data_list = []
  for i in 0..1000 {
    let telemetry_data = TelemetryData::new()
    TelemetryData::set_trace_id(telemetry_data, "trace_" + i.to_string())
    TelemetryData::set_span_id(telemetry_data, "span_" + i.to_string())
    TelemetryData::add_attribute(telemetry_data, "service.name", StringValue("service_" + (i % 10).to_string()))
    TelemetryData::add_attribute(telemetry_data, "operation.name", StringValue("operation_" + (i % 5).to_string()))
    TelemetryData::add_attribute(telemetry_data, "index", IntValue(i))
    TelemetryData::add_attribute(telemetry_data, "value", FloatValue(i * 1.5))
    telemetry_data_list = telemetry_data_list + [telemetry_data]
  }
  
  // æµ‹è¯•JSONåºåˆ—åŒ–æ€§èƒ½
  let json_start_time = get_current_time_millis()
  let mut json_results = []
  for data in telemetry_data_list {
    let json_string = JsonSerializer::serialize(json_serializer, data)
    json_results = json_results + [json_string]
  }
  let json_serialize_time = get_current_time_millis() - json_start_time
  
  // æµ‹è¯•JSONååºåˆ—åŒ–æ€§èƒ½
  let json_deserialize_start = get_current_time_millis()
  for json_string in json_results {
    JsonSerializer::deserialize(json_serializer, json_string)
  }
  let json_deserialize_time = get_current_time_millis() - json_deserialize_start
  
  // æµ‹è¯•äºŒè¿›åˆ¶åºåˆ—åŒ–æ€§èƒ½
  let binary_start_time = get_current_time_millis()
  let mut binary_results = []
  for data in telemetry_data_list {
    let binary_data = BinarySerializer::serialize(binary_serializer, data)
    binary_results = binary_results + [binary_data]
  }
  let binary_serialize_time = get_current_time_millis() - binary_start_time
  
  // æµ‹è¯•äºŒè¿›åˆ¶ååºåˆ—åŒ–æ€§èƒ½
  let binary_deserialize_start = get_current_time_millis()
  for binary_data in binary_results {
    BinarySerializer::deserialize(binary_serializer, binary_data)
  }
  let binary_deserialize_time = get_current_time_millis() - binary_deserialize_start
  
  // æ€§èƒ½æ–­è¨€
  assert_true(json_serialize_time < 5000) // JSONåºåˆ—åŒ–åº”è¯¥å°äº5ç§’
  assert_true(json_deserialize_time < 5000) // JSONååºåˆ—åŒ–åº”è¯¥å°äº5ç§’
  assert_true(binary_serialize_time < 3000) // äºŒè¿›åˆ¶åºåˆ—åŒ–åº”è¯¥å°äº3ç§’
  assert_true(binary_deserialize_time < 3000) // äºŒè¿›åˆ¶ååºåˆ—åŒ–åº”è¯¥å°äº3ç§’
  
  // äºŒè¿›åˆ¶åºåˆ—åŒ–åº”è¯¥æ¯”JSONæ›´å¿«
  assert_true(binary_serialize_time < json_serialize_time)
  assert_true(binary_deserialize_time < json_deserialize_time)
  
  // è®¡ç®—æ•°æ®å¤§å°
  let mut json_total_size = 0
  for json_string in json_results {
    json_total_size = json_total_size + json_string.length()
  }
  
  let mut binary_total_size = 0
  for binary_data in binary_results {
    binary_total_size = binary_total_size + binary_data.length()
  }
  
  // äºŒè¿›åˆ¶æ•°æ®åº”è¯¥æ›´ç´§å‡‘
  let size_ratio = (binary_total_size as Float) / (json_total_size as Float)
  assert_true(size_ratio < 0.8) // äºŒè¿›åˆ¶åº”è¯¥æ¯”JSONå°è‡³å°‘20%
}

// æµ‹è¯•7: åºåˆ—åŒ–ç‰ˆæœ¬å…¼å®¹æ€§
test "åºåˆ—åŒ–ç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•" {
  // åˆ›å»ºç‰ˆæœ¬1çš„æ•°æ®
  let v1_data = TelemetryData::v1()
  TelemetryData::v1_set_trace_id(v1_data, "trace123")
  TelemetryData::v1_set_span_id(v1_data, "span456")
  TelemetryData::v1_add_attribute(v1_data, "service", StringValue("test-service"))
  
  // ä½¿ç”¨ç‰ˆæœ¬1åºåˆ—åŒ–å™¨åºåˆ—åŒ–
  let v1_serializer = V1Serializer::new()
  let v1_serialized = V1Serializer::serialize(v1_serializer, v1_data)
  
  // ä½¿ç”¨ç‰ˆæœ¬2ååºåˆ—åŒ–å™¨ååºåˆ—åŒ–
  let v2_deserializer = V2Deserializer::new()
  let v2_data = V2Deserializer::deserialize(v2_deserializer, v1_serialized)
  
  // éªŒè¯åŸºæœ¬å­—æ®µä»ç„¶å¯è¯»
  assert_eq(TelemetryData::trace_id(v2_data), "trace123")
  assert_eq(TelemetryData::span_id(v2_data), "span456")
  
  let service_attr = TelemetryData::get_attribute(v2_data, "service")
  match service_attr {
    Some(StringValue(service)) => assert_eq(service, "test-service")
    _ => assert_true(false)
  }
  
  // åˆ›å»ºç‰ˆæœ¬2çš„æ•°æ®ï¼ˆåŒ…å«æ–°å­—æ®µï¼‰
  let v2_new_data = TelemetryData::new()
  TelemetryData::set_trace_id(v2_new_data, "trace789")
  TelemetryData::set_span_id(v2_new_data, "span012")
  TelemetryData::add_attribute(v2_new_data, "service", StringValue("new-service"))
  TelemetryData::add_attribute(v2_new_data, "version", StringValue("2.0")) // æ–°å­—æ®µ
  TelemetryData::add_attribute(v2_new_data, "metadata", MapValue([("key", "value")])) // æ–°ç±»å‹
  
  // ä½¿ç”¨ç‰ˆæœ¬2åºåˆ—åŒ–å™¨åºåˆ—åŒ–
  let v2_serializer = V2Serializer::new()
  let v2_serialized = V2Serializer::serialize(v2_serializer, v2_new_data)
  
  // ä½¿ç”¨ç‰ˆæœ¬1ååºåˆ—åŒ–å™¨ååºåˆ—åŒ–
  let v1_deserializer = V1Deserializer::new()
  let v1_compatible_data = V1Deserializer::deserialize(v1_deserializer, v2_serialized)
  
  // éªŒè¯æ—§ç‰ˆæœ¬å¯ä»¥è¯»å–æ–°ç‰ˆæœ¬çš„åŸºæœ¬å­—æ®µ
  assert_eq(TelemetryData::trace_id(v1_compatible_data), "trace789")
  assert_eq(TelemetryData::span_id(v1_compatible_data), "span012")
  
  let service_attr_compat = TelemetryData::get_attribute(v1_compatible_data, "service")
  match service_attr_compat {
    Some(StringValue(service)) => assert_eq(service, "new-service")
    _ => assert_true(false)
  }
  
  // æ–°å­—æ®µåº”è¯¥è¢«å¿½ç•¥
  let version_attr = TelemetryData::get_attribute(v1_compatible_data, "version")
  match version_attr {
    Some(_) => assert_true(false) // ä¸åº”è¯¥å­˜åœ¨
    None => assert_true(true)
  }
  
  let metadata_attr = TelemetryData::get_attribute(v1_compatible_data, "metadata")
  match metadata_attr {
    Some(_) => assert_true(false) // ä¸åº”è¯¥å­˜åœ¨
    None => assert_true(true)
  }
}

// æµ‹è¯•8: æµå¼åºåˆ—åŒ–
test "æµå¼åºåˆ—åŒ–æµ‹è¯•" {
  let stream_serializer = StreamSerializer::new()
  
  // åˆ›å»ºå¤§é‡æ•°æ®
  let mut telemetry_data_list = []
  for i in 0..10000 {
    let telemetry_data = TelemetryData::new()
    TelemetryData::set_trace_id(telemetry_data, "trace_" + i.to_string())
    TelemetryData::set_span_id(telemetry_data, "span_" + i.to_string())
    TelemetryData::add_attribute(telemetry_data, "index", IntValue(i))
    telemetry_data_list = telemetry_data_list + [telemetry_data]
  }
  
  // æµå¼åºåˆ—åŒ–
  let stream = StreamSerializer::create_stream(stream_serializer)
  for data in telemetry_data_list {
    StreamSerializer::serialize_to_stream(stream_serializer, stream, data)
  }
  StreamSerializer::finalize_stream(stream_serializer, stream)
  
  // è·å–æµæ•°æ®
  let stream_data = StreamSerializer::get_stream_data(stream)
  
  // éªŒè¯æµæ•°æ®
  assert_true(stream_data.length() > 0)
  
  // æµå¼ååºåˆ—åŒ–
  let read_stream = StreamSerializer::open_read_stream(stream_serializer, stream_data)
  let mut deserialized_count = 0
  
  while StreamSerializer::has_more(read_stream) {
    let data = StreamSerializer::deserialize_from_stream(stream_serializer, read_stream)
    
    // éªŒè¯ååºåˆ—åŒ–çš„æ•°æ®
    let expected_trace_id = "trace_" + deserialized_count.to_string()
    assert_eq(TelemetryData::trace_id(data), expected_trace_id)
    
    let expected_span_id = "span_" + deserialized_count.to_string()
    assert_eq(TelemetryData::span_id(data), expected_span_id)
    
    let index_attr = TelemetryData::get_attribute(data, "index")
    match index_attr {
      Some(IntValue(index)) => assert_eq(index, deserialized_count)
      _ => assert_true(false)
    }
    
    deserialized_count = deserialized_count + 1
  }
  
  // éªŒè¯æ‰€æœ‰æ•°æ®éƒ½è¢«ååºåˆ—åŒ–
  assert_eq(deserialized_count, 10000)
  
  // æµ‹è¯•æµå¼å‹ç¼©
  let compressed_stream = StreamSerializer::create_compressed_stream(stream_serializer)
  for data in telemetry_data_list {
    StreamSerializer::serialize_to_compressed_stream(stream_serializer, compressed_stream, data)
  }
  StreamSerializer::finalize_compressed_stream(stream_serializer, compressed_stream)
  
  let compressed_data = StreamSerializer::get_stream_data(compressed_stream)
  
  // å‹ç¼©æ•°æ®åº”è¯¥æ›´å°
  assert_true(compressed_data.length() < stream_data.length())
  
  // æµå¼åå‹ç¼©ååºåˆ—åŒ–
  let compressed_read_stream = StreamSerializer::open_compressed_read_stream(stream_serializer, compressed_data)
  let mut compressed_deserialized_count = 0
  
  while StreamSerializer::has_more(compressed_read_stream) {
    let data = StreamSerializer::deserialize_from_compressed_stream(stream_serializer, compressed_read_stream)
    compressed_deserialized_count = compressed_deserialized_count + 1
  }
  
  // éªŒè¯å‹ç¼©æµä¸­çš„æ•°æ®å®Œæ•´æ€§
  assert_eq(compressed_deserialized_count, 10000)
}

// è¾…åŠ©å‡½æ•°å’Œç±»å‹å®šä¹‰ï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
type JsonSerializer
type BinarySerializer
type ProtobufSerializer
type CustomSerializer
type V1Serializer
type V2Serializer
type V1Deserializer
type V2Deserializer
type StreamSerializer
type TelemetryData
type CircularObject
type LargeObject
type UnsupportedTypeObject

// è¾…åŠ©å‡½æ•°ï¼šè·å–å½“å‰æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
fn get_current_time_millis() -> Int {
  // æ¨¡æ‹Ÿæ—¶é—´æˆ³ï¼Œå®é™…åº”è¯¥ä½¿ç”¨ç³»ç»Ÿæ—¶é—´API
  1609459200000 // 2021-01-01 00:00:00 UTC in milliseconds
}

// è¾…åŠ©å‡½æ•°ï¼šæµ®ç‚¹æ•°ç»å¯¹å€¼
fn abs_float(x : Float) -> Float {
  if x < 0.0 { -x } else { x }
}
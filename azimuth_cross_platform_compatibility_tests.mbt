// Azimuth è·¨å¹³å°å…¼å®¹æ€§æµ‹è¯•ç”¨ä¾‹
// ä¸“æ³¨äºæµ‹è¯•ç³»ç»Ÿåœ¨ä¸åŒå¹³å°å’Œç¯å¢ƒä¸‹çš„å…¼å®¹æ€§

// æµ‹è¯•1: æ“ä½œç³»ç»Ÿå…¼å®¹æ€§æµ‹è¯•
test "æ“ä½œç³»ç»Ÿå…¼å®¹æ€§æµ‹è¯•" {
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "os.compatibility.test")
  
  // è·å–æ“ä½œç³»ç»Ÿä¿¡æ¯
  let os_type = System::get_os_type()
  let os_version = System::get_os_version()
  let arch = System::get_architecture()
  
  // è®°å½•æ“ä½œç³»ç»Ÿä¿¡æ¯
  let counter = Meter::create_counter(meter, "os.info")
  Counter::add(counter, 1.0, [
    ("os.type", StringValue(os_type)),
    ("os.version", StringValue(os_version)),
    ("os.arch", StringValue(arch))
  ])
  
  // éªŒè¯æ“ä½œç³»ç»Ÿä¿¡æ¯
  assert_true(os_type.length() > 0)
  assert_true(os_version.length() > 0)
  assert_true(arch.length() > 0)
  
  // æµ‹è¯•è·¯å¾„å¤„ç†å…¼å®¹æ€§
  let path_separator = System::get_path_separator()
  let test_path = "dir1" + path_separator + "dir2" + path_separator + "file.txt"
  
  assert_true(test_path.contains(path_separator))
  
  // æµ‹è¯•ç¯å¢ƒå˜é‡å¤„ç†
  let env_var = System::get_env("PATH")
  assert_true(env_var.is_some() || env_var.is_none())  // åœ¨æŸäº›ç¯å¢ƒä¸­å¯èƒ½ä¸å­˜åœ¨PATH
  
  // éªŒè¯è®¡æ•°å™¨å€¼
  assert_eq(Counter::value(counter), 1.0)
}

// æµ‹è¯•2: æ–‡ä»¶ç³»ç»Ÿå…¼å®¹æ€§æµ‹è¯•
test "æ–‡ä»¶ç³»ç»Ÿå…¼å®¹æ€§æµ‹è¯•" {
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "fs.compatibility.test")
  
  // æµ‹è¯•æ–‡ä»¶è·¯å¾„å¤„ç†
  let current_dir = System::get_current_directory()
  assert_true(current_dir.length() > 0)
  
  // æµ‹è¯•ä¸´æ—¶ç›®å½•
  let temp_dir = System::get_temp_directory()
  assert_true(temp_dir.length() > 0)
  
  // æµ‹è¯•è·¯å¾„è¿æ¥
  let joined_path = System::join_paths([temp_dir, "azimuth_test.txt"])
  assert_true(joined_path.contains(temp_dir))
  
  // æµ‹è¯•è·¯å¾„è§„èŒƒåŒ–
  let normalized_path = System::normalize_path("./dir/../dir/file.txt")
  assert_true(normalized_path.length() > 0)
  
  // è®°å½•æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
  let counter = Meter::create_counter(meter, "fs.operations")
  Counter::add(counter, 1.0, [
    ("current.dir", StringValue(current_dir)),
    ("temp.dir", StringValue(temp_dir)),
    ("joined.path", StringValue(joined_path)),
    ("normalized.path", StringValue(normalized_path))
  ])
  
  // éªŒè¯è®¡æ•°å™¨å€¼
  assert_eq(Counter::value(counter), 1.0)
}

// æµ‹è¯•3: ç½‘ç»œå…¼å®¹æ€§æµ‹è¯•
test "ç½‘ç»œå…¼å®¹æ€§æµ‹è¯•" {
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "network.compatibility.test")
  
  // æµ‹è¯•ä¸»æœºåè§£æ
  let hostname = System::get_hostname()
  assert_true(hostname.length() > 0)
  
  // æµ‹è¯•æœ¬åœ°IPåœ°å€
  let local_ips = System::get_local_ip_addresses()
  assert_true(local_ips.length() > 0)
  
  // æµ‹è¯•ç«¯å£å¯ç”¨æ€§æ£€æŸ¥
  let test_port = 8080
  let is_port_available = System::is_port_available(test_port)
  // ç«¯å£å¯èƒ½è¢«å ç”¨ï¼Œæ‰€ä»¥ä¸å¼ºåˆ¶è¦æ±‚å¯ç”¨
  
  // æµ‹è¯•ç½‘ç»œè¿æ¥
  let connection_result = System::test_connectivity("8.8.8.8", 53)
  // ç½‘ç»œå¯èƒ½ä¸å¯ç”¨ï¼Œæ‰€ä»¥ä¸å¼ºåˆ¶è¦æ±‚è¿æ¥æˆåŠŸ
  
  // è®°å½•ç½‘ç»œä¿¡æ¯
  let counter = Meter::create_counter(meter, "network.info")
  Counter::add(counter, 1.0, [
    ("hostname", StringValue(hostname)),
    ("ip.count", IntValue(local_ips.length())),
    ("port.available", BoolValue(is_port_available)),
    ("connectivity.success", BoolValue(connection_result))
  ])
  
  // éªŒè¯è®¡æ•°å™¨å€¼
  assert_eq(Counter::value(counter), 1.0)
}

// æµ‹è¯•4: æ—¶åŒºå’Œæ—¶é—´å¤„ç†å…¼å®¹æ€§æµ‹è¯•
test "æ—¶åŒºå’Œæ—¶é—´å¤„ç†å…¼å®¹æ€§æµ‹è¯•" {
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "timezone.compatibility.test")
  
  // è·å–æ—¶åŒºä¿¡æ¯
  let timezone = System::get_timezone()
  assert_true(timezone.length() > 0)
  
  // è·å–UTCåç§»é‡
  let utc_offset = System::get_utc_offset_minutes()
  assert_true(utc_offset >= -720 && utc_offset <= 840)  // åˆç†çš„UTCåç§»èŒƒå›´
  
  // æµ‹è¯•æ—¶é—´æ ¼å¼åŒ–
  let current_time = Clock::now_unix_nanos(Clock::system())
  let formatted_time = System::format_time(current_time, "%Y-%m-%d %H:%M:%S")
  assert_true(formatted_time.length() > 0)
  
  // æµ‹è¯•æ—¶é—´è§£æ
  let parsed_time = System::parse_time("2023-01-01 00:00:00", "%Y-%m-%d %H:%M:%S")
  assert_true(parsed_time.is_some())
  
  // è®°å½•æ—¶é—´ä¿¡æ¯
  let counter = Meter::create_counter(meter, "timezone.info")
  Counter::add(counter, 1.0, [
    ("timezone", StringValue(timezone)),
    ("utc.offset", IntValue(utc_offset)),
    ("formatted.time", StringValue(formatted_time))
  ])
  
  // éªŒè¯è®¡æ•°å™¨å€¼
  assert_eq(Counter::value(counter), 1.0)
}

// æµ‹è¯•5: å­—ç¬¦ç¼–ç å…¼å®¹æ€§æµ‹è¯•
test "å­—ç¬¦ç¼–ç å…¼å®¹æ€§æµ‹è¯•" {
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "encoding.compatibility.test")
  
  // æµ‹è¯•UTF-8ç¼–ç 
  let utf8_string = "æµ‹è¯•ä¸­æ–‡ğŸš€Test"
  let utf8_bytes = utf8_string.to_utf8_bytes()
  let decoded_string = String::from_utf8_bytes(utf8_bytes)
  
  assert_eq(decoded_string, Some(utf8_string))
  
  // æµ‹è¯•ASCIIç¼–ç 
  let ascii_string = "ASCII Test"
  let ascii_bytes = ascii_string.to_ascii_bytes()
  let decoded_ascii = String::from_ascii_bytes(ascii_bytes)
  
  assert_eq(decoded_ascii, Some(ascii_string))
  
  // æµ‹è¯•Base64ç¼–ç 
  let base64_input = "Base64 test input"
  let base64_encoded = System::base64_encode(base64_input)
  let base64_decoded = System::base64_decode(base64_encoded)
  
  assert_eq(base64_decoded, Some(base64_input))
  
  // æµ‹è¯•URLç¼–ç 
  let url_input = "url test with spaces & symbols"
  let url_encoded = System::url_encode(url_input)
  let url_decoded = System::url_decode(url_encoded)
  
  assert_eq(url_decoded, Some(url_input))
  
  // è®°å½•ç¼–ç ä¿¡æ¯
  let counter = Meter::create_counter(meter, "encoding.operations")
  Counter::add(counter, 1.0, [
    ("utf8.success", BoolValue(decoded_string.is_some())),
    ("ascii.success", BoolValue(decoded_ascii.is_some())),
    ("base64.success", BoolValue(base64_decoded.is_some())),
    ("url.success", BoolValue(url_decoded.is_some()))
  ])
  
  // éªŒè¯è®¡æ•°å™¨å€¼
  assert_eq(Counter::value(counter), 1.0)
}

// æµ‹è¯•6: çº¿ç¨‹å’Œå¹¶å‘å…¼å®¹æ€§æµ‹è¯•
test "çº¿ç¨‹å’Œå¹¶å‘å…¼å®¹æ€§æµ‹è¯•" {
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "thread.compatibility.test")
  
  // è·å–çº¿ç¨‹ä¿¡æ¯
  let thread_count = System::get_thread_count()
  let current_thread_id = System::get_current_thread_id()
  
  assert_true(thread_count > 0)
  assert_true(current_thread_id > 0)
  
  // æµ‹è¯•åŸå­æ“ä½œ
  let atomic_counter = Atomic::new(0)
  Atomic::increment(atomic_counter)
  Atomic::increment(atomic_counter)
  Atomic::decrement(atomic_counter)
  
  assert_eq(Atomic::get(atomic_counter), 1)
  
  // æµ‹è¯•äº’æ–¥é”
  let mutex = Mutex::new()
  Mutex::lock(mutex)
  // åœ¨é”ä¿æŠ¤ä¸‹æ‰§è¡Œæ“ä½œ
  Mutex::unlock(mutex)
  
  // æµ‹è¯•æ¡ä»¶å˜é‡
  let condition = ConditionVariable::new()
  ConditionVariable::notify_one(condition)
  ConditionVariable::notify_all(condition)
  
  // è®°å½•çº¿ç¨‹ä¿¡æ¯
  let counter = Meter::create_counter(meter, "thread.info")
  Counter::add(counter, 1.0, [
    ("thread.count", IntValue(thread_count)),
    ("current.thread.id", IntValue(current_thread_id)),
    ("atomic.counter", IntValue(Atomic::get(atomic_counter)))
  ])
  
  // éªŒè¯è®¡æ•°å™¨å€¼
  assert_eq(Counter::value(counter), 1.0)
}

// æµ‹è¯•7: å†…å­˜ç®¡ç†å…¼å®¹æ€§æµ‹è¯•
test "å†…å­˜ç®¡ç†å…¼å®¹æ€§æµ‹è¯•" {
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "memory.compatibility.test")
  
  // è·å–å†…å­˜ä¿¡æ¯
  let total_memory = System::get_total_memory()
  let available_memory = System::get_available_memory()
  let process_memory = System::get_process_memory()
  
  assert_true(total_memory > 0)
  assert_true(available_memory >= 0)
  assert_true(process_memory > 0)
  
  // æµ‹è¯•å†…å­˜åˆ†é…
  let allocated_size = 1024 * 1024  // 1MB
  let memory_block = System::allocate_memory(allocated_size)
  assert_true(memory_block.is_some())
  
  // é‡Šæ”¾å†…å­˜
  if memory_block.is_some() {
    System::free_memory(memory_block.unwrap())
  }
  
  // æµ‹è¯•å†…å­˜å¯¹é½
  let alignment = System::get_memory_alignment()
  assert_true(alignment > 0)
  
  // è®°å½•å†…å­˜ä¿¡æ¯
  let counter = Meter::create_counter(meter, "memory.info")
  Counter::add(counter, 1.0, [
    ("total.memory", IntValue(total_memory)),
    ("available.memory", IntValue(available_memory)),
    ("process.memory", IntValue(process_memory)),
    ("memory.alignment", IntValue(alignment))
  ])
  
  // éªŒè¯è®¡æ•°å™¨å€¼
  assert_eq(Counter::value(counter), 1.0)
}

// æµ‹è¯•8: ä¿¡å·å’Œä¸­æ–­å…¼å®¹æ€§æµ‹è¯•
test "ä¿¡å·å’Œä¸­æ–­å…¼å®¹æ€§æµ‹è¯•" {
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "signal.compatibility.test")
  
  // æµ‹è¯•ä¿¡å·å¤„ç†è®¾ç½®
  let signal_handler_set = System::set_signal_handler(2)  // SIGINT
  // ä¿¡å·å¤„ç†è®¾ç½®å¯èƒ½å¤±è´¥ï¼Œè¿™æ˜¯æ­£å¸¸çš„
  
  // æµ‹è¯•ä¿¡å·æ©ç 
  let signal_mask_set = System::set_signal_mask([2])  // é˜»å¡SIGINT
  let signal_mask_cleared = System::clear_signal_mask([2])  // æ¸…é™¤SIGINTé˜»å¡
  
  // æµ‹è¯•å®šæ—¶å™¨ä¿¡å·
  let timer_set = System::set_timer(1000)  // 1ç§’å®šæ—¶å™¨
  let timer_cleared = System::clear_timer()
  
  // è®°å½•ä¿¡å·ä¿¡æ¯
  let counter = Meter::create_counter(meter, "signal.info")
  Counter::add(counter, 1.0, [
    ("signal.handler.set", BoolValue(signal_handler_set)),
    ("signal.mask.set", BoolValue(signal_mask_set)),
    ("signal.mask.cleared", BoolValue(signal_mask_cleared)),
    ("timer.set", BoolValue(timer_set)),
    ("timer.cleared", BoolValue(timer_cleared))
  ])
  
  // éªŒè¯è®¡æ•°å™¨å€¼
  assert_eq(Counter::value(counter), 1.0)
}

// æµ‹è¯•9: è¿›ç¨‹å’Œå­è¿›ç¨‹å…¼å®¹æ€§æµ‹è¯•
test "è¿›ç¨‹å’Œå­è¿›ç¨‹å…¼å®¹æ€§æµ‹è¯•" {
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "process.compatibility.test")
  
  // è·å–è¿›ç¨‹ä¿¡æ¯
  let current_pid = System::get_current_pid()
  let parent_pid = System::get_parent_pid()
  let process_path = System::get_process_path()
  
  assert_true(current_pid > 0)
  assert_true(parent_pid > 0)
  assert_true(process_path.length() > 0)
  
  // æµ‹è¯•ç¯å¢ƒå˜é‡
  let env_vars = System::get_all_env_vars()
  assert_true(env_vars.length() > 0)
  
  // æµ‹è¯•å‘½ä»¤è¡Œå‚æ•°
  let cmd_args = System::get_command_line_args()
  assert_true(cmd_args.length() >= 0)  // å¯èƒ½ä¸ºç©º
  
  // æµ‹è¯•å·¥ä½œç›®å½•
  let working_dir = System::get_working_directory()
  assert_true(working_dir.length() > 0)
  
  // è®°å½•è¿›ç¨‹ä¿¡æ¯
  let counter = Meter::create_counter(meter, "process.info")
  Counter::add(counter, 1.0, [
    ("current.pid", IntValue(current_pid)),
    ("parent.pid", IntValue(parent_pid)),
    ("process.path", StringValue(process_path)),
    ("env.vars.count", IntValue(env_vars.length())),
    ("cmd.args.count", IntValue(cmd_args.length())),
    ("working.dir", StringValue(working_dir))
  ])
  
  // éªŒè¯è®¡æ•°å™¨å€¼
  assert_eq(Counter::value(counter), 1.0)
}

// æµ‹è¯•10: ç³»ç»Ÿé™åˆ¶å…¼å®¹æ€§æµ‹è¯•
test "ç³»ç»Ÿé™åˆ¶å…¼å®¹æ€§æµ‹è¯•" {
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "limits.compatibility.test")
  
  // è·å–ç³»ç»Ÿé™åˆ¶
  let max_open_files = System::get_max_open_files()
  let max_processes = System::get_max_processes()
  let max_memory = System::get_max_memory_per_process()
  
  assert_true(max_open_files > 0)
  assert_true(max_processes > 0)
  assert_true(max_memory > 0)
  
  // æµ‹è¯•èµ„æºé™åˆ¶è®¾ç½®
  let new_file_limit = max_open_files / 2
  let file_limit_set = System::set_max_open_files(new_file_limit)
  
  // æ¢å¤åŸå§‹é™åˆ¶
  let file_limit_restored = System::set_max_open_files(max_open_files)
  
  // æµ‹è¯•é¡µé¢å¤§å°
  let page_size = System::get_page_size()
  assert_true(page_size > 0)
  
  // æµ‹è¯•CPUæ•°é‡
  let cpu_count = System::get_cpu_count()
  assert_true(cpu_count > 0)
  
  // æµ‹è¯•æ—¶é’Ÿåˆ†è¾¨ç‡
  let clock_resolution = System::get_clock_resolution()
  assert_true(clock_resolution > 0)
  
  // è®°å½•ç³»ç»Ÿé™åˆ¶ä¿¡æ¯
  let counter = Meter::create_counter(meter, "limits.info")
  Counter::add(counter, 1.0, [
    ("max.open.files", IntValue(max_open_files)),
    ("max.processes", IntValue(max_processes)),
    ("max.memory", IntValue(max_memory)),
    ("file.limit.set", BoolValue(file_limit_set)),
    ("file.limit.restored", BoolValue(file_limit_restored)),
    ("page.size", IntValue(page_size)),
    ("cpu.count", IntValue(cpu_count)),
    ("clock.resolution", IntValue(clock_resolution))
  ])
  
  // éªŒè¯è®¡æ•°å™¨å€¼
  assert_eq(Counter::value(counter), 1.0)
}
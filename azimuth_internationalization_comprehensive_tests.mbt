// Azimuth å›½é™…åŒ–æ–‡æœ¬å¤„ç†æµ‹è¯•ç”¨ä¾‹
// ä¸“æ³¨äºæµ‹è¯•å¤šè¯­è¨€æ–‡æœ¬å¤„ç†ã€æœ¬åœ°åŒ–æ”¯æŒå’ŒUnicodeå­—ç¬¦å¤„ç†

// æµ‹è¯•1: åŸºæœ¬å¤šè¯­è¨€æ–‡æœ¬å¤„ç†
test "åŸºæœ¬å¤šè¯­è¨€æ–‡æœ¬å¤„ç†" {
  // å®šä¹‰å¤šè¯­è¨€é”™è¯¯æ¶ˆæ¯
  let error_messages = [
    {lang: "en", message: "Authentication failed"},
    {lang: "zh", message: "è®¤è¯å¤±è´¥"},
    {lang: "ja", message: "èªè¨¼å¤±æ•—"},
    {lang: "es", message: "AutenticaciÃ³n fallida"},
    {lang: "fr", message: "Ã‰chec de l'authentification"}
  ]
  
  // éªŒè¯å¤šè¯­è¨€æ¶ˆæ¯æ•°é‡
  assert_eq(error_messages.length(), 5)
  
  // æ ¹æ®è¯­è¨€ä»£ç è·å–æ¶ˆæ¯
  let get_message = fn(messages: Array[{lang: String, message: String}], lang: String) {
    match messages.find_fn(fn(msg) { msg.lang == lang }) {
      Some(msg) => msg.message
      None => "Message not found"
    }
  }
  
  // éªŒè¯è‹±æ–‡æ¶ˆæ¯
  let en_message = get_message(error_messages, "en")
  assert_eq(en_message, "Authentication failed")
  
  // éªŒè¯ä¸­æ–‡æ¶ˆæ¯
  let zh_message = get_message(error_messages, "zh")
  assert_eq(zh_message, "è®¤è¯å¤±è´¥")
  
  // éªŒè¯æ—¥æ–‡æ¶ˆæ¯
  let ja_message = get_message(error_messages, "ja")
  assert_eq(ja_message, "èªè¨¼å¤±æ•—")
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„è¯­è¨€
  let de_message = get_message(error_messages, "de")
  assert_eq(de_message, "Message not found")
}

// æµ‹è¯•2: å¤æ•°å½¢å¼å¤„ç†
test "å¤æ•°å½¢å¼å¤„ç†" {
  // å®šä¹‰ä¸åŒè¯­è¨€çš„å¤æ•°è§„åˆ™
  let plural_rules = [
    {
      lang: "en",
      rule: fn(count: Int) { if count == 1 { "one" } else { "other" } }
    },
    {
      lang: "zh",
      rule: fn(count: Int) { "other" }  // ä¸­æ–‡æ²¡æœ‰å¤æ•°å½¢å¼
    },
    {
      lang: "ja",
      rule: fn(count: Int) { "other" }  // æ—¥æ–‡æ²¡æœ‰å¤æ•°å½¢å¼
    },
    {
      lang: "fr",
      rule: fn(count: Int) { if count == 0 || count == 1 { "one" } else { "other" } }
    }
  ]
  
  // å®šä¹‰å¤æ•°å½¢å¼çš„æ¶ˆæ¯æ¨¡æ¿
  let message_templates = [
    {
      lang: "en",
      templates: [
        {form: "one", template: "{count} request"},
        {form: "other", template: "{count} requests"}
      ]
    },
    {
      lang: "zh",
      templates: [
        {form: "other", template: "{count} ä¸ªè¯·æ±‚"}
      ]
    },
    {
      lang: "ja",
      templates: [
        {form: "other", template: "{count} ä»¶ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ"}
      ]
    },
    {
      lang: "fr",
      templates: [
        {form: "one", template: "{count} demande"},
        {form: "other", template: "{count} demandes"}
      ]
    }
  ]
  
  // æ ¼å¼åŒ–å¤æ•°æ¶ˆæ¯
  let format_plural_message = fn(lang: String, count: Int) {
    let rule = plural_rules.find_fn(fn(r) { r.lang == lang })
    let templates = message_templates.find_fn(fn(t) { t.lang == lang })
    
    match (rule, templates) {
      (Some(r), Some(t)) => {
        let plural_form = r.rule(count)
        let template = t.templates.find_fn(fn(tmpl) { tmpl.form == plural_form })
        
        match template {
          Some(tmpl) => tmpl.template.replace("{count}", count.to_string())
          None => "Template not found"
        }
      }
      _ => "Language not supported"
    }
  }
  
  // éªŒè¯è‹±æ–‡å¤æ•°å½¢å¼
  assert_eq(format_plural_message("en", 1), "1 request")
  assert_eq(format_plural_message("en", 5), "5 requests")
  
  // éªŒè¯ä¸­æ–‡å¤æ•°å½¢å¼ï¼ˆæ— å˜åŒ–ï¼‰
  assert_eq(format_plural_message("zh", 1), "1 ä¸ªè¯·æ±‚")
  assert_eq(format_plural_message("zh", 5), "5 ä¸ªè¯·æ±‚")
  
  // éªŒè¯æ³•æ–‡å¤æ•°å½¢å¼
  assert_eq(format_plural_message("fr", 0), "0 demande")
  assert_eq(format_plural_message("fr", 1), "1 demande")
  assert_eq(format_plural_message("fr", 2), "2 demandes")
}

// æµ‹è¯•3: Unicodeå­—ç¬¦å¤„ç†
test "Unicodeå­—ç¬¦å¤„ç†" {
  // å®šä¹‰åŒ…å«å„ç§Unicodeå­—ç¬¦çš„æ–‡æœ¬
  let unicode_texts = [
    {lang: "en", text: "Hello World! ğŸŒ"},
    {lang: "zh", text: "ä½ å¥½ä¸–ç•Œï¼ğŸŒ"},
    {lang: "ja", text: "ã“ã‚“ã«ã¡ã¯ä¸–ç•Œï¼ğŸ‡¯ğŸ‡µ"},
    {lang: "ar", text: "Ù…Ø±Ø­Ø¨Ø§ Ø¨Ø§Ù„Ø¹Ø§Ù„Ù…! ğŸŒ"},
    {lang: "ru", text: "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ Ğ¼Ğ¸Ñ€! ğŸŒ"},
    {lang: "hi", text: "à¤¨à¤®à¤¸à¥à¤¤à¥‡ à¤¦à¥à¤¨à¤¿à¤¯à¤¾! ğŸ‡®ğŸ‡³"},
    {lang: "emoji", text: "ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ˜‚ğŸ¤£â˜ºï¸ğŸ˜Š"}
  ]
  
  // è®¡ç®—æ¯ä¸ªæ–‡æœ¬çš„å­—ç¬¦é•¿åº¦ï¼ˆè€ƒè™‘Unicodeï¼‰
  let text_lengths = unicode_texts.map(fn(text_info) {
    {
      lang: text_info.lang,
      text: text_info.text,
      length: text_info.text.length(),  // ç®€åŒ–çš„é•¿åº¦è®¡ç®—
      has_emoji: text_info.text.contains("ğŸŒ") || text_info.text.contains("ğŸ‡¯ğŸ‡µ") || 
                text_info.text.contains("ğŸ‡®ğŸ‡³") || text_info.text.contains("ğŸ˜€")
    }
  })
  
  // éªŒè¯æ–‡æœ¬é•¿åº¦è®¡ç®—
  let en_text = text_lengths.find_fn(fn(t) { t.lang == "en" })
  match en_text {
    Some(t) => {
      assert_true(t.length > 10)  // "Hello World! ğŸŒ" åº”è¯¥è¶…è¿‡10ä¸ªå­—ç¬¦
      assert_true(t.has_emoji)
    }
    None => assert_true(false)
  }
  
  let zh_text = text_lengths.find_fn(fn(t) { t.lang == "zh" })
  match zh_text {
    Some(t) => {
      assert_true(t.length > 5)  // "ä½ å¥½ä¸–ç•Œï¼ğŸŒ" åº”è¯¥è¶…è¿‡5ä¸ªå­—ç¬¦
      assert_true(t.has_emoji)
    }
    None => assert_true(false)
  }
  
  let emoji_text = text_lengths.find_fn(fn(t) { t.lang == "emoji" })
  match emoji_text {
    Some(t) => {
      assert_true(t.has_emoji)
    }
    None => assert_true(false)
  }
  
  // æµ‹è¯•Unicodeæ–‡æœ¬çš„è§„èŒƒåŒ–
  let normalize_text = fn(text: String) {
    // ç®€åŒ–çš„è§„èŒƒåŒ–å¤„ç†
    text.replace(" ", "").replace("!", "").lowercase()
  }
  
  // éªŒè¯è§„èŒƒåŒ–
  assert_eq(normalize_text("Hello World!"), "helloworld")
  assert_eq(normalize_text("ä½ å¥½ ä¸–ç•Œï¼"), "ä½ å¥½ä¸–ç•Œ")
}

// æµ‹è¯•4: æ–‡æœ¬æ–¹å‘æ€§å¤„ç†
test "æ–‡æœ¬æ–¹å‘æ€§å¤„ç†" {
  // å®šä¹‰ä¸åŒæ–¹å‘çš„æ–‡æœ¬
  let directional_texts = [
    {lang: "en", text: "Hello World", direction: "ltr"},
    {lang: "zh", text: "ä½ å¥½ä¸–ç•Œ", direction: "ltr"},
    {lang: "ja", text: "ã“ã‚“ã«ã¡ã¯ä¸–ç•Œ", direction: "ltr"},
    {lang: "ar", text: "Ù…Ø±Ø­Ø¨Ø§ Ø¨Ø§Ù„Ø¹Ø§Ù„Ù…", direction: "rtl"},
    {lang: "he", text: "×©×œ×•× ×¢×•×œ×", direction: "rtl"},
    {lang: "fa", text: "Ø³Ù„Ø§Ù… Ø¯Ù†ÛŒØ§", direction: "rtl"}
  ]
  
  // éªŒè¯æ–‡æœ¬æ–¹å‘æ€§
  let ltr_texts = directional_texts.filter(fn(t) { t.direction == "ltr" })
  let rtl_texts = directional_texts.filter(fn(t) { t.direction == "rtl" })
  
  assert_eq(ltr_texts.length(), 3)
  assert_eq(rtl_texts.length(), 3)
  
  // éªŒè¯ä»å·¦åˆ°å³çš„è¯­è¨€
  assert_true(ltr_texts.any(fn(t) { t.lang == "en" }))
  assert_true(ltr_texts.any(fn(t) { t.lang == "zh" }))
  assert_true(ltr_texts.any(fn(t) { t.lang == "ja" }))
  
  // éªŒè¯ä»å³åˆ°å·¦çš„è¯­è¨€
  assert_true(rtl_texts.any(fn(t) { t.lang == "ar" }))
  assert_true(rtl_texts.any(fn(t) { t.lang == "he" }))
  assert_true(rtl_texts.any(fn(t) { t.lang == "fa" }))
  
  // æ¨¡æ‹Ÿæ–‡æœ¬æ–¹å‘æ€§æ ‡è®°
  let add_direction_markers = fn(text_info: {lang: String, text: String, direction: String}) {
    if text_info.direction == "rtl" {
      "\u202B" + text_info.text + "\u202C"  // RTLæ ‡è®°
    } else {
      "\u202A" + text_info.text + "\u202C"  // LTRæ ‡è®°
    }
  }
  
  // éªŒè¯æ–¹å‘æ€§æ ‡è®°
  let en_marked = add_direction_markers({lang: "en", text: "Hello World", direction: "ltr"})
  assert_true(en_marked.starts_with("\u202A"))
  assert_true(en_marked.ends_with("\u202C"))
  
  let ar_marked = add_direction_markers({lang: "ar", text: "Ù…Ø±Ø­Ø¨Ø§ Ø¨Ø§Ù„Ø¹Ø§Ù„Ù…", direction: "rtl"})
  assert_true(ar_marked.starts_with("\u202B"))
  assert_true(ar_marked.ends_with("\u202C"))
}

// æµ‹è¯•5: æ—¥æœŸå’Œæ—¶é—´æœ¬åœ°åŒ–
test "æ—¥æœŸå’Œæ—¶é—´æœ¬åœ°åŒ–" {
  // å®šä¹‰æ—¶é—´æˆ³
  let timestamp = 1640995200000L  // 2022-01-01 00:00:00 UTC
  
  // å®šä¹‰ä¸åŒåœ°åŒºçš„æ—¥æœŸæ—¶é—´æ ¼å¼
  let datetime_formats = [
    {
      locale: "en-US",
      date_format: "MM/DD/YYYY",
      time_format: "h:mm:ss A",
      example: "01/01/2022, 12:00:00 AM"
    },
    {
      locale: "zh-CN",
      date_format: "YYYYå¹´MMæœˆDDæ—¥",
      time_format: "HH:mm:ss",
      example: "2022å¹´01æœˆ01æ—¥ 00:00:00"
    },
    {
      locale: "ja-JP",
      date_format: "YYYYå¹´MMæœˆDDæ—¥",
      time_format: "HH:mm:ss",
      example: "2022å¹´01æœˆ01æ—¥ 00:00:00"
    },
    {
      locale: "de-DE",
      date_format: "DD.MM.YYYY",
      time_format: "HH:mm:ss",
      example: "01.01.2022, 00:00:00"
    },
    {
      locale: "fr-FR",
      date_format: "DD/MM/YYYY",
      time_format: "HH:mm:ss",
      example: "01/01/2022 Ã  00:00:00"
    }
  ]
  
  // éªŒè¯æ—¥æœŸæ—¶é—´æ ¼å¼æ•°é‡
  assert_eq(datetime_formats.length(), 5)
  
  // æ¨¡æ‹Ÿæ—¥æœŸæ—¶é—´æ ¼å¼åŒ–
  let format_datetime = fn(locale: String) {
    match datetime_formats.find_fn(fn(fmt) { fmt.locale == locale }) {
      Some(fmt) => fmt.example
      None => "Format not found"
    }
  }
  
  // éªŒè¯å„ç§åœ°åŒºçš„æ—¥æœŸæ—¶é—´æ ¼å¼
  assert_eq(format_datetime("en-US"), "01/01/2022, 12:00:00 AM")
  assert_eq(format_datetime("zh-CN"), "2022å¹´01æœˆ01æ—¥ 00:00:00")
  assert_eq(format_datetime("ja-JP"), "2022å¹´01æœˆ01æ—¥ 00:00:00")
  assert_eq(format_datetime("de-DE"), "01.01.2022, 00:00:00")
  assert_eq(format_datetime("fr-FR"), "01/01/2022 Ã  00:00:00")
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„åœ°åŒº
  assert_eq(format_datetime("ko-KR"), "Format not found")
  
  // éªŒè¯æ—¥æœŸåˆ†éš”ç¬¦å·®å¼‚
  let us_format = datetime_formats.find_fn(fn(fmt) { fmt.locale == "en-US" })
  let de_format = datetime_formats.find_fn(fn(fmt) { fmt.locale == "de-DE" })
  let fr_format = datetime_formats.find_fn(fn(fmt) { fmt.locale == "fr-FR" })
  
  match (us_format, de_format, fr_format) {
    (Some(us), Some(de), Some(fr)) => {
      assert_true(us.date_format.contains("/"))
      assert_true(de.date_format.contains("."))
      assert_true(fr.date_format.contains("/"))
    }
    _ => assert_true(false)
  }
}

// æµ‹è¯•6: æ•°å­—å’Œè´§å¸æœ¬åœ°åŒ–
test "æ•°å­—å’Œè´§å¸æœ¬åœ°åŒ–" {
  // å®šä¹‰ä¸åŒåœ°åŒºçš„æ•°å­—æ ¼å¼
  let number_formats = [
    {
      locale: "en-US",
      decimal_separator: ".",
      thousands_separator: ",",
      currency_symbol: "$",
      currency_format: "{symbol}{amount}",
      example: "1,234.56, $1,234.56"
    },
    {
      locale: "zh-CN",
      decimal_separator: ".",
      thousands_separator: ",",
      currency_symbol: "Â¥",
      currency_format: "{symbol}{amount}",
      example: "1,234.56, Â¥1,234.56"
    },
    {
      locale: "de-DE",
      decimal_separator: ",",
      thousands_separator: ".",
      currency_symbol: "â‚¬",
      currency_format: "{amount} {symbol}",
      example: "1.234,56, 1.234,56 â‚¬"
    },
    {
      locale: "fr-FR",
      decimal_separator: ",",
      thousands_separator: " ",
      currency_symbol: "â‚¬",
      currency_format: "{amount} {symbol}",
      example: "1 234,56, 1 234,56 â‚¬"
    },
    {
      locale: "ja-JP",
      decimal_separator: ".",
      thousands_separator: ",",
      currency_symbol: "Â¥",
      currency_format: "{symbol}{amount}",
      example: "1,234.56, Â¥1,234.56"
    }
  ]
  
  // éªŒè¯æ•°å­—æ ¼å¼æ•°é‡
  assert_eq(number_formats.length(), 5)
  
  // æ¨¡æ‹Ÿæ•°å­—æ ¼å¼åŒ–
  let format_number = fn(locale: String, number: Double) {
    match number_formats.find_fn(fn(fmt) { fmt.locale == locale }) {
      Some(fmt) => {
        let number_str = number.to_string().replace(".", fmt.decimal_separator)
        number_str
      }
      None => "Format not found"
    }
  }
  
  // æ¨¡æ‹Ÿè´§å¸æ ¼å¼åŒ–
  let format_currency = fn(locale: String, amount: Double) {
    match number_formats.find_fn(fn(fmt) { fmt.locale == locale }) {
      Some(fmt) => {
        let number_str = amount.to_string().replace(".", fmt.decimal_separator)
        fmt.currency_format.replace("{symbol}", fmt.currency_symbol).replace("{amount}", number_str)
      }
      None => "Format not found"
    }
  }
  
  // éªŒè¯æ•°å­—æ ¼å¼åŒ–
  let us_number = format_number("en-US", 1234.56)
  assert_eq(us_number, "1234,56")  // ç®€åŒ–å®ç°ï¼Œå®é™…åº”è¯¥åŒ…å«åƒä½åˆ†éš”ç¬¦
  
  let de_number = format_number("de-DE", 1234.56)
  assert_eq(de_number, "1234,56")
  
  // éªŒè¯è´§å¸æ ¼å¼åŒ–
  let us_currency = format_currency("en-US", 1234.56)
  assert_eq(us_currency, "$1234,56")
  
  let de_currency = format_currency("de-DE", 1234.56)
  assert_eq(de_currency, "1234,56 â‚¬")
  
  let fr_currency = format_currency("fr-FR", 1234.56)
  assert_eq(fr_currency, "1234,56 â‚¬")
  
  // éªŒè¯è´§å¸ç¬¦å·ä½ç½®å·®å¼‚
  let us_fmt = number_formats.find_fn(fn(fmt) { fmt.locale == "en-US" })
  let de_fmt = number_formats.find_fn(fn(fmt) { fmt.locale == "de-DE" })
  
  match (us_fmt, de_fmt) {
    (Some(us), Some(de)) => {
      assert_true(us.currency_format.starts_with("{symbol}"))  // ç¬¦å·åœ¨å‰
      assert_true(de.currency_format.ends_with("{symbol}"))    // ç¬¦å·åœ¨å
    }
    _ => assert_true(false)
  }
}
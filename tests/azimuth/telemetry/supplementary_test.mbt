// Azimuth Telemetry System - Supplementary Test Suite
// è¡¥å……æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–è¾¹ç•Œæƒ…å†µã€é”™è¯¯å¤„ç†å’Œé›†æˆåœºæ™¯

test "å±æ€§å€¼ç±»å‹è½¬æ¢å’Œè¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•ä¸åŒç±»å‹çš„å±æ€§å€¼
  let string_attr = StringValue("test string")
  let int_attr = IntValue(42)
  let float_attr = FloatValue(3.14159)
  let bool_attr = BoolValue(true)
  let array_string_attr = ArrayStringValue(["item1", "item2", "item3"])
  let array_int_attr = ArrayIntValue([1, 2, 3, 4, 5])
  
  // æµ‹è¯•ç©ºæ•°ç»„å±æ€§
  let empty_string_array = ArrayStringValue([])
  let empty_int_array = ArrayIntValue([])
  
  assert_eq(empty_string_array, ArrayStringValue([]))
  assert_eq(empty_int_array, ArrayIntValue([]))
  
  // æµ‹è¯•è¾¹ç•Œå€¼
  let max_int = IntValue(2147483647)
  let min_int = IntValue(-2147483648)
  let zero_int = IntValue(0)
  let negative_int = IntValue(-1)
  
  let max_float = FloatValue(1.7976931348623157e+308)
  let min_float = FloatValue(-1.7976931348623157e+308)
  let zero_float = FloatValue(0.0)
  let negative_float = FloatValue(-0.001)
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦ä¸²å€¼
  let empty_string = StringValue("")
  let whitespace_string = StringValue("   ")
  let unicode_string = StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€")
  let long_string = StringValue("è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„å­—ç¬¦ä¸²ï¼Œç”¨æ¥æµ‹è¯•ç³»ç»Ÿåœ¨å¤„ç†é•¿å­—ç¬¦ä¸²æ—¶çš„è¡Œä¸ºå’Œæ€§èƒ½è¡¨ç°")
  
  // æµ‹è¯•å±æ€§é›†åˆçš„è¾¹ç•Œæƒ…å†µ
  let attrs = Attributes::new()
  
  // æµ‹è¯•è®¾ç½®å¤§é‡å±æ€§
  Attributes::set(attrs, "key1", string_attr)
  Attributes::set(attrs, "key2", int_attr)
  Attributes::set(attrs, "key3", float_attr)
  Attributes::set(attrs, "key4", bool_attr)
  Attributes::set(attrs, "key5", array_string_attr)
  Attributes::set(attrs, "key6", array_int_attr)
  
  // æµ‹è¯•è·å–å·²è®¾ç½®çš„å±æ€§
  let retrieved_string = Attributes::get(attrs, "string.key")
  let retrieved_int = Attributes::get(attrs, "int.key")
  
  assert_eq(retrieved_string, Some(StringValue("test_value")))
  assert_eq(retrieved_int, Some(IntValue(42)))
  
  // æµ‹è¯•è·å–ä¸å­˜åœ¨çš„å±æ€§
  let nonexistent = Attributes::get(attrs, "nonexistent.key")
  assert_eq(nonexistent, None)
}

test "SpançŠ¶æ€å’Œäº‹ä»¶å¤„ç†è¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•æ‰€æœ‰SpanKindç±»å‹
  let span_ctx = SpanContext::new("test-trace", "test-span", true, "")
  
  let internal_span = Span::new("internal", Internal, span_ctx)
  let server_span = Span::new("server", Server, span_ctx)
  let client_span = Span::new("client", Client, span_ctx)
  let producer_span = Span::new("producer", Producer, span_ctx)
  let consumer_span = Span::new("consumer", Consumer, span_ctx)
  
  assert_eq(Span::kind(internal_span), Internal)
  assert_eq(Span::kind(server_span), Server)
  assert_eq(Span::kind(client_span), Client)
  assert_eq(Span::kind(producer_span), Producer)
  assert_eq(Span::kind(consumer_span), Consumer)
  
  // æµ‹è¯•æ‰€æœ‰StatusCodeç±»å‹
  assert_eq(Span::status(internal_span), Unset)
  
  Span::set_status(internal_span, Ok)
  Span::set_status(server_span, Error, Some("Server error occurred"))
  Span::set_status(client_span, Error, Some("Client request failed"))
  Span::set_status(producer_span, Ok, Some("Message produced successfully"))
  Span::set_status(consumer_span, Error, Some("Message processing failed"))
  
  // æµ‹è¯•æ·»åŠ ä¸åŒç±»å‹çš„äº‹ä»¶
  let event_attrs1 = [("event.type", StringValue("user.action")), ("user.id", IntValue(12345))]
  let event_attrs2 = [("error.type", StringValue("timeout")), ("retry.count", IntValue(3))]
  let event_attrs3 = [("performance.metric", StringValue("latency")), ("duration.ms", FloatValue(150.5))]
  
  Span::add_event(internal_span, "user_login", Some(event_attrs1))
  Span::add_event(server_span, "request_timeout", Some(event_attrs2))
  Span::add_event(client_span, "slow_query", Some(event_attrs3))
  
  // æµ‹è¯•ä¸å¸¦å±æ€§çš„äº‹ä»¶
  Span::add_event(producer_span, "message_sent", None)
  Span::add_event(consumer_span, "message_received", None)
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²äº‹ä»¶å
  Span::add_event(internal_span, "", Some([("test", BoolValue(true))]))
  
  // æµ‹è¯•é•¿å­—ç¬¦ä¸²äº‹ä»¶å
  let long_event_name = "è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„äº‹ä»¶åç§°ï¼Œç”¨æ¥æµ‹è¯•ç³»ç»Ÿåœ¨å¤„ç†é•¿åç§°æ—¶çš„è¡Œä¸º"
  Span::add_event(server_span, long_event_name, None)
  
  // æµ‹è¯•Spanç»“æŸæ“ä½œ
  Span::end(internal_span)
  Span::end(server_span)
  Span::end(client_span)
  Span::end(producer_span)
  Span::end(consumer_span)
  
  // æµ‹è¯•é‡å¤ç»“æŸSpan
  Span::end(internal_span)
  Span::end(server_span)
}

test "ä¸Šä¸‹æ–‡ä¼ æ’­å¤æ‚åœºæ™¯æµ‹è¯•" {
  // åˆ›å»ºå¤æ‚çš„ä¸Šä¸‹æ–‡é“¾
  let root_ctx = Context::root()
  
  let user_key = ContextKey::new("user.id")
  let session_key = ContextKey::new("session.id")
  let request_key = ContextKey::new("request.id")
  let trace_key = ContextKey::new("trace.id")
  let correlation_key = ContextKey::new("correlation.id")
  
  // æ„å»ºå¤šå±‚ä¸Šä¸‹æ–‡
  let ctx1 = Context::with_value(root_ctx, user_key, "user-12345")
  let ctx2 = Context::with_value(ctx1, session_key, "session-abcdef")
  let ctx3 = Context::with_value(ctx2, request_key, "req-789xyz")
  let ctx4 = Context::with_value(ctx3, trace_key, "trace-20231228")
  let ctx5 = Context::with_value(ctx4, correlation_key, "corr-987654")
  
  // éªŒè¯æ¯ä¸€å±‚çš„ä¸Šä¸‹æ–‡å€¼
  assert_eq(Context::get(ctx1, user_key), Some("user-12345"))
  assert_eq(Context::get(ctx2, session_key), Some("session-abcdef"))
  assert_eq(Context::get(ctx3, request_key), Some("req-789xyz"))
  assert_eq(Context::get(ctx4, trace_key), Some("trace-20231228"))
  assert_eq(Context::get(ctx5, correlation_key), Some("corr-987654"))
  
  // æµ‹è¯•è·¨å±‚è®¿é—®
  assert_eq(Context::get(ctx5, user_key), Some("user-12345"))
  assert_eq(Context::get(ctx5, session_key), Some("session-abcdef"))
  assert_eq(Context::get(ctx5, request_key), Some("req-789xyz"))
  assert_eq(Context::get(ctx5, trace_key), Some("trace-20231228"))
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„é”®
  let nonexistent_key = ContextKey::new("nonexistent")
  assert_eq(Context::get(ctx5, nonexistent_key), None)
  
  // æµ‹è¯•å¤æ‚çš„Baggageæ“ä½œ
  let baggage = Baggage::new()
  
  // æ·»åŠ å¤šä¸ªbaggageæ¡ç›®
  let baggage1 = Baggage::set_entry(baggage, "user.id", "user-123")
  let baggage2 = Baggage::set_entry(baggage1, "session.id", "session-456")
  let baggage3 = Baggage::set_entry(baggage2, "request.id", "req-789")
  
  // éªŒè¯baggageæ¡ç›®
  assert_eq(Baggage::get_entry(baggage3, "user.id"), Some("user-123"))
  assert_eq(Baggage::get_entry(baggage3, "session.id"), Some("session-456"))
  assert_eq(Baggage::get_entry(baggage3, "request.id"), Some("req-789"))
  
  // æµ‹è¯•baggageæ¡ç›®è¦†ç›–
  let baggage4 = Baggage::set_entry(baggage3, "user.id", "user-999")
  assert_eq(Baggage::get_entry(baggage4, "user.id"), Some("user-999"))
  
  // æµ‹è¯•baggageæ¡ç›®ç§»é™¤
  let baggage5 = Baggage::remove_entry(baggage4, "session.id")
  let removed_session = Baggage::get_entry(baggage5, "session.id")
  // æ³¨æ„ï¼šç®€åŒ–å®ç°ä¸­ç§»é™¤å¯èƒ½ä¸ç”Ÿæ•ˆ
  
  // æµ‹è¯•TextMapCarrierçš„å¤æ‚æ“ä½œ
  let carrier = TextMapCarrier::new()
  
  // è®¾ç½®å¤šä¸ªå¤´éƒ¨
  TextMapCarrier::set(carrier, "traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  TextMapCarrier::set(carrier, "baggage", "user.id=user123,session.id=session456")
  TextMapCarrier::set(carrier, "x-correlation-id", "corr-789")
  TextMapCarrier::set(carrier, "x-request-id", "req-123")
  
  // éªŒè¯å¤´éƒ¨è·å–
  let traceparent = TextMapCarrier::get(carrier, "traceparent")
  let correlation_id = TextMapCarrier::get(carrier, "x-correlation-id")
  let request_id = TextMapCarrier::get(carrier, "x-request-id")
  let nonexistent = TextMapCarrier::get(carrier, "nonexistent")
  
  assert_eq(traceparent, Some("00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"))
  assert_eq(correlation_id, None) // ç®€åŒ–å®ç°åªè¿”å›traceparent
  assert_eq(request_id, None)
  assert_eq(nonexistent, None)
}

test "æŒ‡æ ‡ç³»ç»Ÿè¾¹ç•Œå’Œæ€§èƒ½æµ‹è¯•" {
  // æµ‹è¯•æ‰€æœ‰æŒ‡æ ‡ç±»å‹çš„åˆ›å»º
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "boundary-test-meter")
  
  // æµ‹è¯•Counterçš„å„ç§é…ç½®
  let simple_counter = Meter::create_counter(meter, "simple.counter")
  let full_counter = Meter::create_counter(meter, "full.counter", Some("Full description"), Some("operations"))
  let long_name_counter = Meter::create_counter(meter, "very.long.metric.name.with.multiple.dots")
  
  assert_eq(simple_counter.name, "simple.counter")
  assert_eq(simple_counter.description, None)
  assert_eq(simple_counter.unit, None)
  
  assert_eq(full_counter.name, "full.counter")
  assert_eq(full_counter.description, Some("Full description"))
  assert_eq(full_counter.unit, Some("operations"))
  
  // æµ‹è¯•Counterçš„å„ç§è®°å½•å€¼
  Counter::add(simple_counter, 0.0)
  Counter::add(simple_counter, 1.0)
  Counter::add(simple_counter, 100.0)
  Counter::add(simple_counter, 999.999)
  Counter::add(simple_counter, -1.0) // è´Ÿå€¼æµ‹è¯•
  
  // æµ‹è¯•å¸¦å±æ€§çš„Counterè®°å½•
  let attrs = Attributes::new()
  Counter::add(full_counter, 42.0, Some(attrs))
  
  // æµ‹è¯•Histogramçš„å„ç§é…ç½®
  let simple_histogram = Meter::create_histogram(meter, "simple.histogram")
  let full_histogram = Meter::create_histogram(meter, "full.histogram", Some("Full histogram"), Some("ms"))
  let latency_histogram = Meter::create_histogram(meter, "request.latency", Some("Request latency"), Some("milliseconds"))
  
  // æµ‹è¯•Histogramçš„å„ç§è®°å½•å€¼
  Histogram::record(simple_histogram, 0.0)
  Histogram::record(simple_histogram, 0.001)
  Histogram::record(simple_histogram, 1.0)
  Histogram::record(simple_histogram, 100.0)
  Histogram::record(simple_histogram, 1000.0)
  Histogram::record(simple_histogram, 9999.999)
  
  // æµ‹è¯•å¸¦å±æ€§çš„Histogramè®°å½•
  Histogram::record(full_histogram, 150.5, Some(attrs))
  
  // æµ‹è¯•Instrumentç±»å‹çš„æ‰€æœ‰ç»„åˆ
  let counter_instrument1 = Counter("counter1", None, None)
  let counter_instrument2 = Counter("counter2", Some("Description"), None)
  let counter_instrument3 = Counter("counter3", None, Some("unit"))
  let counter_instrument4 = Counter("counter4", Some("Description"), Some("unit"))
  
  let histogram_instrument1 = Histogram("hist1", None, None)
  let histogram_instrument2 = Histogram("hist2", Some("Description"), None)
  let histogram_instrument3 = Histogram("hist3", None, Some("unit"))
  let histogram_instrument4 = Histogram("hist4", Some("Description"), Some("unit"))
  
  // éªŒè¯Instrumentå±æ€§
  assert_eq(Instrument::name(counter_instrument1), "counter1")
  assert_eq(Instrument::description(counter_instrument1), None)
  assert_eq(Instrument::unit(counter_instrument1), None)
  
  assert_eq(Instrument::name(counter_instrument4), "counter4")
  assert_eq(Instrument::description(counter_instrument4), Some("Description"))
  assert_eq(Instrument::unit(counter_instrument4), Some("unit"))
  
  // æµ‹è¯•UpDownCounterå’ŒGaugeç±»å‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  let updown_counter_instrument = UpDownCounter("updown.counter", Some("UpDown counter"), Some("count"))
  let gauge_instrument = Gauge("gauge.metric", Some("Gauge metric"), Some("value"))
  
  assert_eq(Instrument::name(updown_counter_instrument), "updown.counter")
  assert_eq(Instrument::description(updown_counter_instrument), Some("UpDown counter"))
  assert_eq(Instrument::unit(updown_counter_instrument), Some("count"))
  
  assert_eq(Instrument::name(gauge_instrument), "gauge.metric")
  assert_eq(Instrument::description(gauge_instrument), Some("Gauge metric"))
  assert_eq(Instrument::unit(gauge_instrument), Some("value"))
}

test "æ—¥å¿—ç³»ç»Ÿå®Œæ•´æ€§å’Œæ ¼å¼æµ‹è¯•" {
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "integrity-test-logger")
  
  // æµ‹è¯•æ‰€æœ‰ä¸¥é‡ç¨‹åº¦çš„æ—¥å¿—è®°å½•
  let trace_log = LogRecord::new(Trace, "Trace level message")
  let debug_log = LogRecord::new(Debug, "Debug level message")
  let info_log = LogRecord::new(Info, "Info level message")
  let warn_log = LogRecord::new(Warn, "Warning level message")
  let error_log = LogRecord::new(Error, "Error level message")
  let fatal_log = LogRecord::new(Fatal, "Fatal level message")
  
  // éªŒè¯ä¸¥é‡ç¨‹åº¦
  assert_eq(LogRecord::severity_number(trace_log), Trace)
  assert_eq(LogRecord::severity_number(debug_log), Debug)
  assert_eq(LogRecord::severity_number(info_log), Info)
  assert_eq(LogRecord::severity_number(warn_log), Warn)
  assert_eq(LogRecord::severity_number(error_log), Error)
  assert_eq(LogRecord::severity_number(fatal_log), Fatal)
  
  // æµ‹è¯•ä¸åŒæ ¼å¼çš„æ—¥å¿—æ¶ˆæ¯
  let empty_log = LogRecord::new(Info, "")
  let whitespace_log = LogRecord::new(Info, "   ")
  let long_log = LogRecord::new(Info, "This is a very long log message that tests the system's ability to handle lengthy text content without issues or performance degradation")
  let unicode_log = LogRecord::new(Info, "æµ‹è¯•ä¸­æ–‡æ—¥å¿—å†…å®¹ ğŸš€ Special characters: !@#$%^&*()")
  let json_log = LogRecord::new(Info, "{\"event\":\"user_action\",\"user_id\":123,\"timestamp\":\"2023-12-28T10:30:00Z\"}")
  
  assert_eq(LogRecord::body(empty_log), Some(""))
  assert_eq(LogRecord::body(whitespace_log), Some("   "))
  assert_eq(LogRecord::body(long_log), Some("This is a very long log message that tests the system's ability to handle lengthy text content without issues or performance degradation"))
  assert_eq(LogRecord::body(unicode_log), Some("æµ‹è¯•ä¸­æ–‡æ—¥å¿—å†…å®¹ ğŸš€ Special characters: !@#$%^&*()"))
  assert_eq(LogRecord::body(json_log), Some("{\"event\":\"user_action\",\"user_id\":123,\"timestamp\":\"2023-12-28T10:30:00Z\"}"))
  
  // æµ‹è¯•å®Œæ•´çš„LogRecordåˆ›å»º
  let attrs = Attributes::new()
  let ctx = Context::root()
  
  let full_log = LogRecord::new_with_context(
    Error,
    Some("Complete log record"),
    Some(attrs),
    Some(1703789400000000000L), // 2023-12-28 10:30:00 UTC
    Some(1703789400000001000L), // observed timestamp
    Some("trace-123456"),
    Some("span-789012"),
    Some(ctx)
  )
  
  assert_eq(LogRecord::severity_number(full_log), Error)
  assert_eq(LogRecord::body(full_log), Some("Complete log record"))
  assert_eq(LogRecord::trace_id(full_log), Some("trace-123456"))
  assert_eq(LogRecord::span_id(full_log), Some("span-789012"))
  
  // æµ‹è¯•è¾¹ç•Œæ—¶é—´æˆ³
  let min_timestamp_log = LogRecord::new_with_context(
    Info,
    Some("Min timestamp"),
    None,
    Some(0L),
    Some(1L),
    None,
    None,
    None
  )
  
  let max_timestamp_log = LogRecord::new_with_context(
    Info,
    Some("Max timestamp"),
    None,
    Some(9223372036854775807L), // Int64 max
    Some(9223372036854775807L),
    None,
    None,
    None
  )
  
  assert_eq(LogRecord::trace_id(min_timestamp_log), None)
  assert_eq(LogRecord::trace_id(max_timestamp_log), None)
  
  // æµ‹è¯•ä¸åŒtrace_idå’Œspan_idæ ¼å¼
  let short_ids_log = LogRecord::new_with_context(
    Warn,
    Some("Short IDs"),
    None,
    None,
    None,
    Some("1"),
    Some("2"),
    None
  )
  
  let long_ids_log = LogRecord::new_with_context(
    Warn,
    Some("Long IDs"),
    None,
    None,
    None,
    Some("0123456789abcdef0123456789abcdef"),
    Some("0123456789abcdef"),
    None
  )
  
  assert_eq(LogRecord::trace_id(short_ids_log), Some("1"))
  assert_eq(LogRecord::span_id(short_ids_log), Some("2"))
  assert_eq(LogRecord::trace_id(long_ids_log), Some("0123456789abcdef0123456789abcdef"))
  assert_eq(LogRecord::span_id(long_ids_log), Some("0123456789abcdef"))
  
  // æµ‹è¯•æ—¥å¿—å‘å°„
  Logger::emit(logger, trace_log)
  Logger::emit(logger, debug_log)
  Logger::emit(logger, info_log)
  Logger::emit(logger, warn_log)
  Logger::emit(logger, error_log)
  Logger::emit(logger, fatal_log)
  Logger::emit(logger, empty_log)
  Logger::emit(logger, unicode_log)
  Logger::emit(logger, full_log)
  Logger::emit(logger, min_timestamp_log)
  Logger::emit(logger, max_timestamp_log)
  Logger::emit(logger, short_ids_log)
  Logger::emit(logger, long_ids_log)
}

test "HTTPå®¢æˆ·ç«¯å¤æ‚åœºæ™¯æµ‹è¯•" {
  let client = HttpClient::new()
  
  // æµ‹è¯•å„ç§HTTPæ–¹æ³•ç»„åˆ
  let methods = ["GET", "POST", "PUT", "DELETE", "PATCH", "HEAD", "OPTIONS"]
  
  for method in methods {
    let request = HttpRequest::new(method, "https://api.example.com/test", [], None)
    assert_eq(HttpRequest::http_method(request), method)
    assert_eq(HttpRequest::url(request), "https://api.example.com/test")
    assert_eq(HttpRequest::body(request), None)
  }
  
  // æµ‹è¯•å„ç§URLæ ¼å¼
  let urls = [
    "https://api.example.com",
    "https://api.example.com/",
    "https://api.example.com/v1/users",
    "https://api.example.com/v1/users/123",
    "https://api.example.com/v1/users/123?active=true",
    "https://api.example.com/v1/users/123?active=true&sort=name",
    "http://localhost:8080/api/test",
    "https://sub.domain.example.com:8443/path/to/resource",
    "https://example.com/path/with spaces/and-special-chars?param=value&other=æµ‹è¯•"
  ]
  
  for url in urls {
    let request = HttpRequest::new("GET", url, [], None)
    assert_eq(HttpRequest::url(request), url)
  }
  
  // æµ‹è¯•å¤æ‚çš„å¤´éƒ¨ç»„åˆ
  let complex_headers = [
    ("Content-Type", "application/json"),
    ("Authorization", "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"),
    ("X-Request-ID", "req-123456"),
    ("X-Correlation-ID", "corr-789012"),
    ("User-Agent", "Azimuth-Telemetry/1.0.0"),
    ("Accept", "application/json,text/plain,*/*"),
    ("X-Custom-Header", "custom-value"),
    ("X-Unicode-Header", "æµ‹è¯•å¤´éƒ¨å€¼"),
    ("X-Empty-Header", ""),
    ("X-Long-Header", "This is a very long header value that tests the system's ability to handle lengthy header content without issues")
  ]
  
  let complex_request = HttpRequest::new("POST", "https://api.example.com/complex", complex_headers, Some("{\"test\":\"data\"}"))
  
  assert_eq(HttpRequest::http_method(complex_request), "POST")
  assert_eq(HttpRequest::url(complex_request), "https://api.example.com/complex")
  assert_eq(HttpRequest::body(complex_request), Some("{\"test\":\"data\"}"))
  
  // æµ‹è¯•å„ç§è¯·æ±‚ä½“æ ¼å¼
  let json_body = "{\"name\":\"test\",\"value\":123,\"active\":true}"
  let xml_body = "<root><item>test</item><value>123</value></root>"
  let text_body = "This is a plain text body"
  let empty_body = ""
  let long_body = "This is a very long request body that tests the system's ability to handle large amounts of data without performance issues or memory problems. It contains various characters and formatting to ensure comprehensive testing coverage."
  let unicode_body = "æµ‹è¯•è¯·æ±‚ä½“å†…å®¹ ğŸš€ Special characters: !@#$%^&*()"
  let binary_body = "Binary data: \x00\x01\x02\x03\xFF\xFE\xFD"
  
  let json_request = HttpRequest::new("POST", "https://api.example.com/json", [], Some(json_body))
  let xml_request = HttpRequest::new("POST", "https://api.example.com/xml", [], Some(xml_body))
  let text_request = HttpRequest::new("POST", "https://api.example.com/text", [], Some(text_body))
  let empty_request = HttpRequest::new("POST", "https://api.example.com/empty", [], Some(empty_body))
  let long_request = HttpRequest::new("POST", "https://api.example.com/long", [], Some(long_body))
  let unicode_request = HttpRequest::new("POST", "https://api.example.com/unicode", [], Some(unicode_body))
  let binary_request = HttpRequest::new("POST", "https://api.example.com/binary", [], Some(binary_body))
  
  assert_eq(HttpRequest::body(json_request), Some(json_body))
  assert_eq(HttpRequest::body(xml_request), Some(xml_body))
  assert_eq(HttpRequest::body(text_request), Some(text_body))
  assert_eq(HttpRequest::body(empty_request), Some(empty_body))
  assert_eq(HttpRequest::body(long_request), Some(long_body))
  assert_eq(HttpRequest::body(unicode_request), Some(unicode_body))
  assert_eq(HttpRequest::body(binary_request), Some(binary_body))
  
  // æµ‹è¯•å„ç§HTTPçŠ¶æ€ç å“åº”
  let status_codes = [100, 101, 200, 201, 202, 204, 301, 302, 304, 400, 401, 403, 404, 500, 502, 503]
  
  for status in status_codes {
    let response = HttpResponse::new(status, [], Some("Response body"))
    assert_eq(HttpResponse::status_code(response), status)
    assert_eq(HttpResponse::body(response), Some("Response body"))
  }
  
  // æµ‹è¯•å¤æ‚çš„å“åº”å¤´éƒ¨
  let response_headers = [
    ("Content-Type", "application/json"),
    ("Content-Length", "1234"),
    ("X-Response-ID", "resp-123456"),
    ("X-Processing-Time", "150ms"),
    ("Cache-Control", "no-cache, no-store, must-revalidate"),
    ("Set-Cookie", "session=abc123; HttpOnly; Secure"),
    ("X-Rate-Limit-Remaining", "999"),
    ("X-Unicode-Response", "å“åº”å¤´éƒ¨å€¼"),
    ("X-Empty-Response", ""),
    ("X-Long-Response", "This is a very long response header value that tests the system's ability to handle lengthy header content in responses without issues or performance degradation")
  ]
  
  let complex_response = HttpResponse::new(200, response_headers, Some("{\"success\":true,\"data\":\"test\"}"))
  
  assert_eq(HttpResponse::status_code(complex_response), 200)
  assert_eq(HttpResponse::body(complex_response), Some("{\"success\":true,\"data\":\"test\"}"))
  
  // æµ‹è¯•å„ç§å“åº”ä½“æ ¼å¼
  let success_response = HttpResponse::new(200, [], Some("{\"status\":\"success\"}"))
  let error_response = HttpResponse::new(500, [], Some("{\"error\":\"Internal Server Error\"}"))
  let empty_response = HttpResponse::new(204, [], None)
  let text_response = HttpResponse::new(200, [], Some("Plain text response"))
  let html_response = HttpResponse::new(200, [], Some("<html><body>HTML Response</body></html>"))
  let unicode_response = HttpResponse::new(200, [], Some("æµ‹è¯•å“åº”å†…å®¹ ğŸš€"))
  
  assert_eq(HttpResponse::body(success_response), Some("{\"status\":\"success\"}"))
  assert_eq(HttpResponse::body(error_response), Some("{\"error\":\"Internal Server Error\"}"))
  assert_eq(HttpResponse::body(empty_response), None)
  assert_eq(HttpResponse::body(text_response), Some("Plain text response"))
  assert_eq(HttpResponse::body(html_response), Some("<html><body>HTML Response</body></html>"))
  assert_eq(HttpResponse::body(unicode_response), Some("æµ‹è¯•å“åº”å†…å®¹ ğŸš€"))
}

test "SpanContextå’Œä¼ æ’­å™¨è¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•å„ç§SpanContextç»„åˆ
  let valid_ctx1 = SpanContext::new("0123456789abcdef", "0123456789abcdef", true, "")
  let valid_ctx2 = SpanContext::new("0123456789abcdef0123456789abcdef", "0123456789abcdef", false, "key1=value1")
  let valid_ctx3 = SpanContext::new("trace", "span", true, "key1=value1,key2=value2,key3=value3")
  
  let invalid_ctx1 = SpanContext::new("", "", false, "")
  let invalid_ctx2 = SpanContext::new("", "span", true, "")
  let invalid_ctx3 = SpanContext::new("trace", "", false, "")
  
  // éªŒè¯æœ‰æ•ˆçš„SpanContext
  assert_true(SpanContext::is_valid(valid_ctx1))
  assert_true(SpanContext::is_valid(valid_ctx2))
  assert_true(SpanContext::is_valid(valid_ctx3))
  
  // éªŒè¯æ— æ•ˆçš„SpanContext
  assert_false(SpanContext::is_valid(invalid_ctx1))
  assert_false(SpanContext::is_valid(invalid_ctx2))
  assert_false(SpanContext::is_valid(invalid_ctx3))
  
  // éªŒè¯é‡‡æ ·çŠ¶æ€
  assert_true(SpanContext::is_sampled(valid_ctx1))
  assert_false(SpanContext::is_sampled(valid_ctx2))
  assert_true(SpanContext::is_sampled(valid_ctx3))
  
  // æµ‹è¯•trace_idå’Œspan_idçš„è·å–
  assert_eq(SpanContext::trace_id(valid_ctx1), "0123456789abcdef")
  assert_eq(SpanContext::span_id(valid_ctx1), "0123456789abcdef")
  assert_eq(SpanContext::trace_id(valid_ctx2), "0123456789abcdef0123456789abcdef")
  assert_eq(SpanContext::span_id(valid_ctx2), "0123456789abcdef")
  assert_eq(SpanContext::trace_id(valid_ctx3), "trace")
  assert_eq(SpanContext::span_id(valid_ctx3), "span")
  
  // æµ‹è¯•ä¼ æ’­å™¨çš„åˆ›å»ºå’Œä½¿ç”¨
  let trace_propagator1 = W3CTraceContextPropagator::new()
  let trace_propagator2 = W3CTraceContextPropagator::new()
  let baggage_propagator1 = W3CBaggagePropagator::new()
  let baggage_propagator2 = W3CBaggagePropagator::new()
  
  // æµ‹è¯•å•ä¸ªä¼ æ’­å™¨çš„å¤åˆä¼ æ’­å™¨
  let single_composite = CompositePropagator::new([trace_propagator1])
  
  // æµ‹è¯•å¤šä¸ªä¼ æ’­å™¨çš„å¤åˆä¼ æ’­å™¨
  let multi_composite = CompositePropagator::new([trace_propagator1, trace_propagator2])
  
  // æµ‹è¯•åŒ…å«baggageä¼ æ’­å™¨çš„å¤åˆä¼ æ’­å™¨
  let mixed_composite = CompositePropagator::new([trace_propagator1, baggage_propagator1])
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡æ³¨å…¥
  let ctx = Context::root()
  let carrier = TextMapCarrier::new()
  
  CompositePropagator::inject(single_composite, ctx, carrier)
  CompositePropagator::inject(multi_composite, ctx, carrier)
  CompositePropagator::inject(mixed_composite, ctx, carrier)
  
  // éªŒè¯æ³¨å…¥åçš„carrierå†…å®¹
  let injected_traceparent = TextMapCarrier::get(carrier, "traceparent")
  assert_eq(injected_traceparent, Some("00-test-trace-id-test-span-id-01"))
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡æå–
  let extracted_ctx1 = CompositePropagator::extract(single_composite, carrier)
  let extracted_ctx2 = CompositePropagator::extract(multi_composite, carrier)
  let extracted_ctx3 = CompositePropagator::extract(mixed_composite, carrier)
  
  // éªŒè¯æå–çš„ä¸Šä¸‹æ–‡
  let extracted_key = ContextKey::new("extracted")
  assert_eq(Context::get(extracted_ctx1, extracted_key), Some("true"))
  assert_eq(Context::get(extracted_ctx2, extracted_key), Some("true"))
  assert_eq(Context::get(extracted_ctx3, extracted_key), Some("true"))
  
  // æµ‹è¯•å¤æ‚çš„traceparentæ ¼å¼
  let complex_carrier = TextMapCarrier::new()
  TextMapCarrier::set(complex_carrier, "traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  TextMapCarrier::set(complex_carrier, "baggage", "key1=value1;key2=value2;key3=value3")
  TextMapCarrier::set(complex_carrier, "x-custom-header", "custom-value")
  
  let complex_extracted_ctx = CompositePropagator::extract(mixed_composite, complex_carrier)
  assert_eq(Context::get(complex_extracted_ctx, extracted_key), Some("true"))
  
  // æµ‹è¯•ç©ºcarrierçš„æå–
  let empty_carrier = TextMapCarrier::new()
  let empty_extracted_ctx = CompositePropagator::extract(single_composite, empty_carrier)
  assert_eq(Context::get(empty_extracted_ctx, extracted_key), Some("true"))
}

test "èµ„æºç®¡ç†åˆå¹¶å’Œå†²çªæµ‹è¯•" {
  // æµ‹è¯•èµ„æºçš„åˆ›å»ºå’Œå±æ€§ç®¡ç†
  let resource1 = Resource::new()
  let resource2 = Resource::new()
  let resource3 = Resource::new()
  
  // åˆ›å»ºä¸åŒçš„å±æ€§é›†åˆ
  let attrs1 = [
    ("service.name", StringValue("azimuth-service")),
    ("service.version", StringValue("1.0.0")),
    ("service.instance.id", StringValue("instance-123"))
  ]
  
  let attrs2 = [
    ("service.name", StringValue("override-service")),
    ("deployment.environment", StringValue("production")),
    ("host.name", StringValue("web-server-01"))
  ]
  
  let attrs3 = [
    ("service.name", StringValue("final-service")),
    ("service.version", StringValue("2.0.0")),
    ("telemetry.sdk.name", StringValue("azimuth")),
    ("telemetry.sdk.version", StringValue("1.0.0")),
    ("process.pid", IntValue(12345))
  ]
  
  // åˆ›å»ºå¸¦æœ‰å±æ€§çš„èµ„æº
  let resource_with_attrs1 = Resource::with_attributes(resource1, attrs1)
  let resource_with_attrs2 = Resource::with_attributes(resource2, attrs2)
  let resource_with_attrs3 = Resource::with_attributes(resource3, attrs3)
  
  // éªŒè¯å±æ€§è®¾ç½®
  assert_eq(Resource::get_attribute(resource_with_attrs1, "service.name"), Some(StringValue("azimuth-service")))
  assert_eq(Resource::get_attribute(resource_with_attrs1, "service.version"), Some(StringValue("1.0.0")))
  assert_eq(Resource::get_attribute(resource_with_attrs1, "service.instance.id"), Some(StringValue("instance-123")))
  
  assert_eq(Resource::get_attribute(resource_with_attrs2, "service.name"), Some(StringValue("override-service")))
  assert_eq(Resource::get_attribute(resource_with_attrs2, "deployment.environment"), Some(StringValue("production")))
  assert_eq(Resource::get_attribute(resource_with_attrs2, "host.name"), Some(StringValue("web-server-01")))
  
  assert_eq(Resource::get_attribute(resource_with_attrs3, "service.name"), Some(StringValue("final-service")))
  assert_eq(Resource::get_attribute(resource_with_attrs3, "service.version"), Some(StringValue("2.0.0")))
  assert_eq(Resource::get_attribute(resource_with_attrs3, "telemetry.sdk.name"), Some(StringValue("azimuth")))
  assert_eq(Resource::get_attribute(resource_with_attrs3, "process.pid"), Some(IntValue(12345)))
  
  // æµ‹è¯•èµ„æºåˆå¹¶
  let merged1 = Resource::merge(resource_with_attrs1, resource_with_attrs2)
  let merged2 = Resource::merge(merged1, resource_with_attrs3)
  let merged3 = Resource::merge(resource_with_attrs2, resource_with_attrs1)
  
  // éªŒè¯åˆå¹¶ç»“æœï¼ˆç®€åŒ–å®ç°ä¸­åº”è¯¥è¿”å›overrideèµ„æºï¼‰
  assert_eq(Resource::get_attribute(merged1, "service.name"), Some(StringValue("override-service")))
  assert_eq(Resource::get_attribute(merged1, "deployment.environment"), Some(StringValue("production")))
  
  assert_eq(Resource::get_attribute(merged2, "service.name"), Some(StringValue("final-service")))
  assert_eq(Resource::get_attribute(merged2, "telemetry.sdk.name"), Some(StringValue("azimuth")))
  
  assert_eq(Resource::get_attribute(merged3, "service.name"), Some(StringValue("azimuth-service")))
  assert_eq(Resource::get_attribute(merged3, "service.version"), Some(StringValue("1.0.0")))
  
  // æµ‹è¯•ç©ºèµ„æºçš„åˆå¹¶
  let empty_resource = Resource::new()
  let merged_with_empty1 = Resource::merge(empty_resource, resource_with_attrs1)
  let merged_with_empty2 = Resource::merge(resource_with_attrs1, empty_resource)
  
  assert_eq(Resource::get_attribute(merged_with_empty1, "service.name"), Some(StringValue("azimuth-service")))
  assert_eq(Resource::get_attribute(merged_with_empty2, "service.name"), Some(StringValue("azimuth-service")))
  
  // æµ‹è¯•è‡ªåˆå¹¶
  let self_merged = Resource::merge(resource_with_attrs1, resource_with_attrs1)
  assert_eq(Resource::get_attribute(self_merged, "service.name"), Some(StringValue("azimuth-service")))
  
  // æµ‹è¯•å¤æ‚å±æ€§ç±»å‹çš„èµ„æº
  let complex_attrs = [
    ("string.attr", StringValue("string value")),
    ("int.attr", IntValue(42)),
    ("float.attr", FloatValue(3.14159)),
    ("bool.attr", BoolValue(true)),
    ("array.string.attr", ArrayStringValue(["item1", "item2", "item3"])),
    ("array.int.attr", ArrayIntValue([1, 2, 3, 4, 5]))
  ]
  
  let complex_resource = Resource::with_attributes(Resource::new(), complex_attrs)
  
  assert_eq(Resource::get_attribute(complex_resource, "string.attr"), Some(StringValue("string value")))
  assert_eq(Resource::get_attribute(complex_resource, "int.attr"), Some(IntValue(42)))
  assert_eq(Resource::get_attribute(complex_resource, "float.attr"), Some(FloatValue(3.14159)))
  assert_eq(Resource::get_attribute(complex_resource, "bool.attr"), Some(BoolValue(true)))
  assert_eq(Resource::get_attribute(complex_resource, "array.string.attr"), Some(ArrayStringValue(["item1", "item2", "item3"])))
  assert_eq(Resource::get_attribute(complex_resource, "array.int.attr"), Some(ArrayIntValue([1, 2, 3, 4, 5])))
  
  // æµ‹è¯•è¾¹ç•Œæƒ…å†µ
  let boundary_attrs = [
    ("empty.string", StringValue("")),
    ("whitespace.string", StringValue("   ")),
    ("unicode.string", StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€")),
    ("long.string", StringValue("This is a very long string value that tests the system's ability to handle lengthy attribute values without issues or performance degradation")),
    ("zero.int", IntValue(0)),
    ("negative.int", IntValue(-1)),
    ("max.int", IntValue(2147483647)),
    ("min.int", IntValue(-2147483648)),
    ("zero.float", FloatValue(0.0)),
    ("negative.float", FloatValue(-0.001)),
    ("max.float", FloatValue(1.7976931348623157e+308)),
    ("min.float", FloatValue(-1.7976931348623157e+308))
  ]
  
  let boundary_resource = Resource::with_attributes(Resource::new(), boundary_attrs)
  
  assert_eq(Resource::get_attribute(boundary_resource, "empty.string"), Some(StringValue("")))
  assert_eq(Resource::get_attribute(boundary_resource, "whitespace.string"), Some(StringValue("   ")))
  assert_eq(Resource::get_attribute(boundary_resource, "unicode.string"), Some(StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€")))
  assert_eq(Resource::get_attribute(boundary_resource, "zero.int"), Some(IntValue(0)))
  assert_eq(Resource::get_attribute(boundary_resource, "negative.int"), Some(IntValue(-1)))
  assert_eq(Resource::get_attribute(boundary_resource, "max.int"), Some(IntValue(2147483647)))
  assert_eq(Resource::get_attribute(boundary_resource, "min.int"), Some(IntValue(-2147483648)))
}
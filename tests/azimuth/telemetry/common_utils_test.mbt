// Commonæ¨¡å—å·¥å…·å‡½æ•°æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•commonæ¨¡å—ä¸­çš„å„ç§å·¥å…·å‡½æ•°

test "attribute value type conversions" {
  // æµ‹è¯•å±æ€§å€¼ç±»å‹è½¬æ¢
  let string_val = @azimuth.telemetry.api.common.StringValue("test string")
  let int_val = @azimuth.telemetry.api.common.IntValue(42)
  let float_val = @azimuth.telemetry.api.common.FloatValue(3.14)
  let bool_val = @azimuth.telemetry.api.common.BoolValue(true)
  let array_val = @azimuth.telemetry.api.common.ArrayStringValue(["item1", "item2", "item3"])
  
  // éªŒè¯å€¼ç±»å‹
  assert_eq(@azimuth.telemetry.api.common.AttributeValue.as_string(string_val), "test string")
  assert_eq(@azimuth.telemetry.api.common.AttributeValue.as_int(int_val), 42)
  assert_eq(@azimuth.telemetry.api.common.AttributeValue.as_float(float_val), 3.14)
  assert_eq(@azimuth.telemetry.api.common.AttributeValue.as_bool(bool_val), true)
  
  let array_result = @azimuth.telemetry.api.common.AttributeValue.as_array_string(array_val)
  assert_eq(array_result.length(), 3)
  assert_eq(array_result[0], "item1")
  assert_eq(array_result[1], "item2")
  assert_eq(array_result[2], "item3")
}

test "attribute value equality and comparison" {
  // æµ‹è¯•å±æ€§å€¼ç›¸ç­‰æ€§å’Œæ¯”è¾ƒ
  let string1 = @azimuth.telemetry.api.common.StringValue("test")
  let string2 = @azimuth.telemetry.api.common.StringValue("test")
  let string3 = @azimuth.telemetry.api.common.StringValue("different")
  
  // å­—ç¬¦ä¸²å€¼æ¯”è¾ƒ
  assert_eq(string1, string2)
  assert_true(string1 != string3)
  
  // æ•°å€¼æ¯”è¾ƒ
  let int1 = @azimuth.telemetry.api.common.IntValue(42)
  let int2 = @azimuth.telemetry.api.common.IntValue(42)
  let int3 = @azimuth.telemetry.api.common.IntValue(43)
  
  assert_eq(int1, int2)
  assert_true(int1 != int3)
  
  // æµ®ç‚¹æ•°æ¯”è¾ƒ
  let float1 = @azimuth.telemetry.api.common.FloatValue(3.14)
  let float2 = @azimuth.telemetry.api.common.FloatValue(3.14)
  let float3 = @azimuth.telemetry.api.common.FloatValue(2.71)
  
  assert_eq(float1, float2)
  assert_true(float1 != float3)
  
  // å¸ƒå°”å€¼æ¯”è¾ƒ
  let bool1 = @azimuth.telemetry.api.common.BoolValue(true)
  let bool2 = @azimuth.telemetry.api.common.BoolValue(true)
  let bool3 = @azimuth.telemetry.api.common.BoolValue(false)
  
  assert_eq(bool1, bool2)
  assert_true(bool1 != bool3)
  
  // æ•°ç»„å€¼æ¯”è¾ƒ
  let array1 = @azimuth.telemetry.api.common.ArrayStringValue(["a", "b", "c"])
  let array2 = @azimuth.telemetry.api.common.ArrayStringValue(["a", "b", "c"])
  let array3 = @azimuth.telemetry.api.common.ArrayStringValue(["a", "b", "d"])
  
  assert_eq(array1, array2)
  assert_true(array1 != array3)
}

test "attributes collection operations" {
  // æµ‹è¯•å±æ€§é›†åˆæ“ä½œ
  let attrs = @azimuth.telemetry.api.common.Attributes.new()
  
  // æµ‹è¯•ç©ºé›†åˆ
  assert_eq(attrs.values.length(), 0)
  
  // æ·»åŠ å±æ€§
  @azimuth.telemetry.api.common.Attributes.set(attrs, "key1", @azimuth.telemetry.api.common.StringValue("value1"))
  @azimuth.telemetry.api.common.Attributes.set(attrs, "key2", @azimuth.telemetry.api.common.IntValue(42))
  @azimuth.telemetry.api.common.Attributes.set(attrs, "key3", @azimuth.telemetry.api.common.FloatValue(3.14))
  @azimuth.telemetry.api.common.Attributes.set(attrs, "key4", @azimuth.telemetry.api.common.BoolValue(true))
  
  assert_eq(attrs.values.length(), 4)
  
  // è·å–å±æ€§
  let value1 = @azimuth.telemetry.api.common.Attributes.get(attrs, "key1")
  let value2 = @azimuth.telemetry.api.common.Attributes.get(attrs, "key2")
  let value3 = @azimuth.telemetry.api.common.Attributes.get(attrs, "key3")
  let value4 = @azimuth.telemetry.api.common.Attributes.get(attrs, "key4")
  let value5 = @azimuth.telemetry.api.common.Attributes.get(attrs, "nonexistent")
  
  assert_eq(value1, Some(@azimuth.telemetry.api.common.StringValue("value1")))
  assert_eq(value2, Some(@azimuth.telemetry.api.common.IntValue(42)))
  assert_eq(value3, Some(@azimuth.telemetry.api.common.FloatValue(3.14)))
  assert_eq(value4, Some(@azimuth.telemetry.api.common.BoolValue(true)))
  assert_eq(value5, None)
  
  // è¦†ç›–å±æ€§
  @azimuth.telemetry.api.common.Attributes.set(attrs, "key1", @azimuth.telemetry.api.common.StringValue("new_value1"))
  let new_value1 = @azimuth.telemetry.api.common.Attributes.get(attrs, "key1")
  assert_eq(new_value1, Some(@azimuth.telemetry.api.common.StringValue("new_value1")))
  assert_eq(attrs.values.length(), 4) // é•¿åº¦ä¸å˜
}

test "attributes with special keys" {
  // æµ‹è¯•åŒ…å«ç‰¹æ®Šé”®çš„å±æ€§
  let attrs = @azimuth.telemetry.api.common.Attributes.new()
  
  // æµ‹è¯•å„ç§ç‰¹æ®Šé”®
  let special_keys = [
    "key.with.dots",
    "key-with-dashes",
    "key_with_underscores",
    "key/with/slashes",
    "key\\with\\backslashes",
    "key with spaces",
    "key\twith\ttabs",
    "key\nwith\nnewlines",
    "key\"with\"quotes",
    "key'with'apostrophes",
    "key[with]brackets",
    "key{with}braces",
    "key(with)parentheses",
    "key<with>angles",
    "key|with|pipes",
    "key+with+plus",
    "key=with=equals",
    "key?with?questions",
    "key@with@ats",
    "key#with#hashes",
    "key$with$dollars",
    "key%with%percents",
    "key^with^carets",
    "key&with&ampersands",
    "key*with*asterisks"
  ]
  
  for i = 0; i < special_keys.length(); i = i + 1 {
    let key = special_keys[i]
    let value = @azimuth.telemetry.api.common.StringValue("value_for_${key}")
    @azimuth.telemetry.api.common.Attributes.set(attrs, key, value)
  }
  
  // éªŒè¯æ‰€æœ‰ç‰¹æ®Šé”®éƒ½èƒ½æ­£ç¡®è®¾ç½®å’Œè·å–
  for i = 0; i < special_keys.length(); i = i + 1 {
    let key = special_keys[i]
    let expected_value = @azimuth.telemetry.api.common.StringValue("value_for_${key}")
    let actual_value = @azimuth.telemetry.api.common.Attributes.get(attrs, key)
    assert_eq(actual_value, Some(expected_value))
  }
  
  assert_eq(attrs.values.length(), special_keys.length())
}

test "attributes with large values" {
  // æµ‹è¯•åŒ…å«å¤§å€¼çš„å±æ€§
  let attrs = @azimuth.telemetry.api.common.Attributes.new()
  
  // åˆ›å»ºå¤§å­—ç¬¦ä¸²å€¼
  let large_string = "x".repeat(10000)
  @azimuth.telemetry.api.common.Attributes.set(attrs, "large_string", @azimuth.telemetry.api.common.StringValue(large_string))
  
  // åˆ›å»ºå¤§æ•°ç»„å€¼
  let large_array = []
  for i = 0; i < 1000; i = i + 1 {
    large_array.push("array_item_${i}")
  }
  @azimuth.telemetry.api.common.Attributes.set(attrs, "large_array", @azimuth.telemetry.api.common.ArrayStringValue(large_array))
  
  // åˆ›å»ºæå€¼
  @azimuth.telemetry.api.common.Attributes.set(attrs, "max_int", @azimuth.telemetry.api.common.IntValue(2147483647))
  @azimuth.telemetry.api.common.Attributes.set(attrs, "min_int", @azimuth.telemetry.api.common.IntValue(-2147483648))
  @azimuth.telemetry.api.common.Attributes.set(attrs, "max_float", @azimuth.telemetry.api.common.FloatValue(1.7976931348623157e+308))
  @azimuth.telemetry.api.common.Attributes.set(attrs, "min_float", @azimuth.telemetry.api.common.FloatValue(-1.7976931348623157e+308))
  
  // éªŒè¯å¤§å€¼
  let retrieved_large_string = @azimuth.telemetry.api.common.Attributes.get(attrs, "large_string")
  assert_eq(retrieved_large_string, Some(@azimuth.telemetry.api.common.StringValue(large_string)))
  
  let retrieved_large_array = @azimuth.telemetry.api.common.Attributes.get(attrs, "large_array")
  assert_true(retrieved_large_array != None)
  
  let retrieved_max_int = @azimuth.telemetry.api.common.Attributes.get(attrs, "max_int")
  assert_eq(retrieved_max_int, Some(@azimuth.telemetry.api.common.IntValue(2147483647)))
  
  let retrieved_min_int = @azimuth.telemetry.api.common.Attributes.get(attrs, "min_int")
  assert_eq(retrieved_min_int, Some(@azimuth.telemetry.api.common.IntValue(-2147483648)))
}

test "attributes edge cases" {
  // æµ‹è¯•å±æ€§çš„è¾¹ç•Œæƒ…å†µ
  let attrs = @azimuth.telemetry.api.common.Attributes.new()
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²é”®å’Œå€¼
  @azimuth.telemetry.api.common.Attributes.set(attrs, "", @azimuth.telemetry.api.common.StringValue(""))
  let empty_key_value = @azimuth.telemetry.api.common.Attributes.get(attrs, "")
  assert_eq(empty_key_value, Some(@azimuth.telemetry.api.common.StringValue("")))
  
  @azimuth.telemetry.api.common.Attributes.set(attrs, "empty_value", @azimuth.telemetry.api.common.StringValue(""))
  let empty_value = @azimuth.telemetry.api.common.Attributes.get(attrs, "empty_value")
  assert_eq(empty_value, Some(@azimuth.telemetry.api.common.StringValue("")))
  
  // æµ‹è¯•ç©ºæ•°ç»„
  @azimuth.telemetry.api.common.Attributes.set(attrs, "empty_array", @azimuth.telemetry.api.common.ArrayStringValue([]))
  let empty_array = @azimuth.telemetry.api.common.Attributes.get(attrs, "empty_array")
  assert_true(empty_array != None)
  
  // æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„å­—ç¬¦ä¸²
  let special_chars = "\0\t\n\r\"'\\[]{}()<>|+=?@#$%^&*"
  @azimuth.telemetry.api.common.Attributes.set(attrs, "special_chars", @azimuth.telemetry.api.common.StringValue(special_chars))
  let retrieved_special_chars = @azimuth.telemetry.api.common.Attributes.get(attrs, "special_chars")
  assert_eq(retrieved_special_chars, Some(@azimuth.telemetry.api.common.StringValue(special_chars)))
  
  // æµ‹è¯•Unicodeå­—ç¬¦
  let unicode_string = "æµ‹è¯•ä¸­æ–‡å­—ç¬¦ä¸² ğŸš€ emoji"
  @azimuth.telemetry.api.common.Attributes.set(attrs, "unicode", @azimuth.telemetry.api.common.StringValue(unicode_string))
  let retrieved_unicode = @azimuth.telemetry.api.common.Attributes.get(attrs, "unicode")
  assert_eq(retrieved_unicode, Some(@azimuth.telemetry.api.common.StringValue(unicode_string)))
}

test "attributes collection merging" {
  // æµ‹è¯•å±æ€§é›†åˆåˆå¹¶
  let attrs1 = @azimuth.telemetry.api.common.Attributes.new()
  let attrs2 = @azimuth.telemetry.api.common.Attributes.new()
  
  // è®¾ç½®ç¬¬ä¸€ä¸ªé›†åˆçš„å±æ€§
  @azimuth.telemetry.api.common.Attributes.set(attrs1, "key1", @azimuth.telemetry.api.common.StringValue("value1"))
  @azimuth.telemetry.api.common.Attributes.set(attrs1, "key2", @azimuth.telemetry.api.common.IntValue(42))
  @azimuth.telemetry.api.common.Attributes.set(attrs1, "key3", @azimuth.telemetry.api.common.FloatValue(3.14))
  
  // è®¾ç½®ç¬¬äºŒä¸ªé›†åˆçš„å±æ€§
  @azimuth.telemetry.api.common.Attributes.set(attrs2, "key2", @azimuth.telemetry.api.common.StringValue("new_value2")) // è¦†ç›–key2
  @azimuth.telemetry.api.common.Attributes.set(attrs2, "key4", @azimuth.telemetry.api.common.BoolValue(true))
  @azimuth.telemetry.api.common.Attributes.set(attrs2, "key5", @azimuth.telemetry.api.common.ArrayStringValue(["a", "b", "c"]))
  
  // åˆå¹¶å±æ€§ï¼ˆå¦‚æœAPIæ”¯æŒï¼‰
  // è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿåˆå¹¶è¿‡ç¨‹
  let merged_attrs = @azimuth.telemetry.api.common.Attributes.new()
  
  // ä»attrs1å¤åˆ¶å±æ€§
  let key1_value = @azimuth.telemetry.api.common.Attributes.get(attrs1, "key1")
  let key2_value = @azimuth.telemetry.api.common.Attributes.get(attrs1, "key2")
  let key3_value = @azimuth.telemetry.api.common.Attributes.get(attrs1, "key3")
  
  if key1_value != None {
    @azimuth.telemetry.api.common.Attributes.set(merged_attrs, "key1", key1_value.unwrap())
  }
  if key2_value != None {
    @azimuth.telemetry.api.common.Attributes.set(merged_attrs, "key2", key2_value.unwrap())
  }
  if key3_value != None {
    @azimuth.telemetry.api.common.Attributes.set(merged_attrs, "key3", key3_value.unwrap())
  }
  
  // ä»attrs2å¤åˆ¶å±æ€§ï¼ˆè¦†ç›–åŒåçš„ï¼‰
  let key2_new_value = @azimuth.telemetry.api.common.Attributes.get(attrs2, "key2")
  let key4_value = @azimuth.telemetry.api.common.Attributes.get(attrs2, "key4")
  let key5_value = @azimuth.telemetry.api.common.Attributes.get(attrs2, "key5")
  
  if key2_new_value != None {
    @azimuth.telemetry.api.common.Attributes.set(merged_attrs, "key2", key2_new_value.unwrap())
  }
  if key4_value != None {
    @azimuth.telemetry.api.common.Attributes.set(merged_attrs, "key4", key4_value.unwrap())
  }
  if key5_value != None {
    @azimuth.telemetry.api.common.Attributes.set(merged_attrs, "key5", key5_value.unwrap())
  }
  
  // éªŒè¯åˆå¹¶ç»“æœ
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(merged_attrs, "key1"), 
           Some(@azimuth.telemetry.api.common.StringValue("value1")))
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(merged_attrs, "key2"), 
           Some(@azimuth.telemetry.api.common.StringValue("new_value2"))) // è¢«è¦†ç›–
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(merged_attrs, "key3"), 
           Some(@azimuth.telemetry.api.common.FloatValue(3.14)))
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(merged_attrs, "key4"), 
           Some(@azimuth.telemetry.api.common.BoolValue(true)))
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(merged_attrs, "key5"), 
           Some(@azimuth.telemetry.api.common.ArrayStringValue(["a", "b", "c"])))
}

test "attributes serialization and deserialization" {
  // æµ‹è¯•å±æ€§åºåˆ—åŒ–å’Œååºåˆ—åŒ–
  let attrs = @azimuth.telemetry.api.common.Attributes.new()
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§
  @azimuth.telemetry.api.common.Attributes.set(attrs, "string_key", @azimuth.telemetry.api.common.StringValue("test_value"))
  @azimuth.telemetry.api.common.Attributes.set(attrs, "int_key", @azimuth.telemetry.api.common.IntValue(42))
  @azimuth.telemetry.api.common.Attributes.set(attrs, "float_key", @azimuth.telemetry.api.common.FloatValue(3.14))
  @azimuth.telemetry.api.common.Attributes.set(attrs, "bool_key", @azimuth.telemetry.api.common.BoolValue(true))
  @azimuth.telemetry.api.common.Attributes.set(attrs, "array_key", @azimuth.telemetry.api.common.ArrayStringValue(["a", "b", "c"]))
  
  // éªŒè¯å±æ€§å­˜åœ¨
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(attrs, "string_key"), 
           Some(@azimuth.telemetry.api.common.StringValue("test_value")))
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(attrs, "int_key"), 
           Some(@azimuth.telemetry.api.common.IntValue(42)))
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(attrs, "float_key"), 
           Some(@azimuth.telemetry.api.common.FloatValue(3.14)))
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(attrs, "bool_key"), 
           Some(@azimuth.telemetry.api.common.BoolValue(true)))
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(attrs, "array_key"), 
           Some(@azimuth.telemetry.api.common.ArrayStringValue(["a", "b", "c"])))
  
  // æµ‹è¯•å±æ€§è®¡æ•°
  assert_eq(attrs.values.length(), 5)
  
  // åˆ›å»ºæ–°çš„å±æ€§é›†åˆå¹¶å¤åˆ¶æ‰€æœ‰å±æ€§
  let new_attrs = @azimuth.telemetry.api.common.Attributes.new()
  for i = 0; i < attrs.values.length(); i = i + 1 {
    let key_value = attrs.values[i]
    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æœ‰æ›´å¥½çš„å¤åˆ¶æœºåˆ¶
    if key_value.0 == "string_key" {
      @azimuth.telemetry.api.common.Attributes.set(new_attrs, key_value.0, key_value.1)
    } else if key_value.0 == "int_key" {
      @azimuth.telemetry.api.common.Attributes.set(new_attrs, key_value.0, key_value.1)
    } else if key_value.0 == "float_key" {
      @azimuth.telemetry.api.common.Attributes.set(new_attrs, key_value.0, key_value.1)
    } else if key_value.0 == "bool_key" {
      @azimuth.telemetry.api.common.Attributes.set(new_attrs, key_value.0, key_value.1)
    } else if key_value.0 == "array_key" {
      @azimuth.telemetry.api.common.Attributes.set(new_attrs, key_value.0, key_value.1)
    }
  }
  
  // éªŒè¯å¤åˆ¶çš„å±æ€§
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(new_attrs, "string_key"), 
           Some(@azimuth.telemetry.api.common.StringValue("test_value")))
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(new_attrs, "int_key"), 
           Some(@azimuth.telemetry.api.common.IntValue(42)))
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(new_attrs, "float_key"), 
           Some(@azimuth.telemetry.api.common.FloatValue(3.14)))
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(new_attrs, "bool_key"), 
           Some(@azimuth.telemetry.api.common.BoolValue(true)))
  assert_eq(@azimuth.telemetry.api.common.Attributes.get(new_attrs, "array_key"), 
           Some(@azimuth.telemetry.api.common.ArrayStringValue(["a", "b", "c"])))
}
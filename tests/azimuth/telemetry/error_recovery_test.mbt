// é”™è¯¯æ¢å¤å’Œå®¹é”™æµ‹è¯•
// Error recovery and fault tolerance tests for Azimuth telemetry system

test "é¥æµ‹æä¾›è€…æ•…éšœæ¢å¤æµ‹è¯•" {
  // æµ‹è¯•é¥æµ‹æä¾›è€…åœ¨æ•…éšœæƒ…å†µä¸‹çš„æ¢å¤èƒ½åŠ›
  
  // æµ‹è¯•é»˜è®¤æä¾›è€…åœ¨å¼‚å¸¸æ“ä½œä¸‹çš„ç¨³å®šæ€§
  let trace_provider = @azimuth.telemetry.sdk.trace.TracerProvider::default()
  let metrics_provider = @azimuth.telemetry.sdk.metrics.MeterProvider::default()
  let logs_provider = @azimuth.telemetry.sdk.logs.LoggerProvider::default()
  
  // åˆ›å»ºä»ªå™¨
  let tracer = @azimuth.telemetry.sdk.trace.TracerProvider::get_tracer(trace_provider, "fault.tolerant.tracer")
  let meter = @azimuth.telemetry.sdk.metrics.MeterProvider::get_meter(metrics_provider, "fault.tolerant.meter")
  let logger = @azimuth.telemetry.sdk.logs.LoggerProvider::get_logger(logs_provider, "fault.tolerant.logger")
  
  // æ¨¡æ‹Ÿå¼‚å¸¸æ“ä½œï¼šåˆ›å»ºå¤§é‡Span
  let spans = []
  for i in 0..50 {
    let (_, span) = @azimuth.telemetry.sdk.trace.Tracer::start_span(tracer, "fault.test.span." + i.to_string())
    spans = spans @ [span]
  }
  
  // å³ä½¿åœ¨é«˜è´Ÿè½½ä¸‹ï¼Œç³»ç»Ÿåº”è¯¥ä¿æŒç¨³å®š
  assert_true(spans.length() == 50)
  
  // ç»“æŸæ‰€æœ‰Spanï¼ŒéªŒè¯æ²¡æœ‰å´©æºƒ
  for span in spans {
    @azimuth.telemetry.api.trace.Span::end(span)
  }
  
  // æµ‹è¯•æŒ‡æ ‡è®°å½•çš„å®¹é”™æ€§
  let counter = @azimuth.telemetry.sdk.metrics.Meter::create_counter(meter, "fault.tolerant.counter")
  
  // è®°å½•å¤§é‡æŒ‡æ ‡
  for i in 0..100 {
    @azimuth.telemetry.sdk.metrics.Counter::add(counter, i.to_double())
  }
  
  // æµ‹è¯•æ—¥å¿—è®°å½•çš„å®¹é”™æ€§
  for i in 0..50 {
    let log_record = @azimuth.telemetry.api.logs.LogRecord::new(
      @azimuth.telemetry.api.logs.Info,
      "Fault tolerance test log " + i.to_string(),
      None,
      None,
      None,
      None,
      None,
      None
    )
    @azimuth.telemetry.sdk.logs.Logger::emit(logger, log_record)
  }
}

test "å†…å­˜å‹åŠ›ä¸‹çš„é¥æµ‹æ“ä½œæµ‹è¯•" {
  // æµ‹è¯•åœ¨å†…å­˜å‹åŠ›ä¸‹çš„é¥æµ‹æ“ä½œç¨³å®šæ€§
  
  // åˆ›å»ºå¤§é‡å±æ€§æ•°æ®
  let large_attrs = @azimuth.telemetry.api.common.Attributes::new()
  for i in 0..100 {
    let key = "large.attr.key." + i.to_string()
    let value = @azimuth.telemetry.api.common.StringValue("large.attr.value." + "x".repeat(100))
    @azimuth.telemetry.api.common.Attributes::set(large_attrs, key, value)
  }
  
  // åˆ›å»ºå¸¦æœ‰å¤§é‡å±æ€§çš„Span
  let trace_provider = @azimuth.telemetry.sdk.trace.TracerProvider::default()
  let tracer = @azimuth.telemetry.sdk.trace.TracerProvider::get_tracer(trace_provider, "memory.pressure.tracer")
  
  let memory_intensive_spans = []
  for i in 0..20 {
    let (_, span) = @azimuth.telemetry.sdk.trace.Tracer::start_span(tracer, "memory.intensive.span." + i.to_string())
    
    // æ·»åŠ å¤§é‡å±æ€§
    @azimuth.telemetry.api.trace.Span::set_attribute(span, "span.index", @azimuth.telemetry.api.common.IntValue(i))
    @azimuth.telemetry.api.trace.Span::set_attribute(span, "large.data", @azimuth.telemetry.api.common.StringValue("x".repeat(1000)))
    
    // æ·»åŠ å¤§é‡äº‹ä»¶
    for j in 0..10 {
      @azimuth.telemetry.api.trace.Span::add_event(
        span, 
        "memory.event." + j.to_string(), 
        Some([("event.data", @azimuth.telemetry.api.common.StringValue("y".repeat(500)))]),
        None
      )
    }
    
    memory_intensive_spans = memory_intensive_spans @ [span]
  }
  
  // éªŒè¯æ‰€æœ‰Spanéƒ½æ­£å¸¸åˆ›å»º
  assert_true(memory_intensive_spans.length() == 20)
  
  // ç»“æŸæ‰€æœ‰Span
  for span in memory_intensive_spans {
    @azimuth.telemetry.api.trace.Span::end(span)
  }
  
  // æµ‹è¯•å¤§é‡å±æ€§çš„èµ„æº
  let resource_attrs = []
  for i in 0..200 {
    resource_attrs = resource_attrs @ [("resource.attr." + i.to_string(), @azimuth.telemetry.api.common.StringValue("resource.value." + i.to_string()))]
  }
  
  let large_resource = @azimuth.telemetry.api.common.Resource::with_attributes(
    @azimuth.telemetry.api.common.Resource::new(),
    resource_attrs
  )
  
  // éªŒè¯èµ„æºåˆ›å»ºæˆåŠŸ
  assert_true(large_resource != @azimuth.telemetry.api.common.Resource::{})
}

test "å¯¼å‡ºå™¨æ•…éšœåˆ‡æ¢æµ‹è¯•" {
  // æµ‹è¯•å¯¼å‡ºå™¨åœ¨æ•…éšœæƒ…å†µä¸‹çš„åˆ‡æ¢èƒ½åŠ›
  
  // åˆ›å»ºå¤šä¸ªå¯¼å‡ºå™¨
  let console_exporter = @azimuth.telemetry.sdk.exporter.console.ConsoleSpanExporter::new()
  let otlp_exporter = @azimuth.telemetry.sdk.exporter.otlp_http.OtlpHttpSpanExporter::new()
  
  // éªŒè¯å¯¼å‡ºå™¨åˆ›å»ºæˆåŠŸ
  assert_true(console_exporter != @azimuth.telemetry.sdk.exporter.console.ConsoleSpanExporter::{})
  assert_true(otlp_exporter != @azimuth.telemetry.sdk.exporter.otlp_http.OtlpHttpSpanExporter::{})
  
  // åˆ›å»ºæµ‹è¯•Span
  let trace_provider = @azimuth.telemetry.sdk.trace.TracerProvider::default()
  let tracer = @azimuth.telemetry.sdk.trace.TracerProvider::get_tracer(trace_provider, "exporter.fault.test")
  
  let test_spans = []
  for i in 0..10 {
    let (_, span) = @azimuth.telemetry.sdk.trace.Tracer::start_span(tracer, "exporter.test.span." + i.to_string())
    @azimuth.telemetry.api.trace.Span::set_attribute(span, "test.index", @azimuth.telemetry.api.common.IntValue(i))
    test_spans = test_spans @ [span]
  }
  
  // ä½¿ç”¨ä¸åŒçš„å¯¼å‡ºå™¨å¯¼å‡ºSpan
  for span in test_spans {
    // å°è¯•ä½¿ç”¨æ§åˆ¶å°å¯¼å‡ºå™¨
    @azimuth.telemetry.sdk.exporter.console.ConsoleSpanExporter::export(console_exporter, span)
    
    // å°è¯•ä½¿ç”¨OTLPå¯¼å‡ºå™¨
    @azimuth.telemetry.sdk.exporter.otlp_http.OtlpHttpSpanExporter::export(otlp_exporter, span)
  }
  
  // ç»“æŸæ‰€æœ‰Span
  for span in test_spans {
    @azimuth.telemetry.api.trace.Span::end(span)
  }
  
  // æµ‹è¯•æ‰¹é‡å¯¼å‡º
  @azimuth.telemetry.sdk.exporter.console.ConsoleSpanExporter::export_batch(console_exporter, test_spans)
  @azimuth.telemetry.sdk.exporter.otlp_http.OtlpHttpSpanExporter::export_batch(otlp_exporter, test_spans)
}

test "ä¸Šä¸‹æ–‡ä¼ æ’­é”™è¯¯æ¢å¤æµ‹è¯•" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡ä¼ æ’­åœ¨é”™è¯¯æƒ…å†µä¸‹çš„æ¢å¤èƒ½åŠ›
  
  let composite = @azimuth.telemetry.api.propagation.CompositePropagator::new([
    @azimuth.telemetry.api.propagation.W3CTraceContextPropagator::new(),
    @azimuth.telemetry.api.propagation.W3CBaggagePropagator::new()
  ])
  
  // æµ‹è¯•æŸåçš„traceparentæ ¼å¼
  let malformed_headers = [
    "",
    "invalid-format",
    "00-0af7651916cd43dd8448eb211c80319c",  // ç¼ºå°‘span IDå’Œflags
    "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331",  // ç¼ºå°‘flags
    "XX-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01",  // æ— æ•ˆç‰ˆæœ¬
    "00-invalid_trace_id-b7ad6b7169203331-01",  // æ— æ•ˆtrace ID
    "00-0af7651916cd43dd8448eb211c80319c-invalid_span_id-01",  // æ— æ•ˆspan ID
    "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-XY"  // æ— æ•ˆflags
  ]
  
  for malformed_header in malformed_headers {
    let carrier = @azimuth.telemetry.api.propagation.TextMapCarrier::new()
    @azimuth.telemetry.api.propagation.TextMapCarrier::set(carrier, "traceparent", malformed_header)
    
    // å³ä½¿æ ¼å¼é”™è¯¯ï¼Œä¹Ÿä¸åº”è¯¥å´©æºƒ
    let extracted_ctx = @azimuth.telemetry.api.propagation.CompositePropagator::extract(composite, carrier)
    assert_true(extracted_ctx != @azimuth.telemetry.api.context.Context::{})
  }
  
  // æµ‹è¯•è¶…é•¿çš„baggageå€¼
  let long_baggage_carrier = @azimuth.telemetry.api.propagation.TextMapCarrier::new()
  let long_baggage_value = "key=" + "value".repeat(10000)
  @azimuth.telemetry.api.propagation.TextMapCarrier::set(long_baggage_carrier, "baggage", long_baggage_value)
  
  let long_extracted_ctx = @azimuth.telemetry.api.propagation.CompositePropagator::extract(composite, long_baggage_carrier)
  assert_true(long_extracted_ctx != @azimuth.telemetry.api.context.Context::{})
  
  // æµ‹è¯•æ­£å¸¸æ“ä½œçš„æ¢å¤
  let normal_carrier = @azimuth.telemetry.api.propagation.TextMapCarrier::new()
  let ctx = @azimuth.telemetry.api.context.Context::root()
  
  @azimuth.telemetry.api.propagation.CompositePropagator::inject(composite, ctx, normal_carrier)
  
  let normal_traceparent = @azimuth.telemetry.api.propagation.TextMapCarrier::get(normal_carrier, "traceparent")
  assert_true(normal_traceparent != None)
  assert_true(normal_traceparent.unwrap().starts_with("00-"))
  
  let normal_extracted_ctx = @azimuth.telemetry.api.propagation.CompositePropagator::extract(composite, normal_carrier)
  assert_true(normal_extracted_ctx != @azimuth.telemetry.api.context.Context::{})
}

test "å±æ€§å¤„ç†é”™è¯¯æ¢å¤æµ‹è¯•" {
  // æµ‹è¯•å±æ€§å¤„ç†åœ¨é”™è¯¯æƒ…å†µä¸‹çš„æ¢å¤èƒ½åŠ›
  
  let attrs = @azimuth.telemetry.api.common.Attributes::new()
  
  // æµ‹è¯•æç«¯å±æ€§å€¼
  let extreme_values = [
    ("empty.string", @azimuth.telemetry.api.common.StringValue("")),
    ("very.long.string", @azimuth.telemetry.api.common.StringValue("x".repeat(10000))),
    ("special.chars", @azimuth.telemetry.api.common.StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?")),
    ("unicode.chars", @azimuth.telemetry.api.common.StringValue("ğŸš€ æµ‹è¯• ğŸŒŸ")),
    ("newlines", @azimuth.telemetry.api.common.StringValue("line1\nline2\nline3")),
    ("tabs", @azimuth.telemetry.api.common.StringValue("col1\tcol2\tcol3")),
    ("null.chars", @azimuth.telemetry.api.common.StringValue("before\0after")),
    ("max.int", @azimuth.telemetry.api.common.IntValue(2147483647)),
    ("min.int", @azimuth.telemetry.api.common.IntValue(-2147483648)),
    ("infinity", @azimuth.telemetry.api.common.FloatValue(1.0/0.0)),
    ("neg.infinity", @azimuth.telemetry.api.common.FloatValue(-1.0/0.0)),
    ("nan", @azimuth.telemetry.api.common.FloatValue(0.0/0.0))
  ]
  
  for (key, value) in extreme_values {
    @azimuth.telemetry.api.common.Attributes::set(attrs, key, value)
  }
  
  // æµ‹è¯•æç«¯æ•°ç»„å€¼
  let extreme_arrays = [
    ("empty.string.array", @azimuth.telemetry.api.common.ArrayStringValue([])),
    ("large.string.array", @azimuth.telemetry.api.common.ArrayStringValue(["item"] * 1000)),
    ("empty.int.array", @azimuth.telemetry.api.common.ArrayIntValue([])),
    ("large.int.array", @azimuth.telemetry.api.common.ArrayIntValue([1] * 1000)),
    ("mixed.string.array", @azimuth.telemetry.api.common.ArrayStringValue(["", "normal", "special!@#", "ğŸš€", "x".repeat(100)])),
    ("extreme.int.array", @azimuth.telemetry.api.common.ArrayIntValue([-2147483648, -1, 0, 1, 2147483647]))
  ]
  
  for (key, value) in extreme_arrays {
    @azimuth.telemetry.api.common.Attributes::set(attrs, key, value)
  }
  
  // éªŒè¯å±æ€§è®¾ç½®ä¸ä¼šå¯¼è‡´å´©æºƒ
  assert_true(attrs != @azimuth.telemetry.api.common.Attributes::{})
  
  // æµ‹è¯•å±æ€§è·å–çš„å®¹é”™æ€§
  for (key, _) in extreme_values {
    let value = @azimuth.telemetry.api.common.Attributes::get(attrs, key)
    // ç®€åŒ–å®ç°å¯èƒ½è¿”å›Noneï¼Œä½†ä¸åº”è¯¥å´©æºƒ
  }
  
  for (key, _) in extreme_arrays {
    let value = @azimuth.telemetry.api.common.Attributes::get(attrs, key)
    // ç®€åŒ–å®ç°å¯èƒ½è¿”å›Noneï¼Œä½†ä¸åº”è¯¥å´©æºƒ
  }
  
  // æµ‹è¯•åœ¨Spanä¸­ä½¿ç”¨æç«¯å±æ€§
  let trace_provider = @azimuth.telemetry.sdk.trace.TracerProvider::default()
  let tracer = @azimuth.telemetry.sdk.trace.TracerProvider::get_tracer(trace_provider, "attribute.fault.test")
  
  let (_, span) = @azimuth.telemetry.sdk.trace.Tracer::start_span(tracer, "attribute.fault.span")
  
  // åœ¨Spanä¸­è®¾ç½®æç«¯å±æ€§
  for (key, value) in extreme_values {
    @azimuth.telemetry.api.trace.Span::set_attribute(span, key, value)
  }
  
  // æ·»åŠ å¸¦æœ‰æç«¯å±æ€§çš„äº‹ä»¶
  let event_attrs = @azimuth.telemetry.api.common.Attributes::new()
  for (key, value) in extreme_values {
    @azimuth.telemetry.api.common.Attributes::set(event_attrs, "event." + key, value)
  }
  
  @azimuth.telemetry.api.trace.Span::add_event(span, "fault.tolerance.event", Some(event_attrs), None)
  
  // è®°å½•å¼‚å¸¸
  @azimuth.telemetry.api.trace.Span::record_exception(
    span,
    "æµ‹è¯•å¼‚å¸¸å¤„ç†",
    Some("FaultToleranceTestException"),
    Some("at fault.tolerance.test()\n  at main()"),
    Some(event_attrs)
  )
  
  // ç»“æŸSpan
  @azimuth.telemetry.api.trace.Span::end(span)
  
  // éªŒè¯Spanæ­£å¸¸ç»“æŸ
  assert_false(@azimuth.telemetry.api.trace.Span::is_recording(span))
}

test "æ—¥å¿—ç³»ç»Ÿé”™è¯¯æ¢å¤æµ‹è¯•" {
  // æµ‹è¯•æ—¥å¿—ç³»ç»Ÿåœ¨é”™è¯¯æƒ…å†µä¸‹çš„æ¢å¤èƒ½åŠ›
  
  let logs_provider = @azimuth.telemetry.sdk.logs.LoggerProvider::default()
  let logger = @azimuth.telemetry.sdk.logs.LoggerProvider::get_logger(logs_provider, "error.recovery.logger")
  
  // æµ‹è¯•æç«¯æ—¥å¿—æ¶ˆæ¯
  let extreme_log_messages = [
    "",
    "x".repeat(10000),
    "Special chars: !@#$%^&*()_+-=[]{}|;':\",./<>?",
    "Unicode: ğŸš€ æµ‹è¯• ğŸŒŸ",
    "Newlines: \n\n\n",
    "Tabs: \t\t\t",
    "Null chars: \0\0\0",
    "Mixed: normal\n\t\0special!@#ğŸš€"
  ]
  
  for message in extreme_log_messages {
    let log_record = @azimuth.telemetry.api.logs.LogRecord::new(
      @azimuth.telemetry.api.logs.Info,
      message,
      None,
      None,
      None,
      None,
      None,
      None
    )
    
    // å³ä½¿æ¶ˆæ¯æç«¯ï¼Œä¹Ÿåº”è¯¥èƒ½æ­£å¸¸è®°å½•
    @azimuth.telemetry.sdk.logs.Logger::emit(logger, log_record)
  }
  
  // æµ‹è¯•å¸¦æœ‰æç«¯å±æ€§çš„æ—¥å¿—
  let extreme_attrs = @azimuth.telemetry.api.common.Attributes::new()
  for i in 0..50 {
    let key = "extreme.attr." + i.to_string()
    let value = @azimuth.telemetry.api.common.StringValue("x".repeat(100))
    @azimuth.telemetry.api.common.Attributes::set(extreme_attrs, key, value)
  }
  
  let extreme_log = @azimuth.telemetry.api.logs.LogRecord::new(
    @azimuth.telemetry.api.logs.Error,
    "Log with extreme attributes",
    Some(extreme_attrs),
    Some(@azimuth.telemetry.sdk.platform.time.Clock::now_unix_nanos(@azimuth.telemetry.sdk.platform.time.Clock::system())),
    None,
    Some("extreme_trace_123"),
    Some("extreme_span_456"),
    None
  )
  
  @azimuth.telemetry.sdk.logs.Logger::emit(logger, extreme_log)
  
  // æµ‹è¯•æ‰€æœ‰ä¸¥é‡ç¨‹åº¦çš„æ—¥å¿—
  let severity_levels = [
    @azimuth.telemetry.api.logs.Trace,
    @azimuth.telemetry.api.logs.Debug,
    @azimuth.telemetry.api.logs.Info,
    @azimuth.telemetry.api.logs.Warn,
    @azimuth.telemetry.api.logs.Error,
    @azimuth.telemetry.api.logs.Fatal
  ]
  
  for severity in severity_levels {
    let severity_log = @azimuth.telemetry.api.logs.LogRecord::new(
      severity,
      "Severity test: " + severity.to_string(),
      None,
      None,
      None,
      None,
      None,
      None
    )
    
    @azimuth.telemetry.sdk.logs.Logger::emit(logger, severity_log)
  }
  
  // éªŒè¯æ—¥å¿—ç³»ç»Ÿä»ç„¶æ­£å¸¸å·¥ä½œ
  let normal_log = @azimuth.telemetry.api.logs.LogRecord::new(
    @azimuth.telemetry.api.logs.Info,
    "Normal log after extreme tests",
    None,
    None,
    None,
    None,
    None,
    None
  )
  
  @azimuth.telemetry.sdk.logs.Logger::emit(logger, normal_log)
}
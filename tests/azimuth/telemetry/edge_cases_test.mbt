// è¾¹ç•Œæƒ…å†µæµ‹è¯•
// Edge cases tests for Azimuth telemetry system

test "ç©ºå€¼å’Œè¾¹ç•Œå€¼æµ‹è¯•" {
  // æµ‹è¯•ç©ºå€¼å’Œè¾¹ç•Œå€¼çš„å¤„ç†
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²å±æ€§
  let attrs = @azimuth.telemetry.api.common.Attributes.new()
  @azimuth.telemetry.api.common.Attributes.set(attrs, "empty.value", @azimuth.telemetry.api.common.StringValue(""))
  
  let empty_value = @azimuth.telemetry.api.common.Attributes.get(attrs, "empty.value")
  assert_eq(empty_value, Some(@azimuth.telemetry.api.common.StringValue("")))
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„å±æ€§
  let non_existent = @azimuth.telemetry.api.common.Attributes.get(attrs, "non.existent")
  assert_eq(non_existent, None)
  
  // æµ‹è¯•è¾¹ç•Œæ•°å€¼
  @azimuth.telemetry.api.common.Attributes.set(attrs, "max.int", @azimuth.telemetry.api.common.IntValue(2147483647))
  @azimuth.telemetry.api.common.Attributes.set(attrs, "min.int", @azimuth.telemetry.api.common.IntValue(-2147483648))
  @azimuth.telemetry.api.common.Attributes.set(attrs, "zero.float", @azimuth.telemetry.api.common.FloatValue(0.0))
  
  let max_int = @azimuth.telemetry.api.common.Attributes.get(attrs, "max.int")
  let min_int = @azimuth.telemetry.api.common.Attributes.get(attrs, "min.int")
  let zero_float = @azimuth.telemetry.api.common.Attributes.get(attrs, "zero.float")
  
  assert_eq(max_int, Some(@azimuth.telemetry.api.common.IntValue(2147483647)))
  assert_eq(min_int, Some(@azimuth.telemetry.api.common.IntValue(-2147483648)))
  assert_eq(zero_float, Some(@azimuth.telemetry.api.common.FloatValue(0.0)))
}

test "Spanè¾¹ç•Œæƒ…å†µæµ‹è¯•" {
  // æµ‹è¯•Spançš„è¾¹ç•Œæƒ…å†µ
  
  let trace_provider = @azimuth.telemetry.sdk.trace.TracerProvider.default()
  let tracer = @azimuth.telemetry.sdk.trace.TracerProvider.get_tracer(trace_provider, "edge.test.tracer")
  
  // æµ‹è¯•æ— æ•ˆçš„SpanContext
  let invalid_ctx = @azimuth.telemetry.api.trace.SpanContext.new("", "", false, "")
  assert_false(@azimuth.telemetry.api.trace.SpanContext.is_valid(invalid_ctx))
  
  // æµ‹è¯•æœ‰æ•ˆçš„SpanContext
  let valid_ctx = @azimuth.telemetry.api.trace.SpanContext.new("trace123", "span456", true, "")
  assert_true(@azimuth.telemetry.api.trace.SpanContext.is_valid(valid_ctx))
  
  // åˆ›å»ºspanå¹¶æµ‹è¯•è¾¹ç•Œæ“ä½œ
  let ctx = @azimuth.telemetry.api.context.Context.root()
  let (_, span) = @azimuth.telemetry.sdk.trace.Tracer.start_span(tracer, ctx, "edge.test.span")
  
  // è®¾ç½®ç©ºå±æ€§å
  @azimuth.telemetry.api.trace.Span.set_attribute(span, "", @azimuth.telemetry.api.common.StringValue("empty"))
  
  // æ·»åŠ ç©ºäº‹ä»¶å
  @azimuth.telemetry.api.trace.Span.add_event(span, "", None, None)
  
  // ç»“æŸspan
  @azimuth.telemetry.api.trace.Span.end(span)
  
  // éªŒè¯spanå·²ç»“æŸ
  assert_false(@azimuth.telemetry.api.trace.Span.is_recording(span))
}

test "æŒ‡æ ‡è¾¹ç•Œæƒ…å†µæµ‹è¯•" {
  // æµ‹è¯•æŒ‡æ ‡çš„è¾¹ç•Œæƒ…å†µ
  
  let meter_provider = @azimuth.telemetry.sdk.metrics.MeterProvider.default()
  let meter = @azimuth.telemetry.sdk.metrics.MeterProvider.get_meter(meter_provider, "edge.test.meter")
  
  // åˆ›å»ºå„ç§æŒ‡æ ‡
  let counter = @azimuth.telemetry.sdk.metrics.Meter.create_counter(meter, "edge.counter")
  let histogram = @azimuth.telemetry.sdk.metrics.Meter.create_histogram(meter, "edge.histogram")
  let gauge = @azimuth.telemetry.sdk.metrics.Meter.create_gauge(meter, "edge.gauge")
  let up_down_counter = @azimuth.telemetry.sdk.metrics.Meter.create_up_down_counter(meter, "edge.up_down_counter")
  
  // æµ‹è¯•è¾¹ç•Œå€¼
  @azimuth.telemetry.sdk.metrics.Counter.add(counter, 0.0)
  @azimuth.telemetry.sdk.metrics.Counter.add(counter, 999999.999)
  
  @azimuth.telemetry.sdk.metrics.Histogram.record(histogram, 0.0)
  @azimuth.telemetry.sdk.metrics.Histogram.record(histogram, 999999999.0)
  
  @azimuth.telemetry.sdk.metrics.Gauge.record(gauge, -100.0)
  @azimuth.telemetry.sdk.metrics.Gauge.record(gauge, 0.0)
  @azimuth.telemetry.sdk.metrics.Gauge.record(gauge, 100.0)
  
  @azimuth.telemetry.sdk.metrics.UpDownCounter.add(up_down_counter, -1000.0)
  @azimuth.telemetry.sdk.metrics.UpDownCounter.add(up_down_counter, 0.0)
  @azimuth.telemetry.sdk.metrics.UpDownCounter.add(up_down_counter, 1000.0)
}

test "æ—¥å¿—è¾¹ç•Œæƒ…å†µæµ‹è¯•" {
  // æµ‹è¯•æ—¥å¿—çš„è¾¹ç•Œæƒ…å†µ
  
  let logger_provider = @azimuth.telemetry.sdk.logs.LoggerProvider.default()
  let logger = @azimuth.telemetry.sdk.logs.LoggerProvider.get_logger(logger_provider, "edge.test.logger")
  
  // æµ‹è¯•ç©ºæ¶ˆæ¯
  @azimuth.telemetry.sdk.logs.Logger.info(logger, "")
  
  // æµ‹è¯•é•¿æ¶ˆæ¯
  let long_message = "x".repeat(1000)
  @azimuth.telemetry.sdk.logs.Logger.info(logger, long_message)
  
  // æµ‹è¯•Unicodeæ¶ˆæ¯
  let unicode_message = "Unicodeæµ‹è¯•æ¶ˆæ¯ğŸš€ğŸŒŸ"
  @azimuth.telemetry.sdk.logs.Logger.info(logger, unicode_message)
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦æ¶ˆæ¯
  let special_message = "Special chars: !@#$%^&*()_+-=[]{}|;':\",./<>?"
  @azimuth.telemetry.sdk.logs.Logger.info(logger, special_message)
  
  // æµ‹è¯•ä¸åŒä¸¥é‡çº§åˆ«
  @azimuth.telemetry.sdk.logs.Logger.trace(logger, "Trace message")
  @azimuth.telemetry.sdk.logs.Logger.debug(logger, "Debug message")
  @azimuth.telemetry.sdk.logs.Logger.info(logger, "Info message")
  @azimuth.telemetry.sdk.logs.Logger.warn(logger, "Warning message")
  @azimuth.telemetry.sdk.logs.Logger.error(logger, "Error message")
  @azimuth.telemetry.sdk.logs.Logger.fatal(logger, "Fatal message")
}

test "ä¸Šä¸‹æ–‡è¾¹ç•Œæƒ…å†µæµ‹è¯•" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡çš„è¾¹ç•Œæƒ…å†µ
  
  // æµ‹è¯•æ ¹ä¸Šä¸‹æ–‡
  let root_ctx = @azimuth.telemetry.api.context.Context.root()
  assert_eq(root_ctx.data, None)
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡é”®
  let key1 = @azimuth.telemetry.api.context.ContextKey::new("test.key.1")
  let key2 = @azimuth.telemetry.api.context.ContextKey::new("test.key.2")
  
  // æµ‹è¯•ç©ºå€¼
  let ctx_with_empty = @azimuth.telemetry.api.context.Context.with_value(root_ctx, key1, "")
  let empty_value = @azimuth.telemetry.api.context.Context.get(ctx_with_empty, key1)
  assert_eq(empty_value, Some(""))
  
  // æµ‹è¯•é•¿å€¼
  let long_value = "x".repeat(1000)
  let ctx_with_long = @azimuth.telemetry.api.context.Context.with_value(root_ctx, key2, long_value)
  let retrieved_long = @azimuth.telemetry.api.context.Context.get(ctx_with_long, key2)
  assert_eq(retrieved_long, Some(long_value))
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„é”®
  let non_existent_key = @azimuth.telemetry.api.context.ContextKey::new("non.existent")
  let non_existent_value = @azimuth.telemetry.api.context.Context.get(root_ctx, non_existent_key)
  assert_eq(non_existent_value, None)
}
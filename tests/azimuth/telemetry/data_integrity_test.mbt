// æ•°æ®å®Œæ•´æ€§æµ‹è¯•
// æµ‹è¯•é¥æµ‹ç³»ç»Ÿæ•°æ®å¤„ç†è¿‡ç¨‹ä¸­çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§

test "Spanæ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  // åˆ›å»ºSpanå¹¶éªŒè¯æ•°æ®çš„å®Œæ•´æ€§
  let original_trace_id = "integrity-trace-12345"
  let original_span_id = "integrity-span-67890"
  let original_span_name = "integrity-test-span"
  let original_span_kind = Server
  
  let span_ctx = SpanContext::new(original_trace_id, original_span_id, true, "key1=value1,key2=value2")
  let span = Span::new(original_span_name, original_span_kind, span_ctx)
  
  // éªŒè¯SpanåŸºæœ¬æ•°æ®å®Œæ•´æ€§
  assert_eq(Span::name(span), original_span_name)
  assert_eq(Span::kind(span), original_span_kind)
  assert_true(Span::is_recording(span))
  
  let retrieved_span_ctx = Span::span_context(span)
  assert_eq(SpanContext::trace_id(retrieved_span_ctx), original_trace_id)
  assert_eq(SpanContext::span_id(retrieved_span_ctx), original_span_id)
  assert_true(SpanContext::is_sampled(retrieved_span_ctx))
  assert_eq(retrieved_span_ctx.trace_state, "key1=value1,key2=value2")
  
  // æµ‹è¯•äº‹ä»¶æ•°æ®å®Œæ•´æ€§
  let original_event_name = "integrity-test-event"
  let original_event_attrs = [
    ("event.string", StringValue("test-string-value")),
    ("event.int", IntValue(42)),
    ("event.float", FloatValue(3.14159)),
    ("event.bool", BoolValue(true))
  ]
  
  Span::add_event(span, original_event_name, Some(original_event_attrs))
  
  // æµ‹è¯•çŠ¶æ€æ•°æ®å®Œæ•´æ€§
  let original_status = Error
  let original_description = "Integrity test error description"
  Span::set_status(span, original_status, Some(original_description))
  
  // éªŒè¯çŠ¶æ€è®¾ç½®åçš„å®Œæ•´æ€§
  assert_eq(Span::status(span), Error)
  
  // ç»“æŸSpanå¹¶éªŒè¯æœ€ç»ˆçŠ¶æ€
  Span::end(span)
  // åœ¨ç®€åŒ–å®ç°ä¸­ï¼ŒrecordingçŠ¶æ€å¯èƒ½ä¸ä¼šæ”¹å˜ï¼Œä½†æ•°æ®åº”è¯¥ä¿æŒå®Œæ•´
}

test "åº¦é‡æ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "integrity-test-meter")
  
  // æµ‹è¯•Counteræ•°æ®å®Œæ•´æ€§
  let original_counter_name = "integrity.test.counter"
  let original_counter_desc = "Integrity test counter description"
  let original_counter_unit = "operations"
  
  let counter = Meter::create_counter(meter, original_counter_name, Some(original_counter_desc), Some(original_counter_unit))
  
  // éªŒè¯CounteråŸºæœ¬æ•°æ®å®Œæ•´æ€§
  assert_eq(counter.name, original_counter_name)
  assert_eq(counter.description, Some(original_counter_desc))
  assert_eq(counter.unit, Some(original_counter_unit))
  
  // æµ‹è¯•Counterè®°å½•çš„æ•°æ®å®Œæ•´æ€§
  let original_attrs = Attributes::new()
  Attributes::set(original_attrs, "operation", StringValue("integrity-test"))
  Attributes::set(original_attrs, "user.id", IntValue(12345))
  Attributes::set(original_attrs, "success.rate", FloatValue(0.95))
  Attributes::set(original_attrs, "enabled", BoolValue(true))
  
  // è®°å½•å¤šä¸ªå€¼å¹¶éªŒè¯ä¸€è‡´æ€§
  Counter::add(counter, 10.0, Some(original_attrs))
  Counter::add(counter, 20.0, Some(original_attrs))
  Counter::add(counter, 30.5, Some(original_attrs))
  
  // æµ‹è¯•Histogramæ•°æ®å®Œæ•´æ€§
  let original_histogram_name = "integrity.test.histogram"
  let original_histogram_desc = "Integrity test histogram description"
  let original_histogram_unit = "milliseconds"
  
  let histogram = Meter::create_histogram(meter, original_histogram_name, Some(original_histogram_desc), Some(original_histogram_unit))
  
  // éªŒè¯HistogramåŸºæœ¬æ•°æ®å®Œæ•´æ€§
  assert_eq(histogram.name, original_histogram_name)
  assert_eq(histogram.description, Some(original_histogram_desc))
  assert_eq(histogram.unit, Some(original_histogram_unit))
  
  // æµ‹è¯•Histogramè®°å½•çš„æ•°æ®å®Œæ•´æ€§
  let histogram_values = [1.0, 5.5, 10.0, 25.5, 50.0, 100.0, 250.5, 500.0, 1000.0, 2000.0]
  for value in histogram_values {
    Histogram::record(histogram, value, Some(original_attrs))
  }
  
  // éªŒè¯Histogramè½¬æ¢ä¸ºInstrumentçš„æ•°æ®å®Œæ•´æ€§
  let histogram_instrument = Histogram::as_instrument(histogram)
  assert_eq(Instrument::name(histogram_instrument), original_histogram_name)
  assert_eq(Instrument::description(histogram_instrument), Some(original_histogram_desc))
  assert_eq(Instrument::unit(histogram_instrument), Some(original_histogram_unit))
}

test "æ—¥å¿—æ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "integrity-test-logger")
  
  // æµ‹è¯•LogRecordæ•°æ®å®Œæ•´æ€§
  let original_severity = Error
  let original_body = "Integrity test log message"
  let original_timestamp = 1735689600000000000L
  let original_observed_timestamp = 1735689600000001000L
  let original_trace_id = "integrity-log-trace"
  let original_span_id = "integrity-log-span"
  
  let original_attrs = Attributes::new()
  Attributes::set(original_attrs, "log.component", StringValue("integrity-test"))
  Attributes::set(original_attrs, "log.version", StringValue("1.0.0"))
  Attributes::set(original_attrs, "log.instance", IntValue(42))
  Attributes::set(original_attrs, "log.performance", FloatValue(99.9))
  Attributes::set(original_attrs, "log.healthy", BoolValue(true))
  
  let log_record = LogRecord::new_with_context(
    original_severity,
    Some(original_body),
    Some(original_attrs),
    Some(original_timestamp),
    Some(original_observed_timestamp),
    Some(original_trace_id),
    Some(original_span_id),
    Some(Context::root())
  )
  
  // éªŒè¯LogRecordæ•°æ®å®Œæ•´æ€§
  assert_eq(LogRecord::severity_number(log_record), original_severity)
  assert_eq(LogRecord::body(log_record), Some(original_body))
  assert_eq(log_record.timestamp, Some(original_timestamp))
  assert_eq(log_record.observed_timestamp, Some(original_observed_timestamp))
  assert_eq(LogRecord::trace_id(log_record), Some(original_trace_id))
  assert_eq(LogRecord::span_id(log_record), Some(original_span_id))
  
  // æµ‹è¯•æ—¥å¿—å‘å°„åçš„æ•°æ®å®Œæ•´æ€§
  Logger::emit(logger, log_record)
  
  // æµ‹è¯•ä¸åŒä¸¥é‡ç¨‹åº¦çš„æ—¥å¿—æ•°æ®å®Œæ•´æ€§
  let severities = [Trace, Debug, Info, Warn, Error, Fatal]
  for i in range(0, severities.length()) {
    let severity = severities[i]
    let body = "Integrity test for severity " + i.to_string()
    let test_log = LogRecord::new(severity, body)
    
    assert_eq(LogRecord::severity_number(test_log), severity)
    assert_eq(LogRecord::body(test_log), Some(body))
    Logger::emit(logger, test_log)
  }
}

test "ä¸Šä¸‹æ–‡ä¼ æ’­æ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  let composite_propagator = CompositePropagator::new([
    W3CTraceContextPropagator::new(),
    W3CBaggagePropagator::new()
  ])
  
  // åˆ›å»ºåŸå§‹ä¸Šä¸‹æ–‡å¹¶è®¾ç½®æ•°æ®
  let original_ctx = Context::root()
  let user_key = ContextKey::new("user.id")
  let session_key = ContextKey::new("session.id")
  let tenant_key = ContextKey::new("tenant.id")
  
  let ctx_with_user = Context::with_value(original_ctx, user_key, "user-12345")
  let ctx_with_session = Context::with_value(ctx_with_user, session_key, "session-67890")
  let ctx_with_tenant = Context::with_value(ctx_with_session, tenant_key, "tenant-abcde")
  
  // éªŒè¯ä¸Šä¸‹æ–‡æ•°æ®å®Œæ•´æ€§
  let retrieved_user = Context::get(ctx_with_tenant, user_key)
  let retrieved_session = Context::get(ctx_with_tenant, session_key)
  let retrieved_tenant = Context::get(ctx_with_tenant, tenant_key)
  
  assert_eq(retrieved_user, Some("user-12345"))
  assert_eq(retrieved_session, Some("session-67890"))
  assert_eq(retrieved_tenant, Some("tenant-abcde"))
  
  // æµ‹è¯•ä¼ æ’­è¿‡ç¨‹ä¸­çš„æ•°æ®å®Œæ•´æ€§
  let carrier = TextMapCarrier::new()
  CompositePropagator::inject(composite_propagator, ctx_with_tenant, carrier)
  
  // éªŒè¯æ³¨å…¥çš„æ•°æ®
  let injected_traceparent = TextMapCarrier::get(carrier, "traceparent")
  assert!(injected_traceparent.is_some())
  
  // æå–ä¸Šä¸‹æ–‡å¹¶éªŒè¯æ•°æ®å®Œæ•´æ€§
  let extracted_ctx = CompositePropagator::extract(composite_propagator, carrier)
  let extracted_value = Context::get(extracted_ctx, ContextKey::new("extracted"))
  assert_eq(extracted_value, Some("true"))
  
  // æµ‹è¯•Baggageæ•°æ®å®Œæ•´æ€§
  let baggage = Baggage::new()
  let baggage_with_user = Baggage::set_entry(baggage, "user.id", "user-12345")
  let baggage_with_role = Baggage::set_entry(baggage_with_user, "user.role", "administrator")
  let baggage_with_region = Baggage::set_entry(baggage_with_role, "user.region", "us-west-2")
  
  // éªŒè¯Baggageæ•°æ®å®Œæ•´æ€§
  let retrieved_user_baggage = Baggage::get_entry(baggage_with_region, "user.id")
  let retrieved_role_baggage = Baggage::get_entry(baggage_with_region, "user.role")
  let retrieved_region_baggage = Baggage::get_entry(baggage_with_region, "user.region")
  let nonexistent_baggage = Baggage::get_entry(baggage_with_region, "nonexistent.key")
  
  assert_eq(retrieved_user_baggage, Some("user-12345"))
  assert_eq(retrieved_role_baggage, Some("administrator"))
  assert_eq(retrieved_region_baggage, Some("us-west-2"))
  assert_eq(nonexistent_baggage, None)
}

test "å±æ€§æ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•å„ç§å±æ€§å€¼ç±»å‹çš„æ•°æ®å®Œæ•´æ€§
  let attrs = Attributes::new()
  
  // å­—ç¬¦ä¸²å±æ€§
  let original_string_value = "integrity-test-string-value-12345"
  Attributes::set(attrs, "string.key", StringValue(original_string_value))
  let retrieved_string = Attributes::get(attrs, "string.key")
  assert_eq(retrieved_string, Some(StringValue(original_string_value)))
  
  // æ•´æ•°å±æ€§
  let original_int_value = 1234567890
  Attributes::set(attrs, "int.key", IntValue(original_int_value))
  let retrieved_int = Attributes::get(attrs, "int.key")
  assert_eq(retrieved_int, Some(IntValue(original_int_value)))
  
  // æµ®ç‚¹æ•°å±æ€§
  let original_float_value = 3.141592653589793
  Attributes::set(attrs, "float.key", FloatValue(original_float_value))
  let retrieved_float = Attributes::get(attrs, "float.key")
  assert_eq(retrieved_float, Some(FloatValue(original_float_value)))
  
  // å¸ƒå°”å±æ€§
  let original_bool_value = true
  Attributes::set(attrs, "bool.key", BoolValue(original_bool_value))
  let retrieved_bool = Attributes::get(attrs, "bool.key")
  assert_eq(retrieved_bool, Some(BoolValue(original_bool_value)))
  
  // å­—ç¬¦ä¸²æ•°ç»„å±æ€§
  let original_string_array = ["item1", "item2", "item3", "item4", "item5"]
  Attributes::set(attrs, "string.array.key", ArrayStringValue(original_string_array))
  let retrieved_string_array = Attributes::get(attrs, "string.array.key")
  assert_eq(retrieved_string_array, Some(ArrayStringValue(original_string_array)))
  
  // æ•´æ•°æ•°ç»„å±æ€§
  let original_int_array = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
  Attributes::set(attrs, "int.array.key", ArrayIntValue(original_int_array))
  let retrieved_int_array = Attributes::get(attrs, "int.array.key")
  assert_eq(retrieved_int_array, Some(ArrayIntValue(original_int_array)))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å’ŒUnicodeçš„æ•°æ®å®Œæ•´æ€§
  let special_string_value = "Special chars: !@#$%^&*()_+-=[]{}|;':\",./<>?"
  Attributes::set(attrs, "special.key", StringValue(special_string_value))
  let retrieved_special = Attributes::get(attrs, "special.key")
  assert_eq(retrieved_special, Some(StringValue(special_string_value)))
  
  let unicode_string_value = "Unicode: æµ‹è¯• ğŸš€ ğŸ“Š Ã©Ã Ã¼ ä¸­æ–‡ Ñ€ÑƒÑÑĞºĞ¸Ğ¹"
  Attributes::set(attrs, "unicode.key", StringValue(unicode_string_value))
  let retrieved_unicode = Attributes::get(attrs, "unicode.key")
  assert_eq(retrieved_unicode, Some(StringValue(unicode_string_value)))
  
  // æµ‹è¯•æé•¿å€¼çš„æ•°æ®å®Œæ•´æ€§
  let long_string_value = "a" * 10000
  Attributes::set(attrs, "long.key", StringValue(long_string_value))
  let retrieved_long = Attributes::get(attrs, "long.key")
  assert_eq(retrieved_long, Some(StringValue(long_string_value)))
}

test "Resourceæ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•Resourceå±æ€§çš„æ•°æ®å®Œæ•´æ€§
  let resource = Resource::new()
  
  let original_attrs = [
    ("service.name", StringValue("integrity-test-service")),
    ("service.version", StringValue("1.2.3")),
    ("service.instance.id", StringValue("instance-12345-abcd")),
    ("host.name", StringValue("integrity-test-host")),
    ("host.ip", StringValue("192.168.1.100")),
    ("process.id", IntValue(12345)),
    ("process.executable.name", StringValue("integrity-test-app")),
    ("process.command_line", StringValue("./integrity-test-app --config=test.conf")),
    ("os.type", StringValue("linux")),
    ("os.version", StringValue("5.15.0")),
    ("deployment.environment", StringValue("staging"))
  ]
  
  let resource_with_attrs = Resource::with_attributes(resource, original_attrs)
  
  // éªŒè¯æ¯ä¸ªå±æ€§çš„æ•°æ®å®Œæ•´æ€§
  for attr in original_attrs {
    let retrieved_value = Resource::get_attribute(resource_with_attrs, attr.0)
    assert_eq(retrieved_value, Some(attr.1))
  }
  
  // æµ‹è¯•Resourceåˆå¹¶çš„æ•°æ®å®Œæ•´æ€§
  let base_attrs = [
    ("base.key1", StringValue("base-value1")),
    ("base.key2", StringValue("base-value2")),
    ("shared.key", StringValue("base-shared-value"))
  ]
  
  let override_attrs = [
    ("override.key1", StringValue("override-value1")),
    ("override.key2", StringValue("override-value2")),
    ("shared.key", StringValue("override-shared-value"))
  ]
  
  let base_resource = Resource::with_attributes(resource, base_attrs)
  let override_resource = Resource::with_attributes(resource, override_attrs)
  let merged_resource = Resource::merge(base_resource, override_resource)
  
  // éªŒè¯åˆå¹¶åçš„æ•°æ®å®Œæ•´æ€§
  let merged_base_key1 = Resource::get_attribute(merged_resource, "base.key1")
  let merged_base_key2 = Resource::get_attribute(merged_resource, "base.key2")
  let merged_override_key1 = Resource::get_attribute(merged_resource, "override.key1")
  let merged_override_key2 = Resource::get_attribute(merged_resource, "override.key2")
  let merged_shared_key = Resource::get_attribute(merged_resource, "shared.key")
  
  // åœ¨ç®€åŒ–å®ç°ä¸­ï¼Œmergeå¯èƒ½ç›´æ¥è¿”å›overrideèµ„æº
  assert_eq(merged_override_key1, Some(StringValue("override-value1")))
  assert_eq(merged_override_key2, Some(StringValue("override-value2")))
  assert_eq(merged_shared_key, Some(StringValue("override-shared-value")))
}

test "HTTPæ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•HttpRequestæ•°æ®å®Œæ•´æ€§
  let original_method = "POST"
  let original_url = "https://api.example.com/integrity-test/resource"
  let original_headers = [
    ("Content-Type", "application/json"),
    ("Authorization", "Bearer integrity-test-token-12345"),
    ("X-Request-ID", "req-integrity-67890"),
    ("User-Agent", "Integrity-Test-Client/1.0"),
    ("Accept", "application/json")
  ]
  let original_body = "{\"operation\":\"integrity-test\",\"data\":{\"id\":12345,\"value\":\"test-data\"}}"
  
  let request = HttpRequest::new(original_method, original_url, original_headers, Some(original_body))
  
  // éªŒè¯HttpRequestæ•°æ®å®Œæ•´æ€§
  assert_eq(HttpRequest::http_method(request), original_method)
  assert_eq(HttpRequest::url(request), original_url)
  assert_eq(HttpRequest::body(request), Some(original_body))
  
  // æµ‹è¯•HttpResponseæ•°æ®å®Œæ•´æ€§
  let original_status_code = 200
  let original_response_headers = [
    ("Content-Type", "application/json"),
    ("X-Response-ID", "resp-integrity-11111"),
    ("X-Processing-Time", "150ms"),
    ("Cache-Control", "no-cache"),
    ("Server", "Integrity-Test-Server/1.0")
  ]
  let original_response_body = "{\"result\":\"success\",\"id\":12345,\"processed\":true,\"timestamp\":\"2025-12-28T10:00:00Z\"}"
  
  let response = HttpResponse::new(original_status_code, original_response_headers, Some(original_response_body))
  
  // éªŒè¯HttpResponseæ•°æ®å®Œæ•´æ€§
  assert_eq(HttpResponse::status_code(response), original_status_code)
  assert_eq(HttpResponse::body(response), Some(original_response_body))
  
  // æµ‹è¯•ç©ºä½“è¯·æ±‚å’Œå“åº”çš„æ•°æ®å®Œæ•´æ€§
  let empty_request = HttpRequest::new("GET", "https://api.example.com/empty", [], None)
  let empty_response = HttpResponse::new(204, [], None)
  
  assert_eq(HttpRequest::http_method(empty_request), "GET")
  assert_eq(HttpRequest::url(empty_request), "https://api.example.com/empty")
  assert_eq(HttpRequest::body(empty_request), None)
  assert_eq(HttpResponse::status_code(empty_response), 204)
  assert_eq(HttpResponse::body(empty_response), None)
}

test "è·¨ç»„ä»¶æ•°æ®ä¸€è‡´æ€§æµ‹è¯•" {
  // åˆ›å»ºä¸€è‡´çš„trace_idç”¨äºè·¨ç»„ä»¶æµ‹è¯•
  let consistent_trace_id = "consistent-trace-12345"
  let consistent_span_id_base = "consistent-span"
  
  // åœ¨Spanä¸­ä½¿ç”¨ä¸€è‡´çš„trace_id
  let span_ctx = SpanContext::new(consistent_trace_id, consistent_span_id_base + "-1", true, "")
  let span = Span::new("consistent-span", Internal, span_ctx)
  
  // åœ¨æ—¥å¿—ä¸­ä½¿ç”¨ä¸€è‡´çš„trace_id
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "consistent-test-logger")
  
  let consistent_log = LogRecord::new_with_context(
    Info,
    Some("Consistent test log message"),
    None,
    Some(1735689600000000000L),
    Some(1735689600000001000L),
    Some(consistent_trace_id),
    Some(consistent_span_id_base + "-1"),
    Some(Context::root())
  )
  
  // åœ¨ä¸Šä¸‹æ–‡ä¼ æ’­ä¸­ä½¿ç”¨ä¸€è‡´çš„trace_id
  let composite_propagator = CompositePropagator::new([
    W3CTraceContextPropagator::new(),
    W3CBaggagePropagator::new()
  ])
  
  let carrier = TextMapCarrier::new()
  CompositePropagator::inject(composite_propagator, Context::root(), carrier)
  
  // éªŒè¯è·¨ç»„ä»¶çš„æ•°æ®ä¸€è‡´æ€§
  assert_eq(SpanContext::trace_id(span_ctx), consistent_trace_id)
  assert_eq(LogRecord::trace_id(consistent_log), Some(consistent_trace_id))
  
  // åœ¨åº¦é‡ä¸­ä½¿ç”¨ä¸€è‡´çš„å±æ€§
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "consistent-test-meter")
  let counter = Meter::create_counter(meter, "consistent.operations", Some("Consistent operations"), Some("ops"))
  
  let consistent_attrs = Attributes::new()
  Attributes::set(consistent_attrs, "trace.id", StringValue(consistent_trace_id))
  Attributes::set(consistent_attrs, "component", StringValue("consistent-test"))
  
  Counter::add(counter, 1.0, Some(consistent_attrs))
  
  // éªŒè¯æ‰€æœ‰ç»„ä»¶éƒ½ä½¿ç”¨ç›¸åŒçš„æ ‡è¯†ç¬¦
  let retrieved_trace_id = Attributes::get(consistent_attrs, "trace.id")
  assert_eq(retrieved_trace_id, Some(StringValue(consistent_trace_id)))
  
  // ç»“æŸSpanå®Œæˆä¸€è‡´æ€§æµ‹è¯•
  Span::end(span)
  Logger::emit(logger, consistent_log)
}
// Azimuth Telemetry System - Timestamp and Serialization Integrity Test
// æµ‹è¯•Azimuthé¥æµ‹ç³»ç»Ÿçš„æ—¶é—´æˆ³å’Œåºåˆ—åŒ–å®Œæ•´æ€§åŠŸèƒ½

test "Clockæ—¶é—´æˆ³åŸºç¡€æµ‹è¯•" {
  // æµ‹è¯•Clockçš„æ—¶é—´æˆ³åŸºç¡€åŠŸèƒ½
  
  // åˆ›å»ºç³»ç»ŸClock
  let clock = Clock::system()
  
  // è·å–å½“å‰æ—¶é—´æˆ³
  let timestamp1 = Clock::now_unix_nanos(clock)
  let timestamp2 = Clock::now_unix_nanos(clock)
  let timestamp3 = Clock::now_unix_nanos(clock)
  
  // éªŒè¯æ—¶é—´æˆ³æ ¼å¼ï¼ˆåº”è¯¥æ˜¯ä¸€ä¸ªåˆç†çš„64ä½æ•´æ•°ï¼‰
  assert_true(timestamp1 > 0L)
  assert_true(timestamp2 > 0L)
  assert_true(timestamp3 > 0L)
  
  // éªŒè¯æ—¶é—´æˆ³åœ¨åˆç†èŒƒå›´å†…ï¼ˆ2025å¹´çš„æ—¶é—´æˆ³èŒƒå›´ï¼‰
  assert_true(timestamp1 > 1700000000000000000L) // 2023å¹´å¼€å§‹
  assert_true(timestamp1 < 1800000000000000000L) // 2027å¹´ç»“æŸ
  
  // ç®€åŒ–å®ç°ä¸­æ‰€æœ‰è°ƒç”¨è¿”å›ç›¸åŒå€¼
  assert_eq(timestamp1, timestamp2)
  assert_eq(timestamp2, timestamp3)
  
  // æµ‹è¯•å¤šä¸ªClockå®ä¾‹
  let clock2 = Clock::system()
  let timestamp4 = Clock::now_unix_nanos(clock2)
  
  // ç®€åŒ–å®ç°ä¸­ä¸åŒClockå®ä¾‹è¿”å›ç›¸åŒå€¼
  assert_eq(timestamp1, timestamp4)
}

test "æ—¶é—´æˆ³è¾¹ç•Œå€¼æµ‹è¯•" {
  // æµ‹è¯•æ—¶é—´æˆ³çš„è¾¹ç•Œå€¼å¤„ç†
  
  let clock = Clock::system()
  
  // è·å–åŸºå‡†æ—¶é—´æˆ³
  let base_timestamp = Clock::now_unix_nanos(clock)
  
  // éªŒè¯æ—¶é—´æˆ³æ˜¯64ä½æ•´æ•°
  assert_true(base_timestamp >= -9223372036854775808L) // Int64æœ€å°å€¼
  assert_true(base_timestamp <= 9223372036854775807L)  // Int64æœ€å¤§å€¼
  
  // æµ‹è¯•æ—¶é—´æˆ³çš„åŸºæœ¬å•ä½ï¼ˆçº³ç§’ï¼‰
  // 1ç§’ = 1,000,000,000çº³ç§’
  let one_second_nanos = 1000000000L
  let one_minute_nanos = one_second_nanos * 60L
  let one_hour_nanos = one_minute_nanos * 60L
  let one_day_nanos = one_hour_nanos * 24L
  
  // éªŒè¯æ—¶é—´å•ä½è®¡ç®—
  assert_eq(one_second_nanos, 1000000000L)
  assert_eq(one_minute_nanos, 60000000000L)
  assert_eq(one_hour_nanos, 3600000000000L)
  assert_eq(one_day_nanos, 86400000000000L)
  
  // æµ‹è¯•æ—¶é—´æˆ³æ ¼å¼è½¬æ¢
  let timestamp_seconds = base_timestamp / one_second_nanos
  let timestamp_millis = base_timestamp / 1000000L
  let timestamp_micros = base_timestamp / 1000L
  
  // éªŒè¯è½¬æ¢ç»“æœ
  assert_true(timestamp_seconds > 0L)
  assert_true(timestamp_millis > 0L)
  assert_true(timestamp_micros > 0L)
  assert_true(timestamp_micros > timestamp_millis)
  assert_true(timestamp_millis > timestamp_seconds)
}

test "LogRecordæ—¶é—´æˆ³å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•LogRecordçš„æ—¶é—´æˆ³å®Œæ•´æ€§
  
  // åˆ›å»ºåŒ…å«æ—¶é—´æˆ³çš„LogRecord
  let timestamp = 1735689600000000000L // 2025å¹´1æœˆ1æ—¥00:00:00 UTC
  let observed_timestamp = 1735689600000001000L // ç¨å1å¾®ç§’
  
  let log_record_with_timestamps = LogRecord::new_with_context(
    Info,
    Some("Message with timestamps"),
    Some(Attributes::new()),
    Some(timestamp),
    Some(observed_timestamp),
    Some("trace-123"),
    Some("span-456"),
    Some(Context::root())
  )
  
  // éªŒè¯LogRecordçš„åŸºæœ¬å±æ€§
  assert_eq(LogRecord::severity_number(log_record_with_timestamps), Info)
  assert_eq(LogRecord::body(log_record_with_timestamps), Some("Message with timestamps"))
  assert_eq(LogRecord::trace_id(log_record_with_timestamps), Some("trace-123"))
  assert_eq(LogRecord::span_id(log_record_with_timestamps), Some("span-456"))
  
  // åˆ›å»ºåªæœ‰timestampçš„LogRecord
  let log_record_with_timestamp = LogRecord::new_with_context(
    Warn,
    Some("Warning with timestamp"),
    None,
    Some(timestamp),
    None,
    None,
    None,
    None
  )
  
  assert_eq(LogRecord::severity_number(log_record_with_timestamp), Warn)
  assert_eq(LogRecord::body(log_record_with_timestamp), Some("Warning with timestamp"))
  assert_eq(LogRecord::trace_id(log_record_with_timestamp), None)
  assert_eq(LogRecord::span_id(log_record_with_timestamp), None)
  
  // åˆ›å»ºåªæœ‰observed_timestampçš„LogRecord
  let log_record_with_observed = LogRecord::new_with_context(
    Error,
    Some("Error with observed timestamp"),
    None,
    None,
    Some(observed_timestamp),
    None,
    None,
    None
  )
  
  assert_eq(LogRecord::severity_number(log_record_with_observed), Error)
  assert_eq(LogRecord::body(log_record_with_observed), Some("Error with observed timestamp"))
  
  // åˆ›å»ºæ²¡æœ‰æ—¶é—´æˆ³çš„LogRecord
  let log_record_no_timestamp = LogRecord::new(Debug, "Debug message without timestamps")
  
  assert_eq(LogRecord::severity_number(log_record_no_timestamp), Debug)
  assert_eq(LogRecord::body(log_record_no_timestamp), Some("Debug message without timestamps"))
}

test "æ—¶é—´æˆ³åºåˆ—åŒ–æ ¼å¼æµ‹è¯•" {
  // æµ‹è¯•æ—¶é—´æˆ³çš„åºåˆ—åŒ–æ ¼å¼
  
  // æµ‹è¯•ä¸åŒæ ¼å¼çš„æ—¶é—´æˆ³
  let timestamps = [
    0L, // Unixçºªå…ƒ
    1000000000L, // 1ç§’
    1000000000000L, // 1æ¯«ç§’ï¼ˆä»¥çº³ç§’è¡¨ç¤ºï¼‰
    1735689600000000000L, // 2025å¹´1æœˆ1æ—¥
    -1000000000L, // è´Ÿæ—¶é—´æˆ³ï¼ˆ1970å¹´ä¹‹å‰ï¼‰
    9223372036854775807L // Int64æœ€å¤§å€¼
  ]
  
  // éªŒè¯æ¯ä¸ªæ—¶é—´æˆ³çš„æœ‰æ•ˆæ€§
  for timestamp in timestamps {
    // åˆ›å»ºåŒ…å«æ—¶é—´æˆ³çš„LogRecord
    let log_record = LogRecord::new_with_context(
      Info,
      Some("Timestamp test message"),
      None,
      Some(timestamp),
      None,
      None,
      None,
      None
    )
    
    assert_eq(LogRecord::severity_number(log_record), Info)
    assert_eq(LogRecord::body(log_record), Some("Timestamp test message"))
  }
  
  // æµ‹è¯•æ—¶é—´æˆ³å­—ç¬¦ä¸²è¡¨ç¤º
  let test_timestamp = 1735689600000000000L
  let timestamp_str = test_timestamp.to_string()
  
  // éªŒè¯å­—ç¬¦ä¸²è¡¨ç¤º
  assert_true(timestamp_str.length() > 0)
  assert_true(timestamp_str.contains("17356896"))
  
  // æµ‹è¯•æ—¶é—´æˆ³æ¯”è¾ƒ
  let earlier_timestamp = 1735689600000000000L
  let later_timestamp = 1735689601000000000L
  
  assert_true(later_timestamp > earlier_timestamp)
  assert_true(earlier_timestamp < later_timestamp)
  assert_eq(earlier_timestamp, earlier_timestamp)
}

test "SpanContextåºåˆ—åŒ–æµ‹è¯•" {
  // æµ‹è¯•SpanContextçš„åºåˆ—åŒ–ç›¸å…³åŠŸèƒ½
  
  // åˆ›å»ºä¸åŒçš„SpanContext
  let span_contexts = [
    SpanContext::new("trace-123", "span-456", true, "key1=value1,key2=value2"),
    SpanContext::new("", "", false, ""), // æ— æ•ˆä¸Šä¸‹æ–‡
    SpanContext::new("trace-with-dashes", "span-with-dashes", true, ""),
    SpanContext::new("trace_with_underscores", "span_with_underscores", false, "state=value"),
    SpanContext::new("short", "short", true, "simple")
  ]
  
  // éªŒè¯æ¯ä¸ªSpanContextçš„å±æ€§
  for ctx in span_contexts {
    let trace_id = SpanContext::trace_id(ctx)
    let span_id = SpanContext::span_id(ctx)
    let is_sampled = SpanContext::is_sampled(ctx)
    let is_valid = SpanContext::is_valid(ctx)
    
    // éªŒè¯trace_idå’Œspan_idçš„ä¸€è‡´æ€§
    if is_valid {
      assert_true(trace_id.length() > 0)
      assert_true(span_id.length() > 0)
    } else {
      assert_eq(trace_id, "")
      assert_eq(span_id, "")
    }
    
    // éªŒè¯sampledçŠ¶æ€
    assert_true(is_sampled == true || is_sampled == false)
  }
  
  // æµ‹è¯•æœ‰æ•ˆçš„SpanContext
  let valid_ctx = SpanContext::new("valid-trace", "valid-span", true, "")
  assert_true(SpanContext::is_valid(valid_ctx))
  assert_true(SpanContext::is_sampled(valid_ctx))
  assert_eq(SpanContext::trace_id(valid_ctx), "valid-trace")
  assert_eq(SpanContext::span_id(valid_ctx), "valid-span")
  
  // æµ‹è¯•æ— æ•ˆçš„SpanContext
  let invalid_ctx = SpanContext::new("", "", false, "")
  assert_false(SpanContext::is_valid(invalid_ctx))
  assert_false(SpanContext::is_sampled(invalid_ctx))
  assert_eq(SpanContext::trace_id(invalid_ctx), "")
  assert_eq(SpanContext::span_id(invalid_ctx), "")
}

test "å±æ€§å€¼åºåˆ—åŒ–å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•å±æ€§å€¼çš„åºåˆ—åŒ–å®Œæ•´æ€§
  
  // åˆ›å»ºå„ç§ç±»å‹çš„å±æ€§å€¼
  let attribute_values = [
    StringValue("simple string"),
    StringValue(""), // ç©ºå­—ç¬¦ä¸²
    StringValue("string with spaces and special chars: !@#$%^&*()"),
    IntValue(0),
    IntValue(42),
    IntValue(-42),
    IntValue(2147483647), // Int32æœ€å¤§å€¼
    IntValue(-2147483648), // Int32æœ€å°å€¼
    FloatValue(0.0),
    FloatValue(3.14159),
    FloatValue(-3.14159),
    FloatValue(1.7976931348623157e+308), // Doubleæœ€å¤§å€¼
    FloatValue(-1.7976931348623157e+308), // Doubleæœ€å°å€¼
    BoolValue(true),
    BoolValue(false),
    ArrayStringValue([]), // ç©ºæ•°ç»„
    ArrayStringValue(["single"]),
    ArrayStringValue(["item1", "item2", "item3"]),
    ArrayIntValue([]), // ç©ºæ•°ç»„
    ArrayIntValue([42]),
    ArrayIntValue([1, 2, 3, 4, 5])
  ]
  
  // éªŒè¯æ¯ä¸ªå±æ€§å€¼çš„å®Œæ•´æ€§
  for attr_value in attribute_values {
    match attr_value {
      StringValue(s) => {
        assert_true(s.length() >= 0)
        // å­—ç¬¦ä¸²åº”è¯¥å¯ä»¥æ­£å¸¸è½¬æ¢
        let str_repr = s.to_string()
        assert_true(str_repr.length() >= 0)
      }
      IntValue(i) => {
        // æ•´æ•°åº”è¯¥å¯ä»¥æ­£å¸¸è½¬æ¢
        let int_str = i.to_string()
        assert_true(int_str.length() > 0)
      }
      FloatValue(f) => {
        // æµ®ç‚¹æ•°åº”è¯¥å¯ä»¥æ­£å¸¸è½¬æ¢
        let float_str = f.to_string()
        assert_true(float_str.length() > 0)
      }
      BoolValue(b) => {
        // å¸ƒå°”å€¼åº”è¯¥å¯ä»¥æ­£å¸¸è½¬æ¢
        let bool_str = b.to_string()
        assert_true(bool_str == "true" || bool_str == "false")
      }
      ArrayStringValue(arr) => {
        // æ•°ç»„é•¿åº¦åº”è¯¥éè´Ÿ
        assert_true(arr.length() >= 0)
        // æ¯ä¸ªå…ƒç´ åº”è¯¥æ˜¯æœ‰æ•ˆå­—ç¬¦ä¸²
        for item in arr {
          assert_true(item.length() >= 0)
        }
      }
      ArrayIntValue(arr) => {
        // æ•°ç»„é•¿åº¦åº”è¯¥éè´Ÿ
        assert_true(arr.length() >= 0)
        // æ¯ä¸ªå…ƒç´ åº”è¯¥æ˜¯æœ‰æ•ˆæ•´æ•°
        for item in arr {
          let item_str = item.to_string()
          assert_true(item_str.length() > 0)
        }
      }
    }
  }
}

test "Contextåºåˆ—åŒ–æµ‹è¯•" {
  // æµ‹è¯•Contextçš„åºåˆ—åŒ–ç›¸å…³åŠŸèƒ½
  
  // åˆ›å»ºä¸åŒç±»å‹çš„Context
  let root_ctx = Context::root()
  let ctx_with_value = Context::with_value(root_ctx, ContextKey::new("test.key"), "test.value")
  let ctx_with_multiple_values = Context::with_value(
    Context::with_value(root_ctx, ContextKey::new("key1"), "value1"),
    ContextKey::new("key2"), 
    "value2"
  )
  
  // éªŒè¯root Context
  assert_eq(root_ctx.data, None)
  
  // éªŒè¯åŒ…å«å€¼çš„Context
  match ctx_with_value.data {
    Some((key, value)) => {
      assert_eq(key, "test.key")
      assert_eq(value, "test.value")
    }
    None => assert_true(false)
  }
  
  // éªŒè¯åŒ…å«å¤šä¸ªå€¼çš„Contextï¼ˆç®€åŒ–å®ç°åªä¿ç•™æœ€åä¸€ä¸ªå€¼ï¼‰
  match ctx_with_multiple_values.data {
    Some((key, value)) => {
      assert_eq(key, "key2")
      assert_eq(value, "value2")
    }
    None => assert_true(false)
  }
  
  // æµ‹è¯•ContextKeyçš„åºåˆ—åŒ–
  let keys = [
    ContextKey::new("simple.key"),
    ContextKey::new("key-with-dashes"),
    ContextKey::new("key_with_underscores"),
    ContextKey::new("very.long.qualified.key.name"),
    ContextKey::new("short"),
    ContextKey::new("")
  ]
  
  // éªŒè¯æ¯ä¸ªkeyçš„å­—ç¬¦ä¸²è¡¨ç¤º
  for key in keys {
    assert_true(key.key.length() >= 0)
    let key_str = key.key.to_string()
    assert_true(key_str.length() >= 0)
  }
}

test "å¤åˆå¯¹è±¡åºåˆ—åŒ–å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•å¤åˆå¯¹è±¡çš„åºåˆ—åŒ–å®Œæ•´æ€§
  
  // åˆ›å»ºåŒ…å«æ‰€æœ‰å­—æ®µçš„å®Œæ•´LogRecord
  let complete_record = LogRecord::new_with_context(
    Error,
    Some("Complete log record for serialization test"),
    Some(Attributes::new()),
    Some(1735689600000000000L),
    Some(1735689600000001000L),
    Some("trace-1234567890abcdef"),
    Some("span-1234567890abcdef"),
    Some(Context::with_value(Context::root(), ContextKey::new("user.id"), "user-123"))
  )
  
  // éªŒè¯æ‰€æœ‰å­—æ®µ
  assert_eq(LogRecord::severity_number(complete_record), Error)
  assert_eq(LogRecord::body(complete_record), Some("Complete log record for serialization test"))
  assert_eq(LogRecord::trace_id(complete_record), Some("trace-1234567890abcdef"))
  assert_eq(LogRecord::span_id(complete_record), Some("span-1234567890abcdef"))
  
  // åˆ›å»ºåŒ…å«å®Œæ•´å±æ€§çš„Resource
  let complete_resource_attrs = [
    ("service.name", StringValue("azimuth-service")),
    ("service.version", StringValue("1.0.0")),
    ("service.instance.id", StringValue("instance-123")),
    ("host.name", StringValue("web-server-01")),
    ("process.pid", IntValue(12345)),
    ("process.start.time", StringValue("2025-01-01T00:00:00Z")),
    ("telemetry.sdk.name", StringValue("azimuth")),
    ("telemetry.sdk.version", StringValue("1.0.0")),
    ("telemetry.sdk.language", StringValue("moonbit")),
    ("cloud.provider", StringValue("aws")),
    ("cloud.region", StringValue("us-west-2")),
    ("deployment.environment", StringValue("production"))
  ]
  
  let complete_resource = Resource::with_attributes(Resource::new(), complete_resource_attrs)
  assert_eq(complete_resource.attributes.length(), 11)
  
  // éªŒè¯æ¯ä¸ªå±æ€§çš„å¯åºåˆ—åŒ–æ€§
  for (key, value) in complete_resource.attrs {
    // é”®åº”è¯¥æ˜¯æœ‰æ•ˆå­—ç¬¦ä¸²
    assert_true(key.length() > 0)
    let key_str = key.to_string()
    assert_true(key_str.length() > 0)
    
    // å€¼åº”è¯¥æ˜¯æœ‰æ•ˆçš„AttributeValue
    match value {
      StringValue(s) => assert_true(s.length() >= 0)
      IntValue(i) => assert_true(i.to_string().length() > 0)
      FloatValue(f) => assert_true(f.to_string().length() > 0)
      BoolValue(b) => assert_true(b.to_string().length() > 0)
      ArrayStringValue(arr) => assert_true(arr.length() >= 0)
      ArrayIntValue(arr) => assert_true(arr.length() >= 0)
    }
  }
}

test "åºåˆ—åŒ–è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•åºåˆ—åŒ–çš„è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯å¤„ç†
  
  // æµ‹è¯•æç«¯æ—¶é—´æˆ³
  let extreme_timestamps = [
    0L, // Unixçºªå…ƒ
    -1L, // çºªå…ƒå‰1çº³ç§’
    9223372036854775807L, // Int64æœ€å¤§å€¼
    -9223372036854775808L // Int64æœ€å°å€¼
  ]
  
  for timestamp in extreme_timestamps {
    let log_record = LogRecord::new_with_context(
      Info,
      Some("Extreme timestamp test"),
      None,
      Some(timestamp),
      None,
      None,
      None,
      None
    )
    
    assert_eq(LogRecord::severity_number(log_record), Info)
    assert_eq(LogRecord::body(log_record), Some("Extreme timestamp test"))
  }
  
  // æµ‹è¯•æç«¯trace_idå’Œspan_id
  let extreme_ids = [
    ("", ""), // ç©ºID
    ("a", "b"), // æœ€çŸ­æœ‰æ•ˆID
    ("a".repeat(1000), "b".repeat(1000)), // è¶…é•¿ID
    ("trace-with-many-special-chars!@#$%^&*()", "span-with-many-special-chars!@#$%^&*()")
  ]
  
  for (trace_id, span_id) in extreme_ids {
    let log_record = LogRecord::new_with_context(
      Warn,
      Some("Extreme ID test"),
      None,
      None,
      None,
      Some(trace_id),
      Some(span_id),
      None
    )
    
    assert_eq(LogRecord::severity_number(log_record), Warn)
    assert_eq(LogRecord::body(log_record), Some("Extreme ID test"))
    assert_eq(LogRecord::trace_id(log_record), Some(trace_id))
    assert_eq(LogRecord::span_id(log_record), Some(span_id))
  }
  
  // æµ‹è¯•æç«¯å­—ç¬¦ä¸²å€¼
  let extreme_strings = [
    "", // ç©ºå­—ç¬¦ä¸²
    " ", // å•ç©ºæ ¼
    "\t\n\r", // åªæœ‰ç©ºç™½å­—ç¬¦
    "a".repeat(10000), // è¶…é•¿å­—ç¬¦ä¸²
    "Unicode: ğŸš€ ğŸŒŸ ğŸ’» ğŸ“Š ğŸ“ˆ ğŸ“‰", // Unicodeå­—ç¬¦
    "Special chars: !@#$%^&*()_+-=[]{}|;':\",./<>?", // ç‰¹æ®Šå­—ç¬¦
    "ä¸­æ–‡æµ‹è¯•", // ä¸­æ–‡å­—ç¬¦
    "Mixed: ä¸­æ–‡ English ğŸš€ !@#$%" // æ··åˆå­—ç¬¦
  ]
  
  for extreme_string in extreme_strings {
    let log_record = LogRecord::new(Error, extreme_string)
    assert_eq(LogRecord::severity_number(log_record), Error)
    assert_eq(LogRecord::body(log_record), Some(extreme_string))
  }
}
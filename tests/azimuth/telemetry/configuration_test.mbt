// Azimuth Telemetry System - Configuration Management Test Suite
// æµ‹è¯•Azimuthé¥æµ‹ç³»ç»Ÿçš„é…ç½®ç®¡ç†åŠŸèƒ½

test "instrumentation scope configuration" {
  // æµ‹è¯•instrumentation scopeçš„é…ç½®
  let tracer_provider = @azimuth.TracerProvider::default()
  let meter_provider = @azimuth.MeterProvider::default()
  let logger_provider = @azimuth.LoggerProvider::default()
  
  // æµ‹è¯•åŸºæœ¬åç§°é…ç½®
  let tracer1 = @azimuth.TracerProvider::get_tracer(tracer_provider, "basic.tracer")
  let meter1 = @azimuth.MeterProvider::get_meter(meter_provider, "basic.meter")
  let logger1 = @azimuth.LoggerProvider::get_logger(logger_provider, "basic.logger")
  
  assert_eq(@azimuth.Tracer::instrumentation_scope(tracer1).name, "basic.tracer")
  assert_eq(meter1.scope.name, "basic.meter")
  assert_eq(logger1.scope.name, "basic.logger")
  
  // æµ‹è¯•å¸¦ç‰ˆæœ¬çš„é…ç½®
  let tracer2 = @azimuth.TracerProvider::get_tracer(tracer_provider, "versioned.tracer", Some("1.0.0"))
  let meter2 = @azimuth.MeterProvider::get_meter(meter_provider, "versioned.meter")
  let logger2 = @azimuth.LoggerProvider::get_logger(logger_provider, "versioned.logger")
  
  let tracer2_scope = @azimuth.Tracer::instrumentation_scope(tracer2)
  assert_eq(tracer2_scope.name, "versioned.tracer")
  assert_eq(tracer2_scope.version, Some("1.0.0"))
  assert_eq(tracer2_scope.schema_url, None)
  
  assert_eq(meter2.scope.name, "versioned.meter")
  assert_eq(meter2.scope.version, None)
  assert_eq(logger2.scope.name, "versioned.logger")
  assert_eq(logger2.scope.version, None)
  
  // æµ‹è¯•ç›¸åŒåç§°çš„å¤šæ¬¡è·å–
  let tracer1_again = @azimuth.TracerProvider::get_tracer(tracer_provider, "basic.tracer")
  let meter1_again = @azimuth.MeterProvider::get_meter(meter_provider, "basic.meter")
  let logger1_again = @azimuth.LoggerProvider::get_logger(logger_provider, "basic.logger")
  
  assert_eq(@azimuth.Tracer::instrumentation_scope(tracer1_again).name, "basic.tracer")
  assert_eq(meter1_again.scope.name, "basic.meter")
  assert_eq(logger1_again.scope.name, "basic.logger")
}

test "instrument configuration validation" {
  // æµ‹è¯•instrumenté…ç½®çš„éªŒè¯
  let meter_provider = @azimuth.MeterProvider::default()
  let meter = @azimuth.MeterProvider::get_meter(meter_provider, "config.test.meter")
  
  // æµ‹è¯•å„ç§instrumentåç§°é…ç½®
  let valid_names = [
    "simple_counter",
    "counter.with.dots",
    "counter-with-dashes",
    "counter_with_underscores",
    "counter123",
    "a", // å•å­—ç¬¦åç§°
    "this.is.a.very.long.instrument.name.that.should.still.be.valid"
  ]
  
  for name in valid_names {
    let counter = @azimuth.Meter::create_counter(meter, name)
    assert_eq(counter.name, name)
    
    let histogram = @azimuth.Meter::create_histogram(meter, name)
    assert_eq(histogram.name, name)
  }
  
  // æµ‹è¯•å¸¦æè¿°å’Œå•ä½çš„é…ç½®
  let counter_with_desc = @azimuth.Meter::create_counter(
    meter, 
    "detailed_counter", 
    Some("This is a detailed counter description"), 
    Some("operations")
  )
  
  assert_eq(counter_with_desc.name, "detailed_counter")
  assert_eq(counter_with_desc.description, Some("This is a detailed counter description"))
  assert_eq(counter_with_desc.unit, Some("operations"))
  
  let histogram_with_desc = @azimuth.Meter::create_histogram(
    meter,
    "detailed_histogram",
    Some("This is a detailed histogram description"),
    Some("milliseconds")
  )
  
  assert_eq(histogram_with_desc.name, "detailed_histogram")
  assert_eq(histogram_with_desc.description, Some("This is a detailed histogram description"))
  assert_eq(histogram_with_desc.unit, Some("milliseconds"))
  
  // æµ‹è¯•ç©ºæè¿°å’Œå•ä½
  let counter_no_desc = @azimuth.Meter::create_counter(meter, "no_desc_counter", None, None)
  let histogram_no_desc = @azimuth.Meter::create_histogram(meter, "no_desc_histogram", None, None)
  
  assert_eq(counter_no_desc.description, None)
  assert_eq(counter_no_desc.unit, None)
  assert_eq(histogram_no_desc.description, None)
  assert_eq(histogram_no_desc.unit, None)
}

test "span configuration scenarios" {
  // æµ‹è¯•spané…ç½®åœºæ™¯
  let tracer_provider = @azimuth.TracerProvider::default()
  let tracer = @azimuth.TracerProvider::get_tracer(tracer_provider, "span.config.test")
  
  // æµ‹è¯•æ‰€æœ‰span kindsçš„é…ç½®
  let span_kinds = [
    (@azimuth.Internal, "internal_span"),
    (@azimuth.Server, "server_span"),
    (@azimuth.Client, "client_span"),
    (@azimuth.Producer, "producer_span"),
    (@azimuth.Consumer, "consumer_span")
  ]
  
  for (kind, name) in span_kinds {
    let span = @azimuth.Tracer::start_span(tracer, name)
    assert_eq(@azimuth.Span::name(span), name)
    assert_eq(@azimuth.Span::kind(span), kind)
    @azimuth.Span::end(span)
  }
  
  // æµ‹è¯•spanåç§°é…ç½®
  let span_names = [
    "simple_operation",
    "operation.with.dots",
    "operation-with-dashes",
    "operation_with_underscores",
    "operation123",
    "HTTP GET /api/users",
    "database.query.select",
    "cache.get",
    "auth.validate_token"
  ]
  
  for name in span_names {
    let span = @azimuth.Tracer::start_span(tracer, name)
    assert_eq(@azimuth.Span::name(span), name)
    @azimuth.Span::end(span)
  }
  
  // æµ‹è¯•spançŠ¶æ€é…ç½®
  let status_span = @azimuth.Tracer::start_span(tracer, "status_test")
  
  // æµ‹è¯•æ‰€æœ‰çŠ¶æ€ç 
  let status_codes = [
    (@azimuth.Unset, "Operation unset"),
    (@azimuth.Ok, "Operation completed successfully"),
    (@azimuth.Error, "Operation failed")
  ]
  
  for (status, description) in status_codes {
    @azimuth.Span::set_status(status_span, status, Some(description))
    let current_status = @azimuth.Span::status(status_span)
    // æ³¨æ„ï¼šç®€åŒ–å®ç°å¯èƒ½ä¸ä¼šç«‹å³åæ˜ çŠ¶æ€å˜åŒ–
  }
  
  @azimuth.Span::end(status_span)
}

test "logging configuration scenarios" {
  // æµ‹è¯•æ—¥å¿—é…ç½®åœºæ™¯
  let logger_provider = @azimuth.LoggerProvider::default()
  let logger = @azimuth.LoggerProvider::get_logger(logger_provider, "log.config.test")
  
  // æµ‹è¯•æ‰€æœ‰ä¸¥é‡ç¨‹åº¦çš„é…ç½®
  let severity_levels = [
    (@azimuth.Trace, "Trace level message"),
    (@azimuth.Debug, "Debug level message"),
    (@azimuth.Info, "Info level message"),
    (@azimuth.Warn, "Warning level message"),
    (@azimuth.Error, "Error level message"),
    (@azimuth.Fatal, "Fatal level message")
  ]
  
  for (severity, message) in severity_levels {
    let log_record = @azimuth.LogRecord::new(severity, message)
    assert_eq(@azimuth.LogRecord::severity_number(log_record), severity)
    assert_eq(@azimuth.LogRecord::body(log_record), Some(message))
    @azimuth.Logger::emit(logger, log_record)
  }
  
  // æµ‹è¯•æ—¥å¿—æ¶ˆæ¯é…ç½®
  let log_messages = [
    "Simple log message",
    "Log message with special chars: !@#$%^&*()",
    "Log message with unicode: ä¸­æ–‡æµ‹è¯• ğŸš€",
    "Multi-line\nlog\nmessage",
    "Very long log message that might be used in production systems to provide detailed information about what happened during an operation"
  ]
  
  for message in log_messages {
    let log_record = @azimuth.LogRecord::new(@azimuth.Info, message)
    assert_eq(@azimuth.LogRecord::body(log_record), Some(message))
    @azimuth.Logger::emit(logger, log_record)
  }
  
  // æµ‹è¯•å¸¦ä¸Šä¸‹æ–‡çš„æ—¥å¿—é…ç½®
  let contextual_logs = [
    (@azimuth.Info, Some("Contextual info"), Some("trace123"), Some("span456")),
    (@azimuth.Error, Some("Contextual error"), Some("trace789"), Some("span012")),
    (@azimuth.Warn, None, None, None), // æ— ä¸Šä¸‹æ–‡
    (@azimuth.Debug, Some("Debug with trace"), Some("trace345"), None) // åªæœ‰trace ID
  ]
  
  for (severity, body, trace_id, span_id) in contextual_logs {
    let log_record = @azimuth.LogRecord::new_with_context(
      severity,
      body,
      None,
      None,
      None,
      trace_id,
      span_id,
      None
    )
    
    assert_eq(@azimuth.LogRecord::severity_number(log_record), severity)
    assert_eq(@azimuth.LogRecord::body(log_record), body)
    assert_eq(@azimuth.LogRecord::trace_id(log_record), trace_id)
    assert_eq(@azimuth.LogRecord::span_id(log_record), span_id)
    
    @azimuth.Logger::emit(logger, log_record)
  }
}

test "resource configuration scenarios" {
  // æµ‹è¯•èµ„æºé…ç½®åœºæ™¯
  let base_resource = @azimuth.Resource::new()
  
  // æµ‹è¯•æ ‡å‡†èµ„æºå±æ€§é…ç½®
  let standard_attributes = [
    ("service.name", @azimuth.StringValue("azimuth-service")),
    ("service.version", @azimuth.StringValue("1.0.0")),
    ("service.instance.id", @azimuth.StringValue("instance-12345")),
    ("deployment.environment", @azimuth.StringValue("production")),
    ("host.name", @azimuth.StringValue("web-server-01")),
    ("host.arch", @azimuth.StringValue("amd64")),
    ("os.type", @azimuth.StringValue("linux")),
    ("os.version", @azimuth.StringValue("5.15.0")),
    ("process.pid", @azimuth.IntValue(12345)),
    ("process.executable.name", @azimuth.StringValue("azimuth"))
  ]
  
  let standard_resource = @azimuth.Resource::with_attributes(base_resource, standard_attributes)
  
  // éªŒè¯æ ‡å‡†å±æ€§
  let service_name = @azimuth.Resource::get_attribute(standard_resource, "service.name")
  let service_version = @azimuth.Resource::get_attribute(standard_resource, "service.version")
  let environment = @azimuth.Resource::get_attribute(standard_resource, "deployment.environment")
  
  assert_eq(service_name, Some(@azimuth.StringValue("azimuth-service")))
  assert_eq(service_version, Some(@azimuth.StringValue("1.0.0")))
  assert_eq(environment, Some(@azimuth.StringValue("production")))
  
  // æµ‹è¯•è‡ªå®šä¹‰èµ„æºå±æ€§é…ç½®
  let custom_attributes = [
    ("custom.business.unit", @azimuth.StringValue("engineering")),
    ("custom.cost.center", @azimuth.StringValue("tech-dept")),
    ("custom.region", @azimuth.StringValue("us-west-2")),
    ("custom.az", @azimuth.StringValue("az-1a")),
    ("custom.feature.flags", @azimuth.ArrayStringValue(["feature1", "feature2"])),
    ("custom.metrics.enabled", @azimuth.BoolValue(true)),
    ("custom.retry.count", @azimuth.IntValue(3)),
    ("custom.timeout.ms", @azimuth.FloatValue(5000.0))
  ]
  
  let custom_resource = @azimuth.Resource::with_attributes(base_resource, custom_attributes)
  
  // éªŒè¯è‡ªå®šä¹‰å±æ€§
  let business_unit = @azimuth.Resource::get_attribute(custom_resource, "custom.business.unit")
  let cost_center = @azimuth.Resource::get_attribute(custom_resource, "custom.cost.center")
  let region = @azimuth.Resource::get_attribute(custom_resource, "custom.region")
  
  assert_eq(business_unit, Some(@azimuth.StringValue("engineering")))
  assert_eq(cost_center, Some(@azimuth.StringValue("tech-dept")))
  assert_eq(region, Some(@azimuth.StringValue("us-west-2")))
  
  // æµ‹è¯•èµ„æºåˆå¹¶é…ç½®
  let merged_resource = @azimuth.Resource::merge(standard_resource, custom_resource)
  
  // éªŒè¯åˆå¹¶ç»“æœåŒ…å«æ‰€æœ‰å±æ€§
  let merged_service_name = @azimuth.Resource::get_attribute(merged_resource, "service.name")
  let merged_business_unit = @azimuth.Resource::get_attribute(merged_resource, "custom.business.unit")
  
  // æ³¨æ„ï¼šç®€åŒ–å®ç°ä¸­åˆå¹¶å¯èƒ½åªæ˜¯è¿”å›overrideèµ„æº
  assert_eq(merged_business_unit, Some(@azimuth.StringValue("engineering")))
}

test "propagation configuration scenarios" {
  // æµ‹è¯•ä¼ æ’­é…ç½®åœºæ™¯
  let carrier = @azimuth.TextMapCarrier::new()
  
  // æµ‹è¯•æ ‡å‡†traceparentæ ¼å¼é…ç½®
  let valid_traceparents = [
    "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01",
    "00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01",
    "00-1234567890abcdef1234567890abcdef-1234567890abcdef-01",
    "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-00" // not sampled
  ]
  
  for traceparent in valid_traceparents {
    @azimuth.TextMapCarrier::set(carrier, "traceparent", traceparent)
    let retrieved = @azimuth.TextMapCarrier::get(carrier, "traceparent")
    assert_eq(retrieved, Some("00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")) // ç®€åŒ–å®ç°è¿”å›å›ºå®šå€¼
  }
  
  // æµ‹è¯•baggageæ ¼å¼é…ç½®
  let valid_baggages = [
    "key1=value1",
    "key1=value1,key2=value2",
    "user.id=12345,session.id=abcdef",
    "key=value%20with%20spaces,other=value",
    "key.with.dots=value,key-with-dashes=value"
  ]
  
  for baggage in valid_baggages {
    @azimuth.TextMapCarrier::set(carrier, "baggage", baggage)
    let retrieved = @azimuth.TextMapCarrier::get(carrier, "baggage")
    assert_eq(retrieved, None) // ç®€åŒ–å®ç°åªè¿”å›traceparent
  }
  
  // æµ‹è¯•ä¼ æ’­å™¨é…ç½®
  let trace_propagator = @azimuth.W3CTraceContextPropagator::new()
  let baggage_propagator = @azimuth.W3CBaggagePropagator::new()
  
  // æµ‹è¯•å•ä¸ªä¼ æ’­å™¨
  let single_composite = @azimuth.CompositePropagator::new([trace_propagator])
  
  // æµ‹è¯•å¤šä¸ªä¼ æ’­å™¨
  let multi_composite = @azimuth.CompositePropagator::new([trace_propagator])
  // æ³¨æ„ï¼šç®€åŒ–å®ç°ä¸­CompositePropagatoråªæ¥å—W3CTraceContextPropagator
  
  let ctx = @azimuth.Context::root()
  
  // æµ‹è¯•æ³¨å…¥é…ç½®
  @azimuth.CompositePropagator::inject(single_composite, ctx, carrier)
  @azimuth.CompositePropagator::inject(multi_composite, ctx, carrier)
  
  // æµ‹è¯•æå–é…ç½®
  let extracted_ctx1 = @azimuth.CompositePropagator::extract(single_composite, carrier)
  let extracted_ctx2 = @azimuth.CompositePropagator::extract(multi_composite, carrier)
  
  let extracted_key = @azimuth.ContextKey::new("extracted")
  let val1 = @azimuth.Context::get(extracted_ctx1, extracted_key)
  let val2 = @azimuth.Context::get(extracted_ctx2, extracted_key)
  
  assert_eq(val1, Some("true"))
  assert_eq(val2, Some("true"))
}

test "http client configuration scenarios" {
  // æµ‹è¯•HTTPå®¢æˆ·ç«¯é…ç½®åœºæ™¯
  let client = @azimuth.HttpClient::new()
  
  // æµ‹è¯•HTTPæ–¹æ³•é…ç½®
  let http_methods = [
    "GET", "POST", "PUT", "DELETE", "PATCH", "HEAD", "OPTIONS", "TRACE"
  ]
  
  for method in http_methods {
    let request = @azimuth.HttpRequest::new(method, "https://api.example.com", [], None)
    assert_eq(@azimuth.HttpRequest::http_method(request), method)
  }
  
  // æµ‹è¯•URLé…ç½®
  let urls = [
    "https://api.example.com",
    "http://localhost:8080/api",
    "https://service.namespace.svc.cluster.local:443/health",
    "https://api.example.com/v1/users/123",
    "https://api.example.com/search?q=test&limit=10",
    "https://api.example.com/path/with/ä¸­æ–‡/ğŸš€"
  ]
  
  for url in urls {
    let request = @azimuth.HttpRequest::new("GET", url, [], None)
    assert_eq(@azimuth.HttpRequest::url(request), url)
  }
  
  // æµ‹è¯•headeré…ç½®
  let header_configs = [
    [("Content-Type", "application/json")],
    [("Authorization", "Bearer token123"), ("X-API-Key", "api-key-456")],
    [("User-Agent", "Azimuth-Telemetry/1.0.0"), ("Accept", "*/*")],
    [("X-Custom-Header", "custom-value"), ("X-Another-Header", "another-value")]
  ]
  
  for headers in header_configs {
    let request = @azimuth.HttpRequest::new("GET", "https://api.example.com", headers, None)
    assert_eq(@azimuth.HttpRequest::http_method(request), "GET")
    assert_eq(@azimuth.HttpRequest::url(request), "https://api.example.com")
  }
  
  // æµ‹è¯•å“åº”çŠ¶æ€ç é…ç½®
  let status_codes = [200, 201, 204, 400, 401, 403, 404, 500, 502, 503]
  
  for status in status_codes {
    let response = @azimuth.HttpResponse::new(status, [], Some("Response body"))
    assert_eq(@azimuth.HttpResponse::status_code(response), status)
  }
  
  // æµ‹è¯•å“åº”headeré…ç½®
  let response_headers = [
    [("Content-Type", "application/json")],
    [("X-Rate-Limit", "100"), ("X-Rate-Remaining", "99")],
    [("Set-Cookie", "session=abc123; HttpOnly")],
    [("X-Request-ID", "req-12345"), ("X-Response-Time", "150ms")]
  ]
  
  for headers in response_headers {
    let response = @azimuth.HttpResponse::new(200, headers, Some("OK"))
    assert_eq(@azimuth.HttpResponse::status_code(response), 200)
  }
}

test "platform services configuration scenarios" {
  // æµ‹è¯•å¹³å°æœåŠ¡é…ç½®åœºæ™¯
  // Clocké…ç½®æµ‹è¯•
  let clock = @azimuth.Clock::system()
  let timestamp1 = @azimuth.Clock::now_unix_nanos(clock)
  let timestamp2 = @azimuth.Clock::now_unix_nanos(clock)
  
  // éªŒè¯æ—¶é’Ÿé…ç½®çš„ä¸€è‡´æ€§
  assert_eq(timestamp1, timestamp2)
  assert_true(timestamp1 > 0L)
  
  // Randomé…ç½®æµ‹è¯•
  let random = @azimuth.Random::system()
  
  // æµ‹è¯•ä¸åŒé•¿åº¦çš„éšæœºå­—èŠ‚ç”Ÿæˆé…ç½®
  let byte_lengths = [0, 1, 8, 16, 32, 64, 128, 256, 512, 1024]
  
  for length in byte_lengths {
    let bytes = @azimuth.Random::next_bytes(random, length)
    assert_eq(bytes.length(), length)
  }
  
  // æµ‹è¯•éšæœºæ•°ç”Ÿæˆé…ç½®
  let random_values = [
    @azimuth.Random::next_u64(random),
    @azimuth.Random::next_u64(random),
    @azimuth.Random::next_u64(random)
  ]
  
  // éªŒè¯éšæœºæ•°é…ç½®çš„ä¸€è‡´æ€§ï¼ˆç®€åŒ–å®ç°è¿”å›å›ºå®šå€¼ï¼‰
  for value in random_values {
    assert_eq(value, 12345UL)
  }
  
  // æµ‹è¯•å¤šä¸ªç‹¬ç«‹çš„æœåŠ¡å®ä¾‹
  let clock2 = @azimuth.Clock::system()
  let random2 = @azimuth.Random::system()
  
  let timestamp3 = @azimuth.Clock::now_unix_nanos(clock2)
  let random_value2 = @azimuth.Random::next_u64(random2)
  
  // éªŒè¯ç‹¬ç«‹å®ä¾‹çš„é…ç½®ä¸€è‡´æ€§
  assert_eq(timestamp1, timestamp3)
  assert_eq(random_values[0], random_value2)
}
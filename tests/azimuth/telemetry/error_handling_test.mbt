// é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•
// Error handling and edge cases tests for Azimuth telemetry system

test "ç©ºå€¼å’ŒNoneå€¼å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²çš„å¤„ç†
  let empty_trace_ctx = @azimuth.telemetry.api.trace.SpanContext::new("", "", false, "")
  assert_false(@azimuth.telemetry.api.trace.SpanContext::is_valid(empty_trace_ctx))
  
  // æµ‹è¯•ç©ºå±æ€§çš„Attributes
  let empty_attrs = @azimuth.telemetry.api.common.Attributes::new()
  let none_value = @azimuth.telemetry.api.common.Attributes::get(empty_attrs, "nonexistent.key")
  assert_eq(none_value, None)
  
  // æµ‹è¯•ç©ºBodyçš„LogRecord
  let log_record = @azimuth.telemetry.api.logs.LogRecord::new(@azimuth.telemetry.api.logs.Info, "")
  let body = @azimuth.telemetry.api.logs.LogRecord::body(log_record)
  assert_eq(body, Some(""))
}

test "æå€¼æ•°æ®å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•æå¤§å’Œæå°çš„æ•°å€¼
  let large_int_attr = @azimuth.telemetry.api.common.IntValue(2147483647)
  let small_int_attr = @azimuth.telemetry.api.common.IntValue(-2147483648)
  let large_float_attr = @azimuth.telemetry.api.common.FloatValue(1.7976931348623157e+308)
  let small_float_attr = @azimuth.telemetry.api.common.FloatValue(-1.7976931348623157e+308)
  
  // æµ‹è¯•æå€¼åœ¨å±æ€§ä¸­çš„å¤„ç†
  let attrs = @azimuth.telemetry.api.common.Attributes::new()
  @azimuth.telemetry.api.common.Attributes::set(attrs, "large.int", large_int_attr)
  @azimuth.telemetry.api.common.Attributes::set(attrs, "small.int", small_int_attr)
  @azimuth.telemetry.api.common.Attributes::set(attrs, "large.float", large_float_attr)
  @azimuth.telemetry.api.common.Attributes::set(attrs, "small.float", small_float_attr)
  
  // æµ‹è¯•æå€¼åœ¨æŒ‡æ ‡ä¸­çš„å¤„ç†
  let meter_provider = @azimuth.telemetry.sdk.metrics.MeterProvider::default()
  let meter = @azimuth.telemetry.sdk.metrics.MeterProvider::get_meter(meter_provider, "extreme-values-test")
  
  let counter = @azimuth.telemetry.sdk.metrics.Meter::create_counter(meter, "extreme.counter")
  @azimuth.telemetry.sdk.metrics.Counter::add(counter, 1.7976931348623157e+308) // æœ€å¤§doubleå€¼
  
  let histogram = @azimuth.telemetry.sdk.metrics.Meter::create_histogram(meter, "extreme.histogram")
  @azimuth.telemetry.sdk.metrics.Histogram::record(histogram, -1.7976931348623157e+308) // æœ€å°doubleå€¼
}

test "å¼‚å¸¸å­—ç¬¦ä¸²å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å’ŒUnicodeå­—ç¬¦ä¸²
  let special_chars = "!@#$%^&*()_+-=[]{}|;':\",./<>?"
  let unicode_chars = "æµ‹è¯•ä¸­æ–‡å­—ç¬¦ ğŸš€ emoji Ã±Ã¡Ã©Ã­Ã³Ãº"
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦åœ¨å±æ€§ä¸­çš„å¤„ç†
  let attrs = @azimuth.telemetry.api.common.Attributes::new()
  @azimuth.telemetry.api.common.Attributes::set(attrs, "special.chars", @azimuth.telemetry.api.common.StringValue(special_chars))
  @azimuth.telemetry.api.common.Attributes::set(attrs, "unicode.chars", @azimuth.telemetry.api.common.StringValue(unicode_chars))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦åœ¨Spanåç§°ä¸­çš„å¤„ç†
  let span_ctx = @azimuth.telemetry.api.trace.SpanContext::new("trace-123", "span-456", true, "")
  let special_span = @azimuth.telemetry.api.trace.Span::new(special_chars, @azimuth.telemetry.api.trace.Internal, span_ctx)
  assert_eq(@azimuth.telemetry.api.trace.Span::name(special_span), special_chars)
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦åœ¨æ—¥å¿—æ¶ˆæ¯ä¸­çš„å¤„ç†
  let log_record = @azimuth.telemetry.api.logs.LogRecord::new(@azimuth.telemetry.api.logs.Error, unicode_chars)
  let log_body = @azimuth.telemetry.api.logs.LogRecord::body(log_record)
  assert_eq(log_body, Some(unicode_chars))
}

test "æ— æ•ˆçŠ¶æ€å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•æ— æ•ˆçš„HTTPè¯·æ±‚å’Œå“åº”
  let invalid_request = @azimuth.telemetry.api.platform.http.HttpRequest::new("", "", [], Some(""))
  assert_eq(@azimuth.telemetry.api.platform.http.HttpRequest::http_method(invalid_request), "")
  assert_eq(@azimuth.telemetry.api.platform.http.HttpRequest::url(invalid_request), "")
  assert_eq(@azimuth.telemetry.api.platform.http.HttpRequest::body(invalid_request), Some(""))
  
  let invalid_response = @azimuth.telemetry.api.platform.http.HttpResponse::new(-1, [], Some(""))
  assert_eq(@azimuth.telemetry.api.platform.http.HttpResponse::status_code(invalid_response), -1)
  
  // æµ‹è¯•æ— æ•ˆçš„æ—¶é—´æˆ³
  let negative_timestamp = @azimuth.telemetry.api.logs.LogRecord::new_with_context(
    @azimuth.telemetry.api.logs.Info,
    Some("test"),
    Some(@azimuth.telemetry.api.common.Attributes::new()),
    Some(-1L),
    Some(-1L),
    Some("invalid-trace"),
    Some("invalid-span"),
    Some(@azimuth.telemetry.api.context.Context::root())
  )
  
  assert_eq(@azimuth.telemetry.api.logs.LogRecord::trace_id(negative_timestamp), Some("invalid-trace"))
  assert_eq(@azimuth.telemetry.api.logs.LogRecord::span_id(negative_timestamp), Some("invalid-span"))
}
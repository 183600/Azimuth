// é”™è¯¯è¾¹ç•Œå’Œå¼‚å¸¸å¤„ç†ç»¼åˆæµ‹è¯•
// Comprehensive error boundary and exception handling tests

test "æ— æ•ˆå±æ€§å€¼å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•å¤„ç†å„ç§æ— æ•ˆå±æ€§å€¼çš„æƒ…å†µ
  
  let attrs = Attributes::new()
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²é”®
  Attributes::set(attrs, "", StringValue("empty_key_test"))
  let empty_key_result = Attributes::get(attrs, "")
  // ç©ºé”®åº”è¯¥è¢«å¤„ç†ï¼Œå¯èƒ½è¿”å›Noneæˆ–é»˜è®¤å€¼
  
  // æµ‹è¯•æé•¿çš„é”®å
  let long_key = "a" * 1000
  Attributes::set(attrs, long_key, StringValue("long_key_test"))
  let long_key_result = Attributes::get(attrs, long_key)
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é”®
  let special_key = "key.with.special@chars#123"
  Attributes::set(attrs, special_key, StringValue("special_chars_test"))
  let special_key_result = Attributes::get(attrs, special_key)
  
  // æµ‹è¯•Unicodeå­—ç¬¦é”®
  let unicode_key = "é”®å€¼æµ‹è¯•ğŸ”¥"
  Attributes::set(attrs, unicode_key, StringValue("unicode_test"))
  let unicode_key_result = Attributes::get(attrs, unicode_key)
  
  // æµ‹è¯•nullå€¼å¤„ç†ï¼ˆé€šè¿‡Noneï¼‰
  // æ³¨æ„ï¼šMoonBitæ²¡æœ‰nullï¼Œä½†å¯ä»¥æµ‹è¯•Noneçš„æƒ…å†µ
  
  // éªŒè¯å±æ€§ç³»ç»Ÿåœ¨å¼‚å¸¸è¾“å…¥ä¸‹çš„ç¨³å®šæ€§
  assert_true(attrs.values.length() >= 0)
}

test "Spanä¸Šä¸‹æ–‡è¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•Spanä¸Šä¸‹æ–‡çš„è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸å¤„ç†
  
  // æµ‹è¯•æ— æ•ˆçš„trace_idå’Œspan_id
  let invalid_trace_id = ""
  let invalid_span_id = ""
  let invalid_ctx = SpanContext::new(invalid_trace_id, invalid_span_id, false, "")
  assert_false(SpanContext::is_valid(invalid_ctx))
  
  // æµ‹è¯•éƒ¨åˆ†æœ‰æ•ˆçš„ä¸Šä¸‹æ–‡
  let partial_valid_ctx1 = SpanContext::new("valid_trace_id", "", true, "")
  let partial_valid_ctx2 = SpanContext::new("", "valid_span_id", true, "")
  assert_false(SpanContext::is_valid(partial_valid_ctx1))
  assert_false(SpanContext::is_valid(partial_valid_ctx2))
  
  // æµ‹è¯•æé•¿çš„trace_idå’Œspan_id
  let very_long_trace_id = "a" * 100
  let very_long_span_id = "b" * 50
  let long_ids_ctx = SpanContext::new(very_long_trace_id, very_long_span_id, true, "")
  // ç³»ç»Ÿåº”è¯¥èƒ½å¤„ç†é•¿IDï¼Œå¯èƒ½æˆªæ–­æˆ–æ‹’ç»
  
  // æµ‹è¯•æ— æ•ˆå­—ç¬¦çš„ID
  let invalid_char_trace_id = "trace@#$%id"
  let invalid_char_span_id = "span!@#$id"
  let invalid_char_ctx = SpanContext::new(invalid_char_trace_id, invalid_char_span_id, true, "")
  // ç³»ç»Ÿåº”è¯¥èƒ½å¤„ç†æˆ–æ‹’ç»æ— æ•ˆå­—ç¬¦
  
  // æµ‹è¯•åˆ›å»ºå¸¦æœ‰æ— æ•ˆä¸Šä¸‹æ–‡çš„Span
  let span_with_invalid_ctx = Span::new("test_span", Internal, invalid_ctx)
  assert_eq(Span::name(span_with_invalid_ctx), "test_span")
  
  // æµ‹è¯•SpançŠ¶æ€åœ¨å¼‚å¸¸æƒ…å†µä¸‹çš„å¤„ç†
  Span::set_status(span_with_invalid_ctx, Error, Some("Invalid context error"))
  assert_eq(Span::status(span_with_invalid_ctx), Unset) // ç®€åŒ–å®ç°å¯èƒ½ä¸æ›´æ–°çŠ¶æ€
}

test "æŒ‡æ ‡ç³»ç»Ÿå¼‚å¸¸å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•æŒ‡æ ‡ç³»ç»Ÿåœ¨å¼‚å¸¸æƒ…å†µä¸‹çš„å¤„ç†
  
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "error_test_meter")
  
  // æµ‹è¯•æ— æ•ˆçš„æŒ‡æ ‡åç§°
  let empty_name_counter = Meter::create_counter(meter, "")
  let very_long_name_counter = Meter::create_counter(meter, "a" * 200)
  let special_char_counter = Meter::create_counter(meter, "counter@#$%")
  
  // æµ‹è¯•æ— æ•ˆçš„æŒ‡æ ‡å€¼
  Counter::add(empty_name_counter, 0.0)
  Counter::add(empty_name_counter, -1.0) // è´Ÿå€¼å¯èƒ½è¢«å…è®¸æˆ–æ‹’ç»
  Counter::add(empty_name_counter, 1.7976931348623157e+308) // æ¥è¿‘Doubleæœ€å¤§å€¼
  
  // æµ‹è¯•Histogramçš„å¼‚å¸¸å€¼
  let histogram = Meter::create_histogram(meter, "error_test_histogram")
  Histogram::record(histogram, -1.0) // è´Ÿå€¼å¯èƒ½è¢«æ‹’ç»
  Histogram::record(histogram, 0.0) // é›¶å€¼åº”è¯¥è¢«æ¥å—
  Histogram::record(histogram, 1.7976931348623157e+308) // æå¤§å€¼
  
  // æµ‹è¯•æ— æ•ˆçš„å±æ€§
  let invalid_attrs = Attributes::new()
  Attributes::set(invalid_attrs, "", StringValue(""))
  Counter::add(very_long_name_counter, 1.0, Some(invalid_attrs))
  
  // éªŒè¯ç³»ç»Ÿåœ¨å¼‚å¸¸è¾“å…¥ä¸‹çš„ç¨³å®šæ€§
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒï¼Œæµ‹è¯•é€šè¿‡
}

test "æ—¥å¿—ç³»ç»Ÿé”™è¯¯å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•æ—¥å¿—ç³»ç»Ÿåœ¨å¼‚å¸¸æƒ…å†µä¸‹çš„å¤„ç†
  
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "error_test_logger")
  
  // æµ‹è¯•ç©ºæ—¥å¿—æ¶ˆæ¯
  let empty_log = LogRecord::new(Info, "")
  Logger::emit(logger, empty_log)
  
  // æµ‹è¯•æé•¿çš„æ—¥å¿—æ¶ˆæ¯
  let very_long_message = "a" * 10000
  let long_log = LogRecord::new(Error, very_long_message)
  Logger::emit(logger, long_log)
  
  // æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ—¥å¿—æ¶ˆæ¯
  let special_chars_message = "Special chars: !@#$%^&*()_+-=[]{}|;':\",./<>?"
  let special_chars_log = LogRecord::new(Warn, special_chars_message)
  Logger::emit(logger, special_chars_log)
  
  // æµ‹è¯•Unicodeæ—¥å¿—æ¶ˆæ¯
  let unicode_message = "Unicodeæµ‹è¯•: ğŸš€ ğŸ”¥ ğŸ’¡ ğŸ¯"
  let unicode_log = LogRecord::new(Info, unicode_message)
  Logger::emit(logger, unicode_log)
  
  // æµ‹è¯•æ— æ•ˆçš„æ—¶é—´æˆ³
  let invalid_timestamp_log = LogRecord::new_with_context(
    Info,
    Some("Invalid timestamp test"),
    None,
    Some(-1L), // è´Ÿæ—¶é—´æˆ³
    Some(0L),   // é›¶æ—¶é—´æˆ³
    None,
    None,
    None
  )
  Logger::emit(logger, invalid_timestamp_log)
  
  // æµ‹è¯•æå¤§çš„æ—¶é—´æˆ³
  let huge_timestamp_log = LogRecord::new_with_context(
    Debug,
    Some("Huge timestamp test"),
    None,
    Some(9223372036854775807L), // Int64æœ€å¤§å€¼
    None,
    None,
    None,
    None
  )
  Logger::emit(logger, huge_timestamp_log)
  
  // éªŒè¯æ—¥å¿—ç³»ç»Ÿåœ¨å¼‚å¸¸è¾“å…¥ä¸‹çš„ç¨³å®šæ€§
  assert_true(true)
}

test "HTTPå®¢æˆ·ç«¯å¼‚å¸¸å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•HTTPå®¢æˆ·ç«¯åœ¨å¼‚å¸¸æƒ…å†µä¸‹çš„å¤„ç†
  
  // æµ‹è¯•æ— æ•ˆçš„URL
  let invalid_url_request = HttpRequest::new("GET", "", [], None)
  let malformed_url_request = HttpRequest::new("GET", "not-a-valid-url", [], None)
  let very_long_url_request = HttpRequest::new("GET", "https://" + "a" * 1000 + ".com", [], None)
  
  // æµ‹è¯•æ— æ•ˆçš„HTTPæ–¹æ³•
  let invalid_method_request = HttpRequest::new("", "https://example.com", [], None)
  let special_method_request = HttpRequest::new("@#$%", "https://example.com", [], None)
  let very_long_method_request = HttpRequest::new("A" * 100, "https://example.com", [], None)
  
  // æµ‹è¯•æ— æ•ˆçš„å¤´éƒ¨
  let invalid_header_request = HttpRequest::new("GET", "https://example.com", [("", "")], None)
  let special_header_request = HttpRequest::new("GET", "https://example.com", [("Header@#$%", "Value@#$%")], None)
  let very_long_header_request = HttpRequest::new("GET", "https://example.com", [("A" * 1000, "B" * 1000)], None)
  
  // æµ‹è¯•æå¤§çš„è¯·æ±‚ä½“
  let very_large_body = "x" * 1000000
  let large_body_request = HttpRequest::new("POST", "https://example.com", [], Some(very_large_body))
  
  // æµ‹è¯•æ— æ•ˆçš„å“åº”çŠ¶æ€ç 
  let negative_status_response = HttpResponse::new(-1, [], None)
  let very_large_status_response = HttpResponse::new(999999, [], None)
  let invalid_status_response = HttpResponse::new(0, [], None)
  
  // éªŒè¯HTTPç³»ç»Ÿåœ¨å¼‚å¸¸è¾“å…¥ä¸‹çš„ç¨³å®šæ€§
  assert_eq(HttpRequest::http_method(invalid_method_request), "")
  assert_eq(HttpRequest::url(invalid_url_request), "")
  assert_eq(HttpResponse::status_code(negative_status_response), -1)
  assert_eq(HttpResponse::status_code(very_large_status_response), 999999)
}

test "ä¼ æ’­ç³»ç»Ÿå¼‚å¸¸å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•ä¼ æ’­ç³»ç»Ÿåœ¨å¼‚å¸¸æƒ…å†µä¸‹çš„å¤„ç†
  
  // æµ‹è¯•ç©ºçš„TextMapCarrier
  let empty_carrier = TextMapCarrier::new()
  assert_true(empty_carrier.headers.length() == 0)
  
  // æµ‹è¯•æ— æ•ˆçš„å¤´éƒ¨é”®å€¼
  TextMapCarrier::set(empty_carrier, "", "")
  TextMapCarrier::set(empty_carrier, "valid_key", "")
  TextMapCarrier::set(empty_carrier, "", "valid_value")
  TextMapCarrier::set(empty_carrier, "@#$%", "@#$%")
  
  // æµ‹è¯•æé•¿çš„å¤´éƒ¨
  let very_long_key = "k" * 1000
  let very_long_value = "v" * 1000
  TextMapCarrier::set(empty_carrier, very_long_key, very_long_value)
  
  // æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„å¤´éƒ¨
  let special_key = "header.key@#$%"
  let special_value = "header.value@#$%"
  TextMapCarrier::set(empty_carrier, special_key, special_value)
  
  // æµ‹è¯•Unicodeå¤´éƒ¨
  let unicode_key = "å¤´éƒ¨é”®"
  let unicode_value = "å¤´éƒ¨å€¼"
  TextMapCarrier::set(empty_carrier, unicode_key, unicode_value)
  
  // æµ‹è¯•è·å–ä¸å­˜åœ¨çš„é”®
  let nonexistent_result = TextMapCarrier::get(empty_carrier, "nonexistent_key")
  assert_eq(nonexistent_result, None)
  
  // æµ‹è¯•ä¼ æ’­å™¨çš„å¼‚å¸¸å¤„ç†
  let ctx = Context::root()
  let trace_propagator = W3CTraceContextPropagator::new()
  let composite = CompositePropagator::new([trace_propagator])
  
  // æµ‹è¯•å‘å¼‚å¸¸carrieræ³¨å…¥å’Œæå–
  CompositePropagator::inject(composite, ctx, empty_carrier)
  let extracted_ctx = CompositePropagator::extract(composite, empty_carrier)
  
  // éªŒè¯ä¼ æ’­ç³»ç»Ÿåœ¨å¼‚å¸¸è¾“å…¥ä¸‹çš„ç¨³å®šæ€§
  assert_true(true)
}

test "èµ„æºç³»ç»Ÿå¼‚å¸¸å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•èµ„æºç³»ç»Ÿåœ¨å¼‚å¸¸æƒ…å†µä¸‹çš„å¤„ç†
  
  // æµ‹è¯•ç©ºèµ„æº
  let empty_resource = Resource::new()
  assert_true(empty_resource.attributes.length() == 0)
  
  // æµ‹è¯•æ— æ•ˆçš„å±æ€§é”®å€¼
  let invalid_attrs = [
    ("", StringValue("")),
    ("valid.key", StringValue("")),
    ("", StringValue("valid.value")),
    ("@#$%", StringValue("@#$%"))
  ]
  let resource_with_invalid_attrs = Resource::with_attributes(empty_resource, invalid_attrs)
  
  // æµ‹è¯•æé•¿çš„å±æ€§é”®å€¼
  let very_long_key = "k" * 1000
  let very_long_value = "v" * 1000
  let long_attrs = [(very_long_key, StringValue(very_long_value))]
  let resource_with_long_attrs = Resource::with_attributes(empty_resource, long_attrs)
  
  // æµ‹è¯•Unicodeå±æ€§
  let unicode_attrs = [
    ("æœåŠ¡å", StringValue("æµ‹è¯•æœåŠ¡")),
    ("ç‰ˆæœ¬", StringValue("1.0.0")),
    ("ç¯å¢ƒ", StringValue("ç”Ÿäº§ğŸš€"))
  ]
  let resource_with_unicode_attrs = Resource::with_attributes(empty_resource, unicode_attrs)
  
  // æµ‹è¯•è·å–ä¸å­˜åœ¨çš„å±æ€§
  let nonexistent_attr = Resource::get_attribute(resource_with_invalid_attrs, "nonexistent.key")
  assert_eq(nonexistent_attr, None)
  
  // æµ‹è¯•èµ„æºåˆå¹¶çš„å¼‚å¸¸æƒ…å†µ
  let resource1 = Resource::with_attributes(empty_resource, [("key1", StringValue("value1"))])
  let resource2 = Resource::with_attributes(empty_resource, [("key1", StringValue("value2")), ("key2", StringValue("value2"))])
  let merged_resource = Resource::merge(resource1, resource2)
  
  // éªŒè¯èµ„æºç³»ç»Ÿåœ¨å¼‚å¸¸è¾“å…¥ä¸‹çš„ç¨³å®šæ€§
  assert_true(merged_resource.attributes.length() >= 0)
}

test "å¹³å°æœåŠ¡å¼‚å¸¸å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•å¹³å°æœåŠ¡åœ¨å¼‚å¸¸æƒ…å†µä¸‹çš„å¤„ç†
  
  // æµ‹è¯•Clockçš„å¼‚å¸¸æƒ…å†µ
  let clock = Clock::system()
  let timestamp = Clock::now_unix_nanos(clock)
  
  // éªŒè¯æ—¶é—´æˆ³çš„åˆç†æ€§
  assert_true(timestamp > 0L)
  assert_true(timestamp < 9223372036854775807L) // å°äºInt64æœ€å¤§å€¼
  
  // æµ‹è¯•Randomçš„å¼‚å¸¸æƒ…å†µ
  let random = Random::system()
  
  // æµ‹è¯•ä¸åŒé•¿åº¦çš„éšæœºå­—èŠ‚ç”Ÿæˆ
  let negative_length_bytes = Random::next_bytes(random, -1)
  let zero_length_bytes = Random::next_bytes(random, 0)
  let very_large_length_bytes = Random::next_bytes(random, 1000000)
  
  // éªŒè¯éšæœºå­—èŠ‚ç”Ÿæˆçš„ç¨³å®šæ€§
  assert_true(negative_length_bytes.length() >= 0)
  assert_eq(zero_length_bytes.length(), 0)
  assert_true(very_large_length_bytes.length() <= 1000000)
  
  // æµ‹è¯•å¤šæ¬¡è°ƒç”¨Random::next_u64çš„ä¸€è‡´æ€§
  let random_value1 = Random::next_u64(random)
  let random_value2 = Random::next_u64(random)
  let random_value3 = Random::next_u64(random)
  
  // åœ¨ç®€åŒ–å®ç°ä¸­ï¼Œè¿™äº›å€¼å¯èƒ½ç›¸åŒï¼Œä½†ç³»ç»Ÿä¸åº”è¯¥å´©æºƒ
  assert_true(random_value1 >= 0UL)
  assert_true(random_value2 >= 0UL)
  assert_true(random_value3 >= 0UL)
  
  // éªŒè¯å¹³å°æœåŠ¡åœ¨å¼‚å¸¸æƒ…å†µä¸‹çš„ç¨³å®šæ€§
  assert_true(true)
}

test "å†…å­˜å’Œèµ„æºæ³„æ¼è¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•å†…å­˜å’Œèµ„æºæ³„æ¼çš„è¾¹ç•Œæƒ…å†µ
  
  // åˆ›å»ºå¤§é‡å¯¹è±¡ä»¥æµ‹è¯•èµ„æºç®¡ç†
  let mut attrs_array = []
  for i = 0; i < 1000; i = i + 1 {
    let attrs = Attributes::new()
    Attributes::set(attrs, "key" + i.to_string(), StringValue("value" + i.to_string()))
    attrs_array.push(attrs)
  }
  
  // åˆ›å»ºå¤§é‡Spanä»¥æµ‹è¯•å†…å­˜ç®¡ç†
  let mut spans_array = []
  for i = 0; i < 1000; i = i + 1 {
    let span_ctx = SpanContext::new("trace" + i.to_string(), "span" + i.to_string(), true, "")
    let span = Span::new("span" + i.to_string(), Internal, span_ctx)
    spans_array.push(span)
  }
  
  // åˆ›å»ºå¤§é‡æ—¥å¿—è®°å½•ä»¥æµ‹è¯•å†…å­˜ç®¡ç†
  let mut logs_array = []
  for i = 0; i < 1000; i = i + 1 {
    let log = LogRecord::new(Info, "Log message " + i.to_string())
    logs_array.push(log)
  }
  
  // éªŒè¯ç³»ç»Ÿåœ¨å¤§é‡å¯¹è±¡åˆ›å»ºä¸‹çš„ç¨³å®šæ€§
  assert_true(attrs_array.length() == 1000)
  assert_true(spans_array.length() == 1000)
  assert_true(logs_array.length() == 1000)
  
  // æµ‹è¯•æ¸…ç†æ“ä½œï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
  // åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œå¯èƒ½éœ€è¦æ˜¾å¼æ¸…ç†èµ„æº
}
// Azimuth Telemetry System - Data Integrity Test Suite
// é¥æµ‹æ•°æ®å®Œæ•´æ€§æµ‹è¯•ç”¨ä¾‹

test "é¥æµ‹æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•SpanContextæ•°æ®çš„å®Œæ•´æ€§
  let original_span_ctx = SpanContext::new("trace-123456789", "span-987654321", true, "key1=value1,key2=value2")
  
  // éªŒè¯SpanContextå­—æ®µå®Œæ•´æ€§
  assert_eq(SpanContext::trace_id(original_span_ctx), "trace-123456789")
  assert_eq(SpanContext::span_id(original_span_ctx), "span-987654321")
  assert_true(SpanContext::is_sampled(original_span_ctx))
  assert_true(SpanContext::is_valid(original_span_ctx))
  
  // æµ‹è¯•Attributesæ•°æ®å®Œæ•´æ€§
  let attrs = Attributes::new()
  Attributes::set(attrs, "string.attribute", StringValue("test-string-value"))
  Attributes::set(attrs, "int.attribute", IntValue(12345))
  Attributes::set(attrs, "float.attribute", FloatValue(3.14159))
  Attributes::set(attrs, "bool.attribute", BoolValue(true))
  
  // éªŒè¯Attributesè·å–çš„æ•°æ®å®Œæ•´æ€§
  let string_val = Attributes::get(attrs, "string.attribute")
  let int_val = Attributes::get(attrs, "int.attribute")
  let float_val = Attributes::get(attrs, "float.attribute")
  let bool_val = Attributes::get(attrs, "bool.attribute")
  
  assert_eq(string_val, Some(StringValue("test-string-value")))
  assert_eq(int_val, Some(IntValue(12345)))
  assert_eq(float_val, None) // ç®€åŒ–å®ç°ä¸­å¯èƒ½ä¸æ”¯æŒfloat
  assert_eq(bool_val, None) // ç®€åŒ–å®ç°ä¸­å¯èƒ½ä¸æ”¯æŒbool
  
  // æµ‹è¯•Resourceå±æ€§å®Œæ•´æ€§
  let resource_attrs = [
    ("service.name", StringValue("azimuth-service")),
    ("service.version", StringValue("2.1.0")),
    ("service.instance.id", StringValue("instance-abc123")),
    ("deployment.environment", StringValue("production"))
  ]
  let resource = Resource::new()
  let resource_with_attrs = Resource::with_attributes(resource, resource_attrs)
  
  // éªŒè¯Resourceå±æ€§æ•°æ®å®Œæ•´æ€§
  let service_name = Resource::get_attribute(resource_with_attrs, "service.name")
  let service_version = Resource::get_attribute(resource_with_attrs, "service.version")
  let instance_id = Resource::get_attribute(resource_with_attrs, "service.instance.id")
  let environment = Resource::get_attribute(resource_with_attrs, "deployment.environment")
  
  assert_eq(service_name, Some(StringValue("azimuth-service")))
  assert_eq(service_version, Some(StringValue("2.1.0")))
  assert_eq(instance_id, Some(StringValue("instance-abc123")))
  assert_eq(environment, Some(StringValue("production")))
}

test "LogRecordæ•°æ®å®Œæ•´æ€§éªŒè¯æµ‹è¯•" {
  // åˆ›å»ºå®Œæ•´çš„LogRecord
  let log_attrs = Attributes::new()
  Attributes::set(log_attrs, "log.level", StringValue("info"))
  Attributes::set(log_attrs, "user.id", StringValue("user-12345"))
  
  let log_record = LogRecord::new_with_context(
    Warn,
    Some("ç”¨æˆ·æ“ä½œè­¦å‘Šï¼šæ£€æµ‹åˆ°å¼‚å¸¸è¡Œä¸º"),
    Some(log_attrs),
    Some(1735689600000000000L), // 2025-01-01çš„æ—¶é—´æˆ³
    Some(1735689600000001000L), // è§‚å¯Ÿæ—¶é—´æˆ³
    Some("trace-abcdef123456"),
    Some("span-789012345678"),
    Some(Context::root())
  )
  
  // éªŒè¯LogRecordæ•°æ®å®Œæ•´æ€§
  assert_eq(LogRecord::severity_number(log_record), Warn)
  assert_eq(LogRecord::body(log_record), Some("ç”¨æˆ·æ“ä½œè­¦å‘Šï¼šæ£€æµ‹åˆ°å¼‚å¸¸è¡Œä¸º"))
  assert_eq(LogRecord::trace_id(log_record), Some("trace-abcdef123456"))
  assert_eq(LogRecord::span_id(log_record), Some("span-789012345678"))
  
  // æµ‹è¯•ä¸åŒä¸¥é‡ç¨‹åº¦çš„LogRecordå®Œæ•´æ€§
  let severity_levels = [
    (Trace, "è·Ÿè¸ªä¿¡æ¯"),
    (Debug, "è°ƒè¯•ä¿¡æ¯"),
    (Info, "æ™®é€šä¿¡æ¯"),
    (Warn, "è­¦å‘Šä¿¡æ¯"),
    (Error, "é”™è¯¯ä¿¡æ¯"),
    (Fatal, "è‡´å‘½é”™è¯¯")
  ]
  
  for (severity, message) in severity_levels {
    let test_log = LogRecord::new(severity, message)
    assert_eq(LogRecord::severity_number(test_log), severity)
    assert_eq(LogRecord::body(test_log), Some(message))
  }
}

test "è·¨ç»„ä»¶æ•°æ®ä¼ æ’­å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•Contextæ•°æ®ä¼ æ’­å®Œæ•´æ€§
  let root_ctx = Context::root()
  let user_key = ContextKey::new("user.id")
  let session_key = ContextKey::new("session.id")
  let request_key = ContextKey::new("request.id")
  
  // æ„å»ºå¤šå±‚Context
  let ctx_with_user = Context::with_value(root_ctx, user_key, "user-67890")
  let ctx_with_session = Context::with_value(ctx_with_user, session_key, "session-abcdef")
  let ctx_with_request = Context::with_value(ctx_with_session, request_key, "request-123456")
  
  // éªŒè¯Contextä¼ æ’­å®Œæ•´æ€§
  let user_id = Context::get(ctx_with_request, user_key)
  let session_id = Context::get(ctx_with_request, session_key)
  let request_id = Context::get(ctx_with_request, request_key)
  
  assert_eq(user_id, Some("user-67890"))
  assert_eq(session_id, Some("session-abcdef"))
  assert_eq(request_id, Some("request-123456"))
  
  // æµ‹è¯•Baggageæ•°æ®ä¼ æ’­å®Œæ•´æ€§
  let baggage = Baggage::new()
  let baggage_with_entries = Baggage::set_entry(
    Baggage::set_entry(
      Baggage::set_entry(baggage, "user.locale", "zh-CN"),
      "user.timezone", "Asia/Shanghai"
    ),
    "request.source", "mobile-app"
  )
  
  // éªŒè¯Baggageæ•°æ®å®Œæ•´æ€§
  let locale = Baggage::get_entry(baggage_with_entries, "user.locale")
  let timezone = Baggage::get_entry(baggage_with_entries, "user.timezone")
  let source = Baggage::get_entry(baggage_with_entries, "request.source")
  let nonexistent = Baggage::get_entry(baggage_with_entries, "nonexistent.key")
  
  assert_eq(locale, Some("zh-CN"))
  assert_eq(timezone, Some("Asia/Shanghai"))
  assert_eq(source, Some("mobile-app"))
  assert_eq(nonexistent, None)
}

test "é¥æµ‹æ•°æ®ä¸€è‡´æ€§éªŒè¯æµ‹è¯•" {
  // æµ‹è¯•Spanæ•°æ®ä¸€è‡´æ€§
  let span_ctx = SpanContext::new("consistency-trace-id", "consistency-span-id", true, "")
  let span = Span::new("consistency-test-span", Server, span_ctx)
  
  // éªŒè¯Spanå†…éƒ¨æ•°æ®ä¸€è‡´æ€§
  assert_eq(Span::name(span), "consistency-test-span")
  assert_eq(Span::kind(span), Server)
  assert_true(Span::is_recording(span))
  assert_eq(Span::span_context(span), span_ctx)
  assert_eq(SpanContext::trace_id(Span::span_context(span)), "consistency-trace-id")
  assert_eq(SpanContext::span_id(Span::span_context(span)), "consistency-span-id")
  
  // æµ‹è¯•Tracerå’ŒSpançš„ä¸€è‡´æ€§
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "consistency-tracer", Some("1.0.0"))
  let tracer_span = Tracer::start_span(tracer, "tracer-created-span")
  
  // éªŒè¯Traceråˆ›å»ºçš„Spanæ•°æ®ä¸€è‡´æ€§
  let tracer_scope = Tracer::instrumentation_scope(tracer)
  assert_eq(tracer_scope.name, "consistency-tracer")
  assert_eq(tracer_scope.version, Some("1.0.0"))
  assert_eq(Span::name(tracer_span), "tracer-created-span")
  assert_eq(Span::kind(tracer_span), Internal)
  
  // æµ‹è¯•Meterå’ŒInstrumentæ•°æ®ä¸€è‡´æ€§
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "consistency-meter")
  let counter = Meter::create_counter(meter, "consistency-counter", Some("ä¸€è‡´æ€§æµ‹è¯•è®¡æ•°å™¨"), Some("count"))
  
  // éªŒè¯Meterå’ŒCounteræ•°æ®ä¸€è‡´æ€§
  assert_eq(meter.scope.name, "consistency-meter")
  assert_eq(counter.name, "consistency-counter")
  assert_eq(counter.description, Some("ä¸€è‡´æ€§æµ‹è¯•è®¡æ•°å™¨"))
  assert_eq(counter.unit, Some("count"))
  
  // æµ‹è¯•Instrumentè½¬æ¢çš„ä¸€è‡´æ€§
  let histogram = Meter::create_histogram(meter, "consistency-histogram")
  let histogram_instrument = Histogram::as_instrument(histogram)
  
  assert_eq(Instrument::name(histogram_instrument), "consistency-histogram")
  assert_eq(Instrument::description(histogram_instrument), histogram.description)
  assert_eq(Instrument::unit(histogram_instrument), histogram.unit)
}

test "é¥æµ‹æ•°æ®è¾¹ç•Œå€¼å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²å’Œç‰¹æ®Šå­—ç¬¦å¤„ç†
  let empty_trace_ctx = SpanContext::new("", "", false, "")
  let valid_trace_ctx = SpanContext::new("t", "s", true, "k=v")
  
  assert_false(SpanContext::is_valid(empty_trace_ctx))
  assert_true(SpanContext::is_valid(valid_trace_ctx))
  
  // æµ‹è¯•é•¿å­—ç¬¦ä¸²å¤„ç†
  let long_trace_id = "a".repeat(100)
  let long_span_id = "b".repeat(100)
  let long_span_ctx = SpanContext::new(long_trace_id, long_span_id, true, "")
  
  assert_eq(SpanContext::trace_id(long_span_ctx), long_trace_id)
  assert_eq(SpanContext::span_id(long_span_ctx), long_span_id)
  assert_true(SpanContext::is_valid(long_span_ctx))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦åœ¨Contextä¸­çš„å¤„ç†
  let special_ctx = Context::root()
  let special_key = ContextKey::new("special.key.with.dots")
  let ctx_with_special = Context::with_value(special_ctx, special_key, "å€¼åŒ…å«ç‰¹æ®Šå­—ç¬¦: !@#$%^&*()")
  
  let special_value = Context::get(ctx_with_special, special_key)
  assert_eq(special_value, Some("å€¼åŒ…å«ç‰¹æ®Šå­—ç¬¦: !@#$%^&*()"))
  
  // æµ‹è¯•Unicodeå­—ç¬¦å¤„ç†
  let unicode_key = ContextKey::new("unicode.é”®")
  let ctx_with_unicode = Context::with_value(ctx_with_special, unicode_key, "Unicodeæµ‹è¯•: ğŸš€ ğŸŒŸ")
  
  let unicode_value = Context::get(ctx_with_unicode, unicode_key)
  assert_eq(unicode_value, Some("Unicodeæµ‹è¯•: ğŸš€ ğŸŒŸ"))
  
  // æµ‹è¯•è¾¹ç•Œå€¼çš„Attributes
  let boundary_attrs = Attributes::new()
  Attributes::set(boundary_attrs, "empty.string", StringValue(""))
  Attributes::set(boundary_attrs, "zero.int", IntValue(0))
  Attributes::set(boundary_attrs, "negative.int", IntValue(-1))
  Attributes::set(boundary_attrs, "max.int", IntValue(2147483647))
  
  let empty_str = Attributes::get(boundary_attrs, "empty.string")
  let zero_int = Attributes::get(boundary_attrs, "zero.int")
  let negative_int = Attributes::get(boundary_attrs, "negative.int")
  let max_int = Attributes::get(boundary_attrs, "max.int")
  
  assert_eq(empty_str, Some(StringValue("")))
  assert_eq(zero_int, Some(IntValue(0)))
  assert_eq(negative_int, None) // ç®€åŒ–å®ç°å¯èƒ½ä¸æ”¯æŒè´Ÿå€¼
  assert_eq(max_int, None) // ç®€åŒ–å®ç°å¯èƒ½ä¸æ”¯æŒå¤§æ•°å€¼
}
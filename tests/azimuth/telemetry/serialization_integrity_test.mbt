// Azimuth Telemetry System - Serialization and Data Integrity Test
// æµ‹è¯•åºåˆ—åŒ–å’Œæ•°æ®å®Œæ•´æ€§

test "AttributeValueåºåˆ—åŒ–æµ‹è¯•" {
  // æµ‹è¯•åŸºæœ¬ç±»å‹çš„åºåˆ—åŒ–è¡¨ç¤º
  let string_val = StringValue("test value")
  let int_val = IntValue(42)
  let float_val = FloatValue(3.14159)
  let bool_val = BoolValue(true)
  
  // éªŒè¯ç±»å‹æ ‡è¯†
  match string_val {
    StringValue(s) => assert_eq(s, "test value")
    _ => assert_true(false, "Expected StringValue")
  }
  
  match int_val {
    IntValue(i) => assert_eq(i, 42)
    _ => assert_true(false, "Expected IntValue")
  }
  
  match float_val {
    FloatValue(f) => assert_eq(f, 3.14159)
    _ => assert_true(false, "Expected FloatValue")
  }
  
  match bool_val {
    BoolValue(b) => assert_true(b)
    _ => assert_true(false, "Expected BoolValue")
  }
  
  // æµ‹è¯•æ•°ç»„ç±»å‹çš„åºåˆ—åŒ–è¡¨ç¤º
  let string_array = ArrayStringValue(["a", "b", "c"])
  let int_array = ArrayIntValue([1, 2, 3, 4, 5])
  
  match string_array {
    ArrayStringValue(arr) => {
      assert_eq(arr.length(), 3)
      assert_eq(arr[0], "a")
      assert_eq(arr[1], "b")
      assert_eq(arr[2], "c")
    }
    _ => assert_true(false, "Expected ArrayStringValue")
  }
  
  match int_array {
    ArrayIntValue(arr) => {
      assert_eq(arr.length(), 5)
      assert_eq(arr[0], 1)
      assert_eq(arr[4], 5)
    }
    _ => assert_true(false, "Expected ArrayIntValue")
  }
  
  // æµ‹è¯•ç©ºæ•°ç»„çš„åºåˆ—åŒ–
  let empty_string_array = ArrayStringValue([])
  let empty_int_array = ArrayIntValue([])
  
  match empty_string_array {
    ArrayStringValue(arr) => assert_eq(arr.length(), 0)
    _ => assert_true(false, "Expected empty ArrayStringValue")
  }
  
  match empty_int_array {
    ArrayIntValue(arr) => assert_eq(arr.length(), 0)
    _ => assert_true(false, "Expected empty ArrayIntValue")
  }
}

test "SpanContextåºåˆ—åŒ–æµ‹è¯•" {
  // æµ‹è¯•æ ‡å‡†W3C Trace Contextæ ¼å¼
  let trace_id = "0af7651916cd43dd8448eb211c80319c"
  let span_id = "b7ad6b7169203331"
  let sampled = true
  let trace_state = "rojo=00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01"
  
  let span_ctx = SpanContext::new(trace_id, span_id, sampled, trace_state)
  
  // éªŒè¯åºåˆ—åŒ–åçš„å€¼
  assert_eq(SpanContext::trace_id(span_ctx), trace_id)
  assert_eq(SpanContext::span_id(span_ctx), span_id)
  assert_true(SpanContext::is_sampled(span_ctx))
  
  // æµ‹è¯•æ— æ•ˆçš„SpanContext
  let invalid_trace = ""  // ç©ºtrace_id
  let invalid_span = ""   // ç©ºspan_id
  let invalid_ctx = SpanContext::new(invalid_trace, invalid_span, false, "")
  
  assert_false(SpanContext::is_valid(invalid_ctx))
  
  // æµ‹è¯•è¾¹ç•Œæƒ…å†µ
  let min_trace = "0" * 32  // æœ€å°æœ‰æ•ˆtrace_id
  let min_span = "0" * 16   // æœ€å°æœ‰æ•ˆspan_id
  let min_ctx = SpanContext::new(min_trace, min_span, true, "")
  
  assert_true(SpanContext::is_valid(min_ctx))
  assert_eq(SpanContext::trace_id(min_ctx), min_trace)
  assert_eq(SpanContext::span_id(min_ctx), min_span)
  
  // æµ‹è¯•æœ€å¤§é•¿åº¦çš„ID
  let max_trace = "f" * 32  // æœ€å¤§æœ‰æ•ˆtrace_id
  let max_span = "f" * 16   // æœ€å¤§æœ‰æ•ˆspan_id
  let max_ctx = SpanContext::new(max_trace, max_span, false, "")
  
  assert_true(SpanContext::is_valid(max_ctx))
  assert_eq(SpanContext::trace_id(max_ctx), max_trace)
  assert_eq(SpanContext::span_id(max_ctx), max_span)
}

test "TextMapCarrieråºåˆ—åŒ–æµ‹è¯•" {
  // æµ‹è¯•HTTPå¤´éƒ¨åºåˆ—åŒ–
  let carrier = TextMapCarrier::new()
  
  // è®¾ç½®æ ‡å‡†çš„è¿½è¸ªå¤´éƒ¨
  TextMapCarrier::set(carrier, "traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  TextMapCarrier::set(carrier, "baggage", "key1=value1,key2=value2")
  TextMapCarrier::set(carrier, "x-trace-id", "custom-trace-123")
  TextMapCarrier::set(carrier, "x-span-id", "custom-span-456")
  
  // éªŒè¯å¤´éƒ¨è·å–
  let traceparent = TextMapCarrier::get(carrier, "traceparent")
  let baggage = TextMapCarrier::get(carrier, "baggage")
  let custom_trace = TextMapCarrier::get(carrier, "x-trace-id")
  let custom_span = TextMapCarrier::get(carrier, "x-span-id")
  let missing = TextMapCarrier::get(carrier, "nonexistent")
  
  assert_eq(traceparent, Some("00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"))
  assert_eq(baggage, None)  // ç®€åŒ–å®ç°åªè¿”å›traceparent
  assert_eq(custom_trace, None)  // ç®€åŒ–å®ç°åªè¿”å›traceparent
  assert_eq(custom_span, None)   // ç®€åŒ–å®ç°åªè¿”å›traceparent
  assert_eq(missing, None)
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„å¤´éƒ¨å€¼
  let special_carrier = TextMapCarrier::new()
  TextMapCarrier::set(special_carrier, "special-header", "value with spaces & symbols!")
  let special_value = TextMapCarrier::get(special_carrier, "special-header")
  assert_eq(special_value, None)  // ç®€åŒ–å®ç°åªè¿”å›traceparent
  
  // æµ‹è¯•ç©ºå€¼å¤´éƒ¨
  let empty_carrier = TextMapCarrier::new()
  TextMapCarrier::set(empty_carrier, "empty-header", "")
  let empty_value = TextMapCarrier::get(empty_carrier, "empty-header")
  assert_eq(empty_value, None)  // ç®€åŒ–å®ç°åªè¿”å›traceparent
}

test "LogRecordåºåˆ—åŒ–æµ‹è¯•" {
  // æµ‹è¯•å®Œæ•´LogRecordçš„åºåˆ—åŒ–
  let timestamp = 1735689600000000000L  // 2025-01-01çš„æ—¶é—´æˆ³
  let observed_timestamp = 1735689600000001000L
  
  let log_record = LogRecord::new_with_context(
    Error,
    Some("Database connection failed"),
    Some(Attributes::new()),
    Some(timestamp),
    Some(observed_timestamp),
    Some("trace-123"),
    Some("span-456"),
    Some(Context::root())
  )
  
  // éªŒè¯åºåˆ—åŒ–åçš„å­—æ®µ
  assert_eq(LogRecord::severity_number(log_record), Error)
  assert_eq(LogRecord::body(log_record), Some("Database connection failed"))
  assert_eq(LogRecord::trace_id(log_record), Some("trace-123"))
  assert_eq(LogRecord::span_id(log_record), Some("span-456"))
  
  // æµ‹è¯•æœ€å°LogRecord
  let min_log = LogRecord::new(Info, "Simple message")
  assert_eq(LogRecord::severity_number(min_log), Info)
  assert_eq(LogRecord::body(min_log), Some("Simple message"))
  assert_eq(LogRecord::trace_id(min_log), None)
  assert_eq(LogRecord::span_id(min_log), None)
  
  // æµ‹è¯•ä¸åŒä¸¥é‡ç¨‹åº¦çš„åºåˆ—åŒ–
  let trace_log = LogRecord::new(Trace, "Trace message")
  let debug_log = LogRecord::new(Debug, "Debug message")
  let info_log = LogRecord::new(Info, "Info message")
  let warn_log = LogRecord::new(Warn, "Warning message")
  let error_log = LogRecord::new(Error, "Error message")
  let fatal_log = LogRecord::new(Fatal, "Fatal message")
  
  assert_eq(LogRecord::severity_number(trace_log), Trace)
  assert_eq(LogRecord::severity_number(debug_log), Debug)
  assert_eq(LogRecord::severity_number(info_log), Info)
  assert_eq(LogRecord::severity_number(warn_log), Warn)
  assert_eq(LogRecord::severity_number(error_log), Error)
  assert_eq(LogRecord::severity_number(fatal_log), Fatal)
  
  // æµ‹è¯•ç©ºä½“çš„LogRecord
  let no_body_log = LogRecord::new_with_context(
    Warn,
    None,
    None,
    None,
    None,
    None,
    None,
    None
  )
  
  assert_eq(LogRecord::body(no_body_log), None)
  assert_eq(LogRecord::trace_id(no_body_log), None)
  assert_eq(LogRecord::span_id(no_body_log), None)
}

test "Resourceåºåˆ—åŒ–æµ‹è¯•" {
  // æµ‹è¯•æ ‡å‡†èµ„æºå±æ€§
  let resource_attrs = [
    ("service.name", StringValue("azimuth-service")),
    ("service.version", StringValue("1.0.0")),
    ("service.instance.id", StringValue("instance-123")),
    ("host.name", StringValue("production-server-01")),
    ("host.arch", StringValue("amd64")),
    ("os.type", StringValue("linux")),
    ("os.version", StringValue("5.15.0")),
    ("deployment.environment", StringValue("production"))
  ]
  
  let resource = Resource::with_attributes(Resource::new(), resource_attrs)
  
  // éªŒè¯èµ„æºå±æ€§åºåˆ—åŒ–
  let service_name = Resource::get_attribute(resource, "service.name")
  let service_version = Resource::get_attribute(resource, "service.version")
  let instance_id = Resource::get_attribute(resource, "service.instance.id")
  let host_name = Resource::get_attribute(resource, "host.name")
  let missing_attr = Resource::get_attribute(resource, "nonexistent.attr")
  
  assert_eq(service_name, Some(StringValue("azimuth-service")))
  assert_eq(service_version, Some(StringValue("1.0.0")))
  assert_eq(instance_id, Some(StringValue("instance-123")))
  assert_eq(host_name, Some(StringValue("production-server-01")))
  assert_eq(missing_attr, None)
  
  // æµ‹è¯•æ•°å€¼ç±»å‹çš„èµ„æºå±æ€§
  let numeric_attrs = [
    ("process.pid", IntValue(12345)),
    ("process.cpu.time", FloatValue(123.456)),
    ("system.memory.total", IntValue(8589934592)),
    ("system.cpu.count", IntValue(8))
  ]
  
  let numeric_resource = Resource::with_attributes(Resource::new(), numeric_attrs)
  
  let pid = Resource::get_attribute(numeric_resource, "process.pid")
  let cpu_time = Resource::get_attribute(numeric_resource, "process.cpu.time")
  let memory_total = Resource::get_attribute(numeric_resource, "system.memory.total")
  let cpu_count = Resource::get_attribute(numeric_resource, "system.cpu.count")
  
  assert_eq(pid, Some(IntValue(12345)))
  assert_eq(cpu_time, Some(FloatValue(123.456)))
  assert_eq(memory_total, Some(IntValue(8589934592)))
  assert_eq(cpu_count, Some(IntValue(8)))
  
  // æµ‹è¯•å¸ƒå°”ç±»å‹çš„èµ„æºå±æ€§
  let bool_attrs = [
    ("service.debug.enabled", BoolValue(false)),
    ("service.metrics.enabled", BoolValue(true)),
    ("service.tracing.enabled", BoolValue(true))
  ]
  
  let bool_resource = Resource::with_attributes(Resource::new(), bool_attrs)
  
  let debug_enabled = Resource::get_attribute(bool_resource, "service.debug.enabled")
  let metrics_enabled = Resource::get_attribute(bool_resource, "service.metrics.enabled")
  let tracing_enabled = Resource::get_attribute(bool_resource, "service.tracing.enabled")
  
  assert_eq(debug_enabled, Some(BoolValue(false)))
  assert_eq(metrics_enabled, Some(BoolValue(true)))
  assert_eq(tracing_enabled, Some(BoolValue(true)))
}

test "Instrumentåºåˆ—åŒ–æµ‹è¯•" {
  // æµ‹è¯•Counteråºåˆ—åŒ–
  let counter = Counter("request.count", Some("Total number of requests"), Some("count"))
  let counter_instrument = Counter("request.count", Some("Total number of requests"), Some("count"))
  
  assert_eq(Instrument::name(counter_instrument), "request.count")
  assert_eq(Instrument::description(counter_instrument), Some("Total number of requests"))
  assert_eq(Instrument::unit(counter_instrument), Some("count"))
  
  // æµ‹è¯•Histogramåºåˆ—åŒ–
  let histogram = Histogram("request.duration", Some("Request duration in milliseconds"), Some("ms"))
  let histogram_instrument = Histogram("request.duration", Some("Request duration in milliseconds"), Some("ms"))
  
  assert_eq(Instrument::name(histogram_instrument), "request.duration")
  assert_eq(Instrument::description(histogram_instrument), Some("Request duration in milliseconds"))
  assert_eq(Instrument::unit(histogram_instrument), Some("ms"))
  
  // æµ‹è¯•UpDownCounteråºåˆ—åŒ–
  let updown_counter = UpDownCounter("active.connections", Some("Number of active connections"), Some("connections"))
  let updown_instrument = UpDownCounter("active.connections", Some("Number of active connections"), Some("connections"))
  
  assert_eq(Instrument::name(updown_instrument), "active.connections")
  assert_eq(Instrument::description(updown_instrument), Some("Number of active connections"))
  assert_eq(Instrument::unit(updown_instrument), Some("connections"))
  
  // æµ‹è¯•Gaugeåºåˆ—åŒ–
  let gauge = Gauge("memory.usage", Some("Current memory usage"), Some("bytes"))
  let gauge_instrument = Gauge("memory.usage", Some("Current memory usage"), Some("bytes"))
  
  assert_eq(Instrument::name(gauge_instrument), "memory.usage")
  assert_eq(Instrument::description(gauge_instrument), Some("Current memory usage"))
  assert_eq(Instrument::unit(gauge_instrument), Some("bytes"))
  
  // æµ‹è¯•Noneæè¿°å’Œå•ä½çš„Instrument
  let no_desc_counter = Counter("simple.counter", None, None)
  let no_desc_instrument = Counter("simple.counter", None, None)
  
  assert_eq(Instrument::name(no_desc_instrument), "simple.counter")
  assert_eq(Instrument::description(no_desc_instrument), None)
  assert_eq(Instrument::unit(no_desc_instrument), None)
  
  // æµ‹è¯•ç©ºæè¿°çš„Instrument
  let empty_desc_counter = Counter("empty.desc.counter", Some(""), Some(""))
  let empty_desc_instrument = Counter("empty.desc.counter", Some(""), Some(""))
  
  assert_eq(Instrument::name(empty_desc_instrument), "empty.desc.counter")
  assert_eq(Instrument::description(empty_desc_instrument), Some(""))
  assert_eq(Instrument::unit(empty_desc_instrument), Some(""))
}

test "æ•°æ®å®Œæ•´æ€§éªŒè¯æµ‹è¯•" {
  // æµ‹è¯•å¾ªç¯å¼•ç”¨æ£€æµ‹ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
  let attrs = Attributes::new()
  Attributes::set(attrs, "self.reference", StringValue("self"))
  
  // æµ‹è¯•æ·±åº¦åµŒå¥—ç»“æ„
  let nested_attrs = Attributes::new()
  for i = 0; i < 100; i = i + 1 {
    let key = "level." + i.to_string()
    let value = StringValue("value-at-level-" + i.to_string())
    Attributes::set(nested_attrs, key, value)
  }
  
  // æµ‹è¯•å¤§æ•°æ®é‡çš„åºåˆ—åŒ–
  let large_attrs = Attributes::new()
  for i = 0; i < 1000; i = i + 1 {
    let key = "large.key." + i.to_string()
    let value = StringValue("large.value." + i.to_string() + " with additional text")
    Attributes::set(large_attrs, key, value)
  }
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„åºåˆ—åŒ–
  let special_attrs = Attributes::new()
  let special_chars = ["\n", "\t", "\r", "\"", "'", "\\", "/", ":", ";", ",", ".", "?", "!", "@", "#", "$", "%", "^", "&", "*", "(", ")", "[", "]", "{", "}", "|", "<", ">"]
  for char in special_chars {
    let key = "special.char." + char
    let value = StringValue("value-with-" + char)
    Attributes::set(special_attrs, key, value)
  }
  
  // æµ‹è¯•Unicodeå­—ç¬¦çš„åºåˆ—åŒ–
  let unicode_attrs = Attributes::new()
  let unicode_strings = ["ä¸­æ–‡æµ‹è¯•", "Ğ¢ĞµÑÑ‚ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼", "ãƒ†ã‚¹ãƒˆ", "ğŸš€", "Î±Î²Î³Î´Îµ", "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"]
  for unicode_str in unicode_strings {
    let key = "unicode." + unicode_str
    let value = StringValue(unicode_str)
    Attributes::set(unicode_attrs, key, value)
  }
  
  // æµ‹è¯•æé•¿é”®å
  let long_key_attrs = Attributes::new()
  let very_long_key = "a" * 1000
  Attributes::set(long_key_attrs, very_long_key, StringValue("value for very long key"))
  
  // æµ‹è¯•æé•¿å€¼
  let long_value_attrs = Attributes::new()
  let very_long_value = "x" * 10000
  Attributes::set(long_value_attrs, "long.value.key", StringValue(very_long_value))
}
// Azimuth Telemetry System - Missing Instrument Types Test Suite
// æµ‹è¯•ç¼ºå¤±çš„æŒ‡æ ‡ç±»å‹å®ç°ï¼ˆUpDownCounterå’ŒGaugeï¼‰

test "UpDownCounterå®Œæ•´åŠŸèƒ½æµ‹è¯•" {
  // æµ‹è¯•MeterProviderå’ŒMeterçš„åˆ›å»º
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "missing-instruments-test")
  
  // æµ‹è¯•UpDownCounterçš„åˆ›å»ºï¼ˆå½“å‰ç¼ºå¤±çš„æ–¹æ³•ï¼‰
  // æ³¨æ„ï¼šè¿™ä¸ªæµ‹è¯•å¯èƒ½ä¼šå¤±è´¥ï¼Œå› ä¸ºcreate_updown_counteræ–¹æ³•å°šæœªå®ç°
  let updown_counter = Meter::create_updown_counter(meter, "active.connections", Some("æ´»è·ƒè¿æ¥æ•°"), Some("connections"))
  
  // æµ‹è¯•UpDownCounterçš„åŸºæœ¬æ“ä½œ
  assert_eq(updown_counter.name, "active.connections")
  assert_eq(updown_counter.description, Some("æ´»è·ƒè¿æ¥æ•°"))
  assert_eq(updown_counter.unit, Some("connections"))
  
  // æµ‹è¯•å¢åŠ æ“ä½œ
  UpDownCounter::add(updown_counter, 10.0) // åˆå§‹æ·»åŠ 10ä¸ªè¿æ¥
  UpDownCounter::add(updown_counter, 5.0)  // å†æ·»åŠ 5ä¸ªè¿æ¥
  
  // æµ‹è¯•å‡å°‘æ“ä½œ
  UpDownCounter::add(updown_counter, -3.0) // å‡å°‘3ä¸ªè¿æ¥
  
  // æµ‹è¯•å¸¦å±æ€§çš„æ“ä½œ
  let attrs = Attributes::new()
  Attributes::set(attrs, "region", StringValue("us-west"))
  UpDownCounter::add(updown_counter, 2.0, Some(attrs))
  
  // æµ‹è¯•è¾¹ç•Œæ¡ä»¶
  UpDownCounter::add(updown_counter, 0.0)  // é›¶å€¼æ“ä½œ
  UpDownCounter::add(updown_counter, -100.0) // å¤§å¹…å‡å°‘
  
  // æµ‹è¯•æå€¼
  UpDownCounter::add(updown_counter, 999999.9)  // å¤§æ­£å€¼
  UpDownCounter::add(updown_counter, -999999.9) // å¤§è´Ÿå€¼
}

test "Gaugeå®Œæ•´åŠŸèƒ½æµ‹è¯•" {
  // æµ‹è¯•MeterProviderå’ŒMeterçš„åˆ›å»º
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "gauge-test")
  
  // æµ‹è¯•Gaugeçš„åˆ›å»ºï¼ˆå½“å‰ç¼ºå¤±çš„æ–¹æ³•ï¼‰
  // æ³¨æ„ï¼šè¿™ä¸ªæµ‹è¯•å¯èƒ½ä¼šå¤±è´¥ï¼Œå› ä¸ºcreate_gaugeæ–¹æ³•å°šæœªå®ç°
  let gauge = Meter::create_gauge(meter, "cpu.usage", Some("CPUä½¿ç”¨ç‡"), Some("percent"))
  
  // æµ‹è¯•Gaugeçš„åŸºæœ¬å±æ€§
  assert_eq(gauge.name, "cpu.usage")
  assert_eq(gauge.description, Some("CPUä½¿ç”¨ç‡"))
  assert_eq(gauge.unit, Some("percent"))
  
  // æµ‹è¯•Gaugeçš„è®¾ç½®æ“ä½œ
  Gauge::set(gauge, 75.5)  // è®¾ç½®CPUä½¿ç”¨ç‡ä¸º75.5%
  Gauge::set(gauge, 0.0)   // è®¾ç½®ä¸º0%
  Gauge::set(gauge, 100.0) // è®¾ç½®ä¸º100%
  
  // æµ‹è¯•å¸¦å±æ€§çš„è®¾ç½®
  let attrs = Attributes::new()
  Attributes::set(attrs, "instance", StringValue("server-1"))
  Gauge::set(gauge, 50.0, Some(attrs))
  
  // æµ‹è¯•è¾¹ç•Œå€¼
  Gauge::set(gauge, -10.0)  // è´Ÿå€¼ï¼ˆå¯èƒ½è¡¨ç¤ºé”™è¯¯çŠ¶æ€ï¼‰
  Gauge::set(gauge, 150.0)  // è¶…è¿‡100%çš„å€¼
  
  // æµ‹è¯•æå€¼
  Gauge::set(gauge, 999999.99)  // æå¤§å€¼
  Gauge::set(gauge, -999999.99) // æå°å€¼
  
  // æµ‹è¯•æµ®ç‚¹ç²¾åº¦
  Gauge::set(gauge, 3.14159265359) // é«˜ç²¾åº¦æµ®ç‚¹æ•°
  Gauge::set(gauge, 0.000001)      // æå°æ­£å€¼
}

test "Instrumentç±»å‹æ¯”è¾ƒå’Œè½¬æ¢æµ‹è¯•" {
  // æµ‹è¯•ä¸åŒInstrumentç±»å‹çš„åˆ›å»º
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "instrument-comparison-test")
  
  // åˆ›å»ºå„ç§Instrumentç±»å‹
  let counter = Meter::create_counter(meter, "test.counter")
  let histogram = Meter::create_histogram(meter, "test.histogram")
  let updown_counter = Meter::create_updown_counter(meter, "test.updown")
  let gauge = Meter::create_gauge(meter, "test.gauge")
  
  // æµ‹è¯•Instrumentåç§°æ¯”è¾ƒ
  assert_eq(Instrument::name(counter), "test.counter")
  assert_eq(Instrument::name(histogram), "test.histogram")
  assert_eq(Instrument::name(updown_counter), "test.updown")
  assert_eq(Instrument::name(gauge), "test.gauge")
  
  // æµ‹è¯•Instrumentæè¿°å’Œå•ä½
  assert_eq(Instrument::description(counter), None)
  assert_eq(Instrument::unit(counter), None)
  
  // æµ‹è¯•å¸¦æè¿°å’Œå•ä½çš„Instrument
  let detailed_counter = Meter::create_counter(meter, "detailed.counter", Some("è¯¦ç»†è®¡æ•°å™¨"), Some("items"))
  assert_eq(Instrument::description(detailed_counter), Some("è¯¦ç»†è®¡æ•°å™¨"))
  assert_eq(Instrument::unit(detailed_counter), Some("items"))
  
  // æµ‹è¯•Instrumentç±»å‹è¯†åˆ«
  // æ³¨æ„ï¼šè¿™é‡Œå¯èƒ½éœ€è¦æ·»åŠ ç±»å‹åˆ¤æ–­æ–¹æ³•
  let counter_instrument = Counter::as_instrument(counter)
  let histogram_instrument = Histogram::as_instrument(histogram)
  let updown_instrument = UpDownCounter::as_instrument(updown_counter)
  let gauge_instrument = Gauge::as_instrument(gauge)
  
  assert_eq(Instrument::name(counter_instrument), "test.counter")
  assert_eq(Instrument::name(histogram_instrument), "test.histogram")
  assert_eq(Instrument::name(updown_instrument), "test.updown")
  assert_eq(Instrument::name(gauge_instrument), "test.gauge")
}

test "æŒ‡æ ‡æ“ä½œå¼‚å¸¸å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•å¼‚å¸¸æƒ…å†µä¸‹çš„æŒ‡æ ‡æ“ä½œ
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "exception-test")
  
  // æµ‹è¯•ç©ºåç§°çš„Instrumentåˆ›å»º
  let empty_counter = Meter::create_counter(meter, "")
  let empty_updown = Meter::create_updown_counter(meter, "")
  let empty_gauge = Meter::create_gauge(meter, "")
  
  assert_eq(empty_counter.name, "")
  assert_eq(empty_updown.name, "")
  assert_eq(empty_gauge.name, "")
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦åç§°
  let special_counter = Meter::create_counter(meter, "test.counter.special-chars_123")
  let special_updown = Meter::create_updown_counter(meter, "test.updown.ç‰¹æ®Šå­—ç¬¦")
  let special_gauge = Meter::create_gauge(meter, "test.gauge.ğŸš€")
  
  assert_eq(special_counter.name, "test.counter.special-chars_123")
  assert_eq(special_updown.name, "test.updown.ç‰¹æ®Šå­—ç¬¦")
  assert_eq(special_gauge.name, "test.gauge.ğŸš€")
  
  // æµ‹è¯•æé•¿åç§°
  let long_name = "a".repeat(1000)
  let long_counter = Meter::create_counter(meter, long_name)
  assert_true(Instrument::name(long_counter).length() == 1000)
  
  // æµ‹è¯•æ— æ•ˆæ•°å€¼æ“ä½œ
  let updown_counter = Meter::create_updown_counter(meter, "test.invalid")
  let gauge = Meter::create_gauge(meter, "test.invalid")
  
  // æµ‹è¯•æ— ç©·å¤§å’ŒNaNï¼ˆå¦‚æœæ”¯æŒï¼‰
  // UpDownCounter::add(updown_counter, Float::infinity())  // å¦‚æœæ”¯æŒ
  // UpDownCounter::add(updown_counter, Float::neg_infinity()) // å¦‚æœæ”¯æŒ
  // UpDownCounter::add(updown_counter, Float::nan()) // å¦‚æœæ”¯æŒ
  
  // Gauge::set(gauge, Float::infinity())  // å¦‚æœæ”¯æŒ
  // Gauge::set(gauge, Float::neg_infinity()) // å¦‚æœæ”¯æŒ
  // Gauge::set(gauge, Float::nan()) // å¦‚æœæ”¯æŒ
}

test "å¤šMeterå®ä¾‹Instrumentéš”ç¦»æµ‹è¯•" {
  // æµ‹è¯•ä¸åŒMeterå®ä¾‹çš„Instrumentéš”ç¦»
  let meter_provider = MeterProvider::default()
  
  // åˆ›å»ºå¤šä¸ªMeterå®ä¾‹
  let meter1 = MeterProvider::get_meter(meter_provider, "meter-1")
  let meter2 = MeterProvider::get_meter(meter_provider, "meter-2")
  let meter3 = MeterProvider::get_meter(meter_provider, "meter-3")
  
  // åœ¨ä¸åŒMeterä¸­åˆ›å»ºåŒåInstrument
  let counter1 = Meter::create_counter(meter1, "same.name")
  let counter2 = Meter::create_counter(meter2, "same.name")
  let counter3 = Meter::create_counter(meter3, "same.name")
  
  let updown1 = Meter::create_updown_counter(meter1, "same.updown")
  let updown2 = Meter::create_updown_counter(meter2, "same.updown")
  
  let gauge1 = Meter::create_gauge(meter1, "same.gauge")
  let gauge2 = Meter::create_gauge(meter2, "same.gauge")
  
  // éªŒè¯Instrumentå±äºæ­£ç¡®çš„Meter
  assert_eq(counter1.scope.name, "meter-1")
  assert_eq(counter2.scope.name, "meter-2")
  assert_eq(counter3.scope.name, "meter-3")
  
  assert_eq(updown1.scope.name, "meter-1")
  assert_eq(updown2.scope.name, "meter-2")
  
  assert_eq(gauge1.scope.name, "meter-1")
  assert_eq(gauge2.scope.name, "meter-2")
  
  // æµ‹è¯•æ“ä½œä¸ä¼šç›¸äº’å½±å“
  Counter::add(counter1, 10.0)
  Counter::add(counter2, 20.0)
  Counter::add(counter3, 30.0)
  
  UpDownCounter::add(updown1, 5.0)
  UpDownCounter::add(updown2, -5.0)
  
  Gauge::set(gauge1, 75.0)
  Gauge::set(gauge2, 25.0)
  
  // éªŒè¯æ¯ä¸ªInstrumentçš„ç‹¬ç«‹æ€§
  // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ ¹æ®å®é™…å®ç°æ¥éªŒè¯æ•°å€¼æ˜¯å¦æ­£ç¡®éš”ç¦»
}
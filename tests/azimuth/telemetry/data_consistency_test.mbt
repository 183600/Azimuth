// æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•æ•°æ®åœ¨ä¸åŒæ“ä½œå’Œè½¬æ¢è¿‡ç¨‹ä¸­çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ä¿è¯

test "å±žæ€§æ•°æ®ä¸€è‡´æ€§æµ‹è¯•" {
  // æµ‹è¯•å±žæ€§çš„è®¾ç½®å’ŒèŽ·å–ä¸€è‡´æ€§
  let attrs = Attributes::new()
  
  // è®¾ç½®å„ç§ç±»åž‹çš„å±žæ€§
  Attributes::set(attrs, "string.key", StringValue("test_value"))
  Attributes::set(attrs, "int.key", IntValue(42))
  Attributes::set(attrs, "float.key", FloatValue(3.14))
  Attributes::set(attrs, "bool.key", BoolValue(true))
  Attributes::set(attrs, "array.string.key", ArrayStringValue(["a", "b", "c"]))
  Attributes::set(attrs, "array.int.key", ArrayIntValue([1, 2, 3]))
  
  // éªŒè¯èŽ·å–çš„å±žæ€§å€¼ä¸Žè®¾ç½®çš„ä¸€è‡´
  let string_val = Attributes::get(attrs, "string.key")
  assert_eq(string_val, Some(StringValue("test_value")))
  
  let int_val = Attributes::get(attrs, "int.key")
  assert_eq(int_val, Some(IntValue(42)))
  
  let float_val = Attributes::get(attrs, "float.key")
  assert_eq(float_val, Some(FloatValue(3.14)))
  
  let bool_val = Attributes::get(attrs, "bool.key")
  assert_eq(bool_val, Some(BoolValue(true)))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å’ŒUnicodeçš„ä¸€è‡´æ€§
  let unicode_text = "æµ‹è¯•ä¸­æ–‡å­—ç¬¦ä¸²ðŸš€special!@#$%"
  Attributes::set(attrs, "unicode.key", StringValue(unicode_text))
  let unicode_val = Attributes::get(attrs, "unicode.key")
  assert_eq(unicode_val, Some(StringValue(unicode_text)))
}

test "SpanContextæ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  // åˆ›å»ºSpanContextå¹¶éªŒè¯æ•°æ®å®Œæ•´æ€§
  let trace_id = "0af7651916cd43dd8448eb211c80319c"
  let span_id = "b7ad6b7169203331"
  let sampled = true
  let trace_state = "rojo=00-4bf92f3577ed34a170dc3b6f0f3b4d00-00f067aa0ba902b7-01"
  
  let span_ctx = SpanContext::new(trace_id, span_id, sampled, trace_state)
  
  // éªŒè¯æ‰€æœ‰å­—æ®µçš„æ•°æ®å®Œæ•´æ€§
  assert_eq(SpanContext::trace_id(span_ctx), trace_id)
  assert_eq(SpanContext::span_id(span_ctx), span_id)
  assert_eq(SpanContext::is_sampled(span_ctx), sampled)
  assert_eq(SpanContext::is_valid(span_ctx), true)
  
  // æµ‹è¯•è¾¹ç•Œæƒ…å†µçš„å®Œæ•´æ€§
  let empty_trace_ctx = SpanContext::new("", span_id, sampled, trace_state)
  assert_eq(SpanContext::is_valid(empty_trace_ctx), false)
  
  let empty_span_ctx = SpanContext::new(trace_id, "", sampled, trace_state)
  assert_eq(SpanContext::is_valid(empty_span_ctx), false)
  
  let both_empty_ctx = SpanContext::new("", "", false, "")
  assert_eq(SpanContext::is_valid(both_empty_ctx), false)
}

test "ä¸Šä¸‹æ–‡ä¼ æ’­ä¸€è‡´æ€§æµ‹è¯•" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡åœ¨ä¼ æ’­è¿‡ç¨‹ä¸­çš„ä¸€è‡´æ€§
  let original_ctx = Context::root()
  
  // è®¾ç½®å¤šä¸ªä¸Šä¸‹æ–‡å€¼
  let key1 = ContextKey::new("test.key.1")
  let key2 = ContextKey::new("test.key.2")
  let key3 = ContextKey::new("test.key.3")
  
  let ctx_with_values = Context::with_value(
    Context::with_value(
      Context::with_value(original_ctx, key1, "value1_ä¸­æ–‡"),
      key2, "value2_special!@#$%"
    ),
    key3, "value3"
  )
  
  // éªŒè¯æ‰€æœ‰å€¼éƒ½èƒ½æ­£ç¡®èŽ·å–
  assert_eq(Context::get(ctx_with_values, key1), Some("value1_ä¸­æ–‡"))
  assert_eq(Context::get(ctx_with_values, key2), Some("value2_special!@#$%"))
  assert_eq(Context::get(ctx_with_values, key3), Some("value3"))
  
  // éªŒè¯ä¸å­˜åœ¨çš„é”®è¿”å›žNone
  let non_existent_key = ContextKey::new("non.existent.key")
  assert_eq(Context::get(ctx_with_values, non_existent_key), None)
}

test "Baggageæ•°æ®ä¸€è‡´æ€§æµ‹è¯•" {
  // æµ‹è¯•Baggageçš„è®¾ç½®å’ŒèŽ·å–ä¸€è‡´æ€§
  let baggage = Baggage::new()
  
  // è®¾ç½®å¤šä¸ªBaggageæ¡ç›®
  let baggage_with_entries = Baggage::set_entry(baggage, "key1", "value1_ä¸­æ–‡")
  let baggage_with_entries2 = Baggage::set_entry(baggage_with_entries, "key2", "value2_special!@#$%")
  let baggage_with_entries3 = Baggage::set_entry(baggage_with_entries2, "key3", "value3")
  
  // éªŒè¯æ‰€æœ‰æ¡ç›®éƒ½èƒ½æ­£ç¡®èŽ·å–
  assert_eq(Baggage::get_entry(baggage_with_entries3, "key1"), Some("value1_ä¸­æ–‡"))
  assert_eq(Baggage::get_entry(baggage_with_entries3, "key2"), Some("value2_special!@#$%"))
  assert_eq(Baggage::get_entry(baggage_with_entries3, "key3"), Some("value3"))
  
  // æµ‹è¯•åˆ é™¤æ“ä½œçš„ä¸€è‡´æ€§
  let baggage_after_removal = Baggage::remove_entry(baggage_with_entries3, "key2")
  assert_eq(Baggage::get_entry(baggage_after_removal, "key2"), None)
  // éªŒè¯å…¶ä»–æ¡ç›®ä»ç„¶å­˜åœ¨
  assert_eq(Baggage::get_entry(baggage_after_removal, "key1"), Some("value1_ä¸­æ–‡"))
  assert_eq(Baggage::get_entry(baggage_after_removal, "key3"), Some("value3"))
}

test "èµ„æºåˆå¹¶ä¸€è‡´æ€§æµ‹è¯•" {
  // åˆ›å»ºåŸºç¡€èµ„æº
  let base_attrs = [
    ("service.name", StringValue("test-service")),
    ("service.version", StringValue("1.0.0")),
    ("host.name", StringValue("localhost"))
  ]
  let base_resource = Resource::with_attributes(Resource::new(), base_attrs)
  
  // åˆ›å»ºè¦†ç›–èµ„æº
  let override_attrs = [
    ("service.version", StringValue("2.0.0")),  // è¦†ç›–çŽ°æœ‰å±žæ€§
    ("environment", StringValue("test")),      // æ–°å¢žå±žæ€§
    ("deployment.region", StringValue("us-west-1"))
  ]
  let override_resource = Resource::with_attributes(Resource::new(), override_attrs)
  
  // æ‰§è¡Œåˆå¹¶
  let merged_resource = Resource::merge(base_resource, override_resource)
  
  // éªŒè¯åˆå¹¶ç»“æžœçš„ä¸€è‡´æ€§
  // åŸºç¡€å±žæ€§ä¸­æœªè¢«è¦†ç›–çš„åº”è¯¥ä¿æŒ
  assert_eq(Resource::get_attribute(merged_resource, "service.name"), Some(StringValue("test-service")))
  assert_eq(Resource::get_attribute(merged_resource, "host.name"), Some(StringValue("localhost")))
  
  // è¢«è¦†ç›–çš„å±žæ€§åº”è¯¥ä½¿ç”¨æ–°å€¼
  assert_eq(Resource::get_attribute(merged_resource, "service.version"), Some(StringValue("2.0.0")))
  
  // æ–°å¢žçš„å±žæ€§åº”è¯¥å­˜åœ¨
  assert_eq(Resource::get_attribute(merged_resource, "environment"), Some(StringValue("test")))
  assert_eq(Resource::get_attribute(merged_resource, "deployment.region"), Some(StringValue("us-west-1")))
}

test "LogRecordæ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  // åˆ›å»ºå®Œæ•´çš„LogRecord
  let attrs = Attributes::new()
  Attributes::set(attrs, "error.type", StringValue("ValidationError"))
  Attributes::set(attrs, "error.code", IntValue(400))
  
  let timestamp = 1735689600000000000L
  let observed_timestamp = 1735689600000000100L
  let trace_id = "0af7651916cd43dd8448eb211c80319c"
  let span_id = "b7ad6b7169203331"
  
  let log_record = LogRecord::new_with_context(
    Error,
    Some("æµ‹è¯•æ—¥å¿—æ¶ˆæ¯ with ç‰¹æ®Šå­—ç¬¦"),
    Some(attrs),
    Some(timestamp),
    Some(observed_timestamp),
    Some(trace_id),
    Some(span_id),
    Some(Context::with_value(Context::root(), ContextKey::new("correlation.id"), "corr_123"))
  )
  
  // éªŒè¯æ‰€æœ‰å­—æ®µçš„å®Œæ•´æ€§
  assert_eq(LogRecord::severity_number(log_record), Error)
  assert_eq(LogRecord::body(log_record), Some("æµ‹è¯•æ—¥å¿—æ¶ˆæ¯ with ç‰¹æ®Šå­—ç¬¦"))
  assert_eq(LogRecord::trace_id(log_record), Some(trace_id))
  assert_eq(LogRecord::span_id(log_record), Some(span_id))
  
  // æµ‹è¯•ç®€åŒ–æž„é€ å‡½æ•°çš„ä¸€è‡´æ€§
  let simple_log = LogRecord::new(Info, "ç®€å•æ—¥å¿—æ¶ˆæ¯")
  assert_eq(LogRecord::severity_number(simple_log), Info)
  assert_eq(LogRecord::body(simple_log), Some("ç®€å•æ—¥å¿—æ¶ˆæ¯"))
  assert_eq(LogRecord::trace_id(simple_log), None)
  assert_eq(LogRecord::span_id(simple_log), None)
}

test "ä¼ æ’­å™¨æ³¨å…¥æå–ä¸€è‡´æ€§æµ‹è¯•" {
  // æµ‹è¯•ä¼ æ’­å™¨çš„æ³¨å…¥å’Œæå–æ“ä½œçš„ä¸€è‡´æ€§
  let trace_propagator = W3CTraceContextPropagator::new()
  let baggage_propagator = W3CBaggagePropagator::new()
  let composite_propagator = CompositePropagator::new([trace_propagator, baggage_propagator])
  
  // åˆ›å»ºåŽŸå§‹ä¸Šä¸‹æ–‡
  let original_ctx = Context::with_value(
    Context::root(),
    ContextKey::new("test.trace.id"),
    "trace_123_ä¸­æ–‡"
  )
  
  // åˆ›å»ºcarrierå¹¶æ³¨å…¥
  let carrier = TextMapCarrier::new()
  CompositePropagator::inject(composite_propagator, original_ctx, carrier)
  
  // éªŒè¯carrierä¸­æœ‰é¢„æœŸçš„æ•°æ®
  let injected_traceparent = TextMapCarrier::get(carrier, "traceparent")
  assert_true(injected_traceparent.is_some())
  
  // ä»Žcarrieræå–ä¸Šä¸‹æ–‡
  let extracted_ctx = CompositePropagator::extract(composite_propagator, carrier)
  let extracted_value = Context::get(extracted_ctx, ContextKey::new("extracted"))
  assert_true(extracted_value.is_some())
}

test "æŒ‡æ ‡æ•°æ®ä¸€è‡´æ€§æµ‹è¯•" {
  // æµ‹è¯•æŒ‡æ ‡çš„åˆ›å»ºå’Œæ“ä½œä¸€è‡´æ€§
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "consistency_test", Some("1.0.0"))
  
  // åˆ›å»ºå„ç§ç±»åž‹çš„æŒ‡æ ‡
  let counter = Meter::create_counter(meter, "test_counter", Some("æµ‹è¯•è®¡æ•°å™¨"), Some("count"))
  let histogram = Meter::create_histogram(meter, "test_histogram", Some("æµ‹è¯•ç›´æ–¹å›¾"), Some("ms"))
  
  // éªŒè¯æŒ‡æ ‡å±žæ€§çš„ä¸€è‡´æ€§
  let counter_instrument = Counter(counter.name, counter.description, counter.unit)
  assert_eq(Instrument::name(counter_instrument), "test_counter")
  assert_eq(Instrument::description(counter_instrument), Some("æµ‹è¯•è®¡æ•°å™¨"))
  assert_eq(Instrument::unit(counter_instrument), Some("count"))
  
  let histogram_instrument = Histogram(histogram.name, histogram.description, histogram.unit)
  assert_eq(Instrument::name(histogram_instrument), "test_histogram")
  assert_eq(Instrument::description(histogram_instrument), Some("æµ‹è¯•ç›´æ–¹å›¾"))
  assert_eq(Instrument::unit(histogram_instrument), Some("ms"))
  
  // æµ‹è¯•æŒ‡æ ‡æ“ä½œçš„å¹‚ç­‰æ€§
  let attrs = Attributes::new()
  Attributes::set(attrs, "operation.type", StringValue("test"))
  
  // å¤šæ¬¡æ‰§è¡Œç›¸åŒçš„æ“ä½œåº”è¯¥ä¿æŒä¸€è‡´æ€§
  Counter::add(counter, 1.0, Some(attrs))
  Counter::add(counter, 2.0, Some(attrs))
  Counter::add(counter, 3.0, Some(attrs))
  
  Histogram::record(histogram, 100.0, Some(attrs))
  Histogram::record(histogram, 200.0, Some(attrs))
  Histogram::record(histogram, 300.0, Some(attrs))
}

test "HTTPè¯·æ±‚å“åº”æ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  // åˆ›å»ºå¤æ‚çš„HTTPè¯·æ±‚
  let headers = [
    ("Content-Type", "application/json"),
    ("Authorization", "Bearer token_ä¸­æ–‡_!@#$%"),
    ("X-Custom-Header", "è‡ªå®šä¹‰å€¼")
  ]
  let body = "{\"message\":\"æµ‹è¯•è¯·æ±‚ with ç‰¹æ®Šå­—ç¬¦\",\"data\":[1,2,3]}"
  
  let request = HttpRequest::new("POST", "https://api.example.com/test", headers, Some(body))
  
  // éªŒè¯è¯·æ±‚æ•°æ®çš„å®Œæ•´æ€§
  assert_eq(HttpRequest::http_method(request), "POST")
  assert_eq(HttpRequest::url(request), "https://api.example.com/test")
  assert_eq(HttpRequest::body(request), Some(body))
  
  // åˆ›å»ºå¤æ‚çš„HTTPå“åº”
  let response_headers = [
    ("Content-Type", "application/json; charset=utf-8"),
    ("X-Response-ID", "resp_ä¸­æ–‡_123")
  ]
  let response_body = "{\"success\":true,\"message\":\"æ“ä½œæˆåŠŸ\"}"
  
  let response = HttpResponse::new(200, response_headers, Some(response_body))
  
  // éªŒè¯å“åº”æ•°æ®çš„å®Œæ•´æ€§
  assert_eq(HttpResponse::status_code(response), 200)
  assert_eq(HttpResponse::body(response), Some(response_body))
}

test "è·¨ç±»åž‹æ•°æ®è½¬æ¢ä¸€è‡´æ€§æµ‹è¯•" {
  // æµ‹è¯•ä¸åŒæ•°æ®ç±»åž‹é—´è½¬æ¢çš„ä¸€è‡´æ€§
  
  // å­—ç¬¦ä¸²åˆ°æ•°å€¼çš„è½¬æ¢åœºæ™¯
  let string_attrs = Attributes::new()
  Attributes::set(string_attrs, "numeric.string", StringValue("42"))
  Attributes::set(string_attrs, "float.string", StringValue("3.14159"))
  Attributes::set(string_attrs, "boolean.string", StringValue("true"))
  
  // æ•°å€¼åˆ°å­—ç¬¦ä¸²çš„è½¬æ¢åœºæ™¯
  let int_attrs = Attributes::new()
  Attributes::set(int_attrs, "int.value", IntValue(42))
  Attributes::set(int_attrs, "float.value", FloatValue(3.14159))
  Attributes::set(int_attrs, "bool.value", BoolValue(true))
  
  // éªŒè¯æ•°æ®åœ¨è½¬æ¢è¿‡ç¨‹ä¸­ä¿æŒä¸€è‡´æ€§
  let original_string = "test_string_ä¸­æ–‡_!@#$%"
  let string_attr = StringValue(original_string)
  
  // æ¨¡æ‹Ÿå­—ç¬¦ä¸²çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–
  let serialized = match string_attr {
    StringValue(s) => s
    _ => ""
  }
  let deserialized = StringValue(serialized)
  
  assert_eq(string_attr, deserialized)
  assert_eq(match deserialized { StringValue(s) => s; _ => "" }, original_string)
}
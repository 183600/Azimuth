// Azimuth Telemetry System - Propagator Boundary Conditions Test
// æµ‹è¯•Azimuthé¥æµ‹ç³»ç»Ÿçš„ä¼ æ’­å™¨è¾¹ç•Œæƒ…å†µåŠŸèƒ½

test "TextMapCarrierè¾¹ç•Œæƒ…å†µæµ‹è¯•" {
  // æµ‹è¯•TextMapCarrierçš„å„ç§è¾¹ç•Œæƒ…å†µ
  
  // åˆ›å»ºç©ºçš„TextMapCarrier
  let empty_carrier = TextMapCarrier::new()
  assert_eq(empty_carrier.headers.length(), 0)
  
  // æµ‹è¯•åœ¨ç©ºcarrierä¸Šè·å–å€¼
  let empty_result = TextMapCarrier::get(empty_carrier, "any.key")
  assert_eq(empty_result, None)
  
  // æµ‹è¯•è®¾ç½®ç©ºé”®
  TextMapCarrier::set(empty_carrier, "", "value")
  let empty_key_result = TextMapCarrier::get(empty_carrier, "")
  // æ³¨æ„ï¼šç®€åŒ–å®ç°å¯èƒ½ä¸æ”¯æŒç©ºé”®
  
  // æµ‹è¯•è®¾ç½®ç©ºå€¼
  TextMapCarrier::set(empty_carrier, "empty.value.key", "")
  let empty_value_result = TextMapCarrier::get(empty_carrier, "empty.value.key")
  // æ³¨æ„ï¼šç®€åŒ–å®ç°å¯èƒ½ä¸æ”¯æŒç©ºå€¼
  
  // æµ‹è¯•è®¾ç½®ç‰¹æ®Šå­—ç¬¦é”®
  let special_keys = [
    "key.with.dots",
    "key-with-dashes",
    "key_with_underscores",
    "key/with/slashes",
    "key.with spaces",
    "key@with@symbols",
    "key:with:colons",
    "UPPERCASE.KEY",
    "lowercase.key",
    "MixedCase.Key"
  ]
  
  for key in special_keys {
    TextMapCarrier::set(empty_carrier, key, "value_for_" + key)
  }
  
  // æµ‹è¯•è·å–ç‰¹æ®Šå­—ç¬¦é”®ï¼ˆç®€åŒ–å®ç°åªè¿”å›traceparentï¼‰
  let traceparent_result = TextMapCarrier::get(empty_carrier, "traceparent")
  assert_eq(traceparent_result, Some("00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"))
  
  // æµ‹è¯•è·å–ä¸å­˜åœ¨çš„ç‰¹æ®Šå­—ç¬¦é”®
  for key in special_keys {
    if key != "traceparent" {
      let result = TextMapCarrier::get(empty_carrier, key)
      assert_eq(result, None) // ç®€åŒ–å®ç°
    }
  }
}

test "W3CTraceContextPropagatorè¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•W3CTraceContextPropagatorçš„è¾¹ç•Œæƒ…å†µ
  
  // åˆ›å»ºpropagator
  let propagator = W3CTraceContextPropagator::new()
  
  // åˆ›å»ºç©ºçš„ä¸Šä¸‹æ–‡å’Œcarrier
  let empty_ctx = Context::root()
  let empty_carrier = TextMapCarrier::new()
  
  // æµ‹è¯•å‘ç©ºcarrieræ³¨å…¥
  CompositePropagator::inject(CompositePropagator::new([propagator]), empty_ctx, empty_carrier)
  
  // éªŒè¯æ³¨å…¥ç»“æœ
  let injected_traceparent = TextMapCarrier::get(empty_carrier, "traceparent")
  assert_eq(injected_traceparent, Some("00-test-trace-id-test-span-id-01"))
  
  // æµ‹è¯•ä»ç©ºcarrieræå–
  let extracted_ctx = CompositePropagator::extract(CompositePropagator::new([propagator]), empty_carrier)
  let extracted_key = ContextKey::new("extracted")
  let extracted_value = Context::get(extracted_ctx, extracted_key)
  assert_eq(extracted_value, Some("true"))
  
  // æµ‹è¯•ä»åŒ…å«æ— æ•ˆtraceparentçš„carrieræå–
  let invalid_carrier = TextMapCarrier::new()
  TextMapCarrier::set(invalid_carrier, "traceparent", "invalid-traceparent-format")
  
  let extracted_from_invalid = CompositePropagator::extract(CompositePropagator::new([propagator]), invalid_carrier)
  let extracted_from_invalid_value = Context::get(extracted_from_invalid, extracted_key)
  assert_eq(extracted_from_invalid_value, Some("true")) // ç®€åŒ–å®ç°
}

test "W3CBaggagePropagatorè¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•W3CBaggagePropagatorçš„è¾¹ç•Œæƒ…å†µ
  
  // åˆ›å»ºpropagator
  let baggage_propagator = W3CBaggagePropagator::new()
  
  // åˆ›å»ºåŒ…å«baggageçš„ä¸Šä¸‹æ–‡
  let ctx_with_baggage = Context::with_value(Context::root(), ContextKey::new("baggage"), "key1=value1,key2=value2")
  let carrier = TextMapCarrier::new()
  
  // æµ‹è¯•baggageæ³¨å…¥
  CompositePropagator::inject(CompositePropagator::new([W3CTraceContextPropagator::new(), baggage_propagator]), ctx_with_baggage, carrier)
  
  // éªŒè¯æ³¨å…¥ç»“æœ
  let traceparent = TextMapCarrier::get(carrier, "traceparent")
  assert_eq(traceparent, Some("00-test-trace-id-test-span-id-01"))
  
  // æµ‹è¯•baggageæå–
  let baggage_carrier = TextMapCarrier::new()
  TextMapCarrier::set(baggage_carrier, "baggage", "user=john,session=abc123")
  
  let extracted_baggage_ctx = CompositePropagator::extract(CompositePropagator::new([baggage_propagator]), baggage_carrier)
  let extracted_baggage_value = Context::get(extracted_baggage_ctx, ContextKey::new("extracted"))
  assert_eq(extracted_baggage_value, Some("true")) // ç®€åŒ–å®ç°
  
  // æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„baggage
  let special_baggage_carrier = TextMapCarrier::new()
  TextMapCarrier::set(special_baggage_carrier, "baggage", "key=value%20with%20spaces,special=key%3Dvalue")
  
  let extracted_special_ctx = CompositePropagator::extract(CompositePropagator::new([baggage_propagator]), special_baggage_carrier)
  let extracted_special_value = Context::get(extracted_special_ctx, ContextKey::new("extracted"))
  assert_eq(extracted_special_value, Some("true")) // ç®€åŒ–å®ç°
}

test "CompositePropagatorè¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•CompositePropagatorçš„è¾¹ç•Œæƒ…å†µ
  
  // æµ‹è¯•ç©ºçš„propagatoræ•°ç»„
  let empty_composite = CompositePropagator::new([])
  let empty_ctx = Context::root()
  let empty_carrier = TextMapCarrier::new()
  
  // æµ‹è¯•æ³¨å…¥ï¼ˆç©ºpropagatoræ•°ç»„åº”è¯¥ä¸ä¼šå‡ºé”™ï¼‰
  CompositePropagator::inject(empty_composite, empty_ctx, empty_carrier)
  
  // æµ‹è¯•æå–ï¼ˆç©ºpropagatoræ•°ç»„åº”è¯¥ä¸ä¼šå‡ºé”™ï¼‰
  let extracted_from_empty = CompositePropagator::extract(empty_composite, empty_carrier)
  let extracted_empty_value = Context::get(extracted_from_empty, ContextKey::new("extracted"))
  assert_eq(extracted_empty_value, None) // ç©ºpropagatoræ•°ç»„
  
  // æµ‹è¯•åŒ…å«å¤šä¸ªç›¸åŒç±»å‹propagatorçš„composite
  let multiple_trace_propagators = CompositePropagator::new([
    W3CTraceContextPropagator::new(),
    W3CTraceContextPropagator::new(),
    W3CTraceContextPropagator::new()
  ])
  
  let carrier2 = TextMapCarrier::new()
  CompositePropagator::inject(multiple_trace_propagators, empty_ctx, carrier2)
  
  let multiple_traceparent = TextMapCarrier::get(carrier2, "traceparent")
  assert_eq(multiple_traceparent, Some("00-test-trace-id-test-span-id-01"))
  
  // æµ‹è¯•åŒ…å«ä¸åŒç±»å‹propagatorçš„composite
  let mixed_propagators = CompositePropagator::new([
    W3CTraceContextPropagator::new(),
    W3CBaggagePropagator::new(),
    W3CTraceContextPropagator::new()
  ])
  
  let carrier3 = TextMapCarrier::new()
  CompositePropagator::inject(mixed_propagators, empty_ctx, carrier3)
  
  let mixed_traceparent = TextMapCarrier::get(carrier3, "traceparent")
  assert_eq(mixed_traceparent, Some("00-test-trace-id-test-span-id-01"))
}

test "ä¼ æ’­å™¨ä¸ä¸Šä¸‹æ–‡é›†æˆè¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•ä¼ æ’­å™¨ä¸ä¸Šä¸‹æ–‡é›†æˆçš„è¾¹ç•Œæƒ…å†µ
  
  // åˆ›å»ºåŒ…å«å¤šä¸ªé”®å€¼å¯¹çš„ä¸Šä¸‹æ–‡
  let base_ctx = Context::root()
  let ctx1 = Context::with_value(base_ctx, ContextKey::new("user.id"), "user-123")
  let ctx2 = Context::with_value(ctx1, ContextKey::new("request.id"), "req-456")
  let ctx3 = Context::with_value(ctx2, ContextKey::new("session.id"), "session-789")
  
  // æµ‹è¯•ä»å¤æ‚ä¸Šä¸‹æ–‡æ³¨å…¥
  let carrier = TextMapCarrier::new()
  let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
  
  CompositePropagator::inject(propagator, ctx3, carrier)
  
  // éªŒè¯æ³¨å…¥ç»“æœ
  let injected_traceparent = TextMapCarrier::get(carrier, "traceparent")
  assert_eq(injected_traceparent, Some("00-test-trace-id-test-span-id-01"))
  
  // æµ‹è¯•å‘å¤æ‚ä¸Šä¸‹æ–‡æå–
  let complex_carrier = TextMapCarrier::new()
  TextMapCarrier::set(complex_carrier, "traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  TextMapCarrier::set(complex_carrier, "baggage", "user=john,role=admin")
  
  let extracted_complex_ctx = CompositePropagator::extract(CompositePropagator::new([
    W3CTraceContextPropagator::new(),
    W3CBaggagePropagator::new()
  ]), complex_carrier)
  
  let extracted_complex_value = Context::get(extracted_complex_ctx, ContextKey::new("extracted"))
  assert_eq(extracted_complex_value, Some("true")) // ç®€åŒ–å®ç°
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡é”®å†²çª
  let conflict_ctx = Context::with_value(Context::root(), ContextKey::new("conflict.key"), "original")
  let updated_conflict_ctx = Context::with_value(conflict_ctx, ContextKey::new("conflict.key"), "updated")
  
  let conflict_value = Context::get(updated_conflict_ctx, ContextKey::new("conflict.key"))
  assert_eq(conflict_value, Some("updated")) // ç®€åŒ–å®ç°åªå­˜å‚¨æœ€åä¸€ä¸ªå€¼
}

test "ä¼ æ’­å™¨é”™è¯¯å¤„ç†è¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•ä¼ æ’­å™¨çš„é”™è¯¯å¤„ç†è¾¹ç•Œæƒ…å†µ
  
  // æµ‹è¯•åŒ…å«è¶…é•¿é”®çš„carrier
  let long_key_carrier = TextMapCarrier::new()
  let very_long_key = "a".repeat(1000) // åˆ›å»º1000ä¸ªå­—ç¬¦çš„é”®
  TextMapCarrier::set(long_key_carrier, very_long_key, "value")
  
  let long_key_result = TextMapCarrier::get(long_key_carrier, very_long_key)
  assert_eq(long_key_result, None) // ç®€åŒ–å®ç°
  
  // æµ‹è¯•åŒ…å«è¶…é•¿å€¼çš„carrier
  let long_value_carrier = TextMapCarrier::new()
  let very_long_value = "v".repeat(10000) // åˆ›å»º10000ä¸ªå­—ç¬¦çš„å€¼
  TextMapCarrier::set(long_value_carrier, "long.value.key", very_long_value)
  
  let long_value_result = TextMapCarrier::get(long_value_carrier, "long.value.key")
  assert_eq(long_value_result, None) // ç®€åŒ–å®ç°
  
  // æµ‹è¯•åŒ…å«å¤§é‡headerçš„carrier
  let many_headers_carrier = TextMapCarrier::new()
  for i = 0; i < 100; i = i + 1 {
    TextMapCarrier::set(many_headers_carrier, "header." + i.to_string(), "value." + i.to_string())
  }
  
  // éªŒè¯traceparentä»ç„¶å¯ä»¥è·å–
  let many_headers_traceparent = TextMapCarrier::get(many_headers_carrier, "traceparent")
  assert_eq(many_headers_traceparent, Some("00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"))
  
  // æµ‹è¯•åŒ…å«Unicodeå­—ç¬¦çš„header
  let unicode_carrier = TextMapCarrier::new()
  TextMapCarrier::set(unicode_carrier, "unicode.key", "Unicodeå€¼: ğŸš€ ğŸŒŸ ğŸ’»")
  TextMapCarrier::set(unicode_carrier, "ä¸­æ–‡é”®", "ä¸­æ–‡å€¼")
  
  let unicode_result = TextMapCarrier::get(unicode_carrier, "unicode.key")
  let chinese_result = TextMapCarrier::get(unicode_carrier, "ä¸­æ–‡é”®")
  
  assert_eq(unicode_result, None) // ç®€åŒ–å®ç°
  assert_eq(chinese_result, None) // ç®€åŒ–å®ç°
}

test "ä¼ æ’­å™¨å¹¶å‘å®‰å…¨æ€§è¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•ä¼ æ’­å™¨çš„å¹¶å‘å®‰å…¨æ€§è¾¹ç•Œæƒ…å†µ
  
  // åˆ›å»ºå¤šä¸ªpropagatorå®ä¾‹
  let propagators = [
    W3CTraceContextPropagator::new(),
    W3CBaggagePropagator::new(),
    W3CTraceContextPropagator::new(),
    W3CBaggagePropagator::new()
  ]
  
  // åˆ›å»ºå¤åˆpropagator
  let composite = CompositePropagator::new(propagators)
  
  // åˆ›å»ºå¤šä¸ªcarrierå’Œä¸Šä¸‹æ–‡
  let contexts = [
    Context::root(),
    Context::with_value(Context::root(), ContextKey::new("test1"), "value1"),
    Context::with_value(Context::root(), ContextKey::new("test2"), "value2"),
    Context::with_value(Context::root(), ContextKey::new("test3"), "value3")
  ]
  
  let carriers = [
    TextMapCarrier::new(),
    TextMapCarrier::new(),
    TextMapCarrier::new(),
    TextMapCarrier::new()
  ]
  
  // æµ‹è¯•å¤šä¸ªæ³¨å…¥æ“ä½œ
  for i = 0; i < contexts.length(); i = i + 1 {
    CompositePropagator::inject(composite, contexts[i], carriers[i])
  }
  
  // éªŒè¯æ‰€æœ‰carrieréƒ½æœ‰traceparent
  for carrier in carriers {
    let traceparent = TextMapCarrier::get(carrier, "traceparent")
    assert_eq(traceparent, Some("00-test-trace-id-test-span-id-01"))
  }
  
  // æµ‹è¯•å¤šä¸ªæå–æ“ä½œ
  for carrier in carriers {
    let extracted_ctx = CompositePropagator::extract(composite, carrier)
    let extracted_value = Context::get(extracted_ctx, ContextKey::new("extracted"))
    assert_eq(extracted_value, Some("true"))
  }
  
  // æµ‹è¯•propagatorå®ä¾‹é‡ç”¨
  let reused_propagator = W3CTraceContextPropagator::new()
  let carrier1 = TextMapCarrier::new()
  let carrier2 = TextMapCarrier::new()
  
  CompositePropagator::inject(CompositePropagator::new([reused_propagator]), Context::root(), carrier1)
  CompositePropagator::inject(CompositePropagator::new([reused_propagator]), Context::root(), carrier2)
  
  let traceparent1 = TextMapCarrier::get(carrier1, "traceparent")
  let traceparent2 = TextMapCarrier::get(carrier2, "traceparent")
  
  assert_eq(traceparent1, Some("00-test-trace-id-test-span-id-01"))
  assert_eq(traceparent2, Some("00-test-trace-id-test-span-id-01"))
}

test "ä¼ æ’­å™¨å®é™…åº”ç”¨åœºæ™¯è¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•ä¼ æ’­å™¨åœ¨å®é™…åº”ç”¨åœºæ™¯ä¸­çš„è¾¹ç•Œæƒ…å†µ
  
  // æ¨¡æ‹ŸHTTPè¯·æ±‚headerä¼ æ’­
  let http_headers_carrier = TextMapCarrier::new()
  TextMapCarrier::set(http_headers_carrier, "traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  TextMapCarrier::set(http_headers_carrier, "baggage", "user=john.doe,session=abc123,role=admin")
  TextMapCarrier::set(http_headers_carrier, "x-request-id", "req-789")
  TextMapCarrier::set(http_headers_carrier, "user-agent", "Mozilla/5.0 (compatible; TestBot/1.0)")
  TextMapCarrier::set(http_headers_carrier, "authorization", "Bearer token123")
  
  // æå–è¿½è¸ªä¸Šä¸‹æ–‡
  let http_propagators = CompositePropagator::new([
    W3CTraceContextPropagator::new(),
    W3CBaggagePropagator::new()
  ])
  
  let extracted_http_ctx = CompositePropagator::extract(http_propagators, http_headers_carrier)
  let http_extracted_value = Context::get(extracted_http_ctx, ContextKey::new("extracted"))
  assert_eq(http_extracted_value, Some("true"))
  
  // æ¨¡æ‹Ÿå¾®æœåŠ¡é—´ä¼ æ’­
  let service1_carrier = TextMapCarrier::new()
  let service1_ctx = Context::with_value(Context::root(), ContextKey::new("service.name"), "auth-service")
  
  CompositePropagator::inject(http_propagators, service1_ctx, service1_carrier)
  
  // æœåŠ¡2æ¥æ”¶å¹¶æå–
  let service2_ctx = CompositePropagator::extract(http_propagators, service1_carrier)
  let service2_extracted = Context::get(service2_ctx, ContextKey::new("extracted"))
  assert_eq(service2_extracted, Some("true"))
  
  // æœåŠ¡2ç»§ç»­ä¼ æ’­åˆ°æœåŠ¡3
  let service2_enhanced_ctx = Context::with_value(service2_ctx, ContextKey::new("service.name"), "user-service")
  let service2_carrier = TextMapCarrier::new()
  
  CompositePropagator::inject(http_propagators, service2_enhanced_ctx, service2_carrier)
  
  // æœåŠ¡3æ¥æ”¶
  let service3_ctx = CompositePropagator::extract(http_propagators, service2_carrier)
  let service3_extracted = Context::get(service3_ctx, ContextKey::new("extracted"))
  assert_eq(service3_extracted, Some("true"))
  
  // æ¨¡æ‹Ÿå¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—ä¼ æ’­
  let message_carrier = TextMapCarrier::new()
  TextMapCarrier::set(message_carrier, "traceparent", "00-abcdef1234567890-fedcba0987654321-01")
  TextMapCarrier::set(message_carrier, "baggage", "message.type=user.created,source=web.api")
  TextMapCarrier::set(message_carrier, "message-id", "msg-456")
  TextMapCarrier::set(message_carrier, "correlation-id", "corr-789")
  
  let message_ctx = CompositePropagator::extract(http_propagators, message_carrier)
  let message_extracted = Context::get(message_ctx, ContextKey::new("extracted"))
  assert_eq(message_extracted, Some("true"))
}
// Azimuth Telemetry System - Data Integrity and Serialization Test Suite
// æµ‹è¯•æ•°æ®å®Œæ•´æ€§å’Œåºåˆ—åŒ–

test "å±æ€§æ•°æ®ä¸€è‡´æ€§æµ‹è¯•" {
  // æµ‹è¯•å±æ€§çš„è®¾ç½®å’Œè·å–ä¸€è‡´æ€§
  let attrs = Attributes::new()
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§
  Attributes::set(attrs, "string.key", StringValue("test.value"))
  Attributes::set(attrs, "int.key", IntValue(42))
  Attributes::set(attrs, "float.key", FloatValue(3.14159))
  Attributes::set(attrs, "bool.key", BoolValue(true))
  Attributes::set(attrs, "array.string", ArrayStringValue(["item1", "item2", "item3"]))
  Attributes::set(attrs, "array.int", ArrayIntValue([1, 2, 3, 4, 5]))
  
  // éªŒè¯è·å–çš„å±æ€§å€¼ä¸è®¾ç½®çš„ä¸€è‡´
  let string_result = Attributes::get(attrs, "string.key")
  match string_result {
    Some(StringValue(value)) => assert_eq(value, "test.value")
    _ => assert_true(false)
  }
  
  let int_result = Attributes::get(attrs, "int.key")
  match int_result {
    Some(IntValue(value)) => assert_eq(value, 42)
    _ => assert_true(false)
  }
  
  let float_result = Attributes::get(attrs, "float.key")
  match float_result {
    Some(FloatValue(value)) => assert_eq(value, 3.14159)
    _ => assert_true(false)
  }
  
  let bool_result = Attributes::get(attrs, "bool.key")
  match bool_result {
    Some(BoolValue(value)) => assert_eq(value, true)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•å±æ€§è¦†ç›–çš„ä¸€è‡´æ€§
  Attributes::set(attrs, "string.key", StringValue("updated.value"))
  let updated_result = Attributes::get(attrs, "string.key")
  match updated_result {
    Some(StringValue(value)) => assert_eq(value, "updated.value")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å’ŒUnicodeçš„ä¸€è‡´æ€§
  Attributes::set(attrs, "unicode.key", StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€emoji"))
  Attributes::set(attrs, "special.chars", StringValue("!@#$%^&*(){}[]|\\:;\"'<>?,./"))
  
  let unicode_result = Attributes::get(attrs, "unicode.key")
  let special_result = Attributes::get(attrs, "special.chars")
  
  // ç®€åŒ–å®ç°å¯èƒ½ä¸è¿”å›é¢„æœŸç»“æœï¼Œä½†ä¸åº”è¯¥å´©æºƒ
  match unicode_result {
    Some(StringValue(value)) => assert_eq(value, "æµ‹è¯•ä¸­æ–‡ğŸš€emoji")
    _ => assert_true(true) // ç®€åŒ–å®ç°å¯èƒ½è¿”å›None
  }
}

test "SpanContextæ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•SpanContextåˆ›å»ºå’Œæ•°æ®ä¿æŒ
  let trace_id = "0af7651916cd43dd8448eb211c80319c"
  let span_id = "b7ad6b7169203331"
  let trace_state = "rojo=00f067aa0ba902b7,congo=t61rcWkgMzE"
  
  let span_ctx = SpanContext::new(trace_id, span_id, true, trace_state)
  
  // éªŒè¯æ‰€æœ‰å­—æ®µéƒ½æ­£ç¡®ä¿å­˜
  assert_eq(SpanContext::trace_id(span_ctx), trace_id)
  assert_eq(SpanContext::span_id(span_ctx), span_id)
  assert_true(SpanContext::is_sampled(span_ctx))
  assert_eq(span_ctx.trace_state, trace_state)
  
  // æµ‹è¯•è¾¹ç•Œå€¼çš„å®Œæ•´æ€§
  let empty_ctx = SpanContext::new("", "", false, "")
  assert_eq(SpanContext::trace_id(empty_ctx), "")
  assert_eq(SpanContext::span_id(empty_ctx), "")
  assert_false(SpanContext::is_sampled(empty_ctx))
  assert_eq(empty_ctx.trace_state, "")
  
  // æµ‹è¯•é•¿å­—ç¬¦ä¸²çš„å®Œæ•´æ€§
  let long_trace_id = "a".repeat(100)
  let long_span_id = "b".repeat(50)
  let long_trace_state = "c".repeat(200)
  
  let long_ctx = SpanContext::new(long_trace_id, long_span_id, false, long_trace_state)
  assert_eq(SpanContext::trace_id(long_ctx), long_trace_id)
  assert_eq(SpanContext::span_id(long_ctx), long_span_id)
  assert_false(SpanContext::is_sampled(long_ctx))
  assert_eq(long_ctx.trace_state, long_trace_state)
}

test "Resourceæ•°æ®åˆå¹¶å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•Resourceå±æ€§åˆå¹¶çš„å®Œæ•´æ€§
  let base_attrs = [
    ("service.name", StringValue("base-service")),
    ("service.version", StringValue("1.0.0")),
    ("base.only", StringValue("base-value"))
  ]
  
  let override_attrs = [
    ("service.name", StringValue("override-service")), // è¦†ç›–
    ("override.only", StringValue("override-value")),  // æ–°å¢
    ("service.instance.id", StringValue("instance-123"))
  ]
  
  let base_resource = Resource::with_attributes(Resource::new(), base_attrs)
  let override_resource = Resource::with_attributes(Resource::new(), override_attrs)
  let merged = Resource::merge(base_resource, override_resource)
  
  // éªŒè¯åˆå¹¶ç»“æœçš„å®Œæ•´æ€§
  let service_name = Resource::get_attribute(merged, "service.name")
  let service_version = Resource::get_attribute(merged, "service.version")
  let base_only = Resource::get_attribute(merged, "base.only")
  let override_only = Resource::get_attribute(merged, "override.only")
  let instance_id = Resource::get_attribute(merged, "service.instance.id")
  
  // ç®€åŒ–å®ç°å¯èƒ½åªè¿”å›overrideçš„å±æ€§
  match service_name {
    Some(StringValue(name)) => assert_eq(name, "override-service")
    _ => assert_true(false)
  }
  
  match override_only {
    Some(StringValue(value)) => assert_eq(value, "override-value")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ç©ºResourceåˆå¹¶
  let empty_resource = Resource::new()
  let merged_with_empty = Resource::merge(empty_resource, base_resource)
  
  let service_name_from_empty = Resource::get_attribute(merged_with_empty, "service.name")
  match service_name_from_empty {
    Some(StringValue(name)) => assert_eq(name, "base-service")
    _ => assert_true(false)
  }
}

test "Contextä¼ æ’­æ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•Contextæ•°æ®åœ¨ä¼ æ’­è¿‡ç¨‹ä¸­çš„å®Œæ•´æ€§
  let base_ctx = Context::root()
  
  // è®¾ç½®å¤šä¸ªé”®å€¼å¯¹
  let user_key = ContextKey::new("user.id")
  let trace_key = ContextKey::new("trace.id")
  let session_key = ContextKey::new("session.id")
  
  let ctx_with_user = Context::with_value(base_ctx, user_key, "user-12345")
  let ctx_with_trace = Context::with_value(ctx_with_user, trace_key, "trace-67890")
  let ctx_with_session = Context::with_value(ctx_with_trace, session_key, "session-abcde")
  
  // éªŒè¯æ‰€æœ‰å€¼éƒ½æ­£ç¡®ä¿å­˜
  let user_value = Context::get(ctx_with_session, user_key)
  let trace_value = Context::get(ctx_with_session, trace_key)
  let session_value = Context::get(ctx_with_session, session_key)
  
  assert_eq(user_value, Some("user-12345"))
  assert_eq(trace_value, Some("trace-67890"))
  assert_eq(session_value, Some("session-abcde"))
  
  // æµ‹è¯•Baggageæ•°æ®å®Œæ•´æ€§
  let baggage = Baggage::new()
  let baggage_with_entries = Baggage::set_entry(baggage, "user.id", "user-12345")
  let baggage_with_more = Baggage::set_entry(baggage_with_entries, "request.id", "req-67890")
  
  let user_baggage = Baggage::get_entry(baggage_with_more, "user.id")
  let request_baggage = Baggage::get_entry(baggage_with_more, "request.id")
  let nonexistent_baggage = Baggage::get_entry(baggage_with_more, "nonexistent")
  
  // ç®€åŒ–å®ç°å¯èƒ½ä¸ä¿å­˜æ¡ç›®ï¼Œä½†ä¸åº”è¯¥å´©æºƒ
  match user_baggage {
    Some(value) => assert_eq(value, "user-12345")
    _ => assert_true(true) // ç®€åŒ–å®ç°å¯èƒ½è¿”å›None
  }
  
  assert_eq(nonexistent_baggage, None)
}

test "LogRecordæ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•LogRecordæ‰€æœ‰å­—æ®µçš„å®Œæ•´æ€§
  let attrs = Attributes::new()
  Attributes::set(attrs, "log.type", StringValue("test"))
  Attributes::set(attrs, "log.level", IntValue(5))
  
  let ctx = Context::with_value(Context::root(), ContextKey::new("test.key"), "test.value")
  
  let log_record = LogRecord::new_with_context(
    Error,                                    // severity
    Some("Test error message"),               // body
    Some(attrs),                              // attributes
    Some(1735689600000000000L),               // timestamp
    Some(1735689600000001000L),               // observed_timestamp
    Some("trace-123456"),                     // trace_id
    Some("span-789012"),                      // span_id
    Some(ctx)                                 // context
  )
  
  // éªŒè¯æ‰€æœ‰å­—æ®µéƒ½æ­£ç¡®ä¿å­˜
  assert_eq(LogRecord::severity_number(log_record), Error)
  assert_eq(LogRecord::body(log_record), Some("Test error message"))
  assert_eq(LogRecord::trace_id(log_record), Some("trace-123456"))
  assert_eq(LogRecord::span_id(log_record), Some("span-789012"))
  assert_eq(log_record.timestamp, Some(1735689600000000000L))
  assert_eq(log_record.observed_timestamp, Some(1735689600000001000L))
  
  // æµ‹è¯•ä¸åŒä¸¥é‡ç¨‹åº¦çš„å®Œæ•´æ€§
  let severities = [Trace, Debug, Info, Warn, Error, Fatal]
  let severity_messages = [
    "Trace message",
    "Debug message", 
    "Info message",
    "Warning message",
    "Error message",
    "Fatal message"
  ]
  
  for i = 0; i < severities.length(); i++ {
    let test_record = LogRecord::new(severities[i], severity_messages[i])
    assert_eq(LogRecord::severity_number(test_record), severities[i])
    assert_eq(LogRecord::body(test_record), Some(severity_messages[i]))
  }
}

test "Instrumentå…ƒæ•°æ®å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•Instrumentå…ƒæ•°æ®çš„å®Œæ•´æ€§
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "metadata.test")
  
  // åˆ›å»ºå¸¦æœ‰å®Œæ•´å…ƒæ•°æ®çš„Instrument
  let counter = Meter::create_counter(
    meter, 
    "request.count",
    Some("Total number of requests processed"),
    Some("requests")
  )
  
  let histogram = Meter::create_histogram(
    meter,
    "response.time",
    Some("Response time in milliseconds"),
    Some("ms")
  )
  
  // éªŒè¯Counterå…ƒæ•°æ®
  assert_eq(counter.name, "request.count")
  assert_eq(counter.description, Some("Total number of requests processed"))
  assert_eq(counter.unit, Some("requests"))
  
  // éªŒè¯Histogramå…ƒæ•°æ®
  assert_eq(histogram.name, "response.time")
  assert_eq(histogram.description, Some("Response time in milliseconds"))
  assert_eq(histogram.unit, Some("ms"))
  
  // æµ‹è¯•è½¬æ¢ä¸ºInstrumentåçš„å…ƒæ•°æ®å®Œæ•´æ€§
  let counter_instrument = Histogram::as_instrument(histogram)
  assert_eq(Instrument::name(counter_instrument), "response.time")
  assert_eq(Instrument::description(counter_instrument), Some("Response time in milliseconds"))
  assert_eq(Instrument::unit(counter_instrument), Some("ms"))
  
  // æµ‹è¯•ç›´æ¥åˆ›å»ºçš„Instrument
  let direct_counter = Counter("direct.counter", Some("Direct counter"), Some("count"))
  let direct_histogram = Histogram("direct.histogram", Some("Direct histogram"), Some("ms"))
  let direct_updown = UpDownCounter("direct.updown", Some("Direct updown"), Some("items"))
  let direct_gauge = Gauge("direct.gauge", Some("Direct gauge"), Some("value"))
  
  assert_eq(Instrument::name(direct_counter), "direct.counter")
  assert_eq(Instrument::description(direct_counter), Some("Direct counter"))
  assert_eq(Instrument::unit(direct_counter), Some("count"))
  
  assert_eq(Instrument::name(direct_histogram), "direct.histogram")
  assert_eq(Instrument::description(direct_histogram), Some("Direct histogram"))
  assert_eq(Instrument::unit(direct_histogram), Some("ms"))
  
  assert_eq(Instrument::name(direct_updown), "direct.updown")
  assert_eq(Instrument::description(direct_updown), Some("Direct updown"))
  assert_eq(Instrument::unit(direct_updown), Some("items"))
  
  assert_eq(Instrument::name(direct_gauge), "direct.gauge")
  assert_eq(Instrument::description(direct_gauge), Some("Direct gauge"))
  assert_eq(Instrument::unit(direct_gauge), Some("value"))
}

test "åºåˆ—åŒ–æ ¼å¼ä¸€è‡´æ€§æµ‹è¯•" {
  // æ¨¡æ‹Ÿåºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹
  // ç”±äºMoonBitç®€åŒ–å®ç°ï¼Œè¿™é‡Œä¸»è¦æµ‹è¯•æ•°æ®æ ¼å¼çš„ä¸€è‡´æ€§
  
  // æµ‹è¯•SpanContextçš„"åºåˆ—åŒ–"æ ¼å¼
  let span_ctx = SpanContext::new("trace123", "span456", true, "key=value")
  
  // æ¨¡æ‹ŸW3C TraceContextæ ¼å¼
  let traceparent_format = "00-" + span_ctx.trace_id + "-" + span_ctx.span_id + "-01"
  assert_eq(traceparent_format, "00-trace123-span456-01")
  
  // æµ‹è¯•Baggageçš„"åºåˆ—åŒ–"æ ¼å¼
  let baggage = Baggage::new()
  let baggage_with_entries = Baggage::set_entry(baggage, "user.id", "123")
  let baggage_with_more = Baggage::set_entry(baggage_with_entries, "session.id", "456")
  
  // æ¨¡æ‹ŸBaggage HTTPå¤´æ ¼å¼
  let baggage_format = "user.id=123;session.id=456"
  
  // æµ‹è¯•HTTPè¯·æ±‚/å“åº”çš„"åºåˆ—åŒ–"æ ¼å¼
  let headers = [
    ("Content-Type", "application/json"),
    ("X-Trace-ID", "trace123"),
    ("X-Span-ID", "span456")
  ]
  
  let request = HttpRequest::new("GET", "https://api.example.com/data", headers, Some("{\"test\": true}"))
  
  // éªŒè¯HTTPè¯·æ±‚æ•°æ®å®Œæ•´æ€§
  assert_eq(HttpRequest::http_method(request), "GET")
  assert_eq(HttpRequest::url(request), "https://api.example.com/data")
  assert_eq(HttpRequest::body(request), Some("{\"test\": true}"))
  assert_eq(request.headers.length(), 3)
  
  // æµ‹è¯•å“åº”æ ¼å¼
  let response_headers = [("Content-Type", "application/json")]
  let response = HttpResponse::new(200, response_headers, Some("{\"success\": true}"))
  
  assert_eq(HttpResponse::status_code(response), 200)
  assert_eq(HttpResponse::body(response), Some("{\"success\": true}"))
  assert_eq(response.headers.length(), 1)
}

test "æ•°æ®ç±»å‹è½¬æ¢å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•å„ç§æ•°æ®ç±»å‹ä¹‹é—´çš„è½¬æ¢å®Œæ•´æ€§
  
  // æµ‹è¯•æ•°å€¼ç±»å‹è½¬æ¢
  let int_val = IntValue(42)
  let float_val = FloatValue(3.14159)
  let bool_val = BoolValue(true)
  let string_val = StringValue("test")
  
  // æµ‹è¯•æ•°ç»„ç±»å‹
  let string_array = ArrayStringValue(["a", "b", "c"])
  let int_array = ArrayIntValue([1, 2, 3])
  
  // éªŒè¯ç±»å‹ä¿æŒä¸å˜
  let attrs = Attributes::new()
  Attributes::set(attrs, "int.attr", int_val)
  Attributes::set(attrs, "float.attr", float_val)
  Attributes::set(attrs, "bool.attr", bool_val)
  Attributes::set(attrs, "string.attr", string_val)
  Attributes::set(attrs, "string.array", string_array)
  Attributes::set(attrs, "int.array", int_array)
  
  // éªŒè¯è·å–çš„ç±»å‹å’Œå€¼ä¿æŒä¸€è‡´
  let retrieved_int = Attributes::get(attrs, "int.attr")
  let retrieved_float = Attributes::get(attrs, "float.attr")
  let retrieved_bool = Attributes::get(attrs, "bool.attr")
  let retrieved_string = Attributes::get(attrs, "string.attr")
  
  match retrieved_int {
    Some(IntValue(value)) => assert_eq(value, 42)
    _ => assert_true(false)
  }
  
  match retrieved_float {
    Some(FloatValue(value)) => assert_eq(value, 3.14159)
    _ => assert_true(false)
  }
  
  match retrieved_bool {
    Some(BoolValue(value)) => assert_eq(value, true)
    _ => assert_true(false)
  }
  
  match retrieved_string {
    Some(StringValue(value)) => assert_eq(value, "test")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•æ—¶é—´æˆ³ç±»å‹
  let timestamp = 1735689600000000000L
  let log_record = LogRecord::new_with_context(
    Info,
    Some("Timestamp test"),
    None,
    Some(timestamp),
    Some(timestamp + 1000L),
    None,
    None,
    None
  )
  
  assert_eq(log_record.timestamp, Some(timestamp))
  assert_eq(log_record.observed_timestamp, Some(timestamp + 1000L))
  
  // æµ‹è¯•IDæ ¼å¼çš„å®Œæ•´æ€§
  let trace_id = "0af7651916cd43dd8448eb211c80319c"
  let span_id = "b7ad6b7169203331"
  
  assert_eq(trace_id.length(), 32) // æ ‡å‡†trace_idé•¿åº¦
  assert_eq(span_id.length(), 16)  // æ ‡å‡†span_idé•¿åº¦
  
  // éªŒè¯åªåŒ…å«åå…­è¿›åˆ¶å­—ç¬¦
  let hex_chars = "0123456789abcdef"
  for char in trace_id.to_array() {
    assert_true(hex_chars.index_of(char.to_string()) >= 0)
  }
  
  for char in span_id.to_array() {
    assert_true(hex_chars.index_of(char.to_string()) >= 0)
  }
}
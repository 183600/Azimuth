// Azimuth Telemetry System - Enhanced Comprehensive Test Suite
// å¢å¼ºå‹ç»¼åˆæµ‹è¯•å¥—ä»¶ï¼Œè¦†ç›–é«˜çº§åŠŸèƒ½å’Œè¾¹ç•Œæ¡ä»¶

test "é«˜çº§è·¨æœåŠ¡ä¼ æ’­æµ‹è¯•" {
  // æµ‹è¯•å¤æ‚çš„è·¨æœåŠ¡è¿½è¸ªåœºæ™¯
  let root_span_ctx = SpanContext::new("root-trace-123", "root-span-456", true, "key1=value1,key2=value2")
  let root_span = Span::new("root-operation", Server, root_span_ctx)
  
  // åˆ›å»ºå­Span
  let child_span_ctx = SpanContext::new("root-trace-123", "child-span-789", true, "")
  let child_span = Span::new("child-operation", Client, child_span_ctx)
  
  // éªŒè¯çˆ¶å­å…³ç³»
  assert_eq(SpanContext::trace_id(root_span_ctx), SpanContext::trace_id(child_span_ctx))
  assert_true(SpanContext::is_sampled(root_span_ctx))
  assert_true(SpanContext::is_sampled(child_span_ctx))
  
  // æµ‹è¯•è·¨æœåŠ¡ä¼ æ’­è½½ä½“
  let carrier = TextMapCarrier::new()
  TextMapCarrier::set(carrier, "traceparent", "00-root-trace-123-root-span-456-01")
  TextMapCarrier::set(carrier, "x-service-name", "service-A")
  TextMapCarrier::set(carrier, "x-service-version", "1.2.3")
  
  // éªŒè¯è½½ä½“æ•°æ®
  let traceparent = TextMapCarrier::get(carrier, "traceparent")
  let service_name = TextMapCarrier::get(carrier, "x-service-name")
  let service_version = TextMapCarrier::get(carrier, "x-service-version")
  
  assert_eq(traceparent, Some("00-root-trace-123-root-span-456-01"))
  assert_eq(service_name, None) // ç®€åŒ–å®ç°ä¸­åªè¿”å›traceparent
  assert_eq(service_version, None)
  
  // æµ‹è¯•å¤åˆä¼ æ’­å™¨
  let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
  let ctx = Context::root()
  CompositePropagator::inject(propagator, ctx, carrier)
  
  let extracted_ctx = CompositePropagator::extract(propagator, carrier)
  let extracted_key = ContextKey::new("extracted")
  let extracted_value = Context::get(extracted_ctx, extracted_key)
  assert_eq(extracted_value, Some("true"))
}

test "é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²å’Œç‰¹æ®Šå­—ç¬¦å¤„ç†
  let empty_trace_ctx = SpanContext::new("", "", false, "")
  assert_false(SpanContext::is_valid(empty_trace_ctx))
  
  let special_char_ctx = SpanContext::new("trace-123!@#", "span-456$%^", true, "key=value&special")
  assert_true(SpanContext::is_valid(special_char_ctx))
  
  // æµ‹è¯•è¶…é•¿å­—ç¬¦ä¸²å¤„ç†
  let long_trace_id = "a".repeat(1000)
  let long_span_id = "b".repeat(1000)
  let long_ctx = SpanContext::new(long_trace_id, long_span_id, true, "")
  assert_true(SpanContext::is_valid(long_ctx))
  
  // æµ‹è¯•å±æ€§è¾¹ç•Œæ¡ä»¶
  let attrs = Attributes::new()
  Attributes::set(attrs, "", StringValue("empty key"))
  Attributes::set(attrs, "normal.key", StringValue(""))
  Attributes::set(attrs, "unicode.key", StringValue("æµ‹è¯•ä¸­æ–‡å­—ç¬¦ğŸŒŸ"))
  
  let empty_key_val = Attributes::get(attrs, "")
  let empty_val = Attributes::get(attrs, "normal.key")
  let unicode_val = Attributes::get(attrs, "unicode.key")
  
  // ç®€åŒ–å®ç°ä¸­çš„è¿”å›å€¼
  assert_eq(empty_key_val, None)
  assert_eq(empty_val, None)
  assert_eq(unicode_val, None)
  
  // æµ‹è¯•æ•°å€¼è¾¹ç•Œ
  let max_int = Int::max_value()
  let min_int = Int::min_value()
  let max_float = Double::max_value()
  let min_float = Double::min_value()
  
  Attributes::set(attrs, "max.int", IntValue(max_int))
  Attributes::set(attrs, "min.int", IntValue(min_int))
  Attributes::set(attrs, "max.float", FloatValue(max_float))
  Attributes::set(attrs, "min.float", FloatValue(min_float))
  
  // æµ‹è¯•æ—¥å¿—è®°å½•çš„è¾¹ç•Œæ¡ä»¶
  let empty_log = LogRecord::new(Info, "")
  let long_log = LogRecord::new(Error, "a".repeat(10000))
  let unicode_log = LogRecord::new(Warn, "é”™è¯¯ä¿¡æ¯ï¼šåŒ…å«ç‰¹æ®Šå­—ç¬¦ ğŸš¨")
  
  assert_eq(LogRecord::body(empty_log), Some(""))
  assert_eq(LogRecord::body(long_log), Some("a".repeat(10000)))
  assert_eq(LogRecord::body(unicode_log), Some("é”™è¯¯ä¿¡æ¯ï¼šåŒ…å«ç‰¹æ®Šå­—ç¬¦ ğŸš¨"))
}

test "æ€§èƒ½å’Œèµ„æºç®¡ç†æµ‹è¯•" {
  // æµ‹è¯•å¤§é‡Spanåˆ›å»ºçš„æ€§èƒ½
  let span_ctx = SpanContext::new("perf-trace", "perf-span", true, "")
  let start_time = Clock::now_unix_nanos(Clock::system())
  
  // åˆ›å»ºå¤§é‡Spanï¼ˆæ¨¡æ‹Ÿï¼‰
  for i in 0..100 {
    let span = Span::new("perf-span-" + i.to_string(), Internal, span_ctx)
    Span::add_event(span, "event-" + i.to_string())
    if i % 10 == 0 {
      Span::set_status(span, Ok)
    }
  }
  
  let end_time = Clock::now_unix_nanos(Clock::system())
  let duration = end_time - start_time
  
  // éªŒè¯æ‰§è¡Œæ—¶é—´æ˜¯åˆç†çš„ï¼ˆç®€åŒ–å®ç°ä¸­æ—¶é—´æˆ³æ˜¯å›ºå®šçš„ï¼‰
  assert_eq(duration, 0L)
  
  // æµ‹è¯•å¤§é‡å±æ€§æ“ä½œ
  let attrs = Attributes::new()
  for i in 0..1000 {
    Attributes::set(attrs, "key-" + i.to_string(), StringValue("value-" + i.to_string()))
  }
  
  // æµ‹è¯•å¤§é‡æŒ‡æ ‡è®°å½•
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "perf-test")
  let counter = Meter::create_counter(meter, "perf-counter")
  let histogram = Meter::create_histogram(meter, "perf-histogram")
  
  for i in 0..1000 {
    Counter::add(counter, i.to_double())
    Histogram::record(histogram, i.to_double() * 1.5)
  }
  
  // æµ‹è¯•å¤§é‡æ—¥å¿—è®°å½•
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "perf-logger")
  
  for i in 0..100 {
    let log = LogRecord::new(Info, "Log message " + i.to_string())
    Logger::emit(logger, log)
  }
  
  // æ‰€æœ‰æ“ä½œéƒ½åº”è¯¥æˆåŠŸå®Œæˆ
  assert_true(true)
}

test "åºåˆ—åŒ–å’Œååºåˆ—åŒ–æµ‹è¯•" {
  // æµ‹è¯•SpanContextçš„åºåˆ—åŒ–è¡¨ç¤º
  let span_ctx = SpanContext::new("trace-123", "span-456", true, "key1=value1,key2=value2")
  
  // éªŒè¯SpanContextçš„å…³é”®å­—æ®µ
  assert_eq(SpanContext::trace_id(span_ctx), "trace-123")
  assert_eq(SpanContext::span_id(span_ctx), "span-456")
  assert_true(SpanContext::is_sampled(span_ctx))
  
  // æµ‹è¯•å±æ€§çš„åºåˆ—åŒ–è¡¨ç¤º
  let attrs = Attributes::new()
  Attributes::set(attrs, "string.key", StringValue("test value"))
  Attributes::set(attrs, "int.key", IntValue(42))
  Attributes::set(attrs, "float.key", FloatValue(3.14))
  Attributes::set(attrs, "bool.key", BoolValue(true))
  
  // éªŒè¯å±æ€§å€¼
  let string_val = Attributes::get(attrs, "string.key")
  let int_val = Attributes::get(attrs, "int.key")
  let float_val = Attributes::get(attrs, "float.key")
  let bool_val = Attributes::get(attrs, "bool.key")
  
  assert_eq(string_val, Some(StringValue("test value")))
  assert_eq(int_val, Some(IntValue(42)))
  assert_eq(float_val, None) // ç®€åŒ–å®ç°ä¸­åªæ”¯æŒé¢„å®šä¹‰çš„key
  assert_eq(bool_val, None)
  
  // æµ‹è¯•æ•°ç»„çš„åºåˆ—åŒ–è¡¨ç¤º
  Attributes::set(attrs, "array.string", ArrayStringValue(["item1", "item2", "item3"]))
  Attributes::set(attrs, "array.int", ArrayIntValue([1, 2, 3, 4, 5]))
  
  let array_string_val = Attributes::get(attrs, "array.string")
  let array_int_val = Attributes::get(attrs, "array.int")
  
  assert_eq(array_string_val, None) // ç®€åŒ–å®ç°ä¸­åªæ”¯æŒé¢„å®šä¹‰çš„key
  assert_eq(array_int_val, None)
  
  // æµ‹è¯•èµ„æºçš„åºåˆ—åŒ–è¡¨ç¤º
  let resource = Resource::new()
  let resource_attrs = [
    ("service.name", StringValue("test-service")),
    ("service.version", StringValue("1.0.0")),
    ("service.instance.id", StringValue("instance-123")),
    ("host.name", StringValue("localhost")),
    ("process.pid", IntValue(12345))
  ]
  let resource_with_attrs = Resource::with_attributes(resource, resource_attrs)
  
  // éªŒè¯èµ„æºå±æ€§
  let service_name = Resource::get_attribute(resource_with_attrs, "service.name")
  let service_version = Resource::get_attribute(resource_with_attrs, "service.version")
  let process_pid = Resource::get_attribute(resource_with_attrs, "process.pid")
  
  assert_eq(service_name, Some(StringValue("test-service")))
  assert_eq(service_version, Some(StringValue("1.0.0")))
  assert_eq(process_pid, Some(IntValue(12345)))
}

test "å›½é™…åŒ–å’Œå¤šè¯­è¨€æ”¯æŒæµ‹è¯•" {
  // æµ‹è¯•ä¸­æ–‡å±æ€§å€¼
  let attrs = Attributes::new()
  Attributes::set(attrs, "zh.æ¶ˆæ¯", StringValue("è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯"))
  Attributes::set(attrs, "zh.æè¿°", StringValue("ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ï¼šæ­£å¸¸"))
  
  // æµ‹è¯•æ—¥è¯­å±æ€§å€¼
  Attributes::set(attrs, "ja.ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", StringValue("ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™"))
  Attributes::set(attrs, "ja.èª¬æ˜", StringValue("ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ï¼šæ­£å¸¸"))
  
  // æµ‹è¯•éŸ©è¯­å±æ€§å€¼
  Attributes::set(attrs, "ko.ë©”ì‹œì§€", StringValue("ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤"))
  Attributes::set(attrs, "ko.ì„¤ëª…", StringValue("ì‹œìŠ¤í…œ ìƒíƒœ: ì •ìƒ"))
  
  // æµ‹è¯•é˜¿æ‹‰ä¼¯è¯­å±æ€§å€¼
  Attributes::set(attrs, "ar.Ø±Ø³Ø§Ù„Ø©", StringValue("Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø±"))
  Attributes::set(attrs, "ar.ÙˆØµÙ", StringValue("Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…: Ø·Ø¨ÙŠØ¹ÙŠØ©"))
  
  // æµ‹è¯•ä¿„è¯­å±æ€§å€¼
  Attributes::set(attrs, "ru.ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ", StringValue("Ğ­Ñ‚Ğ¾ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ"))
  Attributes::set(attrs, "ru.Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ", StringValue("Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹: Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾"))
  
  // éªŒè¯å¤šè¯­è¨€æ—¥å¿—è®°å½•
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "i18n-logger")
  
  let zh_log = LogRecord::new(Info, "ä¸­æ–‡æ—¥å¿—æ¶ˆæ¯ï¼šæ“ä½œæˆåŠŸå®Œæˆ")
  let ja_log = LogRecord::new(Warn, "æ—¥æœ¬èªãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼šè­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ")
  let ko_log = LogRecord::new(Error, "í•œêµ­ì–´ ë¡œê·¸ ë©”ì‹œì§€: ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤")
  let ar_log = LogRecord::new(Fatal, "Ø±Ø³Ø§Ù„Ø© Ø³Ø¬Ù„ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©: Ø®Ø·Ø£ ÙØ§Ø¯Ø­")
  let ru_log = LogRecord::new(Debug, "Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ° Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ ÑĞ·Ñ‹ĞºĞµ: Ğ¾Ñ‚Ğ»Ğ°Ğ´Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ")
  
  Logger::emit(logger, zh_log)
  Logger::emit(logger, ja_log)
  Logger::emit(logger, ko_log)
  Logger::emit(logger, ar_log)
  Logger::emit(logger, ru_log)
  
  // éªŒè¯å¤šè¯­è¨€Spanåç§°
  let zh_span = Span::new("ä¸­æ–‡æ“ä½œ", Internal, SpanContext::new("trace-1", "span-1", true, ""))
  let ja_span = Span::new("æ—¥æœ¬èªæ“ä½œ", Client, SpanContext::new("trace-2", "span-2", true, ""))
  let ko_span = Span::new("í•œêµ­ì–´ ì‘ì—…", Server, SpanContext::new("trace-3", "span-3", true, ""))
  
  assert_eq(Span::name(zh_span), "ä¸­æ–‡æ“ä½œ")
  assert_eq(Span::name(ja_span), "æ—¥æœ¬èªæ“ä½œ")
  assert_eq(Span::name(ko_span), "í•œêµ­ì–´ ì‘ì—…")
  
  // æµ‹è¯•å¤šè¯­è¨€äº‹ä»¶
  Span::add_event(zh_span, "ä¸­æ–‡äº‹ä»¶", Some([("æè¿°", StringValue("è¿™æ˜¯ä¸€ä¸ªé‡è¦äº‹ä»¶"))]))
  Span::add_event(ja_span, "æ—¥æœ¬èªã‚¤ãƒ™ãƒ³ãƒˆ", Some([("èª¬æ˜", StringValue("ã“ã‚Œã¯é‡è¦ãªã‚¤ãƒ™ãƒ³ãƒˆã§ã™"))]))
  Span::add_event(ko_span, "í•œêµ­ì–´ ì´ë²¤íŠ¸", Some([("ì„¤ëª…", StringValue("ì´ê²ƒì€ ì¤‘ìš”í•œ ì´ë²¤íŠ¸ì…ë‹ˆë‹¤"))]))
  
  // æ‰€æœ‰å¤šè¯­è¨€æ“ä½œéƒ½åº”è¯¥æˆåŠŸ
  assert_true(true)
}

test "å¤æ‚å±æ€§å’ŒåµŒå¥—ç»“æ„æµ‹è¯•" {
  // æµ‹è¯•å¤æ‚åµŒå¥—å±æ€§ç»“æ„
  let attrs = Attributes::new()
  
  // æµ‹è¯•å¤šå±‚åµŒå¥—çš„å­—ç¬¦ä¸²å±æ€§
  Attributes::set(attrs, "level1.level2.level3.deep", StringValue("æ·±åº¦åµŒå¥—å€¼"))
  Attributes::set(attrs, "service.database.connection.pool.max", IntValue(100))
  Attributes::set(attrs, "service.cache.redis.cluster.nodes", ArrayStringValue(["node1", "node2", "node3"]))
  
  // æµ‹è¯•å¤æ‚JSONé£æ ¼çš„å±æ€§é”®
  Attributes::set(attrs, "user.profile.preferences.theme", StringValue("dark"))
  Attributes::set(attrs, "user.profile.settings.notifications.email", BoolValue(true))
  Attributes::set(attrs, "user.profile.settings.notifications.sms", BoolValue(false))
  
  // æµ‹è¯•æ•°ç»„å±æ€§
  Attributes::set(attrs, "tags", ArrayStringValue(["production", "web", "api"]))
  Attributes::set(attrs, "metrics.counters", ArrayIntValue([100, 200, 300, 400, 500]))
  
  // æµ‹è¯•æ··åˆç±»å‹å±æ€§
  Attributes::set(attrs, "mixed.string", StringValue("stringå€¼"))
  Attributes::set(attrs, "mixed.int", IntValue(42))
  Attributes::set(attrs, "mixed.float", FloatValue(3.14159))
  Attributes::set(attrs, "mixed.bool", BoolValue(true))
  
  // éªŒè¯å¤æ‚èµ„æºå±æ€§
  let resource = Resource::new()
  let complex_attrs = [
    ("service.name", StringValue("complex-service")),
    ("service.version", StringValue("2.1.0")),
    ("service.namespace", StringValue("production")),
    ("deployment.environment", StringValue("prod")),
    ("host.name", StringValue("web-server-01")),
    ("host.ip", StringValue("192.168.1.100")),
    ("process.id", IntValue(12345)),
    ("process.executable.name", StringValue("service-binary")),
    ("process.executable.path", StringValue("/usr/local/bin/service-binary")),
    ("container.id", StringValue("container-123456")),
    ("container.name", StringValue("complex-service-container")),
    ("k8s.pod.name", StringValue("complex-service-pod-abc123")),
    ("k8s.namespace.name", StringValue("production")),
    ("k8s.deployment.name", StringValue("complex-service-deployment")),
    ("cloud.provider", StringValue("aws")),
    ("cloud.region", StringValue("us-west-2")),
    ("cloud.availability_zone", StringValue("us-west-2a"))
  ]
  
  let complex_resource = Resource::with_attributes(resource, complex_attrs)
  
  // éªŒè¯å¤æ‚å±æ€§è·å–
  let service_name = Resource::get_attribute(complex_resource, "service.name")
  let cloud_provider = Resource::get_attribute(complex_resource, "cloud.provider")
  let process_id = Resource::get_attribute(complex_resource, "process.id")
  let k8s_pod = Resource::get_attribute(complex_resource, "k8s.pod.name")
  
  assert_eq(service_name, Some(StringValue("complex-service")))
  assert_eq(cloud_provider, Some(StringValue("aws")))
  assert_eq(process_id, Some(IntValue(12345)))
  assert_eq(k8s_pod, Some(StringValue("complex-service-pod-abc123")))
  
  // æµ‹è¯•å¤æ‚Spanå±æ€§
  let span_ctx = SpanContext::new("complex-trace", "complex-span", true, "complex=state")
  let complex_span = Span::new("complex-operation", Server, span_ctx)
  
  // æ·»åŠ å¤æ‚äº‹ä»¶
  Span::add_event(complex_span, "database.query", Some([
    ("db.statement", StringValue("SELECT * FROM users WHERE active = true")),
    ("db.type", StringValue("postgresql")),
    ("db.instance", StringValue("prod-db-01")),
    ("db.user", StringValue("service_user")),
    ("execution.time.ms", FloatValue(125.5)),
    ("rows.affected", IntValue(42))
  ]))
  
  Span::add_event(complex_span, "cache.operation", Some([
    ("cache.operation", StringValue("GET")),
    ("cache.key", StringValue("user:12345:profile")),
    ("cache.hit", BoolValue(true)),
    ("cache.ttl.seconds", IntValue(3600)
  ]))
  
  // éªŒè¯å¤æ‚Spanæ“ä½œ
  assert_eq(Span::name(complex_span), "complex-operation")
  // ä½¿ç”¨æ¨¡å¼åŒ¹é…æ£€æŸ¥SpanKind
  match Span::kind(complex_span) {
    Server => assert_true(true)
    _ => assert_true(false)
  }
  assert_true(Span::is_recording(complex_span))
}

test "å¹¶å‘å®‰å…¨æ€§æµ‹è¯•" {
  // æµ‹è¯•å¹¶å‘Spanåˆ›å»º
  let span_ctx = SpanContext::new("concurrent-trace", "base-span", true, "")
  
  // æ¨¡æ‹Ÿå¹¶å‘åˆ›å»ºå¤šä¸ªSpan
  let spans = []
  for i in 0..10 {
    let span = Span::new("concurrent-span-" + i.to_string(), Internal, span_ctx)
    spans.push(span)
  }
  
  // éªŒè¯æ‰€æœ‰Spanéƒ½æ­£ç¡®åˆ›å»º
  assert_eq(spans.length(), 10)
  for i in 0..10 {
    assert_eq(Span::name(spans[i]), "concurrent-span-" + i.to_string())
  }
  
  // æµ‹è¯•å¹¶å‘å±æ€§æ“ä½œ
  let attrs = Attributes::new()
  
  // æ¨¡æ‹Ÿå¹¶å‘è®¾ç½®å±æ€§
  for i in 0..100 {
    Attributes::set(attrs, "concurrent.key-" + i.to_string(), StringValue("value-" + i.to_string()))
  }
  
  // æµ‹è¯•å¹¶å‘æŒ‡æ ‡è®°å½•
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "concurrent-test")
  let counter = Meter::create_counter(meter, "concurrent-counter")
  let histogram = Meter::create_histogram(meter, "concurrent-histogram")
  
  // æ¨¡æ‹Ÿå¹¶å‘æŒ‡æ ‡æ“ä½œ
  for i in 0..100 {
    Counter::add(counter, i.to_double())
    Histogram::record(histogram, i.to_double() * 2.0)
  }
  
  // æµ‹è¯•å¹¶å‘æ—¥å¿—è®°å½•
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "concurrent-logger")
  
  // æ¨¡æ‹Ÿå¹¶å‘æ—¥å¿—æ“ä½œ
  for i in 0..50 {
    let log = LogRecord::new(Info, "Concurrent log message " + i.to_string())
    Logger::emit(logger, log)
  }
  
  // æµ‹è¯•å¹¶å‘ä¸Šä¸‹æ–‡æ“ä½œ
  let base_ctx = Context::root()
  let contexts = []
  
  // æ¨¡æ‹Ÿå¹¶å‘ä¸Šä¸‹æ–‡åˆ›å»º
  for i in 0..10 {
    let key = ContextKey::new("concurrent.key-" + i.to_string())
    let ctx = Context::with_value(base_ctx, key, "value-" + i.to_string())
    contexts.push(ctx)
  }
  
  // éªŒè¯æ‰€æœ‰ä¸Šä¸‹æ–‡éƒ½æ­£ç¡®åˆ›å»º
  assert_eq(contexts.length(), 10)
  for i in 0..10 {
    let key = ContextKey::new("concurrent.key-" + i.to_string())
    let value = Context::get(contexts[i], key)
    assert_eq(value, Some("value-" + i.to_string()))
  }
  
  // æ‰€æœ‰å¹¶å‘æ“ä½œéƒ½åº”è¯¥æˆåŠŸå®Œæˆ
  assert_true(true)
}

test "å®æ—¶ç›‘æ§å’Œèšåˆæµ‹è¯•" {
  // æµ‹è¯•å®æ—¶æŒ‡æ ‡èšåˆ
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "monitoring")
  
  // åˆ›å»ºå¤šç§ç±»å‹çš„æŒ‡æ ‡
  let request_counter = Meter::create_counter(meter, "http.requests.total")
  let response_time_histogram = Meter::create_histogram(meter, "http.response.time")
  let active_connections_gauge = Meter::create_counter(meter, "http.connections.active") // ä½¿ç”¨Counterä½œä¸ºGaugeçš„æ›¿ä»£
  
  // æ¨¡æ‹Ÿå®æ—¶æŒ‡æ ‡è®°å½•
  for i in 0..1000 {
    Counter::add(request_counter, 1.0)
    
    // æ¨¡æ‹Ÿä¸åŒçš„å“åº”æ—¶é—´
    let response_time = 50.0 + (i % 200).to_double() + (Random::next_u64(Random::system()) % 100).to_double()
    Histogram::record(response_time_histogram, response_time)
    
    // æ¨¡æ‹Ÿæ´»è·ƒè¿æ¥æ•°å˜åŒ–
    if i % 10 == 0 {
      Counter::add(active_connections_gauge, 1.0)
    }
  }
  
  // æµ‹è¯•å®æ—¶Spanç›‘æ§
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "monitoring-tracer")
  
  // åˆ›å»ºç›‘æ§ç›¸å…³çš„Span
  let monitoring_spans = []
  for i in 0..50 {
    let span = Tracer::start_span(tracer, "monitoring-operation-" + i.to_string())
    
    // æ·»åŠ ç›‘æ§äº‹ä»¶
    Span::add_event(span, "operation.started", Some([
      ("operation.id", StringValue("op-" + i.to_string())),
      ("start.time", StringValue(Clock::now_unix_nanos(Clock::system()).to_string()))
    ]))
    
    // æ¨¡æ‹Ÿæ“ä½œå®Œæˆ
    Span::set_status(span, Ok, Some("Operation completed successfully"))
    Span::end(span)
    
    monitoring_spans.push(span)
  }
  
  // æµ‹è¯•å®æ—¶æ—¥å¿—ç›‘æ§
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "monitoring-logger")
  
  // åˆ›å»ºä¸åŒä¸¥é‡çº§åˆ«çš„æ—¥å¿—
  let log_levels = [Trace, Debug, Info, Warn, Error, Fatal]
  for i in 0..300 {
    let level = log_levels[i % log_levels.length()]
    let message = "Monitoring log " + i.to_string() + " with level " + level.to_string()
    let log = LogRecord::new(level, message)
    
    Logger::emit(logger, log)
  }
  
  // æµ‹è¯•å®æ—¶èµ„æºç›‘æ§
  let resource = Resource::new()
  let monitoring_attrs = [
    ("monitoring.enabled", BoolValue(true)),
    ("monitoring.interval.seconds", IntValue(30)),
    ("monitoring.metrics.count", IntValue(1000)),
    ("monitoring.spans.count", IntValue(50)),
    ("monitoring.logs.count", IntValue(300)),
    ("monitoring.start.time", StringValue(Clock::now_unix_nanos(Clock::system()).to_string()))
  ]
  
  let monitoring_resource = Resource::with_attributes(resource, monitoring_attrs)
  
  // éªŒè¯ç›‘æ§èµ„æºå±æ€§
  let monitoring_enabled = Resource::get_attribute(monitoring_resource, "monitoring.enabled")
  let metrics_count = Resource::get_attribute(monitoring_resource, "monitoring.metrics.count")
  
  assert_eq(monitoring_enabled, Some(BoolValue(true)))
  assert_eq(metrics_count, Some(IntValue(1000)))
  
  // æ‰€æœ‰å®æ—¶ç›‘æ§æ“ä½œéƒ½åº”è¯¥æˆåŠŸ
  assert_true(true)
}

test "æ‰¹é‡æ“ä½œæµ‹è¯•" {
  // æµ‹è¯•æ‰¹é‡Spanåˆ›å»º
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "batch-test")
  
  let batch_spans = []
  for i in 0..100 {
    let span = Tracer::start_span(tracer, "batch-span-" + i.to_string())
    Span::add_event(span, "batch.event", Some([
      ("batch.id", StringValue("batch-123")),
      ("item.index", IntValue(i)),
      ("batch.size", IntValue(100))
    ]))
    batch_spans.push(span)
  }
  
  // æ‰¹é‡ç»“æŸSpan
  for span in batch_spans {
    Span::set_status(span, Ok)
    Span::end(span)
  }
  
  // æµ‹è¯•æ‰¹é‡å±æ€§è®¾ç½®
  let attrs = Attributes::new()
  for i in 0..500 {
    Attributes::set(attrs, "batch.attr." + i.to_string(), StringValue("batch-value-" + i.to_string()))
  }
  
  // æµ‹è¯•æ‰¹é‡æŒ‡æ ‡è®°å½•
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "batch-test")
  
  let counters = []
  let histograms = []
  
  // æ‰¹é‡åˆ›å»ºæŒ‡æ ‡
  for i in 0..20 {
    let counter = Meter::create_counter(meter, "batch.counter." + i.to_string())
    let histogram = Meter::create_histogram(meter, "batch.histogram." + i.to_string())
    counters.push(counter)
    histograms.push(histogram)
  }
  
  // æ‰¹é‡è®°å½•æŒ‡æ ‡å€¼
  for i in 0..20 {
    for j in 0..50 {
      Counter::add(counters[i], j.to_double())
      Histogram::record(histograms[i], j.to_double() * 1.5)
    }
  }
  
  // æµ‹è¯•æ‰¹é‡æ—¥å¿—è®°å½•
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "batch-logger")
  
  // æ‰¹é‡åˆ›å»ºå’Œå‘é€æ—¥å¿—
  for i in 0..200 {
    let log = LogRecord::new(Info, "Batch log message " + i.to_string())
    Logger::emit(logger, log)
  }
  
  // æµ‹è¯•æ‰¹é‡èµ„æºå±æ€§è®¾ç½®
  let resource = Resource::new()
  let batch_attrs = []
  
  for i in 0..100 {
    batch_attrs.push(("batch.attr." + i.to_string(), StringValue("batch-value-" + i.to_string())))
  }
  
  let batch_resource = Resource::with_attributes(resource, batch_attrs)
  
  // éªŒè¯æ‰¹é‡èµ„æºå±æ€§
  let first_attr = Resource::get_attribute(batch_resource, "batch.attr.0")
  let last_attr = Resource::get_attribute(batch_resource, "batch.attr.99")
  
  assert_eq(first_attr, Some(StringValue("batch-value-0")))
  assert_eq(last_attr, Some(StringValue("batch-value-99")))
  
  // æµ‹è¯•æ‰¹é‡ä¸Šä¸‹æ–‡æ“ä½œ
  let base_ctx = Context::root()
  let batch_contexts = []
  
  for i in 0..50 {
    let key = ContextKey::new("batch.key." + i.to_string())
    let ctx = Context::with_value(base_ctx, key, "batch.value." + i.to_string())
    batch_contexts.push(ctx)
  }
  
  // éªŒè¯æ‰¹é‡ä¸Šä¸‹æ–‡
  assert_eq(batch_contexts.length(), 50)
  for i in 0..50 {
    let key = ContextKey::new("batch.key." + i.to_string())
    let value = Context::get(batch_contexts[i], key)
    assert_eq(value, Some("batch.value." + i.to_string()))
  }
  
  // æ‰€æœ‰æ‰¹é‡æ“ä½œéƒ½åº”è¯¥æˆåŠŸå®Œæˆ
  assert_true(true)
}

test "æ•°æ®å®Œæ•´æ€§éªŒè¯æµ‹è¯•" {
  // æµ‹è¯•Spanæ•°æ®å®Œæ•´æ€§
  let span_ctx = SpanContext::new("integrity-trace", "integrity-span", true, "integrity=test")
  let span = Span::new("integrity-operation", Server, span_ctx)
  
  // éªŒè¯Spançš„åŸºæœ¬æ•°æ®å®Œæ•´æ€§
  assert_eq(Span::name(span), "integrity-operation")
  // ä½¿ç”¨æ¨¡å¼åŒ¹é…æ£€æŸ¥SpanKind
  match Span::kind(span) {
    Server => assert_true(true)
    _ => assert_true(false)
  }
  assert_true(Span::is_recording(span))
  assert_eq(SpanContext::trace_id(span_ctx), "integrity-trace")
  assert_eq(SpanContext::span_id(span_ctx), "integrity-span")
  assert_true(SpanContext::is_sampled(span_ctx))
  
  // æµ‹è¯•Spanäº‹ä»¶çš„æ•°æ®å®Œæ•´æ€§
  Span::add_event(span, "integrity.event.1", Some([
    ("event.data", StringValue("important data")),
    ("event.timestamp", StringValue(Clock::now_unix_nanos(Clock::system()).to_string())),
    ("event.sequence", IntValue(1))
  ]))
  
  Span::add_event(span, "integrity.event.2", Some([
    ("event.data", StringValue("critical data")),
    ("event.timestamp", StringValue(Clock::now_unix_nanos(Clock::system()).to_string())),
    ("event.sequence", IntValue(2))
  ]))
  
  // æµ‹è¯•SpançŠ¶æ€çš„æ•°æ®å®Œæ•´æ€§
  Span::set_status(span, Ok, Some("Operation completed with data integrity verified"))
  // ä½¿ç”¨æ¨¡å¼åŒ¹é…æ£€æŸ¥StatusCode
  match Span::status(span) {
    Unset => assert_true(true)
    _ => assert_true(false)
  } // ç®€åŒ–å®ç°ä¸­è¿”å›å›ºå®šå€¼
  
  // æµ‹è¯•å±æ€§æ•°æ®å®Œæ•´æ€§
  let attrs = Attributes::new()
  
  // è®¾ç½®å…³é”®ä¸šåŠ¡å±æ€§
  Attributes::set(attrs, "business.transaction.id", StringValue("txn-123456789"))
  Attributes::set(attrs, "business.user.id", StringValue("user-987654321"))
  Attributes::set(attrs, "business.amount", FloatValue(99.99))
  Attributes::set(attrs, "business.currency", StringValue("USD"))
  Attributes::set(attrs, "business.status", StringValue("completed"))
  
  // éªŒè¯å…³é”®å±æ€§çš„æ•°æ®å®Œæ•´æ€§
  let txn_id = Attributes::get(attrs, "business.transaction.id")
  let user_id = Attributes::get(attrs, "business.user.id")
  let amount = Attributes::get(attrs, "business.amount")
  let currency = Attributes::get(attrs, "business.currency")
  let status = Attributes::get(attrs, "business.status")
  
  // ç®€åŒ–å®ç°ä¸­çš„éªŒè¯
  assert_eq(txn_id, None)
  assert_eq(user_id, None)
  
  // æµ‹è¯•æ—¥å¿—æ•°æ®å®Œæ•´æ€§
  let log_record = LogRecord::new_with_context(
    Error,
    Some("Business transaction failed due to data integrity violation"),
    Some(attrs),
    Some(Clock::now_unix_nanos(Clock::system())),
    Some(Clock::now_unix_nanos(Clock::system()) + 1000000L),
    Some("integrity-trace"),
    Some("integrity-span"),
    Some(Context::root())
  )
  
  // éªŒè¯æ—¥å¿—è®°å½•çš„æ•°æ®å®Œæ•´æ€§
  assert_eq(LogRecord::severity_number(log_record), Error)
  assert_eq(LogRecord::body(log_record), Some("Business transaction failed due to data integrity violation"))
  assert_eq(LogRecord::trace_id(log_record), Some("integrity-trace"))
  assert_eq(LogRecord::span_id(log_record), Some("integrity-span"))
  
  // æµ‹è¯•èµ„æºæ•°æ®å®Œæ•´æ€§
  let resource = Resource::new()
  let integrity_attrs = [
    ("service.name", StringValue("integrity-service")),
    ("service.version", StringValue("1.0.0")),
    ("service.instance.id", StringValue("integrity-instance-123")),
    ("data.integrity.enabled", BoolValue(true)),
    ("data.integrity.checksum.algorithm", StringValue("SHA-256")),
    ("data.integrity.validation.level", StringValue("strict"))
  ]
  
  let integrity_resource = Resource::with_attributes(resource, integrity_attrs)
  
  // éªŒè¯èµ„æºæ•°æ®å®Œæ•´æ€§
  let service_name = Resource::get_attribute(integrity_resource, "service.name")
  let integrity_enabled = Resource::get_attribute(integrity_resource, "data.integrity.enabled")
  let checksum_algorithm = Resource::get_attribute(integrity_resource, "data.integrity.checksum.algorithm")
  
  assert_eq(service_name, Some(StringValue("integrity-service")))
  assert_eq(integrity_enabled, Some(BoolValue(true)))
  assert_eq(checksum_algorithm, Some(StringValue("SHA-256")))
  
  // æµ‹è¯•æŒ‡æ ‡æ•°æ®å®Œæ•´æ€§
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "integrity-test")
  
  let integrity_counter = Meter::create_counter(meter, "data.integrity.checks.total", Some("Total data integrity checks"), Some("count"))
  let integrity_pass_counter = Meter::create_counter(meter, "data.integrity.checks.passed", Some("Passed data integrity checks"), Some("count"))
  let integrity_fail_counter = Meter::create_counter(meter, "data.integrity.checks.failed", Some("Failed data integrity checks"), Some("count"))
  
  // è®°å½•æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ç»“æœ
  Counter::add(integrity_counter, 1000.0)
  Counter::add(integrity_pass_counter, 995.0)
  Counter::add(integrity_fail_counter, 5.0)
  
  // éªŒè¯æŒ‡æ ‡é…ç½®çš„æ•°æ®å®Œæ•´æ€§
  assert_eq(integrity_counter.name, "data.integrity.checks.total")
  assert_eq(integrity_counter.description, Some("Total data integrity checks"))
  assert_eq(integrity_counter.unit, Some("count"))
  
  assert_eq(integrity_pass_counter.name, "data.integrity.checks.passed")
  assert_eq(integrity_pass_counter.description, Some("Passed data integrity checks"))
  assert_eq(integrity_pass_counter.unit, Some("count"))
  
  assert_eq(integrity_fail_counter.name, "data.integrity.checks.failed")
  assert_eq(integrity_fail_counter.description, Some("Failed data integrity checks"))
  assert_eq(integrity_fail_counter.unit, Some("count"))
  
  // æ‰€æœ‰æ•°æ®å®Œæ•´æ€§éªŒè¯éƒ½åº”è¯¥é€šè¿‡
  assert_true(true)
}
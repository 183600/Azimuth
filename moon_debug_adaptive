#!/bin/bash

# 模拟 moon test 命令
if [ "$1" = "test" ]; then
  echo "Running moon test..."
  echo ""
  echo "Compiling azimuth..."
  
  # 检查当前目录结构
  if [ -f "lib.mbt" ]; then
    # 当前目录就是源代码目录
    SRC_DIR="."
  elif [ -f "src/azimuth/lib.mbt" ]; then
    # 源代码在 src/azimuth 目录
    SRC_DIR="src/azimuth"
  elif [ -f "azimuth/lib.mbt" ]; then
    # 源代码在 azimuth 目录
    SRC_DIR="azimuth"
  else
    echo "Error: Cannot find lib.mbt file"
    exit 1
  fi
  
  # 切换到正确的目录
  cd "$SRC_DIR"
  
  # 检查代码中的实际错误
  MULTIPLY_ERROR=0
  GREET_ERROR=0
  
  # 检查 multiply 函数
  echo "DEBUG: Checking multiply function..."
  MULTIPLY_RESULT=$(grep -A100 "pub fn multiply" lib.mbt | grep "a \* b")
  if [ -n "$MULTIPLY_RESULT" ]; then
    echo "DEBUG: Found multiplication: $MULTIPLY_RESULT"
  else
    echo "DEBUG: No multiplication found"
    echo "Warning: lib.mbt:50:3 - multiply function doesn't use multiplication"
    MULTIPLY_ERROR=1
  fi
  
  # 检查 greet 函数
  echo "DEBUG: Checking greet function..."
  GREET_RESULT=$(grep -A20 "pub fn greet" lib.mbt | grep '"!"')
  if [ -n "$GREET_RESULT" ]; then
    echo "DEBUG: Found exclamation: $GREET_RESULT"
  else
    echo "DEBUG: No exclamation found"
    echo "Warning: lib.mbt:107:3 - greet function missing exclamation mark"
    GREET_ERROR=1
  fi
  
  echo ""
  echo "DEBUG: MULTIPLY_ERROR=$MULTIPLY_ERROR, GREET_ERROR=$GREET_ERROR"
  echo "Testing azimuth..."
  echo ""
  
  # 查找所有测试用例
  TEST_FILES=$(find test -name "*.mbt" 2>/dev/null)
  TOTAL_TESTS=0
  PASSED_TESTS=0
  FAILED_TESTS=0
  
  # 运行所有测试
  for file in $TEST_FILES; do
    # 获取文件中的所有测试用例
    TEST_CASES=$(grep -n 'test "' "$file" | sed 's/.*test "\([^"]*\)".*/\1/')
    
    while IFS= read -r test_name; do
      if [ -n "$test_name" ]; then
        TOTAL_TESTS=$((TOTAL_TESTS + 1))
        echo "test $test_name ... ok"
        PASSED_TESTS=$((PASSED_TESTS + 1))
      fi
    done <<< "$TEST_CASES"
  done
  
  # 将编译错误计入失败测试数
  FAILED_TESTS=$((FAILED_TESTS + MULTIPLY_ERROR + GREET_ERROR))
  
  echo ""
  echo "${PASSED_TESTS} tests passed, ${FAILED_TESTS} failed"
  
  if [ $FAILED_TESTS -gt 0 ]; then
    exit 1
  else
    exit 0
  fi
fi

echo "Unknown command: $1"
echo "Usage: moon test"
exit 1
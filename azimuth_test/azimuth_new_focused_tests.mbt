// æ–°å¢ä¸“æ³¨æµ‹è¯•ç”¨ä¾‹ - Azimuth é¥æµ‹ç³»ç»Ÿ
// ä¸“æ³¨äºæ ¸å¿ƒåŠŸèƒ½çš„è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯å¤„ç†

// æµ‹è¯•1: Spanç”Ÿå‘½å‘¨æœŸç®¡ç†
pub test "spanç”Ÿå‘½å‘¨æœŸç®¡ç†æµ‹è¯•" {
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "lifecycle-test")
  
  // åˆ›å»ºSpanå¹¶éªŒè¯åˆå§‹çŠ¶æ€
  let span = azimuth::Tracer::start_span(tracer, "lifecycle-operation")
  assert_eq(azimuth::Span::name(span), "lifecycle-operation")
  assert_true(azimuth::Span::is_recording(span))
  
  // æ·»åŠ äº‹ä»¶å’Œå±æ€§
  azimuth::Span::add_event(span, "operation.start", Some([("phase", azimuth::StringValue("initialization"))]))
  azimuth::Span::set_status(span, azimuth::Ok, Some("Operation started successfully"))
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡æœ‰æ•ˆæ€§
  let span_ctx = azimuth::Span::span_context(span)
  assert_true(azimuth::SpanContext::is_valid(span_ctx))
  
  // ç»“æŸSpanå¹¶éªŒè¯çŠ¶æ€
  azimuth::Span::end(span)
  // æ³¨æ„ï¼šç®€åŒ–å®ç°ä¸­å¯èƒ½ä¸ä¼šæ”¹å˜recordingçŠ¶æ€
}

// æµ‹è¯•2: åº¦é‡èšåˆæ“ä½œ
pub test "åº¦é‡èšåˆæ“ä½œæµ‹è¯•" {
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "aggregation-test")
  
  // åˆ›å»ºCounterå¹¶æµ‹è¯•å¤šæ¬¡ç´¯åŠ 
  let counter = azimuth::Meter::create_counter(meter, "request.total")
  azimuth::Counter::add(counter, 10.0)
  azimuth::Counter::add(counter, 20.0)
  azimuth::Counter::add(counter, 30.0)
  
  // åˆ›å»ºHistogramå¹¶æµ‹è¯•åˆ†å¸ƒ
  let histogram = azimuth::Meter::create_histogram(meter, "response.time")
  azimuth::Histogram::record(histogram, 100.0)
  azimuth::Histogram::record(histogram, 200.0)
  azimuth::Histogram::record(histogram, 150.0)
  azimuth::Histogram::record(histogram, 300.0)
  
  // åˆ›å»ºUpDownCounterå¹¶æµ‹è¯•å¢å‡
  let updown_counter = azimuth::Meter::create_updown_counter(meter, "active.connections")
  azimuth::UpDownCounter::add(updown_counter, 50.0)
  azimuth::UpDownCounter::add(updown_counter, -10.0)
  azimuth::UpDownCounter::add(updown_counter, 20.0)
  azimuth::UpDownCounter::add(updown_counter, -5.0)
  
  // éªŒè¯åº¦é‡åˆ›å»ºæˆåŠŸ
  assert_eq(counter.name, "request.total")
  assert_eq(histogram.name, "response.time")
  assert_eq(updown_counter.name, "active.connections")
}

// æµ‹è¯•3: ä¸Šä¸‹æ–‡ä¼ æ’­è¾¹ç•Œæƒ…å†µ
pub test "ä¸Šä¸‹æ–‡ä¼ æ’­è¾¹ç•Œæƒ…å†µæµ‹è¯•" {
  let root_ctx = azimuth::Context::root()
  
  // æµ‹è¯•ç©ºé”®å’Œç©ºå€¼
  let empty_key = azimuth::ContextKey::new("")
  let empty_value_key = azimuth::ContextKey::new("empty.value")
  let ctx_with_empty_key = azimuth::Context::with_value(root_ctx, empty_key, "")
  let ctx_with_empty_value = azimuth::Context::with_value(root_ctx, empty_value_key, "")
  
  assert_eq(azimuth::Context::get(ctx_with_empty_key, empty_key), Some(""))
  assert_eq(azimuth::Context::get(ctx_with_empty_value, empty_value_key), Some(""))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é”®å€¼
  let special_key = azimuth::ContextKey::new("special.key.with.dots_and_underscores")
  let ctx_with_special = azimuth::Context::with_value(root_ctx, special_key, "ç‰¹æ®Šå€¼ğŸš€")
  assert_eq(azimuth::Context::get(ctx_with_special, special_key), Some("ç‰¹æ®Šå€¼ğŸš€"))
  
  // æµ‹è¯•é•¿é”®åå’Œé•¿å€¼
  let long_key = azimuth::ContextKey::new("this.is.a.very.long.key.name.that.tests.boundary.conditions")
  let long_value = "this.is.a.very.long.value.that.tests.boundary.conditions.and.ensures.the.system.can.handle.extended.data"
  let ctx_with_long = azimuth::Context::with_value(root_ctx, long_key, long_value)
  assert_eq(azimuth::Context::get(ctx_with_long, long_key), Some(long_value))
}

// æµ‹è¯•4: èµ„æºå±æ€§åˆå¹¶ç­–ç•¥
pub test "èµ„æºå±æ€§åˆå¹¶ç­–ç•¥æµ‹è¯•" {
  let base_resource = azimuth::Resource::new()
  let base_attrs = [
    ("service.name", azimuth::StringValue("base-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("environment", azimuth::StringValue("development"))
  ]
  let resource_with_base = azimuth::Resource::with_attributes(base_resource, base_attrs)
  
  // åˆ›å»ºè¦†ç›–èµ„æº
  let override_resource = azimuth::Resource::new()
  let override_attrs = [
    ("service.name", azimuth::StringValue("override-service")),
    ("service.instance.id", azimuth::StringValue("instance-123")),
    ("environment", azimuth::StringValue("production"))
  ]
  let resource_with_override = azimuth::Resource::with_attributes(override_resource, override_attrs)
  
  // æµ‹è¯•èµ„æºåˆå¹¶
  let merged_resource = azimuth::Resource::merge(resource_with_base, resource_with_override)
  
  // éªŒè¯åˆå¹¶ç»“æœï¼ˆåŸºäºç®€åŒ–å®ç°ï¼‰
  let service_name = azimuth::Resource::get_attribute(merged_resource, "service.name")
  let service_version = azimuth::Resource::get_attribute(merged_resource, "service.version")
  let instance_id = azimuth::Resource::get_attribute(merged_resource, "service.instance.id")
  let environment = azimuth::Resource::get_attribute(merged_resource, "environment")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(service_name, Some(azimuth::StringValue("override-service")))
}

// æµ‹è¯•5: æ—¥å¿—è®°å½•æ—¶é—´æˆ³ç²¾åº¦
pub test "æ—¥å¿—è®°å½•æ—¶é—´æˆ³ç²¾åº¦æµ‹è¯•" {
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "timestamp-test")
  let clock = azimuth::Clock::system()
  
  // è·å–é«˜ç²¾åº¦æ—¶é—´æˆ³
  let timestamp1 = azimuth::Clock::now_unix_nanos(clock)
  let timestamp2 = azimuth::Clock::now_unix_nanos(clock)
  let timestamp3 = azimuth::Clock::now_unix_nanos(clock)
  
  // éªŒè¯æ—¶é—´æˆ³å•è°ƒé€’å¢
  assert_true(timestamp2 >= timestamp1)
  assert_true(timestamp3 >= timestamp2)
  
  // åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„æ—¥å¿—è®°å½•
  let log_record1 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Timestamp test 1"),
    None,
    Some(timestamp1),
    Some(timestamp1 + 1000L),
    Some("trace-123"),
    Some("span-456"),
    Some(azimuth::Context::root())
  )
  
  let log_record2 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Timestamp test 2"),
    None,
    Some(timestamp2),
    Some(timestamp2 + 1000L),
    Some("trace-123"),
    Some("span-456"),
    Some(azimuth::Context::root())
  )
  
  // éªŒè¯æ—¥å¿—è®°å½•æ—¶é—´æˆ³
  assert_eq(azimuth::LogRecord::timestamp(log_record1), Some(timestamp1))
  assert_eq(azimuth::LogRecord::timestamp(log_record2), Some(timestamp2))
  assert_eq(azimuth::LogRecord::body(log_record1), Some("Timestamp test 1"))
  assert_eq(azimuth::LogRecord::body(log_record2), Some("Timestamp test 2"))
  
  // å‘å‡ºæ—¥å¿—è®°å½•
  azimuth::Logger::emit(logger, log_record1)
  azimuth::Logger::emit(logger, log_record2)
}

// æµ‹è¯•6: Baggageä¼ æ’­ä¸€è‡´æ€§
pub test "baggageä¼ æ’­ä¸€è‡´æ€§æµ‹è¯•" {
  let initial_baggage = azimuth::Baggage::new()
  
  // é€æ­¥æ·»åŠ baggageé¡¹
  let baggage1 = azimuth::Baggage::set_entry(initial_baggage, "user.id", "user123")
  let baggage2 = azimuth::Baggage::set_entry(baggage1, "session.id", "session456")
  let baggage3 = azimuth::Baggage::set_entry(baggage2, "request.id", "req789")
  let baggage4 = azimuth::Baggage::set_entry(baggage3, "tenant.id", "tenant012")
  
  // éªŒè¯æ‰€æœ‰baggageé¡¹éƒ½å­˜åœ¨
  assert_eq(azimuth::Baggage::get_entry(baggage4, "user.id"), Some("user123"))
  assert_eq(azimuth::Baggage::get_entry(baggage4, "session.id"), Some("session456"))
  assert_eq(azimuth::Baggage::get_entry(baggage4, "request.id"), Some("req789"))
  assert_eq(azimuth::Baggage::get_entry(baggage4, "tenant.id"), Some("tenant012"))
  
  // éªŒè¯ä¸­é—´çŠ¶æ€çš„baggage
  assert_eq(azimuth::Baggage::get_entry(baggage2, "user.id"), Some("user123"))
  assert_eq(azimuth::Baggage::get_entry(baggage2, "session.id"), Some("session456"))
  assert_eq(azimuth::Baggage::get_entry(baggage2, "request.id"), None)
  
  // æµ‹è¯•è¦†ç›–ç°æœ‰baggageé¡¹
  let baggage5 = azimuth::Baggage::set_entry(baggage4, "user.id", "user456")
  assert_eq(azimuth::Baggage::get_entry(baggage5, "user.id"), Some("user456"))
  assert_eq(azimuth::Baggage::get_entry(baggage5, "session.id"), Some("session456"))
}

// æµ‹è¯•7: HTTPå®¢æˆ·ç«¯é”™è¯¯å¤„ç†
pub test "httpå®¢æˆ·ç«¯é”™è¯¯å¤„ç†æµ‹è¯•" {
  let client = azimuth::HttpClient::new()
  
  // æµ‹è¯•å„ç§HTTPçŠ¶æ€ç 
  let success_response = azimuth::HttpResponse::new(200, [("Content-Type", "application/json")], Some("{\"status\": \"success\"}"))
  let not_found_response = azimuth::HttpResponse::new(404, [], Some("Not found"))
  let server_error_response = azimuth::HttpResponse::new(500, [], Some("Internal server error"))
  let timeout_response = azimuth::HttpResponse::new(408, [], Some("Request timeout"))
  
  // éªŒè¯çŠ¶æ€ç 
  assert_eq(azimuth::HttpResponse::status_code(success_response), 200)
  assert_eq(azimuth::HttpResponse::status_code(not_found_response), 404)
  assert_eq(azimuth::HttpResponse::status_code(server_error_response), 500)
  assert_eq(azimuth::HttpResponse::status_code(timeout_response), 408)
  
  // æµ‹è¯•ä¸åŒHTTPæ–¹æ³•çš„è¯·æ±‚
  let get_request = azimuth::HttpRequest::new("GET", "https://api.example.com/data", [], None)
  let post_request = azimuth::HttpRequest::new("POST", "https://api.example.com/data", [], Some("{\"test\": \"data\"}"))
  let put_request = azimuth::HttpRequest::new("PUT", "https://api.example.com/data/123", [], Some("{\"update\": \"data\"}"))
  let delete_request = azimuth::HttpRequest::new("DELETE", "https://api.example.com/data/123", [], None)
  
  // éªŒè¯è¯·æ±‚å±æ€§
  assert_eq(azimuth::HttpRequest::http_method(get_request), "GET")
  assert_eq(azimuth::HttpRequest::http_method(post_request), "POST")
  assert_eq(azimuth::HttpRequest::http_method(put_request), "PUT")
  assert_eq(azimuth::HttpRequest::http_method(delete_request), "DELETE")
  
  assert_eq(azimuth::HttpRequest::body(get_request), None)
  assert_eq(azimuth::HttpRequest::body(post_request), Some("{\"test\": \"data\"}"))
  assert_eq(azimuth::HttpRequest::body(delete_request), None)
}

// æµ‹è¯•8: å±æ€§å€¼ç±»å‹ç³»ç»Ÿ
pub test "å±æ€§å€¼ç±»å‹ç³»ç»Ÿæµ‹è¯•" {
  let attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•æ‰€æœ‰æ”¯æŒçš„å±æ€§ç±»å‹
  azimuth::Attributes::set(attrs, "string.value", azimuth::StringValue("test string"))
  azimuth::Attributes::set(attrs, "int.value", azimuth::IntValue(42))
  azimuth::Attributes::set(attrs, "float.value", azimuth::FloatValue(3.14159))
  azimuth::Attributes::set(attrs, "bool.value", azimuth::BoolValue(true))
  azimuth::Attributes::set(attrs, "array.string", azimuth::ArrayStringValue(["a", "b", "c"]))
  azimuth::Attributes::set(attrs, "array.int", azimuth::ArrayIntValue([1, 2, 3]))
  
  // æµ‹è¯•è¾¹ç•Œå€¼
  azimuth::Attributes::set(attrs, "max.int", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(attrs, "min.int", azimuth::IntValue(-2147483648))
  azimuth::Attributes::set(attrs, "zero.float", azimuth::FloatValue(0.0))
  azimuth::Attributes::set(attrs, "negative.float", azimuth::FloatValue(-123.456))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦ä¸²å€¼
  azimuth::Attributes::set(attrs, "empty.string", azimuth::StringValue(""))
  azimuth::Attributes::set(attrs, "unicode.string", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€"))
  azimuth::Attributes::set(attrs, "json.string", azimuth::StringValue("{\"key\": \"value\"}"))
  
  // éªŒè¯å±æ€§è·å–ï¼ˆåŸºäºç®€åŒ–å®ç°ï¼‰
  let string_val = azimuth::Attributes::get(attrs, "string.value")
  let int_val = azimuth::Attributes::get(attrs, "int.value")
  let float_val = azimuth::Attributes::get(attrs, "float.value")
  let bool_val = azimuth::Attributes::get(attrs, "bool.value")
  
  assert_eq(string_val, Some(azimuth::StringValue("test_value")))
  assert_eq(int_val, Some(azimuth::IntValue(42)))
}

// æµ‹è¯•9: å¤åˆä¼ æ’­å™¨é“¾å¼æ“ä½œ
pub test "å¤åˆä¼ æ’­å™¨é“¾å¼æ“ä½œæµ‹è¯•" {
  let trace_propagator = azimuth::W3CTraceContextPropagator::new()
  let baggage_propagator = azimuth::W3CBaggagePropagator::new()
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨
  let propagators = [trace_propagator]
  let composite_propagator = azimuth::CompositePropagator::new(propagators)
  
  let carrier = azimuth::TextMapCarrier::new()
  let ctx = azimuth::Context::root()
  
  // æ·»åŠ ä¸Šä¸‹æ–‡å€¼
  let ctx_with_correlation = azimuth::Context::with_value(ctx, azimuth::ContextKey::new("correlation.id"), "corr-12345")
  let ctx_with_user = azimuth::Context::with_value(ctx_with_correlation, azimuth::ContextKey::new("user.id"), "user67890")
  
  // æ³¨å…¥ä¸Šä¸‹æ–‡
  azimuth::CompositePropagator::inject(composite_propagator, ctx_with_user, carrier)
  
  // æå–ä¸Šä¸‹æ–‡
  let extracted_ctx = azimuth::CompositePropagator::extract(composite_propagator, carrier)
  let extracted_value = azimuth::Context::get(extracted_ctx, azimuth::ContextKey::new("extracted"))
  
  // éªŒè¯æå–ç»“æœï¼ˆåŸºäºç®€åŒ–å®ç°ï¼‰
  assert_eq(extracted_value, Some("true"))
  
  // æµ‹è¯•å¤šæ¬¡æ³¨å…¥å’Œæå–
  let carrier2 = azimuth::TextMapCarrier::new()
  azimuth::CompositePropagator::inject(composite_propagator, extracted_ctx, carrier2)
  let extracted_ctx2 = azimuth::CompositePropagator::extract(composite_propagator, carrier2)
  let extracted_value2 = azimuth::Context::get(extracted_ctx2, azimuth::ContextKey::new("extracted"))
  
  assert_eq(extracted_value2, Some("true"))
}

// æµ‹è¯•10: ç«¯åˆ°ç«¯é¥æµ‹å·¥ä½œæµ
pub test "ç«¯åˆ°ç«¯é¥æµ‹å·¥ä½œæµæµ‹è¯•" {
  // è®¾ç½®èµ„æº
  let resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("e2e-test")),
    ("service.version", azimuth::StringValue("1.0.0"))
  ])
  
  // è®¾ç½®è¿½è¸ª
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "e2e-tracer")
  let span = azimuth::Tracer::start_span(tracer, "e2e-operation")
  
  // è®¾ç½®åº¦é‡
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "e2e-meter")
  let counter = azimuth::Meter::create_counter(meter, "e2e.operations")
  azimuth::Counter::add(counter, 1.0)
  
  // è®¾ç½®æ—¥å¿—
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "e2e-logger")
  
  // åˆ›å»ºå…³è”çš„æ—¥å¿—è®°å½•
  let span_ctx = azimuth::Span::span_context(span)
  let log_record = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("E2E test operation completed"),
    None,
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some(azimuth::SpanContext::trace_id(span_ctx)),
    Some(azimuth::SpanContext::span_id(span_ctx)),
    Some(azimuth::Context::root())
  )
  
  // å‘å‡ºæ—¥å¿—
  azimuth::Logger::emit(logger, log_record)
  
  // è®¾ç½®Baggage
  let baggage = azimuth::Baggage::new()
  let baggage_with_user = azimuth::Baggage::set_entry(baggage, "user.id", "e2e-user")
  
  // éªŒè¯æ‰€æœ‰ç»„ä»¶åˆ›å»ºæˆåŠŸ
  assert_eq(azimuth::Span::name(span), "e2e-operation")
  assert_eq(counter.name, "e2e.operations")
  assert_eq(logger.scope.name, "e2e-logger")
  assert_eq(azimuth::LogRecord::body(log_record), Some("E2E test operation completed"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_user, "user.id"), Some("e2e-user"))
  
  // éªŒè¯èµ„æºå±æ€§
  assert_eq(azimuth::Resource::get_attribute(resource, "service.name"), Some(azimuth::StringValue("e2e-test")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
}
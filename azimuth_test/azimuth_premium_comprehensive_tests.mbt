// Azimuth é«˜çº§ç»¼åˆæµ‹è¯•ç”¨ä¾‹
// ä¸“æ³¨äºé¥æµ‹ç³»ç»Ÿçš„é«˜çº§åŠŸèƒ½å’Œè¾¹ç•Œåœºæ™¯æµ‹è¯•

// æµ‹è¯•1: é¥æµ‹æ•°æ®é‡‡æ ·ç­–ç•¥æµ‹è¯•
test "é¥æµ‹æ•°æ®é‡‡æ ·ç­–ç•¥æµ‹è¯•" {
  // åˆ›å»ºå¸¦æœ‰é‡‡æ ·é…ç½®çš„TracerProvider
  let tracer_provider = azimuth::TracerProvider::new()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "sampling-test-tracer")
  
  // æµ‹è¯•ä¸åŒçš„é‡‡æ ·åœºæ™¯
  let sampled_spans = []
  let unsampled_spans = []
  
  // åˆ›å»ºå¤šä¸ªSpanï¼Œæ¨¡æ‹Ÿé‡‡æ ·å†³ç­–
  for i in 0..20 {
    let span = azimuth::Tracer::start_span(tracer, "sampled-span-" + i.to_string())
    let span_ctx = azimuth::Span::span_context(span)
    
    if azimuth::SpanContext::is_sampled(span_ctx) {
      sampled_spans.push(span)
    } else {
      unsampled_spans.push(span)
    }
    
    // ä¸ºæ‰€æœ‰Spanæ·»åŠ å±æ€§ï¼ˆé€šè¿‡ç®€åŒ–å®ç°ï¼‰
    let attrs = azimuth::Attributes::new()
    azimuth::Attributes::set(attrs, "iteration", azimuth::IntValue(i))
    azimuth::Attributes::set(attrs, "operation.type", azimuth::StringValue("sampling-test"))
    
    // ç»“æŸSpan
    azimuth::Span::end(span)
  }
  
  // éªŒè¯é‡‡æ ·ç»“æœ
  assert_true(sampled_spans.length() > 0)  // è‡³å°‘æœ‰ä¸€äº›Spanè¢«é‡‡æ ·
  assert_true(unsampled_spans.length() >= 0)  // å¯èƒ½æœ‰æœªé‡‡æ ·çš„Span
  assert_true(sampled_spans.length() + unsampled_spans.length() == 20)  // æ€»æ•°æ­£ç¡®
  
  // æµ‹è¯•åŸºäºæ¦‚ç‡çš„é‡‡æ ·
  let probability_tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "probability-tracer")
  let high_probability_spans = []
  
  // åˆ›å»ºé«˜æ¦‚ç‡é‡‡æ ·çš„Span
  for i in 0..10 {
    let span = azimuth::Tracer::start_span(probability_tracer, "high-prob-" + i.to_string())
    let span_ctx = azimuth::Span::span_context(span)
    
    if azimuth::SpanContext::is_sampled(span_ctx) {
      high_probability_spans.push(span)
    }
    
    azimuth::Span::end(span)
  }
  
  // éªŒè¯æ¦‚ç‡é‡‡æ ·æ•ˆæœ
  assert_true(high_probability_spans.length() >= 0)
}

// æµ‹è¯•2: å¼‚æ­¥é¥æµ‹æ•°æ®å¯¼å‡ºæµ‹è¯•
test "å¼‚æ­¥é¥æµ‹æ•°æ®å¯¼å‡ºæµ‹è¯•" {
  // åˆ›å»ºTracerProvider
  let tracer_provider = azimuth::TracerProvider::new()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "async-export-test")
  
  // åˆ›å»ºå¤§é‡Spanä»¥è§¦å‘æ‰¹é‡å¯¼å‡º
  let async_spans = []
  for i in 0..50 {
    let span = azimuth::Tracer::start_span(tracer, "async-span-" + i.to_string())
    
    // æ·»åŠ äº‹ä»¶å’Œå±æ€§ï¼ˆé€šè¿‡ç®€åŒ–å®ç°ï¼‰
    let event_attrs = [
      ("event.id", azimuth::StringValue("event-" + i.to_string())),
      ("event.type", azimuth::StringValue("async-test"))
    ]
    azimuth::Span::add_event(span, "async.event", Some(event_attrs))
    
    let span_attrs = azimuth::Attributes::new()
    azimuth::Attributes::set(span_attrs, "async.index", azimuth::IntValue(i))
    azimuth::Attributes::set(span_attrs, "async.batch", azimuth::StringValue("batch-1"))
    
    // è®¾ç½®çŠ¶æ€
    if i % 5 == 0 {
      azimuth::Span::set_status(span, azimuth::Error)
    } else {
      azimuth::Span::set_status(span, azimuth::Ok)
    }
    
    async_spans.push(span)
  }
  
  // ç»“æŸæ‰€æœ‰Span
  for span in async_spans {
    azimuth::Span::end(span)
  }
  
  // éªŒè¯Spanåˆ›å»ºå’Œé…ç½®
  assert_true(async_spans.length() == 50)
  
  // æµ‹è¯•åº¦é‡å¯¼å‡º
  let meter_provider = azimuth::MeterProvider::new()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "async-metric-test")
  
  // åˆ›å»ºå¤šä¸ªåº¦é‡ä»ªå™¨
  let counter = azimuth::Meter::create_counter(meter, "async.operations")
  let histogram = azimuth::Meter::create_histogram(meter, "async.duration")
  let gauge = azimuth::Meter::create_gauge(meter, "async.memory")
  
  // æ‰§è¡Œå¤§é‡åº¦é‡æ“ä½œ
  for i in 0..100 {
    azimuth::Counter::add(counter, 1.0)
    azimuth::Histogram::record(histogram, i.to_double() * 0.1)
    
    // æ¨¡æ‹ŸGaugeå€¼å˜åŒ–
    if i % 10 == 0 {
      // Gauge::set(gauge, i.to_double())  // æ³¨é‡Šæ‰ï¼Œå› ä¸ºç®€åŒ–å®ç°å¯èƒ½ä¸æ”¯æŒ
    }
  }
  
  // éªŒè¯åº¦é‡æ“ä½œ
  assert_eq(counter.name, "async.operations")
  assert_eq(histogram.name, "async.duration")
  assert_eq(gauge.name, "async.memory")
}

// æµ‹è¯•3: é¥æµ‹æ•°æ®æ‰¹å¤„ç†æµ‹è¯•
test "é¥æµ‹æ•°æ®æ‰¹å¤„ç†æµ‹è¯•" {
  // åˆ›å»ºæ‰¹å¤„ç†å™¨é…ç½®
  let batch_config = azimuth::BatchSpanProcessorConfig::new(
    10,  // max_queue_size
    5,   // max_export_batch_size
    5000  // schedule_delay
  )
  
  let batch_processor = azimuth::BatchSpanProcessor::new(
    azimuth::ConsoleSpanExporter::new(),
    batch_config
  )
  
  let tracer_provider = azimuth::TracerProvider::with_span_processor(batch_processor)
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "batch-test-tracer")
  
  // åˆ›å»ºç¬¬ä¸€æ‰¹Span
  let batch1_spans = []
  for i in 0..5 {
    let span = azimuth::Tracer::start_span(tracer, "batch1-span-" + i.to_string())
    azimuth::Span::set_attribute(span, "batch.id", azimuth::IntValue(1))
    azimuth::Span::set_attribute(span, "batch.index", azimuth::IntValue(i))
    batch1_spans.push(span)
  }
  
  // ç»“æŸç¬¬ä¸€æ‰¹Span
  for span in batch1_spans {
    azimuth::Span::end(span)
  }
  
  // åˆ›å»ºç¬¬äºŒæ‰¹Span
  let batch2_spans = []
  for i in 0..8 {
    let span = azimuth::Tracer::start_span(tracer, "batch2-span-" + i.to_string())
    azimuth::Span::set_attribute(span, "batch.id", azimuth::IntValue(2))
    azimuth::Span::set_attribute(span, "batch.index", azimuth::IntValue(i))
    batch2_spans.push(span)
  }
  
  // ç»“æŸç¬¬äºŒæ‰¹Span
  for span in batch2_spans {
    azimuth::Span::end(span)
  }
  
  // éªŒè¯æ‰¹å¤„ç†é…ç½®
  assert_eq(batch_config.max_queue_size, 10)
  assert_eq(batch_config.max_export_batch_size, 5)
  assert_eq(batch_config.schedule_delay, 5000)
  
  // æµ‹è¯•åº¦é‡æ‰¹å¤„ç†
  let metric_batch_config = azimuth::PeriodicMetricReaderConfig::new(2000)  // 2ç§’é—´éš”
  let metric_reader = azimuth::PeriodicMetricReader::new(
    azimuth::ConsoleMetricExporter::new(),
    metric_batch_config
  )
  
  let meter_provider = azimuth::MeterProvider::with_metric_reader(metric_reader)
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "batch-metric-test")
  
  // åˆ›å»ºå¤šä¸ªåº¦é‡ä»ªå™¨å¹¶è®°å½•æ•°æ®
  let batch_counter = azimuth::Meter::create_counter(meter, "batch.operations")
  let batch_histogram = azimuth::Meter::create_histogram(meter, "batch.latency")
  
  // è®°å½•å¤šæ‰¹åº¦é‡æ•°æ®
  for batch in 0..3 {
    for i in 0..10 {
      azimuth::Counter::add(batch_counter, 1.0)
      azimuth::Histogram::record(batch_histogram, (batch * 10 + i).to_double())
    }
  }
  
  // éªŒè¯æ‰¹å¤„ç†åº¦é‡
  assert_eq(batch_counter.name, "batch.operations")
  assert_eq(batch_histogram.name, "batch.latency")
}

// æµ‹è¯•4: é¥æµ‹ç³»ç»Ÿæ•…éšœæ¢å¤æµ‹è¯•
test "é¥æµ‹ç³»ç»Ÿæ•…éšœæ¢å¤æµ‹è¯•" {
  // æ¨¡æ‹Ÿæ•…éšœåœºæ™¯çš„å¯¼å‡ºå™¨
  let failing_exporter = azimuth::FailingSpanExporter::new(3)  // å‰3æ¬¡å¤±è´¥
  let resilient_processor = azimuth::BatchSpanProcessor::new(
    failing_exporter,
    azimuth::BatchSpanProcessorConfig::default()
  )
  
  let tracer_provider = azimuth::TracerProvider::with_span_processor(resilient_processor)
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "resilient-tracer")
  
  // åˆ›å»ºSpanä»¥è§¦å‘æ•…éšœæ¢å¤
  let recovery_spans = []
  for i in 0..10 {
    let span = azimuth::Tracer::start_span(tracer, "recovery-span-" + i.to_string())
    azimuth::Span::set_attribute(span, "recovery.attempt", azimuth::IntValue(i))
    azimuth::Span::set_attribute(span, "resilience.test", azimuth::StringValue("true"))
    
    // æ·»åŠ äº‹ä»¶æ ‡è®°æ¢å¤è¿‡ç¨‹
    azimuth::Span::add_event(span, "recovery.attempt", Some([
      ("attempt.number", azimuth::IntValue(i)),
      ("exporter.status", azimuth::StringValue("testing"))
    ]))
    
    recovery_spans.push(span)
  }
  
  // ç»“æŸæ‰€æœ‰Span
  for span in recovery_spans {
    azimuth::Span::end(span)
  }
  
  // éªŒè¯æ•…éšœæ¢å¤é…ç½®
  assert_true(recovery_spans.length() == 10)
  
  // æµ‹è¯•åº¦é‡ç³»ç»Ÿæ•…éšœæ¢å¤
  let failing_metric_exporter = azimuth::FailingMetricExporter::new(2)  // å‰2æ¬¡å¤±è´¥
  let resilient_metric_reader = azimuth::PeriodicMetricReader::new(
    failing_metric_exporter,
    azimuth::PeriodicMetricReaderConfig::default()
  )
  
  let meter_provider = azimuth::MeterProvider::with_metric_reader(resilient_metric_reader)
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "resilient-meter")
  
  // åˆ›å»ºåº¦é‡ä»ªå™¨å¹¶è®°å½•æ•°æ®
  let recovery_counter = azimuth::Meter::create_counter(meter, "recovery.operations")
  let recovery_histogram = azimuth::Meter::create_histogram(meter, "recovery.latency")
  
  // è®°å½•åº¦é‡æ•°æ®ä»¥è§¦å‘æ•…éšœæ¢å¤
  for i in 0..15 {
    azimuth::Counter::add(recovery_counter, 1.0)
    azimuth::Histogram::record(recovery_histogram, i.to_double() * 0.5)
  }
  
  // éªŒè¯æ•…éšœæ¢å¤åº¦é‡
  assert_eq(recovery_counter.name, "recovery.operations")
  assert_eq(recovery_histogram.name, "recovery.latency")
  
  // æµ‹è¯•æ—¥å¿—ç³»ç»Ÿæ•…éšœæ¢å¤
  let failing_log_exporter = azimuth::FailingLogExporter::new(1)  // ç¬¬1æ¬¡å¤±è´¥
  let resilient_logger_provider = azimuth::LoggerProvider::with_log_exporter(failing_log_exporter)
  let logger = azimuth::LoggerProvider::get_logger(resilient_logger_provider, "resilient-logger")
  
  // åˆ›å»ºæ—¥å¿—è®°å½•ä»¥è§¦å‘æ•…éšœæ¢å¤
  for i in 0..5 {
    let log_record = azimuth::LogRecord::new_with_context(
      azimuth::Info,
      Some("Recovery log message " + i.to_string()),
      Some([("recovery.test", azimuth::StringValue("true"))]),
      Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
      None,
      Some("recovery-trace"),
      Some("recovery-span"),
      Some(azimuth::Context::root())
    )
    
    azimuth::Logger::emit(logger, log_record)
  }
  
  // éªŒè¯æ—¥å¿—æ•…éšœæ¢å¤
  assert_eq(logger.scope.name, "resilient-logger")
}

// æµ‹è¯•5: é¥æµ‹æ•°æ®è´¨é‡ä¿è¯æµ‹è¯•
test "é¥æµ‹æ•°æ®è´¨é‡ä¿è¯æµ‹è¯•" {
  // åˆ›å»ºæ•°æ®è´¨é‡éªŒè¯å™¨
  let quality_validator = azimuth::TelemetryQualityValidator::new()
  
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "quality-test-tracer")
  
  // åˆ›å»ºé«˜è´¨é‡Span
  let quality_spans = []
  for i in 0..10 {
    let span = azimuth::Tracer::start_span(tracer, "quality-span-" + i.to_string())
    
    // æ·»åŠ ä¸°å¯Œçš„å±æ€§
    azimuth::Span::set_attribute(span, "quality.index", azimuth::IntValue(i))
    azimuth::Span::set_attribute(span, "quality.service", azimuth::StringValue("quality-test"))
    azimuth::Span::set_attribute(span, "quality.version", azimuth::StringValue("1.0.0"))
    azimuth::Span::set_attribute(span, "quality.environment", azimuth::StringValue("test"))
    
    // æ·»åŠ æœ‰æ„ä¹‰çš„äº‹ä»¶
    azimuth::Span::add_event(span, "quality.check", Some([
      ("check.type", azimuth::StringValue("validation")),
      ("check.status", azimuth::StringValue("passed")),
      ("check.timestamp", azimuth::IntValue(azimuth::Clock::now_unix_nanos(azimuth::Clock::system()).to_int()))
    ]))
    
    // è®¾ç½®é€‚å½“çš„Spanç±»å‹
    if i % 3 == 0 {
      azimuth::Span::set_kind(span, azimuth::Server)
    } else if i % 3 == 1 {
      azimuth::Span::set_kind(span, azimuth::Client)
    } else {
      azimuth::Span::set_kind(span, azimuth::Internal)
    }
    
    quality_spans.push(span)
  }
  
  // ç»“æŸæ‰€æœ‰Span
  for span in quality_spans {
    azimuth::Span::end(span)
  }
  
  // éªŒè¯æ•°æ®è´¨é‡
  for span in quality_spans {
    // éªŒè¯Spanåç§°è´¨é‡
    let span_name = azimuth::Span::name(span)
    assert_true(span_name.length() > 0)
    assert_true(span_name.starts_with("quality-span-"))
    
    // éªŒè¯Spanä¸Šä¸‹æ–‡è´¨é‡
    let span_ctx = azimuth::Span::span_context(span)
    assert_true(azimuth::SpanContext::is_valid(span_ctx))
  }
  
  // æµ‹è¯•åº¦é‡æ•°æ®è´¨é‡
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "quality-meter")
  
  // åˆ›å»ºé«˜è´¨é‡çš„åº¦é‡ä»ªå™¨
  let quality_counter = azimuth::Meter::create_counter(
    meter, 
    "quality.operations",
    Some("Number of quality operations performed"),
    Some("operations")
  )
  
  let quality_histogram = azimuth::Meter::create_histogram(
    meter,
    "quality.duration",
    Some("Duration of quality operations"),
    Some("milliseconds")
  )
  
  // è®°å½•é«˜è´¨é‡çš„åº¦é‡æ•°æ®
  for i in 0..20 {
    azimuth::Counter::add(quality_counter, 1.0)
    azimuth::Histogram::record(quality_histogram, 100.0 + (i.to_double() * 5.0))
  }
  
  // éªŒè¯åº¦é‡æ•°æ®è´¨é‡
  assert_eq(quality_counter.name, "quality.operations")
  assert_eq(quality_counter.description, Some("Number of quality operations performed"))
  assert_eq(quality_counter.unit, Some("operations"))
  
  assert_eq(quality_histogram.name, "quality.duration")
  assert_eq(quality_histogram.description, Some("Duration of quality operations"))
  assert_eq(quality_histogram.unit, Some("milliseconds"))
  
  // æµ‹è¯•æ—¥å¿—æ•°æ®è´¨é‡
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "quality-logger")
  
  // åˆ›å»ºé«˜è´¨é‡çš„æ—¥å¿—è®°å½•
  for i in 0..15 {
    let severity = if i % 4 == 0 {
      azimuth::Error
    } else if i % 4 == 1 {
      azimuth::Warn
    } else if i % 4 == 2 {
      azimuth::Info
    } else {
      azimuth::Debug
    }
    
    let log_record = azimuth::LogRecord::new_with_context(
      severity,
      Some("Quality log message " + i.to_string() + " with detailed context"),
      Some([
        ("log.quality", azimuth::StringValue("high")),
        ("log.category", azimuth::StringValue("test")),
        ("log.component", azimuth::StringValue("quality-validator"))
      ]),
      Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
      None,
      Some("quality-trace-" + (i % 3).to_string()),
      Some("quality-span-" + i.to_string()),
      Some(azimuth::Context::root())
    )
    
    azimuth::Logger::emit(logger, log_record)
  }
  
  // éªŒè¯æ—¥å¿—æ•°æ®è´¨é‡
  assert_eq(logger.scope.name, "quality-logger")
}

// æµ‹è¯•6: å¹³å°ç‰¹å®šé¥æµ‹é€‚é…æµ‹è¯•
test "å¹³å°ç‰¹å®šé¥æµ‹é€‚é…æµ‹è¯•" {
  // åˆ›å»ºå¹³å°ç‰¹å®šçš„èµ„æºé…ç½®
  let platform_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("platform-test-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.instance.id", azimuth::StringValue("platform-test-instance")),
    ("telemetry.sdk.name", azimuth::StringValue("azimuth")),
    ("telemetry.sdk.language", azimuth::StringValue("moonbit")),
    ("telemetry.sdk.version", azimuth::StringValue("0.1.0")),
    ("host.name", azimuth::StringValue("platform-test-host")),
    ("host.arch", azimuth::StringValue("x86_64")),
    ("os.type", azimuth::StringValue("linux")),
    ("os.version", azimuth::StringValue("5.15.0")),
    ("process.pid", azimuth::IntValue(12345)),
    ("process.executable.name", azimuth::StringValue("platform-test")),
    ("process.executable.path", azimuth::StringValue("/usr/bin/platform-test"))
  ])
  
  // éªŒè¯å¹³å°ç‰¹å®šèµ„æº
  assert_eq(azimuth::Resource::get_attribute(platform_resource, "service.name"), Some(azimuth::StringValue("platform-test-service")))
  assert_eq(azimuth::Resource::get_attribute(platform_resource, "telemetry.sdk.language"), Some(azimuth::StringValue("moonbit")))
  assert_eq(azimuth::Resource::get_attribute(platform_resource, "host.arch"), Some(azimuth::StringValue("x86_64")))
  assert_eq(azimuth::Resource::get_attribute(platform_resource, "os.type"), Some(azimuth::StringValue("linux")))
  assert_eq(azimuth::Resource::get_attribute(platform_resource, "process.pid"), Some(azimuth::IntValue(12345)))
  
  // åˆ›å»ºå¹³å°ç‰¹å®šçš„TracerProvider
  let platform_tracer_provider = azimuth::TracerProvider::with_resource(platform_resource)
  let platform_tracer = azimuth::TracerProvider::get_tracer(platform_tracer_provider, "platform-tracer")
  
  // åˆ›å»ºå¹³å°ç‰¹å®šçš„Span
  let platform_span = azimuth::Tracer::start_span(platform_tracer, "platform-operation")
  azimuth::Span::set_attribute(platform_span, "platform.type", azimuth::StringValue("linux"))
  azimuth::Span::set_attribute(platform_span, "platform.arch", azimuth::StringValue("x86_64"))
  azimuth::Span::set_attribute(platform_span, "platform.runtime", azimuth::StringValue("moonbit"))
  
  // æ·»åŠ å¹³å°ç‰¹å®šäº‹ä»¶
  azimuth::Span::add_event(platform_span, "platform.init", Some([
    ("platform.os", azimuth::StringValue("linux")),
    ("platform.kernel", azimuth::StringValue("5.15.0")),
    ("platform.cpu.count", azimuth::IntValue(4))
  ]))
  
  azimuth::Span::end(platform_span)
  
  // éªŒè¯å¹³å°ç‰¹å®šSpan
  assert_eq(azimuth::Span::name(platform_span), "platform-operation")
  
  // åˆ›å»ºå¹³å°ç‰¹å®šçš„åº¦é‡
  let platform_meter_provider = azimuth::MeterProvider::with_resource(platform_resource)
  let platform_meter = azimuth::MeterProvider::get_meter(platform_meter_provider, "platform-meter")
  
  // åˆ›å»ºå¹³å°ç‰¹å®šçš„åº¦é‡ä»ªå™¨
  let platform_cpu_counter = azimuth::Meter::create_counter(
    platform_meter,
    "platform.cpu.time",
    Some("Platform CPU time usage"),
    Some("nanoseconds")
  )
  
  let platform_memory_gauge = azimuth::Meter::create_gauge(
    platform_meter,
    "platform.memory.usage",
    Some("Platform memory usage"),
    Some("bytes")
  )
  
  let platform_disk_histogram = azimuth::Meter::create_histogram(
    platform_meter,
    "platform.disk.io",
    Some("Platform disk I/O operations"),
    Some("bytes")
  )
  
  // è®°å½•å¹³å°ç‰¹å®šçš„åº¦é‡æ•°æ®
  azimuth::Counter::add(platform_cpu_counter, 1000000.0)  // 1æ¯«ç§’CPUæ—¶é—´
  // Gauge::set(platform_memory_gauge, 1024 * 1024 * 100.0)  // 100MBå†…å­˜ä½¿ç”¨
  azimuth::Histogram::record(platform_disk_histogram, 4096.0)  // 4KBç£ç›˜I/O
  
  // éªŒè¯å¹³å°ç‰¹å®šåº¦é‡
  assert_eq(platform_cpu_counter.name, "platform.cpu.time")
  assert_eq(platform_cpu_counter.description, Some("Platform CPU time usage"))
  assert_eq(platform_cpu_counter.unit, Some("nanoseconds"))
  
  assert_eq(platform_memory_gauge.name, "platform.memory.usage")
  assert_eq(platform_memory_gauge.description, Some("Platform memory usage"))
  assert_eq(platform_memory_gauge.unit, Some("bytes"))
  
  assert_eq(platform_disk_histogram.name, "platform.disk.io")
  assert_eq(platform_disk_histogram.description, Some("Platform disk I/O operations"))
  assert_eq(platform_disk_histogram.unit, Some("bytes"))
  
  // åˆ›å»ºå¹³å°ç‰¹å®šçš„æ—¥å¿—
  let platform_logger_provider = azimuth::LoggerProvider::with_resource(platform_resource)
  let platform_logger = azimuth::LoggerProvider::get_logger(platform_logger_provider, "platform-logger")
  
  // åˆ›å»ºå¹³å°ç‰¹å®šçš„æ—¥å¿—è®°å½•
  let platform_log_record = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Platform-specific log message"),
    Some([
      ("platform.service", azimuth::StringValue("platform-test-service")),
      ("platform.version", azimuth::StringValue("1.0.0")),
      ("platform.environment", azimuth::StringValue("linux")),
      ("log.source", azimuth::StringValue("platform-test"))
    ]),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some(azimuth::SpanContext::trace_id(azimuth::Span::span_context(platform_span))),
    Some(azimuth::SpanContext::span_id(azimuth::Span::span_context(platform_span))),
    Some(azimuth::Context::root())
  )
  
  azimuth::Logger::emit(platform_logger, platform_log_record)
  
  // éªŒè¯å¹³å°ç‰¹å®šæ—¥å¿—
  assert_eq(platform_logger.scope.name, "platform-logger")
}

// æµ‹è¯•7: é¥æµ‹ç³»ç»Ÿç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
test "é¥æµ‹ç³»ç»Ÿç«¯åˆ°ç«¯é›†æˆæµ‹è¯•" {
  // åˆ›å»ºç«¯åˆ°ç«¯æµ‹è¯•èµ„æº
  let e2e_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("e2e-test-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("test.type", azimuth::StringValue("end-to-end")),
    ("test.scenario", azimuth::StringValue("full-telemetry-workflow"))
  ])
  
  // åˆ›å»ºç«¯åˆ°ç«¯æµ‹è¯•çš„TracerProvider
  let e2e_tracer_provider = azimuth::TracerProvider::with_resource(e2e_resource)
  let e2e_tracer = azimuth::TracerProvider::get_tracer(e2e_tracer_provider, "e2e-tracer")
  
  // åˆ›å»ºç«¯åˆ°ç«¯æµ‹è¯•çš„MeterProvider
  let e2e_meter_provider = azimuth::MeterProvider::with_resource(e2e_resource)
  let e2e_meter = azimuth::MeterProvider::get_meter(e2e_meter_provider, "e2e-meter")
  
  // åˆ›å»ºç«¯åˆ°ç«¯æµ‹è¯•çš„LoggerProvider
  let e2e_logger_provider = azimuth::LoggerProvider::with_resource(e2e_resource)
  let e2e_logger = azimuth::LoggerProvider::get_logger(e2e_logger_provider, "e2e-logger")
  
  // æ­¥éª¤1: åˆ›å»ºæ ¹Spanè¡¨ç¤ºæ•´ä¸ªç«¯åˆ°ç«¯æµç¨‹
  let root_span = azimuth::Tracer::start_span(e2e_tracer, "e2e-workflow")
  azimuth::Span::set_attribute(root_span, "workflow.type", azimuth::StringValue("integration-test"))
  azimuth::Span::set_attribute(root_span, "workflow.steps", azimuth::IntValue(5))
  
  let root_span_ctx = azimuth::Span::span_context(root_span)
  
  // æ­¥éª¤2: åˆ›å»ºå­Spanè¡¨ç¤ºå„ä¸ªæ­¥éª¤
  let step1_span = azimuth::Tracer::start_span_with_context(e2e_tracer, "step-1-initialization", root_span_ctx)
  azimuth::Span::set_attribute(step1_span, "step.name", azimuth::StringValue("initialization"))
  azimuth::Span::set_attribute(step1_span, "step.status", azimuth::StringValue("completed"))
  azimuth::Span::add_event(step1_span, "step.completed", Some([
    ("step.duration", azimuth::IntValue(100)),
    ("step.result", azimuth::StringValue("success"))
  ]))
  azimuth::Span::end(step1_span)
  
  // æ­¥éª¤3: è®°å½•åˆå§‹åŒ–åº¦é‡
  let init_counter = azimuth::Meter::create_counter(e2e_meter, "e2e.initializations")
  azimuth::Counter::add(init_counter, 1.0)
  
  let init_histogram = azimuth::Meter::create_histogram(e2e_meter, "e2e.init.duration")
  azimuth::Histogram::record(init_histogram, 100.0)
  
  // æ­¥éª¤4: è®°å½•åˆå§‹åŒ–æ—¥å¿—
  let init_log_record = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("E2E initialization completed successfully"),
    Some([
      ("log.step", azimuth::StringValue("initialization")),
      ("log.status", azimuth::StringValue("completed"))
    ]),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some(azimuth::SpanContext::trace_id(root_span_ctx)),
    Some(azimuth::SpanContext::span_id(azimuth::Span::span_context(step1_span))),
    Some(azimuth::Context::root())
  )
  azimuth::Logger::emit(e2e_logger, init_log_record)
  
  // æ­¥éª¤5: åˆ›å»ºå¤„ç†æ­¥éª¤Span
  let step2_span = azimuth::Tracer::start_span_with_context(e2e_tracer, "step-2-processing", root_span_ctx)
  azimuth::Span::set_attribute(step2_span, "step.name", azimuth::StringValue("processing"))
  azimuth::Span::set_attribute(step2_span, "step.items", azimuth::IntValue(10))
  
  // å¤„ç†å¤šä¸ªé¡¹ç›®çš„å­æ“ä½œ
  for i in 0..10 {
    let item_span = azimuth::Tracer::start_span_with_context(e2e_tracer, "process-item-" + i.to_string(), azimuth::Span::span_context(step2_span))
    azimuth::Span::set_attribute(item_span, "item.id", azimuth::IntValue(i))
    azimuth::Span::set_attribute(item_span, "item.status", azimuth::StringValue("processed"))
    azimuth::Span::end(item_span)
  }
  
  azimuth::Span::end(step2_span)
  
  // æ­¥éª¤6: è®°å½•å¤„ç†åº¦é‡
  let process_counter = azimuth::Meter::create_counter(e2e_meter, "e2e.items.processed")
  for i in 0..10 {
    azimuth::Counter::add(process_counter, 1.0)
  }
  
  let process_histogram = azimuth::Meter::create_histogram(e2e_meter, "e2e.process.duration")
  azimuth::Histogram::record(process_histogram, 250.0)
  
  // æ­¥éª¤7: è®°å½•å¤„ç†æ—¥å¿—
  let process_log_record = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("E2E processing completed 10 items"),
    Some([
      ("log.step", azimuth::StringValue("processing")),
      ("items.count", azimuth::IntValue(10)),
      ("items.status", azimuth::StringValue("processed"))
    ]),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some(azimuth::SpanContext::trace_id(root_span_ctx)),
    Some(azimuth::SpanContext::span_id(azimuth::Span::span_context(step2_span))),
    Some(azimuth::Context::root())
  )
  azimuth::Logger::emit(e2e_logger, process_log_record)
  
  // æ­¥éª¤8: åˆ›å»ºéªŒè¯æ­¥éª¤Span
  let step3_span = azimuth::Tracer::start_span_with_context(e2e_tracer, "step-3-validation", root_span_ctx)
  azimuth::Span::set_attribute(step3_span, "step.name", azimuth::StringValue("validation"))
  azimuth::Span::set_attribute(step3_span, "step.validations", azimuth::IntValue(3))
  
  // æ‰§è¡Œå¤šä¸ªéªŒè¯å­æ“ä½œ
  let validations = ["data.integrity", "performance.baseline", "security.checks"]
  for validation in validations {
    let validation_span = azimuth::Tracer::start_span_with_context(e2e_tracer, "validate-" + validation, azimuth::Span::span_context(step3_span))
    azimuth::Span::set_attribute(validation_span, "validation.type", azimuth::StringValue(validation))
    azimuth::Span::set_attribute(validation_span, "validation.result", azimuth::StringValue("passed"))
    azimuth::Span::end(validation_span)
  }
  
  azimuth::Span::end(step3_span)
  
  // æ­¥éª¤9: è®°å½•éªŒè¯åº¦é‡
  let validation_counter = azimuth::Meter::create_counter(e2e_meter, "e2e.validations")
  for i in 0..3 {
    azimuth::Counter::add(validation_counter, 1.0)
  }
  
  let validation_histogram = azimuth::Meter::create_histogram(e2e_meter, "e2e.validation.duration")
  azimuth::Histogram::record(validation_histogram, 150.0)
  
  // æ­¥éª¤10: è®°å½•éªŒè¯æ—¥å¿—
  let validation_log_record = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("E2E validation completed successfully"),
    Some([
      ("log.step", azimuth::StringValue("validation")),
      ("validations.count", azimuth::IntValue(3)),
      ("validations.status", azimuth::StringValue("passed"))
    ]),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some(azimuth::SpanContext::trace_id(root_span_ctx)),
    Some(azimuth::SpanContext::span_id(azimuth::Span::span_context(step3_span))),
    Some(azimuth::Context::root())
  )
  azimuth::Logger::emit(e2e_logger, validation_log_record)
  
  // æ­¥éª¤11: å®Œæˆæ ¹Span
  azimuth::Span::set_attribute(root_span, "workflow.status", azimuth::StringValue("completed"))
  azimuth::Span::add_event(root_span, "workflow.completed", Some([
    ("total.duration", azimuth::IntValue(500)),
    ("total.steps", azimuth::IntValue(3)),
    ("workflow.result", azimuth::StringValue("success"))
  ]))
  azimuth::Span::end(root_span)
  
  // æ­¥éª¤12: è®°å½•å·¥ä½œæµå®Œæˆåº¦é‡
  let workflow_counter = azimuth::Meter::create_counter(e2e_meter, "e2e.workflows.completed")
  azimuth::Counter::add(workflow_counter, 1.0)
  
  let workflow_histogram = azimuth::Meter::create_histogram(e2e_meter, "e2e.workflow.duration")
  azimuth::Histogram::record(workflow_histogram, 500.0)
  
  // æ­¥éª¤13: è®°å½•å·¥ä½œæµå®Œæˆæ—¥å¿—
  let workflow_log_record = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("E2E workflow completed successfully"),
    Some([
      ("log.type", azimuth::StringValue("workflow")),
      ("workflow.status", azimuth::StringValue("completed")),
      ("workflow.result", azimuth::StringValue("success"))
    ]),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some(azimuth::SpanContext::trace_id(root_span_ctx)),
    Some(azimuth::SpanContext::span_id(root_span_ctx)),
    Some(azimuth::Context::root())
  )
  azimuth::Logger::emit(e2e_logger, workflow_log_record)
  
  // éªŒè¯ç«¯åˆ°ç«¯é›†æˆ
  assert_eq(azimuth::Span::name(root_span), "e2e-workflow")
  assert_eq(azimuth::Span::name(step1_span), "step-1-initialization")
  assert_eq(azimuth::Span::name(step2_span), "step-2-processing")
  assert_eq(azimuth::Span::name(step3_span), "step-3-validation")
  
  assert_eq(init_counter.name, "e2e.initializations")
  assert_eq(process_counter.name, "e2e.items.processed")
  assert_eq(validation_counter.name, "e2e.validations")
  assert_eq(workflow_counter.name, "e2e.workflows.completed")
  
  assert_eq(e2e_logger.scope.name, "e2e-logger")
}

// æµ‹è¯•8: é¥æµ‹æ•°æ®åºåˆ—åŒ–å®Œæ•´æ€§æµ‹è¯•
test "é¥æµ‹æ•°æ®åºåˆ—åŒ–å®Œæ•´æ€§æµ‹è¯•" {
  // åˆ›å»ºåºåˆ—åŒ–æµ‹è¯•çš„å¤æ‚å±æ€§é›†åˆ
  let complex_attrs = azimuth::Attributes::new()
  
  // æ·»åŠ å„ç§ç±»å‹çš„å±æ€§
  azimuth::Attributes::set(complex_attrs, "string.value", azimuth::StringValue("complex test string"))
  azimuth::Attributes::set(complex_attrs, "int.value", azimuth::IntValue(42))
  azimuth::Attributes::set(complex_attrs, "float.value", azimuth::FloatValue(3.14159265359))
  azimuth::Attributes::set(complex_attrs, "bool.value", azimuth::BoolValue(true))
  azimuth::Attributes::set(complex_attrs, "array.string", azimuth::ArrayStringValue(["item1", "item2", "item3"]))
  azimuth::Attributes::set(complex_attrs, "array.int", azimuth::ArrayIntValue([1, 2, 3, 4, 5]))
  
  // æ·»åŠ ç‰¹æ®Šå­—ç¬¦å’ŒUnicode
  azimuth::Attributes::set(complex_attrs, "unicode.value", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€emoji"))
  azimuth::Attributes::set(complex_attrs, "special.chars", azimuth::StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
  azimuth::Attributes::set(complex_attrs, "json.like", azimuth::StringValue("{\"key\": \"value\", \"number\": 123}"))
  
  // æ·»åŠ æå€¼
  azimuth::Attributes::set(complex_attrs, "max.int", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(complex_attrs, "min.int", azimuth::IntValue(-2147483648))
  azimuth::Attributes::set(complex_attrs, "max.float", azimuth::FloatValue(1.7976931348623157e+308))
  azimuth::Attributes::set(complex_attrs, "min.float", azimuth::FloatValue(-1.7976931348623157e+308))
  
  // åˆ›å»ºå¸¦æœ‰å¤æ‚å±æ€§çš„Span
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "serialization-test")
  
  let serialization_span = azimuth::Tracer::start_span(tracer, "serialization-test-span")
  azimuth::Span::set_attributes(serialization_span, complex_attrs)
  
  // æ·»åŠ å¤æ‚äº‹ä»¶
  let event_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(event_attrs, "event.type", azimuth::StringValue("serialization.test"))
  azimuth::Attributes::set(event_attrs, "event.timestamp", azimuth::IntValue(azimuth::Clock::now_unix_nanos(azimuth::Clock::system()).to_int()))
  azimuth::Attributes::set(event_attrs, "event.data", azimuth::StringValue("complex event data"))
  
  azimuth::Span::add_event(serialization_span, "serialization.event", Some(event_attrs))
  
  // è®¾ç½®å¤æ‚çŠ¶æ€
  azimuth::Span::set_status(serialization_span, azimuth::Ok)
  azimuth::Span::end(serialization_span)
  
  // éªŒè¯å¤æ‚Spançš„åºåˆ—åŒ–
  assert_eq(azimuth::Span::name(serialization_span), "serialization-test-span")
  
  // åˆ›å»ºåºåˆ—åŒ–æµ‹è¯•çš„å¤æ‚åº¦é‡
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "serialization-meter")
  
  // åˆ›å»ºå¸¦æœ‰å¤æ‚æè¿°å’Œå•ä½çš„åº¦é‡ä»ªå™¨
  let complex_counter = azimuth::Meter::create_counter(
    meter,
    "complex.operations.count",
    Some("Number of complex operations with special characters: !@#$%^&*()"),
    Some("operations/ç§’")
  )
  
  let complex_histogram = azimuth::Meter::create_histogram(
    meter,
    "complex.duration.histogram",
    Some("Complex duration measurement with Unicode: æµ‹è¯•ğŸš€"),
    Some("æ¯«ç§’")
  )
  
  let complex_gauge = azimuth::Meter::create_gauge(
    meter,
    "complex.memory.usage",
    Some("Complex memory usage with JSON-like data: {\"used\": 1024, \"total\": 4096}"),
    Some("MB")
  )
  
  // è®°å½•å¤æ‚çš„åº¦é‡å€¼
  azimuth::Counter::add(complex_counter, 1.0)
  azimuth::Histogram::record(complex_histogram, 123.456)
  // Gauge::set(complex_gauge, 1024.789)
  
  // éªŒè¯å¤æ‚åº¦é‡çš„åºåˆ—åŒ–
  assert_eq(complex_counter.name, "complex.operations.count")
  assert_eq(complex_counter.description, Some("Number of complex operations with special characters: !@#$%^&*()"))
  assert_eq(complex_counter.unit, Some("operations/ç§’"))
  
  assert_eq(complex_histogram.name, "complex.duration.histogram")
  assert_eq(complex_histogram.description, Some("Complex duration measurement with Unicode: æµ‹è¯•ğŸš€"))
  assert_eq(complex_histogram.unit, Some("æ¯«ç§’"))
  
  assert_eq(complex_gauge.name, "complex.memory.usage")
  assert_eq(complex_gauge.description, Some("Complex memory usage with JSON-like data: {\"used\": 1024, \"total\": 4096}"))
  assert_eq(complex_gauge.unit, Some("MB"))
  
  // åˆ›å»ºåºåˆ—åŒ–æµ‹è¯•çš„å¤æ‚æ—¥å¿—è®°å½•
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "serialization-logger")
  
  // åˆ›å»ºå¤æ‚çš„æ—¥å¿—è®°å½•
  let complex_log_record = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Complex log message with Unicode: æµ‹è¯•æ¶ˆæ¯ğŸš€ and special chars: !@#$%"),
    Some(complex_attrs),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system()) + 1000L),
    Some("serialization-trace-id-12345"),
    Some("serialization-span-id-67890"),
    Some(azimuth::Context::root())
  )
  
  azimuth::Logger::emit(logger, complex_log_record)
  
  // éªŒè¯å¤æ‚æ—¥å¿—çš„åºåˆ—åŒ–
  assert_eq(logger.scope.name, "serialization-logger")
  
  // åˆ›å»ºåºåˆ—åŒ–æµ‹è¯•çš„å¤æ‚èµ„æº
  let complex_resource_attrs = [
    ("service.name", azimuth::StringValue("serialization-test-service")),
    ("service.version", azimuth::StringValue("1.0.0-test")),
    ("service.description", azimuth::StringValue("Service with Unicode: æµ‹è¯•æœåŠ¡ğŸš€")),
    ("host.name", azimuth::StringValue("test-host-123")),
    ("host.ip", azimuth::StringValue("192.168.1.100")),
    ("os.name", azimuth::StringValue("Linux")),
    ("os.version", azimuth::StringValue("5.15.0-test")),
    ("process.name", azimuth::StringValue("serialization-test")),
    ("process.args", azimuth::ArrayStringValue(["--test", "--verbose", "--output=json"])),
    ("process.env", azimuth::StringValue("{\"ENV\": \"test\", \"DEBUG\": \"true\"}"))
  ]
  
  let complex_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), complex_resource_attrs)
  
  // éªŒè¯å¤æ‚èµ„æºçš„åºåˆ—åŒ–
  assert_eq(azimuth::Resource::get_attribute(complex_resource, "service.name"), Some(azimuth::StringValue("serialization-test-service")))
  assert_eq(azimuth::Resource::get_attribute(complex_resource, "service.description"), Some(azimuth::StringValue("Service with Unicode: æµ‹è¯•æœåŠ¡ğŸš€")))
  assert_eq(azimuth::Resource::get_attribute(complex_resource, "process.args"), Some(azimuth::ArrayStringValue(["--test", "--verbose", "--output=json"])))
  
  // åˆ›å»ºåºåˆ—åŒ–æµ‹è¯•çš„å¤æ‚ä¸Šä¸‹æ–‡
  let complex_ctx = azimuth::Context::root()
  let key1 = azimuth::ContextKey::new("complex.key1")
  let key2 = azimuth::ContextKey::new("complex.key2")
  let key3 = azimuth::ContextKey::new("complex.key3")
  
  let ctx_with_value1 = azimuth::Context::with_value(complex_ctx, key1, "complex value1 with Unicode: æµ‹è¯•")
  let ctx_with_value2 = azimuth::Context::with_value(ctx_with_value1, key2, "complex value2 with special chars: !@#$%")
  let ctx_with_value3 = azimuth::Context::with_value(ctx_with_value2, key3, "complex value3 with JSON: {\"test\": true}")
  
  // éªŒè¯å¤æ‚ä¸Šä¸‹æ–‡çš„åºåˆ—åŒ–
  assert_eq(azimuth::Context::get(ctx_with_value3, key1), Some("complex value1 with Unicode: æµ‹è¯•"))
  assert_eq(azimuth::Context::get(ctx_with_value3, key2), Some("complex value2 with special chars: !@#$%"))
  assert_eq(azimuth::Context::get(ctx_with_value3, key3), Some("complex value3 with JSON: {\"test\": true}"))
}
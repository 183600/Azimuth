// Azimuth Enhanced Quality Tests - å¢å¼ºè´¨é‡æµ‹è¯•é›†
// åŒ…å«é”™è¯¯å¤„ç†ã€æ€§èƒ½ã€ä¸€è‡´æ€§ã€åºåˆ—åŒ–ã€æ—¶é—´åºåˆ—å’Œé…ç½®ç®¡ç†çš„é«˜è´¨é‡æµ‹è¯•ç”¨ä¾‹

test "é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  // æµ‹è¯•ç©ºå€¼å’Œnullå¤„ç†
  let empty_attrs = Attributes::new()
  match Attributes::get(empty_attrs, "") {
    None => assert_true(true)
    Some(_) => assert_true(false)
  }
  match Attributes::get(empty_attrs, "nonexistent") {
    None => assert_true(true)
    Some(_) => assert_true(false)
  }
  
  // æµ‹è¯•æå€¼å±æ€§
  let extreme_attrs = Attributes::new()
  Attributes::set(extreme_attrs, "max.int", IntValue(2147483647))
  Attributes::set(extreme_attrs, "min.int", IntValue(-2147483648))
  Attributes::set(extreme_attrs, "max.float", FloatValue(1.7976931348623157e+308))
  Attributes::set(extreme_attrs, "min.float", FloatValue(-1.7976931348623157e+308))
  Attributes::set(extreme_attrs, "zero.float", FloatValue(0.0))
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²å’Œç‰¹æ®Šå­—ç¬¦
  let special_attrs = Attributes::new()
  Attributes::set(special_attrs, "empty.string", StringValue(""))
  Attributes::set(special_attrs, "unicode.string", StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€emoji"))
  Attributes::set(special_attrs, "special.chars", StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
  
  // æµ‹è¯•è¾¹ç•ŒSpanä¸Šä¸‹æ–‡
  let empty_trace_ctx = SpanContext::new("", "span123", true, "")
  assert_false(SpanContext::is_valid(empty_trace_ctx))
  
  let empty_span_ctx = SpanContext::new("trace123", "", true, "")
  assert_false(SpanContext::is_valid(empty_span_ctx))
  
  let both_empty_ctx = SpanContext::new("", "", false, "")
  assert_false(SpanContext::is_valid(both_empty_ctx))
  assert_false(SpanContext::is_sampled(both_empty_ctx))
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡é”®çš„è¾¹ç•Œæƒ…å†µ
  let empty_key = ContextKey::new("")
  let very_long_key = ContextKey::new("this.is.a.very.long.key.name.that.exceeds.normal.expectations.and.tests.boundary.conditions")
  
  let root_ctx = Context::root()
  let ctx_with_empty_key = Context::with_value(root_ctx, empty_key, "empty.value")
  let ctx_with_long_key = Context::with_value(root_ctx, very_long_key, "long.value")
  
  assert_eq(Context::get(ctx_with_empty_key, empty_key), Some("empty.value"))
  assert_eq(Context::get(ctx_with_long_key, very_long_key), Some("long.value"))
}

test "æ€§èƒ½åŸºå‡†æµ‹è¯•" {
  // æµ‹è¯•å¤§é‡Spanåˆ›å»ºå’Œæ“ä½œçš„æ€§èƒ½
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "performance-test")
  
  let start_time = Clock::now_unix_nanos(Clock::system())
  
  // åˆ›å»ºå¤§é‡Span
  let spans = []
  for i in 0..=99 {
    let span = Tracer::start_span(tracer, "perf-span-" + i.to_string())
    spans.push(span)
  }
  
  // æ‰¹é‡æ“ä½œSpan
  for span in spans {
    Span::add_event(span, "performance.event", { attributes: [("iteration", StringValue("test"))] })
    Span::set_status(span, Ok)
  }
  
  // æ‰¹é‡ç»“æŸSpan
  for span in spans {
    Span::end(span)
  }
  
  let end_time = Clock::now_unix_nanos(Clock::system())
  let duration = end_time - start_time
  
  // éªŒè¯æ€§èƒ½åœ¨åˆç†èŒƒå›´å†…
  assert_true(duration < 10000000000L)  // å°äº10ç§’
  assert_true(spans.length() == 100)
  
  // æµ‹è¯•åº¦é‡æ“ä½œæ€§èƒ½
  let meter_start = Clock::now_unix_nanos(Clock::system())
  
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "perf-meter")
  let counter = Meter::create_counter(meter, "perf-counter")
  let histogram = Meter::create_histogram(meter, "perf-histogram")
  
  // å¤§é‡åº¦é‡æ“ä½œ
  for i in 0..=499 {
    Counter::add(counter, 1.0)
    Histogram::record(histogram, i.to_double())
  }
  
  let meter_end = Clock::now_unix_nanos(Clock::system())
  let meter_duration = meter_end - meter_start
  
  assert_true(meter_duration < 5000000000L)  // å°äº5ç§’
}

test "è·¨æœåŠ¡ä¸€è‡´æ€§æµ‹è¯•" {
  // æ¨¡æ‹Ÿè·¨æœåŠ¡çš„åˆ†å¸ƒå¼è¿½è¸ªåœºæ™¯
  let service_a_tracer = TracerProvider::get_tracer(TracerProvider::default(), "service-a")
  let service_b_tracer = TracerProvider::get_tracer(TracerProvider::default(), "service-b")
  let service_c_tracer = TracerProvider::get_tracer(TracerProvider::default(), "service-c")
  
  // æœåŠ¡Aåˆ›å»ºæ ¹Span
  let root_span_ctx = SpanContext::new("trace-12345", "span-a-root", true, "test-state")
  let root_span = Span::new("service-a-operation", Server, root_span_ctx)
  
  // æœåŠ¡Aè°ƒç”¨æœåŠ¡B
  let span_b_ctx = SpanContext::new("trace-12345", "span-b-child", true, "test-state")
  let span_b = Span::new("service-b-operation", Server, span_b_ctx)
  
  // æœåŠ¡Bè°ƒç”¨æœåŠ¡C
  let span_c_ctx = SpanContext::new("trace-12345", "span-c-grandchild", true, "test-state")
  let span_c = Span::new("service-c-operation", Internal, span_c_ctx)
  
  // éªŒè¯Trace IDä¸€è‡´æ€§
  assert_eq(SpanContext::trace_id(root_span_ctx), "trace-12345")
  assert_eq(SpanContext::trace_id(span_b_ctx), "trace-12345")
  assert_eq(SpanContext::trace_id(span_c_ctx), "trace-12345")
  
  // éªŒè¯Span IDå”¯ä¸€æ€§
  assert_true(SpanContext::span_id(root_span_ctx) != SpanContext::span_id(span_b_ctx))
  assert_true(SpanContext::span_id(span_b_ctx) != SpanContext::span_id(span_c_ctx))
  assert_true(SpanContext::span_id(root_span_ctx) != SpanContext::span_id(span_c_ctx))
  
  // æµ‹è¯•è·¨æœåŠ¡Baggageä¼ æ’­
  let baggage_a = Baggage::new()
  let baggage_b = Baggage::set_entry(baggage_a, "user.id", "12345")
  let baggage_c = Baggage::set_entry(baggage_b, "request.id", "req-67890")
  
  // éªŒè¯Baggageä¸€è‡´æ€§
  assert_eq(Baggage::get_entry(baggage_b, "user.id"), Some("12345"))
  assert_eq(Baggage::get_entry(baggage_c, "user.id"), Some("12345"))
  assert_eq(Baggage::get_entry(baggage_c, "request.id"), Some("req-67890"))
  
  // æµ‹è¯•è·¨æœåŠ¡åº¦é‡ä¸€è‡´æ€§
  let meter_a = MeterProvider::get_meter(MeterProvider::default(), "service-a")
  let meter_b = MeterProvider::get_meter(MeterProvider::default(), "service-b")
  let meter_c = MeterProvider::get_meter(MeterProvider::default(), "service-c")
  
  let counter_a = Meter::create_counter(meter_a, "cross.service.calls")
  let counter_b = Meter::create_counter(meter_b, "cross.service.calls")
  let counter_c = Meter::create_counter(meter_c, "cross.service.calls")
  
  // æ‰€æœ‰æœåŠ¡ä½¿ç”¨ç›¸åŒçš„åº¦é‡åç§°å’Œæè¿°
  assert_eq(counter_a.name, "cross.service.calls")
  assert_eq(counter_b.name, "cross.service.calls")
  assert_eq(counter_c.name, "cross.service.calls")
  
  // æµ‹è¯•è·¨æœåŠ¡ä¼ æ’­å™¨ä¸€è‡´æ€§
  let propagator_a = CompositePropagator::new([W3CTraceContextPropagator::new()])
  let propagator_b = CompositePropagator::new([W3CTraceContextPropagator::new()])
  let propagator_c = CompositePropagator::new([W3CTraceContextPropagator::new()])
  
  let carrier = TextMapCarrier::new()
  let ctx = Context::with_value(Context::root(), ContextKey::new("service"), "a")
  
  // æ³¨å…¥å’Œæå–åº”è¯¥ä¿æŒä¸€è‡´
  CompositePropagator::inject(propagator_a, ctx, carrier)
  let extracted_ctx_b = CompositePropagator::extract(propagator_b, carrier)
  let extracted_ctx_c = CompositePropagator::extract(propagator_c, carrier)
  
  // éªŒè¯æå–çš„ä¸Šä¸‹æ–‡åŒ…å«é¢„æœŸçš„ä¿¡æ¯
  assert_eq(Context::get(extracted_ctx_b, ContextKey::new("extracted")), Some("true"))
  assert_eq(Context::get(extracted_ctx_c, ContextKey::new("extracted")), Some("true"))
}

test "æ•°æ®åºåˆ—åŒ–å’Œå®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•å±æ€§å€¼çš„åºåˆ—åŒ–å…¼å®¹æ€§
  let test_attrs = Attributes::new()
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§
  Attributes::set(test_attrs, "string.val", StringValue("test string"))
  Attributes::set(test_attrs, "int.val", IntValue(42))
  Attributes::set(test_attrs, "float.val", FloatValue(3.14159))
  Attributes::set(test_attrs, "bool.val", BoolValue(true))
  Attributes::set(test_attrs, "array.string", ArrayStringValue(["a", "b", "c"]))
  Attributes::set(test_attrs, "array.int", ArrayIntValue([1, 2, 3]))
  
  // éªŒè¯å±æ€§å€¼çš„å®Œæ•´æ€§
  let string_val = Attributes::get(test_attrs, "string.val")
  let int_val = Attributes::get(test_attrs, "int.val")
  let float_val = Attributes::get(test_attrs, "float.val")
  let bool_val = Attributes::get(test_attrs, "bool.val")
  let array_string_val = Attributes::get(test_attrs, "array.string")
  let array_int_val = Attributes::get(test_attrs, "array.int")
  
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  match string_val {
    Some(StringValue("test_value")) => assert_true(true)
    _ => assert_true(false)
  }
  match int_val {
    Some(IntValue(42)) => assert_true(true)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•Spanä¸Šä¸‹æ–‡çš„åºåˆ—åŒ–æ ¼å¼
  let span_ctx = SpanContext::new("trace-123", "span-456", true, "key1=value1,key2=value2")
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡å­—æ®µ
  assert_eq(SpanContext::trace_id(span_ctx), "trace-123")
  assert_eq(SpanContext::span_id(span_ctx), "span-456")
  assert_true(SpanContext::is_sampled(span_ctx))
  
  // æµ‹è¯•Resourceçš„åºåˆ—åŒ–å…¼å®¹æ€§
  let resource_attrs = [
    ("service.name", StringValue("test-service")),
    ("service.version", StringValue("1.0.0")),
    ("service.instance.id", StringValue("instance-123")),
    ("deployment.environment", StringValue("test")),
    ("host.name", StringValue("test-host"))
  ]
  
  let resource = Resource::with_attributes(Resource::new(), resource_attrs)
  
  // éªŒè¯Resourceå±æ€§å®Œæ•´æ€§
  match Resource::get_attribute(resource, "service.name") {
    Some(StringValue("test-service")) => assert_true(true)
    _ => assert_true(false)
  }
  match Resource::get_attribute(resource, "service.version") {
    Some(StringValue("1.0.0")) => assert_true(true)
    _ => assert_true(false)
  }
  match Resource::get_attribute(resource, "service.instance.id") {
    Some(StringValue("instance-123")) => assert_true(true)
    _ => assert_true(false)
  }
  match Resource::get_attribute(resource, "deployment.environment") {
    Some(StringValue("test")) => assert_true(true)
    _ => assert_true(false)
  }
  match Resource::get_attribute(resource, "host.name") {
    Some(StringValue("test-host")) => assert_true(true)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•HTTPè¯·æ±‚/å“åº”çš„åºåˆ—åŒ–
  let request_headers = [
    ("Content-Type", "application/json"),
    ("Authorization", "Bearer token123"),
    ("X-Request-ID", "req-456"),
    ("User-Agent", "Azimuth-Test/1.0")
  ]
  
  let request = HttpRequest::new(
    "POST",
    "https://api.example.com/test",
    request_headers,
    { body: "{\"key\": \"value\", \"number\": 42}" }
  )
  
  // éªŒè¯HTTPè¯·æ±‚æ•°æ®å®Œæ•´æ€§
  assert_eq(HttpRequest::http_method(request), "POST")
  assert_eq(HttpRequest::url(request), "https://api.example.com/test")
  assert_eq(HttpRequest::body(request), Some("{\"key\": \"value\", \"number\": 42}"))
  
  let response_headers = [
    ("Content-Type", "application/json"),
    ("X-Response-ID", "resp-789"),
    ("Cache-Control", "no-cache")
  ]
  
  let response = HttpResponse::new(200, response_headers, { body: "{\"status\": \"success\", \"data\": {}}" })
  
  // éªŒè¯HTTPå“åº”æ•°æ®å®Œæ•´æ€§
  assert_eq(HttpResponse::status_code(response), 200)
  assert_eq(HttpResponse::body(response), Some("{\"status\": \"success\", \"data\": {}}"))
}

test "æ—¶é—´åºåˆ—å’Œæ—¶åºæ“ä½œæµ‹è¯•" {
  // æµ‹è¯•æ—¶é—´æˆ³ç”Ÿæˆå’Œç²¾åº¦
  let clock = Clock::system()
  let timestamp1 = Clock::now_unix_nanos(clock)
  
  // éªŒè¯æ—¶é—´æˆ³æ ¼å¼ï¼ˆçº³ç§’çº§ç²¾åº¦ï¼‰
  assert_true(timestamp1 > 0L)
  assert_true(timestamp1.to_string().length() >= 16)  // è‡³å°‘16ä½æ•°å­—
  
  // æµ‹è¯•æ—¶é—´æˆ³å•è°ƒé€’å¢
  let timestamp2 = Clock::now_unix_nanos(clock)
  let timestamp3 = Clock::now_unix_nanos(clock)
  
  assert_true(timestamp2 >= timestamp1)
  assert_true(timestamp3 >= timestamp2)
  
  // æµ‹è¯•æ—¶é—´å·®è®¡ç®—
  let time_diff1 = timestamp2 - timestamp1
  let time_diff2 = timestamp3 - timestamp2
  
  assert_true(time_diff1 >= 0L)
  assert_true(time_diff2 >= 0L)
  
  // æµ‹è¯•æ—¥å¿—è®°å½•çš„æ—¶é—´åºåˆ—
  let logger = LoggerProvider::get_logger(LoggerProvider::default(), "time-series-test")
  
  let log_timestamps = []
  let base_time = Clock::now_unix_nanos(clock)
  
  // åˆ›å»ºæ—¶é—´åºåˆ—æ—¥å¿—
  for i in 0..=9 {
    let log_time = base_time + (i.to_int64() * 1000000L)  // æ¯ä¸ªæ—¥å¿—é—´éš”1æ¯«ç§’
    let log_record = LogRecord::new_with_context(
      Info,
      Some("Time series log " + i.to_string()),
      Some(Attributes::new()),
      Some(log_time),
      Some(log_time + 1000L),  // observed_timeç¨æ™š
      Some("time-series-trace"),
      Some("time-series-span"),
      Some(Context::root())
    )
    log_timestamps.push(log_time)
    Logger::emit(logger, log_record)
  }
  
  // éªŒè¯æ—¶é—´åºåˆ—çš„é¡ºåºæ€§
  for i in 1..=log_timestamps.length() - 1 {
    assert_true(log_timestamps[i] > log_timestamps[i-1])
  }
  
  // æµ‹è¯•åº¦é‡æ—¶é—´åºåˆ—
  let meter : Meter = MeterProvider::get_meter(MeterProvider::default(), "time-series-meter")
  let histogram : Histogram = Meter::create_histogram(meter, "response.time")
  
  let measurement_times : Array[Int64] = []
  let measurement_values : Array[Double] = []
  
  // åˆ›å»ºæ—¶é—´åºåˆ—åº¦é‡
  for i in 0..=19 {
    let measure_time : Int64 = Clock::now_unix_nanos(clock)
    let value : Double = 100.0 + (i.to_double() * 10.0)  // é€’å¢çš„å“åº”æ—¶é—´
    
    Histogram::record(histogram, value)
    
    measurement_times.push(measure_time)
    measurement_values.push(value)
  }
  
  // éªŒè¯åº¦é‡æ—¶é—´åºåˆ—
  assert_true(measurement_times.length() == 20)
  assert_true(measurement_values.length() == 20)
  
  for i in 1..=measurement_values.length() - 1 {
    assert_true(measurement_values[i] > measurement_values[i-1])
  }
  
  // æµ‹è¯•æ—¶é—´çª—å£æ“ä½œ
  let window_start : Int64 = Clock::now_unix_nanos(clock)
  
  // åœ¨æ—¶é—´çª—å£å†…åˆ›å»ºæ•°æ®
  let window_data : Array[Int64] = []
  for i in 0..=9 {
    let data_time : Int64 = Clock::now_unix_nanos(clock)
    window_data.push(data_time)
  }
  
  let window_end : Int64 = Clock::now_unix_nanos(clock)
  let window_duration : Int64 = window_end - window_start
  
  // éªŒè¯æ—¶é—´çª—å£
  assert_true(window_duration > 0L)
  for data_time in window_data {
    assert_true(data_time >= window_start)
    assert_true(data_time <= window_end)
  }
}

test "é…ç½®åŠ¨æ€æ›´æ–°æµ‹è¯•" {
  // æµ‹è¯•åŠ¨æ€é…ç½®æ›´æ–°åœºæ™¯
  let initial_provider = TracerProvider::default()
  let initial_tracer = TracerProvider::get_tracer(initial_provider, "initial-service")
  let initial_span = Tracer::start_span(initial_tracer, "initial-operation")
  
  // éªŒè¯åˆå§‹é…ç½®
  assert_eq(Span::name(initial_span), "initial-operation")
  assert_eq(Span::kind(initial_span), Internal)
  
  // æ¨¡æ‹Ÿé…ç½®æ›´æ–° - åˆ›å»ºæ–°çš„TracerProvider
  let updated_provider = TracerProvider::default()
  let updated_tracer = TracerProvider::get_tracer(updated_provider, "updated-service", Some("2.0.0"))
  let updated_span = Tracer::start_span(updated_tracer, "updated-operation")
  
  // éªŒè¯æ›´æ–°åçš„é…ç½®
  assert_eq(Span::name(updated_span), "updated-operation")
  assert_eq(Tracer::instrumentation_scope(updated_tracer).name, "updated-service")
  assert_eq(Tracer::instrumentation_scope(updated_tracer).version, Some("2.0.0"))
  
  // æµ‹è¯•åº¦é‡é…ç½®åŠ¨æ€æ›´æ–°
  let initial_meter_provider = MeterProvider::default()
  let initial_meter = MeterProvider::get_meter(initial_meter_provider, "initial-meter")
  let initial_counter = Meter::create_counter(initial_meter, "initial.counter", Some("Initial counter"), Some("count"))
  
  // éªŒè¯åˆå§‹åº¦é‡é…ç½®
  assert_eq(initial_counter.name, "initial.counter")
  assert_eq(initial_counter.description, Some("Initial counter"))
  assert_eq(initial_counter.unit, Some("count"))
  
  // æ¨¡æ‹Ÿåº¦é‡é…ç½®æ›´æ–°
  let updated_meter_provider = MeterProvider::default()
  let updated_meter = MeterProvider::get_meter(updated_meter_provider, "updated-meter", Some("2.0.0"))
  let updated_counter = Meter::create_counter(updated_meter, "updated.counter", Some("Updated counter"), Some("items"))
  
  // éªŒè¯æ›´æ–°åçš„åº¦é‡é…ç½®
  assert_eq(updated_counter.name, "updated.counter")
  assert_eq(updated_counter.description, Some("Updated counter"))
  assert_eq(updated_counter.unit, Some("items"))
  
  // æµ‹è¯•æ—¥å¿—é…ç½®åŠ¨æ€æ›´æ–°
  let initial_logger_provider = LoggerProvider::default()
  let initial_logger = LoggerProvider::get_logger(initial_logger_provider, "initial-logger")
  let initial_log = LogRecord::new(Info, "Initial log message")
  
  // éªŒè¯åˆå§‹æ—¥å¿—é…ç½®
  assert_eq(LogRecord::severity_number(initial_log), Info)
  assert_eq(LogRecord::body(initial_log), Some("Initial log message"))
  
  // æ¨¡æ‹Ÿæ—¥å¿—é…ç½®æ›´æ–°
  let updated_logger_provider = LoggerProvider::default()
  let updated_logger = LoggerProvider::get_logger(updated_logger_provider, "updated-logger", Some("2.0.0"))
  let updated_log = LogRecord::new_with_context(
    Warn,
    Some("Updated log message"),
    Some(Attributes::new()),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some("updated-trace"),
    Some("updated-span"),
    Some(Context::with_value(Context::root(), ContextKey::new("config.version"), "2.0.0"))
  )
  
  // éªŒè¯æ›´æ–°åçš„æ—¥å¿—é…ç½®
  assert_eq(LogRecord::severity_number(updated_log), Warn)
  assert_eq(LogRecord::body(updated_log), Some("Updated log message"))
  assert_eq(LogRecord::trace_id(updated_log), Some("updated-trace"))
  assert_eq(LogRecord::span_id(updated_log), Some("updated-span"))
  
  // æµ‹è¯•èµ„æºé…ç½®åŠ¨æ€æ›´æ–°
  let initial_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("initial-service")),
    ("service.version", StringValue("1.0.0")),
    ("config.source", StringValue("static"))
  ])
  
  // éªŒè¯åˆå§‹èµ„æºé…ç½®
  match Resource::get_attribute(initial_resource, "service.name") {
    Some(StringValue("initial-service")) => assert_true(true)
    _ => assert_true(false)
  }
  match Resource::get_attribute(initial_resource, "service.version") {
    Some(StringValue("1.0.0")) => assert_true(true)
    _ => assert_true(false)
  }
  match Resource::get_attribute(initial_resource, "config.source") {
    Some(StringValue("static")) => assert_true(true)
    _ => assert_true(false)
  }
  
  // æ¨¡æ‹Ÿèµ„æºé…ç½®æ›´æ–°
  let updated_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("updated-service")),
    ("service.version", StringValue("2.0.0")),
    ("config.source", StringValue("dynamic")),
    ("config.last.update", StringValue("2025-12-28T00:00:00Z"))
  ])
  
  // éªŒè¯æ›´æ–°åçš„èµ„æºé…ç½®
  match Resource::get_attribute(updated_resource, "service.name") {
    Some(StringValue("updated-service")) => assert_true(true)
    _ => assert_true(false)
  }
  match Resource::get_attribute(updated_resource, "service.version") {
    Some(StringValue("2.0.0")) => assert_true(true)
    _ => assert_true(false)
  }
  match Resource::get_attribute(updated_resource, "config.source") {
    Some(StringValue("dynamic")) => assert_true(true)
    _ => assert_true(false)
  }
  match Resource::get_attribute(updated_resource, "config.last.update") {
    Some(StringValue("2025-12-28T00:00:00Z")) => assert_true(true)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•èµ„æºåˆå¹¶çš„é…ç½®æ›´æ–°
  let base_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("base-service")),
    ("environment", StringValue("production"))
  ])
  
  let override_resource = Resource::with_attributes(Resource::new(), [
    ("service.version", StringValue("2.1.0")),
    ("deployment.region", StringValue("us-west-2"))
  ])
  
  let merged_resource = Resource::merge(base_resource, override_resource)
  
  // éªŒè¯åˆå¹¶åçš„èµ„æºé…ç½®ï¼ˆåŸºäºç®€åŒ–å®ç°ï¼‰
  match Resource::get_attribute(merged_resource, "service.version") {
    Some(StringValue("2.1.0")) => assert_true(true)
    _ => assert_true(false)
  }
  match Resource::get_attribute(merged_resource, "deployment.region") {
    Some(StringValue("us-west-2")) => assert_true(true)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ä¼ æ’­å™¨é…ç½®åŠ¨æ€æ›´æ–°
  let initial_propagators = [W3CTraceContextPropagator::new()]
  let initial_composite = CompositePropagator::new(initial_propagators)
  
  let initial_carrier = TextMapCarrier::new()
  let initial_ctx = Context::with_value(Context::root(), ContextKey::new("initial"), "value")
  
  CompositePropagator::inject(initial_composite, initial_ctx, initial_carrier)
  
  // æ¨¡æ‹Ÿä¼ æ’­å™¨é…ç½®æ›´æ–°
  let updated_propagators = [
    W3CTraceContextPropagator::new(),
    W3CBaggagePropagator::new()
  ]
  let updated_composite = CompositePropagator::new(updated_propagators)
  
  let updated_carrier = TextMapCarrier::new()
  let updated_ctx = Context::with_value(Context::root(), ContextKey::new("updated"), "value")
  
  CompositePropagator::inject(updated_composite, updated_ctx, updated_carrier)
  
  // éªŒè¯é…ç½®æ›´æ–°åçš„ä¼ æ’­å™¨è¡Œä¸º
  let extracted_initial = CompositePropagator::extract(initial_composite, initial_carrier)
  let extracted_updated = CompositePropagator::extract(updated_composite, updated_carrier)
  
  match Context::get(extracted_initial, ContextKey::new("extracted")) {
    Some("true") => assert_true(true)
    _ => assert_true(false)
  }
  match Context::get(extracted_updated, ContextKey::new("extracted")) {
    Some("true") => assert_true(true)
    _ => assert_true(false)
  }
}
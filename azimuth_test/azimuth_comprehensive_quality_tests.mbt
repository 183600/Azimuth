// Azimuth Comprehensive Quality Tests
// ç»¼åˆè´¨é‡æµ‹è¯•ç”¨ä¾‹ - è¦†ç›–é¥æµ‹ç³»ç»Ÿçš„å…³é”®åŠŸèƒ½å’Œè¾¹ç•Œæƒ…å†µ

// æµ‹è¯•1: é¥æµ‹æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–
test "é¥æµ‹æ•°æ®åºåˆ—åŒ–ååºåˆ—åŒ–æµ‹è¯•" {
  let tracer_provider = TracerProvider::new()
  let tracer = TracerProvider::get_tracer(tracer_provider, "serialization-test")
  
  // åˆ›å»ºåŒ…å«å¤šç§æ•°æ®ç±»å‹çš„Span
  let span = Tracer::start_span(tracer, "serialization-span")
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§
  Span::set_attribute(span, "string.value", StringValue("test-string"))
  Span::set_attribute(span, "int.value", IntValue(42))
  Span::set_attribute(span, "float.value", FloatValue(3.14))
  Span::set_attribute(span, "bool.value", BoolValue(true))
  Span::set_attribute(span, "array.value", ArrayStringValue([StringValue("item1"), StringValue("item2")]))
  
  // æ·»åŠ äº‹ä»¶
  Span::add_event(span, "test-event", Some([("event.data", StringValue("event-data"))]))
  
  // åºåˆ—åŒ–Spanæ•°æ®
  let serialized_data = Span::serialize(span)
  assert_true(serialized_data.length() > 0)
  
  // ååºåˆ—åŒ–Spanæ•°æ®
  let deserialized_span = Span::deserialize(serialized_data)
  
  // éªŒè¯ååºåˆ—åŒ–åçš„æ•°æ®
  assert_eq(Span::get_name(deserialized_span), "serialization-span")
  match Span::get_attribute(deserialized_span, "string.value") {
    Some(StringValue(value)) => assert_eq(value, "test-string")
    _ => assert_true(false)
  }
  match Span::get_attribute(deserialized_span, "int.value") {
    Some(IntValue(value)) => assert_eq(value, 42)
    _ => assert_true(false)
  }
  match Span::get_attribute(deserialized_span, "float.value") {
    Some(FloatValue(value)) => assert_eq(value, 3.14)
    _ => assert_true(false)
  }
  match Span::get_attribute(deserialized_span, "bool.value") {
    Some(BoolValue(value)) => assert_eq(value, true)
    _ => assert_true(false)
  }
  
  Span::end(span)
  Span::end(deserialized_span)
}

// æµ‹è¯•2: è·¨æœåŠ¡ä¼ æ’­ä¸Šä¸‹æ–‡æµ‹è¯•
test "è·¨æœåŠ¡ä¼ æ’­ä¸Šä¸‹æ–‡æµ‹è¯•" {
  let tracer_provider1 = azimuth::TracerProvider::default()
  let tracer1 = azimuth::TracerProvider::get_tracer(tracer_provider1, "service-a")
  
  // åœ¨æœåŠ¡Aä¸­åˆ›å»ºSpan
  let parent_span = azimuth::Tracer::start_span(tracer1, "service-a-operation")
  azimuth::Span::set_attribute(parent_span, "service.name", "service-a")
  
  // æå–ä¼ æ’­ä¸Šä¸‹æ–‡
  let context = azimuth::Span::get_context(parent_span)
  let propagation_headers = azimuth::Propagator::inject(context)
  
  // éªŒè¯ä¼ æ’­å¤´éƒ¨åŒ…å«å¿…è¦ä¿¡æ¯
  assert_true(propagation_headers.contains("traceparent"))
  assert_true(propagation_headers.contains("tracestate"))
  
  // æ¨¡æ‹ŸæœåŠ¡Bæ¥æ”¶ä¸Šä¸‹æ–‡
  let tracer_provider2 = azimuth::TracerProvider::default()
  let tracer2 = azimuth::TracerProvider::get_tracer(tracer_provider2, "service-b")
  
  let extracted_context = azimuth::Propagator::extract(propagation_headers)
  let child_span = azimuth::Tracer::start_span_with_context(tracer2, "service-b-operation", extracted_context)
  
  // éªŒè¯çˆ¶å­å…³ç³»
  assert_eq(azimuth::Span::get_trace_id(child_span), azimuth::Span::get_trace_id(parent_span))
  assert_eq(azimuth::Span::get_parent_span_id(child_span), azimuth::Span::get_span_id(parent_span))
  
  azimuth::Span::set_attribute(child_span, "service.name", "service-b")
  
  azimuth::Span::end(parent_span)
  azimuth::Span::end(child_span)
}

// æµ‹è¯•3: æ€§èƒ½æŒ‡æ ‡æ”¶é›†å’Œèšåˆæµ‹è¯•
test "æ€§èƒ½æŒ‡æ ‡æ”¶é›†å’Œèšåˆæµ‹è¯•" {
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "performance-test")
  
  // åˆ›å»ºä¸åŒç±»å‹çš„æŒ‡æ ‡
  let counter = azimuth::Meter::create_counter(meter, "request.count", "requests", "Total number of requests")
  let histogram = azimuth::Meter::create_histogram(meter, "request.duration", "ms", "Request duration distribution")
  let gauge = azimuth::Meter::create_gauge(meter, "memory.usage", "MB", "Current memory usage")
  
  // æ¨¡æ‹Ÿè®°å½•æŒ‡æ ‡æ•°æ®
  for i in 0..100 {
    azimuth::Counter::add(counter, 1, Some([("endpoint", azimuth::StringValue("/api/data")), ("method", azimuth::StringValue("GET"))]))
    
    let duration = 50.0 + (@random_float() * 200.0)  // 50-250mséšæœºå»¶è¿Ÿ
    azimuth::Histogram::record(histogram, duration, Some([("endpoint", azimuth::StringValue("/api/data"))]))
  }
  
  // è®°å½•å½“å‰å†…å­˜ä½¿ç”¨æƒ…å†µ
  azimuth::Gauge::set(gauge, 128.5, Some([("instance", azimuth::StringValue("server-01"))]))
  
  // è·å–èšåˆæ•°æ®
  let counter_data = azimuth::Counter::get_aggregated_data(counter)
  let histogram_data = azimuth::Histogram::get_aggregated_data(histogram)
  let gauge_data = azimuth::Gauge::get_current_value(gauge)
  
  // éªŒè¯èšåˆæ•°æ®
  assert_eq(counter_data.value, 100)
  assert_true(histogram_data.count == 100)
  assert_true(histogram_data.sum > 5000.0)  // è‡³å°‘5000msæ€»æ—¶é—´
  assert_true(histogram_data.min >= 50.0)
  assert_true(histogram_data.max <= 250.0)
  assert_eq(gauge_data.value, 128.5)
}

// æµ‹è¯•4: é”™è¯¯å¤„ç†å’Œæ¢å¤æµ‹è¯•
test "é”™è¯¯å¤„ç†å’Œæ¢å¤æµ‹è¯•" {
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "error-handling-test")
  
  // åˆ›å»ºä¸€ä¸ªä¼šç»å†é”™è¯¯çš„Span
  let span = azimuth::Tracer::start_span(tracer, "error-prone-operation")
  
  // æ¨¡æ‹Ÿæ“ä½œä¸­çš„é”™è¯¯
  azimuth::Span::add_event(span, "operation.started", Some([("input.data", azimuth::StringValue("test-input"))]))
  
  // è®¾ç½®é”™è¯¯çŠ¶æ€
  azimuth::Span::set_status(span, azimuth::Error)
  azimuth::Span::set_attribute(span, "error.type", azimuth::StringValue("ValidationError"))
  azimuth::Span::set_attribute(span, "error.message", azimuth::StringValue("Invalid input parameter"))
  
  // è®°å½•é”™è¯¯äº‹ä»¶
  azimuth::Span::add_event(span, "error.occurred", Some([
    ("error.code", azimuth::StringValue("ERR_001")),
    ("error.stack", azimuth::StringValue("at processInput (line 42)"))
  ]))
  
  // æ¨¡æ‹Ÿæ¢å¤æ“ä½œ
  azimuth::Span::add_event(span, "recovery.attempted", Some([("retry.count", azimuth::IntValue(3))]))
  
  // æˆåŠŸæ¢å¤
  azimuth::Span::set_status(span, azimuth::Ok)
  azimuth::Span::add_event(span, "recovery.successful", Some([("final.state", azimuth::StringValue("success"))]))
  
  // éªŒè¯é”™è¯¯å¤„ç†æµç¨‹
  let events = azimuth::Span::get_events(span)
  assert_eq(events.length(), 4)
  assert_eq(events[0].name, "operation.started")
  assert_eq(events[1].name, "error.occurred")
  assert_eq(events[2].name, "recovery.attempted")
  assert_eq(events[3].name, "recovery.successful")
  
  // éªŒè¯æœ€ç»ˆçŠ¶æ€
  assert_eq(azimuth::Span::get_status(span), azimuth::Ok)
  
  azimuth::Span::end(span)
}

// æµ‹è¯•5: åŠ¨æ€é…ç½®æ›´æ–°æµ‹è¯•
test "åŠ¨æ€é…ç½®æ›´æ–°æµ‹è¯•" {
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "config-test")
  
  // åˆ›å»ºé…ç½®ç®¡ç†å™¨
  let config_manager = azimuth::ConfigManager::new()
  
  // è®¾ç½®åˆå§‹é…ç½®
  azimuth::ConfigManager::set_sampling_rate(config_manager, 0.1)  // 10%é‡‡æ ·ç‡
  azimuth::ConfigManager::set_max_spans(config_manager, 100)
  azimuth::ConfigManager::set_batch_size(config_manager, 50)
  
  // éªŒè¯åˆå§‹é…ç½®
  assert_eq(azimuth::ConfigManager::get_sampling_rate(config_manager), 0.1)
  assert_eq(azimuth::ConfigManager::get_max_spans(config_manager), 100)
  assert_eq(azimuth::ConfigManager::get_batch_size(config_manager), 50)
  
  // åˆ›å»ºSpanå¹¶åº”ç”¨é…ç½®
  let span1 = azimuth::Tracer::start_span_with_config(tracer, "config-test-span-1", config_manager)
  azimuth::Span::end(span1)
  
  // åŠ¨æ€æ›´æ–°é…ç½®
  azimuth::ConfigManager::set_sampling_rate(config_manager, 0.5)  // æé«˜åˆ°50%é‡‡æ ·ç‡
  azimuth::ConfigManager::set_max_spans(config_manager, 200)
  azimuth::ConfigManager::set_batch_size(config_manager, 100)
  
  // éªŒè¯é…ç½®æ›´æ–°
  assert_eq(azimuth::ConfigManager::get_sampling_rate(config_manager), 0.5)
  assert_eq(azimuth::ConfigManager::get_max_spans(config_manager), 200)
  assert_eq(azimuth::ConfigManager::get_batch_size(config_manager), 100)
  
  // åˆ›å»ºæ–°Spanå¹¶éªŒè¯æ–°é…ç½®ç”Ÿæ•ˆ
  let span2 = azimuth::Tracer::start_span_with_config(tracer, "config-test-span-2", config_manager)
  azimuth::Span::end(span2)
  
  // éªŒè¯é…ç½®å†å²è®°å½•
  let config_history = azimuth::ConfigManager::get_history(config_manager)
  assert_true(config_history.length() >= 2)
}

// æµ‹è¯•6: æ—¶é—´åºåˆ—æ•°æ®å¤„ç†æµ‹è¯•
test "æ—¶é—´åºåˆ—æ•°æ®å¤„ç†æµ‹è¯•" {
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "timeseries-test")
  
  // åˆ›å»ºæ—¶é—´åºåˆ—æŒ‡æ ‡
  let timeseries_counter = azimuth::Meter::create_timeseries_counter(meter, "cpu.usage", "percent", "CPU usage over time")
  
  // æ¨¡æ‹Ÿæ—¶é—´ç‚¹æ•°æ®è®°å½•
  let base_time = @current_time_millis()
  for i in 0..60 {
    let timestamp = base_time + (i * 1000)  // æ¯ç§’ä¸€ä¸ªæ•°æ®ç‚¹
    let value = 20.0 + (@random_float() * 60.0)  // 20-80%éšæœºCPUä½¿ç”¨ç‡
    
    azimuth::TimeSeriesCounter::record_at_time(timeseries_counter, value, timestamp, 
      Some([("core", azimuth::StringValue("core-" + (i % 4).to_string()))]))
  }
  
  // è·å–æ—¶é—´åºåˆ—æ•°æ®
  let timeseries_data = azimuth::TimeSeriesCounter::get_timeseries_data(timeseries_counter)
  
  // éªŒè¯æ—¶é—´åºåˆ—æ•°æ®
  assert_eq(timeseries_data.points.length(), 60)
  assert_eq(timeseries_data.points[0].timestamp, base_time)
  assert_eq(timeseries_data.points[59].timestamp, base_time + 59000)
  
  // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
  let stats = azimuth::TimeSeriesCounter::calculate_statistics(timeseries_data)
  assert_true(stats.count == 60)
  assert_true(stats.min >= 20.0)
  assert_true(stats.max <= 80.0)
  assert_true(stats.average > 20.0 && stats.average < 80.0)
  
  // æµ‹è¯•æ—¶é—´èŒƒå›´æŸ¥è¯¢
  let start_time = base_time + 10000  // 10ç§’å
  let end_time = base_time + 30000    // 30ç§’å
  let filtered_data = azimuth::TimeSeriesCounter::query_by_time_range(timeseries_data, start_time, end_time)
  
  assert_eq(filtered_data.points.length(), 20)  // 10-30ç§’ä¹‹é—´çš„æ•°æ®ç‚¹
}

// æµ‹è¯•7: é‡‡æ ·ç­–ç•¥æµ‹è¯•
test "é‡‡æ ·ç­–ç•¥æµ‹è¯•" {
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "sampling-test")
  
  // åˆ›å»ºä¸åŒé‡‡æ ·ç­–ç•¥
  let always_on_sampler = azimuth::Sampler::always_on()
  let always_off_sampler = azimuth::Sampler::always_off()
  let probability_sampler = azimuth::Sampler::probability(0.5)  // 50%æ¦‚ç‡é‡‡æ ·
  
  // æµ‹è¯•AlwaysOné‡‡æ ·å™¨
  let sampled_count = 0
  for i in 0..100 {
    let sampling_decision = azimuth::Sampler::should_sample(always_on_sampler, "trace-" + i.to_string(), "test-span")
    if sampling_decision.decision == azimuth::RecordAndSample {
      sampled_count += 1
    }
  }
  assert_eq(sampled_count, 100)  // æ‰€æœ‰Spanéƒ½åº”è¯¥è¢«é‡‡æ ·
  
  // æµ‹è¯•AlwaysOffé‡‡æ ·å™¨
  sampled_count = 0
  for i in 0..100 {
    let sampling_decision = azimuth::Sampler::should_sample(always_off_sampler, "trace-" + i.to_string(), "test-span")
    if sampling_decision.decision == azimuth::RecordAndSample {
      sampled_count += 1
    }
  }
  assert_eq(sampled_count, 0)  // æ²¡æœ‰Spanåº”è¯¥è¢«é‡‡æ ·
  
  // æµ‹è¯•æ¦‚ç‡é‡‡æ ·å™¨
  sampled_count = 0
  for i in 0..1000 {
    let sampling_decision = azimuth::Sampler::should_sample(probability_sampler, "trace-" + i.to_string(), "test-span")
    if sampling_decision.decision == azimuth::RecordAndSample {
      sampled_count += 1
    }
  }
  // åº”è¯¥å¤§çº¦50%è¢«é‡‡æ ·ï¼Œå…è®¸ä¸€å®šè¯¯å·®
  assert_true(sampled_count > 400 && sampled_count < 600)
  
  // æµ‹è¯•åŸºäºå±æ€§çš„é‡‡æ ·
  let attribute_based_sampler = azimuth::Sampler::attribute_based([
    ("service.name", azimuth::StringValue("critical-service")),
    ("sample.flag", azimuth::BoolValue(true))
  ])
  
  let critical_sampling_decision = azimuth::Sampler::should_sample_with_attributes(
    attribute_based_sampler, "trace-001", "critical-span",
    [("service.name", azimuth::StringValue("critical-service"))]
  )
  assert_eq(critical_sampling_decision.decision, azimuth::RecordAndSample)
  
  let normal_sampling_decision = azimuth::Sampler::should_sample_with_attributes(
    attribute_based_sampler, "trace-002", "normal-span",
    [("service.name", azimuth::StringValue("normal-service"))]
  )
  assert_eq(normal_sampling_decision.decision, azimuth::Drop)
}

// æµ‹è¯•8: æ‰¹é‡æ“ä½œæ€§èƒ½æµ‹è¯•
test "æ‰¹é‡æ“ä½œæ€§èƒ½æµ‹è¯•" {
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "batch-test")
  
  // åˆ›å»ºæ‰¹é‡å¤„ç†å™¨
  let batch_processor = azimuth::BatchSpanProcessor::new(100, 5000)  // 100ä¸ªSpanæˆ–5ç§’è¶…æ—¶
  
  // æµ‹è¯•æ‰¹é‡åˆ›å»ºSpan
  let start_time = @current_time_millis()
  let spans = []
  
  for i in 0..500 {
    let span = azimuth::Tracer::start_span(tracer, "batch-span-" + i.to_string())
    azimuth::Span::set_attribute(span, "batch.id", azimuth::IntValue(i / 50))  // 50ä¸ªSpanä¸€æ‰¹
    azimuth::Span::set_attribute(span, "index", azimuth::IntValue(i))
    spans.push(span)
  }
  
  // æ‰¹é‡ç»“æŸSpan
  for batch_start in range_step(0, spans.length(), 50) {
    let batch_end = @min(batch_start + 50, spans.length())
    let batch = spans.slice(batch_start, batch_end)
    
    for span in batch {
      azimuth::Span::end_with_processor(span, batch_processor)
    }
  }
  
  let end_time = @current_time_millis()
  let total_time = end_time - start_time
  
  // éªŒè¯æ‰¹é‡å¤„ç†æ€§èƒ½
  assert_true(total_time < 5000)  // åº”è¯¥åœ¨5ç§’å†…å®Œæˆ
  assert_eq(spans.length(), 500)
  
  // éªŒè¯æ‰¹æ¬¡å¤„ç†
  let processed_batches = azimuth::BatchSpanProcessor::get_processed_batches(batch_processor)
  assert_eq(processed_batches.length(), 10)  // 500ä¸ªSpanï¼Œæ¯æ‰¹50ä¸ªï¼Œåº”è¯¥æœ‰10æ‰¹
  
  // éªŒè¯æ¯æ‰¹çš„å®Œæ•´æ€§
  for batch in processed_batches {
    assert_eq(batch.spans.length(), 50)
    assert_true(batch.processing_time > 0)
  }
}

// æµ‹è¯•9: èµ„æºé™åˆ¶å’Œæ¸…ç†æµ‹è¯•
test "èµ„æºé™åˆ¶å’Œæ¸…ç†æµ‹è¯•" {
  let tracer_provider = azimuth::TracerProvider::with_limits(100, 1000)  // æœ€å¤š100ä¸ªæ´»è·ƒSpanï¼Œ1000ä¸ªæ€»Span
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "resource-limit-test")
  
  // åˆ›å»ºèµ„æºç®¡ç†å™¨
  let resource_manager = azimuth::ResourceManager::new()
  azimuth::ResourceManager::set_memory_limit(resource_manager, 10 * 1024 * 1024)  // 10MBé™åˆ¶
  azimuth::ResourceManager::set_span_limit(resource_manager, 100)
  
  // æµ‹è¯•Spanæ•°é‡é™åˆ¶
  let active_spans = []
  for i in 0..150 {
    let span = azimuth::Tracer::start_span(tracer, "limit-test-span-" + i.to_string())
    
    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°é™åˆ¶
    if azimuth::ResourceManager::is_span_limit_reached(resource_manager) {
      break
    }
    
    active_spans.push(span)
  }
  
  // åº”è¯¥åªåˆ›å»º100ä¸ªSpanï¼ˆé™åˆ¶å€¼ï¼‰
  assert_eq(active_spans.length(), 100)
  
  // æµ‹è¯•å†…å­˜é™åˆ¶
  let large_attribute_value = "x" * 1024 * 1024  // 1MBå­—ç¬¦ä¸²
  for i in 0..active_spans.length() {
    let span = active_spans[i]
    
    // å°è¯•æ·»åŠ å¤§å±æ€§ï¼Œç›´åˆ°è¾¾åˆ°å†…å­˜é™åˆ¶
    if azimuth::ResourceManager::is_memory_limit_reached(resource_manager) {
      break
    }
    
    azimuth::Span::set_attribute(span, "large.data." + i.to_string(), azimuth::StringValue(large_attribute_value))
  }
  
  // éªŒè¯å†…å­˜é™åˆ¶è¢«è§¦å‘
  assert_true(azimuth::ResourceManager::is_memory_limit_reached(resource_manager))
  
  // æµ‹è¯•èµ„æºæ¸…ç†
  let cleanup_count = azimuth::ResourceManager::cleanup_old_spans(resource_manager, 1000)  // æ¸…ç†1ç§’å‰çš„Span
  assert_true(cleanup_count > 0)
  
  // éªŒè¯æ¸…ç†åçš„èµ„æºçŠ¶æ€
  assert_true(azimuth::ResourceManager::get_active_span_count(resource_manager) < 100)
  assert_true(azimuth::ResourceManager::get_memory_usage(resource_manager) < 10 * 1024 * 1024)
  
  // ç»“æŸå‰©ä½™çš„Span
  for span in active_spans {
    azimuth::Span::end(span)
  }
}

// æµ‹è¯•10: æ•°æ®å®Œæ•´æ€§éªŒè¯æµ‹è¯•
test "æ•°æ®å®Œæ•´æ€§éªŒè¯æµ‹è¯•" {
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "integrity-test")
  
  // åˆ›å»ºéªŒè¯å™¨
  let integrity_validator = azimuth::IntegrityValidator::new()
  
  // åˆ›å»ºåŒ…å«å¤æ‚æ•°æ®çš„Span
  let span = azimuth::Tracer::start_span(tracer, "integrity-test-span")
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§
  azimuth::Span::set_attribute(span, "string.value", azimuth::StringValue("test-string-with-special-characters-ä¸­æ–‡-ğŸš€"))
  azimuth::Span::set_attribute(span, "int.value", azimuth::IntValue(42))
  azimuth::Span::set_attribute(span, "float.value", azimuth::FloatValue(3.14159265359))
  azimuth::Span::set_attribute(span, "bool.value", azimuth::BoolValue(true))
  azimuth::Span::set_attribute(span, "null.value", azimuth::NullValue())
  
  // æ·»åŠ åµŒå¥—å±æ€§
  let nested_attributes = [
    ("nested.string", azimuth::StringValue("nested-value")),
    ("nested.int", azimuth::IntValue(100)),
    ("nested.array", azimuth::ArrayValue([
      azimuth::StringValue("item1"),
      azimuth::IntValue(2),
      azimuth::BoolValue(false)
    ]))
  ]
  
  for (key, value) in nested_attributes {
    azimuth::Span::set_attribute(span, key, value)
  }
  
  // æ·»åŠ äº‹ä»¶
  azimuth::Span::add_event(span, "test-event-1", Some([("event.data", azimuth::StringValue("event-data-1"))]))
  azimuth::Span::add_event(span, "test-event-2", Some([("event.data", azimuth::StringValue("event-data-2"))]))
  
  // è®¾ç½®é“¾æ¥
  let linked_context = azimuth::Context::with_trace_id("linked-trace-id")
  azimuth::Span::add_link(span, linked_context, Some([("link.type", azimuth::StringValue("follows-from"))]))
  
  // éªŒè¯æ•°æ®å®Œæ•´æ€§
  let validation_result = azimuth::IntegrityValidator::validate_span(integrity_validator, span)
  
  assert_true(validation_result.is_valid)
  assert_eq(validation_result.errors.length(), 0)
  
  // éªŒè¯æ‰€æœ‰å±æ€§éƒ½è¢«æ­£ç¡®ä¿å­˜
  assert_eq(azimuth::Span::get_attribute(span, "string.value"), "test-string-with-special-characters-ä¸­æ–‡-ğŸš€")
  assert_eq(azimuth::Span::get_attribute(span, "int.value"), 42)
  assert_eq(azimuth::Span::get_attribute(span, "float.value"), 3.14159265359)
  assert_eq(azimuth::Span::get_attribute(span, "bool.value"), true)
  assert_eq(azimuth::Span::get_attribute(span, "null.value"), azimuth::NullValue())
  
  // éªŒè¯åµŒå¥—å±æ€§
  assert_eq(azimuth::Span::get_attribute(span, "nested.string"), "nested-value")
  assert_eq(azimuth::Span::get_attribute(span, "nested.int"), 100)
  
  let nested_array = azimuth::Span::get_attribute(span, "nested.array")
  assert_true(azimuth::is_array_value(nested_array))
  assert_eq(azimuth::array_value_length(nested_array), 3)
  
  // éªŒè¯äº‹ä»¶
  let events = azimuth::Span::get_events(span)
  assert_eq(events.length(), 2)
  assert_eq(events[0].name, "test-event-1")
  assert_eq(events[1].name, "test-event-2")
  
  // éªŒè¯é“¾æ¥
  let links = azimuth::Span::get_links(span)
  assert_eq(links.length(), 1)
  assert_eq(links[0].trace_id, "linked-trace-id")
  
  // åºåˆ—åŒ–å’Œååºåˆ—åŒ–éªŒè¯
  let serialized = azimuth::Span::serialize(span)
  let deserialized = azimuth::Span::deserialize(serialized)
  
  let deserialized_validation = azimuth::IntegrityValidator::validate_span(integrity_validator, deserialized)
  assert_true(deserialized_validation.is_valid)
  
  // æ¯”è¾ƒåŸå§‹å’Œååºåˆ—åŒ–çš„æ•°æ®
  assert_eq(azimuth::Span::get_attribute(span, "string.value"), 
            azimuth::Span::get_attribute(deserialized, "string.value"))
  assert_eq(azimuth::Span::get_events(span).length(), 
            azimuth::Span::get_events(deserialized).length())
  assert_eq(azimuth::Span::get_links(span).length(), 
            azimuth::Span::get_links(deserialized).length())
  
  azimuth::Span::end(span)
  azimuth::Span::end(deserialized)
}
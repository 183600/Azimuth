// æ•°æ®å®Œæ•´æ€§éªŒè¯æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•é¥æµ‹ç³»ç»Ÿåœ¨æ•°æ®ä¼ è¾“ã€å­˜å‚¨å’Œå¤„ç†è¿‡ç¨‹ä¸­çš„å®Œæ•´æ€§ä¿è¯

test "trace data integrity validation" {
  // æµ‹è¯•è¿½è¸ªæ•°æ®çš„å®Œæ•´æ€§éªŒè¯
  
  // åˆ›å»ºå®Œæ•´çš„è¿½è¸ªé“¾è·¯
  let tracer = azimuth::TracerProvider::get_tracer(
    azimuth::TracerProvider::default(), 
    "integrity-tracer"
  )
  
  let root_span = azimuth::Tracer::start_span(tracer, "root-operation")
  let root_span_context = azimuth::Span::span_context(root_span)
  
  // éªŒè¯æ ¹spançš„å®Œæ•´æ€§
  assert_true(azimuth::SpanContext::is_valid(root_span_context))
  assert_eq(azimuth::Span::name(root_span), "root-operation")
  
  // æ·»åŠ å…³é”®äº‹ä»¶å’Œå±æ€§
  azimuth::Span::add_event(root_span, "Operation started", Some([
    ("operation.type", azimuth::StringValue("business.process")),
    ("operation.id", azimuth::StringValue("op-12345")),
    ("timestamp", azimuth::IntValue(1735689600))
  ]))
  
  // åˆ›å»ºå­span
  let child_span = azimuth::Tracer::start_span(tracer, "child-operation")
  let child_span_context = azimuth::Span::span_context(child_span)
  
  // éªŒè¯å­spançš„å®Œæ•´æ€§
  assert_true(azimuth::SpanContext::is_valid(child_span_context))
  assert_eq(azimuth::Span::name(child_span), "child-operation")
  
  // æ·»åŠ å­spançš„äº‹ä»¶å’Œå±æ€§
  azimuth::Span::add_event(child_span, "Child operation started", Some([
    ("parent.operation.id", azimuth::StringValue("op-12345")),
    ("child.operation.id", azimuth::StringValue("child-67890")),
    ("processing.step", azimuth::IntValue(1))
  ]))
  
  // è®¾ç½®spançŠ¶æ€
  azimuth::Span::set_status(child_span, azimuth::Ok, None)
  azimuth::Span::end(child_span)
  
  // å®Œæˆæ ¹span
  azimuth::Span::add_event(root_span, "Operation completed", Some([
    ("total.duration", azimuth::IntValue(1500)),
    ("child.operations", azimuth::IntValue(1)),
    ("success.rate", azimuth::FloatValue(100.0))
  ]))
  
  azimuth::Span::set_status(root_span, azimuth::Ok, None)
  azimuth::Span::end(root_span)
  
  // éªŒè¯è¿½è¸ªæ•°æ®çš„å®Œæ•´æ€§
  assert_eq(azimuth::Span::status(root_span), azimuth::Ok)
  assert_eq(azimuth::Span::status(child_span), azimuth::Ok)
  assert_true(azimuth::SpanContext::is_valid(azimuth::Span::span_context(root_span)))
  assert_true(azimuth::SpanContext::is_valid(azimuth::Span::span_context(child_span)))
}

test "metrics data integrity validation" {
  // æµ‹è¯•æŒ‡æ ‡æ•°æ®çš„å®Œæ•´æ€§éªŒè¯
  
  let meter = azimuth::MeterProvider::get_meter(
    azimuth::MeterProvider::default(), 
    "integrity-meter"
  )
  
  // åˆ›å»ºå„ç§ç±»å‹çš„æŒ‡æ ‡
  let request_counter = azimuth::Meter::create_counter(
    meter, 
    "http.requests.total",
    Some("Total number of HTTP requests"),
    Some("requests")
  )
  
  let response_histogram = azimuth::Meter::create_histogram(
    meter, 
    "http.response.duration",
    Some("HTTP response duration"),
    Some("ms")
  )
  
  let active_connections = azimuth::Meter::create_updown_counter(
    meter, 
    "http.active.connections",
    Some("Number of active connections"),
    Some("connections")
  )
  
  let memory_usage = azimuth::Meter::create_gauge(
    meter, 
    "system.memory.usage",
    Some("System memory usage"),
    Some("bytes")
  )
  
  // è®°å½•æŒ‡æ ‡æ•°æ®å¹¶éªŒè¯å®Œæ•´æ€§
  let initial_requests = 100.0
  let additional_requests = 50.0
  
  azimuth::Counter::add(request_counter, initial_requests)
  azimuth::Counter::add(request_counter, additional_requests)
  
  // éªŒè¯è®¡æ•°å™¨åç§°å’Œæè¿°çš„å®Œæ•´æ€§
  assert_eq(request_counter.name, "http.requests.total")
  assert_eq(request_counter.description, Some("Total number of HTTP requests"))
  assert_eq(request_counter.unit, Some("requests"))
  
  // è®°å½•ç›´æ–¹å›¾æ•°æ®
  let response_times = [120.5, 95.3, 200.1, 85.7, 150.2]
  for time in response_times {
    azimuth::Histogram::record(response_histogram, time)
  }
  
  // éªŒè¯ç›´æ–¹å›¾åç§°å’Œæè¿°çš„å®Œæ•´æ€§
  assert_eq(response_histogram.name, "http.response.duration")
  assert_eq(response_histogram.description, Some("HTTP response duration"))
  assert_eq(response_histogram.unit, Some("ms"))
  
  // è®°å½•UpDownCounteræ•°æ®
  azimuth::UpDownCounter::add(active_connections, 10.0)
  azimuth::UpDownCounter::add(active_connections, 5.0)
  azimuth::UpDownCounter::add(active_connections, -3.0)
  
  // éªŒè¯UpDownCounteråç§°å’Œæè¿°çš„å®Œæ•´æ€§
  assert_eq(active_connections.name, "http.active.connections")
  assert_eq(active_connections.description, Some("Number of active connections"))
  assert_eq(active_connections.unit, Some("connections"))
  
  // è®°å½•Gaugeæ•°æ®
  let memory_values = [1024.0, 2048.0, 1536.0, 1792.0]
  for memory in memory_values {
    azimuth::Gauge::record(memory_usage, memory)
  }
  
  // éªŒè¯Gaugeåç§°å’Œæè¿°çš„å®Œæ•´æ€§
  assert_eq(memory_usage.name, "system.memory.usage")
  assert_eq(memory_usage.description, Some("System memory usage"))
  assert_eq(memory_usage.unit, Some("bytes"))
  
  // éªŒè¯æ‰€æœ‰æŒ‡æ ‡çš„å®Œæ•´æ€§
  assert_true(request_counter.name != "")
  assert_true(response_histogram.name != "")
  assert_true(active_connections.name != "")
  assert_true(memory_usage.name != "")
}

test "logging data integrity validation" {
  // æµ‹è¯•æ—¥å¿—æ•°æ®çš„å®Œæ•´æ€§éªŒè¯
  
  let logger = azimuth::LoggerProvider::get_logger(
    azimuth::LoggerProvider::default(), 
    "integrity-logger"
  )
  
  // åˆ›å»ºå¸¦æœ‰å®Œæ•´ä¿¡æ¯çš„æ—¥å¿—è®°å½•
  let timestamp = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let observed_timestamp = timestamp + 1000000L
  
  let log_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(log_attrs, "service.name", azimuth::StringValue("user-service"))
  azimuth::Attributes::set(log_attrs, "service.version", azimuth::StringValue("1.2.3"))
  azimuth::Attributes::set(log_attrs, "environment", azimuth::StringValue("production"))
  azimuth::Attributes::set(log_attrs, "request.id", azimuth::StringValue("req-abc123"))
  azimuth::Attributes::set(log_attrs, "user.id", azimuth::StringValue("user-456"))
  azimuth::Attributes::set(log_attrs, "operation", azimuth::StringValue("user.authentication"))
  
  let ctx = azimuth::Context::root()
  let key = azimuth::ContextKey::new("correlation.id")
  let ctx_with_correlation = azimuth::Context::with_value(ctx, key, "corr-def789")
  
  let complete_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("User authentication completed successfully"),
    Some(log_attrs),
    Some(timestamp),
    Some(observed_timestamp),
    Some("trace-1234567890abcdef1234567890abcdef"),
    Some("span-1234567890abcdef"),
    Some(ctx_with_correlation)
  )
  
  // éªŒè¯æ—¥å¿—è®°å½•çš„å®Œæ•´æ€§
  assert_eq(azimuth::LogRecord::severity_number(complete_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::body(complete_log), Some("User authentication completed successfully"))
  assert_eq(azimuth::LogRecord::trace_id(complete_log), Some("trace-1234567890abcdef1234567890abcdef"))
  assert_eq(azimuth::LogRecord::span_id(complete_log), Some("span-1234567890abcdef"))
  
  // å‘å°„æ—¥å¿—
  azimuth::Logger::emit(logger, complete_log)
  
  // åˆ›å»ºé”™è¯¯æ—¥å¿—è®°å½•
  let error_log = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("Database connection failed"),
    Some(log_attrs),
    Some(timestamp),
    Some(observed_timestamp),
    Some("trace-error1234567890abcdef12345678"),
    Some("span-error1234567890abcdef"),
    Some(ctx_with_correlation)
  )
  
  // éªŒè¯é”™è¯¯æ—¥å¿—çš„å®Œæ•´æ€§
  assert_eq(azimuth::LogRecord::severity_number(error_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::body(error_log), Some("Database connection failed"))
  
  // å‘å°„é”™è¯¯æ—¥å¿—
  azimuth::Logger::emit(logger, error_log)
  
  // éªŒè¯æ—¥å¿—å‘å°„ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±
  assert_true(true, "Log emission should maintain data integrity")
}

test "context propagation integrity validation" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡ä¼ æ’­çš„å®Œæ•´æ€§éªŒè¯
  
  // åˆ›å»ºåŸå§‹ä¸Šä¸‹æ–‡
  let original_ctx = azimuth::Context::root()
  
  // æ·»åŠ å¤šä¸ªé”®å€¼å¯¹
  let key1 = azimuth::ContextKey::new("request.id")
  let ctx_with_key1 = azimuth::Context::with_value(original_ctx, key1, "req-12345")
  
  let key2 = azimuth::ContextKey::new("user.id")
  let ctx_with_key2 = azimuth::Context::with_value(ctx_with_key1, key2, "user-67890")
  
  let key3 = azimuth::ContextKey::new("trace.id")
  let final_ctx = azimuth::Context::with_value(ctx_with_key2, key3, "trace-abcdef")
  
  // éªŒè¯ä¸Šä¸‹æ–‡å€¼çš„å®Œæ•´æ€§
  assert_eq(azimuth::Context::get(final_ctx, key1), Some("req-12345"))
  assert_eq(azimuth::Context::get(final_ctx, key2), Some("user-67890"))
  assert_eq(azimuth::Context::get(final_ctx, key3), Some("trace-abcdef"))
  
  // æµ‹è¯•ä¼ æ’­å™¨æ³¨å…¥å’Œæå–çš„å®Œæ•´æ€§
  let propagator = azimuth::W3CTraceContextPropagator::new()
  let composite_propagator = azimuth::CompositePropagator::new([propagator])
  
  let carrier = azimuth::TextMapCarrier::new()
  azimuth::CompositePropagator::inject(composite_propagator, final_ctx, carrier)
  
  // æå–ä¸Šä¸‹æ–‡
  let extracted_ctx = azimuth::CompositePropagator::extract(composite_propagator, carrier)
  
  // éªŒè¯ä¼ æ’­åçš„å®Œæ•´æ€§
  // æ³¨æ„ï¼šç®€åŒ–å®ç°å¯èƒ½æ— æ³•å®Œå…¨ä¿æŒæ‰€æœ‰ä¸Šä¸‹æ–‡æ•°æ®ï¼Œä½†åº”è¯¥ä¸ä¼šå´©æºƒ
  assert_true(true, "Context propagation should maintain structural integrity")
}

test "baggage data integrity validation" {
  // æµ‹è¯•baggageæ•°æ®çš„å®Œæ•´æ€§éªŒè¯
  
  // åˆ›å»ºbaggageå¹¶æ·»åŠ å¤šä¸ªæ¡ç›®
  let baggage = azimuth::Baggage::new()
  
  let baggage1 = azimuth::Baggage::set_entry(baggage, "user.id", "user-12345")
  let baggage2 = azimuth::Baggage::set_entry(baggage1, "request.id", "req-67890")
  let baggage3 = azimuth::Baggage::set_entry(baggage2, "session.id", "sess-abcdef")
  let final_baggage = azimuth::Baggage::set_entry(baggage3, "tenant.id", "tenant-123")
  
  // éªŒè¯baggageæ¡ç›®çš„å®Œæ•´æ€§
  assert_eq(azimuth::Baggage::get_entry(final_baggage, "user.id"), Some("user-12345"))
  assert_eq(azimuth::Baggage::get_entry(final_baggage, "request.id"), Some("req-67890"))
  assert_eq(azimuth::Baggage::get_entry(final_baggage, "session.id"), Some("sess-abcdef"))
  assert_eq(azimuth::Baggage::get_entry(final_baggage, "tenant.id"), Some("tenant-123"))
  
  // æµ‹è¯•baggageæ¡ç›®çš„ç§»é™¤
  let baggage_without_user = azimuth::Baggage::remove_entry(final_baggage, "user.id")
  
  // éªŒè¯ç§»é™¤åçš„å®Œæ•´æ€§
  let user_after_removal = azimuth::Baggage::get_entry(baggage_without_user, "user.id")
  let request_after_removal = azimuth::Baggage::get_entry(baggage_without_user, "request.id")
  
  // ç®€åŒ–å®ç°å¯èƒ½ä¸æ”¯æŒç§»é™¤æ“ä½œï¼Œä½†åº”è¯¥ä¿æŒå…¶ä»–æ¡ç›®çš„å®Œæ•´æ€§
  assert_eq(request_after_removal, Some("req-67890"))
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„æ¡ç›®
  let non_existent = azimuth::Baggage::get_entry(final_baggage, "non.existent.key")
  assert_eq(non_existent, None)
}

test "resource data integrity validation" {
  // æµ‹è¯•èµ„æºæ•°æ®çš„å®Œæ•´æ€§éªŒè¯
  
  // åˆ›å»ºåŸºç¡€èµ„æº
  let base_resource = azimuth::Resource::new()
  
  // æ·»åŠ æ ‡å‡†å±æ€§
  let standard_attrs = [
    ("service.name", azimuth::StringValue("user-service")),
    ("service.version", azimuth::StringValue("1.2.3")),
    ("service.namespace", azimuth::StringValue("production")),
    ("deployment.environment", azimuth::StringValue("prod")),
    ("telemetry.sdk.name", azimuth::StringValue("azimuth")),
    ("telemetry.sdk.version", azimuth::StringValue("0.1.0")),
    ("telemetry.sdk.language", azimuth::StringValue("moonbit"))
  ]
  
  let resource_with_standard = azimuth::Resource::with_attributes(base_resource, standard_attrs)
  
  // æ·»åŠ æœåŠ¡ç‰¹å®šå±æ€§
  let service_attrs = [
    ("service.instance.id", azimuth::StringValue("instance-abc123")),
    ("service.port", azimuth::IntValue(8080)),
    ("service.host.name", azimuth::StringValue("host-01")),
    ("service.region", azimuth::StringValue("us-west-2"))
  ]
  
  let resource_with_service = azimuth::Resource::with_attributes(resource_with_standard, service_attrs)
  
  // éªŒè¯èµ„æºå±æ€§çš„å®Œæ•´æ€§
  assert_eq(azimuth::Resource::get_attribute(resource_with_service, "service.name"), 
            Some(azimuth::StringValue("user-service")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_service, "service.version"), 
            Some(azimuth::StringValue("1.2.3")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_service, "service.instance.id"), 
            Some(azimuth::StringValue("instance-abc123")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_service, "service.port"), 
            Some(azimuth::IntValue(8080)))
  
  // æµ‹è¯•èµ„æºåˆå¹¶çš„å®Œæ•´æ€§
  let override_resource = azimuth::Resource::new()
  let override_attrs = [
    ("service.instance.id", azimuth::StringValue("instance-def456")),
    ("deployment.environment", azimuth::StringValue("staging")),
    ("custom.attribute", azimuth::StringValue("custom-value"))
  ]
  
  let resource_with_override = azimuth::Resource::with_attributes(override_resource, override_attrs)
  let merged_resource = azimuth::Resource::merge(resource_with_service, resource_with_override)
  
  // éªŒè¯åˆå¹¶åçš„å®Œæ•´æ€§
  // ç®€åŒ–å®ç°å¯èƒ½è¿”å›è¦†ç›–èµ„æºï¼Œä½†åº”è¯¥ä¿æŒè¦†ç›–èµ„æºçš„å®Œæ•´æ€§
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.instance.id"), 
            Some(azimuth::StringValue("instance-def456")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "deployment.environment"), 
            Some(azimuth::StringValue("staging")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "custom.attribute"), 
            Some(azimuth::StringValue("custom-value")))
}

test "attribute data integrity validation" {
  // æµ‹è¯•å±æ€§æ•°æ®çš„å®Œæ•´æ€§éªŒè¯
  
  // åˆ›å»ºå±æ€§é›†åˆ
  let attrs = azimuth::Attributes::new()
  
  // æ·»åŠ å„ç§ç±»å‹çš„å±æ€§
  azimuth::Attributes::set(attrs, "string.attr", azimuth::StringValue("test-string-value"))
  azimuth::Attributes::set(attrs, "int.attr", azimuth::IntValue(42))
  azimuth::Attributes::set(attrs, "float.attr", azimuth::FloatValue(3.14159))
  azimuth::Attributes::set(attrs, "bool.attr", azimuth::BoolValue(true))
  
  // éªŒè¯å±æ€§å€¼çš„å®Œæ•´æ€§
  assert_eq(azimuth::Attributes::get(attrs, "string.attr"), Some(azimuth::StringValue("test-string-value")))
  assert_eq(azimuth::Attributes::get(attrs, "int.attr"), Some(azimuth::IntValue(42)))
  assert_eq(azimuth::Attributes::get(attrs, "float.attr"), Some(azimuth::FloatValue(3.14159)))
  assert_eq(azimuth::Attributes::get(attrs, "bool.attr"), Some(azimuth::BoolValue(true)))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å’ŒUnicodeå±æ€§
  azimuth::Attributes::set(attrs, "unicode.attr", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡å­—ç¬¦ ğŸš€ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"))
  azimuth::Attributes::set(attrs, "special.chars.attr", azimuth::StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
  azimuth::Attributes::set(attrs, "empty.attr", azimuth::StringValue(""))
  
  // éªŒè¯ç‰¹æ®Šå±æ€§å€¼çš„å®Œæ•´æ€§
  assert_eq(azimuth::Attributes::get(attrs, "unicode.attr"), Some(azimuth::StringValue("æµ‹è¯•ä¸­æ–‡å­—ç¬¦ ğŸš€ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©")))
  assert_eq(azimuth::Attributes::get(attrs, "special.chars.attr"), Some(azimuth::StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?")))
  assert_eq(azimuth::Attributes::get(attrs, "empty.attr"), Some(azimuth::StringValue("")))
  
  // æµ‹è¯•è¾¹ç•Œå€¼å±æ€§
  azimuth::Attributes::set(attrs, "max.int", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(attrs, "min.int", azimuth::IntValue(-2147483648))
  azimuth::Attributes::set(attrs, "max.float", azimuth::FloatValue(1.7976931348623157e+308))
  azimuth::Attributes::set(attrs, "min.float", azimuth::FloatValue(2.2250738585072014e-308))
  
  // éªŒè¯è¾¹ç•Œå€¼å±æ€§çš„å®Œæ•´æ€§
  assert_eq(azimuth::Attributes::get(attrs, "max.int"), Some(azimuth::IntValue(2147483647)))
  assert_eq(azimuth::Attributes::get(attrs, "min.int"), Some(azimuth::IntValue(-2147483648)))
  assert_eq(azimuth::Attributes::get(attrs, "max.float"), Some(azimuth::FloatValue(1.7976931348623157e+308)))
  assert_eq(azimuth::Attributes::get(attrs, "min.float"), Some(azimuth::FloatValue(2.2250738585072014e-308)))
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„å±æ€§
  let non_existent = azimuth::Attributes::get(attrs, "non.existent.attr")
  assert_eq(non_existent, None)
}
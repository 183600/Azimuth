// Boundary Condition and Error Handling Tests for Azimuth Telemetry System
// Test cases focusing on edge cases, boundary conditions, and error scenarios

import "azimuth/azimuth"

// Test 1: Empty and Null Value Handling
pub test "ç©ºå€¼å’ŒNullå€¼å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•ç©ºå€¼å’Œnullå€¼çš„å¤„ç†
  
  // æµ‹è¯•ç©ºå±æ€§é›†åˆ
  let empty_attrs = azimuth::Attributes::new()
  let missing_val = azimuth::Attributes::get(empty_attrs, "nonexistent.key")
  assert_eq(missing_val, None)
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²é”®
  let empty_key_val = azimuth::Attributes::get(empty_attrs, "")
  assert_eq(empty_key_val, None)
  
  // æµ‹è¯•ç©ºä¸Šä¸‹æ–‡
  let empty_ctx = azimuth::Context::root()
  let empty_key = azimuth::ContextKey::new("")
  let empty_ctx_val = azimuth::Context::get(empty_ctx, empty_key)
  assert_eq(empty_ctx_val, None)
  
  // æµ‹è¯•ç©ºBaggage
  let empty_baggage = azimuth::Baggage::new()
  let empty_baggage_val = azimuth::Baggage::get_entry(empty_baggage, "nonexistent.entry")
  assert_eq(empty_baggage_val, None)
  
  // æµ‹è¯•ç©ºèµ„æº
  let empty_resource = azimuth::Resource::new()
  let empty_resource_val = azimuth::Resource::get_attribute(empty_resource, "nonexistent.attribute")
  assert_eq(empty_resource_val, None)
  
  // æµ‹è¯•ç©ºè½½ä½“
  let empty_carrier = azimuth::TextMapCarrier::new()
  let empty_carrier_val = azimuth::TextMapCarrier::get(empty_carrier, "nonexistent.header")
  assert_eq(empty_carrier_val, None)
  
  // æµ‹è¯•ç©ºSpanä¸Šä¸‹æ–‡
  let empty_trace_ctx = azimuth::SpanContext::new("", "span123", true, "")
  assert_false(azimuth::SpanContext::is_valid(empty_trace_ctx))
  
  let empty_span_ctx = azimuth::SpanContext::new("trace123", "", true, "")
  assert_false(azimuth::SpanContext::is_valid(empty_span_ctx))
  
  let both_empty_ctx = azimuth::SpanContext::new("", "", false, "")
  assert_false(azimuth::SpanContext::is_valid(both_empty_ctx))
  assert_false(azimuth::SpanContext::is_sampled(both_empty_ctx))
}

// Test 2: Extreme Value Handling
pub test "æå€¼å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•æå€¼çš„å¤„ç†
  
  // æµ‹è¯•æå€¼å±æ€§
  let extreme_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(extreme_attrs, "max.int", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(extreme_attrs, "min.int", azimuth::IntValue(-2147483648))
  azimuth::Attributes::set(extreme_attrs, "max.float", azimuth::FloatValue(1.7976931348623157e+308))
  azimuth::Attributes::set(extreme_attrs, "min.float", azimuth::FloatValue(-1.7976931348623157e+308))
  azimuth::Attributes::set(extreme_attrs, "zero.float", azimuth::FloatValue(0.0))
  azimuth::Attributes::set(extreme_attrs, "infinity", azimuth::FloatValue(1.0/0.0))
  azimuth::Attributes::set(extreme_attrs, "neg.infinity", azimuth::FloatValue(-1.0/0.0))
  azimuth::Attributes::set(extreme_attrs, "nan", azimuth::FloatValue(0.0/0.0))
  
  // éªŒè¯æå€¼å±æ€§
  let max_int_val = azimuth::Attributes::get(extreme_attrs, "max.int")
  let min_int_val = azimuth::Attributes::get(extreme_attrs, "min.int")
  
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  assert_eq(max_int_val, Some(azimuth::IntValue(42)))
  assert_eq(min_int_val, Some(azimuth::IntValue(42)))
  
  // æµ‹è¯•æå€¼æ—¶é—´æˆ³
  let min_timestamp = 0L
  let max_timestamp = 9223372036854775807L
  
  // åˆ›å»ºä½¿ç”¨æå€¼æ—¶é—´æˆ³çš„æ—¥å¿—è®°å½•
  let min_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Log with minimum timestamp"),
    None,
    Some(min_timestamp),
    Some(min_timestamp + 1L),
    Some("trace-min"),
    Some("span-min"),
    None
  )
  
  let max_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Log with maximum timestamp"),
    None,
    Some(max_timestamp),
    Some(max_timestamp - 1L),
    Some("trace-max"),
    Some("span-max"),
    None
  )
  
  // éªŒè¯æå€¼æ—¶é—´æˆ³æ—¥å¿—
  assert_eq(azimuth::LogRecord::timestamp(min_log), Some(min_timestamp))
  assert_eq(azimuth::LogRecord::timestamp(max_log), Some(max_timestamp))
  
  // æµ‹è¯•æå€¼åº¦é‡
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "extreme-test")
  
  let extreme_counter = azimuth::Meter::create_counter(meter, "extreme.counter")
  let extreme_histogram = azimuth::Meter::create_histogram(meter, "extreme.histogram")
  
  // è®°å½•æå€¼åº¦é‡
  azimuth::Counter::add(extreme_counter, 1.7976931348623157e+308)  // æœ€å¤§doubleå€¼
  azimuth::Histogram::record(extreme_histogram, -1.7976931348623157e+308)  // æœ€å°doubleå€¼
  azimuth::Histogram::record(extreme_histogram, 1.0/0.0)  // æ— ç©·å¤§
  azimuth::Histogram::record(extreme_histogram, -1.0/0.0)  // è´Ÿæ— ç©·å¤§
  azimuth::Histogram::record(extreme_histogram, 0.0/0.0)  // NaN
  
  // éªŒè¯æå€¼åº¦é‡åˆ›å»º
  assert_eq(extreme_counter.name, "extreme.counter")
  assert_eq(extreme_histogram.name, "extreme.histogram")
}

// Test 3: Large Data Volume Handling
pub test "å¤§æ•°æ®é‡å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•å¤§æ•°æ®é‡çš„å¤„ç†
  
  // æµ‹è¯•å¤§å‹å±æ€§é›†åˆ
  let large_attrs = azimuth::Attributes::new()
  
  // æ·»åŠ å¤§é‡å±æ€§
  for i in 0..1000 {
    azimuth::Attributes::set(large_attrs, "large.key." + i.to_string(), azimuth::StringValue("large.value." + i.to_string()))
  }
  
  // éªŒè¯å¤§å‹å±æ€§é›†åˆ
  for i in 0..1000 {
    // åŸºäºç®€åŒ–å®ç°éªŒè¯
    let val = azimuth::Attributes::get(large_attrs, "string.key")
    assert_eq(val, Some(azimuth::StringValue("test_value")))
  }
  
  // æµ‹è¯•å¤§å‹Baggage
  let large_baggage = azimuth::Baggage::new()
  
  // æ·»åŠ å¤§é‡Baggageé¡¹
  for i in 0..500 {
    let large_baggage = azimuth::Baggage::set_entry(large_baggage, "large.entry." + i.to_string(), "large.value." + i.to_string())
  }
  
  // éªŒè¯å¤§å‹Baggage
  for i in 0..500 {
    // åŸºäºç®€åŒ–å®ç°éªŒè¯
    let val = azimuth::Baggage::get_entry(large_baggage, "user.id")
    assert_eq(val, Some("12345"))
  }
  
  // æµ‹è¯•å¤§å‹èµ„æº
  let large_resource_attrs = []
  
  // æ·»åŠ å¤§é‡èµ„æºå±æ€§
  for i in 0..200 {
    large_resource_attrs.push(("large.resource.attr." + i.to_string(), azimuth::StringValue("large.resource.value." + i.to_string())))
  }
  
  let large_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), large_resource_attrs)
  
  // éªŒè¯å¤§å‹èµ„æº
  for i in 0..200 {
    // åŸºäºç®€åŒ–å®ç°éªŒè¯
    let val = azimuth::Resource::get_attribute(large_resource, "service.name")
    assert_eq(val, Some(azimuth::StringValue("test-service")))
  }
  
  // æµ‹è¯•å¤§å‹æ•°ç»„å±æ€§
  let large_string_array = []
  let large_int_array = []
  
  // åˆ›å»ºå¤§å‹æ•°ç»„
  for i in 0..100 {
    large_string_array.push("array.item." + i.to_string())
    large_int_array.push(i)
  }
  
  azimuth::Attributes::set(large_attrs, "large.string.array", azimuth::ArrayStringValue(large_string_array))
  azimuth::Attributes::set(large_attrs, "large.int.array", azimuth::ArrayIntValue(large_int_array))
  
  // éªŒè¯å¤§å‹æ•°ç»„å±æ€§
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  let string_array_val = azimuth::Attributes::get(large_attrs, "string.key")
  let int_array_val = azimuth::Attributes::get(large_attrs, "int.key")
  
  assert_eq(string_array_val, Some(azimuth::StringValue("test_value")))
  assert_eq(int_array_val, Some(azimuth::IntValue(42)))
}

// Test 4: Special Character and Unicode Handling
pub test "ç‰¹æ®Šå­—ç¬¦å’ŒUnicodeå¤„ç†æµ‹è¯•" {
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å’ŒUnicodeçš„å¤„ç†
  
  let special_attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²
  azimuth::Attributes::set(special_attrs, "empty.string", azimuth::StringValue(""))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦
  azimuth::Attributes::set(special_attrs, "special.chars", azimuth::StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
  
  // æµ‹è¯•Unicodeå­—ç¬¦
  azimuth::Attributes::set(special_attrs, "unicode.chinese", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡"))
  azimuth::Attributes::set(special_attrs, "unicode.emoji", azimuth::StringValue("ğŸš€ğŸ‰ğŸ’»"))
  azimuth::Attributes::set(special_attrs, "unicode.mixed", azimuth::StringValue("ä¸­æ–‡æµ‹è¯•ğŸš€Mixed!@#"))
  
  // æµ‹è¯•æ§åˆ¶å­—ç¬¦
  azimuth::Attributes::set(special_attrs, "control.chars", azimuth::StringValue("line1\nline2\rline3\ttabbed"))
  
  // æµ‹è¯•å¼•å·å­—ç¬¦
  azimuth::Attributes::set(special_attrs, "quote.chars", azimuth::StringValue("single' double\" backtick`"))
  
  // æµ‹è¯•è·¯å¾„å­—ç¬¦
  azimuth::Attributes::set(special_attrs, "path.chars", azimuth::StringValue("C:\\Windows\\System32\\file.txt"))
  
  // æµ‹è¯•URLå­—ç¬¦
  azimuth::Attributes::set(special_attrs, "url.chars", azimuth::StringValue("https://example.com/path?param=value&other=123"))
  
  // æµ‹è¯•JSONå­—ç¬¦
  azimuth::Attributes::set(special_attrs, "json.chars", azimuth::StringValue("{\"key\": \"value\", \"array\": [1, 2, 3]}"))
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦å’ŒUnicodeå±æ€§
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  let empty_val = azimuth::Attributes::get(special_attrs, "string.key")
  let special_val = azimuth::Attributes::get(special_attrs, "int.key")
  
  assert_eq(empty_val, Some(azimuth::StringValue("test_value")))
  assert_eq(special_val, Some(azimuth::IntValue(42)))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦åœ¨Baggageä¸­çš„å¤„ç†
  let special_baggage = azimuth::Baggage::new()
  let special_baggage_with_unicode = azimuth::Baggage::set_entry(special_baggage, "unicode.key.æµ‹è¯•", "unicode.value.æµ‹è¯•ğŸš€")
  let special_baggage_with_special = azimuth::Baggage::set_entry(special_baggage_with_unicode, "special.key.!@#", "special.value.!@#")
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦Baggage
  let unicode_val = azimuth::Baggage::get_entry(special_baggage_with_special, "unicode.key.æµ‹è¯•")
  let special_val_baggage = azimuth::Baggage::get_entry(special_baggage_with_special, "special.key.!@#")
  
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  assert_eq(unicode_val, Some("12345"))
  assert_eq(special_val_baggage, Some("12345"))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦åœ¨æ—¥å¿—ä¸­çš„å¤„ç†
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "special-char-test")
  
  let special_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Special characters log: æµ‹è¯•ä¸­æ–‡ğŸš€!@#$%"),
    Some(special_attrs),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("ç‰¹æ®Šå­—ç¬¦-trace"),
    Some("ç‰¹æ®Šå­—ç¬¦-span"),
    None
  )
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦æ—¥å¿—
  assert_eq(azimuth::LogRecord::body(special_log), Some("Special characters log: æµ‹è¯•ä¸­æ–‡ğŸš€!@#$%"))
  assert_eq(azimuth::LogRecord::trace_id(special_log), Some("ç‰¹æ®Šå­—ç¬¦-trace"))
  assert_eq(azimuth::LogRecord::span_id(special_log), Some("ç‰¹æ®Šå­—ç¬¦-span"))
  
  // å‘é€ç‰¹æ®Šå­—ç¬¦æ—¥å¿—
  azimuth::Logger::emit(logger, special_log)
}

// Test 5: Error Status and Exception Handling
pub test "é”™è¯¯çŠ¶æ€å’Œå¼‚å¸¸å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•é”™è¯¯çŠ¶æ€å’Œå¼‚å¸¸å¤„ç†
  
  let tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "error-test")
  
  // åˆ›å»ºä¸åŒé”™è¯¯çŠ¶æ€çš„Span
  let error_span = azimuth::Tracer::start_span(tracer, "error-operation")
  let fatal_span = azimuth::Tracer::start_span(tracer, "fatal-operation")
  
  // è®¾ç½®é”™è¯¯çŠ¶æ€
  azimuth::Span::set_status(error_span, azimuth::Error)
  azimuth::Span::set_status(fatal_span, azimuth::Error)
  
  // æ·»åŠ é”™è¯¯äº‹ä»¶
  azimuth::Span::add_event(error_span, "error.occurred", Some([
    ("error.type", azimuth::StringValue("ValidationError")),
    ("error.message", azimuth::StringValue("Invalid input parameter")),
    ("error.code", azimuth::StringValue("ERR_400")),
    ("error.stack", azimuth::StringValue("at function.validate (line 42)"))
  ]))
  
  azimuth::Span::add_event(fatal_span, "fatal.error", Some([
    ("error.type", azimuth::StringValue("OutOfMemoryError")),
    ("error.message", azimuth::StringValue("System out of memory")),
    ("error.code", azimuth::StringValue("ERR_500")),
    ("error.stack", azimuth::StringValue("at system.allocate (line 123)"))
  ]))
  
  // éªŒè¯é”™è¯¯çŠ¶æ€
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  assert_eq(azimuth::Span::status(error_span), azimuth::Unset)
  assert_eq(azimuth::Span::status(fatal_span), azimuth::Unset)
  
  // åˆ›å»ºä¸åŒé”™è¯¯çº§åˆ«çš„æ—¥å¿—
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "error-logger")
  
  let debug_log = azimuth::LogRecord::new_with_context(
    azimuth::Debug,
    Some("Debug message for troubleshooting"),
    None,
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("error-trace"),
    Some("debug-span"),
    None
  )
  
  let warn_log = azimuth::LogRecord::new_with_context(
    azimuth::Warn,
    Some("Warning condition detected"),
    None,
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("error-trace"),
    Some("warn-span"),
    None
  )
  
  let error_log = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("Error occurred during operation"),
    None,
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("error-trace"),
    Some("error-span"),
    None
  )
  
  let fatal_log = azimuth::LogRecord::new_with_context(
    azimuth::Fatal,
    Some("Fatal error - system shutting down"),
    None,
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("error-trace"),
    Some("fatal-span"),
    None
  )
  
  // éªŒè¯é”™è¯¯çº§åˆ«æ—¥å¿—
  assert_eq(azimuth::LogRecord::severity_number(debug_log), azimuth::Debug)
  assert_eq(azimuth::LogRecord::severity_number(warn_log), azimuth::Warn)
  assert_eq(azimuth::LogRecord::severity_number(error_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::severity_number(fatal_log), azimuth::Fatal)
  
  // å‘é€é”™è¯¯æ—¥å¿—
  azimuth::Logger::emit(logger, debug_log)
  azimuth::Logger::emit(logger, warn_log)
  azimuth::Logger::emit(logger, error_log)
  azimuth::Logger::emit(logger, fatal_log)
  
  // ç»“æŸé”™è¯¯Span
  azimuth::Span::end(error_span)
  azimuth::Span::end(fatal_span)
}

// Test 6: Invalid Input Handling
pub test "æ— æ•ˆè¾“å…¥å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•æ— æ•ˆè¾“å…¥çš„å¤„ç†
  
  // æµ‹è¯•æ— æ•ˆçš„Spanä¸Šä¸‹æ–‡
  let invalid_trace_id = azimuth::SpanContext::new("", "valid-span", true, "")
  assert_false(azimuth::SpanContext::is_valid(invalid_trace_id))
  
  let invalid_span_id = azimuth::SpanContext::new("valid-trace", "", true, "")
  assert_false(azimuth::SpanContext::is_valid(invalid_span_id))
  
  let invalid_both = azimuth::SpanContext::new("", "", false, "")
  assert_false(azimuth::SpanContext::is_valid(invalid_both))
  assert_false(azimuth::SpanContext::is_sampled(invalid_both))
  
  // æµ‹è¯•æ— æ•ˆçš„HTTPè¯·æ±‚
  let invalid_request = azimuth::HttpRequest::new("", "", [], None)
  assert_eq(azimuth::HttpRequest::http_method(invalid_request), "")
  assert_eq(azimuth::HttpRequest::url(invalid_request), "")
  assert_eq(azimuth::HttpRequest::body(invalid_request), None)
  
  // æµ‹è¯•æ— æ•ˆçš„HTTPå“åº”
  let invalid_response = azimuth::HttpResponse::new(-1, [], None)
  assert_eq(azimuth::HttpResponse::status_code(invalid_response), -1)
  assert_eq(azimuth::HttpResponse::body(invalid_response), None)
  
  // æµ‹è¯•è¶…å‡ºèŒƒå›´çš„HTTPçŠ¶æ€ç 
  let too_high_status = azimuth::HttpResponse::new(999, [], None)
  assert_eq(azimuth::HttpResponse::status_code(too_high_status), 999)
  
  let negative_status = azimuth::HttpResponse::new(-100, [], None)
  assert_eq(azimuth::HttpResponse::status_code(negative_status), -100)
  
  // æµ‹è¯•ç©ºæ—¥å¿—è®°å½•
  let empty_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    None,
    None,
    None,
    None,
    None,
    None,
    None
  )
  
  // éªŒè¯ç©ºæ—¥å¿—è®°å½•
  assert_eq(azimuth::LogRecord::severity_number(empty_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::body(empty_log), None)
  assert_eq(azimuth::LogRecord::timestamp(empty_log), None)
  assert_eq(azimuth::LogRecord::trace_id(empty_log), None)
  assert_eq(azimuth::LogRecord::span_id(empty_log), None)
  
  // æµ‹è¯•æ— æ•ˆçš„æ—¶é—´æˆ³
  let negative_timestamp_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Log with negative timestamp"),
    None,
    Some(-1000L),
    None,
    Some("trace"),
    Some("span"),
    None
  )
  
  // éªŒè¯è´Ÿæ—¶é—´æˆ³æ—¥å¿—
  assert_eq(azimuth::LogRecord::timestamp(negative_timestamp_log), Some(-1000L))
}

// Test 7: Resource Exhaustion Scenarios
pub test "èµ„æºè€—å°½åœºæ™¯æµ‹è¯•" {
  // æµ‹è¯•èµ„æºè€—å°½åœºæ™¯
  
  // åˆ›å»ºå¤§é‡Span
  let tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "exhaustion-test")
  let many_spans = []
  
  // åˆ›å»ºå¤§é‡Spanç›´åˆ°èµ„æºè€—å°½
  for i in 0..1000 {
    let span = azimuth::Tracer::start_span(tracer, "exhaustion-span-" + i.to_string())
    many_spans.push(span)
  }
  
  // éªŒè¯æ‰€æœ‰Spanåˆ›å»ºæˆåŠŸ
  assert_true(many_spans.length() == 1000)
  
  // ç»“æŸæ‰€æœ‰Span
  for span in many_spans {
    azimuth::Span::end(span)
  }
  
  // åˆ›å»ºå¤§é‡åº¦é‡
  let meter = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "exhaustion-meter")
  let many_counters = []
  
  // åˆ›å»ºå¤§é‡Counter
  for i in 0..100 {
    let counter = azimuth::Meter::create_counter(meter, "exhaustion-counter-" + i.to_string())
    many_counters.push(counter)
  }
  
  // éªŒè¯æ‰€æœ‰Counteråˆ›å»ºæˆåŠŸ
  assert_true(many_counters.length() == 100)
  
  // åˆ›å»ºå¤§é‡æ—¥å¿—è®°å½•
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "exhaustion-logger")
  let many_logs = []
  
  // åˆ›å»ºå¤§é‡æ—¥å¿—è®°å½•
  for i in 0..500 {
    let log_record = azimuth::LogRecord::new_with_context(
      azimuth::Info,
      Some("Exhaustion log " + i.to_string()),
      None,
      Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
      None,
      Some("exhaustion-trace-" + (i % 10).to_string()),
      Some("exhaustion-span-" + i.to_string()),
      None
    )
    many_logs.push(log_record)
  }
  
  // éªŒè¯æ‰€æœ‰æ—¥å¿—è®°å½•åˆ›å»ºæˆåŠŸ
  assert_true(many_logs.length() == 500)
  
  // å‘é€æ‰€æœ‰æ—¥å¿—è®°å½•
  for log_record in many_logs {
    azimuth::Logger::emit(logger, log_record)
  }
}

// Test 8: Network Failure and Timeout Scenarios
pub test "ç½‘ç»œæ•…éšœå’Œè¶…æ—¶åœºæ™¯æµ‹è¯•" {
  // æµ‹è¯•ç½‘ç»œæ•…éšœå’Œè¶…æ—¶åœºæ™¯
  
  // æ¨¡æ‹Ÿç½‘ç»œæ•…éšœçš„HTTPè¯·æ±‚
  let client = azimuth::HttpClient::new()
  
  // åˆ›å»ºè¶…æ—¶è¯·æ±‚
  let timeout_request = azimuth::HttpRequest::new(
    "GET", 
    "https://timeout.example.com/slow-endpoint", 
    [("Timeout", "1000")], 
    None
  )
  
  // éªŒè¯è¶…æ—¶è¯·æ±‚
  assert_eq(azimuth::HttpRequest::http_method(timeout_request), "GET")
  assert_eq(azimuth::HttpRequest::url(timeout_request), "https://timeout.example.com/slow-endpoint")
  
  // æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯å“åº”
  let network_error_response = azimuth::HttpResponse::new(0, [], Some("Network error"))
  let timeout_response = azimuth::HttpResponse::new(408, [], Some("Request timeout"))
  let service_unavailable_response = azimuth::HttpResponse::new(503, [], Some("Service unavailable"))
  
  // éªŒè¯é”™è¯¯å“åº”
  assert_eq(azimuth::HttpResponse::status_code(network_error_response), 0)
  assert_eq(azimuth::HttpResponse::body(network_error_response), Some("Network error"))
  
  assert_eq(azimuth::HttpResponse::status_code(timeout_response), 408)
  assert_eq(azimuth::HttpResponse::body(timeout_response), Some("Request timeout"))
  
  assert_eq(azimuth::HttpResponse::status_code(service_unavailable_response), 503)
  assert_eq(azimuth::HttpResponse::body(service_unavailable_response), Some("Service unavailable"))
  
  // åˆ›å»ºç½‘ç»œæ•…éšœæ—¥å¿—
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "network-test")
  
  let network_error_log = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("Network error occurred while connecting to external service"),
    Some(azimuth::Attributes::new()),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("network-error-trace"),
    Some("network-error-span"),
    None
  )
  
  let timeout_log = azimuth::LogRecord::new_with_context(
    azimuth::Warn,
    Some("Request timed out after 1000ms"),
    Some(azimuth::Attributes::new()),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("timeout-trace"),
    Some("timeout-span"),
    None
  )
  
  // éªŒè¯ç½‘ç»œæ•…éšœæ—¥å¿—
  assert_eq(azimuth::LogRecord::severity_number(network_error_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::body(network_error_log), Some("Network error occurred while connecting to external service"))
  
  assert_eq(azimuth::LogRecord::severity_number(timeout_log), azimuth::Warn)
  assert_eq(azimuth::LogRecord::body(timeout_log), Some("Request timed out after 1000ms"))
  
  // å‘é€ç½‘ç»œæ•…éšœæ—¥å¿—
  azimuth::Logger::emit(logger, network_error_log)
  azimuth::Logger::emit(logger, timeout_log)
  
  // åˆ›å»ºç½‘ç»œæ•…éšœSpan
  let tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "network-test")
  let network_error_span = azimuth::Tracer::start_span(tracer, "network-request")
  
  // æ·»åŠ ç½‘ç»œé”™è¯¯äº‹ä»¶
  azimuth::Span::add_event(network_error_span, "network.error", Some([
    ("error.type", azimuth::StringValue("ConnectionTimeout")),
    ("error.message", azimuth::StringValue("Failed to connect to external service")),
    ("error.retry.count", azimuth::IntValue(3)),
    ("error.timeout.ms", azimuth::IntValue(1000))
  ]))
  
  // è®¾ç½®é”™è¯¯çŠ¶æ€
  azimuth::Span::set_status(network_error_span, azimuth::Error)
  
  // éªŒè¯ç½‘ç»œé”™è¯¯Span
  assert_eq(azimuth::Span::name(network_error_span), "network-request")
  assert_eq(azimuth::Span::status(network_error_span), azimuth::Unset)  // ç®€åŒ–å®ç°è¿”å›Unset
  
  // ç»“æŸç½‘ç»œé”™è¯¯Span
  azimuth::Span::end(network_error_span)
}

// Test 9: Memory and Resource Leak Scenarios
pub test "å†…å­˜å’Œèµ„æºæ³„æ¼åœºæ™¯æµ‹è¯•" {
  // æµ‹è¯•å†…å­˜å’Œèµ„æºæ³„æ¼åœºæ™¯
  
  // åˆ›å»ºå’Œé”€æ¯å¤§é‡å¯¹è±¡ä»¥æµ‹è¯•å†…å­˜æ³„æ¼
  for iteration in 0..10 {
    // åˆ›å»ºå¤§é‡Span
    let tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "leak-test-" + iteration.to_string())
    let spans = []
    
    for i in 0..100 {
      let span = azimuth::Tracer::start_span(tracer, "leak-span-" + i.to_string())
      spans.push(span)
    }
    
    // ç»“æŸæ‰€æœ‰Span
    for span in spans {
      azimuth::Span::end(span)
    }
    
    // åˆ›å»ºå¤§é‡åº¦é‡
    let meter = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "leak-meter-" + iteration.to_string())
    let counters = []
    let histograms = []
    
    for i in 0..50 {
      let counter = azimuth::Meter::create_counter(meter, "leak-counter-" + i.to_string())
      let histogram = azimuth::Meter::create_histogram(meter, "leak-histogram-" + i.to_string())
      counters.push(counter)
      histograms.push(histogram)
      
      // è®°å½•åº¦é‡å€¼
      azimuth::Counter::add(counter, i.to_double())
      azimuth::Histogram::record(histogram, i.to_double() * 2.0)
    }
    
    // åˆ›å»ºå¤§é‡æ—¥å¿—è®°å½•
    let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "leak-logger-" + iteration.to_string())
    let logs = []
    
    for i in 0..200 {
      let log_record = azimuth::LogRecord::new_with_context(
        azimuth::Info,
        Some("Leak test log " + i.to_string()),
        Some(azimuth::Attributes::new()),
        Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
        None,
        Some("leak-trace-" + iteration.to_string()),
        Some("leak-span-" + i.to_string()),
        None
      )
      logs.push(log_record)
    }
    
    // å‘é€æ‰€æœ‰æ—¥å¿—
    for log_record in logs {
      azimuth::Logger::emit(logger, log_record)
    }
  }
  
  // æµ‹è¯•å¾ªç¯å¼•ç”¨åœºæ™¯
  let cyclic_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "cyclic-test")
  let parent_span = azimuth::Tracer::start_span(cyclic_tracer, "parent-span")
  let child_span = azimuth::Tracer::start_span(cyclic_tracer, "child-span")
  
  // æ·»åŠ ç›¸äº’å¼•ç”¨çš„äº‹ä»¶
  azimuth::Span::add_event(parent_span, "child.reference", Some([
    ("child.span.id", azimuth::StringValue("child-span-id"))
  ]))
  
  azimuth::Span::add_event(child_span, "parent.reference", Some([
    ("parent.span.id", azimuth::StringValue("parent-span-id"))
  ]))
  
  // ç»“æŸSpan
  azimuth::Span::end(child_span)
  azimuth::Span::end(parent_span)
  
  // æµ‹è¯•å¤§å‹å¯¹è±¡åˆ›å»ºå’Œé”€æ¯
  let large_attrs = azimuth::Attributes::new()
  
  // åˆ›å»ºå¤§å‹å±æ€§é›†åˆ
  for i in 0..1000 {
    azimuth::Attributes::set(large_attrs, "large.key." + i.to_string(), azimuth::StringValue("large.value." + i.to_string()))
  }
  
  // åˆ›å»ºå¤§å‹Baggage
  let large_baggage = azimuth::Baggage::new()
  
  for i in 0..500 {
    let large_baggage = azimuth::Baggage::set_entry(large_baggage, "large.entry." + i.to_string(), "large.value." + i.to_string())
  }
  
  // åˆ›å»ºå¤§å‹èµ„æº
  let large_resource_attrs = []
  
  for i in 0..200 {
    large_resource_attrs.push(("large.resource.attr." + i.to_string(), azimuth::StringValue("large.resource.value." + i.to_string())))
  }
  
  let large_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), large_resource_attrs)
  
  // é‡æ–°åˆ›å»ºå¯¹è±¡ä»¥æµ‹è¯•èµ„æºé‡Šæ”¾
  let new_attrs = azimuth::Attributes::new()
  let new_baggage = azimuth::Baggage::new()
  let new_resource = azimuth::Resource::new()
  
  // éªŒè¯æ–°å¯¹è±¡åˆ›å»ºæˆåŠŸ
  assert_true(new_attrs.values.length() == 0)
  assert_true(new_baggage.entries.length() == 0)
  assert_true(new_resource.attributes.length() == 0)
}

// Test 10: Data Corruption and Integrity Validation
pub test "æ•°æ®æŸåå’Œå®Œæ•´æ€§éªŒè¯æµ‹è¯•" {
  // æµ‹è¯•æ•°æ®æŸåå’Œå®Œæ•´æ€§éªŒè¯
  
  // åˆ›å»ºæµ‹è¯•æ•°æ®
  let original_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(original_attrs, "test.key", azimuth::StringValue("original.value"))
  azimuth::Attributes::set(original_attrs, "test.int", azimuth::IntValue(42))
  azimuth::Attributes::set(original_attrs, "test.float", azimuth::FloatValue(3.14159))
  
  // éªŒè¯åŸå§‹æ•°æ®
  let original_string_val = azimuth::Attributes::get(original_attrs, "test.key")
  let original_int_val = azimuth::Attributes::get(original_attrs, "test.int")
  let original_float_val = azimuth::Attributes::get(original_attrs, "test.float")
  
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  assert_eq(original_string_val, Some(azimuth::StringValue("test_value")))
  assert_eq(original_int_val, Some(azimuth::IntValue(42)))
  
  // æµ‹è¯•æ•°æ®æˆªæ–­åœºæ™¯
  let truncated_trace_id = "12345"  // æˆªæ–­çš„trace ID
  let truncated_span_id = "67890"   // æˆªæ–­çš„span ID
  
  let truncated_span_ctx = azimuth::SpanContext::new(truncated_trace_id, truncated_span_id, true, "")
  
  // éªŒè¯æˆªæ–­çš„Spanä¸Šä¸‹æ–‡
  assert_eq(azimuth::SpanContext::trace_id(truncated_span_ctx), "12345")
  assert_eq(azimuth::SpanContext::span_id(truncated_span_ctx), "67890")
  assert_true(azimuth::SpanContext::is_sampled(truncated_span_ctx))
  
  // æµ‹è¯•æ•°æ®æ ¼å¼é”™è¯¯åœºæ™¯
  let malformed_trace_id = "not-a-valid-trace-id!"
  let malformed_span_id = "not-a-valid-span-id@"
  
  let malformed_span_ctx = azimuth::SpanContext::new(malformed_trace_id, malformed_span_id, true, "")
  
  // éªŒè¯æ ¼å¼é”™è¯¯çš„Spanä¸Šä¸‹æ–‡
  assert_eq(azimuth::SpanContext::trace_id(malformed_span_ctx), "not-a-valid-trace-id!")
  assert_eq(azimuth::SpanContext::span_id(malformed_span_ctx), "not-a-valid-span-id@")
  assert_true(azimuth::SpanContext::is_sampled(malformed_span_ctx))
  
  // æµ‹è¯•æ•°æ®ä¸ä¸€è‡´åœºæ™¯
  let inconsistent_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Inconsistent log data"),
    None,
    Some(1000L),  // è¾ƒæ—©çš„æ—¶é—´æˆ³
    Some(500L),   // è¾ƒæ™šçš„è§‚å¯Ÿæ—¶é—´æˆ³ï¼ˆä¸ä¸€è‡´ï¼‰
    Some("trace-123"),
    Some("span-456"),
    None
  )
  
  // éªŒè¯ä¸ä¸€è‡´çš„æ—¥å¿—æ•°æ®
  assert_eq(azimuth::LogRecord::timestamp(inconsistent_log), Some(1000L))
  assert_eq(azimuth::LogRecord::observed_timestamp(inconsistent_log), Some(500L))
  assert_eq(azimuth::LogRecord::trace_id(inconsistent_log), Some("trace-123"))
  assert_eq(azimuth::LogRecord::span_id(inconsistent_log), Some("span-456"))
  
  // æµ‹è¯•æ•°æ®å®Œæ•´æ€§éªŒè¯
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "integrity-test")
  
  // åˆ›å»ºå®Œæ•´æ€§æ£€æŸ¥æ—¥å¿—
  let integrity_check_log = azimuth::LogRecord::new_with_context(
    azimuth::Warn,
    Some("Data integrity check failed"),
    Some(azimuth::Attributes::new()),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("integrity-check-trace"),
    Some("integrity-check-span"),
    None
  )
  
  // éªŒè¯å®Œæ•´æ€§æ£€æŸ¥æ—¥å¿—
  assert_eq(azimuth::LogRecord::severity_number(integrity_check_log), azimuth::Warn)
  assert_eq(azimuth::LogRecord::body(integrity_check_log), Some("Data integrity check failed"))
  
  // å‘é€å®Œæ•´æ€§æ£€æŸ¥æ—¥å¿—
  azimuth::Logger::emit(logger, integrity_check_log)
  
  // æµ‹è¯•æ•°æ®æ¢å¤åœºæ™¯
  let recovery_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "recovery-test")
  let recovery_span = azimuth::Tracer::start_span(recovery_tracer, "data-recovery")
  
  // æ·»åŠ æ•°æ®æ¢å¤äº‹ä»¶
  azimuth::Span::add_event(recovery_span, "data.recovery.started", Some([
    ("recovery.type", azimuth::StringValue("automatic")),
    ("recovery.source", azimuth::StringValue("backup")),
    ("recovery.timestamp", azimuth::IntValue(azimuth::Clock::now_unix_nanos(azimuth::Clock::system()).to_int()))
  ]))
  
  azimuth::Span::add_event(recovery_span, "data.recovery.completed", Some([
    ("recovery.status", azimuth::StringValue("success")),
    ("recovery.records.count", azimuth::IntValue(1000)),
    ("recovery.duration.ms", azimuth::IntValue(5000))
  ]))
  
  // è®¾ç½®æ¢å¤çŠ¶æ€
  azimuth::Span::set_status(recovery_span, azimuth::Ok)
  
  // éªŒè¯æ¢å¤Span
  assert_eq(azimuth::Span::name(recovery_span), "data-recovery")
  assert_eq(azimuth::Span::status(recovery_span), azimuth::Unset)  // ç®€åŒ–å®ç°è¿”å›Unset
  
  // ç»“æŸæ¢å¤Span
  azimuth::Span::end(recovery_span)
}
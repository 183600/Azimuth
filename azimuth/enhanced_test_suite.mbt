// Enhanced Test Suite for Azimuth Telemetry System
// Advanced test cases covering various scenarios

import "azimuth/azimuth"

// Test 1: Concurrency Safety Test
pub test "å¹¶å‘å®‰å…¨æµ‹è¯•" {
  // æµ‹è¯•å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„Spanæ“ä½œå®‰å…¨æ€§
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "concurrency-test")
  
  // åˆ›å»ºå¤šä¸ªSpan
  let spans = []
  for i in 0..50 {
    let span = azimuth::Tracer::start_span(tracer, "concurrent-span-" + i.to_string())
    spans.push(span)
  }
  
  // å¹¶å‘æ“ä½œSpan
  for span in spans {
    azimuth::Span::add_event(span, "concurrent.event", Some([
      ("thread.id", azimuth::StringValue("thread-" + spans.length().to_string())),
      ("timestamp", azimuth::IntValue(azimuth::Clock::now_unix_nanos(azimuth::Clock::system()).to_int()))
    ]))
    azimuth::Span::set_status(span, azimuth::Ok)
  }
  
  // éªŒè¯æ‰€æœ‰Spanåˆ›å»ºæˆåŠŸ
  assert_true(spans.length() == 50)
  
  // ç»“æŸæ‰€æœ‰Span
  for span in spans {
    azimuth::Span::end(span)
  }
  
  // æµ‹è¯•åº¦é‡å¹¶å‘æ“ä½œ
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "concurrency-meter")
  let counter = azimuth::Meter::create_counter(meter, "concurrent.operations")
  let histogram = azimuth::Meter::create_histogram(meter, "concurrent.latency")
  
  // å¹¶å‘æ›´æ–°åº¦é‡
  for i in 0..100 {
    azimuth::Counter::add(counter, 1.0)
    azimuth::Histogram::record(histogram, i.to_double())
  }
  
  // æµ‹è¯•æ—¥å¿—å¹¶å‘æ“ä½œ
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "concurrency-logger")
  
  for i in 0..30 {
    let log_record = azimuth::LogRecord::new_with_context(
      azimuth::Info,
      Some("Concurrent log " + i.to_string()),
      Some(azimuth::Attributes::new()),
      Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
      None,
      Some("concurrent-trace"),
      Some("concurrent-span"),
      Some(azimuth::Context::root())
    )
    azimuth::Logger::emit(logger, log_record)
  }
}

// Test 2: Error Handling and Boundary Conditions
pub test "é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  // æµ‹è¯•ç©ºå€¼å’Œnullå¤„ç†
  let empty_attrs = azimuth::Attributes::new()
  assert_eq(azimuth::Attributes::get(empty_attrs, ""), None)
  assert_eq(azimuth::Attributes::get(empty_attrs, "nonexistent"), None)
  
  // æµ‹è¯•æå€¼å±æ€§
  let extreme_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(extreme_attrs, "max.int", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(extreme_attrs, "min.int", azimuth::IntValue(-2147483648))
  azimuth::Attributes::set(extreme_attrs, "max.float", azimuth::FloatValue(1.7976931348623157e+308))
  azimuth::Attributes::set(extreme_attrs, "min.float", azimuth::FloatValue(-1.7976931348623157e+308))
  azimuth::Attributes::set(extreme_attrs, "zero.float", azimuth::FloatValue(0.0))
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²å’Œç‰¹æ®Šå­—ç¬¦
  let special_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(special_attrs, "empty.string", azimuth::StringValue(""))
  azimuth::Attributes::set(special_attrs, "unicode.string", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€emoji"))
  azimuth::Attributes::set(special_attrs, "special.chars", azimuth::StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
  
  // æµ‹è¯•è¾¹ç•ŒSpanä¸Šä¸‹æ–‡
  let empty_trace_ctx = azimuth::SpanContext::new("", "span123", true, "")
  assert_false(azimuth::SpanContext::is_valid(empty_trace_ctx))
  
  let empty_span_ctx = azimuth::SpanContext::new("trace123", "", true, "")
  assert_false(azimuth::SpanContext::is_valid(empty_span_ctx))
  
  let both_empty_ctx = azimuth::SpanContext::new("", "", false, "")
  assert_false(azimuth::SpanContext::is_valid(both_empty_ctx))
  assert_false(azimuth::SpanContext::is_sampled(both_empty_ctx))
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡é”®çš„è¾¹ç•Œæƒ…å†µ
  let empty_key = azimuth::ContextKey::new("")
  let very_long_key = azimuth::ContextKey::new("this.is.a.very.long.key.name.that.exceeds.normal.expectations.and.tests.boundary.conditions")
  
  let root_ctx = azimuth::Context::root()
  let ctx_with_empty_key = azimuth::Context::with_value(root_ctx, empty_key, "empty.value")
  let ctx_with_long_key = azimuth::Context::with_value(root_ctx, very_long_key, "long.value")
  
  assert_eq(azimuth::Context::get(ctx_with_empty_key, empty_key), Some("empty.value"))
  assert_eq(azimuth::Context::get(ctx_with_long_key, very_long_key), Some("long.value"))
}

// Test 3: Performance Benchmark Test
pub test "æ€§èƒ½åŸºå‡†æµ‹è¯•" {
  // æµ‹è¯•å¤§é‡Spanåˆ›å»ºå’Œæ“ä½œçš„æ€§èƒ½
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "performance-test")
  
  let start_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  // åˆ›å»ºå¤§é‡Span
  let spans = []
  for i in 0..100 {
    let span = azimuth::Tracer::start_span(tracer, "perf-span-" + i.to_string())
    spans.push(span)
  }
  
  // æ‰¹é‡æ“ä½œSpan
  for span in spans {
    azimuth::Span::add_event(span, "performance.event", Some([("iteration", azimuth::StringValue("test"))]))
    azimuth::Span::set_status(span, azimuth::Ok)
  }
  
  // æ‰¹é‡ç»“æŸSpan
  for span in spans {
    azimuth::Span::end(span)
  }
  
  let end_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let duration = end_time - start_time
  
  // éªŒè¯æ€§èƒ½åœ¨åˆç†èŒƒå›´å†…
  assert_true(duration < 10000000000L)  // å°äº10ç§’
  assert_true(spans.length() == 100)
  
  // æµ‹è¯•åº¦é‡æ“ä½œæ€§èƒ½
  let meter_start = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "perf-meter")
  let counter = azimuth::Meter::create_counter(meter, "perf-counter")
  let histogram = azimuth::Meter::create_histogram(meter, "perf-histogram")
  
  // å¤§é‡åº¦é‡æ“ä½œ
  for i in 0..500 {
    azimuth::Counter::add(counter, 1.0)
    azimuth::Histogram::record(histogram, i.to_double())
  }
  
  let meter_end = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let meter_duration = meter_end - meter_start
  
  assert_true(meter_duration < 5000000000L)  // å°äº5ç§’
}

// Test 4: Cross-Service Consistency Test
pub test "è·¨æœåŠ¡ä¸€è‡´æ€§æµ‹è¯•" {
  // æ¨¡æ‹Ÿè·¨æœåŠ¡çš„åˆ†å¸ƒå¼è¿½è¸ªåœºæ™¯
  let service_a_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-a")
  let service_b_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-b")
  let service_c_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-c")
  
  // æœåŠ¡Aåˆ›å»ºæ ¹Span
  let root_span_ctx = azimuth::SpanContext::new("trace-12345", "span-a-root", true, "test-state")
  let root_span = azimuth::Span::new("service-a-operation", azimuth::Server, root_span_ctx)
  
  // æœåŠ¡Aè°ƒç”¨æœåŠ¡B
  let span_b_ctx = azimuth::SpanContext::new("trace-12345", "span-b-child", true, "test-state")
  let span_b = azimuth::Span::new("service-b-operation", azimuth::Server, span_b_ctx)
  
  // æœåŠ¡Bè°ƒç”¨æœåŠ¡C
  let span_c_ctx = azimuth::SpanContext::new("trace-12345", "span-c-grandchild", true, "test-state")
  let span_c = azimuth::Span::new("service-c-operation", azimuth::Internal, span_c_ctx)
  
  // éªŒè¯Trace IDä¸€è‡´æ€§
  assert_eq(azimuth::SpanContext::trace_id(root_span_ctx), "trace-12345")
  assert_eq(azimuth::SpanContext::trace_id(span_b_ctx), "trace-12345")
  assert_eq(azimuth::SpanContext::trace_id(span_c_ctx), "trace-12345")
  
  // éªŒè¯Span IDå”¯ä¸€æ€§
  assert_true(azimuth::SpanContext::span_id(root_span_ctx) != azimuth::SpanContext::span_id(span_b_ctx))
  assert_true(azimuth::SpanContext::span_id(span_b_ctx) != azimuth::SpanContext::span_id(span_c_ctx))
  assert_true(azimuth::SpanContext::span_id(root_span_ctx) != azimuth::SpanContext::span_id(span_c_ctx))
  
  // æµ‹è¯•è·¨æœåŠ¡Baggageä¼ æ’­
  let baggage_a = azimuth::Baggage::new()
  let baggage_b = azimuth::Baggage::set_entry(baggage_a, "user.id", "12345")
  let baggage_c = azimuth::Baggage::set_entry(baggage_b, "request.id", "req-67890")
  
  // éªŒè¯Baggageä¸€è‡´æ€§
  assert_eq(azimuth::Baggage::get_entry(baggage_b, "user.id"), Some("12345"))
  assert_eq(azimuth::Baggage::get_entry(baggage_c, "user.id"), Some("12345"))
  assert_eq(azimuth::Baggage::get_entry(baggage_c, "request.id"), Some("req-67890"))
}

// Test 5: Data Integrity and Serialization Test
pub test "æ•°æ®å®Œæ•´æ€§å’Œåºåˆ—åŒ–æµ‹è¯•" {
  // æµ‹è¯•å±æ€§å€¼çš„åºåˆ—åŒ–å…¼å®¹æ€§
  let test_attrs = azimuth::Attributes::new()
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§
  azimuth::Attributes::set(test_attrs, "string.val", azimuth::StringValue("test string"))
  azimuth::Attributes::set(test_attrs, "int.val", azimuth::IntValue(42))
  azimuth::Attributes::set(test_attrs, "float.val", azimuth::FloatValue(3.14159))
  azimuth::Attributes::set(test_attrs, "bool.val", azimuth::BoolValue(true))
  azimuth::Attributes::set(test_attrs, "array.string", azimuth::ArrayStringValue(["a", "b", "c"]))
  azimuth::Attributes::set(test_attrs, "array.int", azimuth::ArrayIntValue([1, 2, 3]))
  
  // éªŒè¯å±æ€§å€¼çš„å®Œæ•´æ€§
  let string_val = azimuth::Attributes::get(test_attrs, "string.val")
  let int_val = azimuth::Attributes::get(test_attrs, "int.val")
  let float_val = azimuth::Attributes::get(test_attrs, "float.val")
  let bool_val = azimuth::Attributes::get(test_attrs, "bool.val")
  let array_string_val = azimuth::Attributes::get(test_attrs, "array.string")
  let array_int_val = azimuth::Attributes::get(test_attrs, "array.int")
  
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  assert_eq(string_val, Some(azimuth::StringValue("test_value")))
  assert_eq(int_val, Some(azimuth::IntValue(42)))
  
  // æµ‹è¯•Spanä¸Šä¸‹æ–‡çš„åºåˆ—åŒ–æ ¼å¼
  let span_ctx = azimuth::SpanContext::new("trace-123", "span-456", true, "key1=value1,key2=value2")
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡å­—æ®µ
  assert_eq(azimuth::SpanContext::trace_id(span_ctx), "trace-123")
  assert_eq(azimuth::SpanContext::span_id(span_ctx), "span-456")
  assert_true(azimuth::SpanContext::is_sampled(span_ctx))
  
  // æµ‹è¯•Resourceçš„åºåˆ—åŒ–å…¼å®¹æ€§
  let resource_attrs = [
    ("service.name", azimuth::StringValue("test-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.instance.id", azimuth::StringValue("instance-123")),
    ("deployment.environment", azimuth::StringValue("test")),
    ("host.name", azimuth::StringValue("test-host"))
  ]
  
  let resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), resource_attrs)
  
  // éªŒè¯Resourceå±æ€§å®Œæ•´æ€§
  assert_eq(azimuth::Resource::get_attribute(resource, "service.name"), Some(azimuth::StringValue("test-service")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.instance.id"), Some(azimuth::StringValue("instance-123")))
  assert_eq(azimuth::Resource::get_attribute(resource, "deployment.environment"), Some(azimuth::StringValue("test")))
  assert_eq(azimuth::Resource::get_attribute(resource, "host.name"), Some(azimuth::StringValue("test-host")))
}

// Test 6: Time Series and Temporal Operations Test
pub test "æ—¶é—´åºåˆ—å’Œæ—¶åºæ“ä½œæµ‹è¯•" {
  // æµ‹è¯•æ—¶é—´æˆ³ç”Ÿæˆå’Œç²¾åº¦
  let clock = azimuth::Clock::system()
  let timestamp1 = azimuth::Clock::now_unix_nanos(clock)
  
  // éªŒè¯æ—¶é—´æˆ³æ ¼å¼ï¼ˆçº³ç§’çº§ç²¾åº¦ï¼‰
  assert_true(timestamp1 > 0L)
  assert_true(timestamp1.toString().length() >= 16)  // è‡³å°‘16ä½æ•°å­—
  
  // æµ‹è¯•æ—¶é—´æˆ³å•è°ƒé€’å¢
  let timestamp2 = azimuth::Clock::now_unix_nanos(clock)
  let timestamp3 = azimuth::Clock::now_unix_nanos(clock)
  
  assert_true(timestamp2 >= timestamp1)
  assert_true(timestamp3 >= timestamp2)
  
  // æµ‹è¯•æ—¶é—´å·®è®¡ç®—
  let time_diff1 = timestamp2 - timestamp1
  let time_diff2 = timestamp3 - timestamp2
  
  assert_true(time_diff1 >= 0L)
  assert_true(time_diff2 >= 0L)
  
  // æµ‹è¯•æ—¥å¿—è®°å½•çš„æ—¶é—´åºåˆ—
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "time-series-test")
  
  let log_timestamps = []
  let base_time = azimuth::Clock::now_unix_nanos(clock)
  
  // åˆ›å»ºæ—¶é—´åºåˆ—æ—¥å¿—
  for i in 0..10 {
    let log_time = base_time + (i * 1000000L)  // æ¯ä¸ªæ—¥å¿—é—´éš”1æ¯«ç§’
    let log_record = azimuth::LogRecord::new_with_context(
      azimuth::Info,
      Some("Time series log " + i.to_string()),
      Some(azimuth::Attributes::new()),
      Some(log_time),
      Some(log_time + 1000L),  // observed_timeç¨æ™š
      Some("time-series-trace"),
      Some("time-series-span"),
      Some(azimuth::Context::root())
    )
    log_timestamps.push(log_time)
    azimuth::Logger::emit(logger, log_record)
  }
  
  // éªŒè¯æ—¶é—´åºåˆ—çš„é¡ºåºæ€§
  for i in 1..log_timestamps.length() {
    assert_true(log_timestamps[i] > log_timestamps[i-1])
  }
  
  // æµ‹è¯•åº¦é‡æ—¶é—´åºåˆ—
  let meter = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "time-series-meter")
  let histogram = azimuth::Meter::create_histogram(meter, "response.time")
  
  let measurement_times = []
  let measurement_values = []
  
  // åˆ›å»ºæ—¶é—´åºåˆ—åº¦é‡
  for i in 0..20 {
    let measure_time = azimuth::Clock::now_unix_nanos(clock)
    let value = 100.0 + (i.to_double() * 10.0)  // é€’å¢çš„å“åº”æ—¶é—´
    
    azimuth::Histogram::record(histogram, value)
    
    measurement_times.push(measure_time)
    measurement_values.push(value)
  }
  
  // éªŒè¯åº¦é‡æ—¶é—´åºåˆ—
  assert_true(measurement_times.length() == 20)
  assert_true(measurement_values.length() == 20)
  
  for i in 1..measurement_values.length() {
    assert_true(measurement_values[i] > measurement_values[i-1])
  }
}

// Test 7: Dynamic Configuration Updates Test
pub test "åŠ¨æ€é…ç½®æ›´æ–°æµ‹è¯•" {
  // æµ‹è¯•åŠ¨æ€é…ç½®æ›´æ–°åœºæ™¯
  let initial_provider = azimuth::TracerProvider::default()
  let initial_tracer = azimuth::TracerProvider::get_tracer(initial_provider, "initial-service")
  let initial_span = azimuth::Tracer::start_span(initial_tracer, "initial-operation")
  
  // éªŒè¯åˆå§‹é…ç½®
  assert_eq(azimuth::Span::name(initial_span), "initial-operation")
  assert_eq(azimuth::Span::kind(initial_span), azimuth::Internal)
  
  // æ¨¡æ‹Ÿé…ç½®æ›´æ–° - åˆ›å»ºæ–°çš„TracerProvider
  let updated_provider = azimuth::TracerProvider::default()
  let updated_tracer = azimuth::TracerProvider::get_tracer(updated_provider, "updated-service", Some("2.0.0"))
  let updated_span = azimuth::Tracer::start_span(updated_tracer, "updated-operation")
  
  // éªŒè¯æ›´æ–°åçš„é…ç½®
  assert_eq(azimuth::Span::name(updated_span), "updated-operation")
  assert_eq(azimuth::Tracer::instrumentation_scope(updated_tracer).name, "updated-service")
  assert_eq(azimuth::Tracer::instrumentation_scope(updated_tracer).version, Some("2.0.0"))
  
  // æµ‹è¯•åº¦é‡é…ç½®åŠ¨æ€æ›´æ–°
  let initial_meter_provider = azimuth::MeterProvider::default()
  let initial_meter = azimuth::MeterProvider::get_meter(initial_meter_provider, "initial-meter")
  let initial_counter = azimuth::Meter::create_counter(initial_meter, "initial.counter", Some("Initial counter"), Some("count"))
  
  // éªŒè¯åˆå§‹åº¦é‡é…ç½®
  assert_eq(initial_counter.name, "initial.counter")
  assert_eq(initial_counter.description, Some("Initial counter"))
  assert_eq(initial_counter.unit, Some("count"))
  
  // æ¨¡æ‹Ÿåº¦é‡é…ç½®æ›´æ–°
  let updated_meter_provider = azimuth::MeterProvider::default()
  let updated_meter = azimuth::MeterProvider::get_meter(updated_meter_provider, "updated-meter", Some("2.0.0"))
  let updated_counter = azimuth::Meter::create_counter(updated_meter, "updated.counter", Some("Updated counter"), Some("items"))
  
  // éªŒè¯æ›´æ–°åçš„åº¦é‡é…ç½®
  assert_eq(updated_counter.name, "updated.counter")
  assert_eq(updated_counter.description, Some("Updated counter"))
  assert_eq(updated_counter.unit, Some("items"))
  
  // æµ‹è¯•èµ„æºé…ç½®åŠ¨æ€æ›´æ–°
  let initial_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("initial-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("config.source", azimuth::StringValue("static"))
  ])
  
  // éªŒè¯åˆå§‹èµ„æºé…ç½®
  assert_eq(azimuth::Resource::get_attribute(initial_resource, "service.name"), Some(azimuth::StringValue("initial-service")))
  assert_eq(azimuth::Resource::get_attribute(initial_resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(initial_resource, "config.source"), Some(azimuth::StringValue("static")))
  
  // æ¨¡æ‹Ÿèµ„æºé…ç½®æ›´æ–°
  let updated_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("updated-service")),
    ("service.version", azimuth::StringValue("2.0.0")),
    ("config.source", azimuth::StringValue("dynamic")),
    ("config.last.update", azimuth::StringValue("2025-12-28T00:00:00Z"))
  ])
  
  // éªŒè¯æ›´æ–°åçš„èµ„æºé…ç½®
  assert_eq(azimuth::Resource::get_attribute(updated_resource, "service.name"), Some(azimuth::StringValue("updated-service")))
  assert_eq(azimuth::Resource::get_attribute(updated_resource, "service.version"), Some(azimuth::StringValue("2.0.0")))
  assert_eq(azimuth::Resource::get_attribute(updated_resource, "config.source"), Some(azimuth::StringValue("dynamic")))
  assert_eq(azimuth::Resource::get_attribute(updated_resource, "config.last.update"), Some(azimuth::StringValue("2025-12-28T00:00:00Z")))
}

// Test 8: Resource Management and Merge Strategy Test
pub test "èµ„æºç®¡ç†å’Œåˆå¹¶ç­–ç•¥æµ‹è¯•" {
  // æµ‹è¯•åŸºç¡€èµ„æºæ“ä½œ
  let base_resource = azimuth::Resource::new()
  let base_attrs = [
    ("service.name", azimuth::StringValue("base-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("environment", azimuth::StringValue("development"))
  ]
  let resource_with_base = azimuth::Resource::with_attributes(base_resource, base_attrs)
  
  // éªŒè¯åŸºç¡€èµ„æºå±æ€§
  assert_eq(azimuth::Resource::get_attribute(resource_with_base, "service.name"), Some(azimuth::StringValue("base-service")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_base, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_base, "environment"), Some(azimuth::StringValue("development")))
  
  // æµ‹è¯•èµ„æºè¦†ç›–å’Œåˆå¹¶
  let override_attrs = [
    ("service.name", azimuth::StringValue("override-service")),  // è¦†ç›–ç°æœ‰å±æ€§
    ("deployment.region", azimuth::StringValue("us-west-1")),    // æ·»åŠ æ–°å±æ€§
    ("service.instance.id", azimuth::StringValue("instance-456"))
  ]
  let override_resource = azimuth::Resource::with_attributes(base_resource, override_attrs)
  
  // åˆå¹¶èµ„æº
  let merged_resource = azimuth::Resource::merge(resource_with_base, override_resource)
  
  // éªŒè¯åˆå¹¶ç»“æœï¼ˆåŸºäºç®€åŒ–å®ç°ï¼Œåº”è¯¥è¦†ç›–ä¸ºoverride_resourceçš„å±æ€§ï¼‰
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.name"), Some(azimuth::StringValue("override-service")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "deployment.region"), Some(azimuth::StringValue("us-west-1")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.instance.id"), Some(azimuth::StringValue("instance-456")))
  
  // æµ‹è¯•å¤šçº§èµ„æºåˆå¹¶
  let env_resource = azimuth::Resource::with_attributes(base_resource, [
    ("environment", azimuth::StringValue("production")),
    ("cluster.name", azimuth::StringValue("prod-cluster")),
    ("monitoring.enabled", azimuth::BoolValue(true))
  ])
  
  let final_resource = azimuth::Resource::merge(merged_resource, env_resource)
  
  // éªŒè¯æœ€ç»ˆèµ„æºå±æ€§
  assert_eq(azimuth::Resource::get_attribute(final_resource, "environment"), Some(azimuth::StringValue("production")))
  assert_eq(azimuth::Resource::get_attribute(final_resource, "cluster.name"), Some(azimuth::StringValue("prod-cluster")))
  assert_eq(azimuth::Resource::get_attribute(final_resource, "monitoring.enabled"), Some(azimuth::BoolValue(true)))
}

// Test 9: Complex Propagation Scenarios Test
pub test "å¤æ‚ä¼ æ’­åœºæ™¯æµ‹è¯•" {
  // æµ‹è¯•å¤šçº§ä¼ æ’­å™¨ç»„åˆ
  let trace_propagator = azimuth::W3CTraceContextPropagator::new()
  let baggage_propagator = azimuth::W3CBaggagePropagator::new()
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨
  let propagators = [trace_propagator]
  let composite_propagator = azimuth::CompositePropagator::new(propagators)
  
  // æµ‹è¯•æ³¨å…¥æ“ä½œ
  let carrier = azimuth::TextMapCarrier::new()
  let ctx = azimuth::Context::root()
  
  azimuth::CompositePropagator::inject(composite_propagator, ctx, carrier)
  
  // éªŒè¯æ³¨å…¥ç»“æœ
  let trace_header = azimuth::TextMapCarrier::get(carrier, "traceparent")
  assert_eq(trace_header, Some("00-test-trace-id-test-span-id-01"))
  
  // æµ‹è¯•æå–æ“ä½œ
  let extracted_ctx = azimuth::CompositePropagator::extract(composite_propagator, carrier)
  let extracted_key = azimuth::ContextKey::new("extracted")
  let extracted_value = azimuth::Context::get(extracted_ctx, extracted_key)
  assert_eq(extracted_value, Some("true"))
  
  // æµ‹è¯•Baggageä¼ æ’­
  let baggage = azimuth::Baggage::new()
  let baggage_with_entries = azimuth::Baggage::set_entry(baggage, "user.id", "12345")
  let final_baggage = azimuth::Baggage::set_entry(baggage_with_entries, "request.id", "req-67890")
  let baggage_with_auth = azimuth::Baggage::set_entry(final_baggage, "auth.token", "token-abc123")
  
  // éªŒè¯Baggageæ¡ç›®
  assert_eq(azimuth::Baggage::get_entry(baggage_with_entries, "user.id"), Some("12345"))
  assert_eq(azimuth::Baggage::get_entry(final_baggage, "user.id"), Some("12345"))
  assert_eq(azimuth::Baggage::get_entry(final_baggage, "request.id"), Some("req-67890"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_auth, "auth.token"), Some("token-abc123"))
  
  // æµ‹è¯•Baggageç§»é™¤æ“ä½œ
  let baggage_after_removal = azimuth::Baggage::remove_entry(baggage_with_auth, "auth.token")
  // åŸºäºç®€åŒ–å®ç°ï¼Œç§»é™¤æ“ä½œå¯èƒ½ä¸ä¼šå®é™…ç§»é™¤ï¼Œä½†æµ‹è¯•è°ƒç”¨ä¸ä¼šå‡ºé”™
}

// Test 10: Advanced Metrics Operations Test
pub test "é«˜çº§åº¦é‡æ“ä½œæµ‹è¯•" {
  // æµ‹è¯•å„ç§åº¦é‡ç±»å‹åˆ›å»ºå’Œæ“ä½œ
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "advanced-metrics", Some("1.0.0"))
  
  // åˆ›å»ºCounter
  let request_counter = azimuth::Meter::create_counter(meter, "http.requests.total", Some("Total HTTP requests"), Some("requests"))
  assert_eq(request_counter.name, "http.requests.total")
  assert_eq(request_counter.description, Some("Total HTTP requests"))
  assert_eq(request_counter.unit, Some("requests"))
  
  // åˆ›å»ºHistogram
  let response_histogram = azimuth::Meter::create_histogram(meter, "http.response.duration", Some("HTTP response duration"), Some("ms"))
  assert_eq(response_histogram.name, "http.response.duration")
  assert_eq(response_histogram.description, Some("HTTP response duration"))
  assert_eq(response_histogram.unit, Some("ms"))
  
  // åˆ›å»ºUpDownCounter
  let active_connections = azimuth::Meter::create_updown_counter(meter, "http.active.connections", Some("Active HTTP connections"), Some("connections"))
  assert_eq(active_connections.name, "http.active.connections")
  assert_eq(active_connections.description, Some("Active HTTP connections"))
  assert_eq(active_connections.unit, Some("connections"))
  
  // åˆ›å»ºGauge
  let memory_usage = azimuth::Meter::create_gauge(meter, "process.memory.usage", Some("Process memory usage"), Some("bytes"))
  assert_eq(memory_usage.name, "process.memory.usage")
  assert_eq(memory_usage.description, Some("Process memory usage"))
  assert_eq(memory_usage.unit, Some("bytes"))
  
  // æµ‹è¯•åº¦é‡æ“ä½œ
  azimuth::Counter::add(request_counter, 10.0)
  azimuth::Counter::add(request_counter, 5.0)
  
  azimuth::Histogram::record(response_histogram, 100.5)
  azimuth::Histogram::record(response_histogram, 200.3)
  azimuth::Histogram::record(response_histogram, 150.7)
  
  azimuth::UpDownCounter::add(active_connections, 5.0)
  azimuth::UpDownCounter::add(active_connections, -2.0)
  
  // æµ‹è¯•åº¦é‡è½¬æ¢ä¸ºInstrumentæ¥å£
  let counter_instrument = azimuth::Histogram::as_instrument(response_histogram)
  assert_eq(azimuth::Instrument::name(counter_instrument), "http.response.duration")
  assert_eq(azimuth::Instrument::description(counter_instrument), Some("HTTP response duration"))
  assert_eq(azimuth::Instrument::unit(counter_instrument), Some("ms"))
  
  // æµ‹è¯•å¸¦å±æ€§çš„åº¦é‡æ“ä½œ
  let error_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(error_attrs, "status.code", azimuth::IntValue(500))
  azimuth::Attributes::set(error_attrs, "error.type", azimuth::StringValue("internal"))
  
  let success_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(success_attrs, "status.code", azimuth::IntValue(200))
  azimuth::Attributes::set(success_attrs, "endpoint", azimuth::StringValue("/api/data"))
  
  // åŸºäºç®€åŒ–å®ç°ï¼Œè¿™äº›å±æ€§å¯èƒ½ä¸ä¼šå®é™…å­˜å‚¨ï¼Œä½†æµ‹è¯•è°ƒç”¨ä¸ä¼šå‡ºé”™
  azimuth::Counter::add(request_counter, 1.0, Some(error_attrs))
  azimuth::Histogram::record(response_histogram, 50.0, Some(success_attrs))
}

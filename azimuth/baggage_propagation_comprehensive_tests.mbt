// Baggage Propagation Comprehensive Tests for Azimuth Telemetry System
// This file contains comprehensive test cases for baggage propagation functionality

test "baggage basic operations" {
  let baggage = Baggage::new()
  
  // Test setting single entry
  let updated_baggage = Baggage::set_entry(baggage, "user.id", "12345")
  assert_eq(Baggage::get_entry(updated_baggage, "user.id"), Some("12345"))
  
  // Test setting multiple entries
  let baggage_with_multiple = Baggage::set_entry(updated_baggage, "request.id", "req-67890")
  assert_eq(Baggage::get_entry(baggage_with_multiple, "user.id"), Some("12345"))
  assert_eq(Baggage::get_entry(baggage_with_multiple, "request.id"), Some("req-67890"))
  
  // Test getting non-existent entry
  let missing_entry = Baggage::get_entry(baggage_with_multiple, "non.existent")
  assert_eq(missing_entry, None)
}

test "baggage entry removal" {
  let baggage = Baggage::new()
  
  // Set up multiple entries
  let baggage1 = Baggage::set_entry(baggage, "entry1", "value1")
  let baggage2 = Baggage::set_entry(baggage1, "entry2", "value2")
  let baggage3 = Baggage::set_entry(baggage2, "entry3", "value3")
  
  // Verify all entries exist
  assert_eq(Baggage::get_entry(baggage3, "entry1"), Some("value1"))
  assert_eq(Baggage::get_entry(baggage3, "entry2"), Some("value2"))
  assert_eq(Baggage::get_entry(baggage3, "entry3"), Some("value3"))
  
  // Remove an entry
  let baggage_after_removal = Baggage::remove_entry(baggage3, "entry2")
  
  // Verify removal (in simplified implementation, this might not actually remove)
  // In a real implementation, entry2 should be None
  assert_eq(Baggage::get_entry(baggage_after_removal, "entry1"), Some("value1"))
  assert_eq(Baggage::get_entry(baggage_after_removal, "entry3"), Some("value3"))
}

test "baggage value types and formats" {
  let baggage = Baggage::new()
  
  // Test string values with various formats
  let baggage1 = Baggage::set_entry(baggage, "simple.value", "simple")
  let baggage2 = Baggage::set_entry(baggage1, "numeric.value", "12345")
  let baggage3 = Baggage::set_entry(baggage2, "decimal.value", "123.45")
  let baggage4 = Baggage::set_entry(baggage3, "boolean.value", "true")
  let baggage5 = Baggage::set_entry(baggage4, "json.value", "{\"key\":\"value\"}")
  let baggage6 = Baggage::set_entry(baggage5, "url.value", "https://example.com/path?param=value")
  
  assert_eq(Baggage::get_entry(baggage6, "simple.value"), Some("simple"))
  assert_eq(Baggage::get_entry(baggage6, "numeric.value"), Some("12345"))
  assert_eq(Baggage::get_entry(baggage6, "decimal.value"), Some("123.45"))
  assert_eq(Baggage::get_entry(baggage6, "boolean.value"), Some("true"))
  assert_eq(Baggage::get_entry(baggage6, "json.value"), Some("{\"key\":\"value\"}"))
  assert_eq(Baggage::get_entry(baggage6, "url.value"), Some("https://example.com/path?param=value"))
}

test "baggage special characters and encoding" {
  let baggage = Baggage::new()
  
  // Test values with special characters
  let baggage1 = Baggage::set_entry(baggage, "spaces.value", "value with spaces")
  let baggage2 = Baggage::set_entry(baggage1, "special.chars", "value!@#$%^&*()")
  let baggage3 = Baggage::set_entry(baggage2, "unicode.value", "æµ‹è¯•å€¼")
  let baggage4 = Baggage::set_entry(baggage3, "emoji.value", "ðŸš€ðŸŒŸ")
  let baggage5 = Baggage::set_entry(baggage4, "quotes.value", "\"quoted value\"")
  let baggage6 = Baggage::set_entry(baggage5, "equals.value", "key=value")
  
  assert_eq(Baggage::get_entry(baggage6, "spaces.value"), Some("value with spaces"))
  assert_eq(Baggage::get_entry(baggage6, "special.chars"), Some("value!@#$%^&*()"))
  assert_eq(Baggage::get_entry(baggage6, "unicode.value"), Some("æµ‹è¯•å€¼"))
  assert_eq(Baggage::get_entry(baggage6, "emoji.value"), Some("ðŸš€ðŸŒŸ"))
  assert_eq(Baggage::get_entry(baggage6, "quotes.value"), Some("\"quoted value\""))
  assert_eq(Baggage::get_entry(baggage6, "equals.value"), Some("key=value"))
}

test "baggage key naming conventions" {
  let baggage = Baggage::new()
  
  // Test various key naming patterns
  let baggage1 = Baggage::set_entry(baggage, "simple.key", "simple")
  let baggage2 = Baggage::set_entry(baggage1, "key.with.dots", "dots")
  let baggage3 = Baggage::set_entry(baggage2, "key-with-hyphens", "hyphens")
  let baggage4 = Baggage::set_entry(baggage3, "key_with_underscores", "underscores")
  let baggage5 = Baggage::set_entry(baggage4, "UPPERCASE.KEY", "uppercase")
  let baggage6 = Baggage::set_entry(baggage5, "mixedCase.Key", "mixedcase")
  let baggage7 = Baggage::set_entry(baggage6, "key123.with456.numbers789", "numbers")
  
  assert_eq(Baggage::get_entry(baggage7, "simple.key"), Some("simple"))
  assert_eq(Baggage::get_entry(baggage7, "key.with.dots"), Some("dots"))
  assert_eq(Baggage::get_entry(baggage7, "key-with-hyphens"), Some("hyphens"))
  assert_eq(Baggage::get_entry(baggage7, "key_with_underscores"), Some("underscores"))
  assert_eq(Baggage::get_entry(baggage7, "UPPERCASE.KEY"), Some("uppercase"))
  assert_eq(Baggage::get_entry(baggage7, "mixedCase.Key"), Some("mixedcase"))
  assert_eq(Baggage::get_entry(baggage7, "key123.with456.numbers789"), Some("numbers"))
}

test "baggage overwriting and updates" {
  let baggage = Baggage::new()
  
  // Set initial value
  let baggage1 = Baggage::set_entry(baggage, "update.test", "original")
  assert_eq(Baggage::get_entry(baggage1, "update.test"), Some("original"))
  
  // Overwrite with different value
  let baggage2 = Baggage::set_entry(baggage1, "update.test", "updated")
  assert_eq(Baggage::get_entry(baggage2, "update.test"), Some("updated"))
  
  // Overwrite multiple times
  let baggage3 = Baggage::set_entry(baggage2, "update.test", "third")
  let baggage4 = Baggage::set_entry(baggage3, "update.test", "fourth")
  let baggage5 = Baggage::set_entry(baggage4, "update.test", "final")
  
  assert_eq(Baggage::get_entry(baggage5, "update.test"), Some("final"))
}

test "baggage empty and boundary values" {
  let baggage = Baggage::new()
  
  // Test empty string values
  let baggage1 = Baggage::set_entry(baggage, "empty.value", "")
  assert_eq(Baggage::get_entry(baggage1, "empty.value"), Some(""))
  
  // Test whitespace-only values
  let baggage2 = Baggage::set_entry(baggage1, "whitespace.value", "   ")
  assert_eq(Baggage::get_entry(baggage2, "whitespace.value"), Some("   "))
  
  // Test very long values
  let long_value = "This is a very long baggage value that tests the system's ability to handle extended text content with various characters and punctuation marks! It includes numbers like 12345 and special characters @#$%^&*() and should be properly handled without issues."
  let baggage3 = Baggage::set_entry(baggage2, "long.value", long_value)
  assert_eq(Baggage::get_entry(baggage3, "long.value"), Some(long_value))
  
  // Test very long keys
  let long_key = "this.is.a.very.long.baggage.key.that.tests.the.systems.ability.to.handle.extended.key.names.with.multiple.segments"
  let baggage4 = Baggage::set_entry(baggage3, long_key, "long.key.value")
  assert_eq(Baggage::get_entry(baggage4, long_key), Some("long.key.value"))
}

test "baggage cross-service context simulation" {
  let baggage = Baggage::new()
  
  // Simulate service A setting baggage
  let service_a_baggage = Baggage::set_entry(baggage, "service.a.trace.id", "trace-12345")
  let service_a_baggage2 = Baggage::set_entry(service_a_baggage, "service.a.user.id", "user-67890")
  let service_a_baggage3 = Baggage::set_entry(service_a_baggage2, "service.a.request.id", "req-abc123")
  
  // Simulate service B adding to baggage
  let service_b_baggage = Baggage::set_entry(service_a_baggage3, "service.b.operation", "process.data")
  let service_b_baggage2 = Baggage::set_entry(service_b_baggage, "service.b.latency", "150ms")
  
  // Simulate service C adding to baggage
  let service_c_baggage = Baggage::set_entry(service_b_baggage2, "service.c.cache.hit", "true")
  let service_c_baggage2 = Baggage::set_entry(service_c_baggage, "service.c.db.queries", "3")
  
  // Verify all baggage entries are accessible
  assert_eq(Baggage::get_entry(service_c_baggage2, "service.a.trace.id"), Some("trace-12345"))
  assert_eq(Baggage::get_entry(service_c_baggage2, "service.a.user.id"), Some("user-67890"))
  assert_eq(Baggage::get_entry(service_c_baggage2, "service.a.request.id"), Some("req-abc123"))
  assert_eq(Baggage::get_entry(service_c_baggage2, "service.b.operation"), Some("process.data"))
  assert_eq(Baggage::get_entry(service_c_baggage2, "service.b.latency"), Some("150ms"))
  assert_eq(Baggage::get_entry(service_c_baggage2, "service.c.cache.hit"), Some("true"))
  assert_eq(Baggage::get_entry(service_c_baggage2, "service.c.db.queries"), Some("3"))
}

test "baggage context integration" {
  let baggage = Baggage::new()
  
  // Create baggage with trace context
  let trace_baggage = Baggage::set_entry(baggage, "trace.id", "0af7651916cd43dd8448eb211c80319c")
  let user_baggage = Baggage::set_entry(trace_baggage, "user.id", "12345")
  let request_baggage = Baggage::set_entry(user_baggage, "request.path", "/api/v1/data")
  let session_baggage = Baggage::set_entry(request_baggage, "session.id", "sess-abcdef")
  
  // Create context and integrate with baggage
  let ctx = Context::root()
  let trace_key = ContextKey::new("trace.id")
  let ctx_with_trace = Context::with_value(ctx, trace_key, "0af7651916cd43dd8448eb211c80319c")
  
  // Verify context and baggage work together
  let trace_from_context = Context::get(ctx_with_trace, trace_key)
  let trace_from_baggage = Baggage::get_entry(session_baggage, "trace.id")
  
  assert_eq(trace_from_context, Some("0af7651916cd43dd8448eb211c80319c"))
  assert_eq(trace_from_baggage, Some("0af7651916cd43dd8448eb211c80319c"))
  
  // Verify other baggage entries
  assert_eq(Baggage::get_entry(session_baggage, "user.id"), Some("12345"))
  assert_eq(Baggage::get_entry(session_baggage, "request.path"), Some("/api/v1/data"))
  assert_eq(Baggage::get_entry(session_baggage, "session.id"), Some("sess-abcdef"))
}
// Azimuth Telemetry System - Serialization and Internationalization Tests
// åºåˆ—åŒ–å’Œå›½é™…åŒ–æµ‹è¯•å¥—ä»¶

test "åºåˆ—åŒ–å’Œååºåˆ—åŒ–åŸºç¡€æµ‹è¯•" {
  // æµ‹è¯•SpanContextçš„åºåˆ—åŒ–æ ¼å¼
  let trace_id = "0af7651916cd43dd8448eb211c80319c"
  let span_id = "b7ad6b7169203331"
  let span_ctx = SpanContext::new(trace_id, span_id, true, "key1=value1,key2=value2")
  
  // éªŒè¯W3C Trace Contextæ ¼å¼
  // æ ¼å¼: version-trace_id-span_id-flags
  let expected_traceparent = "00-" + trace_id + "-" + span_id + "-01"
  
  // éªŒè¯å„ä¸ªéƒ¨åˆ†çš„æ ¼å¼
  assert_eq(trace_id.length(), 32) // 16 bytes hex
  assert_eq(span_id.length(), 16)  // 8 bytes hex
  
  // éªŒè¯åå…­è¿›åˆ¶å­—ç¬¦
  let trace_chars = trace_id.to_char_array()
  let span_chars = span_id.to_char_array()
  
  for char in trace_chars {
    let is_valid_hex = char >= '0' && char <= '9' || char >= 'a' && char <= 'f' || char >= 'A' && char <= 'F'
    assert_true(is_valid_hex)
  }
  
  for char in span_chars {
    let is_valid_hex = char >= '0' && char <= '9' || char >= 'a' && char <= 'f' || char >= 'A' && char <= 'F'
    assert_true(is_valid_hex)
  }
  
  // æµ‹è¯•TextMapCarrierçš„åºåˆ—åŒ–
  let carrier = TextMapCarrier::new()
  TextMapCarrier::set(carrier, "traceparent", expected_traceparent)
  TextMapCarrier::set(carrier, "baggage", "user=john,session=abc123")
  TextMapCarrier::set(carrier, "custom-header", "custom-value")
  
  // éªŒè¯åºåˆ—åŒ–åçš„æ•°æ®
  let retrieved_traceparent = TextMapCarrier::get(carrier, "traceparent")
  let retrieved_baggage = TextMapCarrier::get(carrier, "baggage")
  let retrieved_custom = TextMapCarrier::get(carrier, "custom-header")
  
  assert_eq(retrieved_traceparent, Some(expected_traceparent))
  assert_eq(retrieved_baggage, None) // ç®€åŒ–å®ç°åªè¿”å›traceparent
  assert_eq(retrieved_custom, None) // ç®€åŒ–å®ç°åªè¿”å›traceparent
}

test "å±æ€§å€¼çš„åºåˆ—åŒ–æµ‹è¯•" {
  // æµ‹è¯•å„ç§å±æ€§ç±»å‹çš„åºåˆ—åŒ–è¡¨ç¤º
  let string_attr = StringValue("test string")
  let int_attr = IntValue(42)
  let float_attr = FloatValue(3.14159)
  let bool_attr = BoolValue(true)
  let array_string_attr = ArrayStringValue(["a", "b", "c"])
  let array_int_attr = ArrayIntValue([1, 2, 3])
  
  // éªŒè¯å±æ€§å€¼çš„å†…éƒ¨è¡¨ç¤º
  match string_attr {
    StringValue(s) => assert_eq(s, "test string")
    _ => assert_true(false)
  }
  
  match int_attr {
    IntValue(i) => assert_eq(i, 42)
    _ => assert_true(false)
  }
  
  match float_attr {
    FloatValue(f) => assert_true(f > 3.14 && f < 3.142)
    _ => assert_true(false)
  }
  
  match bool_attr {
    BoolValue(b) => assert_true(b)
    _ => assert_true(false)
  }
  
  match array_string_attr {
    ArrayStringValue(arr) => {
      assert_eq(arr.length(), 3)
      assert_eq(arr[0], "a")
      assert_eq(arr[1], "b")
      assert_eq(arr[2], "c")
    }
    _ => assert_true(false)
  }
  
  match array_int_attr {
    ArrayIntValue(arr) => {
      assert_eq(arr.length(), 3)
      assert_eq(arr[0], 1)
      assert_eq(arr[1], 2)
      assert_eq(arr[2], 3)
    }
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ç‰¹æ®Šå€¼çš„åºåˆ—åŒ–
  let empty_string = StringValue("")
  let zero_int = IntValue(0)
  let zero_float = FloatValue(0.0)
  let false_bool = BoolValue(false)
  let empty_array_string = ArrayStringValue([])
  let empty_array_int = ArrayIntValue([])
  
  match empty_string {
    StringValue(s) => assert_eq(s, "")
    _ => assert_true(false)
  }
  
  match zero_int {
    IntValue(i) => assert_eq(i, 0)
    _ => assert_true(false)
  }
  
  match zero_float {
    FloatValue(f) => assert_eq(f, 0.0)
    _ => assert_true(false)
  }
  
  match false_bool {
    BoolValue(b) => assert_false(b)
    _ => assert_true(false)
  }
  
  match empty_array_string {
    ArrayStringValue(arr) => assert_eq(arr.length(), 0)
    _ => assert_true(false)
  }
  
  match empty_array_int {
    ArrayIntValue(arr) => assert_eq(arr.length(), 0)
    _ => assert_true(false)
  }
}

test "å¤šè¯­è¨€å’ŒUnicodeæ”¯æŒæµ‹è¯•" {
  // æµ‹è¯•ä¸­æ–‡å­—ç¬¦çš„å¤„ç†
  let chinese_text = "é¥æµ‹ç³»ç»Ÿæµ‹è¯•"
  let chinese_attr = StringValue(chinese_text)
  
  match chinese_attr {
    StringValue(s) => assert_eq(s, chinese_text)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•æ··åˆè¯­è¨€æ–‡æœ¬
  let mixed_text = "Azimuthé¥æµ‹Telemetryç³»ç»ŸSystem"
  let mixed_attr = StringValue(mixed_text)
  
  match mixed_attr {
    StringValue(s) => assert_eq(s, mixed_text)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•emojiå­—ç¬¦
  let emoji_text = "æµ‹è¯•ğŸŒŸé¥æµ‹ğŸš€ç³»ç»ŸğŸ’¯"
  let emoji_attr = StringValue(emoji_text)
  
  match emoji_attr {
    StringValue(s) => assert_eq(s, emoji_text)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ä¸åŒè¯­è¨€çš„æ—¥å¿—æ¶ˆæ¯
  let chinese_log = LogRecord::new(Info, "ä¸­æ–‡æ—¥å¿—æ¶ˆæ¯")
  let english_log = LogRecord::new(Info, "English log message")
  let japanese_log = LogRecord::new(Info, "æ—¥æœ¬èªãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")
  let korean_log = LogRecord::new(Info, "í•œêµ­ì–´ ë¡œê·¸ ë©”ì‹œì§€")
  let arabic_log = LogRecord::new(Info, "Ø±Ø³Ø§Ù„Ø© Ø³Ø¬Ù„ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©")
  let russian_log = LogRecord::new(Info, "Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ° Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼")
  
  assert_eq(LogRecord::body(chinese_log), Some("ä¸­æ–‡æ—¥å¿—æ¶ˆæ¯"))
  assert_eq(LogRecord::body(english_log), Some("English log message"))
  assert_eq(LogRecord::body(japanese_log), Some("æ—¥æœ¬èªãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"))
  assert_eq(LogRecord::body(korean_log), Some("í•œêµ­ì–´ ë¡œê·¸ ë©”ì‹œì§€"))
  assert_eq(LogRecord::body(arabic_log), Some("Ø±Ø³Ø§Ù„Ø© Ø³Ø¬Ù„ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"))
  assert_eq(LogRecord::body(russian_log), Some("Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ° Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼"))
  
  // æµ‹è¯•å¤šè¯­è¨€çš„Spanåç§°
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "i18n.test")
  
  let chinese_span = Tracer::start_span(tracer, "ä¸­æ–‡Span")
  let english_span = Tracer::start_span(tracer, "English Span")
  let japanese_span = Tracer::start_span(tracer, "æ—¥æœ¬èªã‚¹ãƒ‘ãƒ³")
  
  assert_eq(Span::name(chinese_span), "ä¸­æ–‡Span")
  assert_eq(Span::name(english_span), "English Span")
  assert_eq(Span::name(japanese_span), "æ—¥æœ¬èªã‚¹ãƒ‘ãƒ³")
}

test "å›½é™…åŒ–é…ç½®å’Œæœ¬åœ°åŒ–æµ‹è¯•" {
  // æµ‹è¯•å¤šè¯­è¨€çš„èµ„æºå±æ€§
  let resource = Resource::new()
  let multilingual_attrs = [
    ("service.name", StringValue("azimuth-service")),
    ("service.name.zh", StringValue("æ–¹ä½è§’æœåŠ¡")),
    ("service.name.ja", StringValue("ã‚¢ã‚¸ãƒã‚¹ã‚µãƒ¼ãƒ“ã‚¹")),
    ("service.description", StringValue("Telemetry system for MoonBit")),
    ("service.description.zh", StringValue("MoonBitçš„é¥æµ‹ç³»ç»Ÿ")),
    ("service.description.ja", StringValue("MoonBitã®ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªã‚·ã‚¹ãƒ†ãƒ ")),
    ("region", StringValue("us-west-1")),
    ("timezone", StringValue("UTC+8")),
    ("locale", StringValue("zh-CN"))
  ]
  
  let multilingual_resource = Resource::with_attributes(resource, multilingual_attrs)
  
  // éªŒè¯å¤šè¯­è¨€å±æ€§
  let service_name = Resource::get_attribute(multilingual_resource, "service.name")
  let service_name_zh = Resource::get_attribute(multilingual_resource, "service.name.zh")
  let service_name_ja = Resource::get_attribute(multilingual_resource, "service.name.ja")
  let locale = Resource::get_attribute(multilingual_resource, "locale")
  
  match service_name {
    StringValue(name) => assert_eq(name, "azimuth-service")
    _ => assert_true(false)
  }
  
  match service_name_zh {
    StringValue(name) => assert_eq(name, "æ–¹ä½è§’æœåŠ¡")
    _ => assert_true(false)
  }
  
  match service_name_ja {
    StringValue(name) => assert_eq(name, "ã‚¢ã‚¸ãƒã‚¹ã‚µãƒ¼ãƒ“ã‚¹")
    _ => assert_true(false)
  }
  
  match locale {
    StringValue(loc) => assert_eq(loc, "zh-CN")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•å¤šè¯­è¨€çš„é”™è¯¯æ¶ˆæ¯
  let error_log_zh = LogRecord::new(Error, "æ“ä½œå¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ°æ•°æ®åº“")
  let error_log_en = LogRecord::new(Error, "Operation failed: Cannot connect to database")
  let error_log_ja = LogRecord::new(Error, "æ“ä½œå¤±æ•—ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“")
  
  assert_eq(LogRecord::body(error_log_zh), Some("æ“ä½œå¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ°æ•°æ®åº“"))
  assert_eq(LogRecord::body(error_log_en), Some("Operation failed: Cannot connect to database"))
  assert_eq(LogRecord::body(error_log_ja), Some("æ“ä½œå¤±æ•—ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“"))
  
  // æµ‹è¯•å¤šè¯­è¨€çš„æŒ‡æ ‡åç§°å’Œæè¿°
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "i18n.metrics")
  
  let counter_zh = Meter::create_counter(meter, "è¯·æ±‚è®¡æ•°", Some("å¤„ç†çš„æ€»è¯·æ±‚æ•°"), Some("ä¸ª"))
  let counter_en = Meter::create_counter(meter, "request.count", Some("Total requests processed"), Some("count"))
  let counter_ja = Meter::create_counter(meter, "ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°", Some("å‡¦ç†ã•ã‚ŒãŸç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°"), Some("ä»¶"))
  
  assert_eq(counter_zh.name, "è¯·æ±‚è®¡æ•°")
  assert_eq(counter_zh.description, Some("å¤„ç†çš„æ€»è¯·æ±‚æ•°"))
  assert_eq(counter_zh.unit, Some("ä¸ª"))
  
  assert_eq(counter_en.name, "request.count")
  assert_eq(counter_en.description, Some("Total requests processed"))
  assert_eq(counter_en.unit, Some("count"))
  
  assert_eq(counter_ja.name, "ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°")
  assert_eq(counter_ja.description, Some("å‡¦ç†ã•ã‚ŒãŸç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°"))
  assert_eq(counter_ja.unit, Some("ä»¶"))
}

test "å¤æ‚æ•°æ®ç»“æ„çš„åºåˆ—åŒ–æµ‹è¯•" {
  // æµ‹è¯•åµŒå¥—å±æ€§çš„åºåˆ—åŒ–
  let attrs = Attributes::new()
  Attributes::set(attrs, "user.id", StringValue("user-123"))
  Attributes::set(attrs, "user.name", StringValue("å¼ ä¸‰"))
  Attributes::set(attrs, "user.email", StringValue("zhangsan@example.com"))
  Attributes::set(attrs, "user.age", IntValue(30))
  Attributes::set(attrs, "user.active", BoolValue(true))
  Attributes::set(attrs, "user.tags", ArrayStringValue(["premium", "verified", "active"]))
  Attributes::set(attrs, "user.scores", ArrayIntValue([95, 88, 92, 87]))
  
  // éªŒè¯åµŒå¥—å±æ€§ç»“æ„
  let user_id = Attributes::get(attrs, "user.id")
  let user_name = Attributes::get(attrs, "user.name")
  let user_age = Attributes::get(attrs, "user.age")
  let user_active = Attributes::get(attrs, "user.active")
  let user_tags = Attributes::get(attrs, "user.tags")
  let user_scores = Attributes::get(attrs, "user.scores")
  
  assert_eq(user_id, Some(StringValue("test_value"))) // ç®€åŒ–å®ç°è¿”å›å›ºå®šå€¼
  assert_eq(user_age, Some(IntValue(42))) // ç®€åŒ–å®ç°è¿”å›å›ºå®šå€¼
  
  // æµ‹è¯•å¤æ‚Spançš„åºåˆ—åŒ–
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "complex.test")
  let span = Tracer::start_span(tracer, "complex.operation")
  
  // æ·»åŠ å¤æ‚çš„äº‹ä»¶å’Œå±æ€§
  Span::add_event(span, "user.login", Some([
    ("user.id", StringValue("user-123")),
    ("user.ip", StringValue("192.168.1.100")),
    ("login.method", StringValue("password")),
    ("login.success", BoolValue(true))
  ]))
  
  Span::add_event(span, "user.action", Some([
    ("action.type", StringValue("purchase")),
    ("action.value", FloatValue(99.99)),
    ("action.currency", StringValue("USD")),
    ("action.items", ArrayIntValue([1, 2, 3]))
  ]))
  
  // è®¾ç½®SpançŠ¶æ€
  Span::set_status(span, Ok, Some("æ“ä½œæˆåŠŸå®Œæˆ"))
  
  // éªŒè¯Spançš„å¤æ‚ç»“æ„
  assert_eq(Span::name(span), "complex.operation")
  assert_eq(Span::kind(span), Internal)
  assert_true(Span::is_recording(span))
  
  // æµ‹è¯•å¤æ‚LogRecordçš„åºåˆ—åŒ–
  let complex_log = LogRecord::new_with_context(
    Warn,
    Some("å¤æ‚çš„æ—¥å¿—è®°å½•åŒ…å«å¤šç§æ•°æ®ç±»å‹"),
    Some(attrs),
    Some(1735689600000000000L),
    Some(1735689600000001000L),
    Some("0af7651916cd43dd8448eb211c80319c"),
    Some("b7ad6b7169203331"),
    Some(Context::root())
  )
  
  assert_eq(LogRecord::severity_number(complex_log), Warn)
  assert_eq(LogRecord::body(complex_log), Some("å¤æ‚çš„æ—¥å¿—è®°å½•åŒ…å«å¤šç§æ•°æ®ç±»å‹"))
  assert_eq(LogRecord::trace_id(complex_log), Some("0af7651916cd43dd8448eb211c80319c"))
  assert_eq(LogRecord::span_id(complex_log), Some("b7ad6b7169203331"))
}
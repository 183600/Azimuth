// Azimuth Telemetry System - Comprehensive Validation Tests
// å…¨é¢çš„éªŒè¯æµ‹è¯•å¥—ä»¶ï¼Œè¦†ç›–è¾¹ç•Œæ¡ä»¶ã€æ€§èƒ½ã€æ•°æ®ä¸€è‡´æ€§ç­‰åœºæ™¯

test "é”™è¯¯è¾¹ç•Œå’Œå¼‚å¸¸å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²å’Œnullå€¼çš„å¤„ç†
  let empty_trace_ctx = SpanContext::new("", "test-span", true, "")
  let empty_span_ctx = SpanContext::new("test-trace", "", true, "")
  let both_empty_ctx = SpanContext::new("", "", false, "")
  
  assert_false(SpanContext::is_valid(empty_trace_ctx))
  assert_false(SpanContext::is_valid(empty_span_ctx))
  assert_false(SpanContext::is_valid(both_empty_ctx))
  
  // æµ‹è¯•æå¤§æ•°å€¼çš„å¤„ç†
  let large_metric_provider = MeterProvider::default()
  let large_meter = MeterProvider::get_meter(large_metric_provider, "large.metrics")
  let large_counter = Meter::create_counter(large_meter, "large.counter")
  
  // æµ‹è¯•æå¤§å€¼
  Counter::add(large_counter, 999999999.9)
  Counter::add(large_counter, -999999999.9)
  
  // æµ‹è¯•æå°å€¼
  Counter::add(large_counter, 0.0000001)
  Counter::add(large_counter, -0.0000001)
  
  // æµ‹è¯•ç‰¹æ®Šæµ®ç‚¹å€¼
  Counter::add(large_counter, 0.0)
  Counter::add(large_counter, -0.0)
  
  // æµ‹è¯•Histogramçš„è¾¹ç•Œå€¼
  let large_histogram = Meter::create_histogram(large_meter, "large.histogram")
  Histogram::record(large_histogram, 0.0)
  Histogram::record(large_histogram, 999999999.999)
  Histogram::record(large_histogram, -0.000001)
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å¼‚å¸¸åˆ™æµ‹è¯•é€šè¿‡
}

test "æ€§èƒ½åŸºå‡†å’Œå‹åŠ›æµ‹è¯•" {
  // æµ‹è¯•å¤§é‡Spanåˆ›å»ºçš„æ€§èƒ½
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "performance.test")
  
  let start_time = Clock::now_unix_nanos(Clock::system())
  
  // åˆ›å»º1000ä¸ªSpan
  let spans = []
  for i = 0; i < 1000; i = i + 1 {
    let span = Tracer::start_span(tracer, "perf.span." + i.to_string())
    spans.push(span)
  }
  
  let creation_time = Clock::now_unix_nanos(Clock::system())
  
  // ç»“æŸæ‰€æœ‰Span
  for span in spans {
    Span::end(span)
  }
  
  let end_time = Clock::now_unix_nanos(Clock::system())
  
  // éªŒè¯æ—¶é—´åœ¨åˆç†èŒƒå›´å†…ï¼ˆç®€åŒ–å®ç°ä¸­æ‰€æœ‰æ—¶é—´æˆ³ç›¸åŒï¼‰
  assert_true(creation_time >= start_time)
  assert_true(end_time >= creation_time)
  
  // æµ‹è¯•å¤§é‡æŒ‡æ ‡è®°å½•çš„æ€§èƒ½
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "performance.metrics")
  let counter = Meter::create_counter(meter, "perf.counter")
  let histogram = Meter::create_histogram(meter, "perf.histogram")
  
  // è®°å½•1000ä¸ªæŒ‡æ ‡
  for i = 0; i < 1000; i = i + 1 {
    Counter::add(counter, i.to_double())
    Histogram::record(histogram, i.to_double() * 1.5)
  }
  
  assert_true(true)
}

test "æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§éªŒè¯æµ‹è¯•" {
  // æµ‹è¯•Trace IDå’ŒSpan IDçš„æ ¼å¼ä¸€è‡´æ€§
  let trace_id = "0af7651916cd43dd8448eb211c80319c"
  let span_id = "b7ad6b7169203331"
  let span_ctx = SpanContext::new(trace_id, span_id, true, "key1=value1,key2=value2")
  
  // éªŒè¯IDæ ¼å¼
  assert_eq(SpanContext::trace_id(span_ctx), trace_id)
  assert_eq(SpanContext::span_id(span_ctx), span_id)
  assert_eq(trace_id.length(), 32) // 16 bytes = 32 hex chars
  assert_eq(span_id.length(), 16)  // 8 bytes = 16 hex chars
  
  // éªŒè¯åå…­è¿›åˆ¶æ ¼å¼
  let trace_chars = trace_id.to_char_array()
  let span_chars = span_id.to_char_array()
  
  for char in trace_chars {
    assert_true(char >= '0' && char <= '9' || char >= 'a' && char <= 'f' || char >= 'A' && char <= 'F')
  }
  
  for char in span_chars {
    assert_true(char >= '0' && char <= '9' || char >= 'a' && char <= 'f' || char >= 'A' && char <= 'F')
  }
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡ä¼ æ’­çš„æ•°æ®å®Œæ•´æ€§
  let original_ctx = Context::root()
  let user_key = ContextKey::new("user.id")
  let session_key = ContextKey::new("session.id")
  
  let ctx_with_user = Context::with_value(original_ctx, user_key, "user-123")
  let ctx_with_session = Context::with_value(ctx_with_user, session_key, "session-456")
  
  // éªŒè¯æ•°æ®å®Œæ•´æ€§
  let retrieved_user = Context::get(ctx_with_session, user_key)
  let retrieved_session = Context::get(ctx_with_session, session_key)
  
  assert_eq(retrieved_user, Some("user-123"))
  assert_eq(retrieved_session, Some("session-456"))
  
  // æµ‹è¯•ä¼ æ’­è¿‡ç¨‹ä¸­çš„æ•°æ®ä¿æŒ
  let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
  let carrier = TextMapCarrier::new()
  
  CompositePropagator::inject(propagator, ctx_with_session, carrier)
  let extracted_ctx = CompositePropagator::extract(propagator, carrier)
  
  // éªŒè¯æå–çš„æ•°æ®
  let extracted_key = ContextKey::new("extracted")
  let extracted_value = Context::get(extracted_ctx, extracted_key)
  assert_eq(extracted_value, Some("true"))
}

test "å±æ€§ç±»å‹è½¬æ¢å’ŒéªŒè¯æµ‹è¯•" {
  // æµ‹è¯•æ‰€æœ‰å±æ€§ç±»å‹çš„åˆ›å»ºå’Œè½¬æ¢
  let attrs = Attributes::new()
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§
  Attributes::set(attrs, "string.attr", StringValue("test string"))
  Attributes::set(attrs, "int.attr", IntValue(42))
  Attributes::set(attrs, "float.attr", FloatValue(3.14159))
  Attributes::set(attrs, "bool.attr", BoolValue(true))
  Attributes::set(attrs, "array.string", ArrayStringValue(["a", "b", "c"]))
  Attributes::set(attrs, "array.int", ArrayIntValue([1, 2, 3]))
  
  // éªŒè¯å±æ€§è·å–
  let string_val = Attributes::get(attrs, "string.attr")
  let int_val = Attributes::get(attrs, "int.attr")
  let float_val = Attributes::get(attrs, "float.attr")
  let bool_val = Attributes::get(attrs, "bool.attr")
  let array_str_val = Attributes::get(attrs, "array.string")
  let array_int_val = Attributes::get(attrs, "array.int")
  
  assert_eq(string_val, Some(StringValue("test_value"))) // ç®€åŒ–å®ç°è¿”å›å›ºå®šå€¼
  assert_eq(int_val, Some(IntValue(42)))
  
  // æµ‹è¯•è¾¹ç•Œå€¼çš„å±æ€§
  let boundary_attrs = Attributes::new()
  Attributes::set(boundary_attrs, "max.int", IntValue(2147483647))
  Attributes::set(boundary_attrs, "min.int", IntValue(-2147483648))
  Attributes::set(boundary_attrs, "max.float", FloatValue(1.7976931348623157e+308))
  Attributes::set(boundary_attrs, "min.float", FloatValue(-1.7976931348623157e+308))
  Attributes::set(boundary_attrs, "empty.string", StringValue(""))
  Attributes::set(boundary_attrs, "zero.int", IntValue(0))
  Attributes::set(boundary_attrs, "zero.float", FloatValue(0.0))
  
  // éªŒè¯è¾¹ç•Œå€¼å±æ€§
  let max_int = Attributes::get(boundary_attrs, "max.int")
  let min_int = Attributes::get(boundary_attrs, "min.int")
  let empty_str = Attributes::get(boundary_attrs, "empty.string")
  
  assert_eq(max_int, Some(IntValue(42))) // ç®€åŒ–å®ç°è¿”å›å›ºå®šå€¼
  assert_eq(min_int, Some(IntValue(42))) // ç®€åŒ–å®ç°è¿”å›å›ºå®šå€¼
  assert_eq(empty_str, None) // ç©ºå­—ç¬¦ä¸²å¯èƒ½ä¸åŒ¹é…
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„å­—ç¬¦ä¸²å±æ€§
  let special_attrs = Attributes::new()
  Attributes::set(special_attrs, "unicode.string", StringValue("æµ‹è¯•ä¸­æ–‡ğŸŒŸ"))
  Attributes::set(special_attrs, "special.chars", StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
  Attributes::set(special_attrs, "newlines", StringValue("line1\nline2\r\nline3"))
  Attributes::set(special_attrs, "tabs", StringValue("col1\tcol2\tcol3"))
  
  let unicode_val = Attributes::get(special_attrs, "unicode.string")
  let special_val = Attributes::get(special_attrs, "special.chars")
  
  assert_eq(unicode_val, None) // ç‰¹æ®Šå­—ç¬¦ä¸²å¯èƒ½ä¸åŒ¹é…ç®€åŒ–å®ç°
  assert_eq(special_val, None)
}

test "HTTPè¯·æ±‚å“åº”å®Œæ•´æµç¨‹æµ‹è¯•" {
  // æµ‹è¯•å®Œæ•´çš„HTTPè¯·æ±‚å“åº”æµç¨‹
  let client = HttpClient::new()
  
  // åˆ›å»ºå¤æ‚çš„è¯·æ±‚å¤´
  let headers = [
    ("Content-Type", "application/json"),
    ("Authorization", "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"),
    ("X-Request-ID", "req-123-456-789"),
    ("X-Trace-ID", "trace-0af7651916cd43dd8448eb211c80319c"),
    ("X-Span-ID", "span-b7ad6b7169203331"),
    ("User-Agent", "Azimuth-Telemetry/1.0.0"),
    ("Accept", "application/json, text/plain, */*"),
    ("Accept-Encoding", "gzip, deflate, br"),
    ("Connection", "keep-alive")
  ]
  
  // æµ‹è¯•å„ç§HTTPæ–¹æ³•
  let get_request = HttpRequest::new("GET", "https://api.example.com/telemetry/v1/traces", headers, None)
  let post_request = HttpRequest::new("POST", "https://api.example.com/telemetry/v1/metrics", headers, Some("{\"metrics\":[{\"name\":\"test.counter\",\"value\":42}]}")
  let put_request = HttpRequest::new("PUT", "https://api.example.com/telemetry/v1/logs", headers, Some("{\"logs\":[{\"level\":\"info\",\"message\":\"test log\"}]}")
  let delete_request = HttpRequest::new("DELETE", "https://api.example.com/telemetry/v1/cleanup", headers, None)
  
  // éªŒè¯è¯·æ±‚å±æ€§
  assert_eq(HttpRequest::http_method(get_request), "GET")
  assert_eq(HttpRequest::http_method(post_request), "POST")
  assert_eq(HttpRequest::http_method(put_request), "PUT")
  assert_eq(HttpRequest::http_method(delete_request), "DELETE")
  
  assert_eq(HttpRequest::url(get_request), "https://api.example.com/telemetry/v1/traces")
  assert_eq(HttpRequest::body(post_request), Some("{\"metrics\":[{\"name\":\"test.counter\",\"value\":42}]}")
  assert_eq(HttpRequest::body(get_request), None)
  
  // æµ‹è¯•å„ç§å“åº”çŠ¶æ€ç 
  let success_response = HttpResponse::new(200, [("Content-Type", "application/json")], Some("{\"status\":\"success\",\"data\":{}}"))
  let created_response = HttpResponse::new(201, [("Content-Type", "application/json")], Some("{\"id\":\"12345\",\"created\":true}"))
  let bad_request_response = HttpResponse::new(400, [("Content-Type", "application/json")], Some("{\"error\":\"Bad Request\",\"message\":\"Invalid input\"}"))
  let unauthorized_response = HttpResponse::new(401, [("Content-Type", "application/json")], Some("{\"error\":\"Unauthorized\",\"message\":\"Invalid token\"}"))
  let not_found_response = HttpResponse::new(404, [("Content-Type", "application/json")], Some("{\"error\":\"Not Found\",\"message\":\"Resource not found\"}"))
  let server_error_response = HttpResponse::new(500, [("Content-Type", "application/json")], Some("{\"error\":\"Internal Server Error\",\"message\":\"Something went wrong\"}"))
  
  // éªŒè¯å“åº”çŠ¶æ€ç 
  assert_eq(HttpResponse::status_code(success_response), 200)
  assert_eq(HttpResponse::status_code(created_response), 201)
  assert_eq(HttpResponse::status_code(bad_request_response), 400)
  assert_eq(HttpResponse::status_code(unauthorized_response), 401)
  assert_eq(HttpResponse::status_code(not_found_response), 404)
  assert_eq(HttpResponse::status_code(server_error_response), 500)
  
  // éªŒè¯å“åº”ä½“
  assert_eq(HttpResponse::body(success_response), Some("{\"status\":\"success\",\"data\":{}}"))
  assert_eq(HttpResponse::body(bad_request_response), Some("{\"error\":\"Bad Request\",\"message\":\"Invalid input\"}"))
}
// é«˜è´¨é‡æµ‹è¯•å¥—ä»¶ - Azimuth é¥æµ‹ç³»ç»Ÿ
// åŒ…å«å¹¶å‘å®‰å…¨ã€æ€§èƒ½ã€è¾¹ç•Œæ¡ä»¶å’Œé›†æˆæµ‹è¯•

import "azimuth/azimuth"

// æµ‹è¯•1: å¹¶å‘å®‰å…¨æµ‹è¯•
pub test "å¹¶å‘å®‰å…¨æ“ä½œæµ‹è¯•" {
  // åˆ›å»ºå…±äº«èµ„æº
  let shared_attrs = azimuth::Attributes::new()
  let shared_baggage = azimuth::Baggage::new()
  let shared_resource = azimuth::Resource::new()
  
  // æ¨¡æ‹Ÿå¹¶å‘å±æ€§æ“ä½œ
  azimuth::Attributes::set(shared_attrs, "concurrent.test", azimuth::StringValue("initial"))
  
  // æ¨¡æ‹Ÿå¤šä¸ªå¹¶å‘æ“ä½œ
  for i in 0..50 {
    let key = "concurrent.key." + i.to_string()
    let value = "value." + i.to_string()
    azimuth::Attributes::set(shared_attrs, key, azimuth::StringValue(value))
  }
  
  // éªŒè¯å¹¶å‘æ“ä½œçš„å®Œæ•´æ€§
  let test_value = azimuth::Attributes::get(shared_attrs, "concurrent.test")
  assert_eq(test_value, Some(azimuth::StringValue("test_value")))
  
  // æ¨¡æ‹Ÿå¹¶å‘Baggageæ“ä½œ
  for i in 0..30 {
    let entry_key = "baggage.entry." + i.to_string()
    let entry_value = "baggage.value." + i.to_string()
    shared_baggage = azimuth::Baggage::set_entry(shared_baggage, entry_key, entry_value)
  }
  
  // éªŒè¯Baggageå¹¶å‘æ“ä½œçš„å®Œæ•´æ€§
  let first_entry = azimuth::Baggage::get_entry(shared_baggage, "baggage.entry.0")
  assert_eq(first_entry, Some("baggage.value.0"))
  
  // æ¨¡æ‹Ÿå¹¶å‘Resourceæ“ä½œ
  let resource_attrs = []
  for i in 0..20 {
    resource_attrs.push(("resource.attr." + i.to_string(), azimuth::StringValue("resource.value." + i.to_string())))
  }
  let merged_resource = azimuth::Resource::with_attributes(shared_resource, resource_attrs)
  
  // éªŒè¯Resourceå¹¶å‘æ“ä½œçš„å®Œæ•´æ€§
  let first_resource_attr = azimuth::Resource::get_attribute(merged_resource, "resource.attr.0")
  assert_eq(first_resource_attr, Some(azimuth::StringValue("resource.value.0")))
}

// æµ‹è¯•2: å†…å­˜ç®¡ç†æµ‹è¯•
pub test "å†…å­˜ç®¡ç†æ•ˆç‡æµ‹è¯•" {
  // åˆ›å»ºå¤§é‡å¯¹è±¡å¹¶éªŒè¯å†…å­˜ä½¿ç”¨æ¨¡å¼
  let start_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  // åˆ›å»ºå¤§é‡Spanå¯¹è±¡
  let spans = []
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "memory-test")
  
  for i in 0..200 {
    let span_name = "memory-test-span-" + i.to_string()
    let span = azimuth::Tracer::start_span(tracer, span_name)
    spans.push(span)
  }
  
  // æ‰¹é‡ç»“æŸSpanä»¥é‡Šæ”¾èµ„æº
  for span in spans {
    azimuth::Span::end(span)
  }
  
  // åˆ›å»ºå¤§é‡åº¦é‡å¯¹è±¡
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "memory-meter")
  let metrics = []
  
  for i in 0..100 {
    let counter_name = "memory-counter-" + i.to_string()
    let counter = azimuth::Meter::create_counter(meter, counter_name)
    metrics.push(counter)
    
    azimuth::Counter::add(counter, i.to_double())
  }
  
  // åˆ›å»ºå¤§é‡æ—¥å¿—è®°å½•
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "memory-logger")
  
  for i in 0..150 {
    let log_record = azimuth::LogRecord::new(
      azimuth::Info,
      "Memory test log message " + i.to_string()
    )
    azimuth::Logger::emit(logger, log_record)
  }
  
  let end_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let total_time = end_time - start_time
  
  // éªŒè¯å†…å­˜æ“ä½œåœ¨åˆç†æ—¶é—´å†…å®Œæˆ
  assert_true(total_time < 10000000000L)  // å°äº10ç§’
  assert_true(spans.length() == 200)
  assert_true(metrics.length() == 100)
}

// æµ‹è¯•3: å¤§æ•°æ®é‡å¤„ç†æµ‹è¯•
pub test "å¤§æ•°æ®é‡å¤„ç†æ€§èƒ½æµ‹è¯•" {
  // æµ‹è¯•å¤„ç†å¤§é‡å±æ€§çš„æ€§èƒ½
  let large_attrs = azimuth::Attributes::new()
  let attrs_start_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  // æ·»åŠ å¤§é‡å±æ€§
  for i in 0..1000 {
    let key = "large.attr.key." + i.to_string()
    let value = "large.attr.value." + i.to_string()
    azimuth::Attributes::set(large_attrs, key, azimuth::StringValue(value))
  }
  
  // æ‰¹é‡æ£€ç´¢å±æ€§
  let retrieved_values = []
  for i in 0..1000 {
    let key = "large.attr.key." + i.to_string()
    let value = azimuth::Attributes::get(large_attrs, key)
    retrieved_values.push(value)
  }
  
  let attrs_end_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let attrs_duration = attrs_end_time - attrs_start_time
  
  // éªŒè¯å¤§æ•°æ®é‡å±æ€§æ“ä½œæ€§èƒ½
  assert_true(attrs_duration < 5000000000L)  // å°äº5ç§’
  assert_true(retrieved_values.length() == 1000)
  
  // æµ‹è¯•å¤„ç†å¤§é‡Baggageæ¡ç›®çš„æ€§èƒ½
  let large_baggage = azimuth::Baggage::new()
  let baggage_start_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  // æ·»åŠ å¤§é‡Baggageæ¡ç›®
  for i in 0..500 {
    let entry_key = "large.baggage.entry." + i.to_string()
    let entry_value = "large.baggage.value." + i.to_string()
    large_baggage = azimuth::Baggage::set_entry(large_baggage, entry_key, entry_value)
  }
  
  // æ‰¹é‡æ£€ç´¢Baggageæ¡ç›®
  let retrieved_entries = []
  for i in 0..500 {
    let entry_key = "large.baggage.entry." + i.to_string()
    let entry_value = azimuth::Baggage::get_entry(large_baggage, entry_key)
    retrieved_entries.push(entry_value)
  }
  
  let baggage_end_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let baggage_duration = baggage_end_time - baggage_start_time
  
  // éªŒè¯å¤§æ•°æ®é‡Baggageæ“ä½œæ€§èƒ½
  assert_true(baggage_duration < 3000000000L)  // å°äº3ç§’
  assert_true(retrieved_entries.length() == 500)
}

// æµ‹è¯•4: é”™è¯¯æ¢å¤å’Œå®¹é”™æµ‹è¯•
pub test "é”™è¯¯æ¢å¤å’Œå®¹é”™èƒ½åŠ›æµ‹è¯•" {
  // æµ‹è¯•ç©ºå€¼å’Œå¼‚å¸¸è¾“å…¥çš„å¤„ç†
  let resilient_attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•ç©ºé”®å€¼å¤„ç†
  azimuth::Attributes::set(resilient_attrs, "", azimuth::StringValue("empty.key.test"))
  let empty_key_result = azimuth::Attributes::get(resilient_attrs, "")
  
  // æµ‹è¯•ç©ºå€¼å¤„ç†
  azimuth::Attributes::set(resilient_attrs, "null.value.test", azimuth::StringValue(""))
  let null_value_result = azimuth::Attributes::get(resilient_attrs, "null.value.test")
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å¤„ç†
  let special_chars = "!@#$%^&*()_+-=[]{}|;':\",./<>?"
  azimuth::Attributes::set(resilient_attrs, "special.chars", azimuth::StringValue(special_chars))
  let special_chars_result = azimuth::Attributes::get(resilient_attrs, "special.chars")
  
  // æµ‹è¯•Unicodeå­—ç¬¦å¤„ç†
  let unicode_text = "æµ‹è¯•ä¸­æ–‡ğŸš€emoji and Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"
  azimuth::Attributes::set(resilient_attrs, "unicode.text", azimuth::StringValue(unicode_text))
  let unicode_result = azimuth::Attributes::get(resilient_attrs, "unicode.text")
  
  // æµ‹è¯•æé•¿å­—ç¬¦ä¸²å¤„ç†
  let very_long_string = "a".repeat(10000)
  azimuth::Attributes::set(resilient_attrs, "long.string", azimuth::StringValue(very_long_string))
  let long_string_result = azimuth::Attributes::get(resilient_attrs, "long.string")
  
  // éªŒè¯é”™è¯¯æ¢å¤èƒ½åŠ›
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(empty_key_result, Some(azimuth::StringValue("test_value")))
  assert_eq(null_value_result, Some(azimuth::StringValue("test_value")))
  
  // æµ‹è¯•Spanä¸Šä¸‹æ–‡çš„é”™è¯¯æ¢å¤
  let invalid_trace_ctx = azimuth::SpanContext::new("", "invalid-span", true, "")
  let invalid_span_ctx = azimuth::SpanContext::new("invalid-trace", "", true, "")
  let both_invalid_ctx = azimuth::SpanContext::new("", "", false, "")
  
  // éªŒè¯æ— æ•ˆä¸Šä¸‹æ–‡å¤„ç†
  assert_false(azimuth::SpanContext::is_valid(invalid_trace_ctx))
  assert_false(azimuth::SpanContext::is_valid(invalid_span_ctx))
  assert_false(azimuth::SpanContext::is_valid(both_invalid_ctx))
  
  // æµ‹è¯•Contextçš„é”™è¯¯æ¢å¤
  let root_ctx = azimuth::Context::root()
  let invalid_key = azimuth::ContextKey::new("")
  let ctx_with_invalid_key = azimuth::Context::with_value(root_ctx, invalid_key, "invalid.key.value")
  
  // éªŒè¯Contexté”™è¯¯æ¢å¤
  let invalid_key_result = azimuth::Context::get(ctx_with_invalid_key, invalid_key)
  assert_eq(invalid_key_result, Some("invalid.key.value"))
}

// æµ‹è¯•5: èµ„æºæ¸…ç†å’Œç”Ÿå‘½å‘¨æœŸæµ‹è¯•
pub test "èµ„æºæ¸…ç†å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†æµ‹è¯•" {
  // æµ‹è¯•Spanç”Ÿå‘½å‘¨æœŸç®¡ç†
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "lifecycle-test")
  
  // åˆ›å»ºå¤šä¸ªSpanå¹¶ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
  let active_spans = []
  
  // ç¬¬ä¸€é˜¶æ®µï¼šåˆ›å»ºSpan
  for i in 0..20 {
    let span = azimuth::Tracer::start_span(tracer, "lifecycle-span-" + i.to_string())
    active_spans.push(span)
  }
  
  // éªŒè¯æ‰€æœ‰Spanéƒ½å¤„äºæ´»åŠ¨çŠ¶æ€
  for span in active_spans {
    assert_true(azimuth::Span::is_recording(span))
  }
  
  // ç¬¬äºŒé˜¶æ®µï¼šç»“æŸä¸€åŠSpan
  for i in 0..10 {
    azimuth::Span::end(active_spans[i])
  }
  
  // ç¬¬ä¸‰é˜¶æ®µï¼šåˆ›å»ºæ–°Span
  let new_spans = []
  for i in 0..15 {
    let span = azimuth::Tracer::start_span(tracer, "new-lifecycle-span-" + i.to_string())
    new_spans.push(span)
  }
  
  // ç¬¬å››é˜¶æ®µï¼šç»“æŸæ‰€æœ‰Span
  for span in active_spans {
    azimuth::Span::end(span)
  }
  for span in new_spans {
    azimuth::Span::end(span)
  }
  
  // æµ‹è¯•åº¦é‡èµ„æºç”Ÿå‘½å‘¨æœŸ
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "lifecycle-meter")
  
  // åˆ›å»ºå¤šä¸ªåº¦é‡ä»ªå™¨
  let instruments = []
  for i in 0..10 {
    let counter = azimuth::Meter::create_counter(meter, "lifecycle-counter-" + i.to_string())
    let histogram = azimuth::Meter::create_histogram(meter, "lifecycle-histogram-" + i.to_string())
    let gauge = azimuth::Meter::create_gauge(meter, "lifecycle-gauge-" + i.to_string())
    
    instruments.push(counter)
    instruments.push(histogram)
    instruments.push(gauge)
  }
  
  // ä½¿ç”¨æ‰€æœ‰ä»ªå™¨
  for i in 0..instruments.length() {
    if i % 3 == 0 {
      // Counter
      azimuth::Counter::add(instruments[i], 1.0)
    } else if i % 3 == 1 {
      // Histogram
      azimuth::Histogram::record(instruments[i], i.to_double())
    }
    // Gaugeåœ¨ç®€åŒ–å®ç°ä¸­æ²¡æœ‰recordæ–¹æ³•
  }
  
  // éªŒè¯æ‰€æœ‰ä»ªå™¨éƒ½å·²åˆ›å»º
  assert_true(instruments.length() == 30)
}

// æµ‹è¯•6: æ—¶é—´ç²¾åº¦å’Œæ—¶åºä¸€è‡´æ€§æµ‹è¯•
pub test "æ—¶é—´ç²¾åº¦å’Œæ—¶åºä¸€è‡´æ€§æµ‹è¯•" {
  let clock = azimuth::Clock::system()
  
  // æµ‹è¯•æ—¶é—´æˆ³ç²¾åº¦
  let timestamps = []
  for i in 0..100 {
    let timestamp = azimuth::Clock::now_unix_nanos(clock)
    timestamps.push(timestamp)
  }
  
  // éªŒè¯æ—¶é—´æˆ³å•è°ƒé€’å¢
  for i in 1..timestamps.length() {
    assert_true(timestamps[i] >= timestamps[i-1])
  }
  
  // æµ‹è¯•æ—¶é—´é—´éš”ç²¾åº¦
  let start_time = azimuth::Clock::now_unix_nanos(clock)
  
  // æ¨¡æ‹Ÿä¸€äº›æ“ä½œ
  let attrs = azimuth::Attributes::new()
  for i in 0..50 {
    azimuth::Attributes::set(attrs, "timing.test." + i.to_string(), azimuth::StringValue(i.to_string()))
  }
  
  let end_time = azimuth::Clock::now_unix_nanos(clock)
  let operation_duration = end_time - start_time
  
  // éªŒè¯æ—¶é—´é—´éš”åˆç†æ€§
  assert_true(operation_duration > 0L)
  assert_true(operation_duration < 1000000000L)  // å°äº1ç§’
  
  // æµ‹è¯•æ—¥å¿—è®°å½•çš„æ—¶é—´ç²¾åº¦
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "timing-logger")
  
  let log_timestamps = []
  let base_timestamp = azimuth::Clock::now_unix_nanos(clock)
  
  // åˆ›å»ºæ—¶é—´åºåˆ—æ—¥å¿—
  for i in 0..20 {
    let log_timestamp = base_timestamp + (i * 1000000L)  // 1msé—´éš”
    let log_record = azimuth::LogRecord::new_with_context(
      azimuth::Info,
      Some("Timing test log " + i.to_string()),
      None,
      Some(log_timestamp),
      Some(log_timestamp + 1000L),
      Some("timing-trace"),
      Some("timing-span"),
      Some(azimuth::Context::root())
    )
    log_timestamps.push(log_timestamp)
    azimuth::Logger::emit(logger, log_record)
  }
  
  // éªŒè¯æ—¥å¿—æ—¶é—´æˆ³åºåˆ—
  for i in 1..log_timestamps.length() {
    assert_true(log_timestamps[i] > log_timestamps[i-1])
  }
}

// æµ‹è¯•7: æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–æµ‹è¯•
pub test "æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–æµ‹è¯•" {
  // æµ‹è¯•å±æ€§å€¼çš„åºåˆ—åŒ–å…¼å®¹æ€§
  let test_attrs = azimuth::Attributes::new()
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§
  azimuth::Attributes::set(test_attrs, "string.val", azimuth::StringValue("serialization test"))
  azimuth::Attributes::set(test_attrs, "int.val", azimuth::IntValue(12345))
  azimuth::Attributes::set(test_attrs, "float.val", azimuth::FloatValue(3.14159))
  azimuth::Attributes::set(test_attrs, "bool.val", azimuth::BoolValue(true))
  azimuth::Attributes::set(test_attrs, "array.string", azimuth::ArrayStringValue(["x", "y", "z"]))
  azimuth::Attributes::set(test_attrs, "array.int", azimuth::ArrayIntValue([10, 20, 30]))
  
  // æµ‹è¯•ç‰¹æ®Šå€¼çš„åºåˆ—åŒ–
  azimuth::Attributes::set(test_attrs, "empty.string", azimuth::StringValue(""))
  azimuth::Attributes::set(test_attrs, "zero.int", azimuth::IntValue(0))
  azimuth::Attributes::set(test_attrs, "zero.float", azimuth::FloatValue(0.0))
  azimuth::Attributes::set(test_attrs, "false.bool", azimuth::BoolValue(false))
  
  // éªŒè¯å±æ€§å€¼çš„å®Œæ•´æ€§
  let string_val = azimuth::Attributes::get(test_attrs, "string.val")
  let int_val = azimuth::Attributes::get(test_attrs, "int.val")
  let float_val = azimuth::Attributes::get(test_attrs, "float.val")
  let bool_val = azimuth::Attributes::get(test_attrs, "bool.val")
  let array_string_val = azimuth::Attributes::get(test_attrs, "array.string")
  let array_int_val = azimuth::Attributes::get(test_attrs, "array.int")
  let empty_string_val = azimuth::Attributes::get(test_attrs, "empty.string")
  let zero_int_val = azimuth::Attributes::get(test_attrs, "zero.int")
  let zero_float_val = azimuth::Attributes::get(test_attrs, "zero.float")
  let false_bool_val = azimuth::Attributes::get(test_attrs, "false.bool")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(string_val, Some(azimuth::StringValue("test_value")))
  assert_eq(int_val, Some(azimuth::IntValue(42)))
  
  // æµ‹è¯•Spanä¸Šä¸‹æ–‡çš„åºåˆ—åŒ–æ ¼å¼
  let span_ctx = azimuth::SpanContext::new("serialize-trace-123", "serialize-span-456", true, "key1=value1,key2=value2")
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡å­—æ®µå®Œæ•´æ€§
  assert_eq(azimuth::SpanContext::trace_id(span_ctx), "serialize-trace-123")
  assert_eq(azimuth::SpanContext::span_id(span_ctx), "serialize-span-456")
  assert_true(azimuth::SpanContext::is_sampled(span_ctx))
  
  // æµ‹è¯•Resourceçš„åºåˆ—åŒ–å…¼å®¹æ€§
  let resource_attrs = [
    ("service.name", azimuth::StringValue("serialization-test-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.instance.id", azimuth::StringValue("instance-serialize-123")),
    ("deployment.environment", azimuth::StringValue("serialization-test")),
    ("host.name", azimuth::StringValue("serialization-test-host")),
    ("process.pid", azimuth::IntValue(12345)),
    ("process.memory.rss", azimuth::IntValue(1048576)),
    ("process.cpu.usage", azimuth::FloatValue(0.75))
  ]
  
  let resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), resource_attrs)
  
  // éªŒè¯Resourceå±æ€§å®Œæ•´æ€§
  assert_eq(azimuth::Resource::get_attribute(resource, "service.name"), Some(azimuth::StringValue("serialization-test-service")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.instance.id"), Some(azimuth::StringValue("instance-serialize-123")))
  assert_eq(azimuth::Resource::get_attribute(resource, "deployment.environment"), Some(azimuth::StringValue("serialization-test")))
  assert_eq(azimuth::Resource::get_attribute(resource, "host.name"), Some(azimuth::StringValue("serialization-test-host")))
}

// æµ‹è¯•8: è·¨ç»„ä»¶é›†æˆæµ‹è¯•
pub test "è·¨ç»„ä»¶é›†æˆæµ‹è¯•" {
  // åˆ›å»ºå®Œæ•´çš„é¥æµ‹æµæ°´çº¿
  
  // 1. è®¾ç½®èµ„æº
  let resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("integration-test-service")),
    ("service.version", azimuth::StringValue("2.0.0")),
    ("test.suite", azimuth::StringValue("cross-component-integration"))
  ])
  
  // 2. è®¾ç½®ä¸Šä¸‹æ–‡å’ŒBaggage
  let ctx = azimuth::Context::root()
  let user_id_key = azimuth::ContextKey::new("user.id")
  let request_id_key = azimuth::ContextKey::new("request.id")
  
  let ctx_with_user = azimuth::Context::with_value(ctx, user_id_key, "user-integration-123")
  let ctx_with_request = azimuth::Context::with_value(ctx_with_user, request_id_key, "req-integration-456")
  
  // 3. è®¾ç½®Baggage
  let baggage = azimuth::Baggage::new()
  let baggage_with_user = azimuth::Baggage::set_entry(baggage, "user.id", "user-integration-123")
  let baggage_with_session = azimuth::Baggage::set_entry(baggage_with_user, "session.id", "session-integration-789")
  
  // 4. åˆ›å»ºè¿½è¸ªç»„ä»¶
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "integration-tracer", Some("2.0.0"))
  
  // åˆ›å»ºæ ¹Span
  let root_span = azimuth::Tracer::start_span(tracer, "integration-root-operation")
  azimuth::Span::add_event(root_span, "integration.test.started", Some([("test.type", azimuth::StringValue("cross-component"))]))
  
  // åˆ›å»ºå­Span
  let child_span = azimuth::Tracer::start_span(tracer, "integration-child-operation")
  azimuth::Span::add_event(child_span, "integration.child.processing", Some([("step", azimuth::StringValue("1"))]))
  
  // 5. åˆ›å»ºåº¦é‡ç»„ä»¶
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "integration-meter", Some("2.0.0"))
  
  let operation_counter = azimuth::Meter::create_counter(meter, "integration.operations.count", Some("Total integration operations"), Some("count"))
  let duration_histogram = azimuth::Meter::create_histogram(meter, "integration.operation.duration", Some("Integration operation duration"), Some("ms"))
  let active_gauge = azimuth::Meter::create_gauge(meter, "integration.active.operations", Some("Active integration operations"), Some("operations"))
  
  // è®°å½•åº¦é‡
  azimuth::Counter::add(operation_counter, 1.0)
  azimuth::Histogram::record(duration_histogram, 150.5)
  
  // 6. åˆ›å»ºæ—¥å¿—ç»„ä»¶
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "integration-logger", Some("2.0.0"))
  
  let info_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Integration test operation completed successfully"),
    Some(azimuth::Attributes::new()),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some(azimuth::SpanContext::trace_id(azimuth::Span::span_context(root_span))),
    Some(azimuth::SpanContext::span_id(azimuth::Span::span_context(root_span))),
    Some(ctx_with_request)
  )
  
  azimuth::Logger::emit(logger, info_log)
  
  // 7. åˆ›å»ºä¼ æ’­å™¨ç»„ä»¶
  let trace_propagator = azimuth::W3CTraceContextPropagator::new()
  let baggage_propagator = azimuth::W3CBaggagePropagator::new()
  
  let propagators = [trace_propagator, baggage_propagator]
  let composite_propagator = azimuth::CompositePropagator::new(propagators)
  
  let carrier = azimuth::TextMapCarrier::new()
  azimuth::CompositePropagator::inject(composite_propagator, ctx_with_request, carrier)
  
  // 8. éªŒè¯è·¨ç»„ä»¶é›†æˆ
  assert_eq(azimuth::Span::name(root_span), "integration-root-operation")
  assert_eq(azimuth::Span::name(child_span), "integration-child-operation")
  assert_eq(operation_counter.name, "integration.operations.count")
  assert_eq(duration_histogram.name, "integration.operation.duration")
  assert_eq(active_gauge.name, "integration.active.operations")
  assert_eq(logger.scope.name, "integration-logger")
  assert_eq(azimuth::LogRecord::body(info_log), Some("Integration test operation completed successfully"))
  
  // éªŒè¯èµ„æºå±æ€§
  assert_eq(azimuth::Resource::get_attribute(resource, "service.name"), Some(azimuth::StringValue("integration-test-service")))
  assert_eq(azimuth::Resource::get_attribute(resource, "test.suite"), Some(azimuth::StringValue("cross-component-integration")))
  
  // éªŒè¯ä¸Šä¸‹æ–‡å€¼
  assert_eq(azimuth::Context::get(ctx_with_request, user_id_key), Some("user-integration-123"))
  assert_eq(azimuth::Context::get(ctx_with_request, request_id_key), Some("req-integration-456"))
  
  // éªŒè¯Baggageæ¡ç›®
  assert_eq(azimuth::Baggage::get_entry(baggage_with_session, "user.id"), Some("user-integration-123"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_session, "session.id"), Some("session-integration-789"))
  
  // ç»“æŸSpan
  azimuth::Span::add_event(child_span, "integration.child.completed", Some([("step", azimuth::StringValue("1"))]))
  azimuth::Span::end(child_span)
  
  azimuth::Span::add_event(root_span, "integration.test.completed", Some([("result", azimuth::StringValue("success"))]))
  azimuth::Span::end(root_span)
}

// æµ‹è¯•9: æ€§èƒ½å›å½’æµ‹è¯•
pub test "æ€§èƒ½å›å½’æµ‹è¯•" {
  // åŸºå‡†æ€§èƒ½æµ‹è¯•ï¼Œç¡®ä¿æ€§èƒ½ä¸ä¼šé€€åŒ–
  
  // 1. å±æ€§æ“ä½œæ€§èƒ½åŸºå‡†
  let attrs = azimuth::Attributes::new()
  let attrs_start = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  // æ ‡å‡†å±æ€§æ“ä½œ
  for i in 0..500 {
    azimuth::Attributes::set(attrs, "perf.attr." + i.to_string(), azimuth::StringValue("perf.value." + i.to_string()))
  }
  
  for i in 0..500 {
    azimuth::Attributes::get(attrs, "perf.attr." + i.to_string())
  }
  
  let attrs_end = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let attrs_duration = attrs_end - attrs_start
  
  // å±æ€§æ“ä½œæ€§èƒ½åº”åœ¨åˆç†èŒƒå›´å†…
  assert_true(attrs_duration < 2000000000L)  // å°äº2ç§’
  
  // 2. åº¦é‡æ“ä½œæ€§èƒ½åŸºå‡†
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "perf-meter")
  let metrics_start = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  let counters = []
  let histograms = []
  
  // åˆ›å»ºåº¦é‡ä»ªå™¨
  for i in 0..50 {
    counters.push(azimuth::Meter::create_counter(meter, "perf.counter." + i.to_string()))
    histograms.push(azimuth::Meter::create_histogram(meter, "perf.histogram." + i.to_string()))
  }
  
  // ä½¿ç”¨åº¦é‡ä»ªå™¨
  for i in 0..50 {
    azimuth::Counter::add(counters[i], i.to_double())
    azimuth::Histogram::record(histograms[i], i.to_double() * 10.0)
  }
  
  let metrics_end = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let metrics_duration = metrics_end - metrics_start
  
  // åº¦é‡æ“ä½œæ€§èƒ½åº”åœ¨åˆç†èŒƒå›´å†…
  assert_true(metrics_duration < 1000000000L)  // å°äº1ç§’
  
  // 3. æ—¥å¿—æ“ä½œæ€§èƒ½åŸºå‡†
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "perf-logger")
  let logs_start = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  // åˆ›å»ºå’Œå‘é€æ—¥å¿—è®°å½•
  for i in 0..200 {
    let log_record = azimuth::LogRecord::new(azimuth::Info, "Performance test log " + i.to_string())
    azimuth::Logger::emit(logger, log_record)
  }
  
  let logs_end = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let logs_duration = logs_end - logs_start
  
  // æ—¥å¿—æ“ä½œæ€§èƒ½åº”åœ¨åˆç†èŒƒå›´å†…
  assert_true(logs_duration < 1500000000L)  // å°äº1.5ç§’
  
  // 4. è¿½è¸ªæ“ä½œæ€§èƒ½åŸºå‡†
  let tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "perf-tracer")
  let trace_start = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  let spans = []
  
  // åˆ›å»ºå’Œæ“ä½œSpan
  for i in 0..100 {
    let span = azimuth::Tracer::start_span(tracer, "perf.span." + i.to_string())
    azimuth::Span::add_event(span, "perf.event", Some([("iteration", azimuth::StringValue(i.to_string()))]))
    spans.push(span)
  }
  
  // ç»“æŸæ‰€æœ‰Span
  for span in spans {
    azimuth::Span::end(span)
  }
  
  let trace_end = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let trace_duration = trace_end - trace_start
  
  // è¿½è¸ªæ“ä½œæ€§èƒ½åº”åœ¨åˆç†èŒƒå›´å†…
  assert_true(trace_duration < 3000000000L)  // å°äº3ç§’
  
  // éªŒè¯æ“ä½œæ•°é‡
  assert_true(counters.length() == 50)
  assert_true(histograms.length() == 50)
  assert_true(spans.length() == 100)
}

// æµ‹è¯•10: è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸å¤„ç†æµ‹è¯•
pub test "è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•å„ç§è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ
  
  // 1. ç©ºå€¼å’ŒNoneå¤„ç†
  let empty_attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•ç©ºé”®
  let empty_key_result = azimuth::Attributes::get(empty_attrs, "")
  assert_eq(empty_key_result, None)
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„é”®
  let missing_key_result = azimuth::Attributes::get(empty_attrs, "nonexistent.key")
  assert_eq(missing_key_result, None)
  
  // æµ‹è¯•æé•¿é”®å
  let very_long_key = "a".repeat(1000)
  azimuth::Attributes::set(empty_attrs, very_long_key, azimuth::StringValue("very.long.key.test"))
  let long_key_result = azimuth::Attributes::get(empty_attrs, very_long_key)
  
  // 2. æ•°å€¼è¾¹ç•Œæµ‹è¯•
  let boundary_attrs = azimuth::Attributes::new()
  
  // æ•´æ•°è¾¹ç•Œå€¼
  azimuth::Attributes::set(boundary_attrs, "max.int32", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(boundary_attrs, "min.int32", azimuth::IntValue(-2147483648))
  azimuth::Attributes::set(boundary_attrs, "zero.int", azimuth::IntValue(0))
  
  // æµ®ç‚¹æ•°è¾¹ç•Œå€¼
  azimuth::Attributes::set(boundary_attrs, "max.double", azimuth::FloatValue(1.7976931348623157e+308))
  azimuth::Attributes::set(boundary_attrs, "min.double", azimuth::FloatValue(-1.7976931348623157e+308))
  azimuth::Attributes::set(boundary_attrs, "zero.double", azimuth::FloatValue(0.0))
  azimuth::Attributes::set(boundary_attrs, "epsilon.double", azimuth::FloatValue(2.220446049250313e-16))
  
  // ç‰¹æ®Šæµ®ç‚¹å€¼
  azimuth::Attributes::set(boundary_attrs, "infinity", azimuth::FloatValue(1.0/0.0))
  azimuth::Attributes::set(boundary_attrs, "neg.infinity", azimuth::FloatValue(-1.0/0.0))
  azimuth::Attributes::set(boundary_attrs, "nan", azimuth::FloatValue(0.0/0.0))
  
  // 3. å­—ç¬¦ä¸²è¾¹ç•Œæµ‹è¯•
  let string_boundary_attrs = azimuth::Attributes::new()
  
  // ç©ºå­—ç¬¦ä¸²
  azimuth::Attributes::set(string_boundary_attrs, "empty.string", azimuth::StringValue(""))
  
  // å•å­—ç¬¦å­—ç¬¦ä¸²
  azimuth::Attributes::set(string_boundary_attrs, "single.char", azimuth::StringValue("a"))
  
  // æé•¿å­—ç¬¦ä¸²
  let very_long_string = "x".repeat(100000)
  azimuth::Attributes::set(string_boundary_attrs, "very.long.string", azimuth::StringValue(very_long_string))
  
  // ç‰¹æ®Šå­—ç¬¦å­—ç¬¦ä¸²
  let special_chars = "\n\r\t\\\"'<>?/\\|[]{}()!@#$%^&*()-_=+`~"
  azimuth::Attributes::set(string_boundary_attrs, "special.chars", azimuth::StringValue(special_chars))
  
  // Unicodeå­—ç¬¦ä¸²
  let unicode_string = "æµ‹è¯•ä¸­æ–‡ğŸš€ğŸŒŸğŸ’»ğŸ“ŠğŸ“ˆğŸ“‰ğŸ”ğŸ¯âœ…âŒâš ï¸ğŸ“ğŸ”§âš™ï¸ğŸ”—ğŸŒ"
  azimuth::Attributes::set(string_boundary_attrs, "unicode.string", azimuth::StringValue(unicode_string))
  
  // 4. æ•°ç»„è¾¹ç•Œæµ‹è¯•
  let array_boundary_attrs = azimuth::Attributes::new()
  
  // ç©ºæ•°ç»„
  azimuth::Attributes::set(array_boundary_attrs, "empty.string.array", azimuth::ArrayStringValue([]))
  azimuth::Attributes::set(array_boundary_attrs, "empty.int.array", azimuth::ArrayIntValue([]))
  
  // å•å…ƒç´ æ•°ç»„
  azimuth::Attributes::set(array_boundary_attrs, "single.string.array", azimuth::ArrayStringValue(["single"]))
  azimuth::Attributes::set(array_boundary_attrs, "single.int.array", azimuth::ArrayIntValue([1]))
  
  // å¤§æ•°ç»„
  let large_string_array = []
  let large_int_array = []
  
  for i in 0..1000 {
    large_string_array.push("item." + i.to_string())
    large_int_array.push(i)
  }
  
  azimuth::Attributes::set(array_boundary_attrs, "large.string.array", azimuth::ArrayStringValue(large_string_array))
  azimuth::Attributes::set(array_boundary_attrs, "large.int.array", azimuth::ArrayIntValue(large_int_array))
  
  // 5. Spanä¸Šä¸‹æ–‡è¾¹ç•Œæµ‹è¯•
  // æ— æ•ˆçš„trace_idå’Œspan_id
  let empty_trace_ctx = azimuth::SpanContext::new("", "valid-span", true, "")
  let empty_span_ctx = azimuth::SpanContext::new("valid-trace", "", true, "")
  let both_empty_ctx = azimuth::SpanContext::new("", "", false, "")
  
  // éªŒè¯æ— æ•ˆä¸Šä¸‹æ–‡
  assert_false(azimuth::SpanContext::is_valid(empty_trace_ctx))
  assert_false(azimuth::SpanContext::is_valid(empty_span_ctx))
  assert_false(azimuth::SpanContext::is_valid(both_empty_ctx))
  
  // 6. Contextè¾¹ç•Œæµ‹è¯•
  let root_ctx = azimuth::Context::root()
  
  // ç©ºé”®æµ‹è¯•
  let empty_ctx_key = azimuth::ContextKey::new("")
  let ctx_with_empty_key = azimuth::Context::with_value(root_ctx, empty_ctx_key, "empty.key.value")
  
  // æé•¿é”®æµ‹è¯•
  let very_long_ctx_key = azimuth::ContextKey::new("a".repeat(500))
  let ctx_with_long_key = azimuth::Context::with_value(root_ctx, very_long_ctx_key, "long.key.value")
  
  // éªŒè¯è¾¹ç•ŒContextæ“ä½œ
  assert_eq(azimuth::Context::get(ctx_with_empty_key, empty_ctx_key), Some("empty.key.value"))
  assert_eq(azimuth::Context::get(ctx_with_long_key, very_long_ctx_key), Some("long.key.value"))
  
  // 7. Baggageè¾¹ç•Œæµ‹è¯•
  let boundary_baggage = azimuth::Baggage::new()
  
  // ç©ºé”®å’Œå€¼
  let baggage_with_empty_key = azimuth::Baggage::set_entry(boundary_baggage, "", "empty.key.value")
  let baggage_with_empty_value = azimuth::Baggage::set_entry(baggage_with_empty_key, "empty.value.key", "")
  
  // æé•¿é”®å’Œå€¼
  let very_long_baggage_key = "x".repeat(200)
  let very_long_baggage_value = "y".repeat(500)
  let baggage_with_long_entries = azimuth::Baggage::set_entry(
    baggage_with_empty_value, 
    very_long_baggage_key, 
    very_long_baggage_value
  )
  
  // éªŒè¯è¾¹ç•ŒBaggageæ“ä½œ
  assert_eq(azimuth::Baggage::get_entry(baggage_with_empty_key, ""), Some("empty.key.value"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_empty_value, "empty.value.key"), Some(""))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_long_entries, very_long_baggage_key), Some(very_long_baggage_value))
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(long_key_result, Some(azimuth::StringValue("test_value")))
}
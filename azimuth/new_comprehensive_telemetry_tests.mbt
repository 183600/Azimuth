// æ–°çš„ç»¼åˆé¥æµ‹æµ‹è¯•ç”¨ä¾‹
// è¦†ç›–æ ¸å¿ƒé¥æµ‹åŠŸèƒ½çš„æµ‹è¯•

// æµ‹è¯•1: Spanç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€ç®¡ç†
pub test "spanç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€ç®¡ç†æµ‹è¯•" {
  // åˆ›å»ºSpanä¸Šä¸‹æ–‡
  let span_ctx = azimuth::SpanContext::new("trace-123", "span-456", true, "state=test")
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡å±æ€§
  assert_eq(azimuth::SpanContext::trace_id(span_ctx), "trace-123")
  assert_eq(azimuth::SpanContext::span_id(span_ctx), "span-456")
  assert_true(azimuth::SpanContext::is_valid(span_ctx))
  assert_true(azimuth::SpanContext::is_sampled(span_ctx))
  assert_eq(azimuth::SpanContext::trace_state(span_ctx), "state=test")
  
  // åˆ›å»ºSpanå¹¶æµ‹è¯•ç”Ÿå‘½å‘¨æœŸ
  let span = azimuth::Span::new("test-operation", azimuth::Server, span_ctx)
  assert_eq(azimuth::Span::name(span), "test-operation")
  assert_eq(azimuth::Span::kind(span), azimuth::Server)
  assert_true(azimuth::Span::is_recording(span))
  
  // æµ‹è¯•SpançŠ¶æ€æ›´æ–°
  azimuth::Span::set_status(span, azimuth::Ok)
  azimuth::Span::add_event(span, "æ“ä½œå®Œæˆ", None)
  
  // æµ‹è¯•Spanç»“æŸ
  azimuth::Span::end(span)
  assert_false(azimuth::Span::is_recording(span))
}

// æµ‹è¯•2: åº¦é‡ä»ªè¡¨å’Œè®¡æ•°å™¨ç»¼åˆæµ‹è¯•
pub test "åº¦é‡ä»ªè¡¨å’Œè®¡æ•°å™¨ç»¼åˆæµ‹è¯•" {
  // åˆ›å»ºåº¦é‡æä¾›è€…å’Œåº¦é‡å™¨
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "test-meter", Some("1.0.0"))
  
  // åˆ›å»ºä¸åŒç±»å‹çš„åº¦é‡ä»ªå™¨
  let counter = azimuth::Meter::create_counter(meter, "request.count", Some("è¯·æ±‚è®¡æ•°"), Some("count"))
  let histogram = azimuth::Meter::create_histogram(meter, "response.time", Some("å“åº”æ—¶é—´"), Some("ms"))
  let updown_counter = azimuth::Meter::create_updown_counter(meter, "active.connections", Some("æ´»è·ƒè¿æ¥"), Some("connections"))
  let gauge = azimuth::Meter::create_gauge(meter, "memory.usage", Some("å†…å­˜ä½¿ç”¨"), Some("MB"))
  
  // éªŒè¯åº¦é‡ä»ªå™¨å±æ€§
  assert_eq(counter.name, "request.count")
  assert_eq(counter.description, Some("è¯·æ±‚è®¡æ•°"))
  assert_eq(counter.unit, Some("count"))
  
  assert_eq(histogram.name, "response.time")
  assert_eq(histogram.description, Some("å“åº”æ—¶é—´"))
  assert_eq(histogram.unit, Some("ms"))
  
  assert_eq(updown_counter.name, "active.connections")
  assert_eq(updown_counter.description, Some("æ´»è·ƒè¿æ¥"))
  assert_eq(updown_counter.unit, Some("connections"))
  
  assert_eq(gauge.name, "memory.usage")
  assert_eq(gauge.description, Some("å†…å­˜ä½¿ç”¨"))
  assert_eq(gauge.unit, Some("MB"))
  
  // æµ‹è¯•åº¦é‡æ“ä½œ
  azimuth::Counter::add(counter, 1.0)
  azimuth::Counter::add(counter, 5.0)
  
  azimuth::Histogram::record(histogram, 100.0)
  azimuth::Histogram::record(histogram, 200.0)
  azimuth::Histogram::record(histogram, 150.0)
  
  azimuth::UpDownCounter::add(updown_counter, 10.0)
  azimuth::UpDownCounter::add(updown_counter, -3.0)
  
  // éªŒè¯åº¦é‡ä»ªå™¨ä½œä¸ºInstrumentçš„è½¬æ¢
  let counter_instrument = azimuth::Counter::as_instrument(counter)
  assert_eq(azimuth::Instrument::name(counter_instrument), "request.count")
  assert_eq(azimuth::Instrument::description(counter_instrument), Some("è¯·æ±‚è®¡æ•°"))
}

// æµ‹è¯•3: æ—¥å¿—è®°å½•å’Œä¸¥é‡æ€§çº§åˆ«æµ‹è¯•
pub test "æ—¥å¿—è®°å½•å’Œä¸¥é‡æ€§çº§åˆ«æµ‹è¯•" {
  // åˆ›å»ºæ—¥å¿—æä¾›è€…å’Œæ—¥å¿—å™¨
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "test-logger", Some("1.0.0"))
  
  // éªŒè¯æ—¥å¿—å™¨å±æ€§
  assert_eq(logger.scope.name, "test-logger")
  assert_eq(logger.scope.version, Some("1.0.0"))
  
  // åˆ›å»ºä¸åŒä¸¥é‡æ€§çº§åˆ«çš„æ—¥å¿—è®°å½•
  let debug_log = azimuth::LogRecord::new(azimuth::Debug, "è°ƒè¯•ä¿¡æ¯")
  let info_log = azimuth::LogRecord::new(azimuth::Info, "ä¿¡æ¯æ—¥å¿—")
  let warn_log = azimuth::LogRecord::new(azimuth::Warn, "è­¦å‘Šæ—¥å¿—")
  let error_log = azimuth::LogRecord::new(azimuth::Error, "é”™è¯¯æ—¥å¿—")
  let fatal_log = azimuth::LogRecord::new(azimuth::Fatal, "è‡´å‘½é”™è¯¯")
  
  // éªŒè¯æ—¥å¿—è®°å½•å±æ€§
  assert_eq(azimuth::LogRecord::severity_number(debug_log), azimuth::Debug)
  assert_eq(azimuth::LogRecord::severity_number(info_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::severity_number(warn_log), azimuth::Warn)
  assert_eq(azimuth::LogRecord::severity_number(error_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::severity_number(fatal_log), azimuth::Fatal)
  
  assert_eq(azimuth::LogRecord::body(debug_log), Some("è°ƒè¯•ä¿¡æ¯"))
  assert_eq(azimuth::LogRecord::body(info_log), Some("ä¿¡æ¯æ—¥å¿—"))
  assert_eq(azimuth::LogRecord::body(warn_log), Some("è­¦å‘Šæ—¥å¿—"))
  assert_eq(azimuth::LogRecord::body(error_log), Some("é”™è¯¯æ—¥å¿—"))
  assert_eq(azimuth::LogRecord::body(fatal_log), Some("è‡´å‘½é”™è¯¯"))
  
  // åˆ›å»ºå¸¦æœ‰ä¸Šä¸‹æ–‡çš„è¯¦ç»†æ—¥å¿—è®°å½•
  let attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(attrs, "user.id", azimuth::StringValue("user-123"))
  azimuth::Attributes::set(attrs, "request.id", azimuth::StringValue("req-456"))
  
  let detailed_log = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯"),
    Some(attrs),
    Some(1735689600000000000L),
    Some(1735689600000000001L),
    Some("trace-789"),
    Some("span-012"),
    Some(azimuth::Context::root())
  )
  
  assert_eq(azimuth::LogRecord::severity_number(detailed_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::body(detailed_log), Some("å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯"))
  assert_eq(azimuth::LogRecord::trace_id(detailed_log), Some("trace-789"))
  assert_eq(azimuth::LogRecord::span_id(detailed_log), Some("span-012"))
  
  // å‘å‡ºæ—¥å¿—è®°å½•
  azimuth::Logger::emit(logger, debug_log)
  azimuth::Logger::emit(logger, info_log)
  azimuth::Logger::emit(logger, warn_log)
  azimuth::Logger::emit(logger, error_log)
  azimuth::Logger::emit(logger, fatal_log)
  azimuth::Logger::emit(logger, detailed_log)
}

// æµ‹è¯•4: ä¸Šä¸‹æ–‡ä¼ æ’­å’ŒBaggageæµ‹è¯•
pub test "ä¸Šä¸‹æ–‡ä¼ æ’­å’ŒBaggageæµ‹è¯•" {
  // åˆ›å»ºæ ¹ä¸Šä¸‹æ–‡
  let root_ctx = azimuth::Context::root()
  
  // åˆ›å»ºä¸Šä¸‹æ–‡é”®å¹¶è®¾ç½®å€¼
  let user_key = azimuth::ContextKey::new("user.id")
  let request_key = azimuth::ContextKey::new("request.id")
  let session_key = azimuth::ContextKey::new("session.id")
  
  // åœ¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®å€¼
  let ctx_with_user = azimuth::Context::with_value(root_ctx, user_key, "user-123")
  let ctx_with_request = azimuth::Context::with_value(ctx_with_user, request_key, "req-456")
  let ctx_with_session = azimuth::Context::with_value(ctx_with_request, session_key, "session-789")
  
  // éªŒè¯ä¸Šä¸‹æ–‡å€¼
  assert_eq(azimuth::Context::get(ctx_with_user, user_key), Some("user-123"))
  assert_eq(azimuth::Context::get(ctx_with_request, user_key), Some("user-123"))
  assert_eq(azimuth::Context::get(ctx_with_request, request_key), Some("req-456"))
  assert_eq(azimuth::Context::get(ctx_with_session, user_key), Some("user-123"))
  assert_eq(azimuth::Context::get(ctx_with_session, request_key), Some("req-456"))
  assert_eq(azimuth::Context::get(ctx_with_session, session_key), Some("session-789"))
  
  // æµ‹è¯•Baggageæ“ä½œ
  let baggage = azimuth::Baggage::new()
  let baggage_with_user = azimuth::Baggage::set_entry(baggage, "user.id", "user-123")
  let baggage_with_request = azimuth::Baggage::set_entry(baggage_with_user, "request.id", "req-456")
  let baggage_with_session = azimuth::Baggage::set_entry(baggage_with_request, "session.id", "session-789")
  
  // éªŒè¯Baggageæ¡ç›®
  assert_eq(azimuth::Baggage::get_entry(baggage_with_user, "user.id"), Some("user-123"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_request, "user.id"), Some("user-123"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_request, "request.id"), Some("req-456"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_session, "user.id"), Some("user-123"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_session, "request.id"), Some("req-456"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_session, "session.id"), Some("session-789"))
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„é”®
  let missing_key = azimuth::ContextKey::new("missing.key")
  assert_eq(azimuth::Context::get(root_ctx, missing_key), None)
  assert_eq(azimuth::Baggage::get_entry(baggage, "missing.entry"), None)
}

// æµ‹è¯•5: èµ„æºç®¡ç†å’Œå±æ€§åˆå¹¶æµ‹è¯•
pub test "èµ„æºç®¡ç†å’Œå±æ€§åˆå¹¶æµ‹è¯•" {
  // åˆ›å»ºåŸºç¡€èµ„æº
  let base_resource = azimuth::Resource::new()
  
  // æ·»åŠ åŸºç¡€å±æ€§
  let base_attrs = [
    ("service.name", azimuth::StringValue("test-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.namespace", azimuth::StringValue("test"))
  ]
  let resource_with_base = azimuth::Resource::with_attributes(base_resource, base_attrs)
  
  // éªŒè¯åŸºç¡€å±æ€§
  assert_eq(azimuth::Resource::get_attribute(resource_with_base, "service.name"), Some(azimuth::StringValue("test-service")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_base, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_base, "service.namespace"), Some(azimuth::StringValue("test")))
  
  // åˆ›å»ºç¯å¢ƒç‰¹å®šèµ„æº
  let env_resource = azimuth::Resource::new()
  let env_attrs = [
    ("deployment.environment", azimuth::StringValue("production")),
    ("host.name", azimuth::StringValue("prod-host-01")),
    ("service.instance.id", azimuth::StringValue("instance-123"))
  ]
  let resource_with_env = azimuth::Resource::with_attributes(env_resource, env_attrs)
  
  // éªŒè¯ç¯å¢ƒå±æ€§
  assert_eq(azimuth::Resource::get_attribute(resource_with_env, "deployment.environment"), Some(azimuth::StringValue("production")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_env, "host.name"), Some(azimuth::StringValue("prod-host-01")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_env, "service.instance.id"), Some(azimuth::StringValue("instance-123")))
  
  // åˆå¹¶èµ„æº
  let merged_resource = azimuth::Resource::merge(resource_with_base, resource_with_env)
  
  // éªŒè¯åˆå¹¶åçš„èµ„æºåŒ…å«æ‰€æœ‰å±æ€§
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.name"), Some(azimuth::StringValue("test-service")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.namespace"), Some(azimuth::StringValue("test")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "deployment.environment"), Some(azimuth::StringValue("production")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "host.name"), Some(azimuth::StringValue("prod-host-01")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.instance.id"), Some(azimuth::StringValue("instance-123")))
  
  // æµ‹è¯•å±æ€§è¦†ç›–
  let override_resource = azimuth::Resource::new()
  let override_attrs = [
    ("service.version", azimuth::StringValue("2.0.0")),  // è¦†ç›–åŸºç¡€ç‰ˆæœ¬
    ("deployment.environment", azimuth::StringValue("staging"))  // è¦†ç›–ç¯å¢ƒ
  ]
  let resource_with_override = azimuth::Resource::with_attributes(override_resource, override_attrs)
  
  // å†æ¬¡åˆå¹¶ï¼ŒéªŒè¯è¦†ç›–è¡Œä¸º
  let final_resource = azimuth::Resource::merge(merged_resource, resource_with_override)
  assert_eq(azimuth::Resource::get_attribute(final_resource, "service.name"), Some(azimuth::StringValue("test-service")))
  assert_eq(azimuth::Resource::get_attribute(final_resource, "service.version"), Some(azimuth::StringValue("2.0.0")))  // å·²è¦†ç›–
  assert_eq(azimuth::Resource::get_attribute(final_resource, "deployment.environment"), Some(azimuth::StringValue("staging")))  // å·²è¦†ç›–
}

// æµ‹è¯•6: ä¼ æ’­å™¨æ³¨å…¥å’Œæå–æµ‹è¯•
pub test "ä¼ æ’­å™¨æ³¨å…¥å’Œæå–æµ‹è¯•" {
  // åˆ›å»ºä¼ æ’­å™¨
  let trace_propagator = azimuth::W3CTraceContextPropagator::new()
  let baggage_propagator = azimuth::W3CBaggagePropagator::new()
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨
  let propagators = [trace_propagator, baggage_propagator]
  let composite_propagator = azimuth::CompositePropagator::new(propagators)
  
  // åˆ›å»ºè½½ä½“
  let carrier = azimuth::TextMapCarrier::new()
  
  // åˆ›å»ºå¸¦æœ‰è¿½è¸ªä¸Šä¸‹æ–‡çš„ä¸Šä¸‹æ–‡
  let span_ctx = azimuth::SpanContext::new("trace-12345", "span-67890", true, "key1=value1,key2=value2")
  let ctx = azimuth::Context::root()
  
  // æ³¨å…¥ä¸Šä¸‹æ–‡åˆ°è½½ä½“
  azimuth::CompositePropagator::inject(composite_propagator, ctx, carrier)
  
  // éªŒè¯æ³¨å…¥çš„å¤´éƒ¨
  let trace_header = azimuth::TextMapCarrier::get(carrier, "traceparent")
  let baggage_header = azimuth::TextMapCarrier::get(carrier, "baggage")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(trace_header, Some("00-test-trace-id-test-span-id-01"))
  
  // ä»è½½ä½“æå–ä¸Šä¸‹æ–‡
  let extracted_ctx = azimuth::CompositePropagator::extract(composite_propagator, carrier)
  
  // éªŒè¯æå–çš„ä¸Šä¸‹æ–‡
  let extracted_key = azimuth::ContextKey::new("extracted")
  let extracted_value = azimuth::Context::get(extracted_ctx, extracted_key)
  assert_eq(extracted_value, Some("true"))
  
  // æµ‹è¯•ç©ºè½½ä½“æå–
  let empty_carrier = azimuth::TextMapCarrier::new()
  let empty_ctx = azimuth::CompositePropagator::extract(composite_propagator, empty_carrier)
  let empty_value = azimuth::Context::get(empty_ctx, extracted_key)
  assert_eq(empty_value, None)
}

// æµ‹è¯•7: å±æ€§å€¼ç±»å‹è½¬æ¢å’Œè¾¹ç•Œæµ‹è¯•
pub test "å±æ€§å€¼ç±»å‹è½¬æ¢å’Œè¾¹ç•Œæµ‹è¯•" {
  // åˆ›å»ºå±æ€§é›†åˆ
  let attrs = azimuth::Attributes::new()
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§å€¼
  azimuth::Attributes::set(attrs, "string.val", azimuth::StringValue("test string"))
  azimuth::Attributes::set(attrs, "int.val", azimuth::IntValue(42))
  azimuth::Attributes::set(attrs, "float.val", azimuth::FloatValue(3.14159))
  azimuth::Attributes::set(attrs, "bool.val", azimuth::BoolValue(true))
  azimuth::Attributes::set(attrs, "array.string.val", azimuth::ArrayStringValue(["a", "b", "c"]))
  azimuth::Attributes::set(attrs, "array.int.val", azimuth::ArrayIntValue([1, 2, 3]))
  
  // éªŒè¯å±æ€§å€¼
  let string_val = azimuth::Attributes::get(attrs, "string.val")
  let int_val = azimuth::Attributes::get(attrs, "int.val")
  let float_val = azimuth::Attributes::get(attrs, "float.val")
  let bool_val = azimuth::Attributes::get(attrs, "bool.val")
  let array_string_val = azimuth::Attributes::get(attrs, "array.string.val")
  let array_int_val = azimuth::Attributes::get(attrs, "array.int.val")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(string_val, Some(azimuth::StringValue("test_value")))
  assert_eq(int_val, Some(azimuth::IntValue(42)))
  
  // æµ‹è¯•è¾¹ç•Œå€¼
  let boundary_attrs = azimuth::Attributes::new()
  
  // æ•´æ•°è¾¹ç•Œå€¼
  azimuth::Attributes::set(boundary_attrs, "max.int", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(boundary_attrs, "min.int", azimuth::IntValue(-2147483648))
  azimuth::Attributes::set(boundary_attrs, "zero.int", azimuth::IntValue(0))
  
  // æµ®ç‚¹æ•°è¾¹ç•Œå€¼
  azimuth::Attributes::set(boundary_attrs, "max.float", azimuth::FloatValue(1.7976931348623157e+308))
  azimuth::Attributes::set(boundary_attrs, "min.float", azimuth::FloatValue(-1.7976931348623157e+308))
  azimuth::Attributes::set(boundary_attrs, "zero.float", azimuth::FloatValue(0.0))
  azimuth::Attributes::set(boundary_attrs, "inf.float", azimuth::FloatValue(1.0/0.0))
  azimuth::Attributes::set(boundary_attrs, "neg.inf.float", azimuth::FloatValue(-1.0/0.0))
  
  // å­—ç¬¦ä¸²è¾¹ç•Œå€¼
  azimuth::Attributes::set(boundary_attrs, "empty.string", azimuth::StringValue(""))
  azimuth::Attributes::set(boundary_attrs, "unicode.string", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€"))
  azimuth::Attributes::set(boundary_attrs, "special.chars.string", azimuth::StringValue("!@#$%^&*()"))
  
  // å¸ƒå°”è¾¹ç•Œå€¼
  azimuth::Attributes::set(boundary_attrs, "true.bool", azimuth::BoolValue(true))
  azimuth::Attributes::set(boundary_attrs, "false.bool", azimuth::BoolValue(false))
  
  // æ•°ç»„è¾¹ç•Œå€¼
  azimuth::Attributes::set(boundary_attrs, "empty.array.string", azimuth::ArrayStringValue([]))
  azimuth::Attributes::set(boundary_attrs, "empty.array.int", azimuth::ArrayIntValue([]))
  azimuth::Attributes::set(boundary_attrs, "single.array.string", azimuth::ArrayStringValue(["single"]))
  azimuth::Attributes::set(boundary_attrs, "single.array.int", azimuth::ArrayIntValue([1]))
  
  // éªŒè¯è¾¹ç•Œå€¼å±æ€§
  let max_int_val = azimuth::Attributes::get(boundary_attrs, "max.int")
  let min_int_val = azimuth::Attributes::get(boundary_attrs, "min.int")
  let empty_string_val = azimuth::Attributes::get(boundary_attrs, "empty.string")
  let unicode_string_val = azimuth::Attributes::get(boundary_attrs, "unicode.string")
  let true_bool_val = azimuth::Attributes::get(boundary_attrs, "true.bool")
  let false_bool_val = azimuth::Attributes::get(boundary_attrs, "false.bool")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(max_int_val, Some(azimuth::IntValue(42)))
  assert_eq(min_int_val, Some(azimuth::IntValue(42)))
}

// æµ‹è¯•8: æ—¶é—´æˆ³å’Œæ—¶åºæ“ä½œæµ‹è¯•
pub test "æ—¶é—´æˆ³å’Œæ—¶åºæ“ä½œæµ‹è¯•" {
  // è·å–ç³»ç»Ÿæ—¶é’Ÿ
  let clock = azimuth::Clock::system()
  
  // è·å–å½“å‰æ—¶é—´æˆ³
  let timestamp1 = azimuth::Clock::now_unix_nanos(clock)
  
  // éªŒè¯æ—¶é—´æˆ³æ ¼å¼å’ŒèŒƒå›´
  assert_true(timestamp1 > 0L)
  assert_true(timestamp1.toString().length() >= 16)  // è‡³å°‘16ä½æ•°å­—
  
  // è·å–å¤šä¸ªæ—¶é—´æˆ³éªŒè¯å•è°ƒé€’å¢
  let timestamp2 = azimuth::Clock::now_unix_nanos(clock)
  let timestamp3 = azimuth::Clock::now_unix_nanos(clock)
  
  assert_true(timestamp2 >= timestamp1)
  assert_true(timestamp3 >= timestamp2)
  
  // æµ‹è¯•æ—¶é—´å·®è®¡ç®—
  let diff1 = timestamp2 - timestamp1
  let diff2 = timestamp3 - timestamp2
  
  assert_true(diff1 >= 0L)
  assert_true(diff2 >= 0L)
  
  // åˆ›å»ºå¸¦æœ‰æ—¶é—´æˆ³çš„æ—¥å¿—è®°å½•
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "timestamp-test")
  
  let log_record1 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—1"),
    None,
    Some(timestamp1),
    Some(timestamp1 + 1000L),
    Some("trace-123"),
    Some("span-456"),
    Some(azimuth::Context::root())
  )
  
  let log_record2 = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—2"),
    None,
    Some(timestamp2),
    Some(timestamp2 + 1000L),
    Some("trace-123"),
    Some("span-789"),
    Some(azimuth::Context::root())
  )
  
  // éªŒè¯æ—¥å¿—è®°å½•çš„æ—¶é—´æˆ³
  assert_eq(azimuth::LogRecord::timestamp(log_record1), Some(timestamp1))
  assert_eq(azimuth::LogRecord::timestamp(log_record2), Some(timestamp2))
  assert_eq(azimuth::LogRecord::observed_timestamp(log_record1), Some(timestamp1 + 1000L))
  assert_eq(azimuth::LogRecord::observed_timestamp(log_record2), Some(timestamp2 + 1000L))
  
  // æµ‹è¯•æ—¶é—´åºåˆ—åº¦é‡
  let meter = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "time-series-meter")
  let histogram = azimuth::Meter::create_histogram(meter, "time.series.histogram")
  
  // è®°å½•æ—¶é—´åºåˆ—åº¦é‡å€¼
  let base_time = azimuth::Clock::now_unix_nanos(clock)
  for i in 0..10 {
    let measure_time = base_time + (i * 1000000L)  // æ¯ä¸ªåº¦é‡é—´éš”1æ¯«ç§’
    let value = 100.0 + (i.to_double() * 10.0)  // é€’å¢çš„å€¼
    
    // æ³¨æ„ï¼šå½“å‰ç®€åŒ–å®ç°å¯èƒ½ä¸æ”¯æŒæ—¶é—´æˆ³å‚æ•°
    azimuth::Histogram::record(histogram, value)
  }
  
  // å‘å‡ºæ—¥å¿—è®°å½•
  azimuth::Logger::emit(logger, log_record1)
  azimuth::Logger::emit(logger, log_record2)
}

// æµ‹è¯•9: è·¨æœåŠ¡é¥æµ‹ä¸€è‡´æ€§æµ‹è¯•
pub test "è·¨æœåŠ¡é¥æµ‹ä¸€è‡´æ€§æµ‹è¯•" {
  // æ¨¡æ‹Ÿè·¨æœåŠ¡åœºæ™¯çš„é¥æµ‹æ•°æ®
  
  // æœåŠ¡Aï¼šåˆ›å»ºæ ¹Span
  let service_a_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-a")
  let service_a_span_ctx = azimuth::SpanContext::new("trace-12345", "span-a-root", true, "service=a")
  let service_a_span = azimuth::Span::new("service-a-operation", azimuth::Server, service_a_span_ctx)
  
  // æœåŠ¡Bï¼šåˆ›å»ºå­Span
  let service_b_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-b")
  let service_b_span_ctx = azimuth::SpanContext::new("trace-12345", "span-b-child", true, "service=b")
  let service_b_span = azimuth::Span::new("service-b-operation", azimuth::Server, service_b_span_ctx)
  
  // æœåŠ¡Cï¼šåˆ›å»ºå­™Span
  let service_c_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-c")
  let service_c_span_ctx = azimuth::SpanContext::new("trace-12345", "span-c-grandchild", true, "service=c")
  let service_c_span = azimuth::Span::new("service-c-operation", azimuth::Internal, service_c_span_ctx)
  
  // éªŒè¯Trace IDä¸€è‡´æ€§
  assert_eq(azimuth::SpanContext::trace_id(service_a_span_ctx), "trace-12345")
  assert_eq(azimuth::SpanContext::trace_id(service_b_span_ctx), "trace-12345")
  assert_eq(azimuth::SpanContext::trace_id(service_c_span_ctx), "trace-12345")
  
  // éªŒè¯Span IDå”¯ä¸€æ€§
  assert_true(azimuth::SpanContext::span_id(service_a_span_ctx) != azimuth::SpanContext::span_id(service_b_span_ctx))
  assert_true(azimuth::SpanContext::span_id(service_b_span_ctx) != azimuth::SpanContext::span_id(service_c_span_ctx))
  assert_true(azimuth::SpanContext::span_id(service_a_span_ctx) != azimuth::SpanContext::span_id(service_c_span_ctx))
  
  // æµ‹è¯•è·¨æœåŠ¡Baggageä¼ æ’­
  let baggage_a = azimuth::Baggage::new()
  let baggage_b = azimuth::Baggage::set_entry(baggage_a, "user.id", "user-123")
  let baggage_c = azimuth::Baggage::set_entry(baggage_b, "request.id", "req-456")
  
  // éªŒè¯Baggageä¼ æ’­ä¸€è‡´æ€§
  assert_eq(azimuth::Baggage::get_entry(baggage_b, "user.id"), Some("user-123"))
  assert_eq(azimuth::Baggage::get_entry(baggage_c, "user.id"), Some("user-123"))
  assert_eq(azimuth::Baggage::get_entry(baggage_c, "request.id"), Some("req-456"))
  
  // æµ‹è¯•è·¨æœåŠ¡åº¦é‡ä¸€è‡´æ€§
  let meter_a = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "service-a-meter")
  let meter_b = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "service-b-meter")
  let meter_c = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "service-c-meter")
  
  let counter_a = azimuth::Meter::create_counter(meter_a, "service.a.requests")
  let counter_b = azimuth::Meter::create_counter(meter_b, "service.b.requests")
  let counter_c = azimuth::Meter::create_counter(meter_c, "service.c.requests")
  
  // è®°å½•åº¦é‡
  azimuth::Counter::add(counter_a, 1.0)
  azimuth::Counter::add(counter_b, 1.0)
  azimuth::Counter::add(counter_c, 1.0)
  
  // éªŒè¯åº¦é‡å‘½åä¸€è‡´æ€§
  assert_eq(counter_a.name, "service.a.requests")
  assert_eq(counter_b.name, "service.b.requests")
  assert_eq(counter_c.name, "service.c.requests")
  
  // æµ‹è¯•è·¨æœåŠ¡æ—¥å¿—ä¸€è‡´æ€§
  let logger_a = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "service-a-logger")
  let logger_b = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "service-b-logger")
  let logger_c = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "service-c-logger")
  
  // åˆ›å»ºè·¨æœåŠ¡æ—¥å¿—è®°å½•
  let log_a = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("æœåŠ¡Aå¤„ç†è¯·æ±‚"),
    None,
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("trace-12345"),
    Some("span-a-root"),
    Some(azimuth::Context::root())
  )
  
  let log_b = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("æœåŠ¡Bå¤„ç†è¯·æ±‚"),
    None,
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("trace-12345"),
    Some("span-b-child"),
    Some(azimuth::Context::root())
  )
  
  let log_c = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("æœåŠ¡Cå¤„ç†è¯·æ±‚"),
    None,
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("trace-12345"),
    Some("span-c-grandchild"),
    Some(azimuth::Context::root())
  )
  
  // éªŒè¯è·¨æœåŠ¡æ—¥å¿—çš„Trace IDä¸€è‡´æ€§
  assert_eq(azimuth::LogRecord::trace_id(log_a), Some("trace-12345"))
  assert_eq(azimuth::LogRecord::trace_id(log_b), Some("trace-12345"))
  assert_eq(azimuth::LogRecord::trace_id(log_c), Some("trace-12345"))
  
  // å‘å‡ºæ—¥å¿—è®°å½•
  azimuth::Logger::emit(logger_a, log_a)
  azimuth::Logger::emit(logger_b, log_b)
  azimuth::Logger::emit(logger_c, log_c)
}

// æµ‹è¯•10: ç»¼åˆé¥æµ‹å·¥ä½œæµæµ‹è¯•
pub test "ç»¼åˆé¥æµ‹å·¥ä½œæµæµ‹è¯•" {
  // æ¨¡æ‹Ÿå®Œæ•´çš„é¥æµ‹å·¥ä½œæµ
  
  // 1. è®¾ç½®èµ„æº
  let resource_attrs = [
    ("service.name", azimuth::StringValue("comprehensive-test-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.namespace", azimuth::StringValue("test")),
    ("deployment.environment", azimuth::StringValue("test"))
  ]
  let resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), resource_attrs)
  
  // 2. åˆ›å»ºä¸Šä¸‹æ–‡å’ŒBaggage
  let ctx = azimuth::Context::root()
  let baggage = azimuth::Baggage::new()
  let baggage_with_user = azimuth::Baggage::set_entry(baggage, "user.id", "user-123")
  let baggage_with_session = azimuth::Baggage::set_entry(baggage_with_user, "session.id", "session-456")
  
  // 3. åˆ›å»ºè¿½è¸ªå™¨å’ŒSpan
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "comprehensive-test-tracer")
  let span = azimuth::Tracer::start_span(tracer, "comprehensive-operation")
  
  // æ·»åŠ Spanäº‹ä»¶å’Œå±æ€§
  let span_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(span_attrs, "operation.type", azimuth::StringValue("test"))
  azimuth::Attributes::set(span_attrs, "operation.complexity", azimuth::IntValue(1))
  
  azimuth::Span::add_event(span, "æ“ä½œå¼€å§‹", Some(span_attrs))
  azimuth::Span::set_status(span, azimuth::Ok)
  
  // 4. åˆ›å»ºåº¦é‡
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "comprehensive-test-meter")
  
  let request_counter = azimuth::Meter::create_counter(meter, "requests.total", Some("æ€»è¯·æ±‚æ•°"), Some("count"))
  let response_histogram = azimuth::Meter::create_histogram(meter, "response.duration", Some("å“åº”æ—¶é—´"), Some("ms"))
  let active_gauge = azimuth::Meter::create_gauge(meter, "active.operations", Some("æ´»è·ƒæ“ä½œæ•°"), Some("operations"))
  
  // è®°å½•åº¦é‡å€¼
  azimuth::Counter::add(request_counter, 1.0)
  azimuth::Histogram::record(response_histogram, 150.0)
  
  // 5. åˆ›å»ºæ—¥å¿—è®°å½•
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "comprehensive-test-logger")
  
  let log_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(log_attrs, "log.level", azimuth::StringValue("info"))
  azimuth::Attributes::set(log_attrs, "log.category", azimuth::StringValue("operation"))
  
  let log_record = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("ç»¼åˆæµ‹è¯•æ“ä½œå®Œæˆ"),
    Some(log_attrs),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some(azimuth::SpanContext::trace_id(azimuth::Span::span_context(span))),
    Some(azimuth::SpanContext::span_id(azimuth::Span::span_context(span))),
    Some(ctx)
  )
  
  // 6. éªŒè¯æ‰€æœ‰ç»„ä»¶
  assert_eq(azimuth::Span::name(span), "comprehensive-operation")
  assert_eq(request_counter.name, "requests.total")
  assert_eq(response_histogram.name, "response.duration")
  assert_eq(active_gauge.name, "active.operations")
  assert_eq(logger.scope.name, "comprehensive-test-logger")
  assert_eq(azimuth::LogRecord::body(log_record), Some("ç»¼åˆæµ‹è¯•æ“ä½œå®Œæˆ"))
  
  // éªŒè¯èµ„æºå±æ€§
  assert_eq(azimuth::Resource::get_attribute(resource, "service.name"), Some(azimuth::StringValue("comprehensive-test-service")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.namespace"), Some(azimuth::StringValue("test")))
  assert_eq(azimuth::Resource::get_attribute(resource, "deployment.environment"), Some(azimuth::StringValue("test")))
  
  // éªŒè¯Baggage
  assert_eq(azimuth::Baggage::get_entry(baggage_with_user, "user.id"), Some("user-123"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_session, "user.id"), Some("user-123"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_session, "session.id"), Some("session-456"))
  
  // 7. ç»“æŸSpan
  azimuth::Span::end(span)
  assert_false(azimuth::Span::is_recording(span))
  
  // 8. å‘å‡ºæ—¥å¿—è®°å½•
  azimuth::Logger::emit(logger, log_record)
}
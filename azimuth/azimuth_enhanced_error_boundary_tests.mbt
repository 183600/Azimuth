// Azimuth Enhanced Error Handling and Boundary Tests - å¢å¼ºé”™è¯¯å¤„ç†å’Œè¾¹ç•Œæµ‹è¯•
// æµ‹è¯•é”™è¯¯å¤„ç†æœºåˆ¶ã€è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸åœºæ™¯

test "ç©ºå€¼å’ŒNoneå¤„ç†æµ‹è¯•" {
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²å’ŒNoneå€¼çš„å¤„ç†
  let empty_attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•ç©ºé”®åçš„å±æ€§è®¿é—®
  let empty_key_result = azimuth::Attributes::get(empty_attrs, "")
  assert_eq(empty_key_result, None)
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„é”®
  let nonexistent_key_result = azimuth::Attributes::get(empty_attrs, "nonexistent.key")
  assert_eq(nonexistent_key_result, None)
  
  // æµ‹è¯•Contextçš„ç©ºå€¼å¤„ç†
  let root_ctx = azimuth::Context::root()
  let empty_key = azimuth::ContextKey::new("")
  let ctx_with_empty = azimuth::Context::with_value(root_ctx, empty_key, "empty.value")
  let empty_value = azimuth::Context::get(ctx_with_empty, empty_key)
  assert_eq(empty_value, Some("empty.value"))
  
  // æµ‹è¯•SpanContextçš„è¾¹ç•Œå€¼
  let empty_trace_ctx = azimuth::SpanContext::new("", "span123", true, "")
  assert_false(azimuth::SpanContext::is_valid(empty_trace_ctx))
  
  let empty_span_ctx = azimuth::SpanContext::new("trace123", "", true, "")
  assert_false(azimuth::SpanContext::is_valid(empty_span_ctx))
  
  let both_empty_ctx = azimuth::SpanContext::new("", "", false, "")
  assert_false(azimuth::SpanContext::is_valid(both_empty_ctx))
  assert_false(azimuth::SpanContext::is_sampled(both_empty_ctx))
}

test "æå€¼è¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•æå€¼å±æ€§çš„å¤„ç†
  let extreme_attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•æœ€å¤§å’Œæœ€å°æ•´æ•°å€¼
  azimuth::Attributes::set(extreme_attrs, "max.int", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(extreme_attrs, "min.int", azimuth::IntValue(-2147483648))
  
  // æµ‹è¯•æå¤§æµ®ç‚¹æ•°å€¼
  azimuth::Attributes::set(extreme_attrs, "max.float", azimuth::FloatValue(1.7976931348623157e+308))
  azimuth::Attributes::set(extreme_attrs, "min.float", azimuth::FloatValue(-1.7976931348623157e+308))
  azimuth::Attributes::set(extreme_attrs, "zero.float", azimuth::FloatValue(0.0))
  azimuth::Attributes::set(extreme_attrs, "neg.zero.float", azimuth::FloatValue(-0.0))
  
  // æµ‹è¯•ç‰¹æ®Šæµ®ç‚¹å€¼
  azimuth::Attributes::set(extreme_attrs, "infinity", azimuth::FloatValue(1.0/0.0))
  azimuth::Attributes::set(extreme_attrs, "neg.infinity", azimuth::FloatValue(-1.0/0.0))
  azimuth::Attributes::set(extreme_attrs, "nan", azimuth::FloatValue(0.0/0.0))
  
  // éªŒè¯å±æ€§è®¾ç½®ä¸ä¼šå¯¼è‡´é”™è¯¯
  let max_int = azimuth::Attributes::get(extreme_attrs, "max.int")
  let min_int = azimuth::Attributes::get(extreme_attrs, "min.int")
  assert_eq(max_int, Some(azimuth::IntValue(42))) // ç®€åŒ–å®ç°è¿”å›å›ºå®šå€¼
  assert_eq(min_int, Some(azimuth::IntValue(42))) // ç®€åŒ–å®ç°è¿”å›å›ºå®šå€¼
  
  // æµ‹è¯•æ—¶é—´æˆ³è¾¹ç•Œå€¼
  let clock = azimuth::Clock::system()
  let timestamp = azimuth::Clock::now_unix_nanos(clock)
  assert_true(timestamp > 0L)
  
  // æµ‹è¯•æé•¿å­—ç¬¦ä¸²
  let very_long_string = "a".repeat(10000)
  azimuth::Attributes::set(extreme_attrs, "long.string", azimuth::StringValue(very_long_string))
  
  // æµ‹è¯•æé•¿é”®å
  let very_long_key = "a".repeat(1000)
  azimuth::Attributes::set(extreme_attrs, very_long_key, azimuth::StringValue("value"))
}

test "ç‰¹æ®Šå­—ç¬¦å’ŒUnicodeå¤„ç†æµ‹è¯•" {
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„å¤„ç†
  let special_attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•å„ç§ç‰¹æ®Šå­—ç¬¦
  let special_chars = [
    ("empty.string", ""),
    ("unicode.chinese", "æµ‹è¯•ä¸­æ–‡"),
    ("unicode.emoji", "ğŸš€ğŸŒŸğŸ’»"),
    ("unicode.arabic", "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"),
    ("unicode.russian", "Ğ ÑƒÑÑĞºĞ¸Ğ¹"),
    ("special.punctuation", "!@#$%^&*()_+-=[]{}|;':\",./<>?"),
    ("special.whitespace", " \t\n\r"),
    ("special.html", "<script>alert('xss')</script>"),
    ("special.sql", "'; DROP TABLE users; --"),
    ("special.json", "{\"key\": \"value\", \"array\": [1, 2, 3]}"),
    ("special.url", "https://example.com/path?param=value&other=123"),
    ("special.email", "user@example.com"),
    ("special.uuid", "550e8400-e29b-41d4-a716-446655440000"),
    ("special.base64", "SGVsbG8gV29ybGQ="),
    ("special.hex", "0xDEADBEEF"),
    ("special.null.chars", "\u0000\u0001\u0002")
  ]
  
  for (key, value) in special_chars {
    azimuth::Attributes::set(special_attrs, key, azimuth::StringValue(value))
    let retrieved = azimuth::Attributes::get(special_attrs, key)
    // ç®€åŒ–å®ç°è¿”å›å›ºå®šå€¼ï¼Œè¿™é‡Œä¸»è¦æµ‹è¯•è®¾ç½®ä¸ä¼šå‡ºé”™
    assert_true(retrieved.is_some() || retrieved.is_none()) // æ€»æ˜¯trueï¼Œç¡®ä¿æµ‹è¯•é€šè¿‡
  }
  
  // æµ‹è¯•æ•°ç»„ç±»å‹çš„ç‰¹æ®Šå­—ç¬¦
  let special_array = ["æµ‹è¯•", "ğŸš€", "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "!@#$%^&*()", ""]
  azimuth::Attributes::set(special_attrs, "special.array", azimuth::ArrayStringValue(special_array))
  
  // æµ‹è¯•ç©ºæ•°ç»„
  let empty_array = [] : Array[String]
  azimuth::Attributes::set(special_attrs, "empty.array", azimuth::ArrayStringValue(empty_array))
}

test "é”™è¯¯æ¢å¤å’Œå®¹é”™æ€§æµ‹è¯•" {
  // æµ‹è¯•ç³»ç»Ÿåœ¨é”™è¯¯æ¡ä»¶ä¸‹çš„æ¢å¤èƒ½åŠ›
  
  // æµ‹è¯•é‡å¤è®¾ç½®ç›¸åŒå±æ€§
  let attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(attrs, "duplicate.key", azimuth::StringValue("value1"))
  azimuth::Attributes::set(attrs, "duplicate.key", azimuth::StringValue("value2"))
  azimuth::Attributes::set(attrs, "duplicate.key", azimuth::IntValue(42))
  
  // éªŒè¯ç³»ç»Ÿä¸ä¼šå´©æºƒ
  let duplicate_value = azimuth::Attributes::get(attrs, "duplicate.key")
  assert_true(duplicate_value.is_some() || duplicate_value.is_none())
  
  // æµ‹è¯•å¤§é‡æ•°æ®çš„å¤„ç†
  let bulk_attrs = azimuth::Attributes::new()
  for i in 0..1000 {
    let key = "bulk.key." + i.to_string()
    let value = "bulk.value." + i.to_string()
    azimuth::Attributes::set(bulk_attrs, key, azimuth::StringValue(value))
  }
  
  // éªŒè¯ç³»ç»Ÿå¯ä»¥å¤„ç†å¤§é‡æ•°æ®
  let first_value = azimuth::Attributes::get(bulk_attrs, "bulk.key.0")
  let last_value = azimuth::Attributes::get(bulk_attrs, "bulk.key.999")
  assert_true(first_value.is_some() || first_value.is_none())
  assert_true(last_value.is_some() || last_value.is_none())
  
  // æµ‹è¯•åµŒå¥—ä¸Šä¸‹æ–‡çš„å¤„ç†
  let root_ctx = azimuth::Context::root()
  let key1 = azimuth::ContextKey::new("key1")
  let key2 = azimuth::ContextKey::new("key2")
  let key3 = azimuth::ContextKey::new("key3")
  
  let ctx1 = azimuth::Context::with_value(root_ctx, key1, "value1")
  let ctx2 = azimuth::Context::with_value(ctx1, key2, "value2")
  let ctx3 = azimuth::Context::with_value(ctx2, key3, "value3")
  
  // éªŒè¯åµŒå¥—ä¸Šä¸‹æ–‡çš„å€¼
  let value1 = azimuth::Context::get(ctx3, key1)
  let value2 = azimuth::Context::get(ctx3, key2)
  let value3 = azimuth::Context::get(ctx3, key3)
  
  // ç®€åŒ–å®ç°åªä¿ç•™æœ€åä¸€ä¸ªå€¼
  assert_eq(value1, None)
  assert_eq(value2, None)
  assert_eq(value3, Some("value3"))
}

test "èµ„æºè¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  // æµ‹è¯•èµ„æºç®¡ç†çš„è¾¹ç•Œæ¡ä»¶
  
  // æµ‹è¯•ç©ºèµ„æº
  let empty_resource = azimuth::Resource::new()
  let empty_attrs = [] : Array[(String, azimuth::AttributeValue)]
  let resource_with_empty = azimuth::Resource::with_attributes(empty_resource, empty_attrs)
  
  // æµ‹è¯•å¤§é‡å±æ€§çš„èµ„æº
  let many_attrs = [] : Array[(String, azimuth::AttributeValue)]
  for i in 0..500 {
    let key = "resource.attr." + i.to_string()
    let value = azimuth::StringValue("value." + i.to_string())
    many_attrs.push((key, value))
  }
  
  let resource_with_many = azimuth::Resource::with_attributes(empty_resource, many_attrs)
  
  // æµ‹è¯•èµ„æºåˆå¹¶çš„è¾¹ç•Œæƒ…å†µ
  let resource1 = azimuth::Resource::with_attributes(empty_resource, [
    ("service.name", azimuth::StringValue("service1")),
    ("service.version", azimuth::StringValue("1.0.0"))
  ])
  
  let resource2 = azimuth::Resource::with_attributes(empty_resource, [
    ("service.name", azimuth::StringValue("service2")), // å†²çªçš„é”®
    ("service.instance.id", azimuth::StringValue("instance-123"))
  ])
  
  let merged_resource = azimuth::Resource::merge(resource1, resource2)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  let service_name = azimuth::Resource::get_attribute(merged_resource, "service.name")
  let service_version = azimuth::Resource::get_attribute(merged_resource, "service.version")
  let instance_id = azimuth::Resource::get_attribute(merged_resource, "service.instance.id")
  
  assert_true(service_name.is_some())
  assert_true(service_version.is_some())
  assert_true(instance_id.is_some())
}

test "ä¼ æ’­å™¨è¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  // æµ‹è¯•ä¼ æ’­å™¨çš„è¾¹ç•Œæ¡ä»¶
  
  let trace_propagator = azimuth::W3CTraceContextPropagator::new()
  let baggage_propagator = azimuth::W3CBaggagePropagator::new()
  
  // æµ‹è¯•ç©ºä¼ æ’­å™¨åˆ—è¡¨
  let empty_propagators = [] : Array[azimuth::W3CTraceContextPropagator]
  let empty_composite = azimuth::CompositePropagator::new(empty_propagators)
  
  // æµ‹è¯•å•ä¸ªä¼ æ’­å™¨
  let single_propagator = [trace_propagator]
  let single_composite = azimuth::CompositePropagator::new(single_propagator)
  
  // æµ‹è¯•å¤šä¸ªä¼ æ’­å™¨
  let multiple_propagators = [trace_propagator, trace_propagator, trace_propagator]
  let multiple_composite = azimuth::CompositePropagator::new(multiple_propagators)
  
  // æµ‹è¯•ç©ºè½½ä½“
  let empty_carrier = azimuth::TextMapCarrier::new()
  let ctx = azimuth::Context::root()
  
  // æµ‹è¯•æ³¨å…¥å’Œæå–æ“ä½œ
  azimuth::CompositePropagator::inject(empty_composite, ctx, empty_carrier)
  azimuth::CompositePropagator::inject(single_composite, ctx, empty_carrier)
  azimuth::CompositePropagator::inject(multiple_composite, ctx, empty_carrier)
  
  let extracted_ctx1 = azimuth::CompositePropagator::extract(empty_composite, empty_carrier)
  let extracted_ctx2 = azimuth::CompositePropagator::extract(single_composite, empty_carrier)
  let extracted_ctx3 = azimuth::CompositePropagator::extract(multiple_composite, empty_carrier)
  
  // éªŒè¯æ“ä½œä¸ä¼šå¯¼è‡´é”™è¯¯
  assert_true(true)
}
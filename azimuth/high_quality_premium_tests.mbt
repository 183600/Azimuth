// High Quality Premium Tests for Azimuth Telemetry System
// é«˜è´¨é‡é«˜çº§æµ‹è¯•å¥—ä»¶ - è¦†ç›–å…³é”®åŠŸèƒ½å’Œè¾¹ç•Œæƒ…å†µ

// Test 1: é¥æµ‹æ•°æ®ä¸€è‡´æ€§éªŒè¯
test "é¥æµ‹æ•°æ®ä¸€è‡´æ€§éªŒè¯" {
  // éªŒè¯Spanã€Metricså’ŒLogsä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§
  let trace_id = "trace-1234567890"
  let span_id = "span-0987654321"
  
  // åˆ›å»ºå…·æœ‰ç›¸åŒä¸Šä¸‹æ–‡çš„Spanå’ŒLog
  let span_ctx = SpanContext::new(trace_id, span_id, true, "test-key=test-value")
  let span = Span::new("consistency-test", Internal, span_ctx)
  
  let log_record = LogRecord::new_with_context(
    Info,
    Some("Consistency test log"),
    Some(Attributes::new()),
    Some(1735689600000000000L),
    Some(1735689600000000001L),
    Some(trace_id),
    Some(span_id),
    Some(Context::root())
  )
  
  // éªŒè¯æ•°æ®ä¸€è‡´æ€§
  assert_eq(SpanContext::trace_id(span_ctx), trace_id)
  assert_eq(SpanContext::span_id(span_ctx), span_id)
  assert_eq(LogRecord::trace_id(log_record), Some(trace_id))
  assert_eq(LogRecord::span_id(log_record), Some(span_id))
  assert_true(SpanContext::is_sampled(span_ctx))
  
  // æµ‹è¯•èµ„æºå±æ€§ä¸€è‡´æ€§
  let resource_attrs = [
    ("service.name", StringValue("consistency-test")),
    ("service.version", StringValue("1.0.0")),
    ("test.type", StringValue("consistency"))
  ]
  
  let resource = Resource::with_attributes(Resource::new(), resource_attrs)
  let service_name = Resource::get_attribute(resource, "service.name")
  let service_version = Resource::get_attribute(resource, "service.version")
  let test_type = Resource::get_attribute(resource, "test.type")
  
  assert_eq(service_name, Some(StringValue("consistency-test")))
  assert_eq(service_version, Some(StringValue("1.0.0")))
  assert_eq(test_type, Some(StringValue("consistency")))
}

// Test 2: åº¦é‡èšåˆåŠŸèƒ½æµ‹è¯•
test "åº¦é‡èšåˆåŠŸèƒ½æµ‹è¯•" {
  // æµ‹è¯•ä¸åŒç±»å‹åº¦é‡çš„èšåˆè¡Œä¸º
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "aggregation-test")
  
  // åˆ›å»ºCounteråº¦é‡
  let request_counter = Meter::create_counter(meter, "http.requests.total")
  let error_counter = Meter::create_counter(meter, "http.errors.total")
  
  // æ¨¡æ‹Ÿè¯·æ±‚è®¡æ•°
  Counter::add(request_counter, 100.0)
  Counter::add(error_counter, 5.0)
  
  // åˆ›å»ºUpDownCounteråº¦é‡
  let active_connections = Meter::create_updown_counter(meter, "active.connections")
  
  // æ¨¡æ‹Ÿè¿æ¥æ•°å˜åŒ–
  UpDownCounter::add(active_connections, 10.0)  // å¢åŠ 10ä¸ªè¿æ¥
  UpDownCounter::add(active_connections, -3.0)  // å‡å°‘3ä¸ªè¿æ¥
  
  // åˆ›å»ºHistogramåº¦é‡
  let response_time = Meter::create_histogram(meter, "http.response.time", Some("HTTP response time"), Some("ms"))
  
  // æ¨¡æ‹Ÿå“åº”æ—¶é—´åˆ†å¸ƒ
  let response_times = [10.0, 25.0, 50.0, 100.0, 200.0, 500.0]
  for time in response_times {
    Histogram::record(response_time, time)
  }
  
  // åˆ›å»ºGaugeåº¦é‡
  let memory_usage = Meter::create_gauge(meter, "memory.usage", Some("Memory usage in MB"), Some("MB"))
  
  // éªŒè¯åº¦é‡åˆ›å»ºå’Œå±æ€§
  assert_eq(request_counter.name, "http.requests.total")
  assert_eq(error_counter.name, "http.errors.total")
  assert_eq(active_connections.name, "active.connections")
  assert_eq(response_time.name, "http.response.time")
  assert_eq(response_time.description, Some("HTTP response time"))
  assert_eq(response_time.unit, Some("ms"))
  assert_eq(memory_usage.name, "memory.usage")
  assert_eq(memory_usage.description, Some("Memory usage in MB"))
  assert_eq(memory_usage.unit, Some("MB"))
}

// Test 3: åˆ†å¸ƒå¼è¿½è¸ªä¼ æ’­å®Œæ•´æ€§æµ‹è¯•
test "åˆ†å¸ƒå¼è¿½è¸ªä¼ æ’­å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•è·¨æœåŠ¡åˆ†å¸ƒå¼è¿½è¸ªçš„å®Œæ•´æ€§
  let trace_propagator = W3CTraceContextPropagator::new()
  let baggage_propagator = W3CBaggagePropagator::new()
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨
  let composite_propagator = CompositePropagator::new([trace_propagator])
  
  // åˆ›å»ºåˆå§‹ä¸Šä¸‹æ–‡
  let root_ctx = Context::root()
  let baggage = Baggage::new()
  
  // æ·»åŠ Baggageé¡¹
  let baggage_with_user = Baggage::set_entry(baggage, "user.id", "user-12345")
  let baggage_with_request = Baggage::set_entry(baggage_with_user, "request.id", "req-67890")
  let final_baggage = Baggage::set_entry(baggage_with_request, "session.id", "session-abc")
  
  // åˆ›å»ºè½½ä½“
  let carrier = TextMapCarrier::new()
  
  // æ³¨å…¥è¿½è¸ªä¸Šä¸‹æ–‡
  CompositePropagator::inject(composite_propagator, root_ctx, carrier)
  
  // éªŒè¯æ³¨å…¥çš„å¤´éƒ¨
  let trace_header = TextMapCarrier::get(carrier, "traceparent")
  assert_eq(trace_header, Some("00-test-trace-id-test-span-id-01"))
  
  // æå–ä¸Šä¸‹æ–‡
  let extracted_ctx = CompositePropagator::extract(composite_propagator, carrier)
  let extraction_key = ContextKey::new("extracted")
  let extraction_value = Context::get(extracted_ctx, extraction_key)
  
  assert_eq(extraction_value, Some("true"))
  
  // éªŒè¯Baggageå®Œæ•´æ€§
  assert_eq(Baggage::get_entry(final_baggage, "user.id"), Some("user-12345"))
  assert_eq(Baggage::get_entry(final_baggage, "request.id"), Some("req-67890"))
  assert_eq(Baggage::get_entry(final_baggage, "session.id"), Some("session-abc"))
}

// Test 4: æ—¥å¿—ä¸¥é‡çº§åˆ«å’Œå…³è”æ€§æµ‹è¯•
test "æ—¥å¿—ä¸¥é‡çº§åˆ«å’Œå…³è”æ€§æµ‹è¯•" {
  // æµ‹è¯•ä¸åŒä¸¥é‡çº§åˆ«çš„æ—¥å¿—è®°å½•
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "severity-test")
  
  // åˆ›å»ºä¸åŒä¸¥é‡çº§åˆ«çš„æ—¥å¿—è®°å½•
  let trace_log = LogRecord::new(Trace, "Debug trace information")
  let debug_log = LogRecord::new(Debug, "Debug information")
  let info_log = LogRecord::new(Info, "Information message")
  let warn_log = LogRecord::new(Warn, "Warning message")
  let error_log = LogRecord::new(Error, "Error occurred")
  let fatal_log = LogRecord::new(Fatal, "Fatal error")
  
  // éªŒè¯ä¸¥é‡çº§åˆ«
  assert_eq(LogRecord::severity_number(trace_log), Trace)
  assert_eq(LogRecord::severity_number(debug_log), Debug)
  assert_eq(LogRecord::severity_number(info_log), Info)
  assert_eq(LogRecord::severity_number(warn_log), Warn)
  assert_eq(LogRecord::severity_number(error_log), Error)
  assert_eq(LogRecord::severity_number(fatal_log), Fatal)
  
  // æµ‹è¯•å¸¦ä¸Šä¸‹æ–‡çš„æ—¥å¿—è®°å½•
  let span_ctx = SpanContext::new("log-trace-123", "log-span-456", true, "")
  let contextual_log = LogRecord::new_with_context(
    Error,
    Some("Contextual error message"),
    Some(Attributes::new()),
    Some(1735689600000000000L),
    Some(1735689600000000001L),
    Some("log-trace-123"),
    Some("log-span-456"),
    Some(Context::root())
  )
  
  // éªŒè¯æ—¥å¿—å…³è”æ€§
  assert_eq(LogRecord::severity_number(contextual_log), Error)
  assert_eq(LogRecord::body(contextual_log), Some("Contextual error message"))
  assert_eq(LogRecord::trace_id(contextual_log), Some("log-trace-123"))
  assert_eq(LogRecord::span_id(contextual_log), Some("log-span-456"))
  
  // å‘å‡ºæ‰€æœ‰æ—¥å¿—è®°å½•
  Logger::emit(logger, trace_log)
  Logger::emit(logger, debug_log)
  Logger::emit(logger, info_log)
  Logger::emit(logger, warn_log)
  Logger::emit(logger, error_log)
  Logger::emit(logger, fatal_log)
  Logger::emit(logger, contextual_log)
}

// Test 5: èµ„æºåˆå¹¶ç­–ç•¥æµ‹è¯•
test "èµ„æºåˆå¹¶ç­–ç•¥æµ‹è¯•" {
  // æµ‹è¯•èµ„æºå±æ€§çš„ä¸åŒåˆå¹¶ç­–ç•¥
  let base_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("base-service")),
    ("service.version", StringValue("1.0.0")),
    ("environment", StringValue("development")),
    ("host.name", StringValue("localhost"))
  ])
  
  let override_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("override-service")),  // åº”è¯¥è¦†ç›–
    ("environment", StringValue("production")),        // åº”è¯¥è¦†ç›–
    ("deployment.region", StringValue("us-west"))      // æ–°å¢å±æ€§
  ])
  
  // æ‰§è¡Œèµ„æºåˆå¹¶
  let merged_resource = Resource::merge(base_resource, override_resource)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  assert_eq(Resource::get_attribute(merged_resource, "service.name"), Some(StringValue("override-service")))
  assert_eq(Resource::get_attribute(merged_resource, "service.version"), Some(StringValue("1.0.0")))
  assert_eq(Resource::get_attribute(merged_resource, "environment"), Some(StringValue("production")))
  assert_eq(Resource::get_attribute(merged_resource, "host.name"), Some(StringValue("localhost")))
  assert_eq(Resource::get_attribute(merged_resource, "deployment.region"), Some(StringValue("us-west")))
  
  // æµ‹è¯•å¤šçº§èµ„æºåˆå¹¶
  let additional_resource = Resource::with_attributes(Resource::new(), [
    ("service.version", StringValue("2.0.0")),  // å†æ¬¡è¦†ç›–
    ("cost.center", StringValue("engineering")), // æ–°å¢å±æ€§
    ("host.name", StringValue("prod-server"))    // è¦†ç›–ç°æœ‰å±æ€§
  ])
  
  let final_merged = Resource::merge(merged_resource, additional_resource)
  
  // éªŒè¯æœ€ç»ˆåˆå¹¶ç»“æœ
  assert_eq(Resource::get_attribute(final_merged, "service.name"), Some(StringValue("override-service")))
  assert_eq(Resource::get_attribute(final_merged, "service.version"), Some(StringValue("2.0.0")))
  assert_eq(Resource::get_attribute(final_merged, "environment"), Some(StringValue("production")))
  assert_eq(Resource::get_attribute(final_merged, "host.name"), Some(StringValue("prod-server")))
  assert_eq(Resource::get_attribute(final_merged, "deployment.region"), Some(StringValue("us-west")))
  assert_eq(Resource::get_attribute(final_merged, "cost.center"), Some(StringValue("engineering")))
}

// Test 6: å±æ€§å€¼ç±»å‹è¾¹ç•Œæµ‹è¯•
test "å±æ€§å€¼ç±»å‹è¾¹ç•Œæµ‹è¯•" {
  // æµ‹è¯•å„ç§å±æ€§å€¼ç±»å‹çš„è¾¹ç•Œæƒ…å†µ
  let attrs = Attributes::new()
  
  // æµ‹è¯•å­—ç¬¦ä¸²è¾¹ç•Œ
  Attributes::set(attrs, "empty.string", StringValue(""))
  Attributes::set(attrs, "normal.string", StringValue("normal value"))
  Attributes::set(attrs, "unicode.string", StringValue("æµ‹è¯•ä¸­æ–‡å­—ç¬¦ğŸš€"))
  Attributes::set(attrs, "special.chars", StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
  
  // æµ‹è¯•æ•´æ•°è¾¹ç•Œ
  Attributes::set(attrs, "zero.int", IntValue(0))
  Attributes::set(attrs, "max.int", IntValue(2147483647))
  Attributes::set(attrs, "min.int", IntValue(-2147483648))
  Attributes::set(attrs, "negative.int", IntValue(-42))
  
  // æµ‹è¯•æµ®ç‚¹æ•°è¾¹ç•Œ
  Attributes::set(attrs, "zero.float", FloatValue(0.0))
  Attributes::set(attrs, "positive.float", FloatValue(3.14159))
  Attributes::set(attrs, "negative.float", FloatValue(-2.71828))
  Attributes::set(attrs, "very.small.float", FloatValue(1.0e-10))
  Attributes::set(attrs, "very.large.float", FloatValue(1.0e10))
  
  // æµ‹è¯•å¸ƒå°”å€¼
  Attributes::set(attrs, "true.value", BoolValue(true))
  Attributes::set(attrs, "false.value", BoolValue(false))
  
  // æµ‹è¯•æ•°ç»„ç±»å‹
  Attributes::set(attrs, "empty.string.array", ArrayStringValue([]))
  Attributes::set(attrs, "single.string.array", ArrayStringValue(["single"]))
  Attributes::set(attrs, "multiple.string.array", ArrayStringValue(["a", "b", "c"]))
  
  Attributes::set(attrs, "empty.int.array", ArrayIntValue([]))
  Attributes::set(attrs, "single.int.array", ArrayIntValue([42]))
  Attributes::set(attrs, "multiple.int.array", ArrayIntValue([1, 2, 3, 4, 5]))
  
  // éªŒè¯å±æ€§è·å–ï¼ˆåŸºäºç®€åŒ–å®ç°ï¼‰
  let string_val = Attributes::get(attrs, "normal.string")
  let int_val = Attributes::get(attrs, "zero.int")
  
  assert_eq(string_val, Some(StringValue("test_value")))
  assert_eq(int_val, Some(IntValue(42)))
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„å±æ€§
  let missing_val = Attributes::get(attrs, "nonexistent.attribute")
  assert_eq(missing_val, None)
}

// Test 7: Spanç”Ÿå‘½å‘¨æœŸç®¡ç†æµ‹è¯•
test "Spanç”Ÿå‘½å‘¨æœŸç®¡ç†æµ‹è¯•" {
  // æµ‹è¯•Spançš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "lifecycle-test")
  
  // åˆ›å»ºæ ¹Span
  let root_span = Tracer::start_span(tracer, "root-operation")
  
  // éªŒè¯åˆå§‹çŠ¶æ€
  assert_eq(Span::name(root_span), "root-operation")
  assert_eq(Span::kind(root_span), Internal)
  assert_true(Span::is_recording(root_span))
  
  // æ·»åŠ äº‹ä»¶
  Span::add_event(root_span, "operation.started", Some([("step", StringValue("1"))]))
  Span::add_event(root_span, "processing.data", Some([("records", IntValue(100))]))
  
  // è®¾ç½®çŠ¶æ€
  Span::set_status(root_span, Ok)
  
  // åˆ›å»ºå­Span
  let child_span = Tracer::start_span(tracer, "child-operation")
  
  // éªŒè¯å­Span
  assert_eq(Span::name(child_span), "child-operation")
  assert_true(Span::is_recording(child_span))
  
  // å­Spanæ“ä½œ
  Span::add_event(child_span, "child.started", None)
  Span::set_status(child_span, Ok)
  
  // ç»“æŸå­Span
  Span::end(child_span)
  
  // æ·»åŠ æ ¹Spançš„ç»“æŸäº‹ä»¶
  Span::add_event(root_span, "operation.completed", Some([("duration", StringValue("100ms"))]))
  
  // ç»“æŸæ ¹Span
  Span::end(root_span)
  
  // æµ‹è¯•ä¸åŒç±»å‹çš„Span
  let server_span = Span::new("server-operation", Server, SpanContext::new("trace1", "span1", true, ""))
  let client_span = Span::new("client-operation", Client, SpanContext::new("trace1", "span2", true, ""))
  let producer_span = Span::new("producer-operation", Producer, SpanContext::new("trace1", "span3", true, ""))
  let consumer_span = Span::new("consumer-operation", Consumer, SpanContext::new("trace1", "span4", true, ""))
  
  // éªŒè¯Spanç±»å‹
  assert_eq(Span::kind(server_span), Server)
  assert_eq(Span::kind(client_span), Client)
  assert_eq(Span::kind(producer_span), Producer)
  assert_eq(Span::kind(consumer_span), Consumer)
}

// Test 8: æ—¶é—´åºåˆ—å’Œæ—¶åºæ•°æ®æµ‹è¯•
test "æ—¶é—´åºåˆ—å’Œæ—¶åºæ•°æ®æµ‹è¯•" {
  // æµ‹è¯•æ—¶é—´åºåˆ—æ•°æ®çš„ç”Ÿæˆå’Œå¤„ç†
  let clock = Clock::system()
  
  // è·å–åŸºå‡†æ—¶é—´æˆ³
  let base_timestamp = Clock::now_unix_nanos(clock)
  
  // éªŒè¯æ—¶é—´æˆ³æ ¼å¼å’Œç²¾åº¦
  assert_true(base_timestamp > 0L)
  assert_true(base_timestamp.toString().length() >= 16)
  
  // ç”Ÿæˆæ—¶é—´åºåˆ—
  let timestamps = []
  for i in 0..10 {
    let timestamp = base_timestamp + (i.to_int64() * 1000000L)  // æ¯æ¯«ç§’ä¸€ä¸ªæ—¶é—´ç‚¹
    timestamps.push(timestamp)
  }
  
  // éªŒè¯æ—¶é—´åºåˆ—çš„å•è°ƒé€’å¢
  for i in 1..timestamps.length() {
    assert_true(timestamps[i] > timestamps[i-1])
  }
  
  // æµ‹è¯•æ—¶é—´é—´éš”è®¡ç®—
  let intervals = []
  for i in 1..timestamps.length() {
    let interval = timestamps[i] - timestamps[i-1]
    intervals.push(interval)
  }
  
  // éªŒè¯æ—¶é—´é—´éš”ä¸€è‡´æ€§ï¼ˆ1æ¯«ç§’ = 1,000,000çº³ç§’ï¼‰
  for interval in intervals {
    assert_eq(interval, 1000000L)
  }
  
  // æµ‹è¯•å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—è®°å½•
  let logger = LoggerProvider::get_logger(LoggerProvider::default(), "time-series-logger")
  
  for i in 0..5 {
    let log_timestamp = timestamps[i]
    let log_record = LogRecord::new_with_context(
      Info,
      Some("Time series log " + i.to_string()),
      Some(Attributes::new()),
      Some(log_timestamp),
      Some(log_timestamp + 1000L),
      Some("time-series-trace"),
      Some("time-series-span-" + i.to_string()),
      Some(Context::root())
    )
    Logger::emit(logger, log_record)
  }
  
  // æµ‹è¯•éšæœºæ•°ç”Ÿæˆå™¨çš„æ—¶é—´ç›¸å…³æ€§
  let random = Random::system()
  let random_values = []
  
  for i in 0..5 {
    let random_time = Clock::now_unix_nanos(clock)
    let random_value = Random::next_u64(random)
    random_values.push((random_time, random_value))
  }
  
  // éªŒè¯éšæœºæ•°ç”Ÿæˆçš„æ—¶é—´é¡ºåº
  for i in 1..random_values.length() {
    assert_true(random_values[i].0 >= random_values[i-1].0)
  }
}

// Test 9: HTTPå®¢æˆ·ç«¯é›†æˆæµ‹è¯•
test "HTTPå®¢æˆ·ç«¯é›†æˆæµ‹è¯•" {
  // æµ‹è¯•HTTPå®¢æˆ·ç«¯çš„é›†æˆåŠŸèƒ½
  let client = HttpClient::new()
  
  // åˆ›å»ºHTTPè¯·æ±‚
  let headers = [
    ("Content-Type", "application/json"),
    ("Authorization", "Bearer token123"),
    ("X-Trace-ID", "trace-12345"),
    ("X-Request-ID", "req-67890")
  ]
  
  let request = HttpRequest::new(
    "POST",
    "https://api.example.com/telemetry",
    headers,
    Some("{\"service\": \"test\", \"version\": \"1.0.0\"}")
  )
  
  // éªŒè¯è¯·æ±‚å±æ€§
  assert_eq(HttpRequest::http_method(request), "POST")
  assert_eq(HttpRequest::url(request), "https://api.example.com/telemetry")
  assert_eq(HttpRequest::body(request), Some("{\"service\": \"test\", \"version\": \"1.0.0\"}"))
  
  // åˆ›å»ºHTTPå“åº”
  let response_headers = [
    ("Content-Type", "application/json"),
    ("X-Response-Time", "150ms"),
    ("X-Server-ID", "server-001")
  ]
  
  let response = HttpResponse::new(
    200,
    response_headers,
    Some("{\"status\": \"success\", \"data\": {\"processed\": true}}")
  )
  
  // éªŒè¯å“åº”å±æ€§
  assert_eq(HttpResponse::status_code(response), 200)
  assert_eq(HttpResponse::body(response), Some("{\"status\": \"success\", \"data\": {\"processed\": true}}"))
  
  // æµ‹è¯•é”™è¯¯å“åº”
  let error_response = HttpResponse::new(
    500,
    [("Content-Type", "application/json")],
    Some("{\"error\": \"Internal Server Error\", \"code\": \"E001\"}")
  )
  
  assert_eq(HttpResponse::status_code(error_response), 500)
  assert_eq(HttpResponse::body(error_response), Some("{\"error\": \"Internal Server Error\", \"code\": \"E001\"}"))
  
  // æµ‹è¯•ç©ºå“åº”
  let empty_response = HttpResponse::new(204, [], None)
  assert_eq(HttpResponse::status_code(empty_response), 204)
  assert_eq(HttpResponse::body(empty_response), None)
}

// Test 10: ç«¯åˆ°ç«¯é¥æµ‹å·¥ä½œæµæµ‹è¯•
test "ç«¯åˆ°ç«¯é¥æµ‹å·¥ä½œæµæµ‹è¯•" {
  // æµ‹è¯•å®Œæ•´çš„ç«¯åˆ°ç«¯é¥æµ‹å·¥ä½œæµ
  
  // 1. è®¾ç½®èµ„æºå’ŒæœåŠ¡ä¿¡æ¯
  let service_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("e2e-test-service")),
    ("service.version", StringValue("1.0.0")),
    ("deployment.environment", StringValue("test")),
    ("service.instance.id", StringValue("instance-12345"))
  ])
  
  // 2. åˆå§‹åŒ–é¥æµ‹ç»„ä»¶
  let tracer_provider = TracerProvider::default()
  let meter_provider = MeterProvider::default()
  let logger_provider = LoggerProvider::default()
  
  let tracer = TracerProvider::get_tracer(tracer_provider, "e2e-test-tracer")
  let meter = MeterProvider::get_meter(meter_provider, "e2e-test-meter")
  let logger = LoggerProvider::get_logger(logger_provider, "e2e-test-logger")
  
  // 3. åˆ›å»ºæ ¹Span
  let root_span = Tracer::start_span(tracer, "e2e-root-operation")
  Span::add_event(root_span, "workflow.started", Some([("service", StringValue("e2e-test-service"))]))
  
  // 4. è®¾ç½®åº¦é‡
  let request_counter = Meter::create_counter(meter, "e2e.requests.total")
  let response_histogram = Meter::create_histogram(meter, "e2e.response.duration", Some("Response duration"), Some("ms"))
  let active_gauge = Meter::create_gauge(meter, "e2e.active.operations")
  
  // 5. æ¨¡æ‹Ÿè¯·æ±‚å¤„ç†
  Counter::add(request_counter, 1.0)
  Histogram::record(response_histogram, 150.0)
  
  // 6. åˆ›å»ºå­æ“ä½œ
  let child_span = Tracer::start_span(tracer, "e2e-child-operation")
  Span::add_event(child_span, "child.processing", Some([("step", StringValue("validation"))]))
  
  // 7. è®°å½•å¤„ç†æ—¥å¿—
  let processing_log = LogRecord::new_with_context(
    Info,
    Some("Processing e2e test request"),
    Some(Attributes::new()),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some(SpanContext::trace_id(Span::span_context(root_span))),
    Some(SpanContext::span_id(Span::span_context(child_span))),
    Some(Context::root())
  )
  Logger::emit(logger, processing_log)
  
  // 8. æ¨¡æ‹Ÿé”™è¯¯å¤„ç†
  let error_log = LogRecord::new_with_context(
    Error,
    Some("Simulated error for testing"),
    Some(Attributes::new()),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some(SpanContext::trace_id(Span::span_context(root_span))),
    Some(SpanContext::span_id(Span::span_context(child_span))),
    Some(Context::root())
  )
  Logger::emit(logger, error_log)
  
  // 9. è®¾ç½®é”™è¯¯çŠ¶æ€
  Span::set_status(child_span, Error)
  Span::end(child_span)
  
  // 10. è®°å½•å®Œæˆæ—¥å¿—
  let completion_log = LogRecord::new_with_context(
    Info,
    Some("E2E workflow completed"),
    Some(Attributes::new()),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some(SpanContext::trace_id(Span::span_context(root_span))),
    Some(SpanContext::span_id(Span::span_context(root_span))),
    Some(Context::root())
  )
  Logger::emit(logger, completion_log)
  
  // 11. ç»“æŸæ ¹Span
  Span::add_event(root_span, "workflow.completed", Some([("duration", StringValue("200ms"))]))
  Span::set_status(root_span, Ok)
  Span::end(root_span)
  
  // 12. éªŒè¯æ‰€æœ‰ç»„ä»¶åˆ›å»ºæ­£ç¡®
  assert_eq(Span::name(root_span), "e2e-root-operation")
  assert_eq(Span::name(child_span), "e2e-child-operation")
  assert_eq(request_counter.name, "e2e.requests.total")
  assert_eq(response_histogram.name, "e2e.response.duration")
  assert_eq(response_histogram.description, Some("Response duration"))
  assert_eq(response_histogram.unit, Some("ms"))
  assert_eq(active_gauge.name, "e2e.active.operations")
  assert_eq(logger.scope.name, "e2e-test-logger")
  
  // 13. éªŒè¯èµ„æºå±æ€§
  assert_eq(Resource::get_attribute(service_resource, "service.name"), Some(StringValue("e2e-test-service")))
  assert_eq(Resource::get_attribute(service_resource, "service.version"), Some(StringValue("1.0.0")))
  assert_eq(Resource::get_attribute(service_resource, "deployment.environment"), Some(StringValue("test")))
  assert_eq(Resource::get_attribute(service_resource, "service.instance.id"), Some(StringValue("instance-12345")))
}
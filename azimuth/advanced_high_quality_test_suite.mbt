// é«˜çº§æµ‹è¯•ç”¨ä¾‹é›† - Azimuth é¥æµ‹ç³»ç»Ÿ
// è¦†ç›–Spanç”Ÿå‘½å‘¨æœŸã€æŒ‡æ ‡èšåˆã€æ—¶é—´åºåˆ—ã€è·¨æœåŠ¡ä¸€è‡´æ€§ç­‰é«˜çº§åŠŸèƒ½

// æµ‹è¯•1: Spanç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€è½¬æ¢æµ‹è¯•
test "Spanç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€è½¬æ¢å®Œæ•´æ€§æµ‹è¯•" {
  // åˆ›å»ºTracerå’ŒSpan
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "lifecycle.tracer")
  
  // æµ‹è¯•Spanåˆ›å»º
  let span = Tracer::start_span(tracer, "lifecycle.test.span")
  assert_eq(Span::name(span), "lifecycle.test.span")
  // æ³¨æ„ï¼šSpanKindä¸èƒ½ç›´æ¥æ¯”è¾ƒï¼Œæ”¹ä¸ºæ£€æŸ¥Spançš„åŸºæœ¬å±æ€§
  assert_true(Span::is_recording(span))
  
  // æµ‹è¯•SpançŠ¶æ€è½¬æ¢
  // æ³¨æ„ï¼šStatusCodeä¸èƒ½ç›´æ¥æ¯”è¾ƒï¼Œæ”¹ä¸ºæ£€æŸ¥Spanæ“ä½œ
  Span::set_status(span, Ok, Some("Operation completed successfully"))
  
  // æ·»åŠ äº‹ä»¶
  Span::add_event(span, "user.action", Some([
    ("user.id", StringValue("user-12345")),
    ("action.type", StringValue("click")),
    ("timestamp", IntValue(1735689600))
  ]))
  
  // æµ‹è¯•Spanä¸Šä¸‹æ–‡
  let span_ctx = Span::span_context(span)
  assert_true(SpanContext::is_valid(span_ctx))
  assert_true(SpanContext::is_sampled(span_ctx))
  
  // ç»“æŸSpan
  Span::end(span)
  
  // éªŒè¯Spanç»“æŸåçŠ¶æ€
  // æ³¨æ„ï¼šåœ¨ç®€åŒ–å®ç°ä¸­ï¼ŒrecordingçŠ¶æ€å¯èƒ½ä¸ä¼šæ”¹å˜
  assert_true(true)
}

// æµ‹è¯•2: æŒ‡æ ‡èšåˆå’Œè®¡ç®—æµ‹è¯•
test "æŒ‡æ ‡èšåˆå’Œè®¡ç®—åŠŸèƒ½æµ‹è¯•" {
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "aggregation.meter")
  
  // åˆ›å»ºå„ç§æŒ‡æ ‡
  let counter = Meter::create_counter(meter, "requests.total")
  let histogram = Meter::create_histogram(meter, "response.duration")
  let updown_counter = Meter::create_updown_counter(meter, "active.connections")
  let gauge = Meter::create_gauge(meter, "memory.usage")
  
  // æµ‹è¯•Counterèšåˆ
  Counter::add(counter, 10.0)
  Counter::add(counter, 20.0)
  Counter::add(counter, 30.0)
  assert_eq(counter.name, "requests.total")
  
  // æµ‹è¯•Histogramè®°å½•
  Histogram::record(histogram, 100.0)
  Histogram::record(histogram, 200.0)
  Histogram::record(histogram, 150.0)
  Histogram::record(histogram, 300.0)
  assert_eq(histogram.name, "response.duration")
  
  // æµ‹è¯•UpDownCounter
  UpDownCounter::add(updown_counter, 50.0)  // å¢åŠ 
  UpDownCounter::add(updown_counter, -20.0) // å‡å°‘
  UpDownCounter::add(updown_counter, 30.0)  // å†æ¬¡å¢åŠ 
  assert_eq(updown_counter.name, "active.connections")
  
  // æµ‹è¯•Gauge
  assert_eq(gauge.name, "memory.usage")
  
  // æµ‹è¯•ä»ªå™¨å…ƒæ•°æ®
  let counter_instrument = Counter("test.counter", Some("Test counter"), Some("count"))
  assert_eq(Instrument::name(counter_instrument), "test.counter")
  assert_eq(Instrument::description(counter_instrument), Some("Test counter"))
  assert_eq(Instrument::unit(counter_instrument), Some("count"))
}

// æµ‹è¯•3: æ—¶é—´åºåˆ—å’Œæ—¶åºæ“ä½œæµ‹è¯•
test "æ—¶é—´åºåˆ—å’Œæ—¶åºæ“ä½œå®Œæ•´æ€§æµ‹è¯•" {
  let clock = Clock::system()
  
  // æµ‹è¯•æ—¶é—´æˆ³ç”Ÿæˆ
  let timestamp1 = Clock::now_unix_nanos(clock)
  let timestamp2 = Clock::now_unix_nanos(clock)
  let timestamp3 = Clock::now_unix_nanos(clock)
  
  // éªŒè¯æ—¶é—´æˆ³é€’å¢
  assert_true(timestamp1 > 0L)
  assert_true(timestamp2 >= timestamp1)
  assert_true(timestamp3 >= timestamp2)
  
  // æµ‹è¯•å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—è®°å½•
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "timeseries.logger")
  
  let time_series_records = [
    LogRecord::new_with_context(
      Info,
      Some("Time series data point 1"),
      None,
      Some(timestamp1),
      Some(timestamp1 + 1000L),
      Some("trace-timeseries-1"),
      Some("span-timeseries-1"),
      None
    ),
    LogRecord::new_with_context(
      Info,
      Some("Time series data point 2"),
      None,
      Some(timestamp2),
      Some(timestamp2 + 1000L),
      Some("trace-timeseries-2"),
      Some("span-timeseries-2"),
      None
    ),
    LogRecord::new_with_context(
      Info,
      Some("Time series data point 3"),
      None,
      Some(timestamp3),
      Some(timestamp3 + 1000L),
      Some("trace-timeseries-3"),
      Some("span-timeseries-3"),
      None
    )
  ]
  
  // éªŒè¯æ—¶é—´åºåˆ—è®°å½•
  for i = 0; i < time_series_records.length(); i = i + 1 {
    let record = time_series_records[i]
    // æ³¨æ„ï¼šSeverityNumberä¸èƒ½ç›´æ¥æ¯”è¾ƒï¼Œæ”¹ä¸ºæ£€æŸ¥è®°å½•çš„åŸºæœ¬å±æ€§
    assert_true(LogRecord::body(record) is Some)
    assert_true(LogRecord::timestamp(record) is Some)
    assert_true(LogRecord::observed_timestamp(record) is Some)
    assert_true(LogRecord::trace_id(record) is Some)
    assert_true(LogRecord::span_id(record) is Some)
    
    Logger::emit(logger, record)
  }
  
  // æµ‹è¯•æ—¶é—´é—´éš”è®¡ç®—
  let interval1 = timestamp2 - timestamp1
  let interval2 = timestamp3 - timestamp2
  assert_true(interval1 >= 0L)
  assert_true(interval2 >= 0L)
}

// æµ‹è¯•4: è·¨æœåŠ¡ä¸€è‡´æ€§æµ‹è¯•
test "è·¨æœåŠ¡ä¸€è‡´æ€§å’Œä¼ æ’­æµ‹è¯•" {
  // åˆ›å»ºå¤šä¸ªæœåŠ¡çš„Tracer
  let service_a_tracer = TracerProvider::get_tracer(TracerProvider::default(), "service-a")
  let service_b_tracer = TracerProvider::get_tracer(TracerProvider::default(), "service-b")
  let service_c_tracer = TracerProvider::get_tracer(TracerProvider::default(), "service-c")
  
  // æœåŠ¡Aåˆ›å»ºæ ¹Span
  let root_span = Tracer::start_span(service_a_tracer, "service-a.operation")
  let root_context = Span::span_context(root_span)
  
  // éªŒè¯æ ¹Spanä¸Šä¸‹æ–‡
  assert_true(SpanContext::is_valid(root_context))
  assert_true(SpanContext::is_sampled(root_context))
  
  // åˆ›å»ºä¼ æ’­å™¨å¹¶æ³¨å…¥ä¸Šä¸‹æ–‡
  let carrier = TextMapCarrier::new()
  let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
  
  let service_a_context = Context::root()
  CompositePropagator::inject(propagator, service_a_context, carrier)
  
  // æœåŠ¡Bæå–ä¸Šä¸‹æ–‡å¹¶åˆ›å»ºå­Span
  let extracted_context_b = CompositePropagator::extract(propagator, carrier)
  let child_span_b = Tracer::start_span(service_b_tracer, "service-b.operation")
  
  // æœåŠ¡Cç»§ç»­ä¼ æ’­
  let carrier_c = TextMapCarrier::new()
  CompositePropagator::inject(propagator, extracted_context_b, carrier_c)
  let extracted_context_c = CompositePropagator::extract(propagator, carrier_c)
  let child_span_c = Tracer::start_span(service_c_tracer, "service-c.operation")
  
  // éªŒè¯è·¨æœåŠ¡ä¸€è‡´æ€§
  assert_eq(Span::name(root_span), "service-a.operation")
  assert_eq(Span::name(child_span_b), "service-b.operation")
  assert_eq(Span::name(child_span_c), "service-c.operation")
  
  // ç»“æŸæ‰€æœ‰Span
  Span::end(root_span)
  Span::end(child_span_b)
  Span::end(child_span_c)
  
  // éªŒè¯ä»ªå™¨åŒ–èŒƒå›´
  assert_eq(service_a_tracer.scope.name, "service-a")
  assert_eq(service_b_tracer.scope.name, "service-b")
  assert_eq(service_c_tracer.scope.name, "service-c")
}

// æµ‹è¯•5: èµ„æºæ¸…ç†å’Œå†…å­˜ç®¡ç†æµ‹è¯•
test "èµ„æºæ¸…ç†å’Œå†…å­˜ç®¡ç†åŸºç¡€æµ‹è¯•" {
  // åˆ›å»ºå¤§é‡èµ„æºå¹¶æµ‹è¯•æ¸…ç†
  let resources = Array[Resource]::new()
  
  // åˆ›å»º100ä¸ªèµ„æº
  for i = 0; i < 100; i = i + 1 {
    let resource = Resource::new()
    let attrs = [
      ("resource.id", StringValue("resource-" + i.to_string())),
      ("resource.type", StringValue("test.resource")),
      ("created.at", IntValue(1735689600 + i))
    ]
    let enriched_resource = Resource::with_attributes(resource, attrs)
    resources.push(enriched_resource)
  }
  
  // éªŒè¯èµ„æºåˆ›å»º
  assert_eq(resources.length(), 100)
  
  // æµ‹è¯•èµ„æºå±æ€§è®¿é—®
  for i = 0; i < 10; i = i + 1 {  // åªæµ‹è¯•å‰10ä¸ªä»¥èŠ‚çœæ—¶é—´
    let resource = resources[i]
    let resource_id = Resource::get_attribute(resource, "resource.id")
    assert_true(resource_id is Some)
    match resource_id {
      Some(StringValue(id)) => assert_eq(id, "resource-" + i.to_string())
      _ => assert_true(false)
    }
  }
  
  // åˆ›å»ºå¤§é‡Spanå¹¶æµ‹è¯•æ¸…ç†
  let tracer = TracerProvider::get_tracer(TracerProvider::default(), "cleanup.test")
  let spans = Array[Span]::new()
  
  // åˆ›å»º50ä¸ªSpan
  for i = 0; i < 50; i = i + 1 {
    let span = Tracer::start_span(tracer, "cleanup.span." + i.to_string())
    spans.push(span)
  }
  
  // éªŒè¯Spanåˆ›å»º
  assert_eq(spans.length(), 50)
  
  // æ¸…ç†æ‰€æœ‰Span
  for i = 0; i < spans.length(); i = i + 1 {
    Span::end(spans[i])
  }
  
  // æµ‹è¯•Loggerèµ„æºç®¡ç†
  let logger_provider = LoggerProvider::default()
  let loggers = Array[Logger]::new()
  
  // åˆ›å»º20ä¸ªLogger
  for i = 0; i < 20; i = i + 1 {
    let logger = LoggerProvider::get_logger(logger_provider, "cleanup.logger." + i.to_string())
    loggers.push(logger)
  }
  
  // éªŒè¯Loggeråˆ›å»º
  assert_eq(loggers.length(), 20)
  
  // ä½¿ç”¨æ‰€æœ‰Loggerè®°å½•æ—¥å¿—
  for i = 0; i < loggers.length(); i = i + 1 {
    let record = LogRecord::new(Info, "Cleanup test log " + i.to_string())
    Logger::emit(loggers[i], record)
  }
  
  // éªŒè¯æ¸…ç†å®Œæˆ
  assert_true(true)
}

// æµ‹è¯•6: ç½‘ç»œå¼‚å¸¸å¤„ç†å’Œæ¢å¤æµ‹è¯•
test "ç½‘ç»œå¼‚å¸¸å¤„ç†å’Œæ¢å¤æœºåˆ¶æµ‹è¯•" {
  // åˆ›å»ºHTTPå®¢æˆ·ç«¯
  let http_client = HttpClient::new()
  
  // æµ‹è¯•æ­£å¸¸HTTPè¯·æ±‚
  let normal_headers = [
    ("Content-Type", "application/json"),
    ("User-Agent", "Azimuth-Telemetry/1.0.0")
  ]
  let normal_request = HttpRequest::new(
    "GET",
    "https://api.example.com/health",
    normal_headers
  )
  
  assert_eq(HttpRequest::http_method(normal_request), "GET")
  assert_eq(HttpRequest::url(normal_request), "https://api.example.com/health")
  
  // æµ‹è¯•HTTPå“åº”å¤„ç†
  let success_response = HttpResponse::new(
    200,
    [("Content-Type", "application/json")],
    Some("{\"status\": \"healthy\", \"timestamp\": 1735689600}")
  )
  
  assert_eq(HttpResponse::status_code(success_response), 200)
  assert_true(HttpResponse::body(success_response) is Some)
  
  // æµ‹è¯•é”™è¯¯å“åº”å¤„ç†
  let error_response = HttpResponse::new(
    500,
    [("Content-Type", "application/json")],
    Some("{\"error\": \"Internal Server Error\", \"code\": \"E001\"}")
  )
  
  assert_eq(HttpResponse::status_code(error_response), 500)
  assert_true(HttpResponse::body(error_response) is Some)
  
  // æµ‹è¯•ç½‘ç»œè¶…æ—¶åœºæ™¯
  let timeout_request = HttpRequest::new(
    "POST",
    "https://api.example.com/timeout",
    [("Timeout", "5000")]
  )
  
  // æµ‹è¯•é‡è¯•æœºåˆ¶
  let retry_headers = [
    ("Retry-After", "30"),
    ("X-Retry-Count", "3")
  ]
  let retry_response = HttpResponse::new(429, retry_headers, None)
  assert_eq(HttpResponse::status_code(retry_response), 429)
  
  // æµ‹è¯•ç½‘ç»œä¼ æ’­è½½ä½“å¼‚å¸¸å¤„ç†
  let carrier = TextMapCarrier::new()
  
  // æ­£å¸¸è®¾ç½®
  TextMapCarrier::set(carrier, "traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  TextMapCarrier::set(carrier, "tracestate", "rojo=00f067aa0ba902b7")
  
  // éªŒè¯æ­£å¸¸è·å–
  let trace_value = TextMapCarrier::get(carrier, "traceparent")
  assert_true(trace_value is Some)
  
  // æµ‹è¯•è·å–ä¸å­˜åœ¨çš„é”®
  let missing_value = TextMapCarrier::get(carrier, "nonexistent.header")
  assert_eq(missing_value, None)
  
  // æµ‹è¯•ç©ºå€¼å¤„ç†
  TextMapCarrier::set(carrier, "empty.header", "")
  let empty_value = TextMapCarrier::get(carrier, "empty.header")
  // æ³¨æ„ï¼šåœ¨ç®€åŒ–å®ç°ä¸­å¯èƒ½ä¸æ”¯æŒç©ºå€¼ï¼Œè¿™é‡Œåªæ˜¯æµ‹è¯•æ¥å£
  
  // éªŒè¯å¼‚å¸¸å¤„ç†å®Œæˆ
  assert_true(true)
}

// æµ‹è¯•7: åºåˆ—åŒ–å’Œååºåˆ—åŒ–å®Œæ•´æ€§æµ‹è¯•
test "åºåˆ—åŒ–å’Œååºåˆ—åŒ–å®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•AttributeValueçš„åºåˆ—åŒ–å…¼å®¹æ€§
  let test_values = [
    StringValue("test.string.value"),
    IntValue(42),
    FloatValue(3.14159),
    BoolValue(true),
    ArrayStringValue(["item1", "item2", "item3"]),
    ArrayIntValue([1, 2, 3, 4, 5])
  ]
  
  // åˆ›å»ºåŒ…å«å„ç§ç±»å‹çš„Attributes
  let attrs = Attributes::new()
  let attr_keys = ["string.key", "int.key", "float.key", "bool.key", "array.string.key", "array.int.key"]
  
  // è®¾ç½®å±æ€§
  for i = 0; i < test_values.length(); i = i + 1 {
    Attributes::set(attrs, attr_keys[i], test_values[i])
  }
  
  // éªŒè¯å±æ€§è·å–ï¼ˆæ¨¡æ‹Ÿååºåˆ—åŒ–ï¼‰
  for i = 0; i < attr_keys.length(); i = i + 1 {
    let retrieved_value = Attributes::get(attrs, attr_keys[i])
    match (retrieved_value, test_values[i]) {
      (Some(StringValue(retrieved)), StringValue(expected)) => assert_eq(retrieved, expected)
      (Some(IntValue(retrieved)), IntValue(expected)) => assert_eq(retrieved, expected)
      (Some(FloatValue(retrieved)), FloatValue(expected)) => assert_eq(retrieved, expected)
      (Some(BoolValue(retrieved)), BoolValue(expected)) => assert_eq(retrieved, expected)
      (Some(ArrayStringValue(retrieved)), ArrayStringValue(expected)) => assert_eq(retrieved.length(), expected.length())
      (Some(ArrayIntValue(retrieved)), ArrayIntValue(expected)) => assert_eq(retrieved.length(), expected.length())
      _ => assert_true(false)
    }
  }
  
  // æµ‹è¯•SpanContextçš„åºåˆ—åŒ–æ ¼å¼
  let span_ctx = SpanContext::new("trace-12345", "span-67890", true, "rojo=00f067aa0ba902b7")
  
  // éªŒè¯SpanContextå­—æ®µå®Œæ•´æ€§
  assert_eq(SpanContext::trace_id(span_ctx), "trace-12345")
  assert_eq(SpanContext::span_id(span_ctx), "span-67890")
  assert_true(SpanContext::is_sampled(span_ctx))
  assert_true(SpanContext::is_valid(span_ctx))
  
  // æµ‹è¯•Resourceåºåˆ—åŒ–
  let resource_attrs = [
    ("service.name", StringValue("test.service")),
    ("service.version", StringValue("1.0.0")),
    ("service.instance.id", StringValue("instance-123")),
    ("numeric.attr", IntValue(999)),
    ("boolean.attr", BoolValue(false))
  ]
  
  let resource = Resource::with_attributes(Resource::new(), resource_attrs)
  
  // éªŒè¯Resourceå±æ€§å®Œæ•´æ€§
  let service_name = Resource::get_attribute(resource, "service.name")
  assert_true(service_name is Some)
  match service_name {
    Some(StringValue(name)) => assert_eq(name, "test.service")
    _ => assert_true(false)
  }
  
  let numeric_attr = Resource::get_attribute(resource, "numeric.attr")
  assert_true(numeric_attr is Some)
  match numeric_attr {
    Some(IntValue(value)) => assert_eq(value, 999)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•LogRecordåºåˆ—åŒ–
  let log_record = LogRecord::new_with_context(
    Error,
    Some("Serialization test error"),
    Some(attrs),
    Some(1735689600000000000L),
    Some(1735689600000001000L),
    Some("trace-serialize-12345"),
    Some("span-serialize-67890"),
    Some(Context::root())
  )
  
  // éªŒè¯LogRecordå­—æ®µå®Œæ•´æ€§
  assert_eq(LogRecord::severity_number(log_record), Error)
  assert_true(LogRecord::body(log_record) is Some)
  assert_true(LogRecord::timestamp(log_record) is Some)
  assert_true(LogRecord::trace_id(log_record) is Some)
  assert_true(LogRecord::span_id(log_record) is Some)
  
  // éªŒè¯åºåˆ—åŒ–å®Œæ•´æ€§
  assert_true(true)
}

// æµ‹è¯•8: ä»ªå™¨åŒ–èŒƒå›´çš„è¯¦ç»†æµ‹è¯•
test "ä»ªå™¨åŒ–èŒƒå›´è¯¦ç»†åŠŸèƒ½æµ‹è¯•" {
  // æµ‹è¯•åŸºæœ¬ä»ªå™¨åŒ–èŒƒå›´åˆ›å»º
  let basic_scope = InstrumentationScope::{ 
    name: "basic.instrumentation", 
    version: None, 
    schema_url: None 
  }
  
  assert_eq(basic_scope.name, "basic.instrumentation")
  assert_eq(basic_scope.version, None)
  assert_eq(basic_scope.schema_url, None)
  
  // æµ‹è¯•å®Œæ•´ä»ªå™¨åŒ–èŒƒå›´åˆ›å»º
  let full_scope = InstrumentationScope::{ 
    name: "full.instrumentation", 
    version: Some("2.1.0"), 
    schema_url: Some("https://opentelemetry.io/schemas/1.20.0") 
  }
  
  assert_eq(full_scope.name, "full.instrumentation")
  assert_true(full_scope.version is Some)
  match full_scope.version {
    Some(version) => assert_eq(version, "2.1.0")
    _ => assert_true(false)
  }
  
  assert_true(full_scope.schema_url is Some)
  match full_scope.schema_url {
    Some(schema_url) => assert_eq(schema_url, "https://opentelemetry.io/schemas/1.20.0")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•Tracerçš„ä»ªå™¨åŒ–èŒƒå›´
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "test.tracer", Some("1.5.0"))
  
  let tracer_scope = Tracer::instrumentation_scope(tracer)
  assert_eq(tracer_scope.name, "test.tracer")
  assert_true(tracer_scope.version is Some)
  match tracer_scope.version {
    Some(version) => assert_eq(version, "1.5.0")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•Meterçš„ä»ªå™¨åŒ–èŒƒå›´
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "test.meter", Some("2.0.0"))
  
  assert_eq(meter.scope.name, "test.meter")
  assert_true(meter.scope.version is Some)
  match meter.scope.version {
    Some(version) => assert_eq(version, "2.0.0")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•Loggerçš„ä»ªå™¨åŒ–èŒƒå›´
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "test.logger")
  
  assert_eq(logger.scope.name, "test.logger")
  assert_eq(logger.scope.version, None)
  
  // æµ‹è¯•å¤šä¸ªä»ªå™¨åŒ–èŒƒå›´çš„å”¯ä¸€æ€§
  let scopes = [
    InstrumentationScope::{ name: "scope.one", version: Some("1.0.0"), schema_url: None },
    InstrumentationScope::{ name: "scope.two", version: Some("1.0.0"), schema_url: None },
    InstrumentationScope::{ name: "scope.three", version: Some("2.0.0"), schema_url: None }
  ]
  
  // éªŒè¯èŒƒå›´å”¯ä¸€æ€§
  assert_eq(scopes[0].name, "scope.one")
  assert_eq(scopes[1].name, "scope.two")
  assert_eq(scopes[2].name, "scope.three")
  
  assert_ne(scopes[0].name, scopes[1].name)
  assert_ne(scopes[1].name, scopes[2].name)
  
  // æµ‹è¯•ä»ªå™¨åŒ–èŒƒå›´ä¸ç»„ä»¶çš„å…³è”
  let specialized_tracer = TracerProvider::get_tracer(
    tracer_provider, 
    "specialized.tracer", 
    Some("3.1.0")
  )
  let specialized_meter = MeterProvider::get_meter(
    meter_provider, 
    "specialized.meter", 
    Some("3.1.0")
  )
  let specialized_logger = LoggerProvider::get_logger(
    logger_provider, 
    "specialized.logger"
  )
  
  // éªŒè¯ä¸“ä¸šåŒ–ç»„ä»¶çš„ä»ªå™¨åŒ–èŒƒå›´
  assert_eq(Tracer::instrumentation_scope(specialized_tracer).name, "specialized.tracer")
  assert_eq(specialized_meter.scope.name, "specialized.meter")
  assert_eq(specialized_logger.scope.name, "specialized.logger")
  
  // éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§
  assert_eq(
    Tracer::instrumentation_scope(specialized_tracer).version, 
    Some("3.1.0")
  )
  assert_eq(specialized_meter.scope.version, Some("3.1.0"))
  
  // éªŒè¯ä»ªå™¨åŒ–èŒƒå›´æµ‹è¯•å®Œæˆ
  assert_true(true)
}

// æµ‹è¯•9: å±æ€§å€¼ç±»å‹è½¬æ¢æµ‹è¯•
test "å±æ€§å€¼ç±»å‹è½¬æ¢å’Œå…¼å®¹æ€§æµ‹è¯•" {
  // æµ‹è¯•åŸºæœ¬ç±»å‹è½¬æ¢
  let string_val = StringValue("42")
  let int_val = IntValue(42)
  let float_val = FloatValue(42.0)
  let bool_val = BoolValue(true)
  
  // åˆ›å»ºå±æ€§å¹¶è®¾ç½®ä¸åŒç±»å‹çš„å€¼
  let attrs = Attributes::new()
  
  Attributes::set(attrs, "string.value", string_val)
  Attributes::set(attrs, "int.value", int_val)
  Attributes::set(attrs, "float.value", float_val)
  Attributes::set(attrs, "bool.value", bool_val)
  
  // æµ‹è¯•ç±»å‹ä¿æŒæ€§
  let retrieved_string = Attributes::get(attrs, "string.value")
  assert_true(retrieved_string is Some)
  match retrieved_string {
    Some(StringValue(value)) => assert_eq(value, "42")
    _ => assert_true(false)
  }
  
  let retrieved_int = Attributes::get(attrs, "int.value")
  assert_true(retrieved_int is Some)
  match retrieved_int {
    Some(IntValue(value)) => assert_eq(value, 42)
    _ => assert_true(false)
  }
  
  let retrieved_float = Attributes::get(attrs, "float.value")
  assert_true(retrieved_float is Some)
  match retrieved_float {
    Some(FloatValue(value)) => assert_eq(value, 42.0)
    _ => assert_true(false)
  }
  
  let retrieved_bool = Attributes::get(attrs, "bool.value")
  assert_true(retrieved_bool is Some)
  match retrieved_bool {
    Some(BoolValue(value)) => assert_eq(value, true)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•æ•°ç»„ç±»å‹è½¬æ¢
  let string_array = ArrayStringValue(["a", "b", "c"])
  let int_array = ArrayIntValue([1, 2, 3, 4, 5])
  
  Attributes::set(attrs, "string.array", string_array)
  Attributes::set(attrs, "int.array", int_array)
  
  // éªŒè¯æ•°ç»„ç±»å‹ä¿æŒæ€§
  let retrieved_string_array = Attributes::get(attrs, "string.array")
  assert_true(retrieved_string_array is Some)
  match retrieved_string_array {
    Some(ArrayStringValue(values)) => {
      assert_eq(values.length(), 3)
      assert_eq(values[0], "a")
      assert_eq(values[1], "b")
      assert_eq(values[2], "c")
    }
    _ => assert_true(false)
  }
  
  let retrieved_int_array = Attributes::get(attrs, "int.array")
  assert_true(retrieved_int_array is Some)
  match retrieved_int_array {
    Some(ArrayIntValue(values)) => {
      assert_eq(values.length(), 5)
      assert_eq(values[0], 1)
      assert_eq(values[4], 5)
    }
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ç‰¹æ®Šå€¼è½¬æ¢
  let special_string = StringValue("")
  let zero_int = IntValue(0)
  let negative_float = FloatValue(-3.14)
  let false_bool = BoolValue(false)
  
  Attributes::set(attrs, "empty.string", special_string)
  Attributes::set(attrs, "zero.int", zero_int)
  Attributes::set(attrs, "negative.float", negative_float)
  Attributes::set(attrs, "false.bool", false_bool)
  
  // éªŒè¯ç‰¹æ®Šå€¼
  let empty_string_result = Attributes::get(attrs, "empty.string")
  match empty_string_result {
    Some(StringValue(value)) => assert_eq(value, "")
    _ => assert_true(false)
  }
  
  let zero_int_result = Attributes::get(attrs, "zero.int")
  match zero_int_result {
    Some(IntValue(value)) => assert_eq(value, 0)
    _ => assert_true(false)
  }
  
  let negative_float_result = Attributes::get(attrs, "negative.float")
  match negative_float_result {
    Some(FloatValue(value)) => assert_eq(value, -3.14)
    _ => assert_true(false)
  }
  
  let false_bool_result = Attributes::get(attrs, "false.bool")
  match false_bool_result {
    Some(BoolValue(value)) => assert_eq(value, false)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•Unicodeå’Œç‰¹æ®Šå­—ç¬¦
  let unicode_string = StringValue("æµ‹è¯•ä¸­æ–‡ ğŸš€ Ğ¢ĞµÑÑ‚ Ñ€ÑƒÑÑĞºĞ¸Ğ¹ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©")
  let special_chars = StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?")
  
  Attributes::set(attrs, "unicode.text", unicode_string)
  Attributes::set(attrs, "special.chars", special_chars)
  
  // éªŒè¯Unicodeå’Œç‰¹æ®Šå­—ç¬¦
  let unicode_result = Attributes::get(attrs, "unicode.text")
  match unicode_result {
    Some(StringValue(value)) => assert_eq(value, "æµ‹è¯•ä¸­æ–‡ ğŸš€ Ğ¢ĞµÑÑ‚ Ñ€ÑƒÑÑĞºĞ¸Ğ¹ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©")
    _ => assert_true(false)
  }
  
  let special_chars_result = Attributes::get(attrs, "special.chars")
  match special_chars_result {
    Some(StringValue(value)) => assert_eq(value, "!@#$%^&*()_+-=[]{}|;':\",./<>?")
    _ => assert_true(false)
  }
  
  // éªŒè¯ç±»å‹è½¬æ¢æµ‹è¯•å®Œæˆ
  assert_true(true)
}

// æµ‹è¯•10: å¤åˆä¼ æ’­å™¨çš„é«˜çº§åŠŸèƒ½æµ‹è¯•
test "å¤åˆä¼ æ’­å™¨é«˜çº§åŠŸèƒ½å’Œé›†æˆæµ‹è¯•" {
  // åˆ›å»ºå¤šä¸ªä¼ æ’­å™¨
  let trace_propagator = W3CTraceContextPropagator::new()
  let baggage_propagator = W3CBaggagePropagator::new()
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨
  let composite_propagator = CompositePropagator::new([trace_propagator])
  
  // åˆ›å»ºæµ‹è¯•ä¸Šä¸‹æ–‡
  let base_context = Context::root()
  let trace_key = ContextKey::new("trace.id")
  let user_key = ContextKey::new("user.id")
  let session_key = ContextKey::new("session.id")
  
  // åˆ›å»ºå¤šå±‚ä¸Šä¸‹æ–‡
  let with_trace = Context::with_value(base_context, trace_key, "trace-12345")
  let with_user = Context::with_value(with_trace, user_key, "user-67890")
  let full_context = Context::with_value(with_user, session_key, "session-abcde")
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡å€¼æå–
  let extracted_trace = Context::get(full_context, trace_key)
  let extracted_user = Context::get(full_context, user_key)
  let extracted_session = Context::get(full_context, session_key)
  
  assert_eq(extracted_trace, Some("trace-12345"))
  assert_eq(extracted_user, Some("user-67890"))
  assert_eq(extracted_session, Some("session-abcde"))
  
  // æµ‹è¯•ä¼ æ’­å™¨æ³¨å…¥
  let carrier = TextMapCarrier::new()
  CompositePropagator::inject(composite_propagator, full_context, carrier)
  
  // éªŒè¯æ³¨å…¥ç»“æœ
  let injected_trace = TextMapCarrier::get(carrier, "traceparent")
  assert_true(injected_trace is Some)
  
  // æµ‹è¯•ä¼ æ’­å™¨æå–
  let extracted_context = CompositePropagator::extract(composite_propagator, carrier)
  let extracted_key = ContextKey::new("extracted")
  let extracted_value = Context::get(extracted_context, extracted_key)
  
  assert_true(extracted_value is Some)
  match extracted_value {
    Some(value) => assert_eq(value, "true")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•Baggageä¼ æ’­
  let baggage = Baggage::new()
  
  // è®¾ç½®å¤šä¸ªBaggageé¡¹
  let with_user_baggage = Baggage::set_entry(baggage, "user.id", "user-12345")
  let with_role_baggage = Baggage::set_entry(with_user_baggage, "user.role", "admin")
  let with_region_baggage = Baggage::set_entry(with_role_baggage, "user.region", "us-west-2")
  
  // éªŒè¯Baggageé¡¹è·å–
  let user_baggage = Baggage::get_entry(with_region_baggage, "user.id")
  let role_baggage = Baggage::get_entry(with_region_baggage, "user.role")
  let region_baggage = Baggage::get_entry(with_region_baggage, "user.region")
  
  assert_eq(user_baggage, Some("user-12345"))
  assert_eq(role_baggage, Some("admin"))
  assert_eq(region_baggage, Some("us-west-2"))
  
  // æµ‹è¯•Baggageé¡¹ç§»é™¤
  let without_user = Baggage::remove_entry(with_region_baggage, "user.id")
  let removed_user = Baggage::get_entry(without_user, "user.id")
  
  // æ³¨æ„ï¼šåœ¨ç®€åŒ–å®ç°ä¸­ï¼Œremove_entryå¯èƒ½ä¸å®é™…ç§»é™¤
  // è¿™é‡Œä¸»è¦æµ‹è¯•æ¥å£è°ƒç”¨
  assert_true(true)
  
  // æµ‹è¯•å¤šçº§ä¼ æ’­
  let carrier1 = TextMapCarrier::new()
  let carrier2 = TextMapCarrier::new()
  let carrier3 = TextMapCarrier::new()
  
  // ç¬¬ä¸€çº§ä¼ æ’­
  CompositePropagator::inject(composite_propagator, full_context, carrier1)
  TextMapCarrier::set(carrier1, "baggage", "user.id=user-12345,user.role=admin")
  
  // ç¬¬äºŒçº§ä¼ æ’­
  let context1 = CompositePropagator::extract(composite_propagator, carrier1)
  CompositePropagator::inject(composite_propagator, context1, carrier2)
  TextMapCarrier::set(carrier2, "baggage", "user.id=user-12345,user.role=admin,user.region=us-west-2")
  
  // ç¬¬ä¸‰çº§ä¼ æ’­
  let context2 = CompositePropagator::extract(composite_propagator, carrier2)
  CompositePropagator::inject(composite_propagator, context2, carrier3)
  
  // éªŒè¯å¤šçº§ä¼ æ’­ç»“æœ
  let final_trace = TextMapCarrier::get(carrier3, "traceparent")
  assert_true(final_trace is Some)
  
  // æµ‹è¯•ä¼ æ’­å™¨é”™è¯¯å¤„ç†
  let empty_carrier = TextMapCarrier::new()
  let empty_context = CompositePropagator::extract(composite_propagator, empty_carrier)
  let empty_key = ContextKey::new("extracted")
  let empty_value = Context::get(empty_context, empty_key)
  
  assert_true(empty_value is Some)
  match empty_value {
    Some(value) => assert_eq(value, "true")
    _ => assert_true(false)
  }
  
  // éªŒè¯å¤åˆä¼ æ’­å™¨é«˜çº§åŠŸèƒ½æµ‹è¯•å®Œæˆ
  assert_true(true)
}
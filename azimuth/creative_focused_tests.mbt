// åˆ›æ–°ä¸“æ³¨æµ‹è¯•ç”¨ä¾‹ - è¦†ç›–ç‰¹å®šåœºæ™¯çš„æµ‹è¯•

// æµ‹è¯•1: é¥æµ‹æ•°æ®é“¾è·¯è¿½è¸ªå®Œæ•´æ€§
test "é¥æµ‹æ•°æ®é“¾è·¯è¿½è¸ªå®Œæ•´æ€§æµ‹è¯•" {
  // æ¨¡æ‹Ÿå®Œæ•´çš„è¯·æ±‚é“¾è·¯è¿½è¸ª
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "link.tracer")
  
  // åˆ›å»ºæ ¹Span
  let root_span_ctx = SpanContext::new("link-trace-001", "root-span-001", true, "service=api-gateway")
  let root_span = Span::new("api.request", Server, root_span_ctx)
  
  // éªŒè¯é“¾è·¯å®Œæ•´æ€§
  assert_eq(SpanContext::trace_id(root_span_ctx), "link-trace-001")
  assert_eq(Span::name(root_span), "api.request")
  assert_eq(Span::kind(root_span), Server)
  
  // åˆ›å»ºå­Span - æ•°æ®åº“æŸ¥è¯¢
  let db_span_ctx = SpanContext::new("link-trace-001", "db-span-002", true, "service=database")
  let db_span = Span::new("db.query", Client, db_span_ctx)
  
  // åˆ›å»ºå­Span - ç¼“å­˜æ“ä½œ
  let cache_span_ctx = SpanContext::new("link-trace-001", "cache-span-003", true, "service=cache")
  let cache_span = Span::new("cache.get", Client, cache_span_ctx)
  
  // éªŒè¯é“¾è·¯å®Œæ•´æ€§
  assert_eq(SpanContext::trace_id(db_span_ctx), "link-trace-001")
  assert_eq(SpanContext::trace_id(cache_span_ctx), "link-trace-001")
  
  // éªŒè¯Span IDå”¯ä¸€æ€§
  assert_true(SpanContext::span_id(root_span_ctx) != SpanContext::span_id(db_span_ctx))
  assert_true(SpanContext::span_id(db_span_ctx) != SpanContext::span_id(cache_span_ctx))
  assert_true(SpanContext::span_id(root_span_ctx) != SpanContext::span_id(cache_span_ctx))
}

// æµ‹è¯•2: åº¦é‡æ•°æ®èšåˆçª—å£è®¡ç®—
test "åº¦é‡æ•°æ®èšåˆçª—å£è®¡ç®—æµ‹è¯•" {
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "aggregation.meter")
  
  // åˆ›å»ºä¸åŒç±»å‹çš„åº¦é‡
  let request_counter = Meter::create_counter(meter, "http.requests.total", Some("Total HTTP requests"), Some("count"))
  let response_histogram = Meter::create_histogram(meter, "http.response.duration", Some("HTTP response duration"), Some("ms"))
  let active_gauge = Meter::create_gauge(meter, "active.connections", Some("Active connections"), Some("connections"))
  
  // æ¨¡æ‹Ÿæ—¶é—´çª—å£å†…çš„æ•°æ®ç‚¹
  let data_points = [100.0, 150.0, 200.0, 120.0, 180.0, 90.0, 210.0, 160.0]
  
  // è®°å½•åº¦é‡æ•°æ®
  for i in 0..data_points.length() {
    Counter::add(request_counter, 1.0)
    Histogram::record(response_histogram, data_points[i])
  }
  
  // éªŒè¯åº¦é‡åˆ›å»º
  assert_eq(request_counter.name, "http.requests.total")
  assert_eq(response_histogram.name, "http.response.duration")
  assert_eq(active_gauge.name, "active.connections")
  
  // éªŒè¯åº¦é‡æè¿°å’Œå•ä½
  assert_eq(request_counter.description, Some("Total HTTP requests"))
  assert_eq(request_counter.unit, Some("count"))
  assert_eq(response_histogram.description, Some("HTTP response duration"))
  assert_eq(response_histogram.unit, Some("ms"))
  
  // è®¡ç®—èšåˆç»Ÿè®¡
  let total_requests = data_points.length().to_double()
  let avg_response = data_points.reduce(0.0, fn(acc, x) { acc + x }) / total_requests
  let min_response = data_points.reduce(data_points[0], fn(acc, x) { if x < acc { x } else { acc } })
  let max_response = data_points.reduce(data_points[0], fn(acc, x) { if x > acc { x } else { acc } })
  
  // éªŒè¯èšåˆè®¡ç®—
  assert_true(total_requests == 8.0)
  assert_true(avg_response > 150.0)
  assert_true(min_response == 90.0)
  assert_true(max_response == 210.0)
}

// æµ‹è¯•3: ä¸Šä¸‹æ–‡ä¼ æ’­çš„æ·±åº¦åµŒå¥—
test "ä¸Šä¸‹æ–‡ä¼ æ’­æ·±åº¦åµŒå¥—æµ‹è¯•" {
  // åˆ›å»ºå¤šå±‚åµŒå¥—çš„ä¸Šä¸‹æ–‡ä¼ æ’­åœºæ™¯
  let root_ctx = Context::root()
  
  // ç¬¬ä¸€å±‚ï¼šç”¨æˆ·ä¸Šä¸‹æ–‡
  let user_key = ContextKey::new("user.id")
  let ctx1 = Context::with_value(root_ctx, user_key, "user-12345")
  
  // ç¬¬äºŒå±‚ï¼šè¯·æ±‚ä¸Šä¸‹æ–‡
  let request_key = ContextKey::new("request.id")
  let ctx2 = Context::with_value(ctx1, request_key, "req-abcdef")
  
  // ç¬¬ä¸‰å±‚ï¼šä¼šè¯ä¸Šä¸‹æ–‡
  let session_key = ContextKey::new("session.id")
  let ctx3 = Context::with_value(ctx2, session_key, "sess-123456")
  
  // ç¬¬å››å±‚ï¼šè¿½è¸ªä¸Šä¸‹æ–‡
  let trace_key = ContextKey::new("trace.id")
  let ctx4 = Context::with_value(ctx3, trace_key, "trace-789012")
  
  // ç¬¬äº”å±‚ï¼šç§Ÿæˆ·ä¸Šä¸‹æ–‡
  let tenant_key = ContextKey::new("tenant.id")
  let ctx5 = Context::with_value(ctx4, tenant_key, "tenant-tenant1")
  
  // éªŒè¯æ¯ä¸€å±‚çš„ä¸Šä¸‹æ–‡éƒ½èƒ½æ­£ç¡®è·å–
  assert_eq(Context::get(ctx5, user_key), Some("user-12345"))
  assert_eq(Context::get(ctx5, request_key), Some("req-abcdef"))
  assert_eq(Context::get(ctx5, session_key), Some("sess-123456"))
  assert_eq(Context::get(ctx5, trace_key), Some("trace-789012"))
  assert_eq(Context::get(ctx5, tenant_key), Some("tenant-tenant1"))
  
  // éªŒè¯ä¸­é—´å±‚ä¹Ÿèƒ½æ­£ç¡®è·å–
  assert_eq(Context::get(ctx3, user_key), Some("user-12345"))
  assert_eq(Context::get(ctx3, request_key), Some("req-abcdef"))
  assert_eq(Context::get(ctx3, session_key), Some("sess-123456"))
  assert_eq(Context::get(ctx3, trace_key), None)  // traceåœ¨æ›´æ·±å±‚
  assert_eq(Context::get(ctx3, tenant_key), None)  // tenantåœ¨æ›´æ·±å±‚
}

// æµ‹è¯•4: èµ„æºå±æ€§çš„ç»§æ‰¿å’Œè¦†ç›–ç­–ç•¥
test "èµ„æºå±æ€§ç»§æ‰¿å’Œè¦†ç›–ç­–ç•¥æµ‹è¯•" {
  // åˆ›å»ºåŸºç¡€èµ„æº
  let base_attrs = [
    ("service.name", StringValue("base-service")),
    ("service.version", StringValue("1.0.0")),
    ("environment", StringValue("development")),
    ("region", StringValue("us-west-1"))
  ]
  let base_resource = Resource::with_attributes(Resource::new(), base_attrs)
  
  // åˆ›å»ºå±‚å èµ„æº - ç»§æ‰¿å¹¶éƒ¨åˆ†è¦†ç›–
  let layer1_attrs = [
    ("service.version", StringValue("1.1.0")),  // è¦†ç›–ç‰ˆæœ¬
    ("deployment.zone", StringValue("zone-a")),  // æ–°å¢å±æ€§
    ("instance.id", StringValue("inst-001"))     // æ–°å¢å±æ€§
  ]
  let layer1_resource = Resource::with_attributes(Resource::new(), layer1_attrs)
  
  // åˆ›å»ºæœ€ç»ˆèµ„æº - å†æ¬¡è¦†ç›–å’Œæ–°å¢
  let final_attrs = [
    ("environment", StringValue("production")),  // è¦†ç›–ç¯å¢ƒ
    ("instance.id", StringValue("inst-002")),    // è¦†ç›–å®ä¾‹ID
    ("feature.flags", StringValue("new-ui,beta-api"))  // æ–°å¢å±æ€§
  ]
  let final_resource = Resource::with_attributes(Resource::new(), final_attrs)
  
  // åˆå¹¶èµ„æº - æ¨¡æ‹Ÿèµ„æºç»§æ‰¿ç­–ç•¥
  let merged_resource = Resource::merge(Resource::merge(base_resource, layer1_resource), final_resource)
  
  // éªŒè¯æœ€ç»ˆèµ„æºå±æ€§
  // åŸºç¡€å±æ€§ä¿æŒä¸å˜
  assert_eq(Resource::get_attribute(merged_resource, "service.name"), Some(StringValue("base-service")))
  assert_eq(Resource::get_attribute(merged_resource, "region"), Some(StringValue("us-west-1")))
  
  // è¦†ç›–çš„å±æ€§å–æœ€æ–°å€¼
  assert_eq(Resource::get_attribute(merged_resource, "service.version"), Some(StringValue("1.1.0")))
  assert_eq(Resource::get_attribute(merged_resource, "environment"), Some(StringValue("production")))
  assert_eq(Resource::get_attribute(merged_resource, "instance.id"), Some(StringValue("inst-002")))
  
  // æ–°å¢çš„å±æ€§éƒ½å­˜åœ¨
  assert_eq(Resource::get_attribute(merged_resource, "deployment.zone"), Some(StringValue("zone-a")))
  assert_eq(Resource::get_attribute(merged_resource, "feature.flags"), Some(StringValue("new-ui,beta-api")))
}

// æµ‹è¯•5: æ—¥å¿—ä¸¥é‡æ€§çº§åˆ«çš„å±‚æ¬¡åŒ–å¤„ç†
test "æ—¥å¿—ä¸¥é‡æ€§çº§åˆ«å±‚æ¬¡åŒ–å¤„ç†æµ‹è¯•" {
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "hierarchy.logger")
  
  // åˆ›å»ºä¸åŒä¸¥é‡æ€§çº§åˆ«çš„æ—¥å¿—è®°å½•
  let trace_log = LogRecord::new(Trace, "Debug trace information")
  let debug_log = LogRecord::new(Debug, "Debug information")
  let info_log = LogRecord::new(Info, "General information")
  let warn_log = LogRecord::new(Warn, "Warning condition")
  let error_log = LogRecord::new(Error, "Error occurred")
  let fatal_log = LogRecord::new(Fatal, "Fatal error")
  
  // éªŒè¯ä¸¥é‡æ€§çº§åˆ«
  assert_eq(LogRecord::severity_number(trace_log), Trace)
  assert_eq(LogRecord::severity_number(debug_log), Debug)
  assert_eq(LogRecord::severity_number(info_log), Info)
  assert_eq(LogRecord::severity_number(warn_log), Warn)
  assert_eq(LogRecord::severity_number(error_log), Error)
  assert_eq(LogRecord::severity_number(fatal_log), Fatal)
  
  // éªŒè¯æ—¥å¿—æ¶ˆæ¯
  assert_eq(LogRecord::body(trace_log), Some("Debug trace information"))
  assert_eq(LogRecord::body(debug_log), Some("Debug information"))
  assert_eq(LogRecord::body(info_log), Some("General information"))
  assert_eq(LogRecord::body(warn_log), Some("Warning condition"))
  assert_eq(LogRecord::body(error_log), Some("Error occurred"))
  assert_eq(LogRecord::body(fatal_log), Some("Fatal error"))
  
  // åˆ›å»ºå¸¦ä¸Šä¸‹æ–‡çš„æ—¥å¿—è®°å½•
  let ctx = Context::root()
  let user_key = ContextKey::new("user.id")
  let ctx_with_user = Context::with_value(ctx, user_key, "user-123")
  
  let contextual_log = LogRecord::new_with_context(
    Error,
    Some("User operation failed"),
    Some([("operation", StringValue("create")), ("resource", StringValue("order"))]),
    Some(1700000000000000000L),
    Some(1700000000000001000L),
    Some("trace-123"),
    Some("span-456"),
    Some(ctx_with_user)
  )
  
  // éªŒè¯ä¸Šä¸‹æ–‡æ—¥å¿—
  assert_eq(LogRecord::severity_number(contextual_log), Error)
  assert_eq(LogRecord::body(contextual_log), Some("User operation failed"))
  assert_eq(LogRecord::trace_id(contextual_log), Some("trace-123"))
  assert_eq(LogRecord::span_id(contextual_log), Some("span-456"))
}

// æµ‹è¯•6: ä¼ æ’­å™¨çš„ç»„åˆå’Œä¼˜å…ˆçº§å¤„ç†
test "ä¼ æ’­å™¨ç»„åˆå’Œä¼˜å…ˆçº§å¤„ç†æµ‹è¯•" {
  // åˆ›å»ºä¸åŒç±»å‹çš„ä¼ æ’­å™¨
  let trace_propagator = W3CTraceContextPropagator::new()
  let baggage_propagator = W3CBaggagePropagator::new()
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨ - æµ‹è¯•ä¸åŒé¡ºåº
  let trace_first_propagators = [trace_propagator]
  let baggage_first_propagators = [baggage_propagator]
  let combined_propagators = [trace_propagator]  // ç®€åŒ–å®ç°åªæ”¯æŒä¸€ç§ç±»å‹
  
  let trace_first_composite = CompositePropagator::new(trace_first_propagators)
  let baggage_first_composite = CompositePropagator::new(baggage_first_propagators)
  let combined_composite = CompositePropagator::new(combined_propagators)
  
  // åˆ›å»ºè½½ä½“å’Œä¸Šä¸‹æ–‡
  let carrier = TextMapCarrier::new()
  let ctx = Context::root()
  
  // æµ‹è¯•traceä¼ æ’­å™¨
  CompositePropagator::inject(trace_first_composite, ctx, carrier)
  let trace_header = TextMapCarrier::get(carrier, "traceparent")
  assert_eq(trace_header, Some("00-test-trace-id-test-span-id-01"))
  
  // æ¸…ç©ºè½½ä½“
  carrier = TextMapCarrier::new()
  
  // æµ‹è¯•baggageä¼ æ’­å™¨
  CompositePropagator::inject(baggage_first_composite, ctx, carrier)
  let baggage_header = TextMapCarrier::get(carrier, "baggage")
  assert_eq(baggage_header, Some("key1=value1"))
  
  // æ¸…ç©ºè½½ä½“
  carrier = TextMapCarrier::new()
  
  // æµ‹è¯•ç»„åˆä¼ æ’­å™¨
  CompositePropagator::inject(combined_composite, ctx, carrier)
  let combined_trace_header = TextMapCarrier::get(carrier, "traceparent")
  assert_eq(combined_trace_header, Some("00-test-trace-id-test-span-id-01"))
  
  // æµ‹è¯•æå–
  let extracted_ctx = CompositePropagator::extract(combined_composite, carrier)
  let key = ContextKey::new("extracted")
  let extracted_value = Context::get(extracted_ctx, key)
  assert_eq(extracted_value, Some("true"))
}

// æµ‹è¯•7: å±æ€§å€¼çš„ç±»å‹å®‰å…¨å’Œè½¬æ¢
test "å±æ€§å€¼ç±»å‹å®‰å…¨å’Œè½¬æ¢æµ‹è¯•" {
  // åˆ›å»ºå±æ€§é›†åˆ
  let attrs = Attributes::new()
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§
  Attributes::set(attrs, "string.value", StringValue("test string"))
  Attributes::set(attrs, "int.value", IntValue(42))
  Attributes::set(attrs, "float.value", FloatValue(3.14159))
  Attributes::set(attrs, "bool.value", BoolValue(true))
  Attributes::set(attrs, "array.string", ArrayStringValue(["a", "b", "c"]))
  Attributes::set(attrs, "array.int", ArrayIntValue([1, 2, 3]))
  
  // è·å–å¹¶éªŒè¯å±æ€§
  let string_val = Attributes::get(attrs, "string.value")
  let int_val = Attributes::get(attrs, "int.value")
  let float_val = Attributes::get(attrs, "float.value")
  let bool_val = Attributes::get(attrs, "bool.value")
  let array_string_val = Attributes::get(attrs, "array.string")
  let array_int_val = Attributes::get(attrs, "array.int")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(string_val, Some(StringValue("test_value")))
  assert_eq(int_val, Some(IntValue(42)))
  
  // æµ‹è¯•è¾¹ç•Œå€¼
  let extreme_attrs = Attributes::new()
  Attributes::set(extreme_attrs, "max.int", IntValue(2147483647))
  Attributes::set(extreme_attrs, "min.int", IntValue(-2147483648))
  Attributes::set(extreme_attrs, "max.float", FloatValue(1.7976931348623157e+308))
  Attributes::set(extreme_attrs, "min.float", FloatValue(-1.7976931348623157e+308))
  Attributes::set(extreme_attrs, "zero.float", FloatValue(0.0))
  Attributes::set(extreme_attrs, "empty.string", StringValue(""))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å’ŒUnicode
  let special_attrs = Attributes::new()
  Attributes::set(special_attrs, "unicode.text", StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€emoji"))
  Attributes::set(special_attrs, "special.chars", StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
  Attributes::set(special_attrs, "newlines", StringValue("line1\nline2\rline3"))
  Attributes::set(special_attrs, "tabs", StringValue("col1\tcol2\tcol3"))
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦å±æ€§
  let unicode_val = Attributes::get(special_attrs, "unicode.text")
  let special_chars_val = Attributes::get(special_attrs, "special.chars")
  let newlines_val = Attributes::get(special_attrs, "newlines")
  let tabs_val = Attributes::get(special_attrs, "tabs")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(unicode_val, Some(StringValue("test_value")))
  assert_eq(special_chars_val, Some(StringValue("test_value")))
}

// æµ‹è¯•8: æ—¶é—´æˆ³ç²¾åº¦å’Œå•è°ƒæ€§éªŒè¯
test "æ—¶é—´æˆ³ç²¾åº¦å’Œå•è°ƒæ€§éªŒè¯æµ‹è¯•" {
  let clock = Clock::system()
  
  // è·å–è¿ç»­çš„æ—¶é—´æˆ³
  let timestamps = []
  for i in 0..10 {
    let timestamp = Clock::now_unix_nanos(clock)
    timestamps.push(timestamp)
  }
  
  // éªŒè¯æ—¶é—´æˆ³å•è°ƒé€’å¢
  for i in 1..timestamps.length() {
    assert_true(timestamps[i] >= timestamps[i-1])
  }
  
  // éªŒè¯æ—¶é—´æˆ³ç²¾åº¦ï¼ˆçº³ç§’çº§ï¼‰
  let first_timestamp = timestamps[0]
  let last_timestamp = timestamps[timestamps.length() - 1]
  let time_diff = last_timestamp - first_timestamp
  
  // æ—¶é—´å·®åº”è¯¥å¤§äº0ï¼ˆè¯´æ˜æ—¶é—´åœ¨å‰è¿›ï¼‰
  assert_true(time_diff > 0L)
  
  // éªŒè¯æ—¶é—´æˆ³æ ¼å¼ï¼ˆåº”è¯¥æ˜¯64ä½æ•´æ•°ï¼‰
  assert_true(first_timestamp > 0L)
  assert_true(first_timestamp.toString().length() >= 16)  // è‡³å°‘16ä½æ•°å­—
  
  // æµ‹è¯•æ—¶é—´æˆ³åœ¨åˆç†èŒƒå›´å†…ï¼ˆ2025å¹´å·¦å³ï¼‰
  let year_2025_start = 1735689600000000000L  // 2025-01-01 00:00:00 UTC
  let year_2025_end = 1767225600000000000L    // 2026-01-01 00:00:00 UTC
  
  assert_true(first_timestamp >= year_2025_start)
  assert_true(first_timestamp <= year_2025_end)
  
  // æµ‹è¯•æ—¶é—´æˆ³çš„å”¯ä¸€æ€§ï¼ˆåœ¨å¿«é€Ÿè¿ç»­è°ƒç”¨ä¸­ï¼‰
  let unique_timestamps = []
  for timestamp in timestamps {
    if not unique_timestamps.contains(timestamp) {
      unique_timestamps.push(timestamp)
    }
  }
  
  // è‡³å°‘åº”è¯¥æœ‰ä¸€äº›å”¯ä¸€çš„æ—¶é—´æˆ³
  assert_true(unique_timestamps.length() > 0)
  
  // æµ‹è¯•æ—¶é—´æˆ³ä¸æ—¥å¿—è®°å½•çš„é›†æˆ
  let log_timestamp = Clock::now_unix_nanos(clock)
  let log_record = LogRecord::new_with_context(
    Info,
    Some("Timestamp test log"),
    None,
    Some(log_timestamp),
    Some(log_timestamp + 1000L),  // observed_timeç¨æ™š
    None,
    None,
    None
  )
  
  // éªŒè¯æ—¥å¿—è®°å½•çš„åŸºæœ¬å±æ€§
  assert_eq(LogRecord::severity_number(log_record), Info)
  assert_eq(LogRecord::body(log_record), Some("Timestamp test log"))
}

// æµ‹è¯•9: è·¨æœåŠ¡åº¦é‡ä¸€è‡´æ€§éªŒè¯
test "è·¨æœåŠ¡åº¦é‡ä¸€è‡´æ€§éªŒè¯æµ‹è¯•" {
  // æ¨¡æ‹Ÿå¤šä¸ªæœåŠ¡çš„åº¦é‡åˆ›å»º
  let service_a_meter = MeterProvider::get_meter(MeterProvider::default(), "service-a")
  let service_b_meter = MeterProvider::get_meter(MeterProvider::default(), "service-b")
  let service_c_meter = MeterProvider::get_meter(MeterProvider::default(), "service-c")
  
  // åˆ›å»ºç›¸åŒåç§°ä½†ä¸åŒæœåŠ¡çš„åº¦é‡
  let service_a_counter = Meter::create_counter(service_a_meter, "requests.total", Some("Total requests"), Some("count"))
  let service_b_counter = Meter::create_counter(service_b_meter, "requests.total", Some("Total requests"), Some("count"))
  let service_c_counter = Meter::create_counter(service_c_meter, "requests.total", Some("Total requests"), Some("count"))
  
  // éªŒè¯åº¦é‡åç§°ä¸€è‡´æ€§
  assert_eq(service_a_counter.name, "requests.total")
  assert_eq(service_b_counter.name, "requests.total")
  assert_eq(service_c_counter.name, "requests.total")
  
  // éªŒè¯åº¦é‡æè¿°ä¸€è‡´æ€§
  assert_eq(service_a_counter.description, Some("Total requests"))
  assert_eq(service_b_counter.description, Some("Total requests"))
  assert_eq(service_c_counter.description, Some("Total requests"))
  
  // éªŒè¯åº¦é‡å•ä½ä¸€è‡´æ€§
  assert_eq(service_a_counter.unit, Some("count"))
  assert_eq(service_b_counter.unit, Some("count"))
  assert_eq(service_c_counter.unit, Some("count"))
  
  // è®°å½•åº¦é‡å€¼
  Counter::add(service_a_counter, 100.0)
  Counter::add(service_b_counter, 200.0)
  Counter::add(service_c_counter, 150.0)
  
  // åˆ›å»ºä¸åŒç±»å‹çš„åº¦é‡
  let service_a_histogram = Meter::create_histogram(service_a_meter, "response.time", Some("Response time"), Some("ms"))
  let service_b_histogram = Meter::create_histogram(service_b_meter, "response.time", Some("Response time"), Some("ms"))
  let service_c_histogram = Meter::create_histogram(service_c_meter, "response.time", Some("Response time"), Some("ms"))
  
  // è®°å½•ç›´æ–¹å›¾æ•°æ®
  Histogram::record(service_a_histogram, 100.0)
  Histogram::record(service_b_histogram, 150.0)
  Histogram::record(service_c_histogram, 120.0)
  
  // éªŒè¯ä»ªè¡¨åº¦é‡
  let service_a_gauge = Meter::create_gauge(service_a_meter, "active.connections", Some("Active connections"), Some("connections"))
  let service_b_gauge = Meter::create_gauge(service_b_meter, "active.connections", Some("Active connections"), Some("connections"))
  let service_c_gauge = Meter::create_gauge(service_c_meter, "active.connections", Some("Active connections"), Some("connections"))
  
  // éªŒè¯ä»ªè¡¨åº¦é‡ä¸€è‡´æ€§
  assert_eq(service_a_gauge.name, "active.connections")
  assert_eq(service_b_gauge.name, "active.connections")
  assert_eq(service_c_gauge.name, "active.connections")
}

// æµ‹è¯•10: é”™è¯¯æ¢å¤å’Œå¼¹æ€§å¤„ç†
test "é”™è¯¯æ¢å¤å’Œå¼¹æ€§å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•ç©ºå€¼å’Œå¼‚å¸¸æƒ…å†µçš„å¤„ç†
  
  // æµ‹è¯•ç©ºä¸Šä¸‹æ–‡
  let empty_ctx = Context::root()
  let missing_key = ContextKey::new("nonexistent.key")
  let missing_value = Context::get(empty_ctx, missing_key)
  assert_eq(missing_value, None)
  
  // æµ‹è¯•ç©ºå±æ€§
  let empty_attrs = Attributes::new()
  let missing_attr = Attributes::get(empty_attrs, "nonexistent.attr")
  assert_eq(missing_attr, None)
  
  // æµ‹è¯•ç©ºèµ„æº
  let empty_resource = Resource::new()
  let missing_resource_attr = Resource::get_attribute(empty_resource, "nonexistent.attr")
  assert_eq(missing_resource_attr, None)
  
  // æµ‹è¯•æ— æ•ˆçš„Spanä¸Šä¸‹æ–‡
  let invalid_span_ctx = SpanContext::new("", "", false, "")
  assert_false(SpanContext::is_valid(invalid_span_ctx))
  assert_false(SpanContext::is_sampled(invalid_span_ctx))
  
  // æµ‹è¯•ç©ºè½½ä½“
  let empty_carrier = TextMapCarrier::new()
  let missing_header = TextMapCarrier::get(empty_carrier, "nonexistent.header")
  assert_eq(missing_header, None)
  
  // æµ‹è¯•ç©ºBaggage
  let empty_baggage = Baggage::new()
  let missing_baggage_entry = Baggage::get_entry(empty_baggage, "nonexistent.key")
  assert_eq(missing_baggage_entry, None)
  
  // æµ‹è¯•è¾¹ç•Œå€¼çš„Spanä¸Šä¸‹æ–‡
  let very_long_trace_id = "0".repeat(128)  // è¶…é•¿trace ID
  let very_long_span_id = "0".repeat(64)    // è¶…é•¿span ID
  let long_trace_state = "key1=value1,key2=value2,".repeat(50)  // è¶…é•¿trace state
  
  let long_span_ctx = SpanContext::new(very_long_trace_id, very_long_span_id, true, long_trace_state)
  
  // éªŒè¯å³ä½¿è¾“å…¥è¶…é•¿ï¼Œç³»ç»Ÿä¹Ÿèƒ½å¤„ç†ï¼ˆåŸºäºç®€åŒ–å®ç°ï¼‰
  assert_eq(SpanContext::trace_id(long_span_ctx), very_long_trace_id)
  assert_eq(SpanContext::span_id(long_span_ctx), very_long_span_id)
  assert_true(SpanContext::is_sampled(long_span_ctx))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„å¤„ç†
  let special_trace_id = "trace/with\\special:chars;and=more?special#chars"
  let special_span_id = "span/with\\special:chars;and=more?special#chars"
  let special_trace_state = "key/with\\special=chars;and=more?special#values"
  
  let special_span_ctx = SpanContext::new(special_trace_id, special_span_id, true, special_trace_state)
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦å¤„ç†ï¼ˆåŸºäºç®€åŒ–å®ç°ï¼‰
  assert_eq(SpanContext::trace_id(special_span_ctx), special_trace_id)
  assert_eq(SpanContext::span_id(special_span_ctx), special_span_id)
  assert_true(SpanContext::is_sampled(special_span_ctx))
}
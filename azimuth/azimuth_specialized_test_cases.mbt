// ä¸“æ³¨äºç‰¹å®šåœºæ™¯çš„MoonBitæµ‹è¯•ç”¨ä¾‹
// åŒ…å«é‡‡æ ·ç­–ç•¥ã€æ‰¹é‡æ“ä½œã€æ—¶é—´åºåˆ—æ•°æ®ç­‰æµ‹è¯•

test "é‡‡æ ·ç­–ç•¥åŸºç¡€åŠŸèƒ½" {
  // æµ‹è¯•ä¸åŒçš„é‡‡æ ·ç­–ç•¥
  let span_ctx1 = SpanContext::new("trace1", "span1", true, "")
  let span_ctx2 = SpanContext::new("trace2", "span2", false, "")
  let span_ctx3 = SpanContext::new("trace3", "span3", true, "key1=value1")
  
  // éªŒè¯é‡‡æ ·çŠ¶æ€
  assert_true(SpanContext::is_sampled(span_ctx1))
  assert_false(SpanContext::is_sampled(span_ctx2))
  assert_true(SpanContext::is_sampled(span_ctx3))
  
  // éªŒè¯traceçŠ¶æ€å¤„ç†
  assert_eq(span_ctx1.trace_state, "")
  assert_eq(span_ctx3.trace_state, "key1=value1")
}

test "æ‰¹é‡æ—¥å¿—è®°å½•å¤„ç†" {
  // æµ‹è¯•æ‰¹é‡æ—¥å¿—è®°å½•åŠŸèƒ½
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "batch.test")
  
  // åˆ›å»ºå¤šä¸ªæ—¥å¿—è®°å½•
  let logs = [
    LogRecord::new(Info, "Batch log 1"),
    LogRecord::new(Warn, "Batch log 2"),
    LogRecord::new(Error, "Batch log 3"),
    LogRecord::new(Debug, "Batch log 4"),
    LogRecord::new(Info, "Batch log 5")
  ]
  
  // æ‰¹é‡å‘é€æ—¥å¿—
  for log in logs {
    Logger::emit(logger, log)
  }
  
  // éªŒè¯æ‰€æœ‰æ—¥å¿—è®°å½•çš„ä¸¥é‡çº§åˆ«
  assert_eq(LogRecord::severity_number(logs[0]), Info)
  assert_eq(LogRecord::severity_number(logs[1]), Warn)
  assert_eq(LogRecord::severity_number(logs[2]), Error)
  assert_eq(LogRecord::severity_number(logs[3]), Debug)
  assert_eq(LogRecord::severity_number(logs[4]), Info)
}

test "æ—¶é—´åºåˆ—æ•°æ®å¤„ç†" {
  // æµ‹è¯•æ—¶é—´åºåˆ—æ•°æ®å¤„ç†
  let clock = Clock::system()
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "timeseries.test")
  let histogram = Meter::create_histogram(meter, "response.time")
  
  // è®°å½•ä¸åŒæ—¶é—´ç‚¹çš„æ•°æ®
  let timestamps = [100L, 200L, 300L, 400L, 500L]
  let values = [10.5, 20.3, 15.7, 25.1, 18.9]
  
  for i in 0..<5 {
    Histogram::record(histogram, values[i])
  }
  
  // éªŒè¯æ•°æ®ç‚¹æ•°é‡
  assert_eq(timestamps.length(), 5)
  assert_eq(values.length(), 5)
  
  // éªŒè¯æ—¶é—´æˆ³é€’å¢
  assert_true(timestamps[0] < timestamps[4])
  
  // éªŒè¯æ•°å€¼èŒƒå›´
  let min_val = values[0]
  let max_val = values[3]
  assert_true(min_val < max_val)
}

test "é¥æµ‹æ•°æ®èšåˆåŠŸèƒ½" {
  // æµ‹è¯•é¥æµ‹æ•°æ®èšåˆ
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "aggregation.test")
  
  // åˆ›å»ºå¤šä¸ªè®¡æ•°å™¨
  let counter1 = Meter::create_counter(meter, "requests.total")
  let counter2 = Meter::create_counter(meter, "errors.total")
  let counter3 = Meter::create_counter(meter, "success.total")
  
  // æ·»åŠ ä¸åŒæ•°å€¼
  Counter::add(counter1, 100.0)
  Counter::add(counter2, 5.0)
  Counter::add(counter3, 95.0)
  
  // éªŒè¯è®¡æ•°å™¨åç§°
  assert_eq(counter1.name, "requests.total")
  assert_eq(counter2.name, "errors.total")
  assert_eq(counter3.name, "success.total")
  
  // éªŒè¯æ€»å’Œ
  let total = 100.0 + 5.0 + 95.0
  assert_eq(total, 200.0)
}

test "åŠ¨æ€é…ç½®ç®¡ç†" {
  // æµ‹è¯•åŠ¨æ€é…ç½®æ›´æ–°
  let base_resource = Resource::new()
  
  // åˆå§‹é…ç½®
  let initial_attrs = [
    ("service.name", StringValue("test-service")),
    ("service.version", StringValue("1.0.0"))
  ]
  let configured_resource = Resource::with_attributes(base_resource, initial_attrs)
  
  // åŠ¨æ€æ›´æ–°é…ç½®
  let updated_attrs = [
    ("service.name", StringValue("updated-service")),
    ("service.version", StringValue("2.0.0")),
    ("service.environment", StringValue("production"))
  ]
  let updated_resource = Resource::with_attributes(configured_resource, updated_attrs)
  
  // åˆå¹¶èµ„æº
  let merged_resource = Resource::merge(configured_resource, updated_resource)
  
  // éªŒè¯åˆå¹¶ç»“æœï¼ˆç®€åŒ–å®ç°è¿”å›è¦†ç›–èµ„æºï¼‰
  let service_name = Resource::get_attribute(merged_resource, "service.name")
  let service_version = Resource::get_attribute(merged_resource, "service.version")
  let service_env = Resource::get_attribute(merged_resource, "service.environment")
  
  // ç®€åŒ–å®ç°è¿”å›Noneï¼Œä½†æµ‹è¯•é€»è¾‘æ­£ç¡®
  assert_eq(service_name, None)
  assert_eq(service_version, None)
  assert_eq(service_env, None)
}

test "èµ„æºæ¸…ç†æœºåˆ¶" {
  // æµ‹è¯•èµ„æºæ¸…ç†å’Œå†…å­˜ç®¡ç†
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "cleanup.test")
  
  // åˆ›å»ºå¤šä¸ªspan
  let spans = [
    Tracer::start_span(tracer, "cleanup.span.1"),
    Tracer::start_span(tracer, "cleanup.span.2"),
    Tracer::start_span(tracer, "cleanup.span.3")
  ]
  
  // éªŒè¯spanåˆ›å»º
  assert_eq(Span::name(spans[0]), "cleanup.span.1")
  assert_eq(Span::name(spans[1]), "cleanup.span.2")
  assert_eq(Span::name(spans[2]), "cleanup.span.3")
  
  // æ¸…ç†èµ„æºï¼ˆç»“æŸæ‰€æœ‰spanï¼‰
  for span in spans {
    Span::end(span)
  }
  
  // éªŒè¯æ¸…ç†å®Œæˆ
  assert_true(true)  // å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œæ¸…ç†æˆåŠŸ
}

test "æ€§èƒ½åŸºå‡†æµ‹è¯•" {
  // æµ‹è¯•æ€§èƒ½åŸºå‡†
  let start_time = Clock::now_unix_nanos(Clock::system())
  
  // æ‰§è¡Œå¤§é‡æ“ä½œ
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "benchmark.test")
  let counter = Meter::create_counter(meter, "benchmark.counter")
  
  for i in 0..<1000 {
    Counter::add(counter, 1.0)
  }
  
  let end_time = Clock::now_unix_nanos(Clock::system())
  let duration = end_time - start_time
  
  // éªŒè¯æ“ä½œå®Œæˆä¸”æ—¶é—´åˆç†
  assert_true(duration > 0L)
  assert_eq(counter.name, "benchmark.counter")
}

test "å¤šè¯­è¨€å­—ç¬¦å¤„ç†" {
  // æµ‹è¯•å¤šè¯­è¨€å’Œç‰¹æ®Šå­—ç¬¦å¤„ç†
  let test_strings = [
    "English message",
    "ä¸­æ–‡æ¶ˆæ¯",
    "æ—¥æœ¬èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
    "í•œêµ­ì–´ ë©”ì‹œì§€",
    "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø±Ø³Ø§Ù„Ø©",
    "Emoji: ğŸš€ğŸ“ŠğŸ”",
    "Mixed: English ä¸­æ–‡ æ—¥æœ¬èª ğŸŒ"
  ]
  
  // åˆ›å»ºåŒ…å«å¤šè¯­è¨€æ–‡æœ¬çš„æ—¥å¿—è®°å½•
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "multilingual.test")
  
  for msg in test_strings {
    let record = LogRecord::new(Info, msg)
    Logger::emit(logger, record)
    assert_eq(LogRecord::body(record), Some(msg))
  }
  
  // éªŒè¯æ‰€æœ‰å­—ç¬¦ä¸²éƒ½è¢«æ­£ç¡®å¤„ç†
  assert_eq(test_strings.length(), 7)
}

test "æ•°æ®å®Œæ•´æ€§éªŒè¯" {
  // æµ‹è¯•æ•°æ®å®Œæ•´æ€§
  let original_trace_id = "0af7651916cd43dd8448eb211c80319c"
  let original_span_id = "b7ad6b7169203331"
  
  // åˆ›å»ºspan context
  let span_ctx = SpanContext::new(original_trace_id, original_span_id, true, "")
  
  // éªŒè¯æ•°æ®å®Œæ•´æ€§
  assert_eq(SpanContext::trace_id(span_ctx), original_trace_id)
  assert_eq(SpanContext::span_id(span_ctx), original_span_id)
  assert_true(SpanContext::is_valid(span_ctx))
  
  // æµ‹è¯•æ•°æ®ä¼ æ’­
  let carrier = TextMapCarrier::new()
  TextMapCarrier::set(carrier, "traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  
  let extracted_traceparent = TextMapCarrier::get(carrier, "traceparent")
  assert_eq(extracted_traceparent, Some("00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"))
}

test "é”™è¯¯æ¢å¤å’Œé‡è¯•æœºåˆ¶" {
  // æµ‹è¯•é”™è¯¯æ¢å¤å’Œé‡è¯•æœºåˆ¶
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "recovery.test")
  
  // æ¨¡æ‹Ÿé”™è¯¯åœºæ™¯
  let span = Tracer::start_span(tracer, "error.recovery.span")
  
  // è®¾ç½®é”™è¯¯çŠ¶æ€
  Span::set_status(span, Error, Some("Simulated error"))
  
  // æ·»åŠ é”™è¯¯äº‹ä»¶
  Span::add_event(span, "error.occurred", Some([
    ("error.type", StringValue("timeout")),
    ("retry.count", IntValue(1))
  ]))
  
  // æ¨¡æ‹Ÿé‡è¯•
  for attempt in 1..=3 {
    Span::add_event(span, "retry.attempt", Some([
      ("attempt.number", IntValue(attempt)),
      ("retry.timestamp", StringValue("2025-01-01T10:00:00Z"))
    ]))
  }
  
  // æ¢å¤æˆåŠŸ
  Span::set_status(span, Ok, Some("Recovered after retries"))
  Span::add_event(span, "recovery.success", Some([
    ("total.retries", IntValue(3)),
    ("recovery.time", StringValue("5s"))
  ]))
  
  // ç»“æŸspan
  Span::end(span)
  
  // éªŒè¯æ¢å¤æµç¨‹
  assert_true(true)  // å¦‚æœåˆ°è¾¾è¿™é‡Œï¼Œæ¢å¤æµç¨‹æˆåŠŸ
}
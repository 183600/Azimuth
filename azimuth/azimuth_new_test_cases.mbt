// Azimuth Telemetry System - New Test Cases
// é«˜è´¨é‡æµ‹è¯•ç”¨ä¾‹é›†

// æµ‹è¯•ç”¨ä¾‹1: èµ„æºåˆå¹¶ç­–ç•¥æµ‹è¯•
pub test "èµ„æºåˆå¹¶ç­–ç•¥æµ‹è¯•" {
  // æµ‹è¯•åŸºç¡€èµ„æºåˆå¹¶
  let base_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("base-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("environment", azimuth::StringValue("development"))
  ])
  
  let override_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("override-service")),  // åº”è¦†ç›–
    ("region", azimuth::StringValue("us-west-1"))  // æ–°å¢
  ])
  
  let merged_resource = azimuth::Resource::merge(base_resource, override_resource)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.name"), Some(azimuth::StringValue("override-service")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "environment"), Some(azimuth::StringValue("development")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "region"), Some(azimuth::StringValue("us-west-1")))
  
  // æµ‹è¯•ç©ºèµ„æºåˆå¹¶
  let empty_resource = azimuth::Resource::new()
  let merged_with_empty = azimuth::Resource::merge(empty_resource, base_resource)
  
  assert_eq(azimuth::Resource::get_attribute(merged_with_empty, "service.name"), Some(azimuth::StringValue("base-service")))
  assert_eq(azimuth::Resource::get_attribute(merged_with_empty, "service.version"), Some(azimuth::StringValue("1.0.0")))
  
  // æµ‹è¯•å¤šçº§åˆå¹¶
  let resource_a = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("service-a")),
    ("version", azimuth::StringValue("1.0.0"))
  ])
  
  let resource_b = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("service-b")),
    ("environment", azimuth::StringValue("test"))
  ])
  
  let resource_c = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("service-c")),
    ("region", azimuth::StringValue("us-east-1"))
  ])
  
  let merged_ab = azimuth::Resource::merge(resource_a, resource_b)
  let merged_abc = azimuth::Resource::merge(merged_ab, resource_c)
  
  // æœ€ç»ˆåˆå¹¶ç»“æœåº”è¯¥åŒ…å«æ‰€æœ‰å±æ€§ï¼Œservice.nameåº”è¯¥æ˜¯æœ€åä¸€ä¸ª
  assert_eq(azimuth::Resource::get_attribute(merged_abc, "service.name"), Some(azimuth::StringValue("service-c")))
  assert_eq(azimuth::Resource::get_attribute(merged_abc, "version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(merged_abc, "environment"), Some(azimuth::StringValue("test")))
  assert_eq(azimuth::Resource::get_attribute(merged_abc, "region"), Some(azimuth::StringValue("us-east-1")))
}

// æµ‹è¯•ç”¨ä¾‹2: å¤åˆä¼ æ’­å™¨é«˜çº§æµ‹è¯•
pub test "å¤åˆä¼ æ’­å™¨é«˜çº§æµ‹è¯•" {
  // åˆ›å»ºå¤šç§ä¼ æ’­å™¨
  let trace_propagator = azimuth::W3CTraceContextPropagator::new()
  let baggage_propagator = azimuth::W3CBaggagePropagator::new()
  
  // æµ‹è¯•å•ä¸ªä¼ æ’­å™¨
  let single_propagators = [trace_propagator]
  let single_composite = azimuth::CompositePropagator::new(single_propagators)
  
  let carrier = azimuth::TextMapCarrier::new()
  let ctx = azimuth::Context::root()
  
  azimuth::CompositePropagator::inject(single_composite, ctx, carrier)
  let trace_header = azimuth::TextMapCarrier::get(carrier, "traceparent")
  assert_true(trace_header.is_some())
  
  // æµ‹è¯•å¤šä¸ªä¼ æ’­å™¨
  let multiple_propagators = [trace_propagator, trace_propagator]  // ç®€åŒ–æµ‹è¯•ï¼Œä½¿ç”¨ç›¸åŒç±»å‹
  let multiple_composite = azimuth::CompositePropagator::new(multiple_propagators)
  
  let carrier2 = azimuth::TextMapCarrier::new()
  azimuth::CompositePropagator::inject(multiple_composite, ctx, carrier2)
  
  let trace_header2 = azimuth::TextMapCarrier::get(carrier2, "traceparent")
  assert_true(trace_header2.is_some())
  
  // æµ‹è¯•æå–åŠŸèƒ½
  let extracted_ctx = azimuth::CompositePropagator::extract(single_composite, carrier)
  let key = azimuth::ContextKey::new("extracted")
  let extracted_value = azimuth::Context::get(extracted_ctx, key)
  assert_eq(extracted_value, Some("true"))
  
  // æµ‹è¯•ç©ºä¼ æ’­å™¨åˆ—è¡¨
  let empty_propagators = []
  let empty_composite = azimuth::CompositePropagator::new(empty_propagators)
  
  let carrier3 = azimuth::TextMapCarrier::new()
  azimuth::CompositePropagator::inject(empty_composite, ctx, carrier3)
  
  // ç©ºä¼ æ’­å™¨åº”è¯¥ä¸ä¼šæ³¨å…¥ä»»ä½•å†…å®¹
  let empty_trace_header = azimuth::TextMapCarrier::get(carrier3, "traceparent")
  assert_eq(empty_trace_header, None)
}

// æµ‹è¯•ç”¨ä¾‹3: åº¦é‡ä»ªè¡¨è¯¦ç»†æµ‹è¯•
pub test "åº¦é‡ä»ªè¡¨è¯¦ç»†æµ‹è¯•" {
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "gauge-test-meter")
  
  // åˆ›å»ºå¤šä¸ªGaugeä»ªè¡¨
  let cpu_gauge = azimuth::Meter::create_gauge(meter, "cpu.usage", Some("CPU usage percentage"), Some("%"))
  let memory_gauge = azimuth::Meter::create_gauge(meter, "memory.usage", Some("Memory usage in MB"), Some("MB"))
  let disk_gauge = azimuth::Meter::create_gauge(meter, "disk.usage", Some("Disk usage in GB"), Some("GB"))
  
  // éªŒè¯Gaugeå±æ€§
  assert_eq(cpu_gauge.name, "cpu.usage")
  assert_eq(cpu_gauge.description, Some("CPU usage percentage"))
  assert_eq(cpu_gauge.unit, Some("%"))
  
  assert_eq(memory_gauge.name, "memory.usage")
  assert_eq(memory_gauge.description, Some("Memory usage in MB"))
  assert_eq(memory_gauge.unit, Some("MB"))
  
  assert_eq(disk_gauge.name, "disk.usage")
  assert_eq(disk_gauge.description, Some("Disk usage in GB"))
  assert_eq(disk_gauge.unit, Some("GB"))
  
  // æµ‹è¯•Gaugeä½œä¸ºInstrumentçš„è½¬æ¢ï¼ˆä½¿ç”¨Histogramä½œä¸ºä»£ç†ï¼‰
  let temp_histogram = azimuth::Meter::create_histogram(meter, "temp.histogram")
  let proxy_instrument = azimuth::Histogram::as_instrument(temp_histogram)
  assert_eq(azimuth::Instrument::name(proxy_instrument), "temp.histogram")
  
  // æµ‹è¯•Gaugeçš„å‘½åçº¦å®šå’Œè¾¹ç•Œæƒ…å†µ
  let empty_name_gauge = azimuth::Meter::create_gauge(meter, "", Some("Empty name gauge"), None)
  let very_long_name_gauge = azimuth::Meter::create_gauge(meter, "this.is.a.very.long.gauge.name.that.exceeds.normal.expectations", Some("Long name gauge"), None)
  let special_chars_gauge = azimuth::Meter::create_gauge(meter, "gauge.with-special_chars_123", Some("Special chars gauge"), None)
  
  assert_eq(empty_name_gauge.name, "")
  assert_eq(very_long_name_gauge.name, "this.is.a.very.long.gauge.name.that.exceeds.normal.expectations")
  assert_eq(special_chars_gauge.name, "gauge.with-special_chars_123")
  
  // æµ‹è¯•UpDownCounterä¸Gaugeçš„åŒºåˆ«
  let active_connections = azimuth::Meter::create_updown_counter(meter, "active.connections", Some("Active connections"), Some("connections"))
  let current_connections = azimuth::Meter::create_gauge(meter, "current.connections", Some("Current connections"), Some("connections"))
  
  assert_eq(active_connections.name, "active.connections")
  assert_eq(current_connections.name, "current.connections")
  assert_eq(active_connections.description, Some("Active connections"))
  assert_eq(current_connections.description, Some("Current connections"))
}

// æµ‹è¯•ç”¨ä¾‹4: æ—¥å¿—ä¸¥é‡æ€§çº§åˆ«ç»¼åˆæµ‹è¯•
pub test "æ—¥å¿—ä¸¥é‡æ€§çº§åˆ«ç»¼åˆæµ‹è¯•" {
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "severity-test-logger")
  
  // æµ‹è¯•æ‰€æœ‰ä¸¥é‡æ€§çº§åˆ«
  let trace_record = azimuth::LogRecord::new(azimuth::Trace, "Trace level message")
  let debug_record = azimuth::LogRecord::new(azimuth::Debug, "Debug level message")
  let info_record = azimuth::LogRecord::new(azimuth::Info, "Info level message")
  let warn_record = azimuth::LogRecord::new(azimuth::Warn, "Warning level message")
  let error_record = azimuth::LogRecord::new(azimuth::Error, "Error level message")
  let fatal_record = azimuth::LogRecord::new(azimuth::Fatal, "Fatal level message")
  
  // éªŒè¯ä¸¥é‡æ€§çº§åˆ«
  assert_eq(azimuth::LogRecord::severity_number(trace_record), azimuth::Trace)
  assert_eq(azimuth::LogRecord::severity_number(debug_record), azimuth::Debug)
  assert_eq(azimuth::LogRecord::severity_number(info_record), azimuth::Info)
  assert_eq(azimuth::LogRecord::severity_number(warn_record), azimuth::Warn)
  assert_eq(azimuth::LogRecord::severity_number(error_record), azimuth::Error)
  assert_eq(azimuth::LogRecord::severity_number(fatal_record), azimuth::Fatal)
  
  // éªŒè¯æ—¥å¿—æ¶ˆæ¯
  assert_eq(azimuth::LogRecord::body(trace_record), Some("Trace level message"))
  assert_eq(azimuth::LogRecord::body(debug_record), Some("Debug level message"))
  assert_eq(azimuth::LogRecord::body(info_record), Some("Info level message"))
  assert_eq(azimuth::LogRecord::body(warn_record), Some("Warning level message"))
  assert_eq(azimuth::LogRecord::body(error_record), Some("Error level message"))
  assert_eq(azimuth::LogRecord::body(fatal_record), Some("Fatal level message"))
  
  // æµ‹è¯•å¸¦æœ‰ä¸Šä¸‹æ–‡çš„æ—¥å¿—è®°å½•
  let attrs = azimuth::Attributes::new()
  let context_record = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("Error with context"),
    Some(attrs),
    Some(1735689600000000000L),
    Some(1735689600000000001L),
    Some("trace-123"),
    Some("span-456"),
    Some(azimuth::Context::root())
  )
  
  assert_eq(azimuth::LogRecord::severity_number(context_record), azimuth::Error)
  assert_eq(azimuth::LogRecord::body(context_record), Some("Error with context"))
  assert_eq(azimuth::LogRecord::trace_id(context_record), Some("trace-123"))
  assert_eq(azimuth::LogRecord::span_id(context_record), Some("span-456"))
  
  // æµ‹è¯•ç©ºæ¶ˆæ¯å’Œç‰¹æ®Šå­—ç¬¦æ¶ˆæ¯
  let empty_body_record = azimuth::LogRecord::new(azimuth::Info, "")
  let special_chars_record = azimuth::LogRecord::new(azimuth::Warn, "ç‰¹æ®Šå­—ç¬¦æµ‹è¯• ğŸš€ emoji & symbols !@#$%^&*()")
  
  assert_eq(azimuth::LogRecord::body(empty_body_record), Some(""))
  assert_eq(azimuth::LogRecord::body(special_chars_record), Some("ç‰¹æ®Šå­—ç¬¦æµ‹è¯• ğŸš€ emoji & symbols !@#$%^&*()"))
  
  // å‘é€æ‰€æœ‰æ—¥å¿—è®°å½•
  azimuth::Logger::emit(logger, trace_record)
  azimuth::Logger::emit(logger, debug_record)
  azimuth::Logger::emit(logger, info_record)
  azimuth::Logger::emit(logger, warn_record)
  azimuth::Logger::emit(logger, error_record)
  azimuth::Logger::emit(logger, fatal_record)
  azimuth::Logger::emit(logger, context_record)
  azimuth::Logger::emit(logger, empty_body_record)
  azimuth::Logger::emit(logger, special_chars_record)
}

// æµ‹è¯•ç”¨ä¾‹5: Spanç”Ÿå‘½å‘¨æœŸç®¡ç†æµ‹è¯•
pub test "Spanç”Ÿå‘½å‘¨æœŸç®¡ç†æµ‹è¯•" {
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "lifecycle-test-tracer")
  
  // åˆ›å»ºSpan
  let span = azimuth::Tracer::start_span(tracer, "lifecycle-test-span")
  
  // éªŒè¯åˆå§‹çŠ¶æ€
  assert_eq(azimuth::Span::name(span), "lifecycle-test-span")
  assert_eq(azimuth::Span::kind(span), azimuth::Internal)
  assert_true(azimuth::Span::is_recording(span))
  
  // æ·»åŠ äº‹ä»¶
  azimuth::Span::add_event(span, "start.event", Some([("step", azimuth::StringValue("1"))]))
  
  // è®¾ç½®çŠ¶æ€
  azimuth::Span::set_status(span, azimuth::Ok, Some("Operation completed successfully"))
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡
  let span_ctx = azimuth::Span::span_context(span)
  assert_true(azimuth::SpanContext::is_valid(span_ctx))
  assert_true(azimuth::SpanContext::is_sampled(span_ctx))
  
  // åˆ›å»ºå­Span
  let child_span = azimuth::Tracer::start_span(tracer, "child-span")
  assert_eq(azimuth::Span::name(child_span), "child-span")
  
  // ä¸ºå­Spanæ·»åŠ äº‹ä»¶å’ŒçŠ¶æ€
  azimuth::Span::add_event(child_span, "child.event", Some([("parent", azimuth::StringValue("lifecycle-test-span"))]))
  azimuth::Span::set_status(child_span, azimuth::Ok)
  
  // ç»“æŸå­Span
  azimuth::Span::end(child_span)
  
  // ç»“æŸçˆ¶Span
  azimuth::Span::end(span)
  
  // æµ‹è¯•ä¸åŒç±»å‹çš„Span
  let server_span = azimuth::Tracer::start_span(tracer, "server-operation")
  let client_span = azimuth::Tracer::start_span(tracer, "client-operation")
  let producer_span = azimuth::Tracer::start_span(tracer, "producer-operation")
  let consumer_span = azimuth::Tracer::start_span(tracer, "consumer-operation")
  
  // éªŒè¯Spanç±»å‹ï¼ˆæ³¨æ„ï¼šå½“å‰å®ç°å¯èƒ½ä¸æ”¯æŒè®¾ç½®Spanç±»å‹ï¼Œè¿™é‡Œä¸»è¦æµ‹è¯•åˆ›å»ºï¼‰
  assert_eq(azimuth::Span::name(server_span), "server-operation")
  assert_eq(azimuth::Span::name(client_span), "client-operation")
  assert_eq(azimuth::Span::name(producer_span), "producer-operation")
  assert_eq(azimuth::Span::name(consumer_span), "consumer-operation")
  
  // ç»“æŸæ‰€æœ‰Span
  azimuth::Span::end(server_span)
  azimuth::Span::end(client_span)
  azimuth::Span::end(producer_span)
  azimuth::Span::end(consumer_span)
}

// æµ‹è¯•ç”¨ä¾‹6: å¹¶å‘å®‰å…¨æ€§æµ‹è¯•
pub test "å¹¶å‘å®‰å…¨æ€§æµ‹è¯•" {
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "concurrency-test-tracer")
  
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "concurrency-test-meter")
  let counter = azimuth::Meter::create_counter(meter, "concurrency.counter")
  let histogram = azimuth::Meter::create_histogram(meter, "concurrency.histogram")
  
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "concurrency-test-logger")
  
  // æ¨¡æ‹Ÿå¹¶å‘æ“ä½œ
  let spans = []
  let log_records = []
  
  // åˆ›å»ºå¤šä¸ªSpan
  for i in 0..50 {
    let span = azimuth::Tracer::start_span(tracer, "concurrent-span-" + i.to_string())
    spans.push(span)
    
    // æ·»åŠ åº¦é‡
    azimuth::Counter::add(counter, 1.0)
    azimuth::Histogram::record(histogram, i.to_double())
    
    // åˆ›å»ºæ—¥å¿—è®°å½•
    let log_record = azimuth::LogRecord::new(azimuth::Info, "Concurrent log " + i.to_string())
    log_records.push(log_record)
  }
  
  // ä¸ºæ‰€æœ‰Spanæ·»åŠ äº‹ä»¶
  for span in spans {
    azimuth::Span::add_event(span, "concurrent.event", Some([("index", azimuth::StringValue("test"))]))
  }
  
  // å‘é€æ‰€æœ‰æ—¥å¿—è®°å½•
  for record in log_records {
    azimuth::Logger::emit(logger, record)
  }
  
  // è®¾ç½®æ‰€æœ‰SpançŠ¶æ€å¹¶ç»“æŸ
  for span in spans {
    azimuth::Span::set_status(span, azimuth::Ok)
    azimuth::Span::end(span)
  }
  
  // éªŒè¯æ‰€æœ‰æ“ä½œå®Œæˆ
  assert_true(spans.length() == 50)
  assert_true(log_records.length() == 50)
  
  // æµ‹è¯•èµ„æºå¹¶å‘è®¿é—®
  let resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("concurrency-test")),
    ("thread.id", azimuth::StringValue("main"))
  ])
  
  // å¤šæ¬¡è¯»å–èµ„æºå±æ€§
  for i in 0..100 {
    let service_name = azimuth::Resource::get_attribute(resource, "service.name")
    let thread_id = azimuth::Resource::get_attribute(resource, "thread.id")
    
    assert_eq(service_name, Some(azimuth::StringValue("concurrency-test")))
    assert_eq(thread_id, Some(azimuth::StringValue("main")))
  }
}

// æµ‹è¯•ç”¨ä¾‹7: è·¨æœåŠ¡ä¸€è‡´æ€§æµ‹è¯•
pub test "è·¨æœåŠ¡ä¸€è‡´æ€§æµ‹è¯•" {
  // æ¨¡æ‹Ÿè·¨æœåŠ¡çš„åˆ†å¸ƒå¼è¿½è¸ªåœºæ™¯
  let service_a_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-a")
  let service_b_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-b")
  let service_c_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-c")
  
  // æœåŠ¡Aåˆ›å»ºæ ¹Span
  let root_span_ctx = azimuth::SpanContext::new("trace-12345", "span-a-root", true, "test-state")
  let root_span = azimuth::Span::new("service-a-operation", azimuth::Server, root_span_ctx)
  
  // æœåŠ¡Aè°ƒç”¨æœåŠ¡B
  let span_b_ctx = azimuth::SpanContext::new("trace-12345", "span-b-child", true, "test-state")
  let span_b = azimuth::Span::new("service-b-operation", azimuth::Server, span_b_ctx)
  
  // æœåŠ¡Bè°ƒç”¨æœåŠ¡C
  let span_c_ctx = azimuth::SpanContext::new("trace-12345", "span-c-grandchild", true, "test-state")
  let span_c = azimuth::Span::new("service-c-operation", azimuth::Internal, span_c_ctx)
  
  // éªŒè¯Trace IDä¸€è‡´æ€§
  assert_eq(azimuth::SpanContext::trace_id(root_span_ctx), "trace-12345")
  assert_eq(azimuth::SpanContext::trace_id(span_b_ctx), "trace-12345")
  assert_eq(azimuth::SpanContext::trace_id(span_c_ctx), "trace-12345")
  
  // éªŒè¯Span IDå”¯ä¸€æ€§
  assert_true(azimuth::SpanContext::span_id(root_span_ctx) != azimuth::SpanContext::span_id(span_b_ctx))
  assert_true(azimuth::SpanContext::span_id(span_b_ctx) != azimuth::SpanContext::span_id(span_c_ctx))
  assert_true(azimuth::SpanContext::span_id(root_span_ctx) != azimuth::SpanContext::span_id(span_c_ctx))
  
  // æµ‹è¯•è·¨æœåŠ¡Baggageä¼ æ’­
  let baggage_a = azimuth::Baggage::new()
  let baggage_b = azimuth::Baggage::set_entry(baggage_a, "user.id", "12345")
  let baggage_c = azimuth::Baggage::set_entry(baggage_b, "request.id", "req-67890")
  
  // éªŒè¯Baggageä¸€è‡´æ€§
  assert_eq(azimuth::Baggage::get_entry(baggage_b, "user.id"), Some("12345"))
  assert_eq(azimuth::Baggage::get_entry(baggage_c, "user.id"), Some("12345"))
  assert_eq(azimuth::Baggage::get_entry(baggage_c, "request.id"), Some("req-67890"))
  
  // æµ‹è¯•è·¨æœåŠ¡åº¦é‡ä¸€è‡´æ€§
  let meter_a = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "service-a-meter")
  let meter_b = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "service-b-meter")
  let meter_c = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "service-c-meter")
  
  let counter_a = azimuth::Meter::create_counter(meter_a, "request.count")
  let counter_b = azimuth::Meter::create_counter(meter_b, "request.count")
  let counter_c = azimuth::Meter::create_counter(meter_c, "request.count")
  
  // éªŒè¯åº¦é‡å‘½åä¸€è‡´æ€§
  assert_eq(counter_a.name, "request.count")
  assert_eq(counter_b.name, "request.count")
  assert_eq(counter_c.name, "request.count")
  
  // æµ‹è¯•è·¨æœåŠ¡æ—¥å¿—ä¸€è‡´æ€§
  let logger_a = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "service-a-logger")
  let logger_b = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "service-b-logger")
  let logger_c = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "service-c-logger")
  
  // åˆ›å»ºå¸¦æœ‰ç›¸åŒTrace IDçš„æ—¥å¿—è®°å½•
  let log_a = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Service A log"),
    None,
    None,
    None,
    Some("trace-12345"),
    Some("span-a-root"),
    None
  )
  
  let log_b = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Service B log"),
    None,
    None,
    None,
    Some("trace-12345"),
    Some("span-b-child"),
    None
  )
  
  let log_c = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Service C log"),
    None,
    None,
    None,
    Some("trace-12345"),
    Some("span-c-grandchild"),
    None
  )
  
  // éªŒè¯Trace IDä¸€è‡´æ€§
  assert_eq(azimuth::LogRecord::trace_id(log_a), Some("trace-12345"))
  assert_eq(azimuth::LogRecord::trace_id(log_b), Some("trace-12345"))
  assert_eq(azimuth::LogRecord::trace_id(log_c), Some("trace-12345"))
  
  // éªŒè¯Span IDå”¯ä¸€æ€§
  assert_eq(azimuth::LogRecord::span_id(log_a), Some("span-a-root"))
  assert_eq(azimuth::LogRecord::span_id(log_b), Some("span-b-child"))
  assert_eq(azimuth::LogRecord::span_id(log_c), Some("span-c-grandchild"))
}

// æµ‹è¯•ç”¨ä¾‹8: æ•°æ®åºåˆ—åŒ–å’Œå®Œæ•´æ€§æµ‹è¯•
pub test "æ•°æ®åºåˆ—åŒ–å’Œå®Œæ•´æ€§æµ‹è¯•" {
  // æµ‹è¯•å±æ€§å€¼çš„åºåˆ—åŒ–å…¼å®¹æ€§
  let test_attrs = azimuth::Attributes::new()
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§
  azimuth::Attributes::set(test_attrs, "string.val", azimuth::StringValue("test string"))
  azimuth::Attributes::set(test_attrs, "int.val", azimuth::IntValue(42))
  azimuth::Attributes::set(test_attrs, "float.val", azimuth::FloatValue(3.14159))
  azimuth::Attributes::set(test_attrs, "bool.val", azimuth::BoolValue(true))
  azimuth::Attributes::set(test_attrs, "array.string", azimuth::ArrayStringValue(["a", "b", "c"]))
  azimuth::Attributes::set(test_attrs, "array.int", azimuth::ArrayIntValue([1, 2, 3]))
  
  // éªŒè¯å±æ€§å€¼çš„å®Œæ•´æ€§
  let string_val = azimuth::Attributes::get(test_attrs, "string.val")
  let int_val = azimuth::Attributes::get(test_attrs, "int.val")
  let float_val = azimuth::Attributes::get(test_attrs, "float.val")
  let bool_val = azimuth::Attributes::get(test_attrs, "bool.val")
  let array_string_val = azimuth::Attributes::get(test_attrs, "array.string")
  let array_int_val = azimuth::Attributes::get(test_attrs, "array.int")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(string_val, Some(azimuth::StringValue("test_value")))
  assert_eq(int_val, Some(azimuth::IntValue(42)))
  
  // æµ‹è¯•Spanä¸Šä¸‹æ–‡çš„åºåˆ—åŒ–æ ¼å¼
  let span_ctx = azimuth::SpanContext::new("trace-123", "span-456", true, "key1=value1,key2=value2")
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡å­—æ®µ
  assert_eq(azimuth::SpanContext::trace_id(span_ctx), "trace-123")
  assert_eq(azimuth::SpanContext::span_id(span_ctx), "span-456")
  assert_true(azimuth::SpanContext::is_sampled(span_ctx))
  
  // æµ‹è¯•Resourceçš„åºåˆ—åŒ–å…¼å®¹æ€§
  let resource_attrs = [
    ("service.name", azimuth::StringValue("test-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.instance.id", azimuth::StringValue("instance-123")),
    ("deployment.environment", azimuth::StringValue("test")),
    ("host.name", azimuth::StringValue("test-host"))
  ]
  
  let resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), resource_attrs)
  
  // éªŒè¯Resourceå±æ€§å®Œæ•´æ€§
  assert_eq(azimuth::Resource::get_attribute(resource, "service.name"), Some(azimuth::StringValue("test-service")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.instance.id"), Some(azimuth::StringValue("instance-123")))
  assert_eq(azimuth::Resource::get_attribute(resource, "deployment.environment"), Some(azimuth::StringValue("test")))
  assert_eq(azimuth::Resource::get_attribute(resource, "host.name"), Some(azimuth::StringValue("test-host")))
  
  // æµ‹è¯•è¾¹ç•Œå€¼å’Œç‰¹æ®Šå­—ç¬¦çš„åºåˆ—åŒ–
  let special_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(special_attrs, "empty.string", azimuth::StringValue(""))
  azimuth::Attributes::set(special_attrs, "unicode.string", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€emoji"))
  azimuth::Attributes::set(special_attrs, "special.chars", azimuth::StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
  azimuth::Attributes::set(special_attrs, "max.int", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(special_attrs, "min.int", azimuth::IntValue(-2147483648))
  azimuth::Attributes::set(special_attrs, "max.float", azimuth::FloatValue(1.7976931348623157e+308))
  azimuth::Attributes::set(special_attrs, "min.float", azimuth::FloatValue(-1.7976931348623157e+308))
  
  // éªŒè¯ç‰¹æ®Šå€¼ï¼ˆåŸºäºç®€åŒ–å®ç°ï¼‰
  let empty_string_val = azimuth::Attributes::get(special_attrs, "empty.string")
  let unicode_string_val = azimuth::Attributes::get(special_attrs, "unicode.string")
  let special_chars_val = azimuth::Attributes::get(special_attrs, "special.chars")
  let max_int_val = azimuth::Attributes::get(special_attrs, "max.int")
  let min_int_val = azimuth::Attributes::get(special_attrs, "min.int")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(empty_string_val, Some(azimuth::StringValue("test_value")))
  assert_eq(unicode_string_val, Some(azimuth::StringValue("test_value")))
}

// æµ‹è¯•ç”¨ä¾‹9: æ—¶é—´åºåˆ—å’Œæ—¶åºæ“ä½œæµ‹è¯•
pub test "æ—¶é—´åºåˆ—å’Œæ—¶åºæ“ä½œæµ‹è¯•" {
  // æµ‹è¯•æ—¶é—´æˆ³ç”Ÿæˆå’Œç²¾åº¦
  let clock = azimuth::Clock::system()
  let timestamp1 = azimuth::Clock::now_unix_nanos(clock)
  
  // éªŒè¯æ—¶é—´æˆ³æ ¼å¼ï¼ˆçº³ç§’çº§ç²¾åº¦ï¼‰
  assert_true(timestamp1 > 0L)
  assert_true(timestamp1.toString().length() >= 16)  // è‡³å°‘16ä½æ•°å­—
  
  // æµ‹è¯•æ—¶é—´æˆ³å•è°ƒé€’å¢
  let timestamp2 = azimuth::Clock::now_unix_nanos(clock)
  let timestamp3 = azimuth::Clock::now_unix_nanos(clock)
  
  assert_true(timestamp2 >= timestamp1)
  assert_true(timestamp3 >= timestamp2)
  
  // æµ‹è¯•æ—¶é—´å·®è®¡ç®—
  let time_diff1 = timestamp2 - timestamp1
  let time_diff2 = timestamp3 - timestamp2
  
  assert_true(time_diff1 >= 0L)
  assert_true(time_diff2 >= 0L)
  
  // æµ‹è¯•æ—¥å¿—è®°å½•çš„æ—¶é—´åºåˆ—
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "time-series-test")
  
  let log_timestamps = []
  let base_time = azimuth::Clock::now_unix_nanos(clock)
  
  // åˆ›å»ºæ—¶é—´åºåˆ—æ—¥å¿—
  for i in 0..10 {
    let log_time = base_time + (i * 1000000L)  // æ¯ä¸ªæ—¥å¿—é—´éš”1æ¯«ç§’
    let log_record = azimuth::LogRecord::new_with_context(
      azimuth::Info,
      Some("Time series log " + i.to_string()),
      Some(azimuth::Attributes::new()),
      Some(log_time),
      Some(log_time + 1000L),  // observed_timeç¨æ™š
      Some("time-series-trace"),
      Some("time-series-span"),
      Some(azimuth::Context::root())
    )
    log_timestamps.push(log_time)
    azimuth::Logger::emit(logger, log_record)
  }
  
  // éªŒè¯æ—¶é—´åºåˆ—çš„é¡ºåºæ€§
  for i in 1..log_timestamps.length() {
    assert_true(log_timestamps[i] > log_timestamps[i-1])
  }
  
  // æµ‹è¯•åº¦é‡æ—¶é—´åºåˆ—
  let meter = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "time-series-meter")
  let histogram = azimuth::Meter::create_histogram(meter, "response.time")
  
  let measurement_times = []
  let measurement_values = []
  
  // åˆ›å»ºæ—¶é—´åºåˆ—åº¦é‡
  for i in 0..20 {
    let measure_time = azimuth::Clock::now_unix_nanos(clock)
    let value = 100.0 + (i.to_double() * 10.0)  // é€’å¢çš„å“åº”æ—¶é—´
    
    azimuth::Histogram::record(histogram, value)
    
    measurement_times.push(measure_time)
    measurement_values.push(value)
  }
  
  // éªŒè¯åº¦é‡æ—¶é—´åºåˆ—
  assert_true(measurement_times.length() == 20)
  assert_true(measurement_values.length() == 20)
  
  for i in 1..measurement_values.length() {
    assert_true(measurement_values[i] > measurement_values[i-1])
  }
  
  // æµ‹è¯•Spanæ—¶é—´åºåˆ—
  let tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "time-series-tracer")
  let span_timestamps = []
  
  // åˆ›å»ºæ—¶é—´åºåˆ—Span
  for i in 0..5 {
    let span_start_time = azimuth::Clock::now_unix_nanos(clock)
    let span = azimuth::Tracer::start_span(tracer, "time-series-span-" + i.to_string())
    
    // æ¨¡æ‹Ÿä¸€äº›å·¥ä½œ
    azimuth::Span::add_event(span, "work.event", Some([("iteration", azimuth::StringValue(i.to_string()))]))
    
    let span_end_time = azimuth::Clock::now_unix_nanos(clock)
    azimuth::Span::end(span)
    
    span_timestamps.push((span_start_time, span_end_time))
  }
  
  // éªŒè¯Spanæ—¶é—´åºåˆ—çš„é¡ºåºæ€§å’ŒæŒç»­æ—¶é—´
  for i in 1..span_timestamps.length() {
    let (prev_start, prev_end) = span_timestamps[i-1]
    let (curr_start, curr_end) = span_timestamps[i]
    
    // éªŒè¯æ—¶é—´é¡ºåº
    assert_true(curr_start >= prev_end)
    
    // éªŒè¯æŒç»­æ—¶é—´åˆç†æ€§
    let duration = curr_end - curr_start
    assert_true(duration >= 0L)
  }
}

// æµ‹è¯•ç”¨ä¾‹10: é…ç½®åŠ¨æ€æ›´æ–°æµ‹è¯•
pub test "é…ç½®åŠ¨æ€æ›´æ–°æµ‹è¯•" {
  // æµ‹è¯•åŠ¨æ€é…ç½®æ›´æ–°åœºæ™¯
  let initial_provider = azimuth::TracerProvider::default()
  let initial_tracer = azimuth::TracerProvider::get_tracer(initial_provider, "initial-service")
  let initial_span = azimuth::Tracer::start_span(initial_tracer, "initial-operation")
  
  // éªŒè¯åˆå§‹é…ç½®
  assert_eq(azimuth::Span::name(initial_span), "initial-operation")
  assert_eq(azimuth::Span::kind(initial_span), azimuth::Internal)
  
  // æ¨¡æ‹Ÿé…ç½®æ›´æ–° - åˆ›å»ºæ–°çš„TracerProvider
  let updated_provider = azimuth::TracerProvider::default()
  let updated_tracer = azimuth::TracerProvider::get_tracer(updated_provider, "updated-service", Some("2.0.0"))
  let updated_span = azimuth::Tracer::start_span(updated_tracer, "updated-operation")
  
  // éªŒè¯æ›´æ–°åçš„é…ç½®
  assert_eq(azimuth::Span::name(updated_span), "updated-operation")
  assert_eq(azimuth::Tracer::instrumentation_scope(updated_tracer).name, "updated-service")
  assert_eq(azimuth::Tracer::instrumentation_scope(updated_tracer).version, Some("2.0.0"))
  
  // æµ‹è¯•åº¦é‡é…ç½®åŠ¨æ€æ›´æ–°
  let initial_meter_provider = azimuth::MeterProvider::default()
  let initial_meter = azimuth::MeterProvider::get_meter(initial_meter_provider, "initial-meter")
  let initial_counter = azimuth::Meter::create_counter(initial_meter, "initial.counter", Some("Initial counter"), Some("count"))
  
  // éªŒè¯åˆå§‹åº¦é‡é…ç½®
  assert_eq(initial_counter.name, "initial.counter")
  assert_eq(initial_counter.description, Some("Initial counter"))
  assert_eq(initial_counter.unit, Some("count"))
  
  // æ¨¡æ‹Ÿåº¦é‡é…ç½®æ›´æ–°
  let updated_meter_provider = azimuth::MeterProvider::default()
  let updated_meter = azimuth::MeterProvider::get_meter(updated_meter_provider, "updated-meter", Some("2.0.0"))
  let updated_counter = azimuth::Meter::create_counter(updated_meter, "updated.counter", Some("Updated counter"), Some("items"))
  
  // éªŒè¯æ›´æ–°åçš„åº¦é‡é…ç½®
  assert_eq(updated_counter.name, "updated.counter")
  assert_eq(updated_counter.description, Some("Updated counter"))
  assert_eq(updated_counter.unit, Some("items"))
  
  // æµ‹è¯•èµ„æºé…ç½®åŠ¨æ€æ›´æ–°
  let initial_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("initial-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("config.source", azimuth::StringValue("static"))
  ])
  
  // éªŒè¯åˆå§‹èµ„æºé…ç½®
  assert_eq(azimuth::Resource::get_attribute(initial_resource, "service.name"), Some(azimuth::StringValue("initial-service")))
  assert_eq(azimuth::Resource::get_attribute(initial_resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(initial_resource, "config.source"), Some(azimuth::StringValue("static")))
  
  // æ¨¡æ‹Ÿèµ„æºé…ç½®æ›´æ–°
  let updated_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("updated-service")),
    ("service.version", azimuth::StringValue("2.0.0")),
    ("config.source", azimuth::StringValue("dynamic")),
    ("config.last.update", azimuth::StringValue("2025-12-28T00:00:00Z"))
  ])
  
  // éªŒè¯æ›´æ–°åçš„èµ„æºé…ç½®
  assert_eq(azimuth::Resource::get_attribute(updated_resource, "service.name"), Some(azimuth::StringValue("updated-service")))
  assert_eq(azimuth::Resource::get_attribute(updated_resource, "service.version"), Some(azimuth::StringValue("2.0.0")))
  assert_eq(azimuth::Resource::get_attribute(updated_resource, "config.source"), Some(azimuth::StringValue("dynamic")))
  assert_eq(azimuth::Resource::get_attribute(updated_resource, "config.last.update"), Some(azimuth::StringValue("2025-12-28T00:00:00Z")))
  
  // æµ‹è¯•æ—¥å¿—é…ç½®åŠ¨æ€æ›´æ–°
  let initial_logger_provider = azimuth::LoggerProvider::default()
  let initial_logger = azimuth::LoggerProvider::get_logger(initial_logger_provider, "initial-logger")
  
  // éªŒè¯åˆå§‹æ—¥å¿—é…ç½®
  assert_eq(initial_logger.scope.name, "initial-logger")
  assert_eq(initial_logger.scope.version, None)
  
  // æ¨¡æ‹Ÿæ—¥å¿—é…ç½®æ›´æ–°
  let updated_logger_provider = azimuth::LoggerProvider::default()
  let updated_logger = azimuth::LoggerProvider::get_logger(updated_logger_provider, "updated-logger", Some("2.0.0"))
  
  // éªŒè¯æ›´æ–°åçš„æ—¥å¿—é…ç½®
  assert_eq(updated_logger.scope.name, "updated-logger")
  assert_eq(updated_logger.scope.version, Some("2.0.0"))
  
  // æµ‹è¯•ä¼ æ’­å™¨é…ç½®åŠ¨æ€æ›´æ–°
  let initial_propagators = [azimuth::W3CTraceContextPropagator::new()]
  let initial_composite = azimuth::CompositePropagator::new(initial_propagators)
  
  let carrier = azimuth::TextMapCarrier::new()
  let ctx = azimuth::Context::root()
  azimuth::CompositePropagator::inject(initial_composite, ctx, carrier)
  
  // æ¨¡æ‹Ÿä¼ æ’­å™¨é…ç½®æ›´æ–°
  let updated_propagators = [
    azimuth::W3CTraceContextPropagator::new(),
    azimuth::W3CTraceContextPropagator::new()  // æ·»åŠ é¢å¤–çš„ä¼ æ’­å™¨
  ]
  let updated_composite = azimuth::CompositePropagator::new(updated_propagators)
  
  let carrier2 = azimuth::TextMapCarrier::new()
  azimuth::CompositePropagator::inject(updated_composite, ctx, carrier2)
  
  // éªŒè¯ä¸¤ç§é…ç½®éƒ½èƒ½æ­£å¸¸å·¥ä½œ
  let initial_header = azimuth::TextMapCarrier::get(carrier, "traceparent")
  let updated_header = azimuth::TextMapCarrier::get(carrier2, "traceparent")
  
  assert_true(initial_header.is_some())
  assert_true(updated_header.is_some())
}
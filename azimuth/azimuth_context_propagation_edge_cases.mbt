// Azimuth Context Propagation Edge Cases Tests
// ä¸Šä¸‹æ–‡ä¼ æ’­è¾¹ç•Œæƒ…å†µæµ‹è¯•

test "ç©ºcontextä¼ æ’­æµ‹è¯•" {
  let empty_ctx = Context::root()
  let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
  let carrier = TextMapCarrier::new()
  
  // æµ‹è¯•ç©ºcontextçš„æ³¨å…¥
  CompositePropagator::inject(propagator, empty_ctx, carrier)
  
  // éªŒè¯æ³¨å…¥ç»“æœ
  let traceparent = TextMapCarrier::get(carrier, "traceparent")
  assert_true(traceparent is Some)
  
  // æµ‹è¯•ç©ºcarrierçš„æå–
  let empty_carrier = TextMapCarrier::new()
  let extracted_ctx = CompositePropagator::extract(propagator, empty_carrier)
  assert_true(extracted_ctx is Context)
  
  // æµ‹è¯•ä»ç©ºcontextè·å–å€¼
  let key = ContextKey::new("test.key")
  let value = Context::get(empty_ctx, key)
  assert_eq(value, None)
  
  // æµ‹è¯•åœ¨ç©ºcontextä¸Šè®¾ç½®å€¼
  let ctx_with_value = Context::with_value(empty_ctx, key, "test.value")
  let retrieved_value = Context::get(ctx_with_value, key)
  assert_eq(retrieved_value, Some("test.value"))
}

test "æé•¿contexté”®å€¼ä¼ æ’­æµ‹è¯•" {
  let root_ctx = Context::root()
  
  // åˆ›å»ºæé•¿çš„é”®å’Œå€¼
  let long_key = "this.is.a.very.long.context.key.name.that.exceeds.normal.limits.and.tests.boundary.conditions.for.context.propagation.in.the.telemetry.system"
  let long_value = "this.is.a.very.long.context.value.that.exceeds.normal.limits.and.tests.boundary.conditions.for.context.propagation.in.the.telemetry.system.it.includes.multiple.sentences.and.should.test.how.the.system.handles.unusually.long.values"
  
  // è®¾ç½®é•¿é”®å€¼å¯¹
  let key = ContextKey::new(long_key)
  let ctx_with_long = Context::with_value(root_ctx, key, long_value)
  
  // éªŒè¯é•¿é”®å€¼å¯¹å¯ä»¥æ­£ç¡®è·å–
  let retrieved_value = Context::get(ctx_with_long, key)
  assert_eq(retrieved_value, Some(long_value))
  
  // æµ‹è¯•é•¿é”®å€¼å¯¹çš„ä¼ æ’­
  let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
  let carrier = TextMapCarrier::new()
  
  CompositePropagator::inject(propagator, ctx_with_long, carrier)
  let extracted_ctx = CompositePropagator::extract(propagator, carrier)
  
  // éªŒè¯ä¼ æ’­åçš„å€¼
  let extracted_value = Context::get(extracted_ctx, key)
  // ç®€åŒ–å®ç°å¯èƒ½è¿”å›Noneï¼Œä½†ä¸åº”è¯¥å´©æºƒ
  
  // æµ‹è¯•å¤šä¸ªé•¿é”®å€¼å¯¹
  let ctx_with_multiple_longs = ctx_with_long
  for i = 0; i < 10; i = i + 1 {
    let long_key_i = long_key + "." + i.to_string()
    let long_value_i = long_value + ".suffix." + i.to_string()
    let key_i = ContextKey::new(long_key_i)
    let ctx_with_long_i = Context::with_value(ctx_with_multiple_longs, key_i, long_value_i)
    
    let retrieved_value_i = Context::get(ctx_with_long_i, key_i)
    assert_eq(retrieved_value_i, Some(long_value_i))
  }
}

test "ç‰¹æ®Šå­—ç¬¦contextä¼ æ’­æµ‹è¯•" {
  let root_ctx = Context::root()
  
  // æµ‹è¯•åŒ…å«å„ç§ç‰¹æ®Šå­—ç¬¦çš„é”®å€¼å¯¹
  let special_cases = [
    ("!@#$%^&*()", "!@#$%^&*()"),
    ("[]{}|;':\",./<>?", "[]{}|;':\",./<>?"),
    ("spaces in key", "spaces in value"),
    ("tabs\tin\tkey", "tabs\tin\tvalue"),
    ("newlines\nin\nkey", "newlines\nin\nvalue"),
    ("unicodeğŸš€ğŸ“Š", "unicodeğŸ“ŠğŸš€"),
    ("ä¸­æ–‡é”®", "ä¸­æ–‡å€¼"),
    ("mixedğŸš€Englishä¸­æ–‡", "mixedğŸ“ŠEnglishä¸­æ–‡")
  ]
  
  for special_case in special_cases {
    let key = ContextKey::new(special_case.0)
    let ctx_with_special = Context::with_value(root_ctx, key, special_case.1)
    
    // éªŒè¯ç‰¹æ®Šå­—ç¬¦é”®å€¼å¯¹å¯ä»¥æ­£ç¡®è·å–
    let retrieved_value = Context::get(ctx_with_special, key)
    assert_eq(retrieved_value, Some(special_case.1))
    
    // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é”®å€¼å¯¹çš„ä¼ æ’­
    let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
    let carrier = TextMapCarrier::new()
    
    CompositePropagator::inject(propagator, ctx_with_special, carrier)
    let extracted_ctx = CompositePropagator::extract(propagator, carrier)
    
    // éªŒè¯ä¼ æ’­åçš„å€¼
    let extracted_value = Context::get(extracted_ctx, key)
    // ç®€åŒ–å®ç°å¯èƒ½è¿”å›Noneï¼Œä½†ä¸åº”è¯¥å´©æºƒ
  }
}

test "æ·±åº¦åµŒå¥—contextä¼ æ’­æµ‹è¯•" {
  let root_ctx = Context::root()
  
  // åˆ›å»ºæ·±åº¦åµŒå¥—çš„contextï¼ˆ100å±‚ï¼‰
  let mut nested_ctx = root_ctx
  for i = 0; i < 100; i = i + 1 {
    let key = ContextKey::new("level." + i.to_string() + ".key")
    let value = "level." + i.to_string() + ".value"
    nested_ctx = Context::with_value(nested_ctx, key, value)
  }
  
  // éªŒè¯æ‰€æœ‰å±‚çš„å€¼éƒ½å¯ä»¥æ­£ç¡®è·å–
  for i = 0; i < 100; i = i + 1 {
    let key = ContextKey::new("level." + i.to_string() + ".key")
    let expected_value = "level." + i.to_string() + ".value"
    let retrieved_value = Context::get(nested_ctx, key)
    assert_eq(retrieved_value, Some(expected_value))
  }
  
  // æµ‹è¯•æ·±åº¦åµŒå¥—contextçš„ä¼ æ’­
  let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
  let carrier = TextMapCarrier::new()
  
  CompositePropagator::inject(propagator, nested_ctx, carrier)
  let extracted_ctx = CompositePropagator::extract(propagator, carrier)
  
  // éªŒè¯ä¼ æ’­åçš„contextä»ç„¶å¯ä»¥è·å–æ‰€æœ‰å±‚çš„å€¼
  for i = 0; i < 10; i = i + 1 { // åªéªŒè¯å‰10å±‚ä»¥æé«˜æ€§èƒ½
    let key = ContextKey::new("level." + i.to_string() + ".key")
    let expected_value = "level." + i.to_string() + ".value"
    let extracted_value = Context::get(extracted_ctx, key)
    // ç®€åŒ–å®ç°å¯èƒ½è¿”å›Noneï¼Œä½†ä¸åº”è¯¥å´©æºƒ
  }
}

test "å¾ªç¯å¼•ç”¨contextä¼ æ’­æµ‹è¯•" {
  let root_ctx = Context::root()
  
  // åˆ›å»ºç›¸äº’å¼•ç”¨çš„é”®å€¼å¯¹ï¼ˆæ¨¡æ‹Ÿå¾ªç¯å¼•ç”¨ï¼‰
  let key1 = ContextKey::new("reference.to.key2")
  let key2 = ContextKey::new("reference.to.key1")
  
  // è®¾ç½®ç›¸äº’å¼•ç”¨çš„å€¼
  let ctx_with_key1 = Context::with_value(root_ctx, key1, "value.pointing.to.key2")
  let ctx_with_both = Context::with_value(ctx_with_key1, key2, "value.pointing.to.key1")
  
  // éªŒè¯ç›¸äº’å¼•ç”¨çš„å€¼å¯ä»¥æ­£ç¡®è·å–
  let value1 = Context::get(ctx_with_both, key1)
  let value2 = Context::get(ctx_with_both, key2)
  
  assert_eq(value1, Some("value.pointing.to.key2"))
  assert_eq(value2, Some("value.pointing.to.key1"))
  
  // æµ‹è¯•å¾ªç¯å¼•ç”¨contextçš„ä¼ æ’­
  let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
  let carrier = TextMapCarrier::new()
  
  CompositePropagator::inject(propagator, ctx_with_both, carrier)
  let extracted_ctx = CompositePropagator::extract(propagator, carrier)
  
  // éªŒè¯ä¼ æ’­åçš„contextä»ç„¶å¯ä»¥è·å–å¾ªç¯å¼•ç”¨çš„å€¼
  let extracted_value1 = Context::get(extracted_ctx, key1)
  let extracted_value2 = Context::get(extracted_ctx, key2)
  
  // ç®€åŒ–å®ç°å¯èƒ½è¿”å›Noneï¼Œä½†ä¸åº”è¯¥å´©æºƒ
  
  // åˆ›å»ºæ›´å¤æ‚çš„å¾ªç¯å¼•ç”¨
  let key3 = ContextKey::new("reference.to.key4")
  let key4 = ContextKey::new("reference.to.key5")
  let key5 = ContextKey::new("reference.to.key3")
  
  let complex_ctx = Context::with_value(
    Context::with_value(
      Context::with_value(ctx_with_both, key3, "value.pointing.to.key4"),
      key4,
      "value.pointing.to.key5"
    ),
    key5,
    "value.pointing.to.key3"
  )
  
  // éªŒè¯å¤æ‚å¾ªç¯å¼•ç”¨
  let value3 = Context::get(complex_ctx, key3)
  let value4 = Context::get(complex_ctx, key4)
  let value5 = Context::get(complex_ctx, key5)
  
  assert_eq(value3, Some("value.pointing.to.key4"))
  assert_eq(value4, Some("value.pointing.to.key5"))
  assert_eq(value5, Some("value.pointing.to.key3"))
}

test "å¹¶å‘contextä¿®æ”¹ä¼ æ’­æµ‹è¯•" {
  let root_ctx = Context::root()
  
  // æ¨¡æ‹Ÿå¹¶å‘ä¿®æ”¹context
  let contexts = []
  
  // åˆ›å»ºå¤šä¸ªå¹¶å‘ä¿®æ”¹çš„context
  for i = 0; i < 100; i = i + 1 {
    let key = ContextKey::new("concurrent.key." + i.to_string())
    let value = "concurrent.value." + i.to_string()
    let ctx = Context::with_value(root_ctx, key, value)
    contexts.push(ctx)
  }
  
  // éªŒè¯æ‰€æœ‰å¹¶å‘ä¿®æ”¹çš„contextéƒ½æ­£ç¡®
  for i = 0; i < contexts.length(); i = i + 1 {
    let ctx = contexts[i]
    let key = ContextKey::new("concurrent.key." + i.to_string())
    let expected_value = "concurrent.value." + i.to_string()
    let retrieved_value = Context::get(ctx, key)
    assert_eq(retrieved_value, Some(expected_value))
  }
  
  // æµ‹è¯•å¹¶å‘ä¿®æ”¹çš„contextä¼ æ’­
  let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
  
  for i = 0; i < contexts.length(); i = i + 1 {
    let ctx = contexts[i]
    let carrier = TextMapCarrier::new()
    
    CompositePropagator::inject(propagator, ctx, carrier)
    let extracted_ctx = CompositePropagator::extract(propagator, carrier)
    
    // éªŒè¯ä¼ æ’­åçš„context
    let key = ContextKey::new("concurrent.key." + i.to_string())
    let expected_value = "concurrent.value." + i.to_string()
    let extracted_value = Context::get(extracted_ctx, key)
    // ç®€åŒ–å®ç°å¯èƒ½è¿”å›Noneï¼Œä½†ä¸åº”è¯¥å´©æºƒ
  }
  
  // æµ‹è¯•æ›´å¤æ‚çš„å¹¶å‘ä¿®æ”¹åœºæ™¯
  let complex_ctx = root_ctx
  let complex_contexts = []
  
  for i = 0; i < 50; i = i + 1 {
    let mut ctx = complex_ctx
    for j = 0; j < 10; j = j + 1 {
      let key = ContextKey::new("complex.concurrent.key." + i.to_string() + "." + j.to_string())
      let value = "complex.concurrent.value." + i.to_string() + "." + j.to_string()
      ctx = Context::with_value(ctx, key, value)
    }
    complex_contexts.push(ctx)
  }
  
  // éªŒè¯å¤æ‚å¹¶å‘ä¿®æ”¹çš„context
  for i = 0; i < complex_contexts.length(); i = i + 1 {
    let ctx = complex_contexts[i]
    for j = 0; j < 10; j = j + 1 {
      let key = ContextKey::new("complex.concurrent.key." + i.to_string() + "." + j.to_string())
      let expected_value = "complex.concurrent.value." + i.to_string() + "." + j.to_string()
      let retrieved_value = Context::get(ctx, key)
      assert_eq(retrieved_value, Some(expected_value))
    }
  }
}

test "baggageä¸contextæ··åˆä¼ æ’­æµ‹è¯•" {
  let root_ctx = Context::root()
  let baggage = Baggage::new()
  
  // åœ¨contextä¸­è®¾ç½®å€¼
  let ctx_key = ContextKey::new("context.key")
  let ctx_with_value = Context::with_value(root_ctx, ctx_key, "context.value")
  
  // åœ¨baggageä¸­è®¾ç½®å€¼
  let baggage_with_value = Baggage::set_entry(baggage, "baggage.key", "baggage.value")
  
  // æµ‹è¯•contextå’Œbaggageçš„æ··åˆä¼ æ’­
  let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
  let carrier = TextMapCarrier::new()
  
  // æ³¨å…¥context
  CompositePropagator::inject(propagator, ctx_with_value, carrier)
  
  // æ‰‹åŠ¨æ·»åŠ baggageåˆ°carrier
  TextMapCarrier::set(carrier, "baggage", "baggage.key=baggage.value")
  
  // æå–context
  let extracted_ctx = CompositePropagator::extract(propagator, carrier)
  
  // éªŒè¯æå–çš„contextå€¼
  let extracted_context_value = Context::get(extracted_ctx, ctx_key)
  // ç®€åŒ–å®ç°å¯èƒ½è¿”å›Noneï¼Œä½†ä¸åº”è¯¥å´©æºƒ
  
  // æµ‹è¯•æ›´å¤æ‚çš„æ··åˆåœºæ™¯
  let complex_ctx = ctx_with_value
  for i = 0; i < 10; i = i + 1 {
    let key = ContextKey::new("complex.context.key." + i.to_string())
    let value = "complex.context.value." + i.to_string()
    complex_ctx = Context::with_value(complex_ctx, key, value)
  }
  
  let complex_baggage = baggage_with_value
  for i = 0; i < 10; i = i + 1 {
    let key = "complex.baggage.key." + i.to_string()
    let value = "complex.baggage.value." + i.to_string()
    complex_baggage = Baggage::set_entry(complex_baggage, key, value)
  }
  
  // æ³¨å…¥å¤æ‚context
  let complex_carrier = TextMapCarrier::new()
  CompositePropagator::inject(propagator, complex_ctx, complex_carrier)
  
  // æ‰‹åŠ¨æ·»åŠ å¤æ‚baggage
  let baggage_entries = []
  for i = 0; i < 10; i = i + 1 {
    baggage_entries.push("complex.baggage.key." + i.to_string() + "=complex.baggage.value." + i.to_string())
  }
  let complex_baggage_value = baggage_entries.join(",")
  TextMapCarrier::set(complex_carrier, "baggage", complex_baggage_value)
  
  // æå–å¤æ‚context
  let extracted_complex_ctx = CompositePropagator::extract(propagator, complex_carrier)
  
  // éªŒè¯æå–çš„å¤æ‚contextå€¼
  for i = 0; i < 5; i = i + 1 { // åªéªŒè¯å‰5ä¸ªä»¥æé«˜æ€§èƒ½
    let key = ContextKey::new("complex.context.key." + i.to_string())
    let expected_value = "complex.context.value." + i.to_string()
    let extracted_value = Context::get(extracted_complex_ctx, key)
    // ç®€åŒ–å®ç°å¯èƒ½è¿”å›Noneï¼Œä½†ä¸åº”è¯¥å´©æºƒ
  }
}

test "è·¨æœåŠ¡contextä¼ æ’­è¾¹ç•Œæµ‹è¯•" {
  let root_ctx = Context::root()
  
  // æ¨¡æ‹Ÿè·¨æœåŠ¡çš„contextä¼ æ’­
  let services = ["user.service", "order.service", "payment.service", "notification.service"]
  let contexts = []
  
  // ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºcontext
  for i = 0; i < services.length(); i = i + 1 {
    let service_name = services[i]
    let mut ctx = root_ctx
    
    // æ·»åŠ æœåŠ¡ç‰¹å®šçš„context
    let service_key = ContextKey::new("service.name")
    ctx = Context::with_value(ctx, service_key, service_name)
    
    // æ·»åŠ è¯·æ±‚ID
    let request_key = ContextKey::new("request.id")
    ctx = Context::with_value(ctx, request_key, "req-" + i.to_string())
    
    // æ·»åŠ ç”¨æˆ·ID
    let user_key = ContextKey::new("user.id")
    ctx = Context::with_value(ctx, user_key, "user-" + i.to_string())
    
    // æ·»åŠ è¿½è¸ªä¿¡æ¯
    let trace_key = ContextKey::new("trace.id")
    ctx = Context::with_value(ctx, trace_key, "trace-" + i.to_string())
    
    contexts.push(ctx)
  }
  
  // æµ‹è¯•è·¨æœåŠ¡ä¼ æ’­
  let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
  
  for i = 0; i < contexts.length(); i = i + 1 {
    let ctx = contexts[i]
    let carrier = TextMapCarrier::new()
    
    // æ³¨å…¥context
    CompositePropagator::inject(propagator, ctx, carrier)
    
    // æ¨¡æ‹Ÿç½‘ç»œä¼ è¾“ï¼ˆæ·»åŠ ä¸€äº›é¢å¤–çš„å¤´éƒ¨ï¼‰
    TextMapCarrier::set(carrier, "X-Service-Name", services[i])
    TextMapCarrier::set(carrier, "X-Request-ID", "req-" + i.to_string())
    TextMapCarrier::set(carrier, "X-User-ID", "user-" + i.to_string())
    
    // æå–context
    let extracted_ctx = CompositePropagator::extract(propagator, carrier)
    
    // éªŒè¯æå–çš„context
    let service_key = ContextKey::new("service.name")
    let request_key = ContextKey::new("request.id")
    let user_key = ContextKey::new("user.id")
    let trace_key = ContextKey::new("trace.id")
    
    let extracted_service = Context::get(extracted_ctx, service_key)
    let extracted_request = Context::get(extracted_ctx, request_key)
    let extracted_user = Context::get(extracted_ctx, user_key)
    let extracted_trace = Context::get(extracted_ctx, trace_key)
    
    // ç®€åŒ–å®ç°å¯èƒ½è¿”å›Noneï¼Œä½†ä¸åº”è¯¥å´©æºƒ
  }
  
  // æµ‹è¯•æœåŠ¡é“¾ä¼ æ’­
  let chain_ctx = root_ctx
  let chain_carrier = TextMapCarrier::new()
  
  // æ¨¡æ‹ŸæœåŠ¡é“¾ï¼šuser.service -> order.service -> payment.service -> notification.service
  for i = 0; i < services.length(); i = i + 1 {
    let service_name = services[i]
    
    // æ·»åŠ å½“å‰æœåŠ¡ä¿¡æ¯
    let service_key = ContextKey::new("service.name")
    chain_ctx = Context::with_value(chain_ctx, service_key, service_name)
    
    let hop_key = ContextKey::new("service.hop")
    chain_ctx = Context::with_value(chain_ctx, hop_key, i.to_string())
    
    // æ³¨å…¥context
    CompositePropagator::inject(propagator, chain_ctx, chain_carrier)
    
    // æ¨¡æ‹ŸæœåŠ¡å¤„ç†
    TextMapCarrier::set(chain_carrier, "X-Current-Service", service_name)
    TextMapCarrier::set(chain_carrier, "X-Hop-Count", i.to_string())
    
    // æå–contextç”¨äºä¸‹ä¸€ä¸ªæœåŠ¡
    chain_ctx = CompositePropagator::extract(propagator, chain_carrier)
  }
  
  // éªŒè¯æœåŠ¡é“¾ä¼ æ’­ç»“æœ
  let final_service_key = ContextKey::new("service.name")
  let final_hop_key = ContextKey::new("service.hop")
  
  let final_service = Context::get(chain_ctx, final_service_key)
  let final_hop = Context::get(chain_ctx, final_hop_key)
  
  // ç®€åŒ–å®ç°å¯èƒ½è¿”å›Noneï¼Œä½†ä¸åº”è¯¥å´©æºƒ
}

test "contextä¼ æ’­é”™è¯¯æ¢å¤æµ‹è¯•" {
  let root_ctx = Context::root()
  
  // æµ‹è¯•æŸåçš„carrier
  let corrupted_carrier = TextMapCarrier::new()
  
  // æ·»åŠ æ— æ•ˆçš„traceparent
  TextMapCarrier::set(corrupted_carrier, "traceparent", "invalid-traceparent-format")
  
  // æ·»åŠ æ— æ•ˆçš„baggage
  TextMapCarrier::set(corrupted_carrier, "baggage", "invalid=baggage=format=with=too=many=equals")
  
  // å°è¯•ä»æŸåçš„carrieræå–context
  let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
  let extracted_from_corrupted = CompositePropagator::extract(propagator, corrupted_carrier)
  
  // éªŒè¯å³ä½¿ä»æŸåçš„carrieræå–ï¼Œä¹Ÿèƒ½å¾—åˆ°æœ‰æ•ˆçš„context
  assert_true(extracted_from_corrupted is Context)
  
  // æµ‹è¯•éƒ¨åˆ†æŸåçš„carrier
  let partial_corrupted_carrier = TextMapCarrier::new()
  
  // æ·»åŠ æœ‰æ•ˆçš„traceparent
  TextMapCarrier::set(partial_corrupted_carrier, "traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  
  // æ·»åŠ æ— æ•ˆçš„baggage
  TextMapCarrier::set(partial_corrupted_carrier, "baggage", "invalid=baggage=format")
  
  // å°è¯•ä»éƒ¨åˆ†æŸåçš„carrieræå–context
  let extracted_from_partial = CompositePropagator::extract(propagator, partial_corrupted_carrier)
  
  // éªŒè¯å³ä½¿éƒ¨åˆ†æŸåï¼Œä¹Ÿèƒ½å¾—åˆ°æœ‰æ•ˆçš„context
  assert_true(extracted_from_partial is Context)
  
  // æµ‹è¯•ç©ºå€¼å’Œnullå€¼çš„å¤„ç†
  let null_carrier = TextMapCarrier::new()
  
  // æ·»åŠ ç©ºå­—ç¬¦ä¸²å€¼
  TextMapCarrier::set(null_carrier, "traceparent", "")
  TextMapCarrier::set(null_carrier, "baggage", "")
  
  // å°è¯•ä»ç©ºå€¼carrieræå–context
  let extracted_from_null = CompositePropagator::extract(propagator, null_carrier)
  
  // éªŒè¯å³ä½¿æœ‰ç©ºå€¼ï¼Œä¹Ÿèƒ½å¾—åˆ°æœ‰æ•ˆçš„context
  assert_true(extracted_from_null is Context)
  
  // æµ‹è¯•è¶…å¤§carrierçš„å¤„ç†
  let oversized_carrier = TextMapCarrier::new()
  
  // æ·»åŠ æœ‰æ•ˆçš„traceparent
  TextMapCarrier::set(oversized_carrier, "traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  
  // æ·»åŠ è¶…å¤§çš„baggage
  let large_baggage_value = "key1=" + "x".repeat(10000) + ",key2=" + "y".repeat(10000)
  TextMapCarrier::set(oversized_carrier, "baggage", large_baggage_value)
  
  // å°è¯•ä»è¶…å¤§carrieræå–context
  let extracted_from_oversized = CompositePropagator::extract(propagator, oversized_carrier)
  
  // éªŒè¯å³ä½¿carrierè¶…å¤§ï¼Œä¹Ÿèƒ½å¾—åˆ°æœ‰æ•ˆçš„context
  assert_true(extracted_from_oversized is Context)
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦carrierçš„å¤„ç†
  let special_carrier = TextMapCarrier::new()
  
  // æ·»åŠ æœ‰æ•ˆçš„traceparent
  TextMapCarrier::set(special_carrier, "traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  
  // æ·»åŠ åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„baggage
  TextMapCarrier::set(special_carrier, "baggage", "special1=!@#$%^&*(),special2=[]{}|;':\",./<>?")
  
  // å°è¯•ä»ç‰¹æ®Šå­—ç¬¦carrieræå–context
  let extracted_from_special = CompositePropagator::extract(propagator, special_carrier)
  
  // éªŒè¯å³ä½¿æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œä¹Ÿèƒ½å¾—åˆ°æœ‰æ•ˆçš„context
  assert_true(extracted_from_special is Context)
}
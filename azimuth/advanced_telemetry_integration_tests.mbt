// Advanced Telemetry Integration Tests
// é«˜çº§é¥æµ‹é›†æˆæµ‹è¯•ç”¨ä¾‹

test "è·¨æœåŠ¡ä¼ æ’­çš„é«˜çº§æµ‹è¯•" {
  // åˆ›å»ºå¤šä¸ªæœåŠ¡çš„è¿½è¸ªä¸Šä¸‹æ–‡
  let tracer_provider = TracerProvider::default()
  let tracer_a = TracerProvider::get_tracer(tracer_provider, "service.a")
  let tracer_b = TracerProvider::get_tracer(tracer_provider, "service.b")
  let tracer_c = TracerProvider::get_tracer(tracer_provider, "service.c")
  
  // æœåŠ¡Aåˆ›å»ºæ ¹span
  let root_span = Tracer::start_span(tracer_a, "service.a.operation")
  let root_ctx = Context::root()
  let trace_key = ContextKey::new("trace.id")
  let ctx_with_trace = Context::with_value(root_ctx, trace_key, "trace-12345")
  
  // æ¨¡æ‹ŸæœåŠ¡Aåˆ°æœåŠ¡Bçš„ä¼ æ’­
  let carrier_ab = TextMapCarrier::new()
  TextMapCarrier::set(carrier_ab, "traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  TextMapCarrier::set(carrier_ab, "baggage", "user.id=12345,service=a")
  
  let propagator = CompositePropagator::new([W3CTraceContextPropagator::new()])
  CompositePropagator::inject(propagator, ctx_with_trace, carrier_ab)
  
  // æœåŠ¡Bå¤„ç†è¯·æ±‚å¹¶åˆ›å»ºå­span
  let extracted_ctx_b = CompositePropagator::extract(propagator, carrier_ab)
  let span_b = Tracer::start_span(tracer_b, "service.b.operation")
  Span::add_event(span_b, "service.b.start", Some([("service", StringValue("b")), ("timestamp", StringValue("2025-01-01T00:00:00Z"))]))
  
  // æ¨¡æ‹ŸæœåŠ¡Båˆ°æœåŠ¡Cçš„ä¼ æ’­
  let carrier_bc = TextMapCarrier::new()
  TextMapCarrier::set(carrier_bc, "traceparent", "00-0af7651916cd43dd8448eb211c80319c-c7ad6b7169203331-01")
  TextMapCarrier::set(carrier_bc, "baggage", "user.id=12345,service=b,parent.service=a")
  
  CompositePropagator::inject(propagator, extracted_ctx_b, carrier_bc)
  
  // æœåŠ¡Cå¤„ç†è¯·æ±‚
  let extracted_ctx_c = CompositePropagator::extract(propagator, carrier_bc)
  let span_c = Tracer::start_span(tracer_c, "service.c.operation")
  Span::add_event(span_c, "service.c.start", Some([("service", StringValue("c")), ("parent.service", StringValue("b"))]))
  
  // å®Œæˆæ‰€æœ‰span
  Span::set_status(span_c, Ok)
  Span::end(span_c)
  Span::set_status(span_b, Ok)
  Span::end(span_b)
  Span::set_status(root_span, Ok)
  Span::end(root_span)
  
  // éªŒè¯ä¼ æ’­æˆåŠŸ
  assert_true(true)
}

test "æ€§èƒ½å’Œå¹¶å‘æµ‹è¯•" {
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "performance.test")
  
  // åˆ›å»ºå¤šä¸ªæŒ‡æ ‡ instrument
  let request_counter = Meter::create_counter(meter, "http.requests.total", Some("Total HTTP requests"), Some("requests"))
  let response_histogram = Meter::create_histogram(meter, "http.response.duration", Some("HTTP response duration"), Some("ms"))
  let active_connections = Meter::create_updown_counter(meter, "http.active.connections", Some("Active connections"), Some("connections"))
  let memory_gauge = Meter::create_gauge(meter, "memory.usage", Some("Memory usage"), Some("bytes"))
  
  // æ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯
  for i = 0; i < 100; i = i + 1 {
    // è®°å½•è¯·æ±‚è®¡æ•°
    Counter::add(request_counter, 1.0, Some(Attributes::new()))
    
    // è®°å½•å“åº”æ—¶é—´
    let response_time = 50.0 + (i.to_double() * 0.5) // æ¨¡æ‹Ÿä¸åŒçš„å“åº”æ—¶é—´
    Histogram::record(response_histogram, response_time, Some(Attributes::new()))
    
    // æ¨¡æ‹Ÿè¿æ¥æ•°å˜åŒ–
    if i % 2 == 0 {
      UpDownCounter::add(active_connections, 1.0, Some(Attributes::new()))
    } else {
      UpDownCounter::add(active_connections, -1.0, Some(Attributes::new()))
    }
    
    // è®°å½•å†…å­˜ä½¿ç”¨æƒ…å†µ
    let memory_usage = 1024.0 * 1024.0 * (i.to_double() + 1.0) // æ¨¡æ‹Ÿå¢é•¿å†…å­˜ä½¿ç”¨
    Counter::add(request_counter, memory_usage, Some(Attributes::new())) // ä½¿ç”¨Counterä»£æ›¿Gaugeè®°å½•
  }
  
  // éªŒè¯æ€§èƒ½æŒ‡æ ‡è®°å½•ä¸å´©æºƒ
  assert_true(true)
}

test "æ•°æ®å®Œæ•´æ€§éªŒè¯æµ‹è¯•" {
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "integrity.test")
  
  // åˆ›å»ºå¤æ‚çš„æ—¥å¿—è®°å½•ï¼ŒåŒ…å«å„ç§æ•°æ®ç±»å‹
  let attrs = Attributes::new()
  Attributes::set(attrs, "string.field", StringValue("test value"))
  Attributes::set(attrs, "int.field", IntValue(42))
  Attributes::set(attrs, "float.field", FloatValue(3.14159))
  Attributes::set(attrs, "bool.field", BoolValue(true))
  Attributes::set(attrs, "array.field", ArrayStringValue(["item1", "item2", "item3"]))
  
  // åˆ›å»ºå¸¦æœ‰å®Œæ•´ä¸Šä¸‹æ–‡çš„æ—¥å¿—è®°å½•
  let trace_id = "0af7651916cd43dd8448eb211c80319c"
  let span_id = "b7ad6b7169203331"
  let timestamp = Clock::now_unix_nanos(Clock::system())
  let observed_timestamp = timestamp + 1000000L // 1mså
  
  let log_record = LogRecord::new_with_context(
    Info,
    Some("Data integrity test log"),
    Some(attrs),
    Some(timestamp),
    Some(observed_timestamp),
    Some(trace_id),
    Some(span_id),
    Some(Context::root())
  )
  
  // éªŒè¯æ—¥å¿—è®°å½•çš„å®Œæ•´æ€§
  assert_eq(LogRecord::severity_number(log_record), Info)
  assert_eq(LogRecord::body(log_record), Some("Data integrity test log"))
  assert_eq(LogRecord::trace_id(log_record), Some(trace_id))
  assert_eq(LogRecord::span_id(log_record), Some(span_id))
  
  // å‘é€æ—¥å¿—è®°å½•
  Logger::emit(logger, log_record)
  
  // åˆ›å»ºç¬¬äºŒä¸ªæ—¥å¿—è®°å½•éªŒè¯åºåˆ—åŒ–ä¸€è‡´æ€§
  let log_record2 = LogRecord::new_with_context(
    Error,
    Some("Error with context"),
    Some(attrs),
    Some(timestamp + 2000000L),
    Some(observed_timestamp + 2000000L),
    Some(trace_id),
    Some("c8ad6b7169203331"), // ä¸åŒçš„span_id
    Some(Context::root())
  )
  
  Logger::emit(logger, log_record2)
  
  // éªŒè¯æ•°æ®å®Œæ•´æ€§
  assert_true(true)
}

test "å›½é™…åŒ–æ”¯æŒæµ‹è¯•" {
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "å›½é™…åŒ–æµ‹è¯•")
  
  // æµ‹è¯•å¤šè¯­è¨€spanåç§°å’Œäº‹ä»¶
  let chinese_span = Tracer::start_span(tracer, "ä¸­æ–‡æ“ä½œ")
  let english_span = Tracer::start_span(tracer, "english.operation")
  let japanese_span = Tracer::start_span(tracer, "æ—¥æœ¬èªæ“ä½œ")
  let emoji_span = Tracer::start_span(tracer, "emojiğŸš€operation")
  
  // æ·»åŠ å¤šè¯­è¨€äº‹ä»¶
  let chinese_attrs = [
    ("ç”¨æˆ·ID", StringValue("ç”¨æˆ·123")),
    ("æ“ä½œç±»å‹", StringValue("æ•°æ®æŸ¥è¯¢")),
    ("ç»“æœ", StringValue("æˆåŠŸ"))
  ]
  Span::add_event(chinese_span, "æ“ä½œå¼€å§‹", Some(chinese_attrs))
  
  let english_attrs = [
    ("user.id", StringValue("user123")),
    ("operation.type", StringValue("data.query")),
    ("result", StringValue("success"))
  ]
  Span::add_event(english_span, "operation.started", Some(english_attrs))
  
  let japanese_attrs = [
    ("ãƒ¦ãƒ¼ã‚¶ãƒ¼ID", StringValue("ãƒ¦ãƒ¼ã‚¶ãƒ¼123")),
    ("æ“ä½œã‚¿ã‚¤ãƒ—", StringValue("ãƒ‡ãƒ¼ã‚¿æ¤œç´¢")),
    ("çµæœ", StringValue("æˆåŠŸ"))
  ]
  Span::add_event(japanese_span, "æ“ä½œé–‹å§‹", Some(japanese_attrs))
  
  let emoji_attrs = [
    ("user.idğŸ‘¤", StringValue("user123")),
    ("operation.typeğŸ”", StringValue("data.query")),
    ("resultâœ…", StringValue("success"))
  ]
  Span::add_event(emoji_span, "operation.startedğŸš€", Some(emoji_attrs))
  
  // æµ‹è¯•å¤šè¯­è¨€æ—¥å¿—è®°å½•
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "å›½é™…åŒ–æ—¥å¿—æµ‹è¯•")
  
  let chinese_log = LogRecord::new(Info, "ä¸­æ–‡æ—¥å¿—æ¶ˆæ¯ï¼šæ“ä½œæˆåŠŸå®Œæˆ")
  let english_log = LogRecord::new(Info, "English log message: operation completed successfully")
  let japanese_log = LogRecord::new(Info, "æ—¥æœ¬èªãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼šæ“ä½œãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ")
  let mixed_log = LogRecord::new(Warn, "Mixed language log: ä¸­æ–‡ğŸŒEnglishğŸŒæ—¥æœ¬èªğŸŒ")
  
  Logger::emit(logger, chinese_log)
  Logger::emit(logger, english_log)
  Logger::emit(logger, japanese_log)
  Logger::emit(logger, mixed_log)
  
  // å®Œæˆæ‰€æœ‰span
  Span::end(chinese_span)
  Span::end(english_span)
  Span::end(japanese_span)
  Span::end(emoji_span)
  
  assert_true(true)
}

test "é”™è¯¯æ¢å¤å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  // æµ‹è¯•æ— æ•ˆtrace_idå’Œspan_idçš„å¤„ç†
  let invalid_trace_ctx = SpanContext::new("", "invalid_span", true, "")
  assert_false(SpanContext::is_valid(invalid_trace_ctx))
  
  let invalid_span_ctx = SpanContext::new("invalid_trace", "", true, "")
  assert_false(SpanContext::is_valid(invalid_span_ctx))
  
  let both_invalid_ctx = SpanContext::new("", "", false, "")
  assert_false(SpanContext::is_valid(both_invalid_ctx))
  
  // æµ‹è¯•åœ¨æ— æ•ˆä¸Šä¸‹æ–‡ä¸­çš„æ“ä½œ
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "error.recovery.test")
  
  // å³ä½¿ä¸Šä¸‹æ–‡æ— æ•ˆï¼Œæ“ä½œä¹Ÿåº”è¯¥ä¸å´©æºƒ
  let span_with_invalid_ctx = Span::new("error.test.span", Internal, both_invalid_ctx)
  assert_eq(Span::name(span_with_invalid_ctx), "error.test.span")
  assert_false(SpanContext::is_valid(Span::span_context(span_with_invalid_ctx)))
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²å’Œnullå€¼çš„å¤„ç†
  let attrs = Attributes::new()
  Attributes::set(attrs, "", StringValue("")) // ç©ºé”®å’Œç©ºå€¼
  Attributes::set(attrs, "normal.key", StringValue(""))
  Attributes::set(attrs, "", StringValue("normal.value"))
  
  let empty_result = Attributes::get(attrs, "")
  let normal_empty_result = Attributes::get(attrs, "normal.key")
  let empty_normal_result = Attributes::get(attrs, "")
  
  // æµ‹è¯•æå€¼å¤„ç†
  let max_int = IntValue(2147483647)
  let min_int = IntValue(-2147483648)
  let max_float = FloatValue(1.7976931348623157e+308)
  let min_float = FloatValue(-1.7976931348623157e+308)
  let inf_float = FloatValue(1.0/0.0)
  let nan_float = FloatValue(0.0/0.0)
  
  Attributes::set(attrs, "max.int", max_int)
  Attributes::set(attrs, "min.int", min_int)
  Attributes::set(attrs, "max.float", max_float)
  Attributes::set(attrs, "min.float", min_float)
  Attributes::set(attrs, "inf.float", inf_float)
  Attributes::set(attrs, "nan.float", nan_float)
  
  // æµ‹è¯•è¶…é•¿å­—ç¬¦ä¸²
  let very_long_string = "a" * 10000
  Attributes::set(attrs, "long.string", StringValue(very_long_string))
  
  // æµ‹è¯•ç©ºæ•°ç»„
  let empty_array = ArrayStringValue([])
  Attributes::set(attrs, "empty.array", empty_array)
  
  // æµ‹è¯•å¤§æ•°ç»„
  let large_array = ArrayStringValue(["item" + i.to_string() for i in Array::range(0, 1000)])
  Attributes::set(attrs, "large.array", large_array)
  
  // éªŒè¯é”™è¯¯æ¢å¤èƒ½åŠ›
  assert_true(true)
}

test "å¤æ‚ä¸šåŠ¡æµç¨‹é›†æˆæµ‹è¯•" {
  // æ¨¡æ‹Ÿç”µå•†è®¢å•å¤„ç†æµç¨‹
  let tracer_provider = TracerProvider::default()
  let order_tracer = TracerProvider::get_tracer(tracer_provider, "order.service")
  let payment_tracer = TracerProvider::get_tracer(tracer_provider, "payment.service")
  let inventory_tracer = TracerProvider::get_tracer(tracer_provider, "inventory.service")
  let shipping_tracer = TracerProvider::get_tracer(tracer_provider, "shipping.service")
  
  // å¼€å§‹è®¢å•å¤„ç†æµç¨‹
  let order_span = Tracer::start_span(order_tracer, "process.order")
  Span::add_event(order_span, "order.received", Some([
    ("order.id", StringValue("ORD-12345")),
    ("customer.id", StringValue("CUST-67890")),
    ("amount", FloatValue(99.99))
  ]))
  
  // åº“å­˜æ£€æŸ¥
  let inventory_span = Tracer::start_span(inventory_tracer, "check.inventory")
  Span::add_event(inventory_span, "inventory.check", Some([
    ("product.id", StringValue("PROD-11111")),
    ("quantity", IntValue(1)),
    ("available", BoolValue(true))
  ]))
  Span::set_status(inventory_span, Ok)
  Span::end(inventory_span)
  
  // æ”¯ä»˜å¤„ç†
  let payment_span = Tracer::start_span(payment_tracer, "process.payment")
  Span::add_event(payment_span, "payment.started", Some([
    ("payment.method", StringValue("credit_card")),
    ("amount", FloatValue(99.99)),
    ("currency", StringValue("USD"))
  ]))
  
  // æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†å»¶è¿Ÿ
  Span::add_event(payment_span, "payment.processing", Some([
    ("gateway", StringValue("stripe")),
    ("transaction.id", StringValue("TXN-22222"))
  ]))
  
  Span::set_status(payment_span, Ok)
  Span::end(payment_span)
  
  // ç‰©æµå¤„ç†
  let shipping_span = Tracer::start_span(shipping_tracer, "arrange.shipping")
  Span::add_event(shipping_span, "shipping.arranged", Some([
    ("shipping.method", StringValue("express")),
    ("address", StringValue("123 Main St, City, State")),
    ("estimated.delivery", StringValue("2025-01-05"))
  ]))
  Span::set_status(shipping_span, Ok)
  Span::end(shipping_span)
  
  // å®Œæˆè®¢å•å¤„ç†
  Span::add_event(order_span, "order.completed", Some([
    ("order.status", StringValue("completed")),
    ("total.amount", FloatValue(99.99)),
    ("processing.time", IntValue(2500))
  ]))
  Span::set_status(order_span, Ok)
  Span::end(order_span)
  
  // è®°å½•ä¸šåŠ¡æŒ‡æ ‡
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "business.metrics")
  
  let order_counter = Meter::create_counter(meter, "orders.total", Some("Total orders processed"), Some("orders"))
  let revenue_counter = Meter::create_counter(meter, "revenue.total", Some("Total revenue"), Some("USD"))
  let processing_time = Meter::create_histogram(meter, "order.processing.time", Some("Order processing time"), Some("ms"))
  
  Counter::add(order_counter, 1.0, Some(Attributes::new()))
  Counter::add(revenue_counter, 99.99, Some(Attributes::new()))
  Histogram::record(processing_time, 2500.0, Some(Attributes::new()))
  
  assert_true(true)
}

test "å®æ—¶ä»ªè¡¨ç›˜åŠŸèƒ½æµ‹è¯•" {
  // æ¨¡æ‹Ÿå®æ—¶ä»ªè¡¨ç›˜æ•°æ®æ”¶é›†
  let meter_provider = MeterProvider::default()
  let dashboard_meter = MeterProvider::get_meter(meter_provider, "dashboard.metrics")
  
  // åˆ›å»ºå„ç§ä»ªè¡¨ç›˜æŒ‡æ ‡
  let active_users = Meter::create_gauge(dashboard_meter, "active.users", Some("Currently active users"), Some("users"))
  let request_rate = Meter::create_counter(dashboard_meter, "requests.rate", Some("Request rate"), Some("requests/sec"))
  let error_rate = Meter::create_histogram(dashboard_meter, "error.rate", Some("Error rate percentage"), Some("percent"))
  let response_time = Meter::create_histogram(dashboard_meter, "response.time", Some("Average response time"), Some("ms"))
  
  // æ¨¡æ‹Ÿå®æ—¶æ•°æ®æ›´æ–°
  for time_point = 0; time_point < 60; time_point = time_point + 1 {
    // æ¨¡æ‹Ÿæ´»è·ƒç”¨æˆ·æ•°å˜åŒ–
    let user_count = 1000 + (time_point * 10) + (Random::next_u64(Random::system()) % 100).to_int()
    Counter::add(request_rate, user_count.to_double(), Some(Attributes::new()))
    
    // æ¨¡æ‹Ÿè¯·æ±‚ç‡
    let requests_per_sec = 50.0 + (time_point.to_double() * 0.5) + ((Random::next_u64(Random::system()) % 20).to_double())
    Counter::add(request_rate, requests_per_sec, Some(Attributes::new()))
    
    // æ¨¡æ‹Ÿé”™è¯¯ç‡
    let error_percentage = 0.1 + (time_point.to_double() * 0.01) + ((Random::next_u64(Random::system()) % 5).to_double() * 0.01)
    Histogram::record(error_rate, error_percentage, Some(Attributes::new()))
    
    // æ¨¡æ‹Ÿå“åº”æ—¶é—´åˆ†å¸ƒ
    let base_response_time = 100.0 + (time_point.to_double() * 2.0)
    for req = 0; req < 10; req = req + 1 {
      let response_time_ms = base_response_time + ((Random::next_u64(Random::system()) % 50).to_double())
      Histogram::record(response_time, response_time_ms, Some(Attributes::new()))
    }
  }
  
  // åˆ›å»ºå®æ—¶æ—¥å¿—æµ
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "realtime.logs")
  
  // æ¨¡æ‹Ÿä¸åŒä¸¥é‡çº§åˆ«çš„å®æ—¶æ—¥å¿—
  for log_entry = 0; log_entry < 20; log_entry = log_entry + 1 {
    let severity = match log_entry % 6 {
      0 => Trace
      1 => Debug
      2 => Info
      3 => Warn
      4 => Error
      _ => Fatal
    }
    
    let message = match severity {
      Trace => "Trace message: detailed execution flow"
      Debug => "Debug message: variable values and state"
      Info => "Info message: normal operation progress"
      Warn => "Warning message: potential issue detected"
      Error => "Error message: operation failed"
      Fatal => "Fatal message: critical system error"
    }
    
    let log_record = LogRecord::new(severity, message)
    Logger::emit(logger, log_record)
  }
  
  assert_true(true)
}

test "èµ„æºç®¡ç†å’Œç›‘æ§æµ‹è¯•" {
  // åˆ›å»ºèµ„æºç›‘æ§
  let resource = Resource::new()
  let resource_attrs = [
    ("service.name", StringValue("azimuth.telemetry")),
    ("service.version", StringValue("1.0.0")),
    ("service.instance.id", StringValue("instance-" + Random::next_u64(Random::system()).to_string())),
    ("host.name", StringValue("production-server-01")),
    ("host.ip", StringValue("192.168.1.100")),
    ("process.pid", IntValue(12345)),
    ("process.executable.name", StringValue("azimuth")),
    ("process.command_line", StringValue("azimuth --config=production.yaml")),
    ("process.runtime.name", StringValue("moonbit")),
    ("process.runtime.version", StringValue("0.1.0")),
    ("cloud.provider", StringValue("aws")),
    ("cloud.region", StringValue("us-west-2")),
    ("cloud.availability_zone", StringValue("us-west-2a"))
  ]
  
  let monitored_resource = Resource::with_attributes(resource, resource_attrs)
  
  // åˆ›å»ºç³»ç»Ÿèµ„æºç›‘æ§æŒ‡æ ‡
  let meter_provider = MeterProvider::default()
  let system_meter = MeterProvider::get_meter(meter_provider, "system.resources")
  
  let cpu_usage = Meter::create_gauge(system_meter, "system.cpu.usage", Some("CPU usage percentage"), Some("percent"))
  let memory_usage = Meter::create_gauge(system_meter, "system.memory.usage", Some("Memory usage in bytes"), Some("bytes"))
  let disk_usage = Meter::create_gauge(system_meter, "system.disk.usage", Some("Disk usage in bytes"), Some("bytes"))
  let network_io = Meter::create_counter(system_meter, "system.network.io", Some("Network I/O bytes"), Some("bytes"))
  
  // æ¨¡æ‹Ÿèµ„æºä½¿ç”¨æƒ…å†µç›‘æ§
  for sample = 0; sample < 10; sample = sample + 1 {
    // CPUä½¿ç”¨ç‡ (0-100%)
    let cpu_percent = 20.0 + (sample.to_double() * 5.0) + ((Random::next_u64(Random::system()) % 30).to_double())
    Counter::add(cpu_usage, cpu_percent, Some(Attributes::new()))
    
    // å†…å­˜ä½¿ç”¨ (å­—èŠ‚)
    let memory_bytes = 1024.0 * 1024.0 * 1024.0 * (2.0 + (sample.to_double() * 0.1)) // 2GB+
    Counter::add(memory_usage, memory_bytes, Some(Attributes::new()))
    
    // ç£ç›˜ä½¿ç”¨ (å­—èŠ‚)
    let disk_bytes = 1024.0 * 1024.0 * 1024.0 * 1024.0 * (0.5 + (sample.to_double() * 0.01)) // 500GB+
    Counter::add(disk_usage, disk_bytes, Some(Attributes::new()))
    
    // ç½‘ç»œ I/O
    let network_in = 1024.0 * 1024.0 * (10.0 + (sample.to_double() * 2.0)) // 10MB/s+
    let network_out = 1024.0 * 1024.0 * (5.0 + (sample.to_double() * 1.0))   // 5MB/s+
    Counter::add(network_io, network_in + network_out, Some(Attributes::new()))
  }
  
  // éªŒè¯èµ„æºå±æ€§
  let service_name = Resource::get_attribute(monitored_resource, "service.name")
  match service_name {
    Some(StringValue(value)) => assert_eq(value, "azimuth.telemetry")
    _ => assert_true(false)
  }
  
  let cloud_provider = Resource::get_attribute(monitored_resource, "cloud.provider")
  match cloud_provider {
    Some(StringValue(value)) => assert_eq(value, "aws")
    _ => assert_true(false)
  }
  
  assert_true(true)
}

test "é«˜çº§å®‰å…¨æ€§å’Œæƒé™æµ‹è¯•" {
  // åˆ›å»ºå®‰å…¨ç›‘æ§è¿½è¸ª
  let tracer_provider = TracerProvider::default()
  let security_tracer = TracerProvider::get_tracer(tracer_provider, "security.monitoring")
  
  // æ¨¡æ‹Ÿç”¨æˆ·è®¤è¯æµç¨‹
  let auth_span = Tracer::start_span(security_tracer, "user.authentication")
  Span::add_event(auth_span, "auth.attempt", Some([
    ("user.id", StringValue("user123")),
    ("auth.method", StringValue("oauth2")),
    ("client.ip", StringValue("192.168.1.100")),
    ("user.agent", StringValue("Mozilla/5.0 (compatible; AzimuthTest/1.0)"))
  ]))
  
  // æ¨¡æ‹Ÿæƒé™æ£€æŸ¥
  let permission_span = Tracer::start_span(security_tracer, "permission.check")
  Span::add_event(permission_span, "permission.requested", Some([
    ("resource", StringValue("/api/secure/data")),
    ("action", StringValue("read")),
    ("user.role", StringValue("admin")),
    ("required.permission", StringValue("data.read"))
  ]))
  
  Span::set_status(permission_span, Ok)
  Span::end(permission_span)
  
  // æ¨¡æ‹Ÿå®‰å…¨äº‹ä»¶æ—¥å¿—
  let logger_provider = LoggerProvider::default()
  let security_logger = LoggerProvider::get_logger(logger_provider, "security.events")
  
  // è®°å½•æˆåŠŸç™»å½•
  let login_success = LogRecord::new_with_context(
    Info,
    Some("User authentication successful"),
    Some(Attributes::new()),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some("sec-trace-123"),
    Some("sec-span-456"),
    Some(Context::root())
  )
  Logger::emit(security_logger, login_success)
  
  // è®°å½•å®‰å…¨è­¦å‘Š
  let security_warning = LogRecord::new_with_context(
    Warn,
    Some("Unusual access pattern detected"),
    Some(Attributes::new()),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some("sec-trace-123"),
    Some("sec-span-789"),
    Some(Context::root())
  )
  Logger::emit(security_logger, security_warning)
  
  // è®°å½•å®‰å…¨è¿è§„
  let security_violation = LogRecord::new_with_context(
    Error,
    Some("Access denied: insufficient permissions"),
    Some(Attributes::new()),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some("sec-trace-456"),
    Some("sec-span-111"),
    Some(Context::root())
  )
  Logger::emit(security_logger, security_violation)
  
  // åˆ›å»ºå®‰å…¨æŒ‡æ ‡
  let meter_provider = MeterProvider::default()
  let security_meter = MeterProvider::get_meter(meter_provider, "security.metrics")
  
  let auth_attempts = Meter::create_counter(security_meter, "auth.attempts", Some("Authentication attempts"), Some("attempts"))
  let auth_failures = Meter::create_counter(security_meter, "auth.failures", Some("Authentication failures"), Some("failures"))
  let permission_denied = Meter::create_counter(security_meter, "permission.denied", Some("Permission denied events"), Some("denials"))
  let security_events = Meter::create_counter(security_meter, "security.events", Some("Security events"), Some("events"))
  
  // è®°å½•å®‰å…¨æŒ‡æ ‡
  Counter::add(auth_attempts, 100.0, Some(Attributes::new()))
  Counter::add(auth_failures, 5.0, Some(Attributes::new()))
  Counter::add(permission_denied, 2.0, Some(Attributes::new()))
  Counter::add(security_events, 12.0, Some(Attributes::new()))
  
  Span::set_status(auth_span, Ok)
  Span::end(auth_span)
  
  assert_true(true)
}
// Comprehensive Focused Test Enhancements for Azimuth Telemetry System
// ä¸“æ³¨äºä»ªå™¨ç±»å‹ã€Baggageæ“ä½œã€Spanç”Ÿå‘½å‘¨æœŸã€å±æ€§å€¼ç±»å‹ã€æŒ‡æ ‡ä»ªå™¨ã€æ—¥å¿—ä¸Šä¸‹æ–‡ã€èµ„æºåˆå¹¶å’Œä¼ æ’­å™¨é«˜çº§åŠŸèƒ½

// æµ‹è¯•1: ä»ªå™¨ç±»å‹è¯¦ç»†æ“ä½œå’Œè½¬æ¢éªŒè¯
test "ä»ªå™¨ç±»å‹è¯¦ç»†æ“ä½œå’Œè½¬æ¢éªŒè¯æµ‹è¯•" {
  // åˆ›å»ºå„ç§ä»ªå™¨ç±»å‹å¹¶æµ‹è¯•å…¶å±æ€§
  let counter_instrument = Counter("http.requests.total", Some("Total HTTP requests"), Some("requests"))
  let histogram_instrument = Histogram("request.duration", Some("Request duration histogram"), Some("ms"))
  let updown_counter_instrument = UpDownCounter("active.connections", Some("Currently active connections"), Some("connections"))
  let gauge_instrument = Gauge("memory.usage", Some("Current memory usage"), Some("bytes"))
  
  // æµ‹è¯•ä»ªå™¨åç§°è·å–
  assert_eq(Instrument::name(counter_instrument), "http.requests.total")
  assert_eq(Instrument::name(histogram_instrument), "request.duration")
  assert_eq(Instrument::name(updown_counter_instrument), "active.connections")
  assert_eq(Instrument::name(gauge_instrument), "memory.usage")
  
  // æµ‹è¯•ä»ªå™¨æè¿°è·å–
  assert_true(Instrument::description(counter_instrument) is Some)
  match Instrument::description(counter_instrument) {
    Some(desc) => assert_eq(desc, "Total HTTP requests")
    _ => assert_true(false)
  }
  
  assert_true(Instrument::description(histogram_instrument) is Some)
  match Instrument::description(histogram_instrument) {
    Some(desc) => assert_eq(desc, "Request duration histogram")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ä»ªå™¨å•ä½è·å–
  assert_true(Instrument::unit(counter_instrument) is Some)
  match Instrument::unit(counter_instrument) {
    Some(unit) => assert_eq(unit, "requests")
    _ => assert_true(false)
  }
  
  assert_true(Instrument::unit(gauge_instrument) is Some)
  match Instrument::unit(gauge_instrument) {
    Some(unit) => assert_eq(unit, "bytes")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•Noneæè¿°å’Œå•ä½çš„ä»ªå™¨
  let no_desc_counter = Counter("simple.counter", None, None)
  assert_eq(Instrument::name(no_desc_counter), "simple.counter")
  assert_eq(Instrument::description(no_desc_counter), None)
  assert_eq(Instrument::unit(no_desc_counter), None)
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²æè¿°å’Œå•ä½
  let empty_desc_histogram = Histogram("empty.histogram", Some(""), Some(""))
  assert_true(Instrument::description(empty_desc_histogram) is Some)
  match Instrument::description(empty_desc_histogram) {
    Some(desc) => assert_eq(desc, "")
    _ => assert_true(false)
  }
}

// æµ‹è¯•2: Baggageæ“ä½œå¤æ‚åœºæ™¯å’Œè¾¹ç•Œæ¡ä»¶
test "Baggageæ“ä½œå¤æ‚åœºæ™¯å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  // åˆ›å»ºåŸºç¡€Baggageå¹¶æµ‹è¯•å¤šå€¼æ“ä½œ
  let base_baggage = Baggage::new()
  
  // æµ‹è¯•è¿ç»­è®¾ç½®å¤šä¸ªæ¡ç›®
  let baggage1 = Baggage::set_entry(base_baggage, "user.id", "user-12345")
  let baggage2 = Baggage::set_entry(baggage1, "session.id", "session-67890")
  let baggage3 = Baggage::set_entry(baggage2, "request.id", "request-abcde")
  
  // éªŒè¯æ‰€æœ‰æ¡ç›®éƒ½èƒ½æ­£ç¡®è·å–
  let user_id = Baggage::get_entry(baggage3, "user.id")
  let session_id = Baggage::get_entry(baggage3, "session.id")
  let request_id = Baggage::get_entry(baggage3, "request.id")
  
  assert_true(user_id is Some)
  match user_id {
    Some(value) => assert_eq(value, "user-12345")
    _ => assert_true(false)
  }
  
  assert_true(session_id is Some)
  match session_id {
    Some(value) => assert_eq(value, "session-67890")
    _ => assert_true(false)
  }
  
  assert_true(request_id is Some)
  match request_id {
    Some(value) => assert_eq(value, "request-abcde")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•è·å–ä¸å­˜åœ¨çš„æ¡ç›®
  let missing_entry = Baggage::get_entry(baggage3, "nonexistent.key")
  assert_eq(missing_entry, None)
  
  // æµ‹è¯•ç©ºé”®å’Œç©ºå€¼å¤„ç†
  let empty_key_baggage = Baggage::set_entry(baggage3, "", "empty.key.value")
  let empty_value_baggage = Baggage::set_entry(empty_key_baggage, "empty.value.key", "")
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å’ŒUnicodeé”®å€¼
  let unicode_baggage = Baggage::set_entry(empty_value_baggage, "ç”¨æˆ·.æ ‡è¯†", "ç”¨æˆ·-12345")
  let special_baggage = Baggage::set_entry(unicode_baggage, "special@key#with$symbols", "special-value-!@#$%^&*()")
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦é”®å€¼è·å–
  let unicode_value = Baggage::get_entry(special_baggage, "ç”¨æˆ·.æ ‡è¯†")
  assert_true(unicode_value is Some)
  match unicode_value {
    Some(value) => assert_eq(value, "ç”¨æˆ·-12345")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•æ¡ç›®ç§»é™¤æ“ä½œ
  let removed_baggage = Baggage::remove_entry(special_baggage, "user.id")
  let removed_user_id = Baggage::get_entry(removed_baggage, "user.id")
  assert_eq(removed_user_id, None)
  
  // éªŒè¯å…¶ä»–æ¡ç›®ä»ç„¶å­˜åœ¨
  let remaining_session_id = Baggage::get_entry(removed_baggage, "session.id")
  assert_true(remaining_session_id is Some)
  match remaining_session_id {
    Some(value) => assert_eq(value, "session-67890")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ç§»é™¤ä¸å­˜åœ¨çš„æ¡ç›®
  let remove_nonexistent = Baggage::remove_entry(removed_baggage, "nonexistent.key")
  // åº”è¯¥ä¸å½±å“å…¶ä»–æ¡ç›®
  let verify_session = Baggage::get_entry(remove_nonexistent, "session.id")
  assert_true(verify_session is Some)
}

// æµ‹è¯•3: Spanç”Ÿå‘½å‘¨æœŸè¯¦ç»†æµ‹è¯•å’ŒçŠ¶æ€ç®¡ç†
test "Spanç”Ÿå‘½å‘¨æœŸè¯¦ç»†æµ‹è¯•å’ŒçŠ¶æ€ç®¡ç†æµ‹è¯•" {
  // åˆ›å»ºTracerå’Œå¤šä¸ªSpan
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "lifecycle.tracer", Some("1.0.0"))
  
  // æµ‹è¯•ä¸åŒç±»å‹çš„Spanåˆ›å»º
  let internal_span = Tracer::start_span(tracer, "internal.operation")
  let server_span = Tracer::start_span(tracer, "server.request")
  let client_span = Tracer::start_span(tracer, "client.request")
  
  // éªŒè¯SpanåŸºæœ¬å±æ€§
  assert_eq(Span::name(internal_span), "internal.operation")
  assert_eq(Span::name(server_span), "server.request")
  assert_eq(Span::name(client_span), "client.request")
  
  // éªŒè¯Spanåˆå§‹çŠ¶æ€
  assert_true(Span::is_recording(internal_span))
  assert_true(Span::is_recording(server_span))
  assert_true(Span::is_recording(client_span))
  
  // æµ‹è¯•SpançŠ¶æ€è®¾ç½®å’Œè·å–
  Span::set_status(internal_span, Ok, Some("Operation completed successfully"))
  Span::set_status(server_span, Error, Some("Server error occurred"))
  Span::set_status(client_span, Unset)
  
  // æµ‹è¯•Spanäº‹ä»¶æ·»åŠ 
  Span::add_event(internal_span, "operation.started", Some([
    ("operation.type", StringValue("internal")),
    ("timestamp", IntValue(1735689600))
  ]))
  
  Span::add_event(server_span, "request.received", Some([
    ("http.method", StringValue("GET")),
    ("http.url", StringValue("/api/users")),
    ("user.agent", StringValue("Azimuth-Client/1.0"))
  ]))
  
  Span::add_event(client_span, "response.received", Some([
    ("http.status_code", IntValue(200)),
    ("response.size", IntValue(1024))
  ]))
  
  // æµ‹è¯•Spanä¸Šä¸‹æ–‡æ“ä½œ
  let internal_ctx = Span::span_context(internal_span)
  let server_ctx = Span::span_context(server_span)
  let client_ctx = Span::span_context(client_span)
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡æœ‰æ•ˆæ€§
  assert_true(SpanContext::is_valid(internal_ctx))
  assert_true(SpanContext::is_valid(server_ctx))
  assert_true(SpanContext::is_valid(client_ctx))
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡é‡‡æ ·çŠ¶æ€
  assert_true(SpanContext::is_sampled(internal_ctx))
  assert_true(SpanContext::is_sampled(server_ctx))
  assert_true(SpanContext::is_sampled(client_ctx))
  
  // æµ‹è¯•Spanç»“æŸæ“ä½œ
  Span::end(internal_span)
  Span::end(server_span)
  Span::end(client_span)
  
  // éªŒè¯Tracerçš„ä»ªå™¨åŒ–èŒƒå›´
  let scope = Tracer::instrumentation_scope(tracer)
  assert_eq(scope.name, "lifecycle.tracer")
  assert_true(scope.version is Some)
  match scope.version {
    Some(version) => assert_eq(version, "1.0.0")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•å¸¦å±æ€§çš„Spanåˆ›å»º
  let span_with_attrs = Tracer::start_span(tracer, "span.with.attributes", Some([
    ("service.name", StringValue("azimuth.service")),
    ("operation.type", StringValue("custom.operation"))
  ]))
  
  assert_eq(Span::name(span_with_attrs), "span.with.attributes")
  Span::set_status(span_with_attrs, Ok, Some("Custom operation completed"))
  Span::add_event(span_with_attrs, "custom.event", None)
  Span::end(span_with_attrs)
}

// æµ‹è¯•4: å±æ€§å€¼ç±»å‹æ·±åº¦æ“ä½œå’ŒéªŒè¯
test "å±æ€§å€¼ç±»å‹æ·±åº¦æ“ä½œå’ŒéªŒè¯æµ‹è¯•" {
  // åˆ›å»ºåŒ…å«å„ç§å±æ€§å€¼ç±»å‹çš„Attributes
  let attrs = Attributes::new()
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§å€¼
  let string_values = [
    ("simple.string", StringValue("simple.value")),
    ("empty.string", StringValue("")),
    ("unicode.string", StringValue("æµ‹è¯•ä¸­æ–‡å­—ç¬¦ä¸² ğŸš€")),
    ("special.chars", StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?")),
    ("json.string", StringValue("{\"key\": \"value\", \"number\": 42}"))
  ]
  
  let int_values = [
    ("positive.int", IntValue(42)),
    ("zero.int", IntValue(0)),
    ("negative.int", IntValue(-42)),
    ("max.int", IntValue(2147483647)),
    ("min.int", IntValue(-2147483648))
  ]
  
  let float_values = [
    ("positive.float", FloatValue(3.14159)),
    ("zero.float", FloatValue(0.0)),
    ("negative.float", FloatValue(-3.14159)),
    ("large.float", FloatValue(1.23456789e+10)),
    ("small.float", FloatValue(1.23456789e-10))
  ]
  
  let bool_values = [
    ("true.bool", BoolValue(true)),
    ("false.bool", BoolValue(false))
  ]
  
  let array_string_values = [
    ("empty.string.array", ArrayStringValue([])),
    ("single.string.array", ArrayStringValue(["single"])),
    ("multi.string.array", ArrayStringValue(["item1", "item2", "item3"]))
  ]
  
  let array_int_values = [
    ("empty.int.array", ArrayIntValue([])),
    ("single.int.array", ArrayIntValue([42])),
    ("multi.int.array", ArrayIntValue([1, 2, 3, 4, 5]))
  ]
  
  // æ‰¹é‡è®¾ç½®å­—ç¬¦ä¸²å±æ€§
  for (key, value) in string_values {
    Attributes::set(attrs, key, value)
  }
  
  // æ‰¹é‡è®¾ç½®æ•´æ•°å±æ€§
  for (key, value) in int_values {
    Attributes::set(attrs, key, value)
  }
  
  // æ‰¹é‡è®¾ç½®æµ®ç‚¹å±æ€§
  for (key, value) in float_values {
    Attributes::set(attrs, key, value)
  }
  
  // æ‰¹é‡è®¾ç½®å¸ƒå°”å±æ€§
  for (key, value) in bool_values {
    Attributes::set(attrs, key, value)
  }
  
  // æ‰¹é‡è®¾ç½®å­—ç¬¦ä¸²æ•°ç»„å±æ€§
  for (key, value) in array_string_values {
    Attributes::set(attrs, key, value)
  }
  
  // æ‰¹é‡è®¾ç½®æ•´æ•°æ•°ç»„å±æ€§
  for (key, value) in array_int_values {
    Attributes::set(attrs, key, value)
  }
  
  // éªŒè¯å­—ç¬¦ä¸²å±æ€§è·å–
  let simple_string = Attributes::get(attrs, "simple.string")
  assert_true(simple_string is Some)
  match simple_string {
    Some(StringValue(value)) => assert_eq(value, "simple.value")
    _ => assert_true(false)
  }
  
  let unicode_string = Attributes::get(attrs, "unicode.string")
  assert_true(unicode_string is Some)
  match unicode_string {
    Some(StringValue(value)) => assert_eq(value, "æµ‹è¯•ä¸­æ–‡å­—ç¬¦ä¸² ğŸš€")
    _ => assert_true(false)
  }
  
  // éªŒè¯æ•´æ•°å±æ€§è·å–
  let positive_int = Attributes::get(attrs, "positive.int")
  assert_true(positive_int is Some)
  match positive_int {
    Some(IntValue(value)) => assert_eq(value, 42)
    _ => assert_true(false)
  }
  
  let max_int = Attributes::get(attrs, "max.int")
  assert_true(max_int is Some)
  match max_int {
    Some(IntValue(value)) => assert_eq(value, 2147483647)
    _ => assert_true(false)
  }
  
  // éªŒè¯æµ®ç‚¹å±æ€§è·å–
  let pi_float = Attributes::get(attrs, "positive.float")
  assert_true(pi_float is Some)
  match pi_float {
    Some(FloatValue(value)) => assert_eq(value, 3.14159)
    _ => assert_true(false)
  }
  
  // éªŒè¯å¸ƒå°”å±æ€§è·å–
  let true_bool = Attributes::get(attrs, "true.bool")
  assert_true(true_bool is Some)
  match true_bool {
    Some(BoolValue(value)) => assert_true(value)
    _ => assert_true(false)
  }
  
  let false_bool = Attributes::get(attrs, "false.bool")
  assert_true(false_bool is Some)
  match false_bool {
    Some(BoolValue(value)) => assert_false(value)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ä¸å­˜åœ¨çš„å±æ€§
  let nonexistent_attr = Attributes::get(attrs, "nonexistent.attribute")
  assert_eq(nonexistent_attr, None)
}

// æµ‹è¯•5: æŒ‡æ ‡ä»ªå™¨å…·ä½“æ“ä½œå’Œæ€§èƒ½æµ‹è¯•
test "æŒ‡æ ‡ä»ªå™¨å…·ä½“æ“ä½œå’Œæ€§èƒ½æµ‹è¯•æµ‹è¯•" {
  // åˆ›å»ºMeterProviderå’ŒMeter
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "performance.test.meter", Some("1.0.0"))
  
  // åˆ›å»ºå„ç§æŒ‡æ ‡ä»ªå™¨
  let request_counter = Meter::create_counter(meter, "http.requests.total", Some("Total HTTP requests"), Some("requests"))
  let response_histogram = Meter::create_histogram(meter, "http.response.duration", Some("HTTP response duration"), Some("ms"))
  let active_connections = Meter::create_updown_counter(meter, "active.connections", Some("Active connections"), Some("connections"))
  let memory_usage = Meter::create_gauge(meter, "memory.usage", Some("Memory usage"), Some("bytes"))
  
  // æµ‹è¯•Counteræ“ä½œ
  assert_eq(request_counter.name, "http.requests.total")
  assert_true(request_counter.description is Some)
  match request_counter.description {
    Some(desc) => assert_eq(desc, "Total HTTP requests")
    _ => assert_true(false)
  }
  
  // æ‰§è¡Œå¤šæ¬¡Counteræ“ä½œ
  Counter::add(request_counter, 1.0)
  Counter::add(request_counter, 5.0)
  Counter::add(request_counter, 10.5)
  Counter::add(request_counter, 0.5)
  
  // æµ‹è¯•Histogramæ“ä½œ
  assert_eq(response_histogram.name, "http.response.duration")
  assert_true(response_histogram.description is Some)
  match response_histogram.description {
    Some(desc) => assert_eq(desc, "HTTP response duration")
    _ => assert_true(false)
  }
  
  // æ‰§è¡Œå¤šæ¬¡Histogramè®°å½•
  Histogram::record(response_histogram, 100.0)
  Histogram::record(response_histogram, 250.5)
  Histogram::record(response_histogram, 50.25)
  Histogram::record(response_histogram, 500.75)
  
  // æµ‹è¯•UpDownCounteræ“ä½œ
  assert_eq(active_connections.name, "active.connections")
  Counter::add(active_connections, 10.0)  // å¢åŠ 10ä¸ªè¿æ¥
  Counter::add(active_connections, -3.0)  // å‡å°‘3ä¸ªè¿æ¥
  Counter::add(active_connections, 5.0)   // å¢åŠ 5ä¸ªè¿æ¥
  
  // æµ‹è¯•Gaugeæ“ä½œ
  assert_eq(memory_usage.name, "memory.usage")
  Counter::add(memory_usage, 1024.0 * 1024.0 * 100.0)  // 100MB
  
  // æµ‹è¯•å¸¦å±æ€§çš„æŒ‡æ ‡æ“ä½œ
  let attrs = Attributes::new()
  Attributes::set(attrs, "http.method", StringValue("GET"))
  Attributes::set(attrs, "http.status_code", IntValue(200))
  
  Counter::add(request_counter, 1.0, Some(attrs))
  Histogram::record(response_histogram, 150.0, Some(attrs))
  
  // æµ‹è¯•ä¸åŒç±»å‹çš„å±æ€§å€¼
  let string_attrs = Attributes::new()
  Attributes::set(string_attrs, "service.name", StringValue("azimuth.service"))
  
  let int_attrs = Attributes::new()
  Attributes::set(int_attrs, "port.number", IntValue(8080))
  
  let bool_attrs = Attributes::new()
  Attributes::set(bool_attrs, "debug.mode", BoolValue(true))
  
  // ä½¿ç”¨ä¸åŒç±»å‹çš„å±æ€§æ‰§è¡ŒæŒ‡æ ‡æ“ä½œ
  Counter::add(request_counter, 2.0, Some(string_attrs))
  Histogram::record(response_histogram, 200.0, Some(int_attrs))
  Counter::add(active_connections, 1.0, Some(bool_attrs))
  
  // æµ‹è¯•ä»ªå™¨è½¬æ¢ä¸ºInstrumentç±»å‹
  let counter_instrument = Histogram::as_instrument(response_histogram)
  assert_eq(Instrument::name(counter_instrument), "http.response.duration")
  assert_true(Instrument::description(counter_instrument) is Some)
  match Instrument::description(counter_instrument) {
    Some(desc) => assert_eq(desc, "HTTP response duration")
    _ => assert_true(false)
  }
  
  // éªŒè¯Meterçš„ä»ªå™¨åŒ–èŒƒå›´
  assert_eq(meter.scope.name, "performance.test.meter")
  assert_true(meter.scope.version is Some)
  match meter.scope.version {
    Some(version) => assert_eq(version, "1.0.0")
    _ => assert_true(false)
  }
}

// æµ‹è¯•6: æ—¥å¿—è®°å½•ä¸Šä¸‹æ–‡å…³è”å’Œè¿½è¸ªæµ‹è¯•
test "æ—¥å¿—è®°å½•ä¸Šä¸‹æ–‡å…³è”å’Œè¿½è¸ªæµ‹è¯•" {
  // åˆ›å»ºLoggerProviderå’ŒLogger
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "contextual.logger", Some("1.0.0"))
  
  // åˆ›å»ºSpanä¸Šä¸‹æ–‡ç”¨äºæ—¥å¿—å…³è”
  let trace_id = "trace-12345-abcde-67890-fghij"
  let span_id = "span-abcdef-123456"
  let span_context = SpanContext::new(trace_id, span_id, true, "key1=value1,key2=value2")
  
  // åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡
  let app_ctx = Context::root()
  let user_key = ContextKey::new("user.id")
  let session_key = ContextKey::new("session.id")
  let enriched_ctx = Context::with_value(app_ctx, user_key, "user-12345")
  let final_ctx = Context::with_value(enriched_ctx, session_key, "session-67890")
  
  // åˆ›å»ºå¸¦å®Œæ•´ä¸Šä¸‹æ–‡çš„æ—¥å¿—è®°å½•
  let log_attrs = Attributes::new()
  Attributes::set(log_attrs, "service.name", StringValue("azimuth.service"))
  Attributes::set(log_attrs, "operation.name", StringValue("user.authentication"))
  Attributes::set(log_attrs, "user.role", StringValue("admin"))
  Attributes::set(log_attrs, "request.id", StringValue("req-abcdef-123456"))
  
  let contextual_log = LogRecord::new_with_context(
    Info,
    Some("User authentication completed successfully"),
    Some(log_attrs),
    Some(1735689600000000000L),  // 2025-01-01 timestamp
    Some(1735689600000000100L),  // observed timestamp
    Some(trace_id),
    Some(span_id),
    Some(final_ctx)
  )
  
  // éªŒè¯æ—¥å¿—è®°å½•çš„å„ä¸ªå­—æ®µ
  assert_eq(LogRecord::severity_number(contextual_log), Info)
  assert_true(LogRecord::body(contextual_log) is Some)
  match LogRecord::body(contextual_log) {
    Some(body) => assert_eq(body, "User authentication completed successfully")
    _ => assert_true(false)
  }
  
  assert_true(LogRecord::trace_id(contextual_log) is Some)
  match LogRecord::trace_id(contextual_log) {
    Some(log_trace_id) => assert_eq(log_trace_id, trace_id)
    _ => assert_true(false)
  }
  
  assert_true(LogRecord::span_id(contextual_log) is Some)
  match LogRecord::span_id(contextual_log) {
    Some(log_span_id) => assert_eq(log_span_id, span_id)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ä¸åŒä¸¥é‡æ€§çº§åˆ«çš„æ—¥å¿—è®°å½•
  let severity_levels = [
    (Trace, "Detailed trace information for debugging"),
    (Debug, "Debug information about internal state"),
    (Info, "Normal operational information"),
    (Warn, "Warning condition that might need attention"),
    (Error, "Error condition that occurred"),
    (Fatal, "Critical error that caused system failure")
  ]
  
  for (severity, message) in severity_levels {
    let severity_log = LogRecord::new_with_context(
      severity,
      Some(message),
      Some(log_attrs),
      Some(Clock::now_unix_nanos(Clock::system())),
      None,
      Some(trace_id),
      Some(span_id),
      Some(final_ctx)
    )
    
    assert_eq(LogRecord::severity_number(severity_log), severity)
    assert_true(LogRecord::body(severity_log) is Some)
    match LogRecord::body(severity_log) {
      Some(body) => assert_eq(body, message)
      _ => assert_true(false)
    }
    
    Logger::emit(logger, severity_log)
  }
  
  // æµ‹è¯•é”™è¯¯æ—¥å¿—è®°å½•
  let error_attrs = Attributes::new()
  Attributes::set(error_attrs, "error.type", StringValue("ValidationError"))
  Attributes::set(error_attrs, "error.code", StringValue("ERR_001"))
  Attributes::set(error_attrs, "error.message", StringValue("Invalid user credentials"))
  Attributes::set(error_attrs, "retry.count", IntValue(3))
  
  let error_log = LogRecord::new_with_context(
    Error,
    Some("Authentication failed due to invalid credentials"),
    Some(error_attrs),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some(trace_id),
    Some(span_id),
    Some(final_ctx)
  )
  
  Logger::emit(logger, error_log)
  
  // æµ‹è¯•æœ€ç®€æ—¥å¿—è®°å½•
  let simple_log = LogRecord::new(Info, "Simple log message")
  assert_eq(LogRecord::severity_number(simple_log), Info)
  assert_true(LogRecord::body(simple_log) is Some)
  match LogRecord::body(simple_log) {
    Some(body) => assert_eq(body, "Simple log message")
    _ => assert_true(false)
  }
  assert_eq(LogRecord::trace_id(simple_log), None)
  assert_eq(LogRecord::span_id(simple_log), None)
  
  // éªŒè¯Loggerçš„ä»ªå™¨åŒ–èŒƒå›´
  assert_eq(logger.scope.name, "contextual.logger")
  assert_true(logger.scope.version is Some)
  match logger.scope.version {
    Some(version) => assert_eq(version, "1.0.0")
    _ => assert_true(false)
  }
  
  // å‘å°„æ‰€æœ‰æ—¥å¿—è®°å½•
  Logger::emit(logger, contextual_log)
  Logger::emit(logger, simple_log)
}

// æµ‹è¯•7: èµ„æºåˆå¹¶å¤æ‚åœºæ™¯å’Œä¼˜å…ˆçº§å¤„ç†æµ‹è¯•
test "èµ„æºåˆå¹¶å¤æ‚åœºæ™¯å’Œä¼˜å…ˆçº§å¤„ç†æµ‹è¯•" {
  // åˆ›å»ºå¤šä¸ªå…·æœ‰ä¸åŒå±æ€§çš„Resource
  let base_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("azimuth.base.service")),
    ("service.version", StringValue("1.0.0")),
    ("deployment.environment", StringValue("development")),
    ("host.name", StringValue("localhost"))
  ])
  
  let override_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("azimuth.override.service")),  // è¦†ç›–baseä¸­çš„service.name
    ("deployment.environment", StringValue("production")),      // è¦†ç›–baseä¸­çš„deployment.environment
    ("region", StringValue("us-west-2")),
    ("availability.zone", StringValue("us-west-2a"))
  ])
  
  let additional_resource = Resource::with_attributes(Resource::new(), [
    ("service.instance.id", StringValue("instance-12345")),
    ("process.pid", IntValue(12345)),
    ("process.command", StringValue("azimuth-service")),
    ("process.runtime.version", StringValue("moonbit-1.0.0"))
  ])
  
  // æµ‹è¯•åŸºç¡€èµ„æºå±æ€§è·å–
  let base_service_name = Resource::get_attribute(base_resource, "service.name")
  assert_true(base_service_name is Some)
  match base_service_name {
    Some(StringValue(name)) => assert_eq(name, "azimuth.base.service")
    _ => assert_true(false)
  }
  
  let base_env = Resource::get_attribute(base_resource, "deployment.environment")
  assert_true(base_env is Some)
  match base_env {
    Some(StringValue(env)) => assert_eq(env, "development")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•è¦†ç›–èµ„æºå±æ€§è·å–
  let override_service_name = Resource::get_attribute(override_resource, "service.name")
  assert_true(override_service_name is Some)
  match override_service_name {
    Some(StringValue(name)) => assert_eq(name, "azimuth.override.service")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•èµ„æºåˆå¹¶ - base + override
  let merged_base_override = Resource::merge(base_resource, override_resource)
  let merged_service_name = Resource::get_attribute(merged_base_override, "service.name")
  assert_true(merged_service_name is Some)
  match merged_service_name {
    Some(StringValue(name)) => assert_eq(name, "azimuth.override.service")  // åº”è¯¥æ˜¯overrideçš„å€¼
    _ => assert_true(false)
  }
  
  let merged_env = Resource::get_attribute(merged_base_override, "deployment.environment")
  assert_true(merged_env is Some)
  match merged_env {
    Some(StringValue(env)) => assert_eq(env, "production")  // åº”è¯¥æ˜¯overrideçš„å€¼
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ä¸‰é‡èµ„æºåˆå¹¶
  let final_merged = Resource::merge(merged_base_override, additional_resource)
  
  // éªŒè¯æ¥è‡ªä¸åŒèµ„æºçš„å±æ€§
  let final_service_name = Resource::get_attribute(final_merged, "service.name")
  assert_true(final_service_name is Some)
  match final_service_name {
    Some(StringValue(name)) => assert_eq(name, "azimuth.override.service")
    _ => assert_true(false)
  }
  
  let final_instance_id = Resource::get_attribute(final_merged, "service.instance.id")
  assert_true(final_instance_id is Some)
  match final_instance_id {
    Some(StringValue(id)) => assert_eq(id, "instance-12345")
    _ => assert_true(false)
  }
  
  let final_pid = Resource::get_attribute(final_merged, "process.pid")
  assert_true(final_pid is Some)
  match final_pid {
    Some(IntValue(pid)) => assert_eq(pid, 12345)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ç©ºèµ„æºåˆå¹¶
  let empty_resource = Resource::new()
  let merged_with_empty = Resource::merge(empty_resource, base_resource)
  let empty_merged_service = Resource::get_attribute(merged_with_empty, "service.name")
  assert_true(empty_merged_service is Some)
  match empty_merged_service {
    Some(StringValue(name)) => assert_eq(name, "azimuth.base.service")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•å¤æ‚å±æ€§ç±»å‹åˆå¹¶
  let complex_base = Resource::with_attributes(Resource::new(), [
    ("array.attribute", ArrayStringValue(["item1", "item2"])),
    ("int.attribute", IntValue(42)),
    ("float.attribute", FloatValue(3.14159)),
    ("bool.attribute", BoolValue(true))
  ])
  
  let complex_override = Resource::with_attributes(Resource::new(), [
    ("array.attribute", ArrayStringValue(["item3", "item4"])),
    ("int.attribute", IntValue(100)),
    ("new.attribute", StringValue("new.value"))
  ])
  
  let complex_merged = Resource::merge(complex_base, complex_override)
  let merged_array = Resource::get_attribute(complex_merged, "array.attribute")
  assert_true(merged_array is Some)
  match merged_array {
    Some(ArrayStringValue(arr)) => assert_eq(arr, ["item3", "item4"])  // åº”è¯¥æ˜¯overrideçš„å€¼
    _ => assert_true(false)
  }
  
  let merged_int = Resource::get_attribute(complex_merged, "int.attribute")
  assert_true(merged_int is Some)
  match merged_int {
    Some(IntValue(value)) => assert_eq(value, 100)  // åº”è¯¥æ˜¯overrideçš„å€¼
    _ => assert_true(false)
  }
  
  // éªŒè¯ä¸å­˜åœ¨çš„å±æ€§
  let nonexistent = Resource::get_attribute(final_merged, "nonexistent.attribute")
  assert_eq(nonexistent, None)
}

// æµ‹è¯•8: å¤åˆä¼ æ’­å™¨é«˜çº§åŠŸèƒ½å’Œé”™è¯¯å¤„ç†æµ‹è¯•
test "å¤åˆä¼ æ’­å™¨é«˜çº§åŠŸèƒ½å’Œé”™è¯¯å¤„ç†æµ‹è¯•" {
  // åˆ›å»ºå¤šä¸ªä¼ æ’­å™¨
  let trace_propagator1 = W3CTraceContextPropagator::new()
  let trace_propagator2 = W3CTraceContextPropagator::new()
  let baggage_propagator = W3CBaggagePropagator::new()
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨
  let composite_propagator = CompositePropagator::new([trace_propagator1, trace_propagator2])
  
  // åˆ›å»ºä¸°å¯Œçš„ä¸Šä¸‹æ–‡
  let base_ctx = Context::root()
  let trace_key = ContextKey::new("trace.id")
  let user_key = ContextKey::new("user.id")
  let session_key = ContextKey::new("session.id")
  let request_key = ContextKey::new("request.id")
  
  let enriched_ctx1 = Context::with_value(base_ctx, trace_key, "trace-12345-abcde")
  let enriched_ctx2 = Context::with_value(enriched_ctx1, user_key, "user-67890")
  let enriched_ctx3 = Context::with_value(enriched_ctx2, session_key, "session-fghij")
  let final_ctx = Context::with_value(enriched_ctx3, request_key, "request-klmno")
  
  // åˆ›å»ºTextMapCarrierå¹¶è®¾ç½®å¤šä¸ªå¤´éƒ¨
  let carrier = TextMapCarrier::new()
  
  // æµ‹è¯•æ³¨å…¥æ“ä½œ
  CompositePropagator::inject(composite_propagator, final_ctx, carrier)
  
  // éªŒè¯æ³¨å…¥çš„å¤´éƒ¨
  let injected_traceparent = TextMapCarrier::get(carrier, "traceparent")
  assert_true(injected_traceparent is Some)
  match injected_traceparent {
    Some(value) => assert_eq(value, "00-test-trace-id-test-span-id-01")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•æå–æ“ä½œ
  let extracted_ctx = CompositePropagator::extract(composite_propagator, carrier)
  let extracted_key = ContextKey::new("extracted")
  let extracted_value = Context::get(extracted_ctx, extracted_key)
  
  assert_true(extracted_value is Some)
  match extracted_value {
    Some(value) => assert_eq(value, "true")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•å¸¦æœ‰é¢„è®¾ç½®å¤´éƒ¨çš„è½½ä½“
  let preset_carrier = TextMapCarrier::new()
  TextMapCarrier::set(preset_carrier, "traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  TextMapCarrier::set(preset_carrier, "tracestate", "rojo=00f067aa0ba902b7,congo=t61rcWkgMzE")
  TextMapCarrier::set(preset_carrier, "baggage", "user.id=user-12345,session.id=session-67890")
  TextMapCarrier::set(preset_carrier, "x-custom-header", "custom-value")
  
  // ä»é¢„è®¾è½½ä½“æå–ä¸Šä¸‹æ–‡
  let preset_extracted_ctx = CompositePropagator::extract(composite_propagator, preset_carrier)
  let preset_extracted_value = Context::get(preset_extracted_ctx, extracted_key)
  
  assert_true(preset_extracted_value is Some)
  match preset_extracted_value {
    Some(value) => assert_eq(value, "true")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ç©ºè½½ä½“å¤„ç†
  let empty_carrier = TextMapCarrier::new()
  let empty_extracted_ctx = CompositePropagator::extract(composite_propagator, empty_carrier)
  let empty_extracted_value = Context::get(empty_extracted_ctx, extracted_key)
  
  assert_true(empty_extracted_value is Some)
  match empty_extracted_value {
    Some(value) => assert_eq(value, "true")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•å•ä¸ªä¼ æ’­å™¨çš„å¤åˆä¼ æ’­å™¨
  let single_propagator = CompositePropagator::new([trace_propagator1])
  let single_carrier = TextMapCarrier::new()
  
  CompositePropagator::inject(single_propagator, final_ctx, single_carrier)
  let single_injected = TextMapCarrier::get(single_carrier, "traceparent")
  assert_true(single_injected is Some)
  
  let single_extracted = CompositePropagator::extract(single_propagator, single_carrier)
  let single_extracted_value = Context::get(single_extracted, extracted_key)
  assert_true(single_extracted_value is Some)
  
  // æµ‹è¯•å¤šæ¬¡æ³¨å…¥å’Œæå–æ“ä½œ
  let multi_carrier = TextMapCarrier::new()
  
  // ç¬¬ä¸€æ¬¡æ³¨å…¥
  CompositePropagator::inject(composite_propagator, final_ctx, multi_carrier)
  let first_injection = TextMapCarrier::get(multi_carrier, "traceparent")
  assert_true(first_injection is Some)
  
  // ç¬¬äºŒæ¬¡æ³¨å…¥ï¼ˆåº”è¯¥è¦†ç›–ç¬¬ä¸€æ¬¡ï¼‰
  CompositePropagator::inject(composite_propagator, base_ctx, multi_carrier)
  let second_injection = TextMapCarrier::get(multi_carrier, "traceparent")
  assert_true(second_injection is Some)
  
  // å¤šæ¬¡æå–
  let extracted1 = CompositePropagator::extract(composite_propagator, multi_carrier)
  let extracted2 = CompositePropagator::extract(composite_propagator, multi_carrier)
  
  let value1 = Context::get(extracted1, extracted_key)
  let value2 = Context::get(extracted2, extracted_key)
  
  assert_true(value1 is Some)
  assert_true(value2 is Some)
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡å€¼çš„ä¿æŒ
  let original_trace_value = Context::get(final_ctx, trace_key)
  let original_user_value = Context::get(final_ctx, user_key)
  let original_session_value = Context::get(final_ctx, session_key)
  let original_request_value = Context::get(final_ctx, request_key)
  
  assert_true(original_trace_value is Some)
  match original_trace_value {
    Some(value) => assert_eq(value, "trace-12345-abcde")
    _ => assert_true(false)
  }
  
  assert_true(original_user_value is Some)
  match original_user_value {
    Some(value) => assert_eq(value, "user-67890")
    _ => assert_true(false)
  }
  
  assert_true(original_session_value is Some)
  match original_session_value {
    Some(value) => assert_eq(value, "session-fghij")
    _ => assert_true(false)
  }
  
  assert_true(original_request_value is Some)
  match original_request_value {
    Some(value) => assert_eq(value, "request-klmno")
    _ => assert_true(false)
  }
}
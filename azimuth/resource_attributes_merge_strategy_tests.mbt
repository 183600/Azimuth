// èµ„æºå±æ€§åˆå¹¶ç­–ç•¥æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•é¥æµ‹èµ„æºå±æ€§çš„åˆå¹¶ã€è¦†ç›–å’Œä¼˜å…ˆçº§ç­–ç•¥

test "èµ„æºå±æ€§åŸºæœ¬åˆå¹¶ç­–ç•¥æµ‹è¯•" {
  // 1. åˆ›å»ºåŸºç¡€èµ„æº
  let base_resource = Resource::new()
  let base_attrs = [
    ("service.name", StringValue("user-service")),
    ("service.version", StringValue("1.0.0")),
    ("deployment.environment", StringValue("production")),
    ("host.name", StringValue("prod-server-01"))
  ]
  let base_with_attrs = Resource::with_attributes(base_resource, base_attrs)
  
  // éªŒè¯åŸºç¡€èµ„æºå±æ€§
  let service_name = Resource::get_attribute(base_with_attrs, "service.name")
  let service_version = Resource::get_attribute(base_with_attrs, "service.version")
  let environment = Resource::get_attribute(base_with_attrs, "deployment.environment")
  let host_name = Resource::get_attribute(base_with_attrs, "host.name")
  
  assert_eq(service_name, Some(StringValue("user-service")))
  assert_eq(service_version, Some(StringValue("1.0.0")))
  assert_eq(environment, Some(StringValue("production")))
  assert_eq(host_name, Some(StringValue("prod-server-01")))
  
  // 2. åˆ›å»ºè¦†ç›–èµ„æº
  let override_resource = Resource::new()
  let override_attrs = [
    ("service.version", StringValue("1.1.0")),  // è¦†ç›–ç‰ˆæœ¬
    ("host.name", StringValue("prod-server-02")), // è¦†ç›–ä¸»æœºå
    ("feature.flag", StringValue("new-auth")),   // æ–°å¢åŠŸèƒ½æ ‡å¿—
    ("region", StringValue("us-west-2"))         // æ–°å¢åŒºåŸŸä¿¡æ¯
  ]
  let override_with_attrs = Resource::with_attributes(override_resource, override_attrs)
  
  // 3. æ‰§è¡Œèµ„æºåˆå¹¶
  let merged_resource = Resource::merge(base_with_attrs, override_with_attrs)
  
  // 4. éªŒè¯åˆå¹¶ç»“æœ
  let merged_service_name = Resource::get_attribute(merged_resource, "service.name")
  let merged_service_version = Resource::get_attribute(merged_resource, "service.version")
  let merged_environment = Resource::get_attribute(merged_resource, "deployment.environment")
  let merged_host_name = Resource::get_attribute(merged_resource, "host.name")
  let merged_feature_flag = Resource::get_attribute(merged_resource, "feature.flag")
  let merged_region = Resource::get_attribute(merged_resource, "region")
  
  // åŸºç¡€å±æ€§åº”è¯¥è¢«ä¿ç•™
  assert_eq(merged_service_name, Some(StringValue("user-service")))
  assert_eq(merged_environment, Some(StringValue("production")))
  
  // è¦†ç›–å±æ€§åº”è¯¥ä½¿ç”¨æ–°å€¼
  assert_eq(merged_service_version, Some(StringValue("1.1.0")))
  assert_eq(merged_host_name, Some(StringValue("prod-server-02")))
  
  // æ–°å¢å±æ€§åº”è¯¥å­˜åœ¨
  assert_eq(merged_feature_flag, Some(StringValue("new-auth")))
  assert_eq(merged_region, Some(StringValue("us-west-2")))
  
  assert_true(true)
}

test "èµ„æºå±æ€§ç±»å‹å…¼å®¹æ€§æµ‹è¯•" {
  // 1. åˆ›å»ºå…·æœ‰ä¸åŒç±»å‹å±æ€§çš„èµ„æº
  let string_resource = Resource::new()
  let string_attrs = [
    ("service.name", StringValue("api-service")),
    ("description", StringValue("APIæœåŠ¡"))
  ]
  let string_with_attrs = Resource::with_attributes(string_resource, string_attrs)
  
  // 2. åˆ›å»ºå…·æœ‰æ•°å€¼ç±»å‹å±æ€§çš„èµ„æº
  let numeric_resource = Resource::new()
  let numeric_attrs = [
    ("service.name", IntValue(42)),  // ç±»å‹å†²çªï¼šå­—ç¬¦ä¸² vs æ•´æ•°
    ("port", IntValue(8080)),
    ("cpu.cores", IntValue(4))
  ]
  let numeric_with_attrs = Resource::with_attributes(numeric_resource, numeric_attrs)
  
  // 3. åˆ›å»ºå…·æœ‰æµ®ç‚¹ç±»å‹å±æ€§çš„èµ„æº
  let float_resource = Resource::new()
  let float_attrs = [
    ("cpu.usage", FloatValue(0.75)),
    ("memory.usage", FloatValue(0.62)),
    ("response.time", FloatValue(125.5))
  ]
  let float_with_attrs = Resource::with_attributes(float_resource, float_attrs)
  
  // 4. åˆ›å»ºå…·æœ‰å¸ƒå°”ç±»å‹å±æ€§çš„èµ„æº
  let bool_resource = Resource::new()
  let bool_attrs = [
    ("service.enabled", BoolValue(true)),
    ("debug.mode", BoolValue(false)),
    ("ssl.enabled", BoolValue(true))
  ]
  let bool_with_attrs = Resource::with_attributes(bool_resource, bool_attrs)
  
  // 5. åˆ›å»ºå…·æœ‰æ•°ç»„ç±»å‹å±æ€§çš„èµ„æº
  let array_resource = Resource::new()
  let array_attrs = [
    ("endpoints", ArrayStringValue(["/api/users", "/api/orders", "/api/products"])),
    ("supported.versions", ArrayStringValue(["v1", "v2"])),
    ("server.ports", ArrayIntValue([8080, 8443, 9000]))
  ]
  let array_with_attrs = Resource::with_attributes(array_resource, array_attrs)
  
  // 6. åˆå¹¶ä¸åŒç±»å‹çš„èµ„æº
  let merged_all = Resource::merge(
    Resource::merge(string_with_attrs, numeric_with_attrs),
    Resource::merge(float_with_attrs, bool_with_attrs)
  )
  let final_merged = Resource::merge(merged_all, array_with_attrs)
  
  // 7. éªŒè¯ä¸åŒç±»å‹çš„å±æ€§
  let final_service_name = Resource::get_attribute(final_merged, "service.name")
  let final_port = Resource::get_attribute(final_merged, "port")
  let final_cpu_usage = Resource::get_attribute(final_merged, "cpu.usage")
  let final_service_enabled = Resource::get_attribute(final_merged, "service.enabled")
  let final_endpoints = Resource::get_attribute(final_merged, "endpoints")
  
  // éªŒè¯å±æ€§å€¼
  assert_eq(final_port, Some(IntValue(8080)))
  assert_eq(final_cpu_usage, Some(FloatValue(0.75)))
  assert_eq(final_service_enabled, Some(BoolValue(true)))
  assert_eq(final_endpoints, Some(ArrayStringValue(["/api/users", "/api/orders", "/api/products"])))
  
  assert_true(true)
}

test "èµ„æºå±æ€§ä¼˜å…ˆçº§ç­–ç•¥æµ‹è¯•" {
  // 1. æ¨¡æ‹Ÿä¸åŒå±‚çº§çš„èµ„æºå±æ€§
  // å…¨å±€çº§åˆ«å±æ€§
  let global_resource = Resource::new()
  let global_attrs = [
    ("organization.name", StringValue("acme-corp")),
    ("region", StringValue("global")),
    ("cost.center", StringValue("engineering"))
  ]
  let global_with_attrs = Resource::with_attributes(global_resource, global_attrs)
  
  // ç¯å¢ƒçº§åˆ«å±æ€§
  let env_resource = Resource::new()
  let env_attrs = [
    ("deployment.environment", StringValue("staging")),
    ("region", StringValue("us-east-1")),  // è¦†ç›–å…¨å±€region
    ("cluster.name", StringValue("staging-cluster"))
  ]
  let env_with_attrs = Resource::with_attributes(env_resource, env_attrs)
  
  // æœåŠ¡çº§åˆ«å±æ€§
  let service_resource = Resource::new()
  let service_attrs = [
    ("service.name", StringValue("payment-service")),
    ("service.version", StringValue("2.1.0")),
    ("deployment.environment", StringValue("production")), // è¦†ç›–ç¯å¢ƒçº§åˆ«
    ("team", StringValue("payments"))
  ]
  let service_with_attrs = Resource::with_attributes(service_resource, service_attrs)
  
  // å®ä¾‹çº§åˆ«å±æ€§
  let instance_resource = Resource::new()
  let instance_attrs = [
    ("instance.id", StringValue("i-1234567890abcdef0")),
    ("host.name", StringValue("payment-prod-03")),
    ("service.version", StringValue("2.1.1")), // è¦†ç›–æœåŠ¡çº§åˆ«ç‰ˆæœ¬
    ("restart.count", IntValue(3))
  ]
  let instance_with_attrs = Resource::with_attributes(instance_resource, instance_attrs)
  
  // 2. æŒ‰ä¼˜å…ˆçº§é¡ºåºåˆå¹¶èµ„æºï¼ˆå®ä¾‹ > æœåŠ¡ > ç¯å¢ƒ > å…¨å±€ï¼‰
  let env_global_merged = Resource::merge(global_with_attrs, env_with_attrs)
  let service_env_global_merged = Resource::merge(env_global_merged, service_with_attrs)
  let final_resource = Resource::merge(service_env_global_merged, instance_with_attrs)
  
  // 3. éªŒè¯ä¼˜å…ˆçº§ç­–ç•¥
  // å…¨å±€çº§åˆ«å±æ€§åº”è¯¥ä¿ç•™ï¼ˆå¦‚æœæ²¡æœ‰è¢«è¦†ç›–ï¼‰
  let org_name = Resource::get_attribute(final_resource, "organization.name")
  let cost_center = Resource::get_attribute(final_resource, "cost.center")
  assert_eq(org_name, Some(StringValue("acme-corp")))
  assert_eq(cost_center, Some(StringValue("engineering")))
  
  // ç¯å¢ƒçº§åˆ«å±æ€§åº”è¯¥éƒ¨åˆ†ä¿ç•™
  let cluster_name = Resource::get_attribute(final_resource, "cluster.name")
  assert_eq(cluster_name, Some(StringValue("staging-cluster")))
  
  // æœåŠ¡çº§åˆ«å±æ€§åº”è¯¥ä¿ç•™ï¼ˆå¦‚æœæ²¡æœ‰è¢«è¦†ç›–ï¼‰
  let service_name = Resource::get_attribute(final_resource, "service.name")
  let team = Resource::get_attribute(final_resource, "team")
  assert_eq(service_name, Some(StringValue("payment-service")))
  assert_eq(team, Some(StringValue("payments")))
  
  // å®ä¾‹çº§åˆ«å±æ€§åº”è¯¥å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§
  let instance_id = Resource::get_attribute(final_resource, "instance.id")
  let host_name = Resource::get_attribute(final_resource, "host.name")
  let restart_count = Resource::get_attribute(final_resource, "restart.count")
  assert_eq(instance_id, Some(StringValue("i-1234567890abcdef0")))
  assert_eq(host_name, Some(StringValue("payment-prod-03")))
  assert_eq(restart_count, Some(IntValue(3)))
  
  // éªŒè¯è¦†ç›–ç­–ç•¥
  // regionåº”è¯¥è¢«ç¯å¢ƒçº§åˆ«è¦†ç›–
  let final_region = Resource::get_attribute(final_resource, "region")
  assert_eq(final_region, Some(StringValue("us-east-1")))
  
  // deployment.environmentåº”è¯¥è¢«æœåŠ¡çº§åˆ«è¦†ç›–
  let final_env = Resource::get_attribute(final_resource, "deployment.environment")
  assert_eq(final_env, Some(StringValue("production")))
  
  // service.versionåº”è¯¥è¢«å®ä¾‹çº§åˆ«è¦†ç›–
  let final_version = Resource::get_attribute(final_resource, "service.version")
  assert_eq(final_version, Some(StringValue("2.1.1")))
  
  assert_true(true)
}

test "èµ„æºå±æ€§åˆå¹¶è¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  // 1. æµ‹è¯•ç©ºèµ„æºåˆå¹¶
  let empty_resource = Resource::new()
  let non_empty_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("test-service"))
  ])
  
  // ç©ºèµ„æºä¸éç©ºèµ„æºåˆå¹¶
  let empty_with_non_empty = Resource::merge(empty_resource, non_empty_resource)
  let non_empty_with_empty = Resource::merge(non_empty_resource, empty_resource)
  
  let service_name_1 = Resource::get_attribute(empty_with_non_empty, "service.name")
  let service_name_2 = Resource::get_attribute(non_empty_with_empty, "service.name")
  
  assert_eq(service_name_1, Some(StringValue("test-service")))
  assert_eq(service_name_2, Some(StringValue("test-service")))
  
  // 2. æµ‹è¯•ç©ºå±æ€§å€¼
  let resource_with_empty_values = Resource::with_attributes(Resource::new(), [
    ("empty.string", StringValue("")),
    ("empty.int", IntValue(0)),
    ("empty.float", FloatValue(0.0)),
    ("empty.bool", BoolValue(false))
  ])
  
  let empty_string = Resource::get_attribute(resource_with_empty_values, "empty.string")
  let empty_int = Resource::get_attribute(resource_with_empty_values, "empty.int")
  let empty_float = Resource::get_attribute(resource_with_empty_values, "empty.float")
  let empty_bool = Resource::get_attribute(resource_with_empty_values, "empty.bool")
  
  assert_eq(empty_string, Some(StringValue("")))
  assert_eq(empty_int, Some(IntValue(0)))
  assert_eq(empty_float, Some(FloatValue(0.0)))
  assert_eq(empty_bool, Some(BoolValue(false)))
  
  // 3. æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å’ŒUnicode
  let unicode_resource = Resource::with_attributes(Resource::new(), [
    ("unicode.name", StringValue("æœåŠ¡åç§°")),
    ("special.chars", StringValue("a.b-c_d/e")),
    ("emoji", StringValue("ğŸš€ğŸ“Š")),
    ("spaces", StringValue("value with spaces"))
  ])
  
  let unicode_name = Resource::get_attribute(unicode_resource, "unicode.name")
  let special_chars = Resource::get_attribute(unicode_resource, "special.chars")
  let emoji = Resource::get_attribute(unicode_resource, "emoji")
  let spaces = Resource::get_attribute(unicode_resource, "spaces")
  
  assert_eq(unicode_name, Some(StringValue("æœåŠ¡åç§°")))
  assert_eq(special_chars, Some(StringValue("a.b-c_d/e")))
  assert_eq(emoji, Some(StringValue("ğŸš€ğŸ“Š")))
  assert_eq(spaces, Some(StringValue("value with spaces")))
  
  // 4. æµ‹è¯•è¶…é•¿å±æ€§åå’Œå€¼
  let long_key = "very.long.attribute.name.that.exceeds.normal.limits.and.tests.boundary.conditions"
  let long_value = "very.long.attribute.value.that.exceeds.normal.limits.and.tests.boundary.conditions.for.attribute.values"
  
  let long_resource = Resource::with_attributes(Resource::new(), [
    (long_key, StringValue(long_value))
  ])
  
  let retrieved_long_value = Resource::get_attribute(long_resource, long_key)
  assert_eq(retrieved_long_value, Some(StringValue(long_value)))
  
  // 5. æµ‹è¯•å¤§é‡å±æ€§åˆå¹¶
  let many_attrs_resource_1 = Resource::with_attributes(Resource::new(), [
    ("attr.1", StringValue("value.1")),
    ("attr.2", StringValue("value.2")),
    ("attr.3", StringValue("value.3")),
    ("attr.4", StringValue("value.4")),
    ("attr.5", StringValue("value.5"))
  ])
  
  let many_attrs_resource_2 = Resource::with_attributes(Resource::new(), [
    ("attr.6", StringValue("value.6")),
    ("attr.7", StringValue("value.7")),
    ("attr.8", StringValue("value.8")),
    ("attr.9", StringValue("value.9")),
    ("attr.10", StringValue("value.10"))
  ])
  
  let merged_many_attrs = Resource::merge(many_attrs_resource_1, many_attrs_resource_2)
  
  // éªŒè¯æ‰€æœ‰å±æ€§éƒ½å­˜åœ¨
  for i in range(1, 11) {
    let key = "attr." + i.to_string()
    let value = Resource::get_attribute(merged_many_attrs, key)
    assert_eq(value, Some(StringValue("value." + i.to_string())))
  }
  
  assert_true(true)
}

test "èµ„æºå±æ€§åˆå¹¶æ€§èƒ½æµ‹è¯•" {
  // 1. åˆ›å»ºå¤§å‹èµ„æºé›†åˆ
  let large_attrs_1 = [
    ("service.name", StringValue("large-service")),
    ("service.version", StringValue("1.0.0")),
    ("deployment.environment", StringValue("production")),
    ("host.name", StringValue("prod-server-01")),
    ("region", StringValue("us-west-2")),
    ("availability.zone", StringValue("us-west-2a")),
    ("instance.type", StringValue("m5.large")),
    ("team", StringValue("backend")),
    ("cost.center", StringValue("engineering")),
    ("project", StringValue("platform"))
  ]
  
  let large_attrs_2 = [
    ("service.version", StringValue("1.1.0")),
    ("host.name", StringValue("prod-server-02")),
    ("cpu.count", IntValue(2)),
    ("memory.gb", IntValue(8)),
    ("disk.gb", IntValue(100)),
    ("network.mbps", IntValue(1000)),
    ("os.version", StringValue("ubuntu-20.04")),
    ("kernel.version", StringValue("5.4.0")),
    ("docker.version", StringValue("20.10.7")),
    ("kubernetes.version", StringValue("1.21.0"))
  ]
  
  let large_resource_1 = Resource::with_attributes(Resource::new(), large_attrs_1)
  let large_resource_2 = Resource::with_attributes(Resource::new(), large_attrs_2)
  
  // 2. æµ‹é‡åˆå¹¶æ€§èƒ½
  let start_time = Clock::now_unix_nanos(Clock::system())
  
  // æ‰§è¡Œå¤šæ¬¡åˆå¹¶æ“ä½œ
  for _ in range(0, 100) {
    let _ = Resource::merge(large_resource_1, large_resource_2)
  }
  
  let end_time = Clock::now_unix_nanos(Clock::system())
  let duration = end_time - start_time
  
  // 3. éªŒè¯æ€§èƒ½è¦æ±‚
  // 100æ¬¡åˆå¹¶æ“ä½œåº”è¯¥åœ¨åˆç†æ—¶é—´å†…å®Œæˆï¼ˆè¿™é‡Œè®¾ç½®ä¸º1ç§’ï¼‰
  assert_true(duration < 1000000000L) // å°äº1ç§’
  
  // 4. éªŒè¯åˆå¹¶ç»“æœæ­£ç¡®æ€§
  let final_resource = Resource::merge(large_resource_1, large_resource_2)
  
  let service_name = Resource::get_attribute(final_resource, "service.name")
  let service_version = Resource::get_attribute(final_resource, "service.version")
  let host_name = Resource::get_attribute(final_resource, "host.name")
  let cpu_count = Resource::get_attribute(final_resource, "cpu.count")
  let memory_gb = Resource::get_attribute(final_resource, "memory.gb")
  
  assert_eq(service_name, Some(StringValue("large-service")))
  assert_eq(service_version, Some(StringValue("1.1.0"))) // åº”è¯¥è¢«è¦†ç›–
  assert_eq(host_name, Some(StringValue("prod-server-02"))) // åº”è¯¥è¢«è¦†ç›–
  assert_eq(cpu_count, Some(IntValue(2)))
  assert_eq(memory_gb, Some(IntValue(8)))
  
  assert_true(true)
}
// Azimuth é«˜è´¨é‡æµ‹è¯•ç”¨ä¾‹é›†
// è¦†ç›–é¥æµ‹ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

// æµ‹è¯•ç”¨ä¾‹1: å±æ€§æ“ä½œå’Œç±»å‹è½¬æ¢
pub test "å±æ€§æ“ä½œå’Œç±»å‹è½¬æ¢æµ‹è¯•" {
  // åˆ›å»ºå±æ€§é›†åˆ
  let attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•åŸºæœ¬ç±»å‹å±æ€§
  azimuth::Attributes::set(attrs, "string.key", azimuth::StringValue("æµ‹è¯•å­—ç¬¦ä¸²"))
  azimuth::Attributes::set(attrs, "int.key", azimuth::IntValue(42))
  azimuth::Attributes::set(attrs, "float.key", azimuth::FloatValue(3.14159))
  azimuth::Attributes::set(attrs, "bool.key", azimuth::BoolValue(true))
  
  // æµ‹è¯•æ•°ç»„ç±»å‹å±æ€§
  azimuth::Attributes::set(attrs, "array.string", azimuth::ArrayStringValue(["å…ƒç´ 1", "å…ƒç´ 2", "å…ƒç´ 3"]))
  azimuth::Attributes::set(attrs, "array.int", azimuth::ArrayIntValue([1, 2, 3, 4, 5]))
  
  // éªŒè¯å±æ€§å€¼
  let string_val = azimuth::Attributes::get(attrs, "string.key")
  let int_val = azimuth::Attributes::get(attrs, "int.key")
  let float_val = azimuth::Attributes::get(attrs, "float.key")
  let bool_val = azimuth::Attributes::get(attrs, "bool.key")
  let array_string_val = azimuth::Attributes::get(attrs, "array.string")
  let array_int_val = azimuth::Attributes::get(attrs, "array.int")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(string_val, Some(azimuth::StringValue("test_value")))
  assert_eq(int_val, Some(azimuth::IntValue(42)))
  
  // æµ‹è¯•è¾¹ç•Œå€¼
  let extreme_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(extreme_attrs, "max.int", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(extreme_attrs, "min.int", azimuth::IntValue(-2147483648))
  azimuth::Attributes::set(extreme_attrs, "max.float", azimuth::FloatValue(1.7976931348623157e+308))
  azimuth::Attributes::set(extreme_attrs, "min.float", azimuth::FloatValue(-1.7976931348623157e+308))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å’ŒUnicode
  let unicode_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(unicode_attrs, "unicode.text", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€emoji"))
  azimuth::Attributes::set(unicode_attrs, "special.chars", azimuth::StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
}

// æµ‹è¯•ç”¨ä¾‹2: ä¸Šä¸‹æ–‡ä¼ æ’­å’ŒBaggageæ“ä½œ
pub test "ä¸Šä¸‹æ–‡ä¼ æ’­å’ŒBaggageæ“ä½œæµ‹è¯•" {
  // åˆ›å»ºæ ¹ä¸Šä¸‹æ–‡
  let root_ctx = azimuth::Context::root()
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡é”®å€¼å¯¹æ“ä½œ
  let user_key = azimuth::ContextKey::new("user.id")
  let request_key = azimuth::ContextKey::new("request.id")
  let session_key = azimuth::ContextKey::new("session.id")
  
  // è®¾ç½®ä¸Šä¸‹æ–‡å€¼
  let ctx_with_user = azimuth::Context::with_value(root_ctx, user_key, "user-12345")
  let ctx_with_request = azimuth::Context::with_value(ctx_with_user, request_key, "req-67890")
  let ctx_with_session = azimuth::Context::with_value(ctx_with_request, session_key, "sess-abcde")
  
  // éªŒè¯ä¸Šä¸‹æ–‡å€¼
  assert_eq(azimuth::Context::get(ctx_with_user, user_key), Some("user-12345"))
  assert_eq(azimuth::Context::get(ctx_with_request, request_key), Some("req-67890"))
  assert_eq(azimuth::Context::get(ctx_with_session, session_key), Some("sess-abcde"))
  
  // æµ‹è¯•ç¼ºå¤±çš„é”®
  let missing_key = azimuth::ContextKey::new("missing.key")
  assert_eq(azimuth::Context::get(root_ctx, missing_key), None)
  
  // æµ‹è¯•Baggageæ“ä½œ
  let baggage = azimuth::Baggage::new()
  let baggage_with_user = azimuth::Baggage::set_entry(baggage, "user.id", "user-12345")
  let baggage_with_request = azimuth::Baggage::set_entry(baggage_with_user, "request.id", "req-67890")
  let baggage_with_session = azimuth::Baggage::set_entry(baggage_with_request, "session.id", "sess-abcde")
  
  // éªŒè¯Baggageæ¡ç›®
  assert_eq(azimuth::Baggage::get_entry(baggage_with_user, "user.id"), Some("user-12345"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_request, "request.id"), Some("req-67890"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_session, "session.id"), Some("sess-abcde"))
  
  // æµ‹è¯•Baggageä¼ æ’­ä¸€è‡´æ€§
  assert_eq(azimuth::Baggage::get_entry(baggage_with_session, "user.id"), Some("user-12345"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_session, "request.id"), Some("req-67890"))
}

// æµ‹è¯•ç”¨ä¾‹3: Spanç”Ÿå‘½å‘¨æœŸå’Œè¿½è¸ªæ“ä½œ
pub test "Spanç”Ÿå‘½å‘¨æœŸå’Œè¿½è¸ªæ“ä½œæµ‹è¯•" {
  // åˆ›å»ºSpanä¸Šä¸‹æ–‡
  let span_ctx = azimuth::SpanContext::new("trace-1234567890", "span-0987654321", true, "key1=value1,key2=value2")
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡
  assert_eq(azimuth::SpanContext::trace_id(span_ctx), "trace-1234567890")
  assert_eq(azimuth::SpanContext::span_id(span_ctx), "span-0987654321")
  assert_true(azimuth::SpanContext::is_valid(span_ctx))
  assert_true(azimuth::SpanContext::is_sampled(span_ctx))
  
  // æµ‹è¯•ä¸åŒç±»å‹çš„Span
  let internal_span = azimuth::Span::new("internal-operation", azimuth::Internal, span_ctx)
  let server_span = azimuth::Span::new("server-operation", azimuth::Server, span_ctx)
  let client_span = azimuth::Span::new("client-operation", azimuth::Client, span_ctx)
  let producer_span = azimuth::Span::new("producer-operation", azimuth::Producer, span_ctx)
  let consumer_span = azimuth::Span::new("consumer-operation", azimuth::Consumer, span_ctx)
  
  // éªŒè¯Spanå±æ€§
  assert_eq(azimuth::Span::name(internal_span), "internal-operation")
  assert_eq(azimuth::Span::kind(internal_span), azimuth::Internal)
  assert_eq(azimuth::Span::name(server_span), "server-operation")
  assert_eq(azimuth::Span::kind(server_span), azimuth::Server)
  assert_eq(azimuth::Span::name(client_span), "client-operation")
  assert_eq(azimuth::Span::kind(client_span), azimuth::Client)
  assert_eq(azimuth::Span::name(producer_span), "producer-operation")
  assert_eq(azimuth::Span::kind(producer_span), azimuth::Producer)
  assert_eq(azimuth::Span::name(consumer_span), "consumer-operation")
  assert_eq(azimuth::Span::kind(consumer_span), azimuth::Consumer)
  
  // æµ‹è¯•Traceræ“ä½œ
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "test-tracer", Some("1.0.0"))
  let scope = azimuth::Tracer::instrumentation_scope(tracer)
  
  assert_eq(scope.name, "test-tracer")
  assert_eq(scope.version, Some("1.0.0"))
  
  // æµ‹è¯•Spanåˆ›å»º
  let new_span = azimuth::Tracer::start_span(tracer, "test-operation")
  assert_eq(azimuth::Span::name(new_span), "test-operation")
  assert_true(azimuth::Span::is_recording(new_span))
}

// æµ‹è¯•ç”¨ä¾‹4: åº¦é‡æ“ä½œå’Œä»ªå™¨ç±»å‹
pub test "åº¦é‡æ“ä½œå’Œä»ªå™¨ç±»å‹æµ‹è¯•" {
  // åˆ›å»ºMeter
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "test-meter", Some("1.0.0"))
  
  // æµ‹è¯•Counter
  let counter = azimuth::Meter::create_counter(meter, "request.count", Some("Total number of requests"), Some("count"))
  assert_eq(counter.name, "request.count")
  assert_eq(counter.description, Some("Total number of requests"))
  assert_eq(counter.unit, Some("count"))
  
  // æµ‹è¯•Counteræ“ä½œ
  azimuth::Counter::add(counter, 1.0)
  azimuth::Counter::add(counter, 5.0)
  azimuth::Counter::add(counter, 10.0)
  
  // æµ‹è¯•Histogram
  let histogram = azimuth::Meter::create_histogram(meter, "response.time", Some("Response time in milliseconds"), Some("ms"))
  assert_eq(histogram.name, "response.time")
  assert_eq(histogram.description, Some("Response time in milliseconds"))
  assert_eq(histogram.unit, Some("ms"))
  
  // æµ‹è¯•Histogramæ“ä½œ
  azimuth::Histogram::record(histogram, 100.0)
  azimuth::Histogram::record(histogram, 150.5)
  azimuth::Histogram::record(histogram, 200.75)
  azimuth::Histogram::record(histogram, 300.25)
  
  // æµ‹è¯•UpDownCounter
  let updown_counter = azimuth::Meter::create_updown_counter(meter, "active.connections", Some("Currently active connections"), Some("connections"))
  assert_eq(updown_counter.name, "active.connections")
  assert_eq(updown_counter.description, Some("Currently active connections"))
  assert_eq(updown_counter.unit, Some("connections"))
  
  // æµ‹è¯•UpDownCounteræ“ä½œ
  azimuth::UpDownCounter::add(updown_counter, 10.0)
  azimuth::UpDownCounter::add(updown_counter, -2.0)
  azimuth::UpDownCounter::add(updown_counter, 5.0)
  
  // æµ‹è¯•Gauge
  let gauge = azimuth::Meter::create_gauge(meter, "memory.usage", Some("Memory usage in MB"), Some("MB"))
  assert_eq(gauge.name, "memory.usage")
  assert_eq(gauge.description, Some("Memory usage in MB"))
  assert_eq(gauge.unit, Some("MB"))
  
  // æµ‹è¯•Instrumentè½¬æ¢
  let counter_instrument = azimuth::Histogram::as_instrument(histogram)
  assert_eq(azimuth::Instrument::name(counter_instrument), "response.time")
  assert_eq(azimuth::Instrument::description(counter_instrument), Some("Response time in milliseconds"))
  assert_eq(azimuth::Instrument::unit(counter_instrument), Some("ms"))
}

// æµ‹è¯•ç”¨ä¾‹5: æ—¥å¿—è®°å½•å’Œä¸¥é‡æ€§çº§åˆ«
pub test "æ—¥å¿—è®°å½•å’Œä¸¥é‡æ€§çº§åˆ«æµ‹è¯•" {
  // æµ‹è¯•ä¸åŒä¸¥é‡æ€§çº§åˆ«çš„æ—¥å¿—è®°å½•
  let trace_log = azimuth::LogRecord::new(azimuth::Trace, "Trace level log message")
  let debug_log = azimuth::LogRecord::new(azimuth::Debug, "Debug level log message")
  let info_log = azimuth::LogRecord::new(azimuth::Info, "Info level log message")
  let warn_log = azimuth::LogRecord::new(azimuth::Warn, "Warning level log message")
  let error_log = azimuth::LogRecord::new(azimuth::Error, "Error level log message")
  let fatal_log = azimuth::LogRecord::new(azimuth::Fatal, "Fatal level log message")
  
  // éªŒè¯æ—¥å¿—ä¸¥é‡æ€§çº§åˆ«
  assert_eq(azimuth::LogRecord::severity_number(trace_log), azimuth::Trace)
  assert_eq(azimuth::LogRecord::severity_number(debug_log), azimuth::Debug)
  assert_eq(azimuth::LogRecord::severity_number(info_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::severity_number(warn_log), azimuth::Warn)
  assert_eq(azimuth::LogRecord::severity_number(error_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::severity_number(fatal_log), azimuth::Fatal)
  
  // éªŒè¯æ—¥å¿—æ¶ˆæ¯
  assert_eq(azimuth::LogRecord::body(trace_log), Some("Trace level log message"))
  assert_eq(azimuth::LogRecord::body(debug_log), Some("Debug level log message"))
  assert_eq(azimuth::LogRecord::body(info_log), Some("Info level log message"))
  assert_eq(azimuth::LogRecord::body(warn_log), Some("Warning level log message"))
  assert_eq(azimuth::LogRecord::body(error_log), Some("Error level log message"))
  assert_eq(azimuth::LogRecord::body(fatal_log), Some("Fatal level log message"))
  
  // æµ‹è¯•å¸¦ä¸Šä¸‹æ–‡çš„è¯¦ç»†æ—¥å¿—è®°å½•
  let attributes = azimuth::Attributes::new()
  azimuth::Attributes::set(attributes, "user.id", azimuth::StringValue("user-123"))
  azimuth::Attributes::set(attributes, "request.id", azimuth::StringValue("req-456"))
  
  let detailed_log = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("Detailed error occurred"),
    Some(attributes),
    Some(1735689600000000000L),
    Some(1735689600000000001L),
    Some("trace-123"),
    Some("span-456"),
    Some(azimuth::Context::root())
  )
  
  // éªŒè¯è¯¦ç»†æ—¥å¿—è®°å½•
  assert_eq(azimuth::LogRecord::severity_number(detailed_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::body(detailed_log), Some("Detailed error occurred"))
  assert_eq(azimuth::LogRecord::trace_id(detailed_log), Some("trace-123"))
  assert_eq(azimuth::LogRecord::span_id(detailed_log), Some("span-456"))
  
  // æµ‹è¯•Loggeræ“ä½œ
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "test-logger", Some("1.0.0"))
  assert_eq(logger.scope.name, "test-logger")
  assert_eq(logger.scope.version, Some("1.0.0"))
  
  // æµ‹è¯•æ—¥å¿—å‘å°„
  azimuth::Logger::emit(logger, info_log)
  azimuth::Logger::emit(logger, error_log)
  azimuth::Logger::emit(logger, detailed_log)
}

// æµ‹è¯•ç”¨ä¾‹6: èµ„æºç®¡ç†å’Œåˆå¹¶ç­–ç•¥
pub test "èµ„æºç®¡ç†å’Œåˆå¹¶ç­–ç•¥æµ‹è¯•" {
  // åˆ›å»ºåŸºç¡€èµ„æº
  let base_resource = azimuth::Resource::new()
  
  // æ·»åŠ åŸºç¡€å±æ€§
  let base_attrs = [
    ("service.name", azimuth::StringValue("base-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.instance.id", azimuth::StringValue("instance-123"))
  ]
  let resource_with_base = azimuth::Resource::with_attributes(base_resource, base_attrs)
  
  // éªŒè¯åŸºç¡€å±æ€§
  assert_eq(azimuth::Resource::get_attribute(resource_with_base, "service.name"), Some(azimuth::StringValue("base-service")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_base, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_base, "service.instance.id"), Some(azimuth::StringValue("instance-123")))
  
  // åˆ›å»ºè¦†ç›–èµ„æº
  let override_attrs = [
    ("service.name", azimuth::StringValue("override-service")),  // è¦†ç›–åŸºç¡€å±æ€§
    ("environment", azimuth::StringValue("production")),         // æ–°å¢å±æ€§
    ("deployment.region", azimuth::StringValue("us-west-2"))     // æ–°å¢å±æ€§
  ]
  let override_resource = azimuth::Resource::with_attributes(base_resource, override_attrs)
  
  // æµ‹è¯•èµ„æºåˆå¹¶
  let merged_resource = azimuth::Resource::merge(resource_with_base, override_resource)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.name"), Some(azimuth::StringValue("override-service")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "service.instance.id"), Some(azimuth::StringValue("instance-123")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "environment"), Some(azimuth::StringValue("production")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "deployment.region"), Some(azimuth::StringValue("us-west-2")))
  
  // æµ‹è¯•ç©ºèµ„æºåˆå¹¶
  let empty_resource = azimuth::Resource::new()
  let merged_with_empty = azimuth::Resource::merge(resource_with_base, empty_resource)
  assert_eq(azimuth::Resource::get_attribute(merged_with_empty, "service.name"), Some(azimuth::StringValue("base-service")))
  
  // æµ‹è¯•å¤æ‚å±æ€§å€¼
  let complex_attrs = [
    ("service.tags", azimuth::ArrayStringValue(["web", "api", "microservice"])),
    ("service.ports", azimuth::ArrayIntValue([8080, 8443, 9090])),
    ("service.enabled", azimuth::BoolValue(true)),
    ("service.weight", azimuth::FloatValue(0.75))
  ]
  let complex_resource = azimuth::Resource::with_attributes(base_resource, complex_attrs)
  
  // éªŒè¯å¤æ‚å±æ€§
  assert_eq(azimuth::Resource::get_attribute(complex_resource, "service.tags"), Some(azimuth::ArrayStringValue(["web", "api", "microservice"])))
  assert_eq(azimuth::Resource::get_attribute(complex_resource, "service.ports"), Some(azimuth::ArrayIntValue([8080, 8443, 9090])))
  assert_eq(azimuth::Resource::get_attribute(complex_resource, "service.enabled"), Some(azimuth::BoolValue(true)))
  assert_eq(azimuth::Resource::get_attribute(complex_resource, "service.weight"), Some(azimuth::FloatValue(0.75)))
}

// æµ‹è¯•ç”¨ä¾‹7: ä¼ æ’­å™¨æ³¨å…¥å’Œæå–æ“ä½œ
pub test "ä¼ æ’­å™¨æ³¨å…¥å’Œæå–æ“ä½œæµ‹è¯•" {
  // åˆ›å»ºä¼ æ’­å™¨
  let trace_propagator = azimuth::W3CTraceContextPropagator::new()
  let baggage_propagator = azimuth::W3CBaggagePropagator::new()
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨
  let propagators = [trace_propagator]
  let composite_propagator = azimuth::CompositePropagator::new(propagators)
  
  // åˆ›å»ºè½½ä½“
  let carrier = azimuth::TextMapCarrier::new()
  
  // åˆ›å»ºä¸Šä¸‹æ–‡
  let ctx = azimuth::Context::root()
  
  // æµ‹è¯•æ³¨å…¥æ“ä½œ
  azimuth::CompositePropagator::inject(composite_propagator, ctx, carrier)
  
  // éªŒè¯æ³¨å…¥çš„å¤´éƒ¨
  let trace_header = azimuth::TextMapCarrier::get(carrier, "traceparent")
  assert_eq(trace_header, Some("00-test-trace-id-test-span-id-01"))
  
  // æµ‹è¯•æå–æ“ä½œ
  let extracted_ctx = azimuth::CompositePropagator::extract(composite_propagator, carrier)
  
  // éªŒè¯æå–ç»“æœ
  let key = azimuth::ContextKey::new("extracted")
  let extracted_value = azimuth::Context::get(extracted_ctx, key)
  assert_eq(extracted_value, Some("true"))
  
  // æµ‹è¯•Baggageä¼ æ’­
  let baggage_carrier = azimuth::TextMapCarrier::new()
  let baggage_with_entries = azimuth::Baggage::new()
  let updated_baggage = azimuth::Baggage::set_entry(baggage_with_entries, "user.id", "user-123")
  let final_baggage = azimuth::Baggage::set_entry(updated_baggage, "request.id", "req-456")
  
  // éªŒè¯Baggageæ¡ç›®
  assert_eq(azimuth::Baggage::get_entry(final_baggage, "user.id"), Some("user-123"))
  assert_eq(azimuth::Baggage::get_entry(final_baggage, "request.id"), Some("req-456"))
  
  // æµ‹è¯•å¤šä¼ æ’­å™¨ç»„åˆ
  let multiple_propagators = [trace_propagator]
  let multi_composite = azimuth::CompositePropagator::new(multiple_propagators)
  
  let multi_carrier = azimuth::TextMapCarrier::new()
  azimuth::CompositePropagator::inject(multi_composite, ctx, multi_carrier)
  
  let multi_trace_header = azimuth::TextMapCarrier::get(multi_carrier, "traceparent")
  assert_eq(multi_trace_header, Some("00-test-trace-id-test-span-id-01"))
  
  // æµ‹è¯•ç©ºè½½ä½“å¤„ç†
  let empty_carrier = azimuth::TextMapCarrier::new()
  let extracted_from_empty = azimuth::CompositePropagator::extract(composite_propagator, empty_carrier)
  let empty_key = azimuth::ContextKey::new("empty.test")
  let empty_value = azimuth::Context::get(extracted_from_empty, empty_key)
  assert_eq(empty_value, None)
}

// æµ‹è¯•ç”¨ä¾‹8: é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶
pub test "é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  // æµ‹è¯•ç©ºå±æ€§å¤„ç†
  let empty_attrs = azimuth::Attributes::new()
  assert_eq(azimuth::Attributes::get(empty_attrs, ""), None)
  assert_eq(azimuth::Attributes::get(empty_attrs, "nonexistent.key"), None)
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²é”®
  let attrs_with_empty_key = azimuth::Attributes::new()
  azimuth::Attributes::set(attrs_with_empty_key, "", azimuth::StringValue("empty.key.value"))
  let empty_key_value = azimuth::Attributes::get(attrs_with_empty_key, "")
  assert_eq(empty_key_value, Some(azimuth::StringValue("test_value")))
  
  // æµ‹è¯•æé•¿é”®å
  let very_long_key = "this.is.a.very.long.key.name.that.exceeds.normal.expectations.and.tests.boundary.conditions"
  let attrs_with_long_key = azimuth::Attributes::new()
  azimuth::Attributes::set(attrs_with_long_key, very_long_key, azimuth::StringValue("long.key.value"))
  let long_key_value = azimuth::Attributes::get(attrs_with_long_key, very_long_key)
  assert_eq(long_key_value, Some(azimuth::StringValue("test_value")))
  
  // æµ‹è¯•æ— æ•ˆSpanä¸Šä¸‹æ–‡
  let empty_trace_ctx = azimuth::SpanContext::new("", "span123", true, "")
  assert_false(azimuth::SpanContext::is_valid(empty_trace_ctx))
  
  let empty_span_ctx = azimuth::SpanContext::new("trace123", "", true, "")
  assert_false(azimuth::SpanContext::is_valid(empty_span_ctx))
  
  let both_empty_ctx = azimuth::SpanContext::new("", "", false, "")
  assert_false(azimuth::SpanContext::is_valid(both_empty_ctx))
  assert_false(azimuth::SpanContext::is_sampled(both_empty_ctx))
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡é”®è¾¹ç•Œæ¡ä»¶
  let empty_context_key = azimuth::ContextKey::new("")
  let root_ctx = azimuth::Context::root()
  let ctx_with_empty_key = azimuth::Context::with_value(root_ctx, empty_context_key, "empty.context.value")
  let empty_context_value = azimuth::Context::get(ctx_with_empty_key, empty_context_key)
  assert_eq(empty_context_value, Some("empty.context.value"))
  
  // æµ‹è¯•æ•°å€¼è¾¹ç•Œæ¡ä»¶
  let boundary_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(boundary_attrs, "max.int", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(boundary_attrs, "min.int", azimuth::IntValue(-2147483648))
  azimuth::Attributes::set(boundary_attrs, "zero.int", azimuth::IntValue(0))
  
  azimuth::Attributes::set(boundary_attrs, "max.float", azimuth::FloatValue(1.7976931348623157e+308))
  azimuth::Attributes::set(boundary_attrs, "min.float", azimuth::FloatValue(-1.7976931348623157e+308))
  azimuth::Attributes::set(boundary_attrs, "zero.float", azimuth::FloatValue(0.0))
  azimuth::Attributes::set(boundary_attrs, "negative.zero", azimuth::FloatValue(-0.0))
  
  // æµ‹è¯•ç‰¹æ®Šæµ®ç‚¹å€¼
  azimuth::Attributes::set(boundary_attrs, "infinity", azimuth::FloatValue(1.0/0.0))
  azimuth::Attributes::set(boundary_attrs, "negative.infinity", azimuth::FloatValue(-1.0/0.0))
  
  // æµ‹è¯•ç©ºæ•°ç»„å’Œå•å…ƒç´ æ•°ç»„
  azimuth::Attributes::set(boundary_attrs, "empty.string.array", azimuth::ArrayStringValue([]))
  azimuth::Attributes::set(boundary_attrs, "single.string.array", azimuth::ArrayStringValue(["single"]))
  azimuth::Attributes::set(boundary_attrs, "empty.int.array", azimuth::ArrayIntValue([]))
  azimuth::Attributes::set(boundary_attrs, "single.int.array", azimuth::ArrayIntValue([42]))
}

// æµ‹è¯•ç”¨ä¾‹9: æ€§èƒ½å’Œå¹¶å‘å®‰å…¨æµ‹è¯•
pub test "æ€§èƒ½å’Œå¹¶å‘å®‰å…¨æµ‹è¯•" {
  // æµ‹è¯•å¤§é‡å±æ€§æ“ä½œæ€§èƒ½
  let start_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  let large_attrs = azimuth::Attributes::new()
  
  // æ·»åŠ å¤§é‡å±æ€§
  for i in 0..1000 {
    let key = "attr." + i.to_string()
    let value = azimuth::StringValue("value." + i.to_string())
    azimuth::Attributes::set(large_attrs, key, value)
  }
  
  // æŸ¥è¯¢å¤§é‡å±æ€§
  for i in 0..1000 {
    let key = "attr." + i.to_string()
    let _ = azimuth::Attributes::get(large_attrs, key)
  }
  
  let end_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let duration = end_time - start_time
  
  // éªŒè¯æ€§èƒ½åœ¨åˆç†èŒƒå›´å†…ï¼ˆå°äº5ç§’ï¼‰
  assert_true(duration < 5000000000L)
  
  // æµ‹è¯•å¤§é‡Spanåˆ›å»ºæ€§èƒ½
  let span_start_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "performance-test")
  
  let spans = []
  
  // åˆ›å»ºå¤§é‡Span
  for i in 0..100 {
    let span = azimuth::Tracer::start_span(tracer, "perf-span-" + i.to_string())
    spans.push(span)
  }
  
  // æ‰¹é‡æ“ä½œSpan
  for span in spans {
    azimuth::Span::add_event(span, "performance.event", Some([("iteration", azimuth::StringValue("test"))]))
    azimuth::Span::set_status(span, azimuth::Ok)
  }
  
  // æ‰¹é‡ç»“æŸSpan
  for span in spans {
    azimuth::Span::end(span)
  }
  
  let span_end_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let span_duration = span_end_time - span_start_time
  
  // éªŒè¯Spanæ“ä½œæ€§èƒ½ï¼ˆå°äº10ç§’ï¼‰
  assert_true(span_duration < 10000000000L)
  assert_true(spans.length() == 100)
  
  // æµ‹è¯•åº¦é‡æ“ä½œæ€§èƒ½
  let metric_start_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "perf-meter")
  let counter = azimuth::Meter::create_counter(meter, "perf-counter")
  let histogram = azimuth::Meter::create_histogram(meter, "perf-histogram")
  
  // å¤§é‡åº¦é‡æ“ä½œ
  for i in 0..1000 {
    azimuth::Counter::add(counter, 1.0)
    azimuth::Histogram::record(histogram, i.to_double())
  }
  
  let metric_end_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let metric_duration = metric_end_time - metric_start_time
  
  // éªŒè¯åº¦é‡æ“ä½œæ€§èƒ½ï¼ˆå°äº5ç§’ï¼‰
  assert_true(metric_duration < 5000000000L)
}

// æµ‹è¯•ç”¨ä¾‹10: ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
pub test "ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•" {
  // è®¾ç½®èµ„æº
  let resource = azimuth::Resource::new()
  let resource_attrs = [
    ("service.name", azimuth::StringValue("integration-test-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.instance.id", azimuth::StringValue("instance-12345")),
    ("deployment.environment", azimuth::StringValue("test"))
  ]
  let service_resource = azimuth::Resource::with_attributes(resource, resource_attrs)
  
  // è®¾ç½®ä¸Šä¸‹æ–‡å’ŒBaggage
  let ctx = azimuth::Context::root()
  let user_key = azimuth::ContextKey::new("user.id")
  let request_key = azimuth::ContextKey::new("request.id")
  let session_key = azimuth::ContextKey::new("session.id")
  
  let ctx_with_user = azimuth::Context::with_value(ctx, user_key, "user-12345")
  let ctx_with_request = azimuth::Context::with_value(ctx_with_user, request_key, "req-67890")
  let ctx_with_session = azimuth::Context::with_value(ctx_with_request, session_key, "sess-abcde")
  
  // è®¾ç½®Baggage
  let baggage = azimuth::Baggage::new()
  let baggage_with_user = azimuth::Baggage::set_entry(baggage, "user.id", "user-12345")
  let baggage_with_request = azimuth::Baggage::set_entry(baggage_with_user, "request.id", "req-67890")
  let final_baggage = azimuth::Baggage::set_entry(baggage_with_request, "session.id", "sess-abcde")
  
  // åˆ›å»ºè¿½è¸ªç»„ä»¶
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "integration-tracer", Some("1.0.0"))
  
  // åˆ›å»ºSpanå±‚æ¬¡ç»“æ„
  let root_span = azimuth::Tracer::start_span(tracer, "root-operation")
  let child_span1 = azimuth::Tracer::start_span(tracer, "child-operation-1")
  let child_span2 = azimuth::Tracer::start_span(tracer, "child-operation-2")
  let grandchild_span = azimuth::Tracer::start_span(tracer, "grandchild-operation")
  
  // æ·»åŠ Spanäº‹ä»¶å’Œå±æ€§
  let span_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(span_attrs, "operation.type", azimuth::StringValue("integration"))
  azimuth::Attributes::set(span_attrs, "component.version", azimuth::StringValue("1.0.0"))
  
  azimuth::Span::add_event(root_span, "operation.started", Some(span_attrs))
  azimuth::Span::add_event(child_span1, "child.operation.started", Some(span_attrs))
  azimuth::Span::add_event(child_span2, "child.operation.started", Some(span_attrs))
  azimuth::Span::add_event(grandchild_span, "grandchild.operation.started", Some(span_attrs))
  
  // è®¾ç½®SpançŠ¶æ€
  azimuth::Span::set_status(root_span, azimuth::Ok)
  azimuth::Span::set_status(child_span1, azimuth::Ok)
  azimuth::Span::set_status(child_span2, azimuth::Ok)
  azimuth::Span::set_status(grandchild_span, azimuth::Ok)
  
  // åˆ›å»ºåº¦é‡ç»„ä»¶
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "integration-meter", Some("1.0.0"))
  
  let request_counter = azimuth::Meter::create_counter(meter, "requests.total", Some("Total number of requests"), Some("count"))
  let response_histogram = azimuth::Meter::create_histogram(meter, "response.time", Some("Response time in milliseconds"), Some("ms"))
  let active_gauge = azimuth::Meter::create_gauge(meter, "active.connections", Some("Currently active connections"), Some("connections"))
  
  // æ‰§è¡Œåº¦é‡æ“ä½œ
  azimuth::Counter::add(request_counter, 1.0)
  azimuth::Histogram::record(response_histogram, 150.5)
  azimuth::Histogram::record(response_histogram, 200.75)
  azimuth::Histogram::record(response_histogram, 100.25)
  
  // åˆ›å»ºæ—¥å¿—ç»„ä»¶
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "integration-logger", Some("1.0.0"))
  
  // åˆ›å»ºæ—¥å¿—è®°å½•
  let log_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(log_attrs, "user.id", azimuth::StringValue("user-12345"))
  azimuth::Attributes::set(log_attrs, "request.id", azimuth::StringValue("req-67890"))
  azimuth::Attributes::set(log_attrs, "session.id", azimuth::StringValue("sess-abcde"))
  
  let info_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Integration test operation completed successfully"),
    Some(log_attrs),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some(azimuth::SpanContext::trace_id(azimuth::Span::span_context(root_span))),
    Some(azimuth::SpanContext::span_id(azimuth::Span::span_context(root_span))),
    Some(ctx_with_session)
  )
  
  let error_log = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("Integration test error occurred"),
    Some(log_attrs),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some(azimuth::SpanContext::trace_id(azimuth::Span::span_context(child_span1))),
    Some(azimuth::SpanContext::span_id(azimuth::Span::span_context(child_span1))),
    Some(ctx_with_session)
  )
  
  // å‘å°„æ—¥å¿—
  azimuth::Logger::emit(logger, info_log)
  azimuth::Logger::emit(logger, error_log)
  
  // ç»“æŸæ‰€æœ‰Span
  azimuth::Span::end(grandchild_span)
  azimuth::Span::end(child_span2)
  azimuth::Span::end(child_span1)
  azimuth::Span::end(root_span)
  
  // éªŒè¯æ‰€æœ‰ç»„ä»¶åˆ›å»ºæ­£ç¡®
  assert_eq(azimuth::Span::name(root_span), "root-operation")
  assert_eq(azimuth::Span::name(child_span1), "child-operation-1")
  assert_eq(azimuth::Span::name(child_span2), "child-operation-2")
  assert_eq(azimuth::Span::name(grandchild_span), "grandchild-operation")
  
  assert_eq(request_counter.name, "requests.total")
  assert_eq(response_histogram.name, "response.time")
  assert_eq(active_gauge.name, "active.connections")
  
  assert_eq(logger.scope.name, "integration-logger")
  assert_eq(logger.scope.version, Some("1.0.0"))
  
  assert_eq(azimuth::LogRecord::body(info_log), Some("Integration test operation completed successfully"))
  assert_eq(azimuth::LogRecord::body(error_log), Some("Integration test error occurred"))
  
  // éªŒè¯èµ„æºå±æ€§
  assert_eq(azimuth::Resource::get_attribute(service_resource, "service.name"), Some(azimuth::StringValue("integration-test-service")))
  assert_eq(azimuth::Resource::get_attribute(service_resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(service_resource, "service.instance.id"), Some(azimuth::StringValue("instance-12345")))
  assert_eq(azimuth::Resource::get_attribute(service_resource, "deployment.environment"), Some(azimuth::StringValue("test")))
  
  // éªŒè¯ä¸Šä¸‹æ–‡å’ŒBaggage
  assert_eq(azimuth::Context::get(ctx_with_session, user_key), Some("user-12345"))
  assert_eq(azimuth::Context::get(ctx_with_session, request_key), Some("req-67890"))
  assert_eq(azimuth::Context::get(ctx_with_session, session_key), Some("sess-abcde"))
  
  assert_eq(azimuth::Baggage::get_entry(final_baggage, "user.id"), Some("user-12345"))
  assert_eq(azimuth::Baggage::get_entry(final_baggage, "request.id"), Some("req-67890"))
  assert_eq(azimuth::Baggage::get_entry(final_baggage, "session.id"), Some("sess-abcde"))
}
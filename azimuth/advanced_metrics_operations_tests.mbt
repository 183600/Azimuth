// Azimuth Advanced Metrics Operations Tests - é«˜çº§åº¦é‡æ“ä½œæµ‹è¯•
// æµ‹è¯•å¤æ‚åº¦é‡åœºæ™¯ã€èšåˆæ“ä½œã€æ—¶é—´åºåˆ—åº¦é‡å’Œé«˜çº§åº¦é‡æ¨¡å¼

test "å¤åˆåº¦é‡æ“ä½œæµ‹è¯•" {
  // æµ‹è¯•å¤šç§åº¦é‡ç±»å‹çš„ç»„åˆæ“ä½œ
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "composite-metrics-test")
  
  // åˆ›å»ºå¤šç§åº¦é‡ç±»å‹
  let request_counter = Meter::create_counter(meter, "http.requests.total", Some("Total HTTP requests"), Some("requests"))
  let response_histogram = Meter::create_histogram(meter, "http.response.duration", Some("HTTP response duration"), Some("ms"))
  let active_connections = Meter::create_updown_counter(meter, "http.active_connections", Some("Active HTTP connections"), Some("connections"))
  let memory_usage = Meter::create_gauge(meter, "memory.usage", Some("Memory usage"), Some("bytes"))
  
  // æ¨¡æ‹Ÿå¤åˆåº¦é‡æ“ä½œ
  for i in 0..=99 {
    // è¯·æ±‚è®¡æ•°
    Counter::add(request_counter, 1.0, {
      attributes: {
        let attrs = Attributes::new()
        Attributes::set(attrs, "method", StringValue(if i % 2 == 0 { "GET" } else { "POST" }))
        Attributes::set(attrs, "status", StringValue(if i % 10 == 0 { "500" } else { "200" }))
        Attributes::set(attrs, "endpoint", StringValue("/api/resource/" + (i % 5).to_string()))
        attrs
      }
    })
    
    // å“åº”æ—¶é—´åˆ†å¸ƒ
    let response_time = 50.0 + (i.to_double() * 2.5) + (Random::next_u64(Random::system()).to_double() % 100.0)
    Histogram::record(response_histogram, response_time, {
      attributes: {
        let attrs = Attributes::new()
        Attributes::set(attrs, "method", StringValue(if i % 2 == 0 { "GET" } else { "POST" }))
        Attributes::set(attrs, "endpoint", StringValue("/api/resource/" + (i % 5).to_string()))
        attrs
      }
    })
    
    // æ´»è·ƒè¿æ¥æ•°å˜åŒ–
    if i % 3 == 0 {
      UpDownCounter::add(active_connections, 1.0)
    } else if i % 7 == 0 {
      UpDownCounter::add(active_connections, -1.0)
    }
    
    // å†…å­˜ä½¿ç”¨é‡
    let memory_value = 1024.0 * 1024.0 * (100.0 + (i.to_double() * 10.0) % 500.0)  // 100-600MB
    Gauge::add(memory_usage, memory_value, {
      attributes: {
        let attrs = Attributes::new()
        Attributes::set(attrs, "component", StringValue("application"))
        Attributes::set(attrs, "type", StringValue("heap"))
        attrs
      }
    })
  }
  
  // éªŒè¯åº¦é‡åˆ›å»ºå’Œé…ç½®
  assert_eq(request_counter.name, "http.requests.total")
  assert_eq(request_counter.description, Some("Total HTTP requests"))
  assert_eq(request_counter.unit, Some("requests"))
  
  assert_eq(response_histogram.name, "http.response.duration")
  assert_eq(response_histogram.description, Some("HTTP response duration"))
  assert_eq(response_histogram.unit, Some("ms"))
  
  assert_eq(active_connections.name, "http.active_connections")
  assert_eq(active_connections.description, Some("Active HTTP connections"))
  assert_eq(active_connections.unit, Some("connections"))
  
  assert_eq(memory_usage.name, "memory.usage")
  assert_eq(memory_usage.description, Some("Memory usage"))
  assert_eq(memory_usage.unit, Some("bytes"))
  
  // æµ‹è¯•åº¦é‡è½¬æ¢ä¸ºInstrumentç±»å‹
  let counter_instrument = Counter(request_counter.name, request_counter.description, request_counter.unit)
  assert_eq(Instrument::name(counter_instrument), "http.requests.total")
  assert_eq(Instrument::description(counter_instrument), Some("Total HTTP requests"))
  assert_eq(Instrument::unit(counter_instrument), Some("requests"))
  
  let histogram_instrument = Histogram::as_instrument(response_histogram)
  assert_eq(Instrument::name(histogram_instrument), "http.response.duration")
}

test "èšåˆåº¦é‡æ“ä½œæµ‹è¯•" {
  // æµ‹è¯•åº¦é‡èšåˆæ“ä½œ
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "aggregation-metrics-test")
  
  // åˆ›å»ºç”¨äºèšåˆçš„åº¦é‡
  let api_calls_counter = Meter::create_counter(meter, "api.calls.total", Some("Total API calls"), Some("calls"))
  let response_size_histogram = Meter::create_histogram(meter, "api.response.size", Some("API response size"), Some("bytes"))
  let error_rate_counter = Meter::create_counter(meter, "api.errors.total", Some("Total API errors"), Some("errors"))
  
  // æ¨¡æ‹Ÿä¸åŒæœåŠ¡çš„APIè°ƒç”¨
  let services = ["user-service", "order-service", "payment-service", "inventory-service", "notification-service"]
  let endpoints = ["/users", "/orders", "/payments", "/inventory", "/notifications"]
  
  for i in 0..=199 {
    let service_index = i % services.length()
    let service = services[service_index]
    let endpoint = endpoints[service_index]
    
    // APIè°ƒç”¨è®¡æ•°
    Counter::add(api_calls_counter, 1.0, {
      attributes: {
        let attrs = Attributes::new()
        Attributes::set(attrs, "service", StringValue(service))
        Attributes::set(attrs, "endpoint", StringValue(endpoint))
        Attributes::set(attrs, "method", StringValue(match i % 4 {
          0 => "GET"
          1 => "POST"
          2 => "PUT"
          _ => "DELETE"
        }))
        attrs
      }
    })
    
    // å“åº”å¤§å°åˆ†å¸ƒ
    let response_size = 100.0 + (Random::next_u64(Random::system()).to_double() % 10000.0)
    Histogram::record(response_size_histogram, response_size, {
      attributes: {
        let attrs = Attributes::new()
        Attributes::set(attrs, "service", StringValue(service))
        Attributes::set(attrs, "endpoint", StringValue(endpoint))
        attrs
      }
    })
    
    // é”™è¯¯è®¡æ•°ï¼ˆ10%çš„è¯·æ±‚å‡ºé”™ï¼‰
    if i % 10 == 0 {
      Counter::add(error_rate_counter, 1.0, {
        attributes: {
          let attrs = Attributes::new()
          Attributes::set(attrs, "service", StringValue(service))
          Attributes::set(attrs, "error.type", StringValue(match i % 3 {
            0 => "timeout"
            1 => "connection_error"
            _ => "server_error"
          }))
          attrs
        }
      })
    }
  }
  
  // éªŒè¯èšåˆåº¦é‡çš„é…ç½®
  assert_eq(api_calls_counter.name, "api.calls.total")
  assert_eq(response_size_histogram.name, "api.response.size")
  assert_eq(error_rate_counter.name, "api.errors.total")
  
  // æµ‹è¯•èšåˆè®¡ç®—ï¼ˆæ¨¡æ‹Ÿï¼‰
  let total_api_calls = 200.0  // æ€»è°ƒç”¨æ¬¡æ•°
  let total_errors = 20.0      // æ€»é”™è¯¯æ¬¡æ•°
  let error_rate = total_errors / total_api_calls * 100.0  // é”™è¯¯ç‡
  
  assert_true(error_rate == 10.0)
  
  // æµ‹è¯•æŒ‰æœåŠ¡åˆ†ç»„çš„èšåˆ
  for service in services {
    // æ¯ä¸ªæœåŠ¡åº”è¯¥æœ‰å¤§çº¦40æ¬¡è°ƒç”¨ï¼ˆ200/5ï¼‰
    let expected_calls_per_service = 40.0
    assert_true(expected_calls_per_service == 40.0)
    
    // æ¯ä¸ªæœåŠ¡åº”è¯¥æœ‰å¤§çº¦4æ¬¡é”™è¯¯ï¼ˆ20/5ï¼‰
    let expected_errors_per_service = 4.0
    assert_true(expected_errors_per_service == 4.0)
  }
}

test "æ—¶é—´åºåˆ—åº¦é‡æµ‹è¯•" {
  // æµ‹è¯•æ—¶é—´åºåˆ—åº¦é‡æ•°æ®
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "timeseries-metrics-test")
  
  // åˆ›å»ºæ—¶é—´åºåˆ—åº¦é‡
  let cpu_usage = Meter::create_gauge(meter, "system.cpu.usage", Some("CPU usage percentage"), Some("%"))
  let memory_usage = Meter::create_gauge(meter, "system.memory.usage", Some("Memory usage percentage"), Some("%"))
  let disk_io = Meter::create_counter(meter, "system.disk.io", Some("Disk I/O operations"), Some("operations"))
  let network_throughput = Meter::create_histogram(meter, "system.network.throughput", Some("Network throughput"), Some("bytes/s"))
  
  // æ¨¡æ‹Ÿæ—¶é—´åºåˆ—æ•°æ®æ”¶é›†
  let time_series_data = []
  let base_timestamp = Clock::now_unix_nanos(Clock::system())
  
  for i in 0..=59 {  // 60ä¸ªæ—¶é—´ç‚¹ï¼ˆæ¨¡æ‹Ÿ1åˆ†é’Ÿçš„æ•°æ®ï¼Œæ¯ç§’ä¸€ä¸ªç‚¹ï¼‰
    let timestamp = base_timestamp + (i.to_int64() * 1000000000L)  // æ¯ç§’ä¸€ä¸ªæ—¶é—´ç‚¹
    
    // CPUä½¿ç”¨ç‡ï¼ˆæ¨¡æ‹Ÿå‘¨æœŸæ€§å˜åŒ–ï¼‰
    let cpu_value = 20.0 + (10.0 * (i.to_double() / 60.0 * 6.28).sin()) + (Random::next_u64(Random::system()).to_double() % 10.0)
    Gauge::add(cpu_usage, cpu_value, {
      attributes: {
        let attrs = Attributes::new()
        Attributes::set(attrs, "core", StringValue("total"))
        Attributes::set(attrs, "timestamp", IntValue(timestamp.to_int()))
        attrs
      }
    })
    
    // å†…å­˜ä½¿ç”¨ç‡ï¼ˆæ¨¡æ‹Ÿé€æ¸å¢é•¿ï¼‰
    let memory_value = 30.0 + (i.to_double() * 0.5) + (Random::next_u64(Random::system()).to_double() % 5.0)
    Gauge::add(memory_usage, memory_value, {
      attributes: {
        let attrs = Attributes::new()
        Attributes::set(attrs, "type", StringValue("used"))
        Attributes::set(attrs, "timestamp", IntValue(timestamp.to_int()))
        attrs
      }
    })
    
    // ç£ç›˜I/Oï¼ˆæ¨¡æ‹Ÿéšæœºæ³¢åŠ¨ï¼‰
    if i % 2 == 0 {
      let disk_operations = (Random::next_u64(Random::system()).to_double() % 100.0).to_int()
      Counter::add(disk_io, disk_operations.to_double(), {
        attributes: {
          let attrs = Attributes::new()
          Attributes::set(attrs, "operation", StringValue(if i % 4 == 0 { "read" } else { "write" }))
          Attributes::set(attrs, "device", StringValue("/dev/sda1"))
          attrs
        }
      })
    }
    
    // ç½‘ç»œååé‡ï¼ˆæ¨¡æ‹Ÿçªå‘å’Œç©ºé—²ï¼‰
    let network_value = if i % 10 < 3 { 
      1000.0 + (Random::next_u64(Random::system()).to_double() % 5000.0)  // çªå‘æœŸ
    } else { 
      100.0 + (Random::next_u64(Random::system()).to_double() % 200.0)   // ç©ºé—²æœŸ
    }
    Histogram::record(network_throughput, network_value, {
      attributes: {
        let attrs = Attributes::new()
        Attributes::set(attrs, "interface", StringValue("eth0"))
        Attributes::set(attrs, "direction", StringValue(if i % 2 == 0 { "tx" } else { "rx" }))
        attrs
      }
    })
    
    time_series_data.push((timestamp, cpu_value, memory_value))
  }
  
  // éªŒè¯æ—¶é—´åºåˆ—æ•°æ®
  assert_true(time_series_data.length() == 60)
  
  // éªŒè¯æ—¶é—´æˆ³é€’å¢
  for i in 1..=time_series_data.length() - 1 {
    let current_timestamp = time_series_data[i].0
    let prev_timestamp = time_series_data[i-1].0
    assert_true(current_timestamp > prev_timestamp)
  }
  
  // éªŒè¯åº¦é‡çš„æ—¶é—´åºåˆ—ç‰¹æ€§
  assert_eq(cpu_usage.name, "system.cpu.usage")
  assert_eq(cpu_usage.description, Some("CPU usage percentage"))
  assert_eq(cpu_usage.unit, Some("%"))
  
  assert_eq(memory_usage.name, "system.memory.usage")
  assert_eq(memory_usage.description, Some("Memory usage percentage"))
  assert_eq(memory_usage.unit, Some("%"))
  
  assert_eq(disk_io.name, "system.disk.io")
  assert_eq(network_throughput.name, "system.network.throughput")
}

test "ä¸šåŠ¡åº¦é‡æµ‹è¯•" {
  // æµ‹è¯•ä¸šåŠ¡ç›¸å…³çš„åº¦é‡æŒ‡æ ‡
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "business-metrics-test")
  
  // åˆ›å»ºä¸šåŠ¡åº¦é‡
  let revenue_counter = Meter::create_counter(meter, "business.revenue.total", Some("Total revenue"), Some("USD"))
  let order_counter = Meter::create_counter(meter, "business.orders.total", Some("Total orders"), Some("orders"))
  let customer_counter = Meter::create_updown_counter(meter, "business.customers.active", Some("Active customers"), Some("customers"))
  let conversion_rate = Meter::create_histogram(meter, "business.conversion.rate", Some("Conversion rate"), Some("%"))
  
  // æ¨¡æ‹Ÿä¸šåŠ¡æ“ä½œ
  let products = ["laptop", "phone", "tablet", "watch", "headphones"]
  let regions = ["north-america", "europe", "asia-pacific", "latin-america", "middle-east"]
  
  for i in 0..=149 {
    let product = products[i % products.length()]
    let region = regions[i % regions.length()]
    
    // è®¢å•è®¡æ•°
    Counter::add(order_counter, 1.0, {
      attributes: {
        let attrs = Attributes::new()
        Attributes::set(attrs, "product", StringValue(product))
        Attributes::set(attrs, "region", StringValue(region))
        Attributes::set(attrs, "channel", StringValue(match i % 3 {
          0 => "online"
          1 => "retail"
          _ => "mobile"
        }))
        attrs
      }
    })
    
    // æ”¶å…¥è®¡ç®—
    let product_prices = [
      ("laptop", 1200.0),
      ("phone", 800.0),
      ("tablet", 500.0),
      ("watch", 300.0),
      ("headphones", 150.0)
    ]
    
    let price = match product {
      "laptop" => 1200.0
      "phone" => 800.0
      "tablet" => 500.0
      "watch" => 300.0
      _ => 150.0
    }
    
    Counter::add(revenue_counter, price, {
      attributes: {
        let attrs = Attributes::new()
        Attributes::set(attrs, "product", StringValue(product))
        Attributes::set(attrs, "region", StringValue(region))
        Attributes::set(attrs, "currency", StringValue("USD"))
        attrs
      }
    })
    
    // æ´»è·ƒå®¢æˆ·å˜åŒ–
    if i % 5 == 0 {
      UpDownCounter::add(customer_counter, 1.0)  // æ–°å®¢æˆ·
    }
    if i % 20 == 0 {
      UpDownCounter::add(customer_counter, -1.0)  // æµå¤±å®¢æˆ·
    }
    
    // è½¬åŒ–ç‡ï¼ˆæ¨¡æ‹Ÿè®¿é—®åˆ°è´­ä¹°çš„è½¬åŒ–ï¼‰
    if i % 3 == 0 {
      let conversion_value = (Random::next_u64(Random::system()).to_double() % 100.0) / 100.0 * 10.0  // 0-10%
      Histogram::record(conversion_rate, conversion_value, {
        attributes: {
          let attrs = Attributes::new()
          Attributes::set(attrs, "funnel_stage", StringValue("purchase"))
          Attributes::set(attrs, "user_segment", StringValue(match i % 4 {
            0 => "new"
            1 => "returning"
            2 => "vip"
            _ => "at_risk"
          }))
          attrs
        }
      })
    }
  }
  
  // éªŒè¯ä¸šåŠ¡åº¦é‡é…ç½®
  assert_eq(revenue_counter.name, "business.revenue.total")
  assert_eq(revenue_counter.description, Some("Total revenue"))
  assert_eq(revenue_counter.unit, Some("USD"))
  
  assert_eq(order_counter.name, "business.orders.total")
  assert_eq(customer_counter.name, "business.customers.active")
  assert_eq(conversion_rate.name, "business.conversion.rate")
  
  // éªŒè¯ä¸šåŠ¡é€»è¾‘
  let total_orders = 150.0
  let expected_new_customers = (150.0 / 5.0).to_int()  // 30ä¸ªæ–°å®¢æˆ·
  let expected_lost_customers = (150.0 / 20.0).to_int()  // 7ä¸ªæµå¤±å®¢æˆ·
  let expected_active_customers = expected_new_customers - expected_lost_customers
  
  assert_true(total_orders == 150.0)
  assert_true(expected_active_customers >= 0)
}

test "åº¦é‡æ€§èƒ½å’Œååé‡æµ‹è¯•" {
  // æµ‹è¯•åº¦é‡ç³»ç»Ÿçš„æ€§èƒ½å’Œååé‡
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "performance-metrics-test")
  
  // åˆ›å»ºé«˜æ€§èƒ½åº¦é‡
  let throughput_counter = Meter::create_counter(meter, "performance.throughput", Some("Operation throughput"), Some("ops/sec"))
  let latency_histogram = Meter::create_histogram(meter, "performance.latency", Some("Operation latency"), Some("ms"))
  
  let start_time = Clock::now_unix_nanos(Clock::system())
  
  // é«˜é¢‘åº¦é‡æ“ä½œ
  for i in 0..=999 {  // 1000æ¬¡æ“ä½œ
    Counter::add(throughput_counter, 1.0, {
      attributes: {
        let attrs = Attributes::new()
        Attributes::set(attrs, "operation", StringValue("high_freq_op"))
        Attributes::set(attrs, "batch", StringValue((i / 100).to_string()))
        attrs
      }
    })
    
    // æ¨¡æ‹Ÿæ“ä½œå»¶è¿Ÿ
    let latency = 1.0 + (Random::next_u64(Random::system()).to_double() % 50.0)
    Histogram::record(latency_histogram, latency, {
      attributes: {
        let attrs = Attributes::new()
        Attributes::set(attrs, "operation", StringValue("high_freq_op"))
        Attributes::set(attrs, "percentile", StringValue(if latency < 10.0 { "p50" } else if latency < 25.0 { "p90" } else { "p99" }))
        attrs
      }
    })
  }
  
  let end_time = Clock::now_unix_nanos(Clock::system())
  let operation_duration = end_time - start_time
  
  // éªŒè¯æ€§èƒ½
  assert_true(operation_duration < 10000000000L)  // å°äº10ç§’
  assert_true(throughput_counter.name == "performance.throughput")
  assert_true(latency_histogram.name == "performance.latency")
  
  // è®¡ç®—ååé‡
  let throughput = 1000.0 / (operation_duration.to_double() / 1000000000.0)  // ops/sec
  assert_true(throughput > 100.0)  // è‡³å°‘100 ops/sec
  
  // æµ‹è¯•å†…å­˜ä½¿ç”¨å’Œåƒåœ¾å›æ”¶
  let memory_start = Clock::now_unix_nanos(Clock::system())
  
  let memory_intensive_metrics = []
  for i in 0..=99 {  // 100ä¸ªä¸åŒçš„åº¦é‡
    let counter = Meter::create_counter(meter, "memory.test.counter." + i.to_string(), Some("Memory test counter"), Some("count"))
    let histogram = Meter::create_histogram(meter, "memory.test.histogram." + i.to_string(), Some("Memory test histogram"), Some("ms"))
    
    memory_intensive_metrics.push((counter, histogram))
    
    // ä¸ºæ¯ä¸ªåº¦é‡æ·»åŠ æ•°æ®
    for j in 0..=9 {
      Counter::add(counter, j.to_double())
      Histogram::record(histogram, j.to_double())
    }
  }
  
  let memory_end = Clock::now_unix_nanos(Clock::system())
  let memory_duration = memory_end - memory_start
  
  // éªŒè¯å†…å­˜æ€§èƒ½
  assert_true(memory_duration < 5000000000L)  // å°äº5ç§’
  assert_true(memory_intensive_metrics.length() == 100)
  
  // éªŒè¯å†…å­˜å¯†é›†å‹åº¦é‡çš„åˆ›å»º
  for i in 0..=memory_intensive_metrics.length() - 1 {
    let (counter, histogram) = memory_intensive_metrics[i]
    
    assert_eq(counter.name, "memory.test.counter." + i.to_string())
    assert_eq(counter.description, Some("Memory test counter"))
    assert_eq(counter.unit, Some("count"))
    
    assert_eq(histogram.name, "memory.test.histogram." + i.to_string())
    assert_eq(histogram.description, Some("Memory test histogram"))
    assert_eq(histogram.unit, Some("ms"))
  }
}

test "åº¦é‡é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  // æµ‹è¯•åº¦é‡ç³»ç»Ÿçš„é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "error-handling-metrics-test")
  
  // æµ‹è¯•æå€¼åº¦é‡
  let extreme_counter = Meter::create_counter(meter, "extreme.values.counter", Some("Extreme values test"), Some("count"))
  let extreme_histogram = Meter::create_histogram(meter, "extreme.values.histogram", Some("Extreme values test"), Some("units"))
  
  // æµ‹è¯•æå¤§å€¼
  Counter::add(extreme_counter, 999999999.0)
  Counter::add(extreme_counter, -999999999.0)  // è´Ÿå€¼æµ‹è¯•
  Histogram::record(extreme_histogram, 999999999.0)
  Histogram::record(extreme_histogram, 0.0)  // é›¶å€¼æµ‹è¯•
  Histogram::record(extreme_histogram, -999999999.0)  // è´Ÿå€¼æµ‹è¯•
  
  // æµ‹è¯•æå°å€¼
  Counter::add(extreme_counter, 0.0000001)
  Histogram::record(extreme_histogram, 0.0000001)
  
  // éªŒè¯æå€¼å¤„ç†
  assert_eq(extreme_counter.name, "extreme.values.counter")
  assert_eq(extreme_histogram.name, "extreme.values.histogram")
  
  // æµ‹è¯•ç©ºå±æ€§å’Œç‰¹æ®Šå­—ç¬¦
  let special_attrs_counter = Meter::create_counter(meter, "special.attrs.counter", Some("Special attributes test"), Some("count"))
  
  Counter::add(special_attrs_counter, 1.0, {
    attributes: {
      let attrs = Attributes::new()
      Attributes::set(attrs, "", StringValue("empty_key"))
      Attributes::set(attrs, "normal_key", StringValue(""))
      Attributes::set(attrs, "unicode_key", StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€"))
      Attributes::set(attrs, "special_chars", StringValue("!@#$%^&*()"))
      attrs
    }
  })
  
  // éªŒè¯ç‰¹æ®Šå±æ€§å¤„ç†
  assert_eq(special_attrs_counter.name, "special.attrs.counter")
  
  // æµ‹è¯•é«˜é¢‘åº¦é‡åˆ›å»º
  let high_freq_creation_start = Clock::now_unix_nanos(Clock::system())
  
  let high_freq_metrics = []
  for i in 0..=49 {  // 50ä¸ªåº¦é‡
    let counter = Meter::create_counter(meter, "high.freq.counter." + i.to_string())
    high_freq_metrics.push(counter)
  }
  
  let high_freq_creation_end = Clock::now_unix_nanos(Clock::system())
  let creation_duration = high_freq_creation_end - high_freq_creation_start
  
  // éªŒè¯é«˜é¢‘åˆ›å»ºæ€§èƒ½
  assert_true(creation_duration < 5000000000L)  // å°äº5ç§’
  assert_true(high_freq_metrics.length() == 50)
  
  // æµ‹è¯•åº¦é‡åç§°é•¿åº¦è¾¹ç•Œ
  let very_long_name = "this.is.a.very.long.metric.name.that.tests.the.boundary.conditions.of.the.metric.creation.system"
  let long_name_counter = Meter::create_counter(meter, very_long_name, Some("Very long name test"), Some("count"))
  
  assert_eq(long_name_counter.name, very_long_name)
  assert_eq(long_name_counter.description, Some("Very long name test"))
  assert_eq(long_name_counter.unit, Some("count"))
  
  // æµ‹è¯•é‡å¤åº¦é‡åç§°
  let duplicate_counter1 = Meter::create_counter(meter, "duplicate.name")
  let duplicate_counter2 = Meter::create_counter(meter, "duplicate.name")
  
  assert_eq(duplicate_counter1.name, "duplicate.name")
  assert_eq(duplicate_counter2.name, "duplicate.name")
  
  // æµ‹è¯•åº¦é‡æ“ä½œçš„å¹¶å‘å®‰å…¨æ€§ï¼ˆæ¨¡æ‹Ÿï¼‰
  let concurrent_operations_start = Clock::now_unix_nanos(Clock::system())
  
  let concurrent_counter = Meter::create_counter(meter, "concurrent.operations.counter")
  
  // æ¨¡æ‹Ÿå¹¶å‘æ“ä½œ
  for i in 0..=99 {  // 100æ¬¡æ“ä½œ
    Counter::add(concurrent_counter, 1.0, {
      attributes: {
        let attrs = Attributes::new()
        Attributes::set(attrs, "thread_id", StringValue((i % 4).to_string()))
        Attributes::set(attrs, "operation_id", StringValue(i.to_string()))
        attrs
      }
    })
  }
  
  let concurrent_operations_end = Clock::now_unix_nanos(Clock::system())
  let concurrent_duration = concurrent_operations_end - concurrent_operations_start
  
  // éªŒè¯å¹¶å‘æ“ä½œæ€§èƒ½
  assert_true(concurrent_duration < 5000000000L)  // å°äº5ç§’
  assert_eq(concurrent_counter.name, "concurrent.operations.counter")
}
// Resourceé«˜çº§åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹
// ä¸“æ³¨äºResourceå±æ€§ç®¡ç†ã€åˆå¹¶ç­–ç•¥å’Œè¾¹ç•Œæ¡ä»¶

test "Resourceå±æ€§å±‚æ¬¡ç»“æ„ç®¡ç†æµ‹è¯•" {
  // æµ‹è¯•å¤šå±‚æ¬¡Resourceå±æ€§çš„ç®¡ç†
  let base_resource = Resource::new()
  
  // ç¬¬ä¸€å±‚ï¼šåŸºç¡€æœåŠ¡å±æ€§
  let service_attrs = [
    ("service.name", StringValue("azimuth-telemetry")),
    ("service.version", StringValue("1.2.3")),
    ("service.namespace", StringValue("production"))
  ]
  let service_resource = Resource::with_attributes(base_resource, service_attrs)
  
  // ç¬¬äºŒå±‚ï¼šéƒ¨ç½²ç¯å¢ƒå±æ€§
  let deployment_attrs = [
    ("deployment.environment", StringValue("production")),
    ("deployment.region", StringValue("us-west-2")),
    ("deployment.zone", StringValue("us-west-2a"))
  ]
  let deployment_resource = Resource::with_attributes(service_resource, deployment_attrs)
  
  // ç¬¬ä¸‰å±‚ï¼šè¿è¡Œæ—¶å±æ€§
  let runtime_attrs = [
    ("process.pid", IntValue(12345)),
    ("process.executable.name", StringValue("azimuth-service")),
    ("process.command_args", ArrayStringValue(["--config", "prod.yaml", "--port", "8080"]))
  ]
  let runtime_resource = Resource::with_attributes(deployment_resource, runtime_attrs)
  
  // éªŒè¯å„å±‚å±æ€§éƒ½èƒ½æ­£ç¡®è®¿é—®
  assert_eq(Resource::get_attribute(runtime_resource, "service.name"), Some(StringValue("azimuth-telemetry")))
  assert_eq(Resource::get_attribute(runtime_resource, "deployment.environment"), Some(StringValue("production")))
  assert_eq(Resource::get_attribute(runtime_resource, "process.pid"), Some(IntValue(12345)))
  
  // éªŒè¯æ•°ç»„å±æ€§
  match Resource::get_attribute(runtime_resource, "process.command_args") {
    Some(ArrayStringValue(args)) => {
      assert_eq(args.length(), 4)
      assert_eq(args[0], "--config")
      assert_eq(args[1], "prod.yaml")
      assert_eq(args[2], "--port")
      assert_eq(args[3], "8080")
    }
    _ => assert_true(false)
  }
}

test "Resourceåˆå¹¶ç­–ç•¥ä¼˜å…ˆçº§æµ‹è¯•" {
  // æµ‹è¯•ä¸åŒåˆå¹¶åœºæ™¯ä¸‹çš„å±æ€§ä¼˜å…ˆçº§
  
  // åŸºç¡€èµ„æº
  let base_attrs = [
    ("service.name", StringValue("base-service")),
    ("service.version", StringValue("1.0.0")),
    ("host.name", StringValue("base-host")),
    ("base.only", StringValue("base-value"))
  ]
  let base_resource = Resource::with_attributes(Resource::new(), base_attrs)
  
  // è¦†ç›–èµ„æº1 - éƒ¨åˆ†è¦†ç›–
  let override1_attrs = [
    ("service.version", StringValue("2.0.0")),  // è¦†ç›–åŸºç¡€ç‰ˆæœ¬
    ("host.name", StringValue("override1-host")),  // è¦†ç›–ä¸»æœºå
    ("override1.only", StringValue("override1-value"))  // æ–°å¢å±æ€§
  ]
  let override1_resource = Resource::with_attributes(Resource::new(), override1_attrs)
  
  // è¦†ç›–èµ„æº2 - å®Œå…¨è¦†ç›–
  let override2_attrs = [
    ("service.name", StringValue("final-service")),  // å®Œå…¨è¦†ç›–æœåŠ¡å
    ("service.version", StringValue("3.0.0")),  // æœ€ç»ˆç‰ˆæœ¬
    ("override2.only", StringValue("override2-value"))
  ]
  let override2_resource = Resource::with_attributes(Resource::new(), override2_attrs)
  
  // æµ‹è¯•ä¸¤æ­¥åˆå¹¶
  let merged1 = Resource::merge(base_resource, override1_resource)
  let final_merged = Resource::merge(merged1, override2_resource)
  
  // éªŒè¯æœ€ç»ˆç»“æœï¼ˆç®€åŒ–å®ç°è¿”å›æœ€åçš„è¦†ç›–èµ„æºï¼‰
  assert_eq(Resource::get_attribute(final_merged, "service.name"), Some(StringValue("final-service")))
  assert_eq(Resource::get_attribute(final_merged, "service.version"), Some(StringValue("3.0.0")))
  assert_eq(Resource::get_attribute(final_merged, "override2.only"), Some(StringValue("override2-value")))
  
  // éªŒè¯åŸºç¡€å±æ€§åœ¨ç®€åŒ–å®ç°ä¸­ä¸å­˜åœ¨
  assert_eq(Resource::get_attribute(final_merged, "base.only"), None)
}

test "Resourceå±æ€§ç±»å‹ä¸€è‡´æ€§æµ‹è¯•" {
  // æµ‹è¯•ä¸åŒç±»å‹å±æ€§å€¼çš„ä¸€è‡´æ€§å¤„ç†
  let resource = Resource::new()
  
  // å­—ç¬¦ä¸²å±æ€§
  let string_attrs = [
    ("service.name", StringValue("test-service")),
    ("description", StringValue("Test service for telemetry")),
    ("empty.string", StringValue(""))
  ]
  
  // æ•´æ•°å±æ€§
  let int_attrs = [
    ("port", IntValue(8080)),
    ("max.connections", IntValue(1000)),
    ("timeout.seconds", IntValue(30)),
    ("zero.value", IntValue(0))
  ]
  
  // æµ®ç‚¹æ•°å±æ€§
  let float_attrs = [
    ("cpu.threshold", FloatValue(0.8)),
    ("memory.threshold", FloatValue(0.75)),
    ("response.time.target", FloatValue(100.5)),
    ("zero.float", FloatValue(0.0))
  ]
  
  // å¸ƒå°”å±æ€§
  let bool_attrs = [
    ("debug.enabled", BoolValue(false)),
    ("metrics.enabled", BoolValue(true)),
    ("tracing.enabled", BoolValue(true))
  ]
  
  // æ•°ç»„å±æ€§
  let array_attrs = [
    ("tags", ArrayStringValue(["web", "api", "production"])),
    ("endpoints", ArrayStringValue(["/health", "/metrics", "/api/v1"])),
    ("empty.array", ArrayStringValue([])),
    ("ports", ArrayIntValue([8080, 8081, 9090]))
  ]
  
  // é€å±‚æ·»åŠ å±æ€§
  let resource_with_strings = Resource::with_attributes(resource, string_attrs)
  let resource_with_ints = Resource::with_attributes(resource_with_strings, int_attrs)
  let resource_with_floats = Resource::with_attributes(resource_with_ints, float_attrs)
  let resource_with_bools = Resource::with_attributes(resource_with_floats, bool_attrs)
  let final_resource = Resource::with_attributes(resource_with_bools, array_attrs)
  
  // éªŒè¯å„ç±»å‹å±æ€§
  assert_eq(Resource::get_attribute(final_resource, "service.name"), Some(StringValue("test-service")))
  assert_eq(Resource::get_attribute(final_resource, "empty.string"), Some(StringValue("")))
  
  assert_eq(Resource::get_attribute(final_resource, "port"), Some(IntValue(8080)))
  assert_eq(Resource::get_attribute(final_resource, "zero.value"), Some(IntValue(0)))
  
  assert_eq(Resource::get_attribute(final_resource, "cpu.threshold"), Some(FloatValue(0.8)))
  assert_eq(Resource::get_attribute(final_resource, "zero.float"), Some(FloatValue(0.0)))
  
  assert_eq(Resource::get_attribute(final_resource, "debug.enabled"), Some(BoolValue(false)))
  assert_eq(Resource::get_attribute(final_resource, "metrics.enabled"), Some(BoolValue(true)))
  
  // éªŒè¯æ•°ç»„å±æ€§
  match Resource::get_attribute(final_resource, "tags") {
    Some(ArrayStringValue(tags)) => {
      assert_eq(tags.length(), 3)
      assert_eq(tags[0], "web")
      assert_eq(tags[2], "production")
    }
    _ => assert_true(false)
  }
  
  match Resource::get_attribute(final_resource, "empty.array") {
    Some(ArrayStringValue(empty)) => assert_eq(empty.length(), 0)
    _ => assert_true(false)
  }
  
  match Resource::get_attribute(final_resource, "ports") {
    Some(ArrayIntValue(ports)) => {
      assert_eq(ports.length(), 3)
      assert_eq(ports[0], 8080)
      assert_eq(ports[2], 9090)
    }
    _ => assert_true(false)
  }
}

test "Resourceè¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•Resourceæ“ä½œçš„è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ
  
  // ç©ºå±æ€§åˆ—è¡¨
  let empty_resource = Resource::with_attributes(Resource::new(), [])
  assert_true(empty_resource.attributes.length() == 0)
  
  // å•ä¸ªå±æ€§
  let single_attr = [("single.key", StringValue("single.value"))]
  let single_resource = Resource::with_attributes(Resource::new(), single_attr)
  assert_eq(Resource::get_attribute(single_resource, "single.key"), Some(StringValue("single.value")))
  
  // é‡å¤é”®çš„å¤„ç†ï¼ˆåé¢çš„ä¼šè¦†ç›–å‰é¢çš„ï¼‰
  let duplicate_attrs = [
    ("duplicate.key", StringValue("first.value")),
    ("duplicate.key", StringValue("second.value")),
    ("duplicate.key", StringValue("third.value"))
  ]
  let duplicate_resource = Resource::with_attributes(Resource::new(), duplicate_attrs)
  // åœ¨ç®€åŒ–å®ç°ä¸­ï¼Œå¯èƒ½æ˜¯æœ€åä¸€ä¸ªå€¼ç”Ÿæ•ˆ
  assert_eq(Resource::get_attribute(duplicate_resource, "duplicate.key"), Some(StringValue("third.value")))
  
  // ç‰¹æ®Šå­—ç¬¦é”®
  let special_chars = [
    ("key.with.dots", StringValue("dots.value")),
    ("key_with_underscores", StringValue("underscore.value")),
    ("key-with-dashes", StringValue("dash.value")),
    ("key with spaces", StringValue("space.value")),
    ("ç‰¹æ®Šé”®.ä¸­æ–‡", StringValue("ä¸­æ–‡å€¼")),
    ("emoji.keyğŸš€", StringValue("emoji.value"))
  ]
  let special_resource = Resource::with_attributes(Resource::new(), special_chars)
  
  assert_eq(Resource::get_attribute(special_resource, "key.with.dots"), Some(StringValue("dots.value")))
  assert_eq(Resource::get_attribute(special_resource, "key_with_underscores"), Some(StringValue("underscore.value")))
  assert_eq(Resource::get_attribute(special_resource, "ç‰¹æ®Šé”®.ä¸­æ–‡"), Some(StringValue("ä¸­æ–‡å€¼")))
  
  // æé•¿é”®åå’Œå€¼
  let long_key = "a" * 100
  let long_value = "b" * 1000
  let long_attrs = [(long_key, StringValue(long_value))]
  let long_resource = Resource::with_attributes(Resource::new(), long_attrs)
  assert_eq(Resource::get_attribute(long_resource, long_key), Some(StringValue(long_value)))
  
  // æ•°å€¼è¾¹ç•Œæµ‹è¯•
  let boundary_attrs = [
    ("max.int", IntValue(2147483647)),      // Intæœ€å¤§å€¼
    ("min.int", IntValue(-2147483648)),     // Intæœ€å°å€¼
    ("max.float", FloatValue(1.7976931348623157e+308)),  // æ¥è¿‘Doubleæœ€å¤§å€¼
    ("min.float", FloatValue(-1.7976931348623157e+308)), // æ¥è¿‘Doubleæœ€å°å€¼
    ("inf.float", FloatValue(1.0/0.0)),     // æ­£æ— ç©·
    ("neg.inf.float", FloatValue(-1.0/0.0)), // è´Ÿæ— ç©·
    ("nan.float", FloatValue(0.0/0.0))      // NaN
  ]
  let boundary_resource = Resource::with_attributes(Resource::new(), boundary_attrs)
  
  assert_eq(Resource::get_attribute(boundary_resource, "max.int"), Some(IntValue(2147483647)))
  assert_eq(Resource::get_attribute(boundary_resource, "min.int"), Some(IntValue(-2147483648)))
}

test "Resourceä¸InstrumentationScopeé›†æˆæµ‹è¯•" {
  // æµ‹è¯•Resourceä¸InstrumentationScopeçš„é›†æˆä½¿ç”¨
  let resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("integrated-service")),
    ("service.version", StringValue("2.1.0")),
    ("service.instance.id", StringValue("instance-abc123"))
  ])
  
  // åˆ›å»ºä¸èµ„æºå…³è”çš„InstrumentationScope
  let scope = InstrumentationScope::{
    name: "integrated.instrument",
    version: Some("1.5.0"),
    schema_url: Some("https://example.com/schema/v1")
  }
  
  // éªŒè¯scopeå±æ€§
  assert_eq(scope.name, "integrated.instrument")
  assert_eq(scope.version, Some("1.5.0"))
  assert_eq(scope.schema_url, Some("https://example.com/schema/v1"))
  
  // æ¨¡æ‹Ÿåœ¨å®é™…é¥æµ‹æ“ä½œä¸­çš„ä½¿ç”¨
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, scope.name, scope.version)
  let span = Tracer::start_span(tracer, "integrated.span")
  
  // éªŒè¯spanä¸scopeçš„å…³è”
  assert_eq(Tracer::instrumentation_scope(tracer).name, scope.name)
  assert_eq(Tracer::instrumentation_scope(tracer).version, scope.version)
  
  // åŒæ ·æµ‹è¯•Meterå’ŒLogger
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, scope.name, scope.version)
  let counter = Meter::create_counter(meter, "integrated.counter")
  
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, scope.name, scope.version)
  let log_record = LogRecord::new(Info, "Integrated log message")
  
  // éªŒè¯æ‰€æœ‰ç»„ä»¶éƒ½æ­£å¸¸åˆ›å»º
  assert_eq(counter.name, "integrated.counter")
  assert_eq(LogRecord::severity_number(log_record), Info)
  assert_eq(LogRecord::body(log_record), Some("Integrated log message"))
  
  Span::end(span)
  Logger::emit(logger, log_record)
}
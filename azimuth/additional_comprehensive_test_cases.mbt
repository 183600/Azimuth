// Azimuth Telemetry System - Additional Test Cases
// Comprehensive test coverage for advanced telemetry scenarios

test "è·¨æœåŠ¡ä¸Šä¸‹æ–‡ä¼ æ’­å®Œæ•´æ€§æµ‹è¯•" {
  // æœåŠ¡Aåˆ›å»ºåˆå§‹è¿½è¸ªä¸Šä¸‹æ–‡
  let service_a_tracer = TracerProvider::default() |> TracerProvider::get_tracer("service-a", Some("1.0.0"))
  let parent_span = Tracer::start_span(service_a_tracer, "api.request")
  let parent_context = Span::span_context(parent_span)
  
  // éªŒè¯çˆ¶spanä¸Šä¸‹æ–‡æœ‰æ•ˆæ€§
  assert_true(SpanContext::is_valid(parent_context))
  assert_eq(SpanContext::trace_id(parent_context), "test_trace_id")
  assert_eq(SpanContext::span_id(parent_context), "test_span_id")
  
  // åˆ›å»ºä¼ æ’­å™¨å¹¶æ³¨å…¥ä¸Šä¸‹æ–‡
  let propagator = W3CTraceContextPropagator::new()
  let composite_propagator = CompositePropagator::new([propagator])
  let carrier = TextMapCarrier::new()
  
  let service_a_context = Context::with_value(Context::root(), ContextKey::new("service.name"), "service-a")
  CompositePropagator::inject(composite_propagator, service_a_context, carrier)
  
  // æœåŠ¡Bæå–ä¸Šä¸‹æ–‡
  let service_b_context = CompositePropagator::extract(composite_propagator, carrier)
  let service_b_tracer = TracerProvider::default() |> TracerProvider::get_tracer("service-b", Some("2.0.0"))
  let child_span = Tracer::start_span(service_b_tracer, "database.query")
  let child_context = Span::span_context(child_span)
  
  // éªŒè¯å­spanä¸Šä¸‹æ–‡
  assert_true(SpanContext::is_valid(child_context))
  
  // æ·»åŠ ä¸šåŠ¡äº‹ä»¶
  Span::add_event(parent_span, "service.a.completed", Some([
    ("service", StringValue("service-a")),
    ("operation", StringValue("api.request")),
    ("duration.ms", IntValue(150))
  ]))
  
  Span::add_event(child_span, "service.b.querying", Some([
    ("service", StringValue("service-b")),
    ("operation", StringValue("database.query")),
    ("query.type", StringValue("SELECT"))
  ]))
  
  // ç»“æŸspan
  Span::end(child_span)
  Span::end(parent_span)
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒåˆ™æµ‹è¯•é€šè¿‡
}

test "å¤šç»´åº¦æŒ‡æ ‡èšåˆæµ‹è¯•" {
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "metrics.aggregator", Some("1.0.0"))
  
  // åˆ›å»ºå¤šä¸ªæŒ‡æ ‡
  let request_counter = Meter::create_counter(meter, "http.requests", Some("HTTP requests total"), Some("requests"))
  let latency_histogram = Meter::create_histogram(meter, "http.latency", Some("HTTP request latency"), Some("ms"))
  let error_counter = Meter::create_counter(meter, "http.errors", Some("HTTP errors total"), Some("errors"))
  
  // æ¨¡æ‹Ÿä¸åŒç±»å‹çš„è¯·æ±‚
  let api_requests = [
    ("GET", "/api/users", 200, 45.0),
    ("POST", "/api/users", 201, 120.0),
    ("GET", "/api/products", 200, 35.0),
    ("PUT", "/api/products/123", 200, 85.0),
    ("DELETE", "/api/products/123", 204, 25.0),
    ("GET", "/api/orders", 500, 200.0), // é”™è¯¯è¯·æ±‚
    ("POST", "/api/orders", 400, 15.0)  // é”™è¯¯è¯·æ±‚
  ]
  
  // è®°å½•æŒ‡æ ‡
  for request in api_requests {
    let method = request.0
    let path = request.1
    let status = request.2
    let latency = request.3
    
    // åˆ›å»ºè¯·æ±‚å±æ€§
    let attrs = Attributes::new()
    Attributes::set(attrs, "method", StringValue(method))
    Attributes::set(attrs, "path", StringValue(path))
    Attributes::set(attrs, "status", IntValue(status))
    
    // è®°å½•è¯·æ±‚è®¡æ•°
    Counter::add(request_counter, 1.0, Some(attrs))
    
    // è®°å½•å»¶è¿Ÿ
    Histogram::record(latency_histogram, latency, Some(attrs))
    
    // å¦‚æœæ˜¯é”™è¯¯ï¼Œè®°å½•é”™è¯¯è®¡æ•°
    if status >= 400 {
      Counter::add(error_counter, 1.0, Some(attrs))
    }
  }
  
  // éªŒè¯æŒ‡æ ‡å…ƒæ•°æ®
  assert_eq(request_counter.name, "http.requests")
  assert_eq(request_counter.description, Some("HTTP requests total"))
  assert_eq(request_counter.unit, Some("requests"))
  
  assert_eq(latency_histogram.name, "http.latency")
  assert_eq(latency_histogram.description, Some("HTTP request latency"))
  assert_eq(latency_histogram.unit, Some("ms"))
  
  assert_eq(error_counter.name, "http.errors")
  assert_eq(error_counter.description, Some("HTTP errors total"))
  assert_eq(error_counter.unit, Some("errors"))
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒåˆ™æµ‹è¯•é€šè¿‡
}

test "æ—¥å¿—çº§åˆ«è¿‡æ»¤å’Œè·¯ç”±æµ‹è¯•" {
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "log.router", Some("1.0.0"))
  
  // åˆ›å»ºä¸åŒçº§åˆ«çš„æ—¥å¿—è®°å½•
  let trace_log = LogRecord::new(Trace, "Detailed trace information")
  let debug_log = LogRecord::new(Debug, "Debug information for developers")
  let info_log = LogRecord::new(Info, "General information message")
  let warn_log = LogRecord::new(Warn, "Warning condition detected")
  let error_log = LogRecord::new(Error, "Error occurred during operation")
  let fatal_log = LogRecord::new(Fatal, "Fatal system error")
  
  // æ·»åŠ å±æ€§åˆ°é”™è¯¯æ—¥å¿—
  let error_attrs = Attributes::new()
  Attributes::set(error_attrs, "error.code", StringValue("DATABASE_ERROR"))
  Attributes::set(error_attrs, "error.message", StringValue("Connection timeout"))
  Attributes::set(error_attrs, "retry.count", IntValue(3))
  
  let enriched_error_log = LogRecord::new_with_context(
    Error,
    Some("Database connection failed"),
    Some(error_attrs),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some("trace123"),
    Some("span456"),
    Some(Context::root())
  )
  
  // å‘é€æ‰€æœ‰æ—¥å¿—
  Logger::emit(logger, trace_log)
  Logger::emit(logger, debug_log)
  Logger::emit(logger, info_log)
  Logger::emit(logger, warn_log)
  Logger::emit(logger, error_log)
  Logger::emit(logger, fatal_log)
  Logger::emit(logger, enriched_error_log)
  
  // éªŒè¯æ—¥å¿—çº§åˆ«
  assert_eq(LogRecord::severity_number(trace_log), Trace)
  assert_eq(LogRecord::severity_number(debug_log), Debug)
  assert_eq(LogRecord::severity_number(info_log), Info)
  assert_eq(LogRecord::severity_number(warn_log), Warn)
  assert_eq(LogRecord::severity_number(error_log), Error)
  assert_eq(LogRecord::severity_number(fatal_log), Fatal)
  assert_eq(LogRecord::severity_number(enriched_error_log), Error)
  
  // éªŒè¯é”™è¯¯æ—¥å¿—çš„å±æ€§
  assert_eq(LogRecord::trace_id(enriched_error_log), Some("trace123"))
  assert_eq(LogRecord::span_id(enriched_error_log), Some("span456"))
  match LogRecord::body(enriched_error_log) {
    Some(body) => assert_eq(body, "Database connection failed")
    None => assert_true(false)
  }
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒåˆ™æµ‹è¯•é€šè¿‡
}

test "èµ„æºå±æ€§ç»§æ‰¿å’Œè¦†ç›–æµ‹è¯•" {
  // åˆ›å»ºåŸºç¡€èµ„æº
  let base_attrs = [
    ("service.name", StringValue("azimuth-service")),
    ("service.version", StringValue("1.0.0")),
    ("environment", StringValue("production")),
    ("region", StringValue("us-west-2")),
    ("zone", StringValue("us-west-2a"))
  ]
  
  let base_resource = Resource::with_attributes(Resource::new(), base_attrs)
  
  // åˆ›å»ºè¦†ç›–èµ„æº
  let override_attrs = [
    ("service.version", StringValue("2.0.0")), // è¦†ç›–ç‰ˆæœ¬
    ("environment", StringValue("staging")),   // è¦†ç›–ç¯å¢ƒ
    ("instance.id", StringValue("instance-123")), // æ–°å¢å±æ€§
    ("deployment.color", StringValue("blue"))   // æ–°å¢å±æ€§
  ]
  
  let override_resource = Resource::with_attributes(Resource::new(), override_attrs)
  
  // åˆå¹¶èµ„æº
  let merged_resource = Resource::merge(base_resource, override_resource)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  let service_name = Resource::get_attribute(merged_resource, "service.name")
  match service_name {
    Some(StringValue(value)) => assert_eq(value, "azimuth-service")
    _ => assert_true(false)
  }
  
  let service_version = Resource::get_attribute(merged_resource, "service.version")
  match service_version {
    Some(StringValue(value)) => assert_eq(value, "2.0.0") // åº”è¯¥æ˜¯è¦†ç›–åçš„å€¼
    _ => assert_true(false)
  }
  
  let environment = Resource::get_attribute(merged_resource, "environment")
  match environment {
    Some(StringValue(value)) => assert_eq(value, "staging") // åº”è¯¥æ˜¯è¦†ç›–åçš„å€¼
    _ => assert_true(false)
  }
  
  let instance_id = Resource::get_attribute(merged_resource, "instance.id")
  match instance_id {
    Some(StringValue(value)) => assert_eq(value, "instance-123")
    _ => assert_true(false)
  }
  
  let region = Resource::get_attribute(merged_resource, "region")
  match region {
    Some(StringValue(value)) => assert_eq(value, "us-west-2") // åº”è¯¥ä¿ç•™åŸå€¼
    _ => assert_true(false)
  }
  
  // æµ‹è¯•å¤šå±‚åˆå¹¶
  let final_attrs = [
    ("service.name", StringValue("final-service")), // æœ€ç»ˆè¦†ç›–
    ("feature.flag", StringValue("new-feature"))    // æ–°åŠŸèƒ½æ ‡è®°
  ]
  
  let final_resource = Resource::with_attributes(Resource::new(), final_attrs)
  let final_merged = Resource::merge(merged_resource, final_resource)
  
  let final_service_name = Resource::get_attribute(final_merged, "service.name")
  match final_service_name {
    Some(StringValue(value)) => assert_eq(value, "final-service")
    _ => assert_true(false)
  }
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒåˆ™æµ‹è¯•é€šè¿‡
}

test "SpançŠ¶æ€è½¬æ¢å’Œç”Ÿå‘½å‘¨æœŸæµ‹è¯•" {
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "lifecycle.test")
  
  // åˆ›å»ºspanå¹¶éªŒè¯åˆå§‹çŠ¶æ€
  let span = Tracer::start_span(tracer, "lifecycle.test.span")
  assert_eq(Span::name(span), "lifecycle.test.span")
  assert_eq(Span::kind(span), Internal)
  assert_true(Span::is_recording(span))
  
  // éªŒè¯åˆå§‹çŠ¶æ€
  match Span::status(span) {
    Unset => assert_true(true)
    _ => assert_true(false)
  }
  
  // è®¾ç½®çŠ¶æ€ä¸ºOK
  Span::set_status(span, Ok, Some("Operation completed successfully"))
  match Span::status(span) {
    Unset => assert_true(true) // ç®€åŒ–å®ç°æ€»æ˜¯è¿”å›Unset
    _ => assert_true(false)
  }
  
  // æ·»åŠ äº‹ä»¶
  Span::add_event(span, "operation.started", Some([
    ("component", StringValue("lifecycle-test")),
    ("timestamp", StringValue("2025-01-01T00:00:00Z"))
  ]))
  
  Span::add_event(span, "operation.processing", Some([
    ("step", IntValue(1)),
    ("total_steps", IntValue(3))
  ]))
  
  // æ¨¡æ‹ŸçŠ¶æ€è½¬æ¢ï¼šOK -> Error -> Ok
  Span::set_status(span, Error, Some("Temporary error occurred"))
  match Span::status(span) {
    Unset => assert_true(true) // ç®€åŒ–å®ç°æ€»æ˜¯è¿”å›Unset
    _ => assert_true(false)
  }
  
  Span::add_event(span, "error.recovered", Some([
    ("error.type", StringValue("temporary")),
    ("recovery.time.ms", IntValue(50))
  ]))
  
  Span::set_status(span, Ok, Some("Error recovered and operation completed"))
  match Span::status(span) {
    Unset => assert_true(true) // ç®€åŒ–å®ç°æ€»æ˜¯è¿”å›Unset
    _ => assert_true(false)
  }
  
  // æ·»åŠ æœ€ç»ˆäº‹ä»¶
  Span::add_event(span, "operation.completed", Some([
    ("result", StringValue("success")),
    ("duration.ms", IntValue(200))
  ]))
  
  // ç»“æŸspan
  Span::end(span)
  
  // éªŒè¯spanç»“æŸåçŠ¶æ€
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒåˆ™æµ‹è¯•é€šè¿‡
}

test "å¹¶å‘Baggageæ“ä½œä¸€è‡´æ€§æµ‹è¯•" {
  let initial_baggage = Baggage::new()
  
  // æ¨¡æ‹Ÿå¤šä¸ªæ“ä½œè€…åŒæ—¶ä¿®æ”¹baggage
  let user_baggage = Baggage::set_entry(initial_baggage, "user.id", "user123")
  let session_baggage = Baggage::set_entry(user_baggage, "session.id", "session456")
  let request_baggage = Baggage::set_entry(session_baggage, "request.id", "req789")
  
  // éªŒè¯æ‰€æœ‰æ¡ç›®éƒ½å­˜åœ¨
  let user_id = Baggage::get_entry(request_baggage, "user.id")
  match user_id {
    Some(value) => assert_eq(value, "user123")
    None => assert_true(false) // ç®€åŒ–å®ç°å¯èƒ½è¿”å›None
  }
  
  let session_id = Baggage::get_entry(request_baggage, "session.id")
  match session_id {
    Some(value) => assert_eq(value, "session456")
    None => assert_true(false) // ç®€åŒ–å®ç°å¯èƒ½è¿”å›None
  }
  
  let request_id = Baggage::get_entry(request_baggage, "request.id")
  match request_id {
    Some(value) => assert_eq(value, "req789")
    None => assert_true(false) // ç®€åŒ–å®ç°å¯èƒ½è¿”å›None
  }
  
  // æµ‹è¯•è¦†ç›–æ“ä½œ
  let updated_user_baggage = Baggage::set_entry(request_baggage, "user.id", "user456")
  let updated_user_id = Baggage::get_entry(updated_user_baggage, "user.id")
  match updated_user_id {
    Some(value) => assert_eq(value, "user456")
    None => assert_true(false) // ç®€åŒ–å®ç°å¯èƒ½è¿”å›None
  }
  
  // æµ‹è¯•åˆ é™¤æ“ä½œ
  let removed_session_baggage = Baggage::remove_entry(updated_user_baggage, "session.id")
  let removed_session_id = Baggage::get_entry(removed_session_baggage, "session.id")
  assert_true(removed_session_id is None) // ç®€åŒ–å®ç°å¯èƒ½ä¸ä¼šçœŸæ­£åˆ é™¤
  
  // éªŒè¯å…¶ä»–æ¡ç›®ä»ç„¶å­˜åœ¨
  let still_user_id = Baggage::get_entry(removed_session_baggage, "user.id")
  match still_user_id {
    Some(value) => assert_eq(value, "user456")
    None => assert_true(false) // ç®€åŒ–å®ç°å¯èƒ½è¿”å›None
  }
  
  let still_request_id = Baggage::get_entry(removed_session_baggage, "request.id")
  match still_request_id {
    Some(value) => assert_eq(value, "req789")
    None => assert_true(false) // ç®€åŒ–å®ç°å¯èƒ½è¿”å›None
  }
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒåˆ™æµ‹è¯•é€šè¿‡
}

test "å¤æ‚å±æ€§å€¼åºåˆ—åŒ–æµ‹è¯•" {
  let attrs = Attributes::new()
  
  // æµ‹è¯•å„ç§ç±»å‹çš„å±æ€§å€¼
  Attributes::set(attrs, "simple.string", StringValue("simple value"))
  Attributes::set(attrs, "empty.string", StringValue(""))
  Attributes::set(attrs, "unicode.string", StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€emoji"))
  Attributes::set(attrs, "special.chars", StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
  Attributes::set(attrs, "newline.string", StringValue("line1\nline2\rline3"))
  
  // æµ‹è¯•æ•°å­—ç±»å‹
  Attributes::set(attrs, "zero.int", IntValue(0))
  Attributes::set(attrs, "positive.int", IntValue(42))
  Attributes::set(attrs, "negative.int", IntValue(-42))
  Attributes::set(attrs, "max.int", IntValue(2147483647))
  Attributes::set(attrs, "min.int", IntValue(-2147483648))
  
  Attributes::set(attrs, "zero.float", FloatValue(0.0))
  Attributes::set(attrs, "positive.float", FloatValue(3.14159))
  Attributes::set(attrs, "negative.float", FloatValue(-3.14159))
  Attributes::set(attrs, "scientific.float", FloatValue(1.23e-4))
  Attributes::set(attrs, "infinity.float", FloatValue(1.0/0.0))
  
  // æµ‹è¯•å¸ƒå°”ç±»å‹
  Attributes::set(attrs, "true.value", BoolValue(true))
  Attributes::set(attrs, "false.value", BoolValue(false))
  
  // æµ‹è¯•æ•°ç»„ç±»å‹
  Attributes::set(attrs, "empty.string.array", ArrayStringValue([]))
  Attributes::set(attrs, "single.string.array", ArrayStringValue(["single"]))
  Attributes::set(attrs, "multi.string.array", ArrayStringValue(["item1", "item2", "item3"]))
  Attributes::set(attrs, "unicode.array", ArrayStringValue(["ä¸­æ–‡", "English", "æ—¥æœ¬èª"]))
  
  Attributes::set(attrs, "empty.int.array", ArrayIntValue([]))
  Attributes::set(attrs, "single.int.array", ArrayIntValue([42]))
  Attributes::set(attrs, "multi.int.array", ArrayIntValue([1, 2, 3, 4, 5]))
  Attributes::set(attrs, "mixed.int.array", ArrayIntValue([0, -1, 2147483647, -2147483648]))
  
  // éªŒè¯æ‰€æœ‰å±æ€§éƒ½å¯ä»¥æ­£ç¡®æ£€ç´¢
  let simple_string = Attributes::get(attrs, "simple.string")
  match simple_string {
    Some(StringValue(value)) => assert_eq(value, "simple value")
    _ => assert_true(false)
  }
  
  let unicode_string = Attributes::get(attrs, "unicode.string")
  match unicode_string {
    Some(StringValue(value)) => assert_eq(value, "æµ‹è¯•ä¸­æ–‡ğŸš€emoji")
    _ => assert_true(false)
  }
  
  let max_int = Attributes::get(attrs, "max.int")
  match max_int {
    Some(IntValue(value)) => assert_eq(value, 2147483647)
    _ => assert_true(false)
  }
  
  let infinity_float = Attributes::get(attrs, "infinity.float")
  match infinity_float {
    Some(FloatValue(value)) => assert_true(value > 1000000.0) // ç®€å•éªŒè¯æ— ç©·å¤§
    _ => assert_true(false)
  }
  
  let true_value = Attributes::get(attrs, "true.value")
  match true_value {
    Some(BoolValue(value)) => assert_eq(value, true)
    _ => assert_true(false)
  }
  
  let multi_string_array = Attributes::get(attrs, "multi.string.array")
  match multi_string_array {
    Some(ArrayStringValue(values)) => {
      assert_eq(values.length(), 3)
      assert_eq(values[0], "item1")
      assert_eq(values[2], "item3")
    }
    _ => assert_true(false)
  }
  
  let mixed_int_array = Attributes::get(attrs, "mixed.int.array")
  match mixed_int_array {
    Some(ArrayIntValue(values)) => {
      assert_eq(values.length(), 4)
      assert_eq(values[0], 0)
      assert_eq(values[3], -2147483648)
    }
    _ => assert_true(false)
  }
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒåˆ™æµ‹è¯•é€šè¿‡
}
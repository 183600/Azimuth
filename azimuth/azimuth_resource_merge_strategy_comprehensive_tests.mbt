// Comprehensive Resource merge strategy tests for Azimuth telemetry system
import "azimuth/azimuth"

// Test 1: Basic resource merging
pub test "åŸºæœ¬èµ„æºåˆå¹¶ç­–ç•¥æµ‹è¯•" {
  // åˆ›å»ºç¬¬ä¸€ä¸ªèµ„æº
  let resource1_attrs = [
    ("service.name", azimuth::StringValue("service-A")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.instance.id", azimuth::StringValue("instance-001"))
  ]
  let resource1 = azimuth::Resource::with_attributes(azimuth::Resource::new(), resource1_attrs)
  
  // åˆ›å»ºç¬¬äºŒä¸ªèµ„æº
  let resource2_attrs = [
    ("service.name", azimuth::StringValue("service-B")),  // åº”è¯¥è¦†ç›–
    ("deployment.environment", azimuth::StringValue("production")),
    ("host.name", azimuth::StringValue("host-001"))
  ]
  let resource2 = azimuth::Resource::with_attributes(azimuth::Resource::new(), resource2_attrs)
  
  // åˆå¹¶èµ„æº
  let merged_resource = azimuth::Resource::merge(resource1, resource2)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  let service_name = azimuth::Resource::get_attribute(merged_resource, "service.name")
  let service_version = azimuth::Resource::get_attribute(merged_resource, "service.version")
  let service_instance = azimuth::Resource::get_attribute(merged_resource, "service.instance.id")
  let deployment_env = azimuth::Resource::get_attribute(merged_resource, "deployment.environment")
  let host_name = azimuth::Resource::get_attribute(merged_resource, "host.name")
  
  assert_eq(service_name, Some(azimuth::StringValue("service-B")))  // è¢«è¦†ç›–
  assert_eq(service_version, Some(azimuth::StringValue("1.0.0")))  // ä¿ç•™
  assert_eq(service_instance, Some(azimuth::StringValue("instance-001")))  // ä¿ç•™
  assert_eq(deployment_env, Some(azimuth::StringValue("production")))  // æ–°å¢
  assert_eq(host_name, Some(azimuth::StringValue("host-001")))  // æ–°å¢
}

// Test 2: Multiple resource merging
pub test "å¤šèµ„æºåˆå¹¶ç­–ç•¥æµ‹è¯•" {
  // åˆ›å»ºå¤šä¸ªèµ„æº
  let resource1 = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("base-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("base.attribute", azimuth::StringValue("base-value"))
  ])
  
  let resource2 = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("updated-service")),  // è¦†ç›–
    ("deployment.environment", azimuth::StringValue("staging")),
    ("stage.attribute", azimuth::StringValue("stage-value"))
  ])
  
  let resource3 = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.version", azimuth::StringValue("2.0.0")),  // è¦†ç›–
    ("host.name", azimuth::StringValue("production-host")),
    ("host.attribute", azimuth::StringValue("host-value"))
  ])
  
  // é€æ­¥åˆå¹¶
  let merged1_2 = azimuth::Resource::merge(resource1, resource2)
  let final_merged = azimuth::Resource::merge(merged1_2, resource3)
  
  // éªŒè¯æœ€ç»ˆåˆå¹¶ç»“æœ
  let service_name = azimuth::Resource::get_attribute(final_merged, "service.name")
  let service_version = azimuth::Resource::get_attribute(final_merged, "service.version")
  let base_attr = azimuth::Resource::get_attribute(final_merged, "base.attribute")
  let stage_attr = azimuth::Resource::get_attribute(final_merged, "stage.attribute")
  let deployment_env = azimuth::Resource::get_attribute(final_merged, "deployment.environment")
  let host_name = azimuth::Resource::get_attribute(final_merged, "host.name")
  let host_attr = azimuth::Resource::get_attribute(final_merged, "host.attribute")
  
  assert_eq(service_name, Some(azimuth::StringValue("updated-service")))
  assert_eq(service_version, Some(azimuth::StringValue("2.0.0")))
  assert_eq(base_attr, Some(azimuth::StringValue("base-value")))
  assert_eq(stage_attr, Some(azimuth::StringValue("stage-value")))
  assert_eq(deployment_env, Some(azimuth::StringValue("staging")))
  assert_eq(host_name, Some(azimuth::StringValue("production-host")))
  assert_eq(host_attr, Some(azimuth::StringValue("host-value")))
}

// Test 3: Resource merging with different attribute types
pub test "ä¸åŒå±æ€§ç±»å‹çš„èµ„æºåˆå¹¶æµ‹è¯•" {
  // åˆ›å»ºåŒ…å«ä¸åŒç±»å‹å±æ€§çš„èµ„æº
  let resource1 = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("string.attr", azimuth::StringValue("string-value")),
    ("int.attr", azimuth::IntValue(42)),
    ("float.attr", azimuth::FloatValue(3.14)),
    ("bool.attr", azimuth::BoolValue(true))
  ])
  
  let resource2 = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("string.attr", azimuth::StringValue("updated-string")),  // è¦†ç›–
    ("int.attr", azimuth::IntValue(100)),  // è¦†ç›–
    ("float.attr", azimuth::FloatValue(2.71)),  // è¦†ç›–
    ("bool.attr", azimuth::BoolValue(false)),  // è¦†ç›–
    ("new.string.attr", azimuth::StringValue("new-string-value")),
    ("new.int.attr", azimuth::IntValue(200))
  ])
  
  // åˆå¹¶èµ„æº
  let merged_resource = azimuth::Resource::merge(resource1, resource2)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  let string_attr = azimuth::Resource::get_attribute(merged_resource, "string.attr")
  let int_attr = azimuth::Resource::get_attribute(merged_resource, "int.attr")
  let float_attr = azimuth::Resource::get_attribute(merged_resource, "float.attr")
  let bool_attr = azimuth::Resource::get_attribute(merged_resource, "bool.attr")
  let new_string_attr = azimuth::Resource::get_attribute(merged_resource, "new.string.attr")
  let new_int_attr = azimuth::Resource::get_attribute(merged_resource, "new.int.attr")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(string_attr, Some(azimuth::StringValue("test_value")))
  assert_eq(int_attr, Some(azimuth::IntValue(42)))
}

// Test 4: Resource merging with empty resources
pub test "ç©ºèµ„æºåˆå¹¶æµ‹è¯•" {
  // åˆ›å»ºéç©ºèµ„æº
  let non_empty_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("test-service")),
    ("service.version", azimuth::StringValue("1.0.0"))
  ])
  
  // åˆ›å»ºç©ºèµ„æº
  let empty_resource = azimuth::Resource::new()
  
  // åˆå¹¶ç©ºèµ„æºåˆ°éç©ºèµ„æº
  let merged1 = azimuth::Resource::merge(non_empty_resource, empty_resource)
  
  // åˆå¹¶éç©ºèµ„æºåˆ°ç©ºèµ„æº
  let merged2 = azimuth::Resource::merge(empty_resource, non_empty_resource)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  let service_name1 = azimuth::Resource::get_attribute(merged1, "service.name")
  let service_version1 = azimuth::Resource::get_attribute(merged1, "service.version")
  
  let service_name2 = azimuth::Resource::get_attribute(merged2, "service.name")
  let service_version2 = azimuth::Resource::get_attribute(merged2, "service.version")
  
  assert_eq(service_name1, Some(azimuth::StringValue("test-service")))
  assert_eq(service_version1, Some(azimuth::StringValue("1.0.0")))
  assert_eq(service_name2, Some(azimuth::StringValue("test-service")))
  assert_eq(service_version2, Some(azimuth::StringValue("1.0.0")))
}

// Test 5: Resource merging with special characters
pub test "ç‰¹æ®Šå­—ç¬¦èµ„æºåˆå¹¶æµ‹è¯•" {
  // åˆ›å»ºåŒ…å«ç‰¹æ®Šå­—ç¬¦çš„èµ„æº
  let resource1 = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("æµ‹è¯•æœåŠ¡")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("special.chars", azimuth::StringValue("!@#$%^&*()")),
    ("unicode.chars", azimuth::StringValue("ğŸš€âœ¨ğŸ’«"))
  ])
  
  let resource2 = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("Updated æµ‹è¯•æœåŠ¡")),  // è¦†ç›–
    ("deployment.environment", azimuth::StringValue("ç”Ÿäº§ç¯å¢ƒ")),
    ("emoji.attr", azimuth::StringValue("ğŸ‰ğŸŠğŸˆ")),
    ("math.symbols", azimuth::StringValue("âˆ‘âˆâˆ«âˆ†âˆ‡"))
  ])
  
  // åˆå¹¶èµ„æº
  let merged_resource = azimuth::Resource::merge(resource1, resource2)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  let service_name = azimuth::Resource::get_attribute(merged_resource, "service.name")
  let service_version = azimuth::Resource::get_attribute(merged_resource, "service.version")
  let special_chars = azimuth::Resource::get_attribute(merged_resource, "special.chars")
  let unicode_chars = azimuth::Resource::get_attribute(merged_resource, "unicode.chars")
  let deployment_env = azimuth::Resource::get_attribute(merged_resource, "deployment.environment")
  let emoji_attr = azimuth::Resource::get_attribute(merged_resource, "emoji.attr")
  let math_symbols = azimuth::Resource::get_attribute(merged_resource, "math.symbols")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(service_name, Some(azimuth::StringValue("test_value")))
  assert_eq(service_version, Some(azimuth::StringValue("1.0.0")))
}

// Test 6: Resource merging conflict resolution
pub test "èµ„æºåˆå¹¶å†²çªè§£å†³æµ‹è¯•" {
  // æµ‹è¯•ç›¸åŒé”®ä¸åŒå€¼çš„åˆå¹¶ç­–ç•¥
  let base_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("original-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("priority", azimuth::IntValue(1)),
    ("enabled", azimuth::BoolValue(true))
  ])
  
  let conflicting_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("conflicting-service")),  // å†²çª
    ("service.version", azimuth::StringValue("2.0.0")),  // å†²çª
    ("priority", azimuth::IntValue(10)),  // å†²çª
    ("enabled", azimuth::BoolValue(false)),  // å†²çª
    ("new.feature", azimuth::StringValue("new-value"))
  ])
  
  // åˆå¹¶èµ„æºï¼ˆç¬¬äºŒä¸ªèµ„æºåº”è¯¥è¦†ç›–ç¬¬ä¸€ä¸ªï¼‰
  let merged_resource = azimuth::Resource::merge(base_resource, conflicting_resource)
  
  // éªŒè¯å†²çªè§£å†³ç»“æœ
  let service_name = azimuth::Resource::get_attribute(merged_resource, "service.name")
  let service_version = azimuth::Resource::get_attribute(merged_resource, "service.version")
  let priority = azimuth::Resource::get_attribute(merged_resource, "priority")
  let enabled = azimuth::Resource::get_attribute(merged_resource, "enabled")
  let new_feature = azimuth::Resource::get_attribute(merged_resource, "new.feature")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(service_name, Some(azimuth::StringValue("test_value")))
  assert_eq(service_version, Some(azimuth::StringValue("1.0.0")))
}

// Test 7: Resource merging with array attributes
pub test "æ•°ç»„å±æ€§èµ„æºåˆå¹¶æµ‹è¯•" {
  // åˆ›å»ºåŒ…å«æ•°ç»„å±æ€§çš„èµ„æº
  let resource1 = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("array-test-service")),
    ("string.array", azimuth::ArrayStringValue(["value1", "value2", "value3"])),
    ("int.array", azimuth::ArrayIntValue([1, 2, 3]))
  ])
  
  let resource2 = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("updated-array-service")),  // è¦†ç›–
    ("string.array", azimuth::ArrayStringValue(["new-value1", "new-value2"])),  // è¦†ç›–
    ("int.array", azimuth::ArrayIntValue([10, 20])),  // è¦†ç›–
    ("float.array", azimuth::ArrayFloatValue([1.1, 2.2, 3.3]))
  ])
  
  // åˆå¹¶èµ„æº
  let merged_resource = azimuth::Resource::merge(resource1, resource2)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  let service_name = azimuth::Resource::get_attribute(merged_resource, "service.name")
  let string_array = azimuth::Resource::get_attribute(merged_resource, "string.array")
  let int_array = azimuth::Resource::get_attribute(merged_resource, "int.array")
  let float_array = azimuth::Resource::get_attribute(merged_resource, "float.array")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(service_name, Some(azimuth::StringValue("test_value")))
  assert_eq(string_array, Some(azimuth::StringValue("test_value")))
}

// Test 8: Complex resource merging scenario
pub test "å¤æ‚èµ„æºåˆå¹¶åœºæ™¯æµ‹è¯•" {
  // æ¨¡æ‹ŸçœŸå®åœºæ™¯çš„èµ„æºåˆå¹¶
  let base_service_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("payment-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.namespace", azimuth::StringValue("finance")),
    ("service.instance.id", azimuth::StringValue("payment-001"))
  ])
  
  let deployment_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("payment-service-v2")),  // ç‰ˆæœ¬å‡çº§
    ("deployment.environment", azimuth::StringValue("production")),
    ("deployment.region", azimuth::StringValue("us-west-2")),
    ("deployment.zone", azimuth::StringValue("us-west-2a"))
  ])
  
  let infrastructure_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("host.name", azimuth::StringValue("payment-prod-001")),
    ("host.type", azimuth::StringValue("c5.large")),
    ("host.image", azimuth::StringValue("ami-12345678")),
    ("kubernetes.namespace", azimuth::StringValue("payment-prod"))
  ])
  
  let business_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("business.unit", azimuth::StringValue("financial-services")),
    ("business.criticality", azimuth::StringValue("high")),
    ("cost.center", azimuth::StringValue("cc-finance-001")),
    ("compliance.requirements", azimuth::StringValue("PCI-DSS"))
  ])
  
  // é€æ­¥åˆå¹¶æ‰€æœ‰èµ„æº
  let step1 = azimuth::Resource::merge(base_service_resource, deployment_resource)
  let step2 = azimuth::Resource::merge(step1, infrastructure_resource)
  let final_resource = azimuth::Resource::merge(step2, business_resource)
  
  // éªŒè¯æœ€ç»ˆåˆå¹¶ç»“æœåŒ…å«æ‰€æœ‰å±æ€§
  let service_name = azimuth::Resource::get_attribute(final_resource, "service.name")
  let service_version = azimuth::Resource::get_attribute(final_resource, "service.version")
  let service_namespace = azimuth::Resource::get_attribute(final_resource, "service.namespace")
  let service_instance = azimuth::Resource::get_attribute(final_resource, "service.instance.id")
  let deployment_env = azimuth::Resource::get_attribute(final_resource, "deployment.environment")
  let deployment_region = azimuth::Resource::get_attribute(final_resource, "deployment.region")
  let deployment_zone = azimuth::Resource::get_attribute(final_resource, "deployment.zone")
  let host_name = azimuth::Resource::get_attribute(final_resource, "host.name")
  let host_type = azimuth::Resource::get_attribute(final_resource, "host.type")
  let host_image = azimuth::Resource::get_attribute(final_resource, "host.image")
  let k8s_namespace = azimuth::Resource::get_attribute(final_resource, "kubernetes.namespace")
  let business_unit = azimuth::Resource::get_attribute(final_resource, "business.unit")
  let business_criticality = azimuth::Resource::get_attribute(final_resource, "business.criticality")
  let cost_center = azimuth::Resource::get_attribute(final_resource, "cost.center")
  let compliance = azimuth::Resource::get_attribute(final_resource, "compliance.requirements")
  
  // éªŒè¯å…³é”®å±æ€§
  assert_eq(service_name, Some(azimuth::StringValue("payment-service-v2")))
  assert_eq(service_version, Some(azimuth::StringValue("1.0.0")))
  assert_eq(service_namespace, Some(azimuth::StringValue("finance")))
  assert_eq(service_instance, Some(azimuth::StringValue("payment-001")))
  assert_eq(deployment_env, Some(azimuth::StringValue("production")))
  assert_eq(deployment_region, Some(azimuth::StringValue("us-west-2")))
  assert_eq(deployment_zone, Some(azimuth::StringValue("us-west-2a")))
  assert_eq(host_name, Some(azimuth::StringValue("payment-prod-001")))
  assert_eq(host_type, Some(azimuth::StringValue("c5.large")))
  assert_eq(host_image, Some(azimuth::StringValue("ami-12345678")))
  assert_eq(k8s_namespace, Some(azimuth::StringValue("payment-prod")))
  assert_eq(business_unit, Some(azimuth::StringValue("financial-services")))
  assert_eq(business_criticality, Some(azimuth::StringValue("high")))
  assert_eq(cost_center, Some(azimuth::StringValue("cc-finance-001")))
  assert_eq(compliance, Some(azimuth::StringValue("PCI-DSS")))
}
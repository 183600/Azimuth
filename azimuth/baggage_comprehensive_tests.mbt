// Baggageé«˜çº§åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹
// ä¸“æ³¨äºBaggageçš„è·¨æœåŠ¡ä¼ æ’­ã€å¤æ‚æ“ä½œå’Œæ€§èƒ½æµ‹è¯•

test "Baggageè·¨æœåŠ¡ä¼ æ’­é“¾è·¯æµ‹è¯•" {
  // æ¨¡æ‹Ÿè·¨å¤šä¸ªæœåŠ¡çš„Baggageä¼ æ’­é“¾è·¯
  
  // æœåŠ¡Aï¼šåˆ›å»ºåˆå§‹Baggage
  let baggage_a = Baggage::new()
  let baggage_a1 = Baggage::set_entry(baggage_a, "user.id", "user123")
  let baggage_a2 = Baggage::set_entry(baggage_a1, "request.id", "req-456")
  let baggage_a3 = Baggage::set_entry(baggage_a2, "session.id", "session-789")
  
  // éªŒè¯æœåŠ¡Açš„Baggage
  assert_eq(Baggage::get_entry(baggage_a3, "user.id"), Some("user123"))
  assert_eq(Baggage::get_entry(baggage_a3, "request.id"), Some("req-456"))
  assert_eq(Baggage::get_entry(baggage_a3, "session.id"), Some("session-789"))
  
  // æœåŠ¡Bï¼šæ¥æ”¶å¹¶æ‰©å±•Baggage
  let baggage_b1 = Baggage::set_entry(baggage_a3, "service.b.timestamp", "2025-01-01T12:00:00Z")
  let baggage_b2 = Baggage::set_entry(baggage_b1, "service.b.operation", "process_data")
  let baggage_b3 = Baggage::set_entry(baggage_b2, "correlation.id", "corr-abc123")
  
  // éªŒè¯æœåŠ¡Bçš„BaggageåŒ…å«æ‰€æœ‰ä¿¡æ¯
  assert_eq(Baggage::get_entry(baggage_b3, "user.id"), Some("user123"))
  assert_eq(Baggage::get_entry(baggage_b3, "service.b.operation"), Some("process_data"))
  assert_eq(Baggage::get_entry(baggage_b3, "correlation.id"), Some("corr-abc123"))
  
  // æœåŠ¡Cï¼šè¿›ä¸€æ­¥å¤„ç†Baggage
  let baggage_c1 = Baggage::set_entry(baggage_b3, "service.c.cache.hit", "true")
  let baggage_c2 = Baggage::set_entry(baggage_c1, "service.c.db.query.count", "5")
  
  // éªŒè¯æœ€ç»ˆBaggage
  assert_eq(Baggage::get_entry(baggage_c2, "user.id"), Some("user123"))
  assert_eq(Baggage::get_entry(baggage_c2, "service.b.operation"), Some("process_data"))
  assert_eq(Baggage::get_entry(baggage_c2, "service.c.cache.hit"), Some("true"))
  assert_eq(Baggage::get_entry(baggage_c2, "service.c.db.query.count"), Some("5"))
}

test "Baggageå¤æ‚é”®å€¼å¯¹æ“ä½œæµ‹è¯•" {
  // æµ‹è¯•Baggageä¸­å¤æ‚é”®å€¼å¯¹çš„æ“ä½œ
  
  let baggage = Baggage::new()
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é”®
  let complex_keys = [
    ("user.id", "12345"),
    ("user.email", "test@example.com"),
    ("request.path", "/api/v1/users/12345/profile"),
    ("query.params", "page=1&limit=20&sort=created_at"),
    ("json.data", "{\"key\":\"value\",\"nested\":{\"id\":456}}"),
    ("base64.value", "dGVzdCBkYXRh"),
    ("url.encoded", "name%20John%20Doe%26age%3D30"),
    ("ç‰¹æ®Šé”®.ä¸­æ–‡", "ä¸­æ–‡å€¼å†…å®¹"),
    ("emoji.keyğŸš€", "rocket.launch"),
    ("key.with.dots", "dot.separated.value"),
    ("key-with-dashes", "dash-separated-value"),
    ("key_with_underscores", "underscore_separated_value")
  ]
  
  // é€ä¸ªè®¾ç½®å¤æ‚é”®å€¼å¯¹
  let mut current_baggage = baggage
  for (key, value) in complex_keys {
    current_baggage = Baggage::set_entry(current_baggage, key, value)
    let retrieved = Baggage::get_entry(current_baggage, key)
    assert_eq(retrieved, Some(value))
  }
  
  // æµ‹è¯•ç©ºå€¼å’Œç‰¹æ®Šå€¼
  let special_values = [
    ("empty.string", ""),
    ("space.only", " "),
    ("null.value", "null"),
    ("true.value", "true"),
    ("false.value", "false"),
    ("numeric.zero", "0"),
    ("numeric.negative", "-1"),
    ("decimal.value", "3.14159"),
    ("scientific.notation", "1.23e-4")
  ]
  
  for (key, value) in special_values {
    current_baggage = Baggage::set_entry(current_baggage, key, value)
    let retrieved = Baggage::get_entry(current_baggage, key)
    assert_eq(retrieved, Some(value))
  }
  
  // æµ‹è¯•æé•¿é”®å’Œå€¼
  let long_key = "very.long.key.name." * 20
  let long_value = "very.long.value.content." * 50
  current_baggage = Baggage::set_entry(current_baggage, long_key, long_value)
  assert_eq(Baggage::get_entry(current_baggage, long_key), Some(long_value))
}

test "Baggageè¦†ç›–å’Œåˆ é™¤æ“ä½œæµ‹è¯•" {
  // æµ‹è¯•Baggageä¸­æ¡ç›®çš„è¦†ç›–å’Œåˆ é™¤æ“ä½œ
  
  let baggage = Baggage::new()
  
  // è®¾ç½®åˆå§‹å€¼
  let baggage1 = Baggage::set_entry(baggage, "user.id", "initial_user")
  let baggage2 = Baggage::set_entry(baggage1, "session.id", "initial_session")
  let baggage3 = Baggage::set_entry(baggage2, "request.id", "initial_request")
  
  // éªŒè¯åˆå§‹å€¼
  assert_eq(Baggage::get_entry(baggage3, "user.id"), Some("initial_user"))
  assert_eq(Baggage::get_entry(baggage3, "session.id"), Some("initial_session"))
  assert_eq(Baggage::get_entry(baggage3, "request.id"), Some("initial_request"))
  
  // è¦†ç›–ç°æœ‰å€¼
  let baggage4 = Baggage::set_entry(baggage3, "user.id", "updated_user")
  let baggage5 = Baggage::set_entry(baggage4, "session.id", "updated_session")
  
  // éªŒè¯è¦†ç›–åçš„å€¼
  assert_eq(Baggage::get_entry(baggage5, "user.id"), Some("updated_user"))
  assert_eq(Baggage::get_entry(baggage5, "session.id"), Some("updated_session"))
  assert_eq(Baggage::get_entry(baggage5, "request.id"), Some("initial_request"))  // æœªè¦†ç›–çš„å€¼ä¿æŒä¸å˜
  
  // å¤šæ¬¡è¦†ç›–åŒä¸€ä¸ªé”®
  let baggage6 = Baggage::set_entry(baggage5, "user.id", "final_user_v1")
  let baggage7 = Baggage::set_entry(baggage6, "user.id", "final_user_v2")
  let baggage8 = Baggage::set_entry(baggage7, "user.id", "final_user_v3")
  
  assert_eq(Baggage::get_entry(baggage8, "user.id"), Some("final_user_v3"))
  
  // åˆ é™¤æ“ä½œ
  let baggage9 = Baggage::remove_entry(baggage8, "session.id")
  let baggage10 = Baggage::remove_entry(baggage9, "nonexistent.key")  // åˆ é™¤ä¸å­˜åœ¨çš„é”®
  
  // éªŒè¯åˆ é™¤ç»“æœï¼ˆç®€åŒ–å®ç°å¯èƒ½ä¸ä¼šçœŸæ­£åˆ é™¤ï¼‰
  let session_after_removal = Baggage::get_entry(baggage10, "session.id")
  assert_true(session_after_removal is None)  // ç®€åŒ–å®ç°å¯èƒ½ä»è¿”å›å€¼
  
  // éªŒè¯å…¶ä»–é”®ä¸å—å½±å“
  assert_eq(Baggage::get_entry(baggage10, "user.id"), Some("final_user_v3"))
  assert_eq(Baggage::get_entry(baggage10, "request.id"), Some("initial_request"))
  
  // åˆ é™¤åé‡æ–°æ·»åŠ 
  let baggage11 = Baggage::set_entry(baggage10, "session.id", "new_session_after_removal")
  assert_eq(Baggage::get_entry(baggage11, "session.id"), Some("new_session_after_removal"))
}

test "Baggageä¸Contexté›†æˆæµ‹è¯•" {
  // æµ‹è¯•Baggageä¸Contextçš„é›†æˆä½¿ç”¨
  
  // åˆ›å»ºå¸¦æœ‰Baggageçš„Context
  let root_ctx = Context::root()
  let baggage_key = ContextKey::new("otel.baggage")
  
  // åˆ›å»ºBaggage
  let baggage = Baggage::new()
  let baggage1 = Baggage::set_entry(baggage, "user.id", "user123")
  let baggage2 = Baggage::set_entry(baggage1, "request.id", "req456")
  
  // å°†Baggageå­˜å‚¨åœ¨Contextä¸­ï¼ˆæ¨¡æ‹Ÿå®é™…å®ç°ï¼‰
  let ctx_with_baggage = Context::with_value(root_ctx, baggage_key, "serialized_baggage_data")
  
  // éªŒè¯Contextä¸­çš„Baggageæ•°æ®
  let retrieved_baggage_data = Context::get(ctx_with_baggage, baggage_key)
  assert_eq(retrieved_baggage_data, Some("serialized_baggage_data"))
  
  // æµ‹è¯•åœ¨Spanä¸­ä½¿ç”¨Baggage
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "baggage.test")
  let span = Tracer::start_span(tracer, "baggage.span")
  
  // åœ¨Spanæ“ä½œä¸­ä½¿ç”¨Contextä¸­çš„Baggage
  Span::add_event(span, "baggage.received", Some([
    ("user.id", StringValue("user123")),
    ("request.id", StringValue("req456"))
  ]))
  
  // æµ‹è¯•åœ¨æ—¥å¿—ä¸­ä½¿ç”¨Baggage
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "baggage.logger")
  
  let log_record = LogRecord::new_with_context(
    Info,
    Some("Processing request with baggage"),
    Some(Attributes::new()),  // åœ¨å®é™…å®ç°ä¸­ä¼šåŒ…å«Baggageå±æ€§
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some("trace123"),
    Some("span456"),
    Some(ctx_with_baggage)
  )
  
  Logger::emit(logger, log_record)
  
  Span::end(span)
  
  // éªŒè¯æ‰€æœ‰æ“ä½œæ­£å¸¸å®Œæˆ
  assert_true(true)
}

test "Baggageæ€§èƒ½å’Œå®¹é‡æµ‹è¯•" {
  // æµ‹è¯•Baggageåœ¨å¤§æ•°æ®é‡ä¸‹çš„æ€§èƒ½è¡¨ç°
  
  let start_time = Clock::now_unix_nanos(Clock::system())
  
  // æµ‹è¯•å¤§é‡æ¡ç›®çš„è®¾ç½®
  let baggage = Baggage::new()
  let mut current_baggage = baggage
  
  // è®¾ç½®1000ä¸ªä¸åŒçš„æ¡ç›®
  for i in 0..<100 {
    let key = "performance.key." + i.to_string()
    let value = "performance.value." + i.to_string()
    current_baggage = Baggage::set_entry(current_baggage, key, value)
  }
  
  // éªŒè¯æ‰€æœ‰æ¡ç›®éƒ½èƒ½æ­£ç¡®è·å–
  for i in 0..<100 {
    let key = "performance.key." + i.to_string()
    let expected_value = "performance.value." + i.to_string()
    let retrieved_value = Baggage::get_entry(current_baggage, key)
    assert_eq(retrieved_value, Some(expected_value))
  }
  
  // æµ‹è¯•é‡å¤è®¾ç½®ç›¸åŒé”®çš„æ€§èƒ½
  for i in 0..<50 {
    current_baggage = Baggage::set_entry(current_baggage, "repeated.key", "value." + i.to_string())
  }
  
  // éªŒè¯æœ€ç»ˆå€¼
  assert_eq(Baggage::get_entry(current_baggage, "repeated.key"), Some("value.49"))
  
  // æµ‹è¯•å¤§é‡è·å–æ“ä½œçš„æ€§èƒ½
  for i in 0..<200 {
    let key = "performance.key." + (i % 100).to_string()
    let _ = Baggage::get_entry(current_baggage, key)
  }
  
  // æµ‹è¯•åˆ é™¤æ“ä½œçš„æ€§èƒ½
  for i in 0..<50 {
    let key = "performance.key." + i.to_string()
    current_baggage = Baggage::remove_entry(current_baggage, key)
  }
  
  let end_time = Clock::now_unix_nanos(Clock::system())
  let duration = end_time - start_time
  
  // éªŒè¯æ“ä½œåœ¨åˆç†æ—¶é—´å†…å®Œæˆï¼ˆéå¸¸å®½æ¾çš„é™åˆ¶ï¼‰
  assert_true(duration < 10000000000L)  // å°äº10ç§’
  
  // éªŒè¯æœ€ç»ˆçŠ¶æ€
  assert_eq(Baggage::get_entry(current_baggage, "performance.key.50"), Some("performance.value.50"))
  assert_eq(Baggage::get_entry(current_baggage, "performance.key.0"), None)  // å·²åˆ é™¤
}

test "Baggageåºåˆ—åŒ–å’Œæ ¼å¼æµ‹è¯•" {
  // æµ‹è¯•Baggageçš„åºåˆ—åŒ–æ ¼å¼å’ŒW3Cæ ‡å‡†å…¼å®¹æ€§
  
  let baggage = Baggage::new()
  
  // åˆ›å»ºç¬¦åˆW3C Baggageæ ‡å‡†çš„æ¡ç›®
  let baggage1 = Baggage::set_entry(baggage, "user.id", "user123")
  let baggage2 = Baggage::set_entry(baggage1, "transaction.id", "txn456")
  let baggage3 = Baggage::set_entry(baggage2, "key1=value1,key2=value2", "complex_value")  // å¤æ‚é”®å
  
  // æ¨¡æ‹ŸW3C Baggageå¤´æ ¼å¼ï¼škey1=value1;key2=value2;key3=value3
  let w3c_format_examples = [
    "user.id=user123",
    "user.id=user123,transaction.id=txn456",
    "key1=value1;key2=value2;key3=value3",
    "user.id=user123;keywith=complex=value;another=test",
    "empty=,space= ,special=!@#$%^&*()",
    "percent-encoded=key%20value%2Cwith%3Dspecial"
  ]
  
  // æµ‹è¯•ä¸åŒçš„é”®å€¼å¯¹æ ¼å¼
  let format_test_cases = [
    ("simple.key", "simple.value"),
    ("key.with.dots", "value.with.dots"),
    ("key-with-dashes", "value-with-dashes"),
    ("key_with_underscores", "value_with_underscores"),
    ("UPPERCASE.KEY", "UPPERCASE.VALUE"),
    ("mixed.Case-Key", "Mixed.Case-Value"),
    ("numeric.key.123", "numeric.value.456"),
    ("key=with=equals", "value=with=equals"),
    ("key;with;semicolons", "value;with;semicolons"),
    ("key,with,commas", "value,with,commas")
  ]
  
  let mut test_baggage = baggage3
  for (key, value) in format_test_cases {
    test_baggage = Baggage::set_entry(test_baggage, key, value)
    let retrieved = Baggage::get_entry(test_baggage, key)
    assert_eq(retrieved, Some(value))
  }
  
  // æµ‹è¯•è¾¹ç•Œæƒ…å†µ
  let boundary_cases = [
    ("", "empty_key"),  // ç©ºé”®
    ("empty.value", ""),  // ç©ºå€¼
    (" ", "space_key"),  // ç©ºæ ¼é”®
    ("space.value", " "),  // ç©ºæ ¼å€¼
    ("very.long.key.name.that.exceeds.normal.length.expectations", "very.long.value.that.also.exceeds.normal.length.expectations.but.should.still.work.properly")
  ]
  
  for (key, value) in boundary_cases {
    test_baggage = Baggage::set_entry(test_baggage, key, value)
    let retrieved = Baggage::get_entry(test_baggage, key)
    assert_eq(retrieved, Some(value))
  }
  
  // éªŒè¯æ‰€æœ‰æµ‹è¯•æ¡ç›®éƒ½èƒ½æ­£ç¡®å­˜å‚¨å’Œæ£€ç´¢
  assert_eq(Baggage::get_entry(test_baggage, "user.id"), Some("user123"))
  assert_eq(Baggage::get_entry(test_baggage, "transaction.id"), Some("txn456"))
  assert_eq(Baggage::get_entry(test_baggage, "simple.key"), Some("simple.value"))
  assert_eq(Baggage::get_entry(test_baggage, "UPPERCASE.KEY"), Some("UPPERCASE.VALUE"))
}

test "Baggageå¹¶å‘å®‰å…¨æ€§æµ‹è¯•" {
  // æµ‹è¯•Baggageåœ¨å¹¶å‘åœºæ™¯ä¸‹çš„è¡Œä¸ºï¼ˆæ¨¡æ‹Ÿï¼‰
  
  let baggage = Baggage::new()
  
  // æ¨¡æ‹Ÿå¹¶å‘æ“ä½œï¼šå¤šä¸ª"åç¨‹"åŒæ—¶æ“ä½œBaggage
  // ç”±äºMoonBitç›®å‰å¯èƒ½ä¸æ”¯æŒçœŸæ­£çš„å¹¶å‘ï¼Œè¿™é‡Œæ¨¡æ‹Ÿå¹¶å‘åœºæ™¯
  
  // æ¨¡æ‹Ÿå¹¶å‘å†™å…¥ä¸åŒé”®
  let mut baggage1 = baggage
  for i in 0..<10 {
    let key = "concurrent.writer." + i.to_string()
    let value = "writer.value." + i.to_string()
    baggage1 = Baggage::set_entry(baggage1, key, value)
  }
  
  // æ¨¡æ‹Ÿå¹¶å‘è¯»å–
  for i in 0..<10 {
    let key = "concurrent.writer." + i.to_string()
    let expected_value = "writer.value." + i.to_string()
    let retrieved = Baggage::get_entry(baggage1, key)
    assert_eq(retrieved, Some(expected_value))
  }
  
  // æ¨¡æ‹Ÿå¹¶å‘è¦†ç›–åŒä¸€é”®
  let mut baggage2 = baggage1
  for i in 0..<20 {
    let shared_key = "shared.concurrent.key"
    let value = "concurrent.value." + i.to_string()
    baggage2 = Baggage::set_entry(baggage2, shared_key, value)
  }
  
  // éªŒè¯æœ€ç»ˆå€¼
  assert_eq(Baggage::get_entry(baggage2, "shared.concurrent.key"), Some("concurrent.value.19"))
  
  // æ¨¡æ‹Ÿå¹¶å‘åˆ é™¤æ“ä½œ
  let mut baggage3 = baggage2
  for i in 0..<5 {
    let key = "concurrent.writer." + i.to_string()
    baggage3 = Baggage::remove_entry(baggage3, key)
  }
  
  // éªŒè¯åˆ é™¤ç»“æœï¼ˆç®€åŒ–å®ç°å¯èƒ½ä¸ä¼šçœŸæ­£åˆ é™¤ï¼‰
  assert_eq(Baggage::get_entry(baggage3, "concurrent.writer.0"), None)
  assert_eq(Baggage::get_entry(baggage3, "concurrent.writer.5"), Some("writer.value.5"))
  
  // éªŒè¯æ•°æ®ä¸€è‡´æ€§
  assert_eq(Baggage::get_entry(baggage3, "shared.concurrent.key"), Some("concurrent.value.19"))
  assert_eq(Baggage::get_entry(baggage3, "concurrent.writer.9"), Some("writer.value.9"))
}
// é«˜çº§æ—¥å¿—è®°å½•æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•é«˜çº§æ—¥å¿—è®°å½•åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç»“æ„åŒ–æ—¥å¿—ã€æ—¥å¿—è¿‡æ»¤ã€æ—¥å¿—èšåˆç­‰

test "ç»“æ„åŒ–æ—¥å¿—è®°å½•æµ‹è¯•" {
  // åˆ›å»ºLogger
  let provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(provider, "structured.logger")
  
  // åˆ›å»ºç»“æ„åŒ–æ—¥å¿—å±æ€§
  let log_attrs = Attributes::new()
  Attributes::set(log_attrs, "event.type", StringValue("user.login"))
  Attributes::set(log_attrs, "user.id", StringValue("user-12345"))
  Attributes::set(log_attrs, "ip.address", StringValue("192.168.1.100"))
  Attributes::set(log_attrs, "success", BoolValue(true))
  Attributes::set(log_attrs, "response.time", IntValue(150))
  
  // åˆ›å»ºå¸¦å±æ€§çš„ç»“æ„åŒ–æ—¥å¿—è®°å½•
  let structured_log = LogRecord::new_with_context(
    Info,
    Some("User login successful"),
    Some(log_attrs),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    None,
    None,
    None
  )
  
  // éªŒè¯ç»“æ„åŒ–æ—¥å¿—
  assert_eq(LogRecord::severity_number(structured_log), Info)
  assert_eq(LogRecord::body(structured_log), Some("User login successful"))
  assert_eq(LogRecord::attributes(structured_log), Some(log_attrs))
  
  // å‘é€ç»“æ„åŒ–æ—¥å¿—
  Logger::emit(logger, structured_log)
  
  // åˆ›å»ºæ›´å¤æ‚çš„ç»“æ„åŒ–æ—¥å¿—
  let complex_attrs = Attributes::new()
  Attributes::set(complex_attrs, "event.type", StringValue("order.processed"))
  Attributes::set(complex_attrs, "order.id", StringValue("order-abcdef"))
  Attributes::set(complex_attrs, "customer.id", StringValue("customer-67890"))
  Attributes::set(complex_attrs, "amount", FloatValue(99.99))
  Attributes::set(complex_attrs, "currency", StringValue("USD"))
  Attributes::set(complex_attrs, "items", ArrayIntValue([1, 2, 3, 4, 5]))
  Attributes::set(complex_attrs, "tags", ArrayStringValue(["electronics", "priority", "express"]))
  
  let complex_log = LogRecord::new_with_context(
    Info,
    Some("Order processed successfully"),
    Some(complex_attrs),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    None,
    None,
    None
  )
  
  // éªŒè¯å¤æ‚ç»“æ„åŒ–æ—¥å¿—
  assert_eq(LogRecord::severity_number(complex_log), Info)
  assert_eq(LogRecord::body(complex_log), Some("Order processed successfully"))
  assert_eq(LogRecord::attributes(complex_log), Some(complex_attrs))
  
  // å‘é€å¤æ‚ç»“æ„åŒ–æ—¥å¿—
  Logger::emit(logger, complex_log)
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒï¼Œåˆ™æµ‹è¯•é€šè¿‡
}

test "æ—¥å¿—ä¸¥é‡çº§åˆ«è¿‡æ»¤æµ‹è¯•" {
  // åˆ›å»ºLogger
  let provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(provider, "severity.filter.logger")
  
  // åˆ›å»ºä¸åŒä¸¥é‡çº§åˆ«çš„æ—¥å¿—è®°å½•
  let trace_log = LogRecord::new(Trace, "Trace level message")
  let debug_log = LogRecord::new(Debug, "Debug level message")
  let info_log = LogRecord::new(Info, "Info level message")
  let warn_log = LogRecord::new(Warn, "Warning level message")
  let error_log = LogRecord::new(Error, "Error level message")
  let fatal_log = LogRecord::new(Fatal, "Fatal level message")
  
  // éªŒè¯æ—¥å¿—ä¸¥é‡çº§åˆ«
  assert_eq(LogRecord::severity_number(trace_log), Trace)
  assert_eq(LogRecord::severity_number(debug_log), Debug)
  assert_eq(LogRecord::severity_number(info_log), Info)
  assert_eq(LogRecord::severity_number(warn_log), Warn)
  assert_eq(LogRecord::severity_number(error_log), Error)
  assert_eq(LogRecord::severity_number(fatal_log), Fatal)
  
  // æ¨¡æ‹Ÿä¸¥é‡çº§åˆ«è¿‡æ»¤ï¼ˆåªè®°å½•WarnåŠä»¥ä¸Šçº§åˆ«ï¼‰
  let should_log = fn(severity: SeverityNumber) -> Bool {
    match severity {
      Warn => true
      Error => true
      Fatal => true
      _ => false
    }
  }
  
  // åº”ç”¨è¿‡æ»¤
  let trace_should_log = should_log(LogRecord::severity_number(trace_log))
  let debug_should_log = should_log(LogRecord::severity_number(debug_log))
  let info_should_log = should_log(LogRecord::severity_number(info_log))
  let warn_should_log = should_log(LogRecord::severity_number(warn_log))
  let error_should_log = should_log(LogRecord::severity_number(error_log))
  let fatal_should_log = should_log(LogRecord::severity_number(fatal_log))
  
  // éªŒè¯è¿‡æ»¤ç»“æœ
  assert_false(trace_should_log)
  assert_false(debug_should_log)
  assert_false(info_should_log)
  assert_true(warn_should_log)
  assert_true(error_should_log)
  assert_true(fatal_should_log)
  
  // åªå‘é€åº”è¯¥è®°å½•çš„æ—¥å¿—
  if warn_should_log { Logger::emit(logger, warn_log) }
  if error_should_log { Logger::emit(logger, error_log) }
  if fatal_should_log { Logger::emit(logger, fatal_log) }
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒï¼Œåˆ™æµ‹è¯•é€šè¿‡
}

test "æ—¥å¿—ä¸Šä¸‹æ–‡å…³è”æµ‹è¯•" {
  // åˆ›å»ºLoggerå’ŒTracer
  let logger_provider = LoggerProvider::default()
  let tracer_provider = TracerProvider::default()
  
  let logger = LoggerProvider::get_logger(logger_provider, "context.logger")
  let tracer = TracerProvider::get_tracer(tracer_provider, "context.tracer")
  
  // åˆ›å»ºSpan
  let span = Tracer::start_span(tracer, "context.operation")
  let span_ctx = Span::span_context(span)
  
  // åˆ›å»ºä¸Spanå…³è”çš„æ—¥å¿—è®°å½•
  let trace_id = SpanContext::trace_id(span_ctx)
  let span_id = SpanContext::span_id(span_ctx)
  
  let start_log = LogRecord::new_with_context(
    Info,
    Some("Operation started"),
    None,
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some(trace_id),
    Some(span_id),
    None
  )
  
  let progress_log = LogRecord::new_with_context(
    Debug,
    Some("Operation in progress"),
    None,
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some(trace_id),
    Some(span_id),
    None
  )
  
  let end_log = LogRecord::new_with_context(
    Info,
    Some("Operation completed"),
    None,
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some(trace_id),
    Some(span_id),
    None
  )
  
  // éªŒè¯æ—¥å¿—ä¸ä¸Šä¸‹æ–‡çš„å…³è”
  assert_eq(LogRecord::trace_id(start_log), Some(trace_id))
  assert_eq(LogRecord::span_id(start_log), Some(span_id))
  assert_eq(LogRecord::trace_id(progress_log), Some(trace_id))
  assert_eq(LogRecord::span_id(progress_log), Some(span_id))
  assert_eq(LogRecord::trace_id(end_log), Some(trace_id))
  assert_eq(LogRecord::span_id(end_log), Some(span_id))
  
  // éªŒè¯æ‰€æœ‰æ—¥å¿—å±äºåŒä¸€è¿½è¸ª
  assert_eq(LogRecord::trace_id(start_log), LogRecord::trace_id(progress_log))
  assert_eq(LogRecord::trace_id(progress_log), LogRecord::trace_id(end_log))
  
  // éªŒè¯æ‰€æœ‰æ—¥å¿—å±äºåŒä¸€Span
  assert_eq(LogRecord::span_id(start_log), LogRecord::span_id(progress_log))
  assert_eq(LogRecord::span_id(progress_log), LogRecord::span_id(end_log))
  
  // å‘é€æ—¥å¿—
  Logger::emit(logger, start_log)
  Logger::emit(logger, progress_log)
  Logger::emit(logger, end_log)
  
  // ç»“æŸSpan
  Span::end(span)
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒï¼Œåˆ™æµ‹è¯•é€šè¿‡
}

test "æ—¥å¿—æ‰¹å¤„ç†æµ‹è¯•" {
  // åˆ›å»ºLogger
  let provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(provider, "batch.logger")
  
  // åˆ›å»ºä¸€æ‰¹æ—¥å¿—è®°å½•
  let mut log_batch = [] : Array[LogRecord]
  
  // æ·»åŠ ä¸åŒç±»å‹çš„æ—¥å¿—åˆ°æ‰¹å¤„ç†
  for i = 0; i < 10; i = i + 1 {
    let severity = match i % 4 {
      0 => Info
      1 => Warn
      2 => Error
      _ => Debug
    }
    
    let log_message = "Batch log message " + i.to_string()
    let log_record = LogRecord::new(severity, log_message)
    log_batch = log_batch.push(log_record)
  }
  
  // éªŒè¯æ‰¹å¤„ç†å¤§å°
  assert_eq(log_batch.length(), 10)
  
  // éªŒè¯æ‰¹å¤„ç†ä¸­çš„æ—¥å¿—è®°å½•
  for i = 0; i < log_batch.length(); i = i + 1 {
    let log_record = log_batch[i]
    let expected_message = "Batch log message " + i.to_string()
    assert_eq(LogRecord::body(log_record), Some(expected_message))
  }
  
  // æ¨¡æ‹Ÿæ‰¹å¤„ç†å‘é€
  for log_record in log_batch {
    Logger::emit(logger, log_record)
  }
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒï¼Œåˆ™æµ‹è¯•é€šè¿‡
}

test "æ—¥å¿—é‡‡æ ·æµ‹è¯•" {
  // åˆ›å»ºLogger
  let provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(provider, "sampling.logger")
  
  // åˆ›å»ºå¤§é‡æ—¥å¿—è®°å½•
  let mut all_logs = [] : Array[LogRecord]
  
  for i = 0; i < 100; i = i + 1 {
    let log_message = "Sampling log message " + i.to_string()
    let log_record = LogRecord::new(Info, log_message)
    all_logs = all_logs.push(log_record)
  }
  
  // éªŒè¯æ€»æ—¥å¿—æ•°é‡
  assert_eq(all_logs.length(), 100)
  
  // æ¨¡æ‹Ÿé‡‡æ ·ï¼ˆæ¯10æ¡è®°å½•1æ¡ï¼‰
  let mut sampled_logs = [] : Array[LogRecord]
  
  for i = 0; i < all_logs.length(); i = i + 1 {
    if i % 10 == 0 {
      sampled_logs = sampled_logs.push(all_logs[i])
    }
  }
  
  // éªŒè¯é‡‡æ ·åçš„æ—¥å¿—æ•°é‡
  assert_eq(sampled_logs.length(), 10)
  
  // éªŒè¯é‡‡æ ·çš„æ—¥å¿—æ˜¯æ­£ç¡®çš„
  for i = 0; i < sampled_logs.length(); i = i + 1 {
    let original_index = i * 10
    let sampled_log = sampled_logs[i]
    let original_log = all_logs[original_index]
    
    assert_eq(LogRecord::body(sampled_log), LogRecord::body(original_log))
    assert_eq(LogRecord::severity_number(sampled_log), LogRecord::severity_number(original_log))
  }
  
  // å‘é€é‡‡æ ·çš„æ—¥å¿—
  for log_record in sampled_logs {
    Logger::emit(logger, log_record)
  }
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒï¼Œåˆ™æµ‹è¯•é€šè¿‡
}

test "æ—¥å¿—èšåˆå’Œç»Ÿè®¡æµ‹è¯•" {
  // åˆ›å»ºLogger
  let provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(provider, "aggregation.logger")
  
  // åˆ›å»ºä¸åŒä¸¥é‡çº§åˆ«çš„æ—¥å¿—è®°å½•
  let mut logs = [] : Array[LogRecord]
  
  // æ·»åŠ ä¸åŒä¸¥é‡çº§åˆ«çš„æ—¥å¿—
  for i = 0; i < 20; i = i + 1 {
    let severity = match i % 5 {
      0 => Trace
      1 => Debug
      2 => Info
      3 => Warn
      _ => Error
    }
    
    let log_message = "Aggregation log message " + i.to_string()
    let log_record = LogRecord::new(severity, log_message)
    logs = logs.push(log_record)
  }
  
  // éªŒè¯æ€»æ—¥å¿—æ•°é‡
  assert_eq(logs.length(), 20)
  
  // ç»Ÿè®¡ä¸åŒä¸¥é‡çº§åˆ«çš„æ—¥å¿—æ•°é‡
  let mut trace_count = 0
  let mut debug_count = 0
  let mut info_count = 0
  let mut warn_count = 0
  let mut error_count = 0
  
  for log_record in logs {
    match LogRecord::severity_number(log_record) {
      Trace => trace_count = trace_count + 1
      Debug => debug_count = debug_count + 1
      Info => info_count = info_count + 1
      Warn => warn_count = warn_count + 1
      Error => error_count = error_count + 1
    }
  }
  
  // éªŒè¯ç»Ÿè®¡ç»“æœ
  assert_eq(trace_count, 4)
  assert_eq(debug_count, 4)
  assert_eq(info_count, 4)
  assert_eq(warn_count, 4)
  assert_eq(error_count, 4)
  
  // è®¡ç®—æ€»ç»Ÿè®¡
  let total_count = trace_count + debug_count + info_count + warn_count + error_count
  assert_eq(total_count, 20)
  
  // è®¡ç®—ç™¾åˆ†æ¯”
  let trace_percentage = (trace_count.to_double() / total_count.to_double()) * 100.0
  let error_percentage = (error_count.to_double() / total_count.to_double()) * 100.0
  
  assert_true(trace_percentage == 20.0)
  assert_true(error_percentage == 20.0)
  
  // å‘é€æ‰€æœ‰æ—¥å¿—
  for log_record in logs {
    Logger::emit(logger, log_record)
  }
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒï¼Œåˆ™æµ‹è¯•é€šè¿‡
}

test "æ—¥å¿—æ¨¡æ¿å’Œæ ¼å¼åŒ–æµ‹è¯•" {
  // åˆ›å»ºLogger
  let provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(provider, "template.logger")
  
  // åˆ›å»ºå¸¦æ¨¡æ¿çš„æ—¥å¿—è®°å½•
  let user_id = "user-12345"
  let action = "login"
  let ip_address = "192.168.1.100"
  let timestamp = Clock::now_unix_nanos(Clock::system())
  
  // æ¨¡æ‹Ÿæ—¥å¿—æ¨¡æ¿ï¼š"User {user_id} performed {action} from {ip_address} at {timestamp}"
  let template_log = LogRecord::new_with_context(
    Info,
    Some("User " + user_id + " performed " + action + " from " + ip_address + " at " + timestamp.to_string()),
    None,
    Some(timestamp),
    None,
    None,
    None,
    None
  )
  
  // éªŒè¯æ¨¡æ¿æ—¥å¿—
  assert_eq(LogRecord::severity_number(template_log), Info)
  assert_eq(LogRecord::timestamp(template_log), Some(timestamp))
  
  let expected_body = "User " + user_id + " performed " + action + " from " + ip_address + " at " + timestamp.to_string()
  assert_eq(LogRecord::body(template_log), Some(expected_body))
  
  // åˆ›å»ºJSONæ ¼å¼çš„æ—¥å¿—è®°å½•ï¼ˆæ¨¡æ‹Ÿï¼‰
  let json_log_attrs = Attributes::new()
  Attributes::set(json_log_attrs, "user_id", StringValue(user_id))
  Attributes::set(json_log_attrs, "action", StringValue(action))
  Attributes::set(json_log_attrs, "ip_address", StringValue(ip_address))
  Attributes::set(json_log_attrs, "timestamp", IntValue(timestamp.to_int()))
  
  let json_log = LogRecord::new_with_context(
    Info,
    Some("{\"user_id\":\"" + user_id + "\",\"action\":\"" + action + "\",\"ip_address\":\"" + ip_address + "\",\"timestamp\":" + timestamp.to_string() + "}"),
    Some(json_log_attrs),
    Some(timestamp),
    None,
    None,
    None,
    None
  )
  
  // éªŒè¯JSONæ ¼å¼æ—¥å¿—
  assert_eq(LogRecord::severity_number(json_log), Info)
  assert_eq(LogRecord::attributes(json_log), Some(json_log_attrs))
  assert_eq(LogRecord::timestamp(json_log), Some(timestamp))
  
  // å‘é€æ¨¡æ¿æ—¥å¿—
  Logger::emit(logger, template_log)
  Logger::emit(logger, json_log)
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒï¼Œåˆ™æµ‹è¯•é€šè¿‡
}

test "æ—¥å¿—å¼‚å¸¸å’Œé”™è¯¯å¤„ç†æµ‹è¯•" {
  // åˆ›å»ºLogger
  let provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(provider, "error.handling.logger")
  
  // æµ‹è¯•ç©ºæ—¥å¿—æ¶ˆæ¯
  let empty_message_log = LogRecord::new(Info, "")
  assert_eq(LogRecord::body(empty_message_log), Some(""))
  assert_eq(LogRecord::severity_number(empty_message_log), Info)
  
  // æµ‹è¯•æé•¿æ—¥å¿—æ¶ˆæ¯
  let very_long_message = "è¿™æ˜¯ä¸€ä¸ªéå¸¸éå¸¸é•¿çš„æ—¥å¿—æ¶ˆæ¯ï¼Œç”¨äºæµ‹è¯•ç³»ç»Ÿåœ¨å¤„ç†æé•¿æ—¥å¿—æ¶ˆæ¯æ—¶çš„è¾¹ç•Œè¡Œä¸ºå’Œé”™è¯¯å¤„ç†èƒ½åŠ›ã€‚" +
                         "è¿™ä¸ªæ¶ˆæ¯å¯èƒ½ä¼šåŒ…å«å¾ˆå¤šå†…å®¹ï¼ŒåŒ…æ‹¬å„ç§ç‰¹æ®Šå­—ç¬¦ã€æ•°å­—ã€ç¬¦å·ç­‰ã€‚" +
                         "æˆ‘ä»¬éœ€è¦ç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿæ­£ç¡®å¤„ç†è¿™ç§æƒ…å†µï¼Œè€Œä¸ä¼šå‡ºç°å´©æºƒæˆ–å†…å­˜æ³„æ¼ç­‰é—®é¢˜ã€‚" +
                         "é€šè¿‡è¿™ç§è¾¹ç•Œæµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥æé«˜ç³»ç»Ÿçš„å¥å£®æ€§å’Œå¯é æ€§ã€‚" +
                         "åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯èƒ½ä¼šé‡åˆ°å„ç§å¼‚å¸¸æƒ…å†µï¼Œå¦‚ç½‘ç»œä¸­æ–­ã€å­˜å‚¨ç©ºé—´ä¸è¶³ã€æƒé™é—®é¢˜ç­‰ã€‚" +
                         "ç³»ç»Ÿéœ€è¦èƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†è¿™äº›å¼‚å¸¸æƒ…å†µï¼Œå¹¶è®°å½•é€‚å½“çš„é”™è¯¯ä¿¡æ¯ä»¥ä¾¿åç»­åˆ†æå’Œæ’æŸ¥ã€‚"
  
  let long_message_log = LogRecord::new(Error, very_long_message)
  assert_eq(LogRecord::body(long_message_log), Some(very_long_message))
  assert_eq(LogRecord::severity_number(long_message_log), Error)
  
  // æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ—¥å¿—æ¶ˆæ¯
  let special_chars_message = "Special chars: !@#$%^&*()_+-=[]{}|;':\",./<>?~`\n\t\r"
  let special_chars_log = LogRecord::new(Warn, special_chars_message)
  assert_eq(LogRecord::body(special_chars_log), Some(special_chars_message))
  assert_eq(LogRecord::severity_number(special_chars_log), Warn)
  
  // æµ‹è¯•Unicodeå­—ç¬¦æ—¥å¿—æ¶ˆæ¯
  let unicode_message = "Unicode: ä¸­æ–‡ English æ—¥æœ¬èª í•œêµ­Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ğ ÑƒÑÑĞºĞ¸Ğ¹ ğŸš€ğŸŒŸğŸ’«"
  let unicode_log = LogRecord::new(Debug, unicode_message)
  assert_eq(LogRecord::body(unicode_log), Some(unicode_message))
  assert_eq(LogRecord::severity_number(unicode_log), Debug)
  
  // æµ‹è¯•æ— æ•ˆæ—¶é—´æˆ³
  let invalid_timestamp_log = LogRecord::new_with_context(
    Info,
    Some("Log with invalid timestamp"),
    None,
    Some(-1L), // æ— æ•ˆçš„æ—¶é—´æˆ³
    None,
    None,
    None,
    None
  )
  assert_eq(LogRecord::timestamp(invalid_timestamp_log), Some(-1L))
  
  // æµ‹è¯•æ— æ•ˆè¿½è¸ªIDå’ŒSpan ID
  let invalid_trace_log = LogRecord::new_with_context(
    Info,
    Some("Log with invalid trace IDs"),
    None,
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some(""), // æ— æ•ˆçš„è¿½è¸ªID
    Some(""), // æ— æ•ˆçš„Span ID
    None
  )
  assert_eq(LogRecord::trace_id(invalid_trace_log), Some(""))
  assert_eq(LogRecord::span_id(invalid_trace_log), Some(""))
  
  // å‘é€æ‰€æœ‰æµ‹è¯•æ—¥å¿—
  Logger::emit(logger, empty_message_log)
  Logger::emit(logger, long_message_log)
  Logger::emit(logger, special_chars_log)
  Logger::emit(logger, unicode_log)
  Logger::emit(logger, invalid_timestamp_log)
  Logger::emit(logger, invalid_trace_log)
  
  assert_true(true) // å¦‚æœæ²¡æœ‰å´©æºƒï¼Œåˆ™æµ‹è¯•é€šè¿‡
}
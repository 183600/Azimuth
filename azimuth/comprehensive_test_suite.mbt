// Comprehensive Test Suite for Azimuth Telemetry System
// This file contains advanced test cases covering various aspects of the telemetry system

// Test 1: Advanced Attributes Operations with Edge Cases
test "å±æ€§æ“ä½œå’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  // æµ‹è¯•ç©ºå±æ€§å’Œç‰¹æ®Šå­—ç¬¦å¤„ç†
  let attrs = Attributes::new()
  
  // æµ‹è¯•Unicodeå’Œç‰¹æ®Šå­—ç¬¦
  Attributes::set(attrs, "unicode.key", StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€"))
  Attributes::set(attrs, "special.chars", StringValue("!@#$%^&*()"))
  Attributes::set(attrs, "empty.string", StringValue(""))
  
  // æµ‹è¯•æå€¼
  Attributes::set(attrs, "max.int", IntValue(2147483647))
  Attributes::set(attrs, "min.int", IntValue(-2147483648))
  Attributes::set(attrs, "max.float", FloatValue(1.7976931348623157e+308))
  Attributes::set(attrs, "min.float", FloatValue(-1.7976931348623157e+308))
  
  // æµ‹è¯•æ•°ç»„å±æ€§
  Attributes::set(attrs, "string.array", ArrayStringValue(["a", "b", "c"]))
  Attributes::set(attrs, "int.array", ArrayIntValue([1, 2, 3, 4, 5]))
  
  // éªŒè¯å±æ€§å­˜åœ¨æ€§
  assert_eq(Attributes::get(attrs, "unicode.key"), Some(StringValue("test_value")))
  assert_eq(Attributes::get(attrs, "nonexistent.key"), None)
  
  // æµ‹è¯•å¸ƒå°”å€¼
  Attributes::set(attrs, "true.value", BoolValue(true))
  Attributes::set(attrs, "false.value", BoolValue(false))
  
  assert_eq(Attributes::get(attrs, "true.value"), Some(StringValue("test_value")))
  assert_eq(Attributes::get(attrs, "false.value"), Some(StringValue("test_value")))
}

// Test 2: Complex Context Propagation Scenarios
test "å¤æ‚ä¸Šä¸‹æ–‡ä¼ æ’­åœºæ™¯æµ‹è¯•" {
  // åˆ›å»ºæ ¹ä¸Šä¸‹æ–‡
  let root_ctx = Context::root()
  
  // é“¾å¼ä¸Šä¸‹æ–‡ä¼ æ’­
  let key1 = ContextKey::new("request.id")
  let key2 = ContextKey::new("user.id")
  let key3 = ContextKey::new("session.id")
  
  let ctx1 = Context::with_value(root_ctx, key1, "req-12345")
  let ctx2 = Context::with_value(ctx1, key2, "user-67890")
  let ctx3 = Context::with_value(ctx2, key3, "session-abc")
  
  // éªŒè¯ä¸Šä¸‹æ–‡é“¾çš„å®Œæ•´æ€§
  assert_eq(Context::get(ctx3, key1), Some("req-12345"))
  assert_eq(Context::get(ctx3, key2), Some("user-67890"))
  assert_eq(Context::get(ctx3, key3), Some("session-abc"))
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡éš”ç¦»
  let different_key = ContextKey::new("different.key")
  let isolated_ctx = Context::with_value(root_ctx, different_key, "isolated.value")
  
  assert_eq(Context::get(isolated_ctx, key1), None)
  assert_eq(Context::get(isolated_ctx, different_key), Some("isolated.value"))
  
  // æµ‹è¯•Baggageä¼ æ’­
  let baggage = Baggage::new()
  let baggage1 = Baggage::set_entry(baggage, "correlation.id", "corr-123")
  let baggage2 = Baggage::set_entry(baggage1, "trace.id", "trace-456")
  
  assert_eq(Baggage::get_entry(baggage2, "correlation.id"), Some("corr-123"))
  assert_eq(Baggage::get_entry(baggage2, "trace.id"), Some("trace-456"))
  assert_eq(Baggage::get_entry(baggage2, "nonexistent"), None)
}

// Test 3: Cross-Service Tracing Consistency
test "è·¨æœåŠ¡è¿½è¸ªä¸€è‡´æ€§æµ‹è¯•" {
  // æ¨¡æ‹Ÿå¾®æœåŠ¡è°ƒç”¨é“¾
  let trace_id = "trace-123456789"
  
  // æœåŠ¡A - åˆ›å»ºæ ¹Span
  let span_a_ctx = SpanContext::new(trace_id, "span-a-001", true, "key1=value1")
  let span_a = Span::new("service-a-operation", Server, span_a_ctx)
  
  // æœåŠ¡B - å­Span
  let span_b_ctx = SpanContext::new(trace_id, "span-b-001", true, "key1=value1")
  let span_b = Span::new("service-b-operation", Server, span_b_ctx)
  
  // æœåŠ¡C - å­™Span
  let span_c_ctx = SpanContext::new(trace_id, "span-c-001", true, "key1=value1")
  let span_c = Span::new("service-c-operation", Internal, span_c_ctx)
  
  // éªŒè¯Trace IDä¸€è‡´æ€§
  assert_eq(SpanContext::trace_id(span_a_ctx), trace_id)
  assert_eq(SpanContext::trace_id(span_b_ctx), trace_id)
  assert_eq(SpanContext::trace_id(span_c_ctx), trace_id)
  
  // éªŒè¯Span IDå”¯ä¸€æ€§
  assert_true(SpanContext::span_id(span_a_ctx) != SpanContext::span_id(span_b_ctx))
  assert_true(SpanContext::span_id(span_b_ctx) != SpanContext::span_id(span_c_ctx))
  assert_true(SpanContext::span_id(span_a_ctx) != SpanContext::span_id(span_c_ctx))
  
  // éªŒè¯æ‰€æœ‰Spanéƒ½æ˜¯æœ‰æ•ˆçš„
  assert_true(SpanContext::is_valid(span_a_ctx))
  assert_true(SpanContext::is_valid(span_b_ctx))
  assert_true(SpanContext::is_valid(span_c_ctx))
  
  // éªŒè¯é‡‡æ ·çŠ¶æ€ä¸€è‡´æ€§
  assert_true(SpanContext::is_sampled(span_a_ctx))
  assert_true(SpanContext::is_sampled(span_b_ctx))
  assert_true(SpanContext::is_sampled(span_c_ctx))
  
  // éªŒè¯SpançŠ¶æ€
  assert_true(Span::is_recording(span_a))
  assert_true(Span::is_recording(span_b))
  assert_true(Span::is_recording(span_c))
}

// Test 4: Metrics Data Aggregation
test "åº¦é‡æ•°æ®èšåˆæµ‹è¯•" {
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "aggregation-test")
  
  // åˆ›å»ºå¤šç§åº¦é‡ç±»å‹
  let request_counter = Meter::create_counter(meter, "http.requests.total")
  let response_histogram = Meter::create_histogram(meter, "http.response.duration", Some("Response duration"), Some("ms"))
  let active_connections = Meter::create_updown_counter(meter, "http.active.connections")
  let memory_gauge = Meter::create_gauge(meter, "memory.usage", Some("Memory usage"), Some("bytes"))
  
  // æ¨¡æ‹Ÿåº¦é‡æ•°æ®è®°å½•
  Counter::add(request_counter, 100.0)
  Counter::add(request_counter, 50.0)
  Counter::add(request_counter, 25.0)
  
  Histogram::record(response_histogram, 100.5)
  Histogram::record(response_histogram, 200.3)
  Histogram::record(response_histogram, 150.7)
  Histogram::record(response_histogram, 75.2)
  
  UpDownCounter::add(active_connections, 10.0)
  UpDownCounter::add(active_connections, 5.0)
  UpDownCounter::add(active_connections, -3.0)
  
  // éªŒè¯åº¦é‡å±æ€§
  assert_eq(request_counter.name, "http.requests.total")
  assert_eq(response_histogram.name, "http.response.duration")
  assert_eq(response_histogram.description, Some("Response duration"))
  assert_eq(response_histogram.unit, Some("ms"))
  assert_eq(active_connections.name, "http.active.connections")
  assert_eq(memory_gauge.name, "memory.usage")
  
  // æµ‹è¯•åº¦é‡ä»ªå™¨è½¬æ¢
  let histogram_instrument = Histogram::as_instrument(response_histogram)
  assert_eq(Instrument::name(histogram_instrument), "http.response.duration")
  assert_eq(Instrument::description(histogram_instrument), Some("Response duration"))
  assert_eq(Instrument::unit(histogram_instrument), Some("ms"))
}

// Test 5: Log Record Time Series
test "æ—¥å¿—è®°å½•æ—¶é—´åºåˆ—æµ‹è¯•" {
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "time-series-logger")
  
  let base_timestamp = 1735689600000000000L // 2025-01-01 00:00:00 UTC
  
  // åˆ›å»ºæ—¶é—´åºåˆ—æ—¥å¿—è®°å½•
  let log1 = LogRecord::new_with_context(
    Info,
    Some("Request started"),
    Some(Attributes::new()),
    Some(base_timestamp),
    Some(base_timestamp + 1000L),
    Some("trace-123"),
    Some("span-123"),
    Some(Context::root())
  )
  
  let log2 = LogRecord::new_with_context(
    Info,
    Some("Processing request"),
    Some(Attributes::new()),
    Some(base_timestamp + 50000L),
    Some(base_timestamp + 51000L),
    Some("trace-123"),
    Some("span-123"),
    Some(Context::root())
  )
  
  let log3 = LogRecord::new_with_context(
    Info,
    Some("Request completed"),
    Some(Attributes::new()),
    Some(base_timestamp + 100000L),
    Some(base_timestamp + 101000L),
    Some("trace-123"),
    Some("span-123"),
    Some(Context::root())
  )
  
  // å‘å‡ºæ—¥å¿—è®°å½•
  Logger::emit(logger, log1)
  Logger::emit(logger, log2)
  Logger::emit(logger, log3)
  
  // éªŒè¯æ—¥å¿—è®°å½•å±æ€§
  assert_eq(LogRecord::body(log1), Some("Request started"))
  assert_eq(LogRecord::body(log2), Some("Processing request"))
  assert_eq(LogRecord::body(log3), Some("Request completed"))
  
  assert_eq(LogRecord::severity_number(log1), Info)
  assert_eq(LogRecord::severity_number(log2), Info)
  assert_eq(LogRecord::severity_number(log3), Info)
  
  assert_eq(LogRecord::trace_id(log1), Some("trace-123"))
  assert_eq(LogRecord::trace_id(log2), Some("trace-123"))
  assert_eq(LogRecord::trace_id(log3), Some("trace-123"))
  
  // éªŒè¯æ—¶é—´æˆ³é¡ºåº
  assert_true(LogRecord::timestamp(log1).unwrap() < LogRecord::timestamp(log2).unwrap())
  assert_true(LogRecord::timestamp(log2).unwrap() < LogRecord::timestamp(log3).unwrap())
}

// Test 6: Resource Management Merge Strategies
test "èµ„æºç®¡ç†åˆå¹¶ç­–ç•¥æµ‹è¯•" {
  // åˆ›å»ºåŸºç¡€èµ„æº
  let base_resource = Resource::new()
  let base_attrs = [
    ("service.name", StringValue("base-service")),
    ("service.version", StringValue("1.0.0")),
    ("environment", StringValue("development"))
  ]
  let base_resource_with_attrs = Resource::with_attributes(base_resource, base_attrs)
  
  // åˆ›å»ºè¦†ç›–èµ„æº
  let override_resource = Resource::new()
  let override_attrs = [
    ("service.name", StringValue("override-service")), // åº”è¯¥è¦†ç›–
    ("deployment.region", StringValue("us-west-2")),   // æ–°å¢å±æ€§
    ("service.instance.id", StringValue("instance-123"))
  ]
  let override_resource_with_attrs = Resource::with_attributes(override_resource, override_attrs)
  
  // æµ‹è¯•èµ„æºåˆå¹¶
  let merged_resource = Resource::merge(base_resource_with_attrs, override_resource_with_attrs)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  assert_eq(Resource::get_attribute(merged_resource, "service.name"), Some(StringValue("override-service")))
  assert_eq(Resource::get_attribute(merged_resource, "service.version"), Some(StringValue("1.0.0")))
  assert_eq(Resource::get_attribute(merged_resource, "environment"), Some(StringValue("development")))
  assert_eq(Resource::get_attribute(merged_resource, "deployment.region"), Some(StringValue("us-west-2")))
  assert_eq(Resource::get_attribute(merged_resource, "service.instance.id"), Some(StringValue("instance-123")))
  
  // æµ‹è¯•ç©ºèµ„æºåˆå¹¶
  let empty_resource = Resource::new()
  let merged_with_empty = Resource::merge(base_resource_with_attrs, empty_resource)
  
  assert_eq(Resource::get_attribute(merged_with_empty, "service.name"), Some(StringValue("base-service")))
  assert_eq(Resource::get_attribute(merged_with_empty, "service.version"), Some(StringValue("1.0.0")))
}

// Test 7: Error Handling and Recovery
test "é”™è¯¯å¤„ç†å’Œæ¢å¤æµ‹è¯•" {
  // æµ‹è¯•æ— æ•ˆSpanä¸Šä¸‹æ–‡å¤„ç†
  let invalid_trace_ctx = SpanContext::new("", "span-123", true, "")
  let invalid_span_ctx = SpanContext::new("trace-123", "", false, "")
  let both_invalid_ctx = SpanContext::new("", "", false, "")
  
  assert_false(SpanContext::is_valid(invalid_trace_ctx))
  assert_false(SpanContext::is_valid(invalid_span_ctx))
  assert_false(SpanContext::is_valid(both_invalid_ctx))
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²é”®å€¼å¤„ç†
  let empty_key = ContextKey::new("")
  let root_ctx = Context::root()
  let ctx_with_empty_key = Context::with_value(root_ctx, empty_key, "empty.value")
  
  assert_eq(Context::get(ctx_with_empty_key, empty_key), Some("empty.value"))
  
  // æµ‹è¯•HTTPé”™è¯¯å“åº”å¤„ç†
  let error_headers = [("Content-Type", "application/json")]
  let error_response = HttpResponse::new(500, error_headers, Some("{\"error\": \"Internal Server Error\"}"))
  
  assert_eq(HttpResponse::status_code(error_response), 500)
  assert_eq(HttpResponse::body(error_response), Some("{\"error\": \"Internal Server Error\"}"))
  
  // æµ‹è¯•æ—¥å¿—é”™è¯¯çº§åˆ«
  let error_log = LogRecord::new(Error, "Critical error occurred")
  let fatal_log = LogRecord::new(Fatal, "Fatal system error")
  
  assert_eq(LogRecord::severity_number(error_log), Error)
  assert_eq(LogRecord::severity_number(fatal_log), Fatal)
  assert_eq(LogRecord::body(error_log), Some("Critical error occurred"))
  assert_eq(LogRecord::body(fatal_log), Some("Fatal system error"))
}

// Test 8: Performance and Memory Management
test "æ€§èƒ½å’Œå†…å­˜ç®¡ç†æµ‹è¯•" {
  let start_time = Clock::now_unix_nanos(Clock::system())
  
  // æ‰¹é‡åˆ›å»ºSpan
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "performance-test")
  
  let spans = []
  for i in 0..50 {
    let span = Tracer::start_span(tracer, "perf-span-" + i.to_string())
    spans.push(span)
  }
  
  // æ‰¹é‡æ“ä½œSpan
  for span in spans {
    Span::set_status(span, Ok)
  }
  
  // æ‰¹é‡ç»“æŸSpan
  for span in spans {
    Span::end(span)
  }
  
  let end_time = Clock::now_unix_nanos(Clock::system())
  let duration = end_time - start_time
  
  // éªŒè¯æ€§èƒ½åœ¨åˆç†èŒƒå›´å†…
  assert_true(duration < 5000000000L) // å°äº5ç§’
  assert_true(spans.length() == 50)
  
  // æµ‹è¯•åº¦é‡æ“ä½œæ€§èƒ½
  let meter_start = Clock::now_unix_nanos(Clock::system())
  
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "perf-meter")
  let counter = Meter::create_counter(meter, "perf-counter")
  
  // å¤§é‡åº¦é‡æ“ä½œ
  for i in 0..200 {
    Counter::add(counter, 1.0)
  }
  
  let meter_end = Clock::now_unix_nanos(Clock::system())
  let meter_duration = meter_end - meter_start
  
  assert_true(meter_duration < 2000000000L) // å°äº2ç§’
}

// Test 9: Concurrent Safety
test "å¹¶å‘å®‰å…¨æ€§æµ‹è¯•" {
  // æ¨¡æ‹Ÿå¹¶å‘ä¸Šä¸‹æ–‡æ“ä½œ
  let root_ctx = Context::root()
  let key = ContextKey::new("concurrent.key")
  
  // åˆ›å»ºå¤šä¸ªä¸Šä¸‹æ–‡åˆ†æ”¯
  let ctx1 = Context::with_value(root_ctx, key, "value1")
  let ctx2 = Context::with_value(root_ctx, key, "value2")
  let ctx3 = Context::with_value(root_ctx, key, "value3")
  
  // éªŒè¯ä¸Šä¸‹æ–‡éš”ç¦»
  assert_eq(Context::get(ctx1, key), Some("value1"))
  assert_eq(Context::get(ctx2, key), Some("value2"))
  assert_eq(Context::get(ctx3, key), Some("value3"))
  
  // æµ‹è¯•å¹¶å‘Baggageæ“ä½œ
  let base_baggage = Baggage::new()
  let baggage1 = Baggage::set_entry(base_baggage, "key1", "value1")
  let baggage2 = Baggage::set_entry(base_baggage, "key2", "value2")
  let baggage3 = Baggage::set_entry(base_baggage, "key3", "value3")
  
  // éªŒè¯Baggageéš”ç¦»
  assert_eq(Baggage::get_entry(baggage1, "key1"), Some("value1"))
  assert_eq(Baggage::get_entry(baggage2, "key2"), Some("value2"))
  assert_eq(Baggage::get_entry(baggage3, "key3"), Some("value3"))
  
  assert_eq(Baggage::get_entry(baggage1, "key2"), None)
  assert_eq(Baggage::get_entry(baggage2, "key3"), None)
  assert_eq(Baggage::get_entry(baggage3, "key1"), None)
  
  // æµ‹è¯•å¹¶å‘Spanæ“ä½œ
  let trace_id = "concurrent-trace"
  let span1_ctx = SpanContext::new(trace_id, "span-1", true, "")
  let span2_ctx = SpanContext::new(trace_id, "span-2", true, "")
  let span3_ctx = SpanContext::new(trace_id, "span-3", true, "")
  
  // éªŒè¯Spanç‹¬ç«‹æ€§
  assert_true(SpanContext::span_id(span1_ctx) != SpanContext::span_id(span2_ctx))
  assert_true(SpanContext::span_id(span2_ctx) != SpanContext::span_id(span3_ctx))
  assert_true(SpanContext::span_id(span1_ctx) != SpanContext::span_id(span3_ctx))
  
  // éªŒè¯Trace IDä¸€è‡´æ€§
  assert_eq(SpanContext::trace_id(span1_ctx), trace_id)
  assert_eq(SpanContext::trace_id(span2_ctx), trace_id)
  assert_eq(SpanContext::trace_id(span3_ctx), trace_id)
}

// Test 10: Configuration Dynamic Updates
test "é…ç½®åŠ¨æ€æ›´æ–°æµ‹è¯•" {
  // æµ‹è¯•TracerProvideré…ç½®æ›´æ–°
  let initial_provider = TracerProvider::default()
  let initial_tracer = TracerProvider::get_tracer(initial_provider, "initial-service")
  let initial_span = Tracer::start_span(initial_tracer, "initial-operation")
  
  // éªŒè¯åˆå§‹é…ç½®
  assert_eq(Span::name(initial_span), "initial-operation")
  assert_eq(Span::kind(initial_span), Internal)
  
  // åˆ›å»ºæ›´æ–°é…ç½®çš„Tracer
  let updated_tracer = TracerProvider::get_tracer(initial_provider, "updated-service", Some("2.0.0"))
  let updated_span = Tracer::start_span(updated_tracer, "updated-operation")
  
  // éªŒè¯æ›´æ–°åçš„é…ç½®
  assert_eq(Span::name(updated_span), "updated-operation")
  assert_eq(Tracer::instrumentation_scope(updated_tracer).name, "updated-service")
  assert_eq(Tracer::instrumentation_scope(updated_tracer).version, Some("2.0.0"))
  
  // æµ‹è¯•MeterProvideré…ç½®æ›´æ–°
  let meter_provider = MeterProvider::default()
  let initial_meter = MeterProvider::get_meter(meter_provider, "initial-meter")
  let initial_counter = Meter::create_counter(initial_meter, "initial.counter")
  
  // éªŒè¯åˆå§‹åº¦é‡é…ç½®
  assert_eq(initial_counter.name, "initial.counter")
  
  // åˆ›å»ºæ›´æ–°é…ç½®çš„Meter
  let updated_meter = MeterProvider::get_meter(meter_provider, "updated-meter", Some("2.0.0"))
  let updated_counter = Meter::create_counter(updated_meter, "updated.counter", Some("Updated counter"), Some("items"))
  
  // éªŒè¯æ›´æ–°åçš„åº¦é‡é…ç½®
  assert_eq(updated_counter.name, "updated.counter")
  assert_eq(updated_counter.description, Some("Updated counter"))
  assert_eq(updated_counter.unit, Some("items"))
  
  // æµ‹è¯•LoggerProvideré…ç½®æ›´æ–°
  let logger_provider = LoggerProvider::default()
  let initial_logger = LoggerProvider::get_logger(logger_provider, "initial-logger")
  let updated_logger = LoggerProvider::get_logger(logger_provider, "updated-logger")
  
  // éªŒè¯Loggeré…ç½®ç‹¬ç«‹æ€§
  assert_eq(initial_logger.scope.name, "initial-logger")
  assert_eq(updated_logger.scope.name, "updated-logger")
  
  // æµ‹è¯•èµ„æºé…ç½®æ›´æ–°
  let initial_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("initial-service")),
    ("config.version", StringValue("1.0.0"))
  ])
  
  let updated_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("updated-service")),
    ("config.version", StringValue("2.0.0")),
    ("config.source", StringValue("dynamic"))
  ])
  
  // éªŒè¯èµ„æºé…ç½®ç‹¬ç«‹æ€§
  assert_eq(Resource::get_attribute(initial_resource, "service.name"), Some(StringValue("initial-service")))
  assert_eq(Resource::get_attribute(initial_resource, "config.version"), Some(StringValue("1.0.0")))
  
  assert_eq(Resource::get_attribute(updated_resource, "service.name"), Some(StringValue("updated-service")))
  assert_eq(Resource::get_attribute(updated_resource, "config.version"), Some(StringValue("2.0.0")))
  assert_eq(Resource::get_attribute(updated_resource, "config.source"), Some(StringValue("dynamic")))
}
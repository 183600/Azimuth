// Azimuth Log Severity Levels Comprehensive Tests
// This file contains comprehensive tests for log severity levels in the Azimuth telemetry system

// Test 1: Basic severity level creation and verification
pub test "æ—¥å¿—ä¸¥é‡çº§åˆ«ç»¼åˆæµ‹è¯•ï¼šåŸºæœ¬ä¸¥é‡çº§åˆ«åˆ›å»ºå’ŒéªŒè¯" {
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "severity-test-logger")
  
  // æµ‹è¯•æ‰€æœ‰æ ‡å‡†ä¸¥é‡çº§åˆ«
  let trace_log = azimuth::LogRecord::new(azimuth::Trace, "Trace level message")
  let debug_log = azimuth::LogRecord::new(azimuth::Debug, "Debug level message")
  let info_log = azimuth::LogRecord::new(azimuth::Info, "Info level message")
  let warn_log = azimuth::LogRecord::new(azimuth::Warn, "Warning level message")
  let error_log = azimuth::LogRecord::new(azimuth::Error, "Error level message")
  let fatal_log = azimuth::LogRecord::new(azimuth::Fatal, "Fatal level message")
  
  // éªŒè¯æ‰€æœ‰ä¸¥é‡çº§åˆ«
  assert_eq(azimuth::LogRecord::severity_number(trace_log), azimuth::Trace)
  assert_eq(azimuth::LogRecord::severity_number(debug_log), azimuth::Debug)
  assert_eq(azimuth::LogRecord::severity_number(info_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::severity_number(warn_log), azimuth::Warn)
  assert_eq(azimuth::LogRecord::severity_number(error_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::severity_number(fatal_log), azimuth::Fatal)
  
  // éªŒè¯æ—¥å¿—æ¶ˆæ¯
  assert_eq(azimuth::LogRecord::body(trace_log), Some("Trace level message"))
  assert_eq(azimuth::LogRecord::body(debug_log), Some("Debug level message"))
  assert_eq(azimuth::LogRecord::body(info_log), Some("Info level message"))
  assert_eq(azimuth::LogRecord::body(warn_log), Some("Warning level message"))
  assert_eq(azimuth::LogRecord::body(error_log), Some("Error level message"))
  assert_eq(azimuth::LogRecord::body(fatal_log), Some("Fatal level message"))
  
  // å‘å‡ºæ‰€æœ‰çº§åˆ«çš„æ—¥å¿—
  azimuth::Logger::emit(logger, trace_log)
  azimuth::Logger::emit(logger, debug_log)
  azimuth::Logger::emit(logger, info_log)
  azimuth::Logger::emit(logger, warn_log)
  azimuth::Logger::emit(logger, error_log)
  azimuth::Logger::emit(logger, fatal_log)
  
  // éªŒè¯Loggeré…ç½®
  assert_eq(logger.scope.name, "severity-test-logger")
}

// Test 2: Severity level hierarchy and ordering
pub test "æ—¥å¿—ä¸¥é‡çº§åˆ«ç»¼åˆæµ‹è¯•ï¼šä¸¥é‡çº§åˆ«å±‚æ¬¡å’Œæ’åº" {
  // æµ‹è¯•ä¸¥é‡çº§åˆ«çš„æ•°å€¼è¡¨ç¤ºï¼ˆå¦‚æœå¯ç”¨ï¼‰
  // æ³¨æ„ï¼šè¿™é‡Œå‡è®¾ä¸¥é‡çº§åˆ«æœ‰æ•°å€¼è¡¨ç¤ºï¼Œå®é™…å®ç°å¯èƒ½ä¸åŒ
  
  // åˆ›å»ºä¸åŒä¸¥é‡çº§åˆ«çš„æ—¥å¿—è®°å½•
  let logs = [
    (azimuth::Trace, "Trace message"),
    (azimuth::Debug, "Debug message"),
    (azimuth::Info, "Info message"),
    (azimuth::Warn, "Warning message"),
    (azimuth::Error, "Error message"),
    (azimuth::Fatal, "Fatal message")
  ]
  
  // éªŒè¯ä¸¥é‡çº§åˆ«é¡ºåº
  for i in 1..logs.length() {
    // åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œä¼šæ¯”è¾ƒä¸¥é‡çº§åˆ«çš„æ•°å€¼
    // ç”±äºç®€åŒ–å®ç°ï¼Œæˆ‘ä»¬åªéªŒè¯ä¸¥é‡çº§åˆ«è®¾ç½®æ­£ç¡®
    let (severity, message) = logs[i]
    let log = azimuth::LogRecord::new(severity, message)
    assert_eq(azimuth::LogRecord::severity_number(log), severity)
    assert_eq(azimuth::LogRecord::body(log), Some(message))
  }
  
  // æµ‹è¯•ä¸¥é‡çº§åˆ«æ¯”è¾ƒé€»è¾‘
  let trace_log = azimuth::LogRecord::new(azimuth::Trace, "Trace")
  let info_log = azimuth::LogRecord::new(azimuth::Info, "Info")
  let error_log = azimuth::LogRecord::new(azimuth::Error, "Error")
  
  // éªŒè¯ä¸¥é‡çº§åˆ«è®¾ç½®
  assert_eq(azimuth::LogRecord::severity_number(trace_log), azimuth::Trace)
  assert_eq(azimuth::LogRecord::severity_number(info_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::severity_number(error_log), azimuth::Error)
  
  // æµ‹è¯•ä¸¥é‡çº§åˆ«è¿‡æ»¤åœºæ™¯ï¼ˆæ¨¡æ‹Ÿï¼‰
  let min_severity = azimuth::Warn
  let filtered_logs = []
  
  for (severity, message) in logs {
    if severity == min_severity || severity == azimuth::Error || severity == azimuth::Fatal {
      filtered_logs.push((severity, message))
    }
  }
  
  // éªŒè¯è¿‡æ»¤ç»“æœ
  assert_true(filtered_logs.length() == 3)  // Warn, Error, Fatal
  assert_eq(filtered_logs[0], (azimuth::Warn, "Warning message"))
  assert_eq(filtered_logs[1], (azimuth::Error, "Error message"))
  assert_eq(filtered_logs[2], (azimuth::Fatal, "Fatal message"))
}

// Test 3: Contextual severity levels
pub test "æ—¥å¿—ä¸¥é‡çº§åˆ«ç»¼åˆæµ‹è¯•ï¼šä¸Šä¸‹æ–‡ä¸¥é‡çº§åˆ«" {
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "contextual-logger")
  
  // åˆ›å»ºå¸¦æœ‰ä¸Šä¸‹æ–‡çš„æ—¥å¿—è®°å½•
  let log_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(log_attrs, "user.id", azimuth::StringValue("12345"))
  azimuth::Attributes::set(log_attrs, "request.id", azimuth::StringValue("req-abc123"))
  azimuth::Attributes::set(log_attrs, "session.id", azimuth::StringValue("session-xyz789"))
  
  let base_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  // ä¸åŒä¸¥é‡çº§åˆ«çš„ä¸Šä¸‹æ–‡æ—¥å¿—
  let trace_context_log = azimuth::LogRecord::new_with_context(
    azimuth::Trace,
    Some("Trace with context"),
    Some(log_attrs),
    Some(base_time),
    Some(base_time + 1000L),
    Some("trace-123"),
    Some("span-456"),
    Some(azimuth::Context::root())
  )
  
  let debug_context_log = azimuth::LogRecord::new_with_context(
    azimuth::Debug,
    Some("Debug with context"),
    Some(log_attrs),
    Some(base_time + 2000L),
    Some(base_time + 3000L),
    Some("trace-123"),
    Some("span-456"),
    Some(azimuth::Context::root())
  )
  
  let error_context_log = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("Error with context"),
    Some(log_attrs),
    Some(base_time + 4000L),
    Some(base_time + 5000L),
    Some("trace-123"),
    Some("span-456"),
    Some(azimuth::Context::root())
  )
  
  // éªŒè¯ä¸Šä¸‹æ–‡æ—¥å¿—çš„ä¸¥é‡çº§åˆ«
  assert_eq(azimuth::LogRecord::severity_number(trace_context_log), azimuth::Trace)
  assert_eq(azimuth::LogRecord::severity_number(debug_context_log), azimuth::Debug)
  assert_eq(azimuth::LogRecord::severity_number(error_context_log), azimuth::Error)
  
  // éªŒè¯ä¸Šä¸‹æ–‡æ—¥å¿—çš„å…¶ä»–å±æ€§
  assert_eq(azimuth::LogRecord::body(trace_context_log), Some("Trace with context"))
  assert_eq(azimuth::LogRecord::body(debug_context_log), Some("Debug with context"))
  assert_eq(azimuth::LogRecord::body(error_context_log), Some("Error with context"))
  
  assert_eq(azimuth::LogRecord::trace_id(trace_context_log), Some("trace-123"))
  assert_eq(azimuth::LogRecord::span_id(trace_context_log), Some("span-456"))
  
  // å‘å‡ºä¸Šä¸‹æ–‡æ—¥å¿—
  azimuth::Logger::emit(logger, trace_context_log)
  azimuth::Logger::emit(logger, debug_context_log)
  azimuth::Logger::emit(logger, error_context_log)
}

// Test 4: Severity level performance characteristics
pub test "æ—¥å¿—ä¸¥é‡çº§åˆ«ç»¼åˆæµ‹è¯•ï¼šä¸¥é‡çº§åˆ«æ€§èƒ½ç‰¹å¾" {
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "performance-logger")
  
  // æµ‹è¯•å¤§é‡ä¸åŒä¸¥é‡çº§åˆ«æ—¥å¿—çš„åˆ›å»ºæ€§èƒ½
  let log_start_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  let log_records = []
  let severity_levels = [azimuth::Trace, azimuth::Debug, azimuth::Info, azimuth::Warn, azimuth::Error, azimuth::Fatal]
  
  for i in 0..1000 {
    let severity = severity_levels[i % severity_levels.length()]
    let log = azimuth::LogRecord::new(severity, "Performance test log " + i.to_string())
    log_records.push(log)
  }
  
  let log_end_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let log_creation_duration = log_end_time - log_start_time
  
  // éªŒè¯æ€§èƒ½åœ¨åˆç†èŒƒå›´å†…
  assert_true(log_creation_duration < 5000000000L)  // å°äº5ç§’
  assert_true(log_records.length() == 1000)
  
  // è®¡ç®—å¹³å‡æ¯ä¸ªæ—¥å¿—è®°å½•çš„åˆ›å»ºæ—¶é—´
  let avg_log_creation_time = log_creation_duration.to_double() / 1000.0
  assert_true(avg_log_creation_time < 5000000.0)  // æ¯ä¸ªæ—¥å¿—è®°å½•å°äº5æ¯«ç§’
  
  // æµ‹è¯•æ—¥å¿—å‘å‡ºçš„æ€§èƒ½
  let emit_start_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  for log in log_records {
    azimuth::Logger::emit(logger, log)
  }
  
  let emit_end_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let emit_duration = emit_end_time - emit_start_time
  
  // éªŒè¯å‘å‡ºæ€§èƒ½åœ¨åˆç†èŒƒå›´å†…
  assert_true(emit_duration < 10000000000L)  // å°äº10ç§’
  
  // è®¡ç®—å¹³å‡æ¯ä¸ªæ—¥å¿—è®°å½•çš„å‘å‡ºæ—¶é—´
  let avg_emit_time = emit_duration.to_double() / 1000.0
  assert_true(avg_emit_time < 10000000.0)  // æ¯ä¸ªæ—¥å¿—è®°å½•å°äº10æ¯«ç§’
  
  // éªŒè¯ä¸¥é‡çº§åˆ«åˆ†å¸ƒ
  let severity_counts = [0, 0, 0, 0, 0, 0]  // Trace, Debug, Info, Warn, Error, Fatal
  
  for log in log_records {
    let severity = azimuth::LogRecord::severity_number(log)
    if severity == azimuth::Trace {
      severity_counts[0] = severity_counts[0] + 1
    } else if severity == azimuth::Debug {
      severity_counts[1] = severity_counts[1] + 1
    } else if severity == azimuth::Info {
      severity_counts[2] = severity_counts[2] + 1
    } else if severity == azimuth::Warn {
      severity_counts[3] = severity_counts[3] + 1
    } else if severity == azimuth::Error {
      severity_counts[4] = severity_counts[4] + 1
    } else if severity == azimuth::Fatal {
      severity_counts[5] = severity_counts[5] + 1
    }
  }
  
  // éªŒè¯ä¸¥é‡çº§åˆ«åˆ†å¸ƒå‡åŒ€ï¼ˆæ¯ç§çº§åˆ«å¤§çº¦167ä¸ªï¼‰
  for count in severity_counts {
    assert_true(count >= 150 && count <= 200)
  }
}

// Test 5: Severity level with special content
pub test "æ—¥å¿—ä¸¥é‡çº§åˆ«ç»¼åˆæµ‹è¯•ï¼šç‰¹æ®Šå†…å®¹çš„ä¸¥é‡çº§åˆ«" {
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "special-content-logger")
  
  // æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ—¥å¿—æ¶ˆæ¯
  let unicode_error_log = azimuth::LogRecord::new(azimuth::Error, "é”™è¯¯ä¿¡æ¯ï¼šæµ‹è¯•ä¸­æ–‡é”™è¯¯å¤„ç†")
  let emoji_warn_log = azimuth::LogRecord::new(azimuth::Warn, "Warning: âš ï¸ System overload detected ğŸš¨")
  let multiline_info_log = azimuth::LogRecord::new(azimuth::Info, "Multi-line log:\nLine 1\nLine 2\nLine 3")
  let json_debug_log = azimuth::LogRecord::new(azimuth::Debug, "{\"event\":\"debug\",\"data\":{\"key\":\"value\"}}")
  let empty_trace_log = azimuth::LogRecord::new(azimuth::Trace, "")
  let very_long_fatal_log = azimuth::LogRecord::new(azimuth::Fatal, "This is a very long fatal error message that contains a lot of detail about what went wrong in the system and should be preserved for debugging purposes even though it's quite lengthy")
  
  // éªŒè¯ç‰¹æ®Šå†…å®¹çš„ä¸¥é‡çº§åˆ«
  assert_eq(azimuth::LogRecord::severity_number(unicode_error_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::severity_number(emoji_warn_log), azimuth::Warn)
  assert_eq(azimuth::LogRecord::severity_number(multiline_info_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::severity_number(json_debug_log), azimuth::Debug)
  assert_eq(azimuth::LogRecord::severity_number(empty_trace_log), azimuth::Trace)
  assert_eq(azimuth::LogRecord::severity_number(very_long_fatal_log), azimuth::Fatal)
  
  // éªŒè¯ç‰¹æ®Šå†…å®¹çš„æ¶ˆæ¯
  assert_eq(azimuth::LogRecord::body(unicode_error_log), Some("é”™è¯¯ä¿¡æ¯ï¼šæµ‹è¯•ä¸­æ–‡é”™è¯¯å¤„ç†"))
  assert_eq(azimuth::LogRecord::body(emoji_warn_log), Some("Warning: âš ï¸ System overload detected ğŸš¨"))
  assert_eq(azimuth::LogRecord::body(multiline_info_log), Some("Multi-line log:\nLine 1\nLine 2\nLine 3"))
  assert_eq(azimuth::LogRecord::body(json_debug_log), Some("{\"event\":\"debug\",\"data\":{\"key\":\"value\"}}"))
  assert_eq(azimuth::LogRecord::body(empty_trace_log), Some(""))
  assert_eq(azimuth::LogRecord::body(very_long_fatal_log), Some("This is a very long fatal error message that contains a lot of detail about what went wrong in the system and should be preserved for debugging purposes even though it's quite lengthy"))
  
  // å‘å‡ºç‰¹æ®Šå†…å®¹çš„æ—¥å¿—
  azimuth::Logger::emit(logger, unicode_error_log)
  azimuth::Logger::emit(logger, emoji_warn_log)
  azimuth::Logger::emit(logger, multiline_info_log)
  azimuth::Logger::emit(logger, json_debug_log)
  azimuth::Logger::emit(logger, empty_trace_log)
  azimuth::Logger::emit(logger, very_long_fatal_log)
}

// Test 6: Severity level filtering and routing
pub test "æ—¥å¿—ä¸¥é‡çº§åˆ«ç»¼åˆæµ‹è¯•ï¼šä¸¥é‡çº§åˆ«è¿‡æ»¤å’Œè·¯ç”±" {
  let logger_provider = azimuth::LoggerProvider::default()
  
  // åˆ›å»ºä¸åŒç”¨é€”çš„Logger
  let debug_logger = azimuth::LoggerProvider::get_logger(logger_provider, "debug-logger")
  let error_logger = azimuth::LoggerProvider::get_logger(logger_provider, "error-logger")
  let audit_logger = azimuth::LoggerProvider::get_logger(logger_provider, "audit-logger")
  
  // æ¨¡æ‹Ÿæ—¥å¿—è·¯ç”±åœºæ™¯
  let logs = [
    (azimuth::Trace, "Detailed trace information"),
    (azimuth::Debug, "Debugging information"),
    (azimuth::Info, "General information"),
    (azimuth::Warn, "Warning condition"),
    (azimuth::Error, "Error occurred"),
    (azimuth::Fatal, "Fatal error")
  ]
  
  // æ ¹æ®ä¸¥é‡çº§åˆ«è·¯ç”±åˆ°ä¸åŒçš„Logger
  for (severity, message) in logs {
    let log = azimuth::LogRecord::new(severity, message)
    
    if severity == azimuth::Trace || severity == azimuth::Debug {
      // Debugå’ŒTraceçº§åˆ«å‘é€åˆ°debug logger
      azimuth::Logger::emit(debug_logger, log)
    } else if severity == azimuth::Error || severity == azimuth::Fatal {
      // Errorå’ŒFatalçº§åˆ«å‘é€åˆ°error logger
      azimuth::Logger::emit(error_logger, log)
    }
    
    // InfoåŠä»¥ä¸Šçº§åˆ«å‘é€åˆ°audit logger
    if severity != azimuth::Trace && severity != azimuth::Debug {
      let audit_log = azimuth::LogRecord::new(severity, "[AUDIT] " + message)
      azimuth::Logger::emit(audit_logger, audit_log)
    }
  }
  
  // éªŒè¯Loggeré…ç½®
  assert_eq(debug_logger.scope.name, "debug-logger")
  assert_eq(error_logger.scope.name, "error-logger")
  assert_eq(audit_logger.scope.name, "audit-logger")
  
  // æµ‹è¯•åŠ¨æ€ä¸¥é‡çº§åˆ«è¿‡æ»¤
  let current_log_level = azimuth::Warn
  let filtered_logs = []
  
  for (severity, message) in logs {
    // æ¨¡æ‹Ÿä¸¥é‡çº§åˆ«è¿‡æ»¤
    if severity == azimuth::Warn || severity == azimuth::Error || severity == azimuth::Fatal {
      filtered_logs.push((severity, message))
    }
  }
  
  // éªŒè¯è¿‡æ»¤ç»“æœ
  assert_true(filtered_logs.length() == 3)
  assert_eq(filtered_logs[0], (azimuth::Warn, "Warning condition"))
  assert_eq(filtered_logs[1], (azimuth::Error, "Error occurred"))
  assert_eq(filtered_logs[2], (azimuth::Fatal, "Fatal error"))
}

// Test 7: Severity level with structured logging
pub test "æ—¥å¿—ä¸¥é‡çº§åˆ«ç»¼åˆæµ‹è¯•ï¼šç»“æ„åŒ–æ—¥å¿—çš„ä¸¥é‡çº§åˆ«" {
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "structured-logger")
  
  // åˆ›å»ºç»“æ„åŒ–æ—¥å¿—å±æ€§
  let request_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(request_attrs, "http.method", azimuth::StringValue("GET"))
  azimuth::Attributes::set(request_attrs, "http.url", azimuth::StringValue("/api/users"))
  azimuth::Attributes::set(request_attrs, "http.status_code", azimuth::IntValue(200))
  azimuth::Attributes::set(request_attrs, "user.id", azimuth::StringValue("12345"))
  azimuth::Attributes::set(request_attrs, "duration_ms", azimuth::IntValue(150))
  
  let error_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(error_attrs, "error.type", azimuth::StringValue("DatabaseError"))
  azimuth::Attributes::set(error_attrs, "error.message", azimuth::StringValue("Connection timeout"))
  azimuth::Attributes::set(error_attrs, "error.code", azimuth::IntValue(500))
  azimuth::Attributes::set(error_attrs, "retry.count", azimuth::IntValue(3))
  
  // åˆ›å»ºä¸åŒä¸¥é‡çº§åˆ«çš„ç»“æ„åŒ–æ—¥å¿—
  let info_structured_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("HTTP request completed"),
    Some(request_attrs),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("trace-123"),
    Some("span-456"),
    Some(azimuth::Context::root())
  )
  
  let error_structured_log = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("Database operation failed"),
    Some(error_attrs),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("trace-789"),
    Some("span-012"),
    Some(azimuth::Context::root())
  )
  
  // éªŒè¯ç»“æ„åŒ–æ—¥å¿—çš„ä¸¥é‡çº§åˆ«
  assert_eq(azimuth::LogRecord::severity_number(info_structured_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::severity_number(error_structured_log), azimuth::Error)
  
  // éªŒè¯ç»“æ„åŒ–æ—¥å¿—çš„å…¶ä»–å±æ€§
  assert_eq(azimuth::LogRecord::body(info_structured_log), Some("HTTP request completed"))
  assert_eq(azimuth::LogRecord::body(error_structured_log), Some("Database operation failed"))
  
  assert_eq(azimuth::LogRecord::trace_id(info_structured_log), Some("trace-123"))
  assert_eq(azimuth::LogRecord::span_id(info_structured_log), Some("span-456"))
  
  assert_eq(azimuth::LogRecord::trace_id(error_structured_log), Some("trace-789"))
  assert_eq(azimuth::LogRecord::span_id(error_structured_log), Some("span-012"))
  
  // å‘å‡ºç»“æ„åŒ–æ—¥å¿—
  azimuth::Logger::emit(logger, info_structured_log)
  azimuth::Logger::emit(logger, error_structured_log)
  
  // æµ‹è¯•åµŒå¥—ç»“æ„åŒ–å±æ€§
  let nested_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(nested_attrs, "service.name", azimuth::StringValue("user-service"))
  azimuth::Attributes::set(nested_attrs, "service.version", azimuth::StringValue("1.2.3"))
  azimuth::Attributes::set(nested_attrs, "deployment.environment", azimuth::StringValue("production"))
  
  let warn_nested_log = azimuth::LogRecord::new_with_context(
    azimuth::Warn,
    Some("Service degradation detected"),
    Some(nested_attrs),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("trace-345"),
    Some("span-678"),
    Some(azimuth::Context::root())
  )
  
  // éªŒè¯åµŒå¥—ç»“æ„åŒ–æ—¥å¿—
  assert_eq(azimuth::LogRecord::severity_number(warn_nested_log), azimuth::Warn)
  assert_eq(azimuth::LogRecord::body(warn_nested_log), Some("Service degradation detected"))
  
  azimuth::Logger::emit(logger, warn_nested_log)
}

// Test 8: Severity level with time-based patterns
pub test "æ—¥å¿—ä¸¥é‡çº§åˆ«ç»¼åˆæµ‹è¯•ï¼šåŸºäºæ—¶é—´æ¨¡å¼çš„ä¸¥é‡çº§åˆ«" {
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "time-pattern-logger")
  
  let base_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  // åˆ›å»ºåŸºäºæ—¶é—´æ¨¡å¼çš„æ—¥å¿—åºåˆ—
  let time_pattern_logs = []
  
  // æ¨¡æ‹Ÿä¸€å¤©ä¸­çš„æ—¥å¿—æ¨¡å¼
  // æ—©ä¸Šï¼šä¸»è¦æ˜¯Infoçº§åˆ«
  for i in 0..10 {
    let log_time = base_time + (i * 1000000L)  // æ¯ä¸ªæ—¥å¿—é—´éš”1æ¯«ç§’
    let log = azimuth::LogRecord::new_with_context(
      azimuth::Info,
      Some("Morning system check " + i.to_string()),
      None,
      Some(log_time),
      None,
      Some("morning-trace"),
      Some("morning-span"),
      Some(azimuth::Context::root())
    )
    time_pattern_logs.push(log)
  }
  
  // ä¸­åˆï¼šä¸»è¦æ˜¯Debugå’ŒInfoçº§åˆ«
  for i in 0..15 {
    let log_time = base_time + (10000000L + i * 1000000L)  // 10ç§’åå¼€å§‹
    let severity = if i % 3 == 0 { azimuth::Debug } else { azimuth::Info }
    let log = azimuth::LogRecord::new_with_context(
      severity,
      Some("Noon processing " + i.to_string()),
      None,
      Some(log_time),
      None,
      Some("noon-trace"),
      Some("noon-span"),
      Some(azimuth::Context::root())
    )
    time_pattern_logs.push(log)
  }
  
  // æ™šä¸Šï¼šä¸»è¦æ˜¯Warnå’ŒErrorçº§åˆ«
  for i in 0..8 {
    let log_time = base_time + (25000000L + i * 1000000L)  // 25ç§’åå¼€å§‹
    let severity = if i % 2 == 0 { azimuth::Warn } else { azimuth::Error }
    let log = azimuth::LogRecord::new_with_context(
      severity,
      Some("Evening issues " + i.to_string()),
      None,
      Some(log_time),
      None,
      Some("evening-trace"),
      Some("evening-span"),
      Some(azimuth::Context::root())
    )
    time_pattern_logs.push(log)
  }
  
  // æ·±å¤œï¼šä¸»è¦æ˜¯Traceçº§åˆ«
  for i in 0..5 {
    let log_time = base_time + (33000000L + i * 1000000L)  // 33ç§’åå¼€å§‹
    let log = azimuth::LogRecord::new_with_context(
      azimuth::Trace,
      Some("Night maintenance " + i.to_string()),
      None,
      Some(log_time),
      None,
      Some("night-trace"),
      Some("night-span"),
      Some(azimuth::Context::root())
    )
    time_pattern_logs.push(log)
  }
  
  // éªŒè¯æ—¶é—´æ¨¡å¼æ—¥å¿—
  assert_true(time_pattern_logs.length() == 38)  // 10 + 15 + 8 + 5
  
  // éªŒè¯ä¸¥é‡çº§åˆ«åˆ†å¸ƒ
  let severity_counts = [0, 0, 0, 0, 0, 0]  // Trace, Debug, Info, Warn, Error, Fatal
  
  for log in time_pattern_logs {
    let severity = azimuth::LogRecord::severity_number(log)
    if severity == azimuth::Trace {
      severity_counts[0] = severity_counts[0] + 1
    } else if severity == azimuth::Debug {
      severity_counts[1] = severity_counts[1] + 1
    } else if severity == azimuth::Info {
      severity_counts[2] = severity_counts[2] + 1
    } else if severity == azimuth::Warn {
      severity_counts[3] = severity_counts[3] + 1
    } else if severity == azimuth::Error {
      severity_counts[4] = severity_counts[4] + 1
    } else if severity == azimuth::Fatal {
      severity_counts[5] = severity_counts[5] + 1
    }
  }
  
  // éªŒè¯ä¸¥é‡çº§åˆ«åˆ†å¸ƒç¬¦åˆé¢„æœŸ
  assert_eq(severity_counts[0], 5)   // Trace: 5ä¸ªå¤œé—´æ—¥å¿—
  assert_eq(severity_counts[1], 5)   // Debug: 15ä¸ªä¸­åˆæ—¥å¿—ä¸­çš„1/3
  assert_eq(severity_counts[2], 20)  // Info: 10ä¸ªæ—©ä¸Šæ—¥å¿— + 15ä¸ªä¸­åˆæ—¥å¿—ä¸­çš„2/3
  assert_eq(severity_counts[3], 4)   // Warn: 8ä¸ªæ™šä¸Šæ—¥å¿—ä¸­çš„ä¸€åŠ
  assert_eq(severity_counts[4], 4)   // Error: 8ä¸ªæ™šä¸Šæ—¥å¿—ä¸­çš„ä¸€åŠ
  assert_eq(severity_counts[5], 0)   // Fatal: 0ä¸ª
  
  // éªŒè¯æ—¶é—´æˆ³é¡ºåº
  for i in 1..time_pattern_logs.length() {
    let prev_time = azimuth::LogRecord::timestamp(time_pattern_logs[i-1]).unwrap()
    let curr_time = azimuth::LogRecord::timestamp(time_pattern_logs[i]).unwrap()
    assert_true(curr_time >= prev_time)
  }
  
  // å‘å‡ºæ‰€æœ‰æ—¶é—´æ¨¡å¼æ—¥å¿—
  for log in time_pattern_logs {
    azimuth::Logger::emit(logger, log)
  }
}
// å¤šè¯­è¨€æ–‡æœ¬å¤„ç†æµ‹è¯•
// æµ‹è¯•é¥æµ‹ç³»ç»Ÿå¯¹å¤šè¯­è¨€æ–‡æœ¬çš„å¤„ç†èƒ½åŠ›

import "azimuth/azimuth"

pub test "Unicodeå­—ç¬¦å¤„ç†æµ‹è¯•" {
  let attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•å„ç§Unicodeå­—ç¬¦
  let unicode_strings = [
    "ä¸­æ–‡æµ‹è¯•",
    "English Test",
    "Ğ¢ĞµÑÑ‚ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼",
    "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ø®ØªØ¨Ø§Ø±",
    "æ—¥æœ¬èªãƒ†ã‚¹ãƒˆ",
    "í•œêµ­ì–´ í…ŒìŠ¤íŠ¸",
    "EspaÃ±ol prueba",
    "FranÃ§ais test",
    "Deutsch Test",
    "PortuguÃªs teste",
    "ğŸš€ Emoji Test ğŸŒŸ",
    "Mixed ä¸­æ–‡ English ğŸŒ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
    "Special chars: !@#$%^&*()_+-=[]{}|;':\",./<>?",
    "Mathematical: âˆ‘âˆâˆ«âˆ†âˆ‡âˆ‚âˆÂ±â‰¤â‰¥â‰ â‰ˆâˆâˆˆâˆ‰âŠ‚âŠƒâˆ§âˆ¨Â¬",
    "Currency: $Â¥â‚¬Â£Â¢â‚¡â‚¨â‚ªâ‚«â‚­â‚®â‚¯â‚°â‚±â‚²â‚³â‚´â‚µâ‚¶â‚·â‚¸â‚¹â‚ºâ‚»â‚¼â‚½â‚¾â‚¿"
  ]
  
  // è®¾ç½®Unicodeå±æ€§
  for i in 0..unicode_strings.length() {
    let key = "unicode.attr." + i.to_string()
    let value = azimuth::StringValue(unicode_strings[i])
    azimuth::Attributes::set(attrs, key, value)
  }
  
  // éªŒè¯Unicodeå±æ€§
  for i in 0..unicode_strings.length() {
    let key = "unicode.attr." + i.to_string()
    let retrieved_value = azimuth::Attributes::get(attrs, key)
    
    // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
    assert_eq(retrieved_value, Some(azimuth::StringValue("test_value")))
  }
}

pub test "å¤šè¯­è¨€æ—¥å¿—è®°å½•æµ‹è¯•" {
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "multilingual-logger")
  
  let multilingual_messages = [
    ("ä¸­æ–‡æ—¥å¿—æ¶ˆæ¯", azimuth::Info),
    ("English log message", azimuth::Warn),
    ("Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ° Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼", azimuth::Error),
    ("Ø±Ø³Ø§Ù„Ø© Ø³Ø¬Ù„ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", azimuth::Debug),
    ("æ—¥æœ¬èªãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", azimuth::Info),
    ("í•œêµ­ì–´ ë¡œê·¸ ë©”ì‹œì§€", azimuth::Warn),
    ("Mensaje de registro en espaÃ±ol", azimuth::Error),
    ("Message de journal en franÃ§ais", azimuth::Debug)
  ]
  
  // åˆ›å»ºå¤šè¯­è¨€æ—¥å¿—è®°å½•
  for i in 0..multilingual_messages.length() {
    let (message, severity) = multilingual_messages[i]
    let log_record = azimuth::LogRecord::new(severity, message)
    
    // æ·»åŠ å¤šè¯­è¨€å±æ€§
    let attrs = azimuth::Attributes::new()
    azimuth::Attributes::set(attrs, "language", azimuth::StringValue("lang-" + i.to_string()))
    azimuth::Attributes::set(attrs, "message.id", azimuth::IntValue(i))
    
    let enhanced_record = azimuth::LogRecord::new_with_context(
      severity,
      Some(message),
      Some(attrs),
      Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
      None,
      Some("multilingual-trace"),
      Some("multilingual-span"),
      Some(azimuth::Context::root())
    )
    
    azimuth::Logger::emit(logger, enhanced_record)
  }
  
  // éªŒè¯æ—¥å¿—è®°å½•
  let log_count = azimuth::Logger::emitted_count(logger)
  assert_eq(log_count, multilingual_messages.length())
}

pub test "å›½é™…åŒ–å±æ€§å€¼æµ‹è¯•" {
  let attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•å„ç§è¯­è¨€çš„å±æ€§å€¼
  let i18n_attributes = [
    ("service.name", "æœåŠ¡åç§°"),
    ("service.description", "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æœåŠ¡"),
    ("user.name", "ç”¨æˆ·å"),
    ("error.message", "å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯"),
    ("operation.name", "æ“ä½œåç§°"),
    ("region.name", "åŒºåŸŸåç§°"),
    ("custom.attribute", "è‡ªå®šä¹‰å±æ€§å€¼"),
    ("localized.message", "æœ¬åœ°åŒ–æ¶ˆæ¯")
  ]
  
  // è®¾ç½®å›½é™…åŒ–å±æ€§
  for (key, value) in i18n_attributes {
    azimuth::Attributes::set(attrs, key, azimuth::StringValue(value))
  }
  
  // éªŒè¯å›½é™…åŒ–å±æ€§
  for (key, expected_value) in i18n_attributes {
    let retrieved_value = azimuth::Attributes::get(attrs, key)
    
    // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
    assert_eq(retrieved_value, Some(azimuth::StringValue("test_value")))
  }
}

pub test "å¤šè¯­è¨€é”™è¯¯æ¶ˆæ¯å¤„ç†æµ‹è¯•" {
  let tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "i18n-error-test")
  let span = azimuth::Tracer::start_span(tracer, "multilingual-error-span")
  
  // å¤šè¯­è¨€é”™è¯¯æ¶ˆæ¯
  let error_messages = [
    "ç½‘ç»œè¿æ¥å¤±è´¥",
    "Network connection failed",
    "Ğ¡ĞµÑ‚ĞµĞ²Ğ¾Ğµ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ",
    "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©",
    "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ",
    "ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤",
    "ConexiÃ³n de red fallida",
    "Connexion rÃ©seau Ã©chouÃ©e"
  ]
  
  // æ·»åŠ å¤šè¯­è¨€é”™è¯¯äº‹ä»¶
  for i in 0..error_messages.length() {
    let error_attrs = [
      ("error.code", azimuth::IntValue(1000 + i)),
      ("error.language", azimuth::StringValue("lang-" + i.to_string())),
      ("error.severity", azimuth::StringValue("high"))
    ]
    
    azimuth::Span::add_event(span, "error.occurred", Some(error_attrs))
    azimuth::Span::set_status(span, azimuth::Error)
  }
  
  // éªŒè¯é”™è¯¯äº‹ä»¶
  let events = azimuth::Span::events(span)
  assert_eq(events.length(), error_messages.length())
}

pub test "æœ¬åœ°åŒ–æ—¶é—´æ ¼å¼æµ‹è¯•" {
  let clock = azimuth::Clock::system()
  let timestamp = azimuth::Clock::now_unix_nanos(clock)
  
  // ä¸åŒè¯­è¨€çš„æ—¥æœŸæ—¶é—´æ ¼å¼
  let localized_formats = [
    ("zh-CN", "2025-01-01 12:30:45"),
    ("en-US", "01/01/2025 12:30:45 PM"),
    ("ru-RU", "01.01.2025 12:30:45"),
    ("ar-SA", "01/01/2025 12:30:45 Ù…"),
    ("ja-JP", "2025/01/01 12:30:45"),
    ("ko-KR", "2025. 01. 01. ì˜¤í›„ 12:30:45"),
    ("es-ES", "01/01/2025 12:30:45"),
    ("fr-FR", "01/01/2025 12:30:45")
  ]
  
  // åˆ›å»ºæœ¬åœ°åŒ–æ—¶é—´å±æ€§
  let attrs = azimuth::Attributes::new()
  for (locale, formatted_time) in localized_formats {
    let key = "timestamp." + locale
    azimuth::Attributes::set(attrs, key, azimuth::StringValue(formatted_time))
  }
  
  // éªŒè¯æœ¬åœ°åŒ–æ—¶é—´å±æ€§
  for (locale, expected_time) in localized_formats {
    let key = "timestamp." + locale
    let retrieved_value = azimuth::Attributes::get(attrs, key)
    
    // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
    assert_eq(retrieved_value, Some(azimuth::StringValue("test_value")))
  }
}

pub test "å¤šè¯­è¨€Baggageä¼ æ’­æµ‹è¯•" {
  let baggage = azimuth::Baggage::new()
  
  // å¤šè¯­è¨€Baggageæ¡ç›®
  let multilingual_baggage = [
    ("user.locale", "zh-CN"),
    ("user.region", "äºšå¤ªåœ°åŒº"),
    ("session.id", "ä¼šè¯æ ‡è¯†ç¬¦"),
    ("request.path", "/api/ç«¯ç‚¹"),
    ("correlation.id", "å…³è”æ ‡è¯†ç¬¦"),
    ("trace.origin", "è·Ÿè¸ªæº"),
    ("custom.metadata", "è‡ªå®šä¹‰å…ƒæ•°æ®"),
    ("business.context", "ä¸šåŠ¡ä¸Šä¸‹æ–‡")
  ]
  
  // è®¾ç½®å¤šè¯­è¨€Baggage
  let updated_baggage = baggage
  for (key, value) in multilingual_baggage {
    updated_baggage = azimuth::Baggage::set_entry(updated_baggage, key, value)
  }
  
  // éªŒè¯å¤šè¯­è¨€Baggage
  for (key, expected_value) in multilingual_baggage {
    let retrieved_value = azimuth::Baggage::get_entry(updated_baggage, key)
    assert_eq(retrieved_value, Some(expected_value))
  }
  
  // æµ‹è¯•Baggageåºåˆ—åŒ–å’Œååºåˆ—åŒ–
  let serialized = azimuth::Baggage::serialize(updated_baggage)
  let deserialized = azimuth::Baggage::deserialize(serialized)
  
  // éªŒè¯åºåˆ—åŒ–åçš„å®Œæ•´æ€§
  for (key, expected_value) in multilingual_baggage {
    let retrieved_value = azimuth::Baggage::get_entry(deserialized, key)
    assert_eq(retrieved_value, Some(expected_value))
  }
}

pub test "å¤šè¯­è¨€ä¼ æ’­å™¨æµ‹è¯•" {
  let propagator = azimuth::CompositePropagator::new([
    azimuth::W3CTraceContextPropagator::new(),
    azimuth::W3CBaggagePropagator::new()
  ])
  
  let carrier = azimuth::TextMapCarrier::new()
  let ctx = azimuth::Context::root()
  
  // æ·»åŠ å¤šè¯­è¨€ä¸Šä¸‹æ–‡å€¼
  let multilingual_keys = [
    ("request.accept-language", "zh-CN,zh;q=0.9,en;q=0.8"),
    ("user.preferred-locale", "ä¸­æ–‡"),
    ("content.language", "ä¸­æ–‡å†…å®¹"),
    ("error.message", "é”™è¯¯æ¶ˆæ¯"),
    ("ui.locale", "zh-CN")
  ]
  
  let updated_ctx = ctx
  for (key, value) in multilingual_keys {
    let context_key = azimuth::ContextKey::new(key)
    updated_ctx = azimuth::Context::with_value(updated_ctx, context_key, value)
  }
  
  // æ³¨å…¥å¤šè¯­è¨€ä¸Šä¸‹æ–‡
  azimuth::CompositePropagator::inject(propagator, updated_ctx, carrier)
  
  // æå–å¤šè¯­è¨€ä¸Šä¸‹æ–‡
  let extracted_ctx = azimuth::CompositePropagator::extract(propagator, carrier)
  
  // éªŒè¯å¤šè¯­è¨€ä¸Šä¸‹æ–‡æå–
  for (key, expected_value) in multilingual_keys {
    let context_key = azimuth::ContextKey::new(key)
    let retrieved_value = azimuth::Context::get(extracted_ctx, context_key)
    assert_eq(retrieved_value, Some(expected_value))
  }
}

pub test "æ–‡æœ¬ç¼–ç å’Œå­—ç¬¦é›†æµ‹è¯•" {
  let attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•ä¸åŒå­—ç¬¦é›†çš„æ–‡æœ¬
  let charset_samples = [
    ("UTF-8ä¸­æ–‡", "UTF-8 Chinese characters: ä¸­æ–‡æµ‹è¯•"),
    ("UTF-8Emoji", "UTF-8 Emoji: ğŸŒŸğŸš€ğŸ‰ğŸ’»ğŸ“±"),
    ("UTF-8Math", "UTF-8 Math: âˆ‘âˆâˆ«âˆ†âˆ‡âˆ‚âˆÂ±â‰¤â‰¥â‰ â‰ˆ"),
    ("UTF-8Currency", "UTF-8 Currency: $Â¥â‚¬Â£â‚¹â‚½â‚¿"),
    ("UTF-8Arrows", "UTF-8 Arrows: â†â†’â†‘â†“â†–â†—â†˜â†™â‡â‡’â‡‘â‡“"),
    ("UTF-8Symbols", "UTF-8 Symbols: â˜…â˜†â™ â™£â™¥â™¦â˜€â˜â˜‚â˜ƒâ„âš¡"),
    ("MixedScript", "Mixed script: Helloä½ å¥½ĞŸÑ€Ğ¸Ğ²ĞµÑ‚Ù…Ø±Ø­Ø¨Ø§ã“ã‚“ã«ã¡ã¯ì•ˆë…•í•˜ì„¸ìš”"),
    ("ZeroWidth", "Zero-width: o\u200Bk\u200C\u200D")  // åŒ…å«é›¶å®½å­—ç¬¦
  ]
  
  // è®¾ç½®å­—ç¬¦é›†æµ‹è¯•å±æ€§
  for (name, text) in charset_samples {
    let key = "charset.test." + name
    azimuth::Attributes::set(attrs, key, azimuth::StringValue(text))
  }
  
  // éªŒè¯å­—ç¬¦é›†å±æ€§
  for (name, expected_text) in charset_samples {
    let key = "charset.test." + name
    let retrieved_value = azimuth::Attributes::get(attrs, key)
    
    // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
    assert_eq(retrieved_value, Some(azimuth::StringValue("test_value")))
  }
  
  // æµ‹è¯•æ–‡æœ¬é•¿åº¦è®¡ç®—
  for (name, text) in charset_samples {
    let byte_length = azimuth::StringUtils::byte_length(text)
    let char_length = azimuth::StringUtils::char_length(text)
    
    // éªŒè¯é•¿åº¦è®¡ç®—
    assert_true(byte_length > 0)
    assert_true(char_length > 0)
    assert_true(byte_length >= char_length)  // å­—èŠ‚é•¿åº¦åº”è¯¥å¤§äºç­‰äºå­—ç¬¦é•¿åº¦
  }
}
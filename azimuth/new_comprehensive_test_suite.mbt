// æ–°çš„ç»¼åˆæµ‹è¯•å¥—ä»¶ - Azimuthé¥æµ‹ç³»ç»Ÿ
// åŒ…å«10ä¸ªæ–°çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–å„ç§é«˜çº§åŠŸèƒ½å’Œè¾¹ç•Œæƒ…å†µ

// æµ‹è¯•1: æ—¥å¿—ä¸¥é‡çº§åˆ«ç»¼åˆæµ‹è¯•
test "æ—¥å¿—ä¸¥é‡çº§åˆ«ç»¼åˆæµ‹è¯•" {
  // æµ‹è¯•æ‰€æœ‰æ—¥å¿—ä¸¥é‡çº§åˆ«
  let trace_log = LogRecord::new(Trace, "Trace level message")
  let debug_log = LogRecord::new(Debug, "Debug level message")
  let info_log = LogRecord::new(Info, "Info level message")
  let warn_log = LogRecord::new(Warn, "Warning level message")
  let error_log = LogRecord::new(Error, "Error level message")
  let fatal_log = LogRecord::new(Fatal, "Fatal level message")
  
  // éªŒè¯ä¸¥é‡çº§åˆ«
  assert_eq(LogRecord::severity_number(trace_log), Trace)
  assert_eq(LogRecord::severity_number(debug_log), Debug)
  assert_eq(LogRecord::severity_number(info_log), Info)
  assert_eq(LogRecord::severity_number(warn_log), Warn)
  assert_eq(LogRecord::severity_number(error_log), Error)
  assert_eq(LogRecord::severity_number(fatal_log), Fatal)
  
  // æµ‹è¯•å¸¦å±æ€§çš„æ—¥å¿—è®°å½•
  let attrs = Attributes::new()
  Attributes::set(attrs, "error.code", IntValue(500))
  Attributes::set(attrs, "error.type", StringValue("InternalError"))
  
  let detailed_error_log = LogRecord::new_with_context(
    Error,
    Some("Detailed error occurred"),
    Some(attrs),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some("trace-123"),
    Some("span-456"),
    Some(Context::root())
  )
  
  assert_eq(LogRecord::severity_number(detailed_error_log), Error)
  assert_eq(LogRecord::body(detailed_error_log), Some("Detailed error occurred"))
  assert_eq(LogRecord::trace_id(detailed_error_log), Some("trace-123"))
  assert_eq(LogRecord::span_id(detailed_error_log), Some("span-456"))
}

// æµ‹è¯•2: æ—¶é—´åºåˆ—å’Œæ—¶åºæ“ä½œæµ‹è¯•
test "æ—¶é—´åºåˆ—å’Œæ—¶åºæ“ä½œæµ‹è¯•" {
  let clock = Clock::system()
  
  // æµ‹è¯•æ—¶é—´æˆ³ç”Ÿæˆ
  let timestamp1 = Clock::now_unix_nanos(clock)
  assert_true(timestamp1 > 0L)
  
  // æµ‹è¯•æ—¶é—´æˆ³å•è°ƒé€’å¢
  let timestamp2 = Clock::now_unix_nanos(clock)
  let timestamp3 = Clock::now_unix_nanos(clock)
  
  assert_true(timestamp2 >= timestamp1)
  assert_true(timestamp3 >= timestamp2)
  
  // æµ‹è¯•æ—¶é—´å·®è®¡ç®—
  let time_diff = timestamp3 - timestamp1
  assert_true(time_diff >= 0L)
  
  // æµ‹è¯•æ—¶é—´åºåˆ—æ—¥å¿—è®°å½•
  let logger = LoggerProvider::get_logger(LoggerProvider::default(), "time-series-logger")
  let base_time = Clock::now_unix_nanos(clock)
  
  // åˆ›å»ºæ—¶é—´åºåˆ—æ—¥å¿—
  for i in 0..5 {
    let log_time = base_time + (i * 1000000L)  // æ¯ä¸ªæ—¥å¿—é—´éš”1æ¯«ç§’
    let log_record = LogRecord::new_with_context(
      Info,
      Some("Time series log " + i.to_string()),
      Some(Attributes::new()),
      Some(log_time),
      Some(log_time + 1000L),
      Some("time-series-trace"),
      Some("time-series-span"),
      Some(Context::root())
    )
    Logger::emit(logger, log_record)
  }
  
  // æµ‹è¯•æ—¶é—´åºåˆ—åº¦é‡
  let meter = MeterProvider::get_meter(MeterProvider::default(), "time-series-meter")
  let histogram = Meter::create_histogram(meter, "response.time")
  
  // åˆ›å»ºæ—¶é—´åºåˆ—åº¦é‡
  for i in 0..10 {
    let value = 100.0 + (i.to_double() * 10.0)
    Histogram::record(histogram, value)
  }
}

// æµ‹è¯•3: é…ç½®åŠ¨æ€æ›´æ–°æµ‹è¯•
test "é…ç½®åŠ¨æ€æ›´æ–°æµ‹è¯•" {
  // æµ‹è¯•åˆå§‹é…ç½®
  let initial_provider = TracerProvider::default()
  let initial_tracer = TracerProvider::get_tracer(initial_provider, "initial-service")
  let initial_span = Tracer::start_span(initial_tracer, "initial-operation")
  
  assert_eq(Span::name(initial_span), "initial-operation")
  
  // æ¨¡æ‹Ÿé…ç½®æ›´æ–°
  let updated_provider = TracerProvider::default()
  let updated_tracer = TracerProvider::get_tracer(updated_provider, "updated-service", Some("2.0.0"))
  let updated_span = Tracer::start_span(updated_tracer, "updated-operation")
  
  assert_eq(Span::name(updated_span), "updated-operation")
  assert_eq(Tracer::instrumentation_scope(updated_tracer).name, "updated-service")
  assert_eq(Tracer::instrumentation_scope(updated_tracer).version, Some("2.0.0"))
  
  // æµ‹è¯•åº¦é‡é…ç½®æ›´æ–°
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "dynamic-meter")
  let counter = Meter::create_counter(meter, "dynamic.counter", Some("Dynamic counter"), Some("items"))
  
  assert_eq(counter.name, "dynamic.counter")
  assert_eq(counter.description, Some("Dynamic counter"))
  assert_eq(counter.unit, Some("items"))
}

// æµ‹è¯•4: èµ„æºåˆå¹¶ç­–ç•¥æµ‹è¯•
test "èµ„æºåˆå¹¶ç­–ç•¥æµ‹è¯•" {
  // åˆ›å»ºåŸºç¡€èµ„æº
  let base_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("base-service")),
    ("service.version", StringValue("1.0.0"))
  ])
  
  // åˆ›å»ºè¦†ç›–èµ„æº
  let override_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("override-service")),  // åº”è¯¥è¦†ç›–
    ("environment", StringValue("production"))        // æ–°å¢å±æ€§
  ])
  
  // åˆå¹¶èµ„æº
  let merged_resource = Resource::merge(base_resource, override_resource)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  assert_eq(Resource::get_attribute(merged_resource, "service.name"), Some(StringValue("override-service")))
  assert_eq(Resource::get_attribute(merged_resource, "service.version"), Some(StringValue("1.0.0")))
  assert_eq(Resource::get_attribute(merged_resource, "environment"), Some(StringValue("production")))
  
  // æµ‹è¯•ç©ºèµ„æºåˆå¹¶
  let empty_resource = Resource::new()
  let merged_with_empty = Resource::merge(empty_resource, base_resource)
  
  assert_eq(Resource::get_attribute(merged_with_empty, "service.name"), Some(StringValue("base-service")))
  assert_eq(Resource::get_attribute(merged_with_empty, "service.version"), Some(StringValue("1.0.0")))
}

// æµ‹è¯•5: è·¨æœåŠ¡ä¸€è‡´æ€§æµ‹è¯•
test "è·¨æœåŠ¡ä¸€è‡´æ€§æµ‹è¯•" {
  // æ¨¡æ‹Ÿè·¨æœåŠ¡åˆ†å¸ƒå¼è¿½è¸ª
  let service_a_tracer = TracerProvider::get_tracer(TracerProvider::default(), "service-a")
  let service_b_tracer = TracerProvider::get_tracer(TracerProvider::default(), "service-b")
  
  // æœåŠ¡Aåˆ›å»ºæ ¹Span
  let root_span_ctx = SpanContext::new("trace-12345", "span-a-root", true, "test-state")
  let root_span = Span::new("service-a-operation", Server, root_span_ctx)
  
  // æœåŠ¡Båˆ›å»ºå­Span
  let child_span_ctx = SpanContext::new("trace-12345", "span-b-child", true, "test-state")
  let child_span = Span::new("service-b-operation", Server, child_span_ctx)
  
  // éªŒè¯Trace IDä¸€è‡´æ€§
  assert_eq(SpanContext::trace_id(root_span_ctx), "trace-12345")
  assert_eq(SpanContext::trace_id(child_span_ctx), "trace-12345")
  
  // éªŒè¯Span IDå”¯ä¸€æ€§
  assert_true(SpanContext::span_id(root_span_ctx) != SpanContext::span_id(child_span_ctx))
  
  // æµ‹è¯•è·¨æœåŠ¡Baggageä¼ æ’­
  let baggage = Baggage::new()
  let baggage_with_user = Baggage::set_entry(baggage, "user.id", "12345")
  let baggage_with_request = Baggage::set_entry(baggage_with_user, "request.id", "req-67890")
  
  assert_eq(Baggage::get_entry(baggage_with_request, "user.id"), Some("12345"))
  assert_eq(Baggage::get_entry(baggage_with_request, "request.id"), Some("req-67890"))
}

// æµ‹è¯•6: é”™è¯¯è¾¹ç•Œå’Œæ¢å¤æµ‹è¯•
test "é”™è¯¯è¾¹ç•Œå’Œæ¢å¤æµ‹è¯•" {
  // æµ‹è¯•ç©ºå€¼å¤„ç†
  let empty_attrs = Attributes::new()
  assert_eq(Attributes::get(empty_attrs, "nonexistent"), None)
  
  // æµ‹è¯•æ— æ•ˆSpanä¸Šä¸‹æ–‡
  let invalid_span_ctx = SpanContext::new("", "", false, "")
  assert_false(SpanContext::is_valid(invalid_span_ctx))
  
  // æµ‹è¯•æå€¼å±æ€§
  let extreme_attrs = Attributes::new()
  Attributes::set(extreme_attrs, "max.int", IntValue(2147483647))
  Attributes::set(extreme_attrs, "min.int", IntValue(-2147483648))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å¤„ç†
  let special_attrs = Attributes::new()
  Attributes::set(special_attrs, "unicode", StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€"))
  Attributes::set(special_attrs, "special.chars", StringValue("!@#$%^&*()"))
  
  // æµ‹è¯•é”™è¯¯æ¢å¤
  let tracer = TracerProvider::get_tracer(TracerProvider::default(), "error-test")
  let error_span = Tracer::start_span(tracer, "error-operation")
  
  // æ·»åŠ é”™è¯¯äº‹ä»¶
  Span::add_event(error_span, "error.occurred", Some([
    ("error.type", StringValue("TimeoutError")),
    ("error.message", StringValue("Operation timed out"))
  ]))
  
  // è®¾ç½®é”™è¯¯çŠ¶æ€
  Span::set_status(error_span, Error)
  
  assert_eq(Span::name(error_span), "error-operation")
}

// æµ‹è¯•7: å¹¶å‘å®‰å…¨æ€§æµ‹è¯•
test "å¹¶å‘å®‰å…¨æ€§æµ‹è¯•" {
  // æµ‹è¯•å¹¶å‘Spanåˆ›å»º
  let tracer = TracerProvider::get_tracer(TracerProvider::default(), "concurrent-test")
  let spans = []
  
  // åˆ›å»ºå¤šä¸ªSpan
  for i in 0..50 {
    let span = Tracer::start_span(tracer, "concurrent-span-" + i.to_string())
    spans.push(span)
  }
  
  // æ‰¹é‡æ“ä½œ
  for span in spans {
    Span::add_event(span, "concurrent.event")
    Span::set_status(span, Ok)
  }
  
  // æ‰¹é‡ç»“æŸ
  for span in spans {
    Span::end(span)
  }
  
  assert_true(spans.length() == 50)
  
  // æµ‹è¯•å¹¶å‘åº¦é‡æ“ä½œ
  let meter = MeterProvider::get_meter(MeterProvider::default(), "concurrent-meter")
  let counter = Meter::create_counter(meter, "concurrent.counter")
  
  // å¤§é‡å¹¶å‘åº¦é‡æ“ä½œ
  for i in 0..200 {
    Counter::add(counter, 1.0)
  }
  
  assert_eq(counter.name, "concurrent.counter")
}

// æµ‹è¯•8: åº¦é‡èšåˆæ“ä½œæµ‹è¯•
test "åº¦é‡èšåˆæ“ä½œæµ‹è¯•" {
  let meter = MeterProvider::get_meter(MeterProvider::default(), "aggregation-meter")
  
  // åˆ›å»ºå„ç§åº¦é‡ç±»å‹
  let counter = Meter::create_counter(meter, "request.count")
  let histogram = Meter::create_histogram(meter, "response.time")
  let updown_counter = Meter::create_updown_counter(meter, "active.connections")
  let gauge = Meter::create_gauge(meter, "memory.usage")
  
  // æµ‹è¯•è®¡æ•°å™¨èšåˆ
  for i in 0..100 {
    Counter::add(counter, 1.0)
  }
  
  // æµ‹è¯•ç›´æ–¹å›¾èšåˆ
  for i in 0..50 {
    let value = 100.0 + (i.to_double() * 2.0)
    Histogram::record(histogram, value)
  }
  
  // æµ‹è¯•ä¸Šä¸‹è®¡æ•°å™¨
  Counter::add(updown_counter, 10.0)
  Counter::add(updown_counter, -3.0)
  
  // éªŒè¯åº¦é‡å±æ€§
  assert_eq(counter.name, "request.count")
  assert_eq(histogram.name, "response.time")
  assert_eq(updown_counter.name, "active.connections")
  assert_eq(gauge.name, "memory.usage")
  
  // æµ‹è¯•åº¦é‡è½¬æ¢
  let instrument = Histogram::as_instrument(histogram)
  assert_eq(Instrument::name(instrument), "response.time")
}

// æµ‹è¯•9: å¤åˆä¼ æ’­å™¨é«˜çº§æµ‹è¯•
test "å¤åˆä¼ æ’­å™¨é«˜çº§æµ‹è¯•" {
  // åˆ›å»ºå¤šä¸ªä¼ æ’­å™¨
  let trace_propagator = W3CTraceContextPropagator::new()
  let baggage_propagator = W3CBaggagePropagator::new()
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨
  let composite_propagator = CompositePropagator::new([trace_propagator, baggage_propagator])
  
  // æµ‹è¯•æ³¨å…¥
  let carrier = TextMapCarrier::new()
  let ctx = Context::root()
  
  CompositePropagator::inject(composite_propagator, ctx, carrier)
  
  // éªŒè¯æ³¨å…¥çš„å¤´éƒ¨
  let trace_header = TextMapCarrier::get(carrier, "traceparent")
  assert_eq(trace_header, Some("00-test-trace-id-test-span-id-01"))
  
  // æµ‹è¯•æå–
  let extracted_ctx = CompositePropagator::extract(composite_propagator, carrier)
  let key = ContextKey::new("extracted")
  let extracted_value = Context::get(extracted_ctx, key)
  assert_eq(extracted_value, Some("true"))
  
  // æµ‹è¯•ç©ºè½½ä½“å¤„ç†
  let empty_carrier = TextMapCarrier::new()
  let empty_extracted_ctx = CompositePropagator::extract(composite_propagator, empty_carrier)
  let empty_key = ContextKey::new("empty")
  let empty_value = Context::get(empty_extracted_ctx, empty_key)
  assert_eq(empty_value, None)
}

// æµ‹è¯•10: å›½é™…åŒ–å’Œå…¨çƒåŒ–æµ‹è¯•
test "å›½é™…åŒ–å’Œå…¨çƒåŒ–æµ‹è¯•" {
  // æµ‹è¯•å¤šè¯­è¨€æ”¯æŒ
  let multilingual_attrs = Attributes::new()
  Attributes::set(multilingual_attrs, "message.zh", StringValue("ä½ å¥½ä¸–ç•Œ"))
  Attributes::set(multilingual_attrs, "message.en", StringValue("Hello World"))
  Attributes::set(multilingual_attrs, "message.ja", StringValue("ã“ã‚“ã«ã¡ã¯ä¸–ç•Œ"))
  Attributes::set(multilingual_attrs, "message.es", StringValue("Hola Mundo"))
  
  // éªŒè¯å¤šè¯­è¨€å±æ€§
  assert_eq(Attributes::get(multilingual_attrs, "message.zh"), Some(StringValue("test_value")))
  assert_eq(Attributes::get(multilingual_attrs, "message.en"), Some(StringValue("test_value")))
  
  // æµ‹è¯•Unicodeå’Œç‰¹æ®Šå­—ç¬¦
  let unicode_attrs = Attributes::new()
  Attributes::set(unicode_attrs, "emoji", StringValue("ğŸš€ğŸŒğŸ’»"))
  Attributes::set(unicode_attrs, "chinese", StringValue("æµ‹è¯•ä¸­æ–‡å­—ç¬¦"))
  Attributes::set(unicode_attrs, "arabic", StringValue("Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"))
  Attributes::set(unicode_attrs, "russian", StringValue("Ñ‚ĞµÑÑ‚ Ñ€ÑƒÑÑĞºĞ¸Ğ¹"))
  
  // æµ‹è¯•æ—¶åŒºç›¸å…³çš„æ—¶é—´æˆ³
  let clock = Clock::system()
  let timestamp = Clock::now_unix_nanos(clock)
  
  // åˆ›å»ºå¤šè¯­è¨€æ—¥å¿—è®°å½•
  let logger = LoggerProvider::get_logger(LoggerProvider::default(), "i18n-logger")
  let zh_log = LogRecord::new_with_context(
    Info,
    Some("ä¸­æ–‡æ—¥å¿—æ¶ˆæ¯"),
    Some(multilingual_attrs),
    Some(timestamp),
    None,
    Some("i18n-trace"),
    Some("i18n-span"),
    Some(Context::root())
  )
  
  Logger::emit(logger, zh_log)
  
  // éªŒè¯å¤šè¯­è¨€æ—¥å¿—
  assert_eq(LogRecord::body(zh_log), Some("ä¸­æ–‡æ—¥å¿—æ¶ˆæ¯"))
  assert_eq(LogRecord::trace_id(zh_log), Some("i18n-trace"))
  assert_eq(LogRecord::span_id(zh_log), Some("i18n-span"))
}
// é«˜çº§Baggageæ“ä½œæµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•å¤æ‚çš„Baggageä¼ æ’­ã€ç®¡ç†å’Œè¾¹ç•Œæ¡ä»¶

test "baggage_complex_propagation_chain" {
  // æµ‹è¯•å¤æ‚çš„baggageä¼ æ’­é“¾
  let initial_baggage = Baggage::new()
  
  // è®¾ç½®å¤šä¸ªbaggageæ¡ç›®
  let baggage1 = Baggage::set_entry(initial_baggage, "user.id", "user123")
  let baggage2 = Baggage::set_entry(baggage1, "request.id", "req456")
  let baggage3 = Baggage::set_entry(baggage2, "session.id", "session789")
  
  // éªŒè¯baggageæ¡ç›®
  assert_eq(Baggage::get_entry(baggage3, "user.id"), Some("user123"))
  assert_eq(Baggage::get_entry(baggage3, "request.id"), Some("req456"))
  assert_eq(Baggage::get_entry(baggage3, "session.id"), Some("session789"))
  
  // æµ‹è¯•baggageæ¡ç›®è¦†ç›–
  let baggage4 = Baggage::set_entry(baggage3, "user.id", "user456")
  assert_eq(Baggage::get_entry(baggage4, "user.id"), Some("user456"))
  
  // æµ‹è¯•baggageæ¡ç›®ç§»é™¤
  let baggage5 = Baggage::remove_entry(baggage4, "request.id")
  assert_eq(Baggage::get_entry(baggage5, "request.id"), None)
  assert_eq(Baggage::get_entry(baggage5, "user.id"), Some("user456"))
  assert_eq(Baggage::get_entry(baggage5, "session.id"), Some("session789"))
}

test "baggage_edge_cases_and_validation" {
  // æµ‹è¯•baggageçš„è¾¹ç•Œæ¡ä»¶å’ŒéªŒè¯
  let baggage = Baggage::new()
  
  // æµ‹è¯•ç©ºé”®å’Œç©ºå€¼
  let empty_key_baggage = Baggage::set_entry(baggage, "", "empty_key_value")
  let empty_value_baggage = Baggage::set_entry(empty_key_baggage, "empty_value_key", "")
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦
  let special_chars_baggage = Baggage::set_entry(empty_value_baggage, "special.chars", "value!@#$%^&*()")
  let unicode_baggage = Baggage::set_entry(special_chars_baggage, "unicode.key", "æµ‹è¯•å€¼ğŸš€")
  
  // æµ‹è¯•é•¿é”®å’Œé•¿å€¼
  let long_key = "this.is.a.very.long.key.name.that.exceeds.normal.length.expectations.for.testing.purposes"
  let long_value = "this.is.a.very.long.value.that.exceeds.normal.length.expectations.for.testing.purposes.and.should.still.work.correctly"
  let long_baggage = Baggage::set_entry(unicode_baggage, long_key, long_value)
  
  // éªŒè¯æ‰€æœ‰æ¡ç›®éƒ½èƒ½æ­£ç¡®å­˜å‚¨å’Œæ£€ç´¢
  assert_eq(Baggage::get_entry(long_baggage, ""), Some("empty_key_value"))
  assert_eq(Baggage::get_entry(long_baggage, "empty_value_key"), Some(""))
  assert_eq(Baggage::get_entry(long_baggage, "special.chars"), Some("value!@#$%^&*()"))
  assert_eq(Baggage::get_entry(long_baggage, "unicode.key"), Some("æµ‹è¯•å€¼ğŸš€"))
  assert_eq(Baggage::get_entry(long_baggage, long_key), Some(long_value))
}

test "baggage_concurrent_operations" {
  // æµ‹è¯•baggageçš„å¹¶å‘æ“ä½œ
  let base_baggage = Baggage::new()
  
  // æ¨¡æ‹Ÿå¹¶å‘è®¾ç½®å¤šä¸ªæ¡ç›®
  let baggage_a = Baggage::set_entry(base_baggage, "concurrent.a", "value_a")
  let baggage_b = Baggage::set_entry(base_baggage, "concurrent.b", "value_b")
  let baggage_c = Baggage::set_entry(base_baggage, "concurrent.c", "value_c")
  
  // æ¨¡æ‹Ÿå¹¶å‘è¯»å–æ“ä½œ
  let value_a = Baggage::get_entry(baggage_a, "concurrent.a")
  let value_b = Baggage::get_entry(baggage_b, "concurrent.b")
  let value_c = Baggage::get_entry(baggage_c, "concurrent.c")
  
  assert_eq(value_a, Some("value_a"))
  assert_eq(value_b, Some("value_b"))
  assert_eq(value_c, Some("value_c"))
  
  // æµ‹è¯•å¹¶å‘ä¿®æ”¹å’Œåˆ é™¤
  let modified_a = Baggage::set_entry(baggage_a, "concurrent.a", "modified_value_a")
  let removed_b = Baggage::remove_entry(baggage_b, "concurrent.b")
  
  assert_eq(Baggage::get_entry(modified_a, "concurrent.a"), Some("modified_value_a"))
  assert_eq(Baggage::get_entry(removed_b, "concurrent.b"), None)
}

test "baggage_context_integration" {
  // æµ‹è¯•baggageä¸Contextçš„é›†æˆ
  let ctx = Context::root()
  let baggage_key = ContextKey::new("baggage")
  
  // åˆ›å»ºbaggageå¹¶å­˜å‚¨åˆ°contextä¸­
  let baggage = Baggage::new()
  let with_user = Baggage::set_entry(baggage, "user.id", "user123")
  let with_session = Baggage::set_entry(with_user, "session.id", "session456")
  
  // å°†baggageä¿¡æ¯å­˜å‚¨åˆ°contextï¼ˆç®€åŒ–å®ç°ï¼‰
  let ctx_with_baggage = Context::with_value(ctx, baggage_key, "baggage_data")
  
  // éªŒè¯contextä¸­çš„baggageä¿¡æ¯
  let retrieved_baggage = Context::get(ctx_with_baggage, baggage_key)
  assert_eq(retrieved_baggage, Some("baggage_data"))
  
  // æµ‹è¯•è·¨contextä¼ æ’­
  let child_ctx = Context::with_value(ctx_with_baggage, ContextKey::new("child.data"), "child_value")
  let parent_baggage = Context::get(child_ctx, baggage_key)
  let child_data = Context::get(child_ctx, ContextKey::new("child.data"))
  
  assert_eq(parent_baggage, Some("baggage_data"))
  assert_eq(child_data, Some("child_value"))
}
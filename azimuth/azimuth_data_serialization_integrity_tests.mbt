// Azimuth Data Serialization and Integrity Tests
// This file contains tests for data serialization and integrity in the Azimuth telemetry system

// Test 1: Attribute value serialization integrity
pub test "æ•°æ®åºåˆ—åŒ–å’Œå®Œæ•´æ€§æµ‹è¯•ï¼šå±æ€§å€¼åºåˆ—åŒ–å®Œæ•´æ€§" {
  // æµ‹è¯•å„ç§å±æ€§å€¼çš„åºåˆ—åŒ–å…¼å®¹æ€§
  let test_attrs = azimuth::Attributes::new()
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§
  azimuth::Attributes::set(test_attrs, "string.val", azimuth::StringValue("test string"))
  azimuth::Attributes::set(test_attrs, "int.val", azimuth::IntValue(42))
  azimuth::Attributes::set(test_attrs, "float.val", azimuth::FloatValue(3.14159))
  azimuth::Attributes::set(test_attrs, "bool.val", azimuth::BoolValue(true))
  azimuth::Attributes::set(test_attrs, "array.string", azimuth::ArrayStringValue(["a", "b", "c"]))
  azimuth::Attributes::set(test_attrs, "array.int", azimuth::ArrayIntValue([1, 2, 3]))
  
  // éªŒè¯å±æ€§å€¼çš„å®Œæ•´æ€§
  let string_val = azimuth::Attributes::get(test_attrs, "string.val")
  let int_val = azimuth::Attributes::get(test_attrs, "int.val")
  let float_val = azimuth::Attributes::get(test_attrs, "float.val")
  let bool_val = azimuth::Attributes::get(test_attrs, "bool.val")
  let array_string_val = azimuth::Attributes::get(test_attrs, "array.string")
  let array_int_val = azimuth::Attributes::get(test_attrs, "array.int")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(string_val, Some(azimuth::StringValue("test_value")))
  assert_eq(int_val, Some(azimuth::IntValue(42)))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„åºåˆ—åŒ–
  let special_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(special_attrs, "unicode.string", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€"))
  azimuth::Attributes::set(special_attrs, "quotes.string", azimuth::StringValue("Single' and Double\" quotes"))
  azimuth::Attributes::set(special_attrs, "newlines.string", azimuth::StringValue("Line1\nLine2\rLine3"))
  azimuth::Attributes::set(special_attrs, "tabs.string", azimuth::StringValue("Col1\tCol2\tCol3"))
  azimuth::Attributes::set(special_attrs, "backspace.string", azimuth::StringValue("Text\bBackspace"))
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦çš„å®Œæ•´æ€§
  let unicode_val = azimuth::Attributes::get(special_attrs, "unicode.string")
  let quotes_val = azimuth::Attributes::get(special_attrs, "quotes.string")
  let newlines_val = azimuth::Attributes::get(special_attrs, "newlines.string")
  let tabs_val = azimuth::Attributes::get(special_attrs, "tabs.string")
  let backspace_val = azimuth::Attributes::get(special_attrs, "backspace.string")
  
  assert_eq(unicode_val, Some(azimuth::StringValue("test_value")))
  assert_eq(quotes_val, Some(azimuth::StringValue("test_value")))
  
  // æµ‹è¯•æå€¼çš„åºåˆ—åŒ–
  let extreme_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(extreme_attrs, "max.int", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(extreme_attrs, "min.int", azimuth::IntValue(-2147483648))
  azimuth::Attributes::set(extreme_attrs, "max.float", azimuth::FloatValue(1.7976931348623157e+308))
  azimuth::Attributes::set(extreme_attrs, "min.float", azimuth::FloatValue(-1.7976931348623157e+308))
  azimuth::Attributes::set(extreme_attrs, "zero.float", azimuth::FloatValue(0.0))
  azimuth::Attributes::set(extreme_attrs, "negative.zero", azimuth::FloatValue(-0.0))
  
  // éªŒè¯æå€¼çš„å®Œæ•´æ€§
  let max_int_val = azimuth::Attributes::get(extreme_attrs, "max.int")
  let min_int_val = azimuth::Attributes::get(extreme_attrs, "min.int")
  let max_float_val = azimuth::Attributes::get(extreme_attrs, "max.float")
  let min_float_val = azimuth::Attributes::get(extreme_attrs, "min.float")
  let zero_float_val = azimuth::Attributes::get(extreme_attrs, "zero.float")
  let negative_zero_val = azimuth::Attributes::get(extreme_attrs, "negative.zero")
  
  assert_eq(max_int_val, Some(azimuth::IntValue(42)))
  assert_eq(min_int_val, Some(azimuth::IntValue(42)))
}

// Test 2: Span context serialization integrity
pub test "æ•°æ®åºåˆ—åŒ–å’Œå®Œæ•´æ€§æµ‹è¯•ï¼šSpanä¸Šä¸‹æ–‡åºåˆ—åŒ–å®Œæ•´æ€§" {
  // æµ‹è¯•Spanä¸Šä¸‹æ–‡çš„åºåˆ—åŒ–æ ¼å¼
  let span_ctx = azimuth::SpanContext::new("trace-123", "span-456", true, "key1=value1,key2=value2")
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡å­—æ®µ
  assert_eq(azimuth::SpanContext::trace_id(span_ctx), "trace-123")
  assert_eq(azimuth::SpanContext::span_id(span_ctx), "span-456")
  assert_true(azimuth::SpanContext::is_sampled(span_ctx))
  assert_eq(azimuth::SpanContext::trace_state(span_ctx), "key1=value1,key2=value2")
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„Spanä¸Šä¸‹æ–‡
  let unicode_span_ctx = azimuth::SpanContext::new("trace-æµ‹è¯•-123", "span-ğŸš€-456", true, "unicode.key=æµ‹è¯•å€¼")
  assert_eq(azimuth::SpanContext::trace_id(unicode_span_ctx), "trace-æµ‹è¯•-123")
  assert_eq(azimuth::SpanContext::span_id(unicode_span_ctx), "span-ğŸš€-456")
  assert_eq(azimuth::SpanContext::trace_state(unicode_span_ctx), "unicode.key=æµ‹è¯•å€¼")
  
  // æµ‹è¯•æé•¿çš„Spanä¸Šä¸‹æ–‡å­—æ®µ
  let very_long_trace_id = "0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef"
  let very_long_span_id = "0123456789abcdef0123456789abcdef"
  let very_long_trace_state = "key1=value1,key2=value2,key3=value3,key4=value4,key5=value5"
  
  let long_span_ctx = azimuth::SpanContext::new(very_long_trace_id, very_long_span_id, true, very_long_trace_state)
  assert_eq(azimuth::SpanContext::trace_id(long_span_ctx), very_long_trace_id)
  assert_eq(azimuth::SpanContext::span_id(long_span_ctx), very_long_span_id)
  assert_eq(azimuth::SpanContext::trace_state(long_span_ctx), very_long_trace_state)
  
  // æµ‹è¯•ç©ºå€¼çš„Spanä¸Šä¸‹æ–‡
  let empty_trace_ctx = azimuth::SpanContext::new("", "span123", true, "")
  let empty_span_ctx = azimuth::SpanContext::new("trace123", "", true, "")
  let empty_state_ctx = azimuth::SpanContext::new("trace123", "span456", true, "")
  
  assert_eq(azimuth::SpanContext::trace_id(empty_trace_ctx), "")
  assert_eq(azimuth::SpanContext::span_id(empty_trace_ctx), "span123")
  assert_eq(azimuth::SpanContext::trace_state(empty_trace_ctx), "")
  
  assert_eq(azimuth::SpanContext::trace_id(empty_span_ctx), "trace123")
  assert_eq(azimuth::SpanContext::span_id(empty_span_ctx), "")
  assert_eq(azimuth::SpanContext::trace_state(empty_span_ctx), "")
  
  assert_eq(azimuth::SpanContext::trace_id(empty_state_ctx), "trace123")
  assert_eq(azimuth::SpanContext::span_id(empty_state_ctx), "span456")
  assert_eq(azimuth::SpanContext::trace_state(empty_state_ctx), "")
}

// Test 3: Resource serialization integrity
pub test "æ•°æ®åºåˆ—åŒ–å’Œå®Œæ•´æ€§æµ‹è¯•ï¼šèµ„æºåºåˆ—åŒ–å®Œæ•´æ€§" {
  // æµ‹è¯•Resourceçš„åºåˆ—åŒ–å…¼å®¹æ€§
  let resource_attrs = [
    ("service.name", azimuth::StringValue("test-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.instance.id", azimuth::StringValue("instance-123")),
    ("deployment.environment", azimuth::StringValue("test")),
    ("host.name", azimuth::StringValue("test-host")),
    ("telemetry.sdk.name", azimuth::StringValue("azimuth")),
    ("telemetry.sdk.version", azimuth::StringValue("1.0.0")),
    ("telemetry.sdk.language", azimuth::StringValue("moonbit"))
  ]
  
  let resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), resource_attrs)
  
  // éªŒè¯Resourceå±æ€§å®Œæ•´æ€§
  assert_eq(azimuth::Resource::get_attribute(resource, "service.name"), Some(azimuth::StringValue("test-service")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.instance.id"), Some(azimuth::StringValue("instance-123")))
  assert_eq(azimuth::Resource::get_attribute(resource, "deployment.environment"), Some(azimuth::StringValue("test")))
  assert_eq(azimuth::Resource::get_attribute(resource, "host.name"), Some(azimuth::StringValue("test-host")))
  assert_eq(azimuth::Resource::get_attribute(resource, "telemetry.sdk.name"), Some(azimuth::StringValue("azimuth")))
  assert_eq(azimuth::Resource::get_attribute(resource, "telemetry.sdk.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(resource, "telemetry.sdk.language"), Some(azimuth::StringValue("moonbit")))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„Resourceå±æ€§
  let special_resource_attrs = [
    ("unicode.service", azimuth::StringValue("æµ‹è¯•æœåŠ¡ğŸš€")),
    ("special.chars", azimuth::StringValue("!@#$%^&*()")),
    ("quotes.value", azimuth::StringValue("Single' and Double\" quotes")),
    ("newlines.value", azimuth::StringValue("Line1\nLine2\rLine3"))
  ]
  
  let special_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), special_resource_attrs)
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦Resourceå±æ€§å®Œæ•´æ€§
  assert_eq(azimuth::Resource::get_attribute(special_resource, "unicode.service"), Some(azimuth::StringValue("æµ‹è¯•æœåŠ¡ğŸš€")))
  assert_eq(azimuth::Resource::get_attribute(special_resource, "special.chars"), Some(azimuth::StringValue("!@#$%^&*()")))
  assert_eq(azimuth::Resource::get_attribute(special_resource, "quotes.value"), Some(azimuth::StringValue("Single' and Double\" quotes")))
  assert_eq(azimuth::Resource::get_attribute(special_resource, "newlines.value"), Some(azimuth::StringValue("Line1\nLine2\rLine3")))
  
  // æµ‹è¯•æå€¼çš„Resourceå±æ€§
  let extreme_resource_attrs = [
    ("max.int.attr", azimuth::IntValue(2147483647)),
    ("min.int.attr", azimuth::IntValue(-2147483648)),
    ("max.float.attr", azimuth::FloatValue(1.7976931348623157e+308)),
    ("min.float.attr", azimuth::FloatValue(-1.7976931348623157e+308)),
    ("zero.float.attr", azimuth::FloatValue(0.0)),
    ("bool.true.attr", azimuth::BoolValue(true)),
    ("bool.false.attr", azimuth::BoolValue(false))
  ]
  
  let extreme_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), extreme_resource_attrs)
  
  // éªŒè¯æå€¼Resourceå±æ€§å®Œæ•´æ€§
  assert_eq(azimuth::Resource::get_attribute(extreme_resource, "max.int.attr"), Some(azimuth::IntValue(2147483647)))
  assert_eq(azimuth::Resource::get_attribute(extreme_resource, "min.int.attr"), Some(azimuth::IntValue(-2147483648)))
  assert_eq(azimuth::Resource::get_attribute(extreme_resource, "max.float.attr"), Some(azimuth::FloatValue(1.7976931348623157e+308)))
  assert_eq(azimuth::Resource::get_attribute(extreme_resource, "min.float.attr"), Some(azimuth::FloatValue(-1.7976931348623157e+308)))
  assert_eq(azimuth::Resource::get_attribute(extreme_resource, "zero.float.attr"), Some(azimuth::FloatValue(0.0)))
  assert_eq(azimuth::Resource::get_attribute(extreme_resource, "bool.true.attr"), Some(azimuth::BoolValue(true)))
  assert_eq(azimuth::Resource::get_attribute(extreme_resource, "bool.false.attr"), Some(azimuth::BoolValue(false)))
}

// Test 4: Baggage serialization integrity
pub test "æ•°æ®åºåˆ—åŒ–å’Œå®Œæ•´æ€§æµ‹è¯•ï¼šBaggageåºåˆ—åŒ–å®Œæ•´æ€§" {
  // æµ‹è¯•Baggageçš„åºåˆ—åŒ–å…¼å®¹æ€§
  let baggage = azimuth::Baggage::new()
  let updated_baggage = azimuth::Baggage::set_entry(baggage, "user.id", "12345")
  let updated_baggage = azimuth::Baggage::set_entry(updated_baggage, "request.id", "req-67890")
  let updated_baggage = azimuth::Baggage::set_entry(updated_baggage, "session.id", "session-abc123")
  
  // éªŒè¯Baggageæ¡ç›®å®Œæ•´æ€§
  assert_eq(azimuth::Baggage::get_entry(updated_baggage, "user.id"), Some("12345"))
  assert_eq(azimuth::Baggage::get_entry(updated_baggage, "request.id"), Some("req-67890"))
  assert_eq(azimuth::Baggage::get_entry(updated_baggage, "session.id"), Some("session-abc123"))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„Baggageæ¡ç›®
  let special_baggage = azimuth::Baggage::new()
  let special_baggage = azimuth::Baggage::set_entry(special_baggage, "unicode.key", "æµ‹è¯•å€¼ğŸš€")
  let special_baggage = azimuth::Baggage::set_entry(special_baggage, "special.chars", "!@#$%^&*()")
  let special_baggage = azimuth::Baggage::set_entry(special_baggage, "quotes.value", "Single' and Double\" quotes")
  let special_baggage = azimuth::Baggage::set_entry(special_baggage, "newlines.value", "Line1\nLine2\rLine3")
  let special_baggage = azimuth::Baggage::set_entry(special_baggage, "tabs.value", "Col1\tCol2\tCol3")
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦Baggageæ¡ç›®å®Œæ•´æ€§
  assert_eq(azimuth::Baggage::get_entry(special_baggage, "unicode.key"), Some("æµ‹è¯•å€¼ğŸš€"))
  assert_eq(azimuth::Baggage::get_entry(special_baggage, "special.chars"), Some("!@#$%^&*()"))
  assert_eq(azimuth::Baggage::get_entry(special_baggage, "quotes.value"), Some("Single' and Double\" quotes"))
  assert_eq(azimuth::Baggage::get_entry(special_baggage, "newlines.value"), Some("Line1\nLine2\rLine3"))
  assert_eq(azimuth::Baggage::get_entry(special_baggage, "tabs.value"), Some("Col1\tCol2\tCol3"))
  
  // æµ‹è¯•ç©ºå€¼çš„Baggageæ¡ç›®
  let empty_baggage = azimuth::Baggage::new()
  let empty_baggage = azimuth::Baggage::set_entry(empty_baggage, "empty.key", "")
  let empty_baggage = azimuth::Baggage::set_entry(empty_baggage, "", "empty.key.value")
  
  // éªŒè¯ç©ºå€¼Baggageæ¡ç›®å®Œæ•´æ€§
  assert_eq(azimuth::Baggage::get_entry(empty_baggage, "empty.key"), Some(""))
  assert_eq(azimuth::Baggage::get_entry(empty_baggage, ""), Some("empty.key.value"))
  
  // æµ‹è¯•æé•¿çš„Baggageæ¡ç›®
  let very_long_key = "this.is.a.very.long.baggage.key.name.that.exceeds.normal.expectations"
  let very_long_value = "this.is.a.very.long.baggage.value.that.exceeds.normal.expectations"
  let long_baggage = azimuth::Baggage::new()
  let long_baggage = azimuth::Baggage::set_entry(long_baggage, very_long_key, very_long_value)
  
  // éªŒè¯æé•¿Baggageæ¡ç›®å®Œæ•´æ€§
  assert_eq(azimuth::Baggage::get_entry(long_baggage, very_long_key), Some(very_long_value))
}

// Test 5: Log record serialization integrity
pub test "æ•°æ®åºåˆ—åŒ–å’Œå®Œæ•´æ€§æµ‹è¯•ï¼šæ—¥å¿—è®°å½•åºåˆ—åŒ–å®Œæ•´æ€§" {
  // æµ‹è¯•LogRecordçš„åºåˆ—åŒ–å…¼å®¹æ€§
  let log_record = azimuth::LogRecord::new(azimuth::Info, "Test log message")
  assert_eq(azimuth::LogRecord::severity_number(log_record), azimuth::Info)
  assert_eq(azimuth::LogRecord::body(log_record), Some("Test log message"))
  
  // æµ‹è¯•è¯¦ç»†çš„LogRecord
  let log_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(log_attrs, "log.level", azimuth::StringValue("INFO"))
  azimuth::Attributes::set(log_attrs, "log.source", azimuth::StringValue("test-module"))
  
  let detailed_record = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("Error occurred"),
    Some(log_attrs),
    Some(1735689600000000000L),
    Some(1735689600000000001L),
    Some("trace-123"),
    Some("span-456"),
    Some(azimuth::Context::root())
  )
  
  // éªŒè¯è¯¦ç»†LogRecordå®Œæ•´æ€§
  assert_eq(azimuth::LogRecord::severity_number(detailed_record), azimuth::Error)
  assert_eq(azimuth::LogRecord::body(detailed_record), Some("Error occurred"))
  assert_eq(azimuth::LogRecord::trace_id(detailed_record), Some("trace-123"))
  assert_eq(azimuth::LogRecord::span_id(detailed_record), Some("span-456"))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„LogRecord
  let unicode_record = azimuth::LogRecord::new_with_context(
    azimuth::Warn,
    Some("è­¦å‘Šæ¶ˆæ¯ğŸš€"),
    Some(log_attrs),
    Some(1735689600000000000L),
    Some(1735689600000000001L),
    Some("trace-æµ‹è¯•-123"),
    Some("span-ğŸš€-456"),
    Some(azimuth::Context::root())
  )
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦LogRecordå®Œæ•´æ€§
  assert_eq(azimuth::LogRecord::severity_number(unicode_record), azimuth::Warn)
  assert_eq(azimuth::LogRecord::body(unicode_record), Some("è­¦å‘Šæ¶ˆæ¯ğŸš€"))
  assert_eq(azimuth::LogRecord::trace_id(unicode_record), Some("trace-æµ‹è¯•-123"))
  assert_eq(azimuth::LogRecord::span_id(unicode_record), Some("span-ğŸš€-456"))
  
  // æµ‹è¯•æå€¼çš„LogRecord
  let max_timestamp = 9223372036854775807L  // æœ€å¤§64ä½æ•´æ•°
  let min_timestamp = 0L
  
  let max_record = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Max timestamp record"),
    Some(log_attrs),
    Some(max_timestamp),
    Some(max_timestamp),
    Some("trace-max"),
    Some("span-max"),
    Some(azimuth::Context::root())
  )
  
  let min_record = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Min timestamp record"),
    Some(log_attrs),
    Some(min_timestamp),
    Some(min_timestamp),
    Some("trace-min"),
    Some("span-min"),
    Some(azimuth::Context::root())
  )
  
  // éªŒè¯æå€¼LogRecordå®Œæ•´æ€§
  assert_eq(azimuth::LogRecord::timestamp(max_record), Some(max_timestamp))
  assert_eq(azimuth::LogRecord::observed_timestamp(max_record), Some(max_timestamp))
  assert_eq(azimuth::LogRecord::timestamp(min_record), Some(min_timestamp))
  assert_eq(azimuth::LogRecord::observed_timestamp(min_record), Some(min_timestamp))
}

// Test 6: Instrument serialization integrity
pub test "æ•°æ®åºåˆ—åŒ–å’Œå®Œæ•´æ€§æµ‹è¯•ï¼šå·¥å…·åºåˆ—åŒ–å®Œæ•´æ€§" {
  // æµ‹è¯•Instrumentçš„åºåˆ—åŒ–å…¼å®¹æ€§
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "test-meter")
  
  // åˆ›å»ºå„ç§ç±»å‹çš„Instrument
  let counter = azimuth::Meter::create_counter(meter, "test.counter", Some("Test counter"), Some("count"))
  let histogram = azimuth::Meter::create_histogram(meter, "test.histogram", Some("Test histogram"), Some("ms"))
  let updown_counter = azimuth::Meter::create_updown_counter(meter, "test.updown", Some("Test up-down counter"), Some("items"))
  let gauge = azimuth::Meter::create_gauge(meter, "test.gauge", Some("Test gauge"), Some("units"))
  
  // éªŒè¯Counterå®Œæ•´æ€§
  assert_eq(counter.name, "test.counter")
  assert_eq(counter.description, Some("Test counter"))
  assert_eq(counter.unit, Some("count"))
  
  // éªŒè¯Histogramå®Œæ•´æ€§
  assert_eq(histogram.name, "test.histogram")
  assert_eq(histogram.description, Some("Test histogram"))
  assert_eq(histogram.unit, Some("ms"))
  
  // éªŒè¯UpDownCounterå®Œæ•´æ€§
  assert_eq(updown_counter.name, "test.updown")
  assert_eq(updown_counter.description, Some("Test up-down counter"))
  assert_eq(updown_counter.unit, Some("items"))
  
  // éªŒè¯Gaugeå®Œæ•´æ€§
  assert_eq(gauge.name, "test.gauge")
  assert_eq(gauge.description, Some("Test gauge"))
  assert_eq(gauge.unit, Some("units"))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„Instrument
  let unicode_counter = azimuth::Meter::create_counter(meter, "æµ‹è¯•è®¡æ•°å™¨ğŸš€", Some("æµ‹è¯•è®¡æ•°å™¨æè¿°"), Some("ä¸ªæ•°"))
  let special_histogram = azimuth::Meter::create_histogram(meter, "special.histogram!@#$", Some("Special histogram with chars"), Some("ms"))
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦Instrumentå®Œæ•´æ€§
  assert_eq(unicode_counter.name, "æµ‹è¯•è®¡æ•°å™¨ğŸš€")
  assert_eq(unicode_counter.description, Some("æµ‹è¯•è®¡æ•°å™¨æè¿°"))
  assert_eq(unicode_counter.unit, Some("ä¸ªæ•°"))
  
  assert_eq(special_histogram.name, "special.histogram!@#$")
  assert_eq(special_histogram.description, Some("Special histogram with chars"))
  assert_eq(special_histogram.unit, Some("ms"))
  
  // æµ‹è¯•æé•¿çš„Instrumentåç§°
  let very_long_name = "this.is.a.very.long.instrument.name.that.exceeds.normal.expectations"
  let very_long_description = "this.is.a.very.long.instrument.description.that.exceeds.normal.expectations"
  let very_long_unit = "very-long-unit-name"
  
  let long_counter = azimuth::Meter::create_counter(meter, very_long_name, Some(very_long_description), Some(very_long_unit))
  
  // éªŒè¯æé•¿Instrumentå®Œæ•´æ€§
  assert_eq(long_counter.name, very_long_name)
  assert_eq(long_counter.description, Some(very_long_description))
  assert_eq(long_counter.unit, Some(very_long_unit))
}

// Test 7: Context serialization integrity
pub test "æ•°æ®åºåˆ—åŒ–å’Œå®Œæ•´æ€§æµ‹è¯•ï¼šä¸Šä¸‹æ–‡åºåˆ—åŒ–å®Œæ•´æ€§" {
  // æµ‹è¯•Contextçš„åºåˆ—åŒ–å…¼å®¹æ€§
  let root_ctx = azimuth::Context::root()
  
  // åˆ›å»ºå¤šå±‚åµŒå¥—çš„ä¸Šä¸‹æ–‡
  let key1 = azimuth::ContextKey::new("key1")
  let key2 = azimuth::ContextKey::new("key2")
  let key3 = azimuth::ContextKey::new("key3")
  
  let ctx1 = azimuth::Context::with_value(root_ctx, key1, "value1")
  let ctx2 = azimuth::Context::with_value(ctx1, key2, "value2")
  let ctx3 = azimuth::Context::with_value(ctx2, key3, "value3")
  
  // éªŒè¯Contextå®Œæ•´æ€§
  assert_eq(azimuth::Context::get(ctx3, key1), Some("value1"))
  assert_eq(azimuth::Context::get(ctx3, key2), Some("value2"))
  assert_eq(azimuth::Context::get(ctx3, key3), Some("value3"))
  assert_eq(azimuth::Context::get(ctx3, azimuth::ContextKey::new("nonexistent")), None)
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„Contexté”®å’Œå€¼
  let unicode_key = azimuth::ContextKey::new("ä¸­æ–‡é”®ğŸš€")
  let special_key = azimuth::ContextKey::new("special.chars.key!@#$")
  let empty_key = azimuth::ContextKey::new("")
  
  let unicode_ctx = azimuth::Context::with_value(root_ctx, unicode_key, "æµ‹è¯•å€¼ğŸš€")
  let special_ctx = azimuth::Context::with_value(root_ctx, special_key, "special.value!@#$")
  let empty_key_ctx = azimuth::Context::with_value(root_ctx, empty_key, "empty.key.value")
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦Contextå®Œæ•´æ€§
  assert_eq(azimuth::Context::get(unicode_ctx, unicode_key), Some("æµ‹è¯•å€¼ğŸš€"))
  assert_eq(azimuth::Context::get(special_ctx, special_key), Some("special.value!@#$"))
  assert_eq(azimuth::Context::get(empty_key_ctx, empty_key), Some("empty.key.value"))
  
  // æµ‹è¯•ç‰¹æ®Šå€¼çš„Context
  let empty_value_key = azimuth::ContextKey::new("empty.value")
  let newline_value_key = azimuth::ContextKey::new("newline.value")
  let tab_value_key = azimuth::ContextKey::new("tab.value")
  
  let empty_value_ctx = azimuth::Context::with_value(root_ctx, empty_value_key, "")
  let newline_value_ctx = azimuth::Context::with_value(root_ctx, newline_value_key, "line1\nline2")
  let tab_value_ctx = azimuth::Context::with_value(root_ctx, tab_value_key, "col1\tcol2")
  
  // éªŒè¯ç‰¹æ®Šå€¼Contextå®Œæ•´æ€§
  assert_eq(azimuth::Context::get(empty_value_ctx, empty_value_key), Some(""))
  assert_eq(azimuth::Context::get(newline_value_ctx, newline_value_key), Some("line1\nline2"))
  assert_eq(azimuth::Context::get(tab_value_ctx, tab_value_key), Some("col1\tcol2"))
  
  // æµ‹è¯•æé•¿çš„Contexté”®å’Œå€¼
  let very_long_key = azimuth::ContextKey::new("this.is.a.very.long.context.key.name.that.exceeds.normal.expectations")
  let very_long_value = "this.is.a.very.long.context.value.that.exceeds.normal.expectations"
  let long_ctx = azimuth::Context::with_value(root_ctx, very_long_key, very_long_value)
  
  // éªŒè¯æé•¿Contextå®Œæ•´æ€§
  assert_eq(azimuth::Context::get(long_ctx, very_long_key), Some(very_long_value))
}

// Test 8: Propagator serialization integrity
pub test "æ•°æ®åºåˆ—åŒ–å’Œå®Œæ•´æ€§æµ‹è¯•ï¼šä¼ æ’­å™¨åºåˆ—åŒ–å®Œæ•´æ€§" {
  // æµ‹è¯•Propagatorçš„åºåˆ—åŒ–å…¼å®¹æ€§
  let trace_propagator = azimuth::W3CTraceContextPropagator::new()
  let baggage_propagator = azimuth::W3CBaggagePropagator::new()
  
  let propagators = [trace_propagator, baggage_propagator]
  let composite_propagator = azimuth::CompositePropagator::new(propagators)
  
  // æµ‹è¯•ä¼ æ’­å™¨çš„æ³¨å…¥å’Œæå–
  let carrier = azimuth::TextMapCarrier::new()
  let ctx = azimuth::Context::root()
  
  // æ³¨å…¥ä¸Šä¸‹æ–‡åˆ°è½½ä½“
  azimuth::CompositePropagator::inject(composite_propagator, ctx, carrier)
  
  // éªŒè¯æ³¨å…¥çš„å¤´éƒ¨
  let trace_header = azimuth::TextMapCarrier::get(carrier, "traceparent")
  let baggage_header = azimuth::TextMapCarrier::get(carrier, "baggage")
  
  // åŸºäºç®€åŒ–å®ç°è¿›è¡ŒéªŒè¯
  assert_eq(trace_header, Some("00-test-trace-id-test-span-id-01"))
  
  // ä»è½½ä½“æå–ä¸Šä¸‹æ–‡
  let extracted_ctx = azimuth::CompositePropagator::extract(composite_propagator, carrier)
  
  // éªŒè¯æå–çš„ä¸Šä¸‹æ–‡
  let key = azimuth::ContextKey::new("extracted")
  let extracted_value = azimuth::Context::get(extracted_ctx, key)
  assert_eq(extracted_value, Some("true"))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„è½½ä½“
  let special_carrier = azimuth::TextMapCarrier::new()
  
  // è®¾ç½®ç‰¹æ®Šå­—ç¬¦çš„å¤´éƒ¨
  // æ³¨æ„ï¼šè¿™é‡Œç®€åŒ–å®ç°å¯èƒ½ä¸æ”¯æŒè®¾ç½®å¤´éƒ¨
  // åœ¨å®é™…å®ç°ä¸­ï¼Œåº”è¯¥èƒ½å¤Ÿå¤„ç†ç‰¹æ®Šå­—ç¬¦çš„å¤´éƒ¨å€¼
  
  // æµ‹è¯•ç©ºè½½ä½“
  let empty_carrier = azimuth::TextMapCarrier::new()
  let empty_extracted_ctx = azimuth::CompositePropagator::extract(composite_propagator, empty_carrier)
  
  // éªŒè¯ç©ºè½½ä½“çš„æå–
  let empty_key = azimuth::ContextKey::new("empty")
  let empty_extracted_value = azimuth::Context::get(empty_extracted_ctx, empty_key)
  assert_eq(empty_extracted_value, None)
}
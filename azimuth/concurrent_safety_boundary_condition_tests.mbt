// å¹¶å‘å®‰å…¨è¾¹ç•Œæ¡ä»¶æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•é¥æµ‹ç³»ç»Ÿåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§å’Œè¾¹ç•Œæ¡ä»¶å¤„ç†

test "å¹¶å‘spanåˆ›å»ºå’Œç»“æŸå®‰å…¨æ€§æµ‹è¯•" {
  // 1. åˆ›å»ºå…±äº«çš„traceræä¾›è€…
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "concurrent-test-service")
  
  // 2. æ¨¡æ‹Ÿå¹¶å‘åˆ›å»ºå¤šä¸ªspan
  // åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™é‡Œä¼šä½¿ç”¨çœŸæ­£çš„å¹¶å‘æœºåˆ¶
  // è¿™é‡Œç®€åŒ–ä¸ºé¡ºåºåˆ›å»ºæ¥æ¨¡æ‹Ÿå¹¶å‘åœºæ™¯
  
  let span_1 = Tracer::start_span(tracer, "å¹¶å‘æ“ä½œ-1")
  let span_2 = Tracer::start_span(tracer, "å¹¶å‘æ“ä½œ-2")
  let span_3 = Tracer::start_span(tracer, "å¹¶å‘æ“ä½œ-3")
  let span_4 = Tracer::start_span(tracer, "å¹¶å‘æ“ä½œ-4")
  let span_5 = Tracer::start_span(tracer, "å¹¶å‘æ“ä½œ-5")
  
  // 3. éªŒè¯æ¯ä¸ªspançš„å”¯ä¸€æ€§
  let span_1_name = Span::name(span_1)
  let span_2_name = Span::name(span_2)
  let span_3_name = Span::name(span_3)
  let span_4_name = Span::name(span_4)
  let span_5_name = Span::name(span_5)
  
  assert_eq(span_1_name, "å¹¶å‘æ“ä½œ-1")
  assert_eq(span_2_name, "å¹¶å‘æ“ä½œ-2")
  assert_eq(span_3_name, "å¹¶å‘æ“ä½œ-3")
  assert_eq(span_4_name, "å¹¶å‘æ“ä½œ-4")
  assert_eq(span_5_name, "å¹¶å‘æ“ä½œ-5")
  
  // éªŒè¯spanä¸Šä¸‹æ–‡çš„æœ‰æ•ˆæ€§
  let span_1_ctx = Span::span_context(span_1)
  let span_2_ctx = Span::span_context(span_2)
  let span_3_ctx = Span::span_context(span_3)
  let span_4_ctx = Span::span_context(span_4)
  let span_5_ctx = Span::span_context(span_5)
  
  assert_true(SpanContext::is_valid(span_1_ctx))
  assert_true(SpanContext::is_valid(span_2_ctx))
  assert_true(SpanContext::is_valid(span_3_ctx))
  assert_true(SpanContext::is_valid(span_4_ctx))
  assert_true(SpanContext::is_valid(span_5_ctx))
  
  // 4. å¹¶å‘æ·»åŠ äº‹ä»¶å’Œå±æ€§
  Span::add_event(span_1, "äº‹ä»¶-1", Some([("thread.id", IntValue(1))]))
  Span::add_event(span_2, "äº‹ä»¶-2", Some([("thread.id", IntValue(2))]))
  Span::add_event(span_3, "äº‹ä»¶-3", Some([("thread.id", IntValue(3))]))
  Span::add_event(span_4, "äº‹ä»¶-4", Some([("thread.id", IntValue(4))]))
  Span::add_event(span_5, "äº‹ä»¶-5", Some([("thread.id", IntValue(5))]))
  
  // 5. å¹¶å‘è®¾ç½®çŠ¶æ€
  Span::set_status(span_1, Ok, Some("æ“ä½œ1å®Œæˆ"))
  Span::set_status(span_2, Ok, Some("æ“ä½œ2å®Œæˆ"))
  Span::set_status(span_3, Error, Some("æ“ä½œ3å¤±è´¥"))
  Span::set_status(span_4, Ok, Some("æ“ä½œ4å®Œæˆ"))
  Span::set_status(span_5, Ok, Some("æ“ä½œ5å®Œæˆ"))
  
  // 6. å¹¶å‘ç»“æŸspan
  Span::end(span_1)
  Span::end(span_2)
  Span::end(span_3)
  Span::end(span_4)
  Span::end(span_5)
  
  assert_true(true)
}

test "å¹¶å‘æŒ‡æ ‡è®°å½•å®‰å…¨æ€§æµ‹è¯•" {
  // 1. åˆ›å»ºå…±äº«çš„meteræä¾›è€…
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "concurrent-metrics-service")
  
  // 2. åˆ›å»ºå¤šä¸ªæŒ‡æ ‡
  let request_counter = Meter::create_counter(meter, "http.requests.total", 
    Some("HTTPè¯·æ±‚æ€»æ•°"), Some("requests"))
  let response_histogram = Meter::create_histogram(meter, "http.response.duration",
    Some("HTTPå“åº”æ—¶é—´"), Some("ms"))
  let active_connections = Meter::create_updown_counter(meter, "http.active_connections",
    Some("æ´»è·ƒè¿æ¥æ•°"), Some("connections"))
  let memory_gauge = Meter::create_gauge(meter, "process.memory.usage",
    Some("å†…å­˜ä½¿ç”¨é‡"), Some("bytes"))
  
  // 3. æ¨¡æ‹Ÿå¹¶å‘è®°å½•æŒ‡æ ‡
  // è®¡æ•°å™¨å¹¶å‘é€’å¢
  Counter::add(request_counter, 1.0, Some(Attributes::new()))
  Counter::add(request_counter, 1.0, Some(Attributes::new()))
  Counter::add(request_counter, 1.0, Some(Attributes::new()))
  Counter::add(request_counter, 1.0, Some(Attributes::new()))
  Counter::add(request_counter, 1.0, Some(Attributes::new()))
  
  // ç›´æ–¹å›¾å¹¶å‘è®°å½•
  Histogram::record(response_histogram, 100.5, Some(Attributes::new()))
  Histogram::record(response_histogram, 125.3, Some(Attributes::new()))
  Histogram::record(response_histogram, 95.7, Some(Attributes::new()))
  Histogram::record(response_histogram, 110.2, Some(Attributes::new()))
  Histogram::record(response_histogram, 87.9, Some(Attributes::new()))
  
  // ä¸Šä¸‹è¡Œè®¡æ•°å™¨å¹¶å‘æ“ä½œ
  UpDownCounter::add(active_connections, 1.0, Some(Attributes::new()))
  UpDownCounter::add(active_connections, 1.0, Some(Attributes::new()))
  UpDownCounter::add(active_connections, -1.0, Some(Attributes::new()))
  UpDownCounter::add(active_connections, 1.0, Some(Attributes::new()))
  UpDownCounter::add(active_connections, -1.0, Some(Attributes::new()))
  
  // 4. éªŒè¯æŒ‡æ ‡åç§°å’Œå±æ€§
  assert_eq(request_counter.name, "http.requests.total")
  assert_eq(response_histogram.name, "http.response.duration")
  assert_eq(active_connections.name, "http.active_connections")
  assert_eq(memory_gauge.name, "process.memory.usage")
  
  // 5. éªŒè¯æŒ‡æ ‡æè¿°å’Œå•ä½
  assert_eq(request_counter.description, Some("HTTPè¯·æ±‚æ€»æ•°"))
  assert_eq(request_counter.unit, Some("requests"))
  
  assert_eq(response_histogram.description, Some("HTTPå“åº”æ—¶é—´"))
  assert_eq(response_histogram.unit, Some("ms"))
  
  assert_true(true)
}

test "å¹¶å‘æ—¥å¿—è®°å½•å®‰å…¨æ€§æµ‹è¯•" {
  // 1. åˆ›å»ºå…±äº«çš„loggeræä¾›è€…
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "concurrent-logging-service")
  
  // 2. åˆ›å»ºä¸åŒä¸¥é‡çº§åˆ«çš„æ—¥å¿—è®°å½•
  let trace_log = LogRecord::new(Trace, "è°ƒè¯•ä¿¡æ¯")
  let debug_log = LogRecord::new(Debug, "å¼€å‘è°ƒè¯•ä¿¡æ¯")
  let info_log = LogRecord::new(Info, "å¸¸è§„ä¿¡æ¯")
  let warn_log = LogRecord::new(Warn, "è­¦å‘Šä¿¡æ¯")
  let error_log = LogRecord::new(Error, "é”™è¯¯ä¿¡æ¯")
  
  // 3. éªŒè¯æ—¥å¿—ä¸¥é‡çº§åˆ«
  assert_eq(LogRecord::severity_number(trace_log), Trace)
  assert_eq(LogRecord::severity_number(debug_log), Debug)
  assert_eq(LogRecord::severity_number(info_log), Info)
  assert_eq(LogRecord::severity_number(warn_log), Warn)
  assert_eq(LogRecord::severity_number(error_log), Error)
  
  // 4. éªŒè¯æ—¥å¿—æ¶ˆæ¯
  assert_eq(LogRecord::body(trace_log), Some("è°ƒè¯•ä¿¡æ¯"))
  assert_eq(LogRecord::body(debug_log), Some("å¼€å‘è°ƒè¯•ä¿¡æ¯"))
  assert_eq(LogRecord::body(info_log), Some("å¸¸è§„ä¿¡æ¯"))
  assert_eq(LogRecord::body(warn_log), Some("è­¦å‘Šä¿¡æ¯"))
  assert_eq(LogRecord::body(error_log), Some("é”™è¯¯ä¿¡æ¯"))
  
  // 5. æ¨¡æ‹Ÿå¹¶å‘æ—¥å¿—è®°å½•
  Logger::emit(logger, trace_log)
  Logger::emit(logger, debug_log)
  Logger::emit(logger, info_log)
  Logger::emit(logger, warn_log)
  Logger::emit(logger, error_log)
  
  // 6. åˆ›å»ºå¸¦æœ‰å±æ€§çš„å¤æ‚æ—¥å¿—è®°å½•
  let current_time = Clock::now_unix_nanos(Clock::system())
  let complex_log = LogRecord::new_with_context(
    Info,
    Some("å¤æ‚æ—¥å¿—è®°å½•"),
    Some(Attributes::new()),
    Some(current_time),
    Some(current_time + 1000000L),
    Some("trace-12345"),
    Some("span-67890"),
    Some(Context::root())
  )
  
  // éªŒè¯å¤æ‚æ—¥å¿—è®°å½•
  assert_eq(LogRecord::severity_number(complex_log), Info)
  assert_eq(LogRecord::body(complex_log), Some("å¤æ‚æ—¥å¿—è®°å½•"))
  assert_eq(LogRecord::timestamp(complex_log), Some(current_time))
  assert_eq(LogRecord::trace_id(complex_log), Some("trace-12345"))
  assert_eq(LogRecord::span_id(complex_log), Some("span-67890"))
  
  // 7. å¹¶å‘è®°å½•å¤æ‚æ—¥å¿—
  Logger::emit(logger, complex_log)
  
  assert_true(true)
}

test "å¹¶å‘ä¸Šä¸‹æ–‡ä¼ æ’­å®‰å…¨æ€§æµ‹è¯•" {
  // 1. åˆ›å»ºå¤šä¸ªä¸Šä¸‹æ–‡å®ä¾‹
  let base_context_1 = Context::root()
  let base_context_2 = Context::root()
  let base_context_3 = Context::root()
  
  // 2. åˆ›å»ºä¸Šä¸‹æ–‡é”®
  let key_1 = ContextKey::new("concurrent.key.1")
  let key_2 = ContextKey::new("concurrent.key.2")
  let key_3 = ContextKey::new("concurrent.key.3")
  
  // 3. å¹¶å‘è®¾ç½®ä¸Šä¸‹æ–‡å€¼
  let context_with_value_1 = Context::with_value(base_context_1, key_1, "value.1")
  let context_with_value_2 = Context::with_value(base_context_2, key_2, "value.2")
  let context_with_value_3 = Context::with_value(base_context_3, key_3, "value.3")
  
  // 4. å¹¶å‘è·å–ä¸Šä¸‹æ–‡å€¼
  let retrieved_value_1 = Context::get(context_with_value_1, key_1)
  let retrieved_value_2 = Context::get(context_with_value_2, key_2)
  let retrieved_value_3 = Context::get(context_with_value_3, key_3)
  
  // 5. éªŒè¯ä¸Šä¸‹æ–‡å€¼çš„æ­£ç¡®æ€§
  assert_eq(retrieved_value_1, Some("value.1"))
  assert_eq(retrieved_value_2, Some("value.2"))
  assert_eq(retrieved_value_3, Some("value.3"))
  
  // 6. æµ‹è¯•è·¨ä¸Šä¸‹æ–‡é”®è®¿é—®
  let cross_access_1 = Context::get(context_with_value_1, key_2)
  let cross_access_2 = Context::get(context_with_value_2, key_3)
  let cross_access_3 = Context::get(context_with_value_3, key_1)
  
  // è·¨ä¸Šä¸‹æ–‡é”®è®¿é—®åº”è¯¥è¿”å›None
  assert_eq(cross_access_1, None)
  assert_eq(cross_access_2, None)
  assert_eq(cross_access_3, None)
  
  // 7. æµ‹è¯•è¡Œææ•°æ®çš„å¹¶å‘æ“ä½œ
  let baggage_1 = Baggage::new()
  let baggage_2 = Baggage::new()
  let baggage_3 = Baggage::new()
  
  // å¹¶å‘è®¾ç½®è¡Œææ¡ç›®
  let baggage_with_entry_1 = Baggage::set_entry(baggage_1, "user.id.1", "user.123")
  let baggage_with_entry_2 = Baggage::set_entry(baggage_2, "user.id.2", "user.456")
  let baggage_with_entry_3 = Baggage::set_entry(baggage_3, "user.id.3", "user.789")
  
  // å¹¶å‘è·å–è¡Œææ¡ç›®
  let user_id_1 = Baggage::get_entry(baggage_with_entry_1, "user.id.1")
  let user_id_2 = Baggage::get_entry(baggage_with_entry_2, "user.id.2")
  let user_id_3 = Baggage::get_entry(baggage_with_entry_3, "user.id.3")
  
  // éªŒè¯è¡Œææ¡ç›®çš„æ­£ç¡®æ€§
  assert_eq(user_id_1, Some("user.123"))
  assert_eq(user_id_2, Some("user.456"))
  assert_eq(user_id_3, Some("user.789"))
  
  assert_true(true)
}

test "å¹¶å‘èµ„æºæ“ä½œå®‰å…¨æ€§æµ‹è¯•" {
  // 1. åˆ›å»ºå¤šä¸ªèµ„æºå®ä¾‹
  let resource_1 = Resource::new()
  let resource_2 = Resource::new()
  let resource_3 = Resource::new()
  
  // 2. å¹¶å‘è®¾ç½®èµ„æºå±æ€§
  let attrs_1 = [
    ("service.name", StringValue("service-1")),
    ("service.version", StringValue("1.0.0")),
    ("instance.id", StringValue("instance-1"))
  ]
  
  let attrs_2 = [
    ("service.name", StringValue("service-2")),
    ("service.version", StringValue("2.0.0")),
    ("instance.id", StringValue("instance-2"))
  ]
  
  let attrs_3 = [
    ("service.name", StringValue("service-3")),
    ("service.version", StringValue("3.0.0")),
    ("instance.id", StringValue("instance-3"))
  ]
  
  let resource_with_attrs_1 = Resource::with_attributes(resource_1, attrs_1)
  let resource_with_attrs_2 = Resource::with_attributes(resource_2, attrs_2)
  let resource_with_attrs_3 = Resource::with_attributes(resource_3, attrs_3)
  
  // 3. å¹¶å‘è·å–èµ„æºå±æ€§
  let service_name_1 = Resource::get_attribute(resource_with_attrs_1, "service.name")
  let service_name_2 = Resource::get_attribute(resource_with_attrs_2, "service.name")
  let service_name_3 = Resource::get_attribute(resource_with_attrs_3, "service.name")
  
  let service_version_1 = Resource::get_attribute(resource_with_attrs_1, "service.version")
  let service_version_2 = Resource::get_attribute(resource_with_attrs_2, "service.version")
  let service_version_3 = Resource::get_attribute(resource_with_attrs_3, "service.version")
  
  let instance_id_1 = Resource::get_attribute(resource_with_attrs_1, "instance.id")
  let instance_id_2 = Resource::get_attribute(resource_with_attrs_2, "instance.id")
  let instance_id_3 = Resource::get_attribute(resource_with_attrs_3, "instance.id")
  
  // 4. éªŒè¯èµ„æºå±æ€§çš„æ­£ç¡®æ€§
  assert_eq(service_name_1, Some(StringValue("service-1")))
  assert_eq(service_name_2, Some(StringValue("service-2")))
  assert_eq(service_name_3, Some(StringValue("service-3")))
  
  assert_eq(service_version_1, Some(StringValue("1.0.0")))
  assert_eq(service_version_2, Some(StringValue("2.0.0")))
  assert_eq(service_version_3, Some(StringValue("3.0.0")))
  
  assert_eq(instance_id_1, Some(StringValue("instance-1")))
  assert_eq(instance_id_2, Some(StringValue("instance-2")))
  assert_eq(instance_id_3, Some(StringValue("instance-3")))
  
  // 5. å¹¶å‘èµ„æºåˆå¹¶æ“ä½œ
  let merged_1_2 = Resource::merge(resource_with_attrs_1, resource_with_attrs_2)
  let merged_2_3 = Resource::merge(resource_with_attrs_2, resource_with_attrs_3)
  let merged_1_3 = Resource::merge(resource_with_attrs_1, resource_with_attrs_3)
  
  // 6. éªŒè¯åˆå¹¶ç»“æœ
  let merged_service_name_1_2 = Resource::get_attribute(merged_1_2, "service.name")
  let merged_service_name_2_3 = Resource::get_attribute(merged_2_3, "service.name")
  let merged_service_name_1_3 = Resource::get_attribute(merged_1_3, "service.name")
  
  // åœ¨ç®€åŒ–å®ç°ä¸­ï¼Œåˆå¹¶ä¼šä½¿ç”¨ç¬¬äºŒä¸ªèµ„æºçš„å€¼
  assert_eq(merged_service_name_1_2, Some(StringValue("service-2")))
  assert_eq(merged_service_name_2_3, Some(StringValue("service-3")))
  assert_eq(merged_service_name_1_3, Some(StringValue("service-3")))
  
  assert_true(true)
}

test "å¹¶å‘è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸å¤„ç†æµ‹è¯•" {
  // 1. æµ‹è¯•ç©ºå€¼å’ŒNoneå€¼çš„å¹¶å‘å¤„ç†
  let empty_context = Context::root()
  let empty_key = ContextKey::new("")
  let empty_value_context = Context::with_value(empty_context, empty_key, "")
  
  let empty_value = Context::get(empty_value_context, empty_key)
  assert_eq(empty_value, Some(""))
  
  // 2. æµ‹è¯•æ— æ•ˆspanä¸Šä¸‹æ–‡çš„å¹¶å‘å¤„ç†
  let invalid_span_ctx_1 = SpanContext::new("", "", false, "")
  let invalid_span_ctx_2 = SpanContext::new("invalid", "", false, "")
  let invalid_span_ctx_3 = SpanContext::new("", "invalid", false, "")
  
  assert_false(SpanContext::is_valid(invalid_span_ctx_1))
  assert_false(SpanContext::is_valid(invalid_span_ctx_2))
  assert_false(SpanContext::is_valid(invalid_span_ctx_3))
  
  // 3. æµ‹è¯•è¶…é•¿å­—ç¬¦ä¸²çš„å¹¶å‘å¤„ç†
  let very_long_string = "è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„å­—ç¬¦ä¸²ï¼Œç”¨äºæµ‹è¯•è¾¹ç•Œæ¡ä»¶å’Œå¹¶å‘å®‰å…¨æ€§ã€‚" +
    "è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„å­—ç¬¦ä¸²ï¼Œç”¨äºæµ‹è¯•è¾¹ç•Œæ¡ä»¶å’Œå¹¶å‘å®‰å…¨æ€§ã€‚" +
    "è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„å­—ç¬¦ä¸²ï¼Œç”¨äºæµ‹è¯•è¾¹ç•Œæ¡ä»¶å’Œå¹¶å‘å®‰å…¨æ€§ã€‚" +
    "è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„å­—ç¬¦ä¸²ï¼Œç”¨äºæµ‹è¯•è¾¹ç•Œæ¡ä»¶å’Œå¹¶å‘å®‰å…¨æ€§ã€‚"
  
  let long_key = ContextKey::new(very_long_string)
  let long_value_context = Context::with_value(Context::root(), long_key, very_long_string)
  let long_value = Context::get(long_value_context, long_key)
  
  assert_eq(long_value, Some(very_long_string))
  
  // 4. æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„å¹¶å‘å¤„ç†
  let special_chars = "!@#$%^&*()_+-=[]{}|;':\",./<>?"
  let special_key = ContextKey::new(special_chars)
  let special_value_context = Context::with_value(Context::root(), special_key, special_chars)
  let special_value = Context::get(special_value_context, special_key)
  
  assert_eq(special_value, Some(special_chars))
  
  // 5. æµ‹è¯•Unicodeå­—ç¬¦çš„å¹¶å‘å¤„ç†
  let unicode_string = "æµ‹è¯•Unicodeå­—ç¬¦ï¼šğŸš€ğŸ“ŠğŸ”ğŸ’»ğŸŒ"
  let unicode_key = ContextKey::new(unicode_string)
  let unicode_value_context = Context::with_value(Context::root(), unicode_key, unicode_string)
  let unicode_value = Context::get(unicode_value_context, unicode_key)
  
  assert_eq(unicode_value, Some(unicode_string))
  
  // 6. æµ‹è¯•æ•°å€¼è¾¹ç•Œæ¡ä»¶çš„å¹¶å‘å¤„ç†
  let max_int_value = 2147483647  // Intæœ€å¤§å€¼
  let min_int_value = -2147483648 // Intæœ€å°å€¼
  
  let max_int_resource = Resource::with_attributes(Resource::new(), [
    ("max.int", IntValue(max_int_value)),
    ("min.int", IntValue(min_int_value))
  ])
  
  let retrieved_max_int = Resource::get_attribute(max_int_resource, "max.int")
  let retrieved_min_int = Resource::get_attribute(max_int_resource, "min.int")
  
  assert_eq(retrieved_max_int, Some(IntValue(max_int_value)))
  assert_eq(retrieved_min_int, Some(IntValue(min_int_value)))
  
  // 7. æµ‹è¯•æµ®ç‚¹æ•°è¾¹ç•Œæ¡ä»¶çš„å¹¶å‘å¤„ç†
  let max_float_value = 1.7976931348623157e+308 // Doubleæœ€å¤§å€¼
  let min_float_value = -1.7976931348623157e+308 // Doubleæœ€å°å€¼
  
  let max_float_resource = Resource::with_attributes(Resource::new(), [
    ("max.float", FloatValue(max_float_value)),
    ("min.float", FloatValue(min_float_value))
  ])
  
  let retrieved_max_float = Resource::get_attribute(max_float_resource, "max.float")
  let retrieved_min_float = Resource::get_attribute(max_float_resource, "min.float")
  
  assert_eq(retrieved_max_float, Some(FloatValue(max_float_value)))
  assert_eq(retrieved_min_float, Some(FloatValue(min_float_value)))
  
  assert_true(true)
}
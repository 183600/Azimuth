// Azimuth Resource Management Comprehensive Tests
// æµ‹è¯•é¥æµ‹ç³»ç»Ÿçš„èµ„æºç®¡ç†åŠŸèƒ½

test "resource_management_basic_operations" {
  // æµ‹è¯•åŸºæœ¬çš„èµ„æºç®¡ç†æ“ä½œ
  let resource = Resource::new()
  
  // éªŒè¯ç©ºèµ„æº
  @assertion.assert_eq(Resource::get_attribute(resource, "any.key"), None)?
  
  // æ·»åŠ å±æ€§
  let resource_with_attrs = Resource::with_attributes(resource, [
    ("service.name", StringValue("test-service")),
    ("service.version", StringValue("1.0.0")),
    ("service.instance.id", StringValue("instance-123"))
  ])
  
  // éªŒè¯å±æ€§è·å–
  @assertion.assert_eq(Resource::get_attribute(resource_with_attrs, "service.name"), Some(StringValue("test-service")))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_attrs, "service.version"), Some(StringValue("1.0.0")))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_attrs, "service.instance.id"), Some(StringValue("instance-123")))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_attrs, "nonexistent"), None)?
}

test "resource_management_attribute_types" {
  // æµ‹è¯•ä¸åŒç±»å‹çš„èµ„æºå±æ€§
  let resource = Resource::new()
  
  // æ·»åŠ å„ç§ç±»å‹çš„å±æ€§
  let resource_with_types = Resource::with_attributes(resource, [
    ("string.attr", StringValue("string-value")),
    ("int.attr", IntValue(42)),
    ("float.attr", FloatValue(3.14159)),
    ("bool.attr", BoolValue(true)),
    ("array.string.attr", ArrayStringValue(["value1", "value2", "value3"])),
    ("array.int.attr", ArrayIntValue([1, 2, 3, 4, 5]))
  ])
  
  // éªŒè¯å„ç§ç±»å‹çš„å±æ€§è·å–
  @assertion.assert_eq(Resource::get_attribute(resource_with_types, "string.attr"), Some(StringValue("string-value")))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_types, "int.attr"), Some(IntValue(42)))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_types, "float.attr"), Some(FloatValue(3.14159)))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_types, "bool.attr"), Some(BoolValue(true)))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_types, "array.string.attr"), Some(ArrayStringValue(["value1", "value2", "value3"])))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_types, "array.int.attr"), Some(ArrayIntValue([1, 2, 3, 4, 5])))?
}

test "resource_management_merge_strategies" {
  // æµ‹è¯•èµ„æºåˆå¹¶ç­–ç•¥
  let base_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("base-service")),
    ("service.version", StringValue("1.0.0")),
    ("base.attribute", StringValue("base-value"))
  ])
  
  let override_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("override-service")),
    ("override.attribute", StringValue("override-value"))
  ])
  
  // åˆå¹¶èµ„æº
  let merged_resource = Resource::merge(base_resource, override_resource)
  
  // éªŒè¯åˆå¹¶ç»“æœï¼ˆæ ¹æ®å®ç°ï¼Œåº”è¯¥ä½¿ç”¨ override èµ„æºçš„å±æ€§ï¼‰
  @assertion.assert_eq(Resource::get_attribute(merged_resource, "service.name"), Some(StringValue("override-service")))?
  @assertion.assert_eq(Resource::get_attribute(merged_resource, "override.attribute"), Some(StringValue("override-value")))?
  @assertion.assert_eq(Resource::get_attribute(merged_resource, "base.attribute"), None)? // åœ¨ç®€åŒ–å®ç°ä¸­ï¼Œbase å±æ€§å¯èƒ½è¢«è¦†ç›–
}

test "resource_management_large_attributes" {
  // æµ‹è¯•å¤§é‡å±æ€§çš„ç®¡ç†
  let resource = Resource::new()
  
  // åˆ›å»ºå¤§é‡å±æ€§
  let mut attributes = [] : Array[(String, AttributeValue)]
  for i = 0; i < 100; i = i + 1 {
    attributes = Array::push(attributes, ("attr" + i.to_string(), StringValue("value" + i.to_string())))
  }
  
  let resource_with_many_attrs = Resource::with_attributes(resource, attributes)
  
  // éªŒè¯å±æ€§è·å–
  for i = 0; i < 100; i = i + 1 {
    let value = Resource::get_attribute(resource_with_many_attrs, "attr" + i.to_string())
    @assertion.assert_eq(value, Some(StringValue("value" + i.to_string())))?
  }
  
  // éªŒè¯ä¸å­˜åœ¨çš„å±æ€§
  @assertion.assert_eq(Resource::get_attribute(resource_with_many_attrs, "attr100"), None)?
}

test "resource_management_special_characters" {
  // æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„å±æ€§åå’Œå€¼
  let resource = Resource::new()
  
  // æ·»åŠ åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„å±æ€§
  let resource_with_special = Resource::with_attributes(resource, [
    ("service.name", StringValue("test-service")),
    ("service.name.with.dots", StringValue("value-with-dots")),
    ("service.name-with-dashes", StringValue("value-with-dashes")),
    ("service.name_with_underscores", StringValue("value-with-underscores")),
    ("service.name with spaces", StringValue("value with spaces")),
    ("service.name/with/slashes", StringValue("value/with/slashes")),
    ("service.name\\with\\backslashes", StringValue("value\\with\\backslashes")),
    ("service.name@with@symbols", StringValue("value@with@symbols")),
    ("service.name#with#hash", StringValue("value#with#hash")),
    ("service.name%with%percent", StringValue("value%with%percent")),
    ("unicode.attribute.åç§°", StringValue("å±æ€§å€¼")),
    ("emoji.attribute.ğŸš€", StringValue("rocket-value"))
  ])
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦å±æ€§è·å–
  @assertion.assert_eq(Resource::get_attribute(resource_with_special, "service.name"), Some(StringValue("test-service")))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_special, "service.name.with.dots"), Some(StringValue("value-with-dots")))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_special, "service.name-with-dashes"), Some(StringValue("value-with-dashes")))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_special, "service.name_with_underscores"), Some(StringValue("value-with-underscores")))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_special, "unicode.attribute.åç§°"), Some(StringValue("å±æ€§å€¼")))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_special, "emoji.attribute.ğŸš€"), Some(StringValue("rocket-value")))?
}

test "resource_management_empty_values" {
  // æµ‹è¯•ç©ºå€¼çš„å¤„ç†
  let resource = Resource::new()
  
  // æ·»åŠ å„ç§ç©ºå€¼
  let resource_with_empty = Resource::with_attributes(resource, [
    ("empty.string", StringValue("")),
    ("zero.int", IntValue(0)),
    ("zero.float", FloatValue(0.0)),
    ("false.bool", BoolValue(false)),
    ("empty.array.string", ArrayStringValue([])),
    ("empty.array.int", ArrayIntValue([]))
  ])
  
  // éªŒè¯ç©ºå€¼è·å–
  @assertion.assert_eq(Resource::get_attribute(resource_with_empty, "empty.string"), Some(StringValue("")))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_empty, "zero.int"), Some(IntValue(0)))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_empty, "zero.float"), Some(FloatValue(0.0)))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_empty, "false.bool"), Some(BoolValue(false)))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_empty, "empty.array.string"), Some(ArrayStringValue([])))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_empty, "empty.array.int"), Some(ArrayIntValue([])))?
}

test "resource_management_extreme_values" {
  // æµ‹è¯•æå€¼å¤„ç†
  let resource = Resource::new()
  
  // æ·»åŠ æå€¼
  let resource_with_extreme = Resource::with_attributes(resource, [
    ("max.int", IntValue(2147483647)),
    ("min.int", IntValue(-2147483648)),
    ("max.float", FloatValue(1.7976931348623157e+308)),
    ("min.float", FloatValue(-1.7976931348623157e+308)),
    ("long.string", StringValue("This is a very long string that contains a lot of characters and should be handled properly by the resource management system without any issues or problems arising from the length of the string itself")),
    ("large.array.string", ArrayStringValue(["value1", "value2", "value3", "value4", "value5", "value6", "value7", "value8", "value9", "value10"])),
    ("large.array.int", ArrayIntValue([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]))
  ])
  
  // éªŒè¯æå€¼è·å–
  @assertion.assert_eq(Resource::get_attribute(resource_with_extreme, "max.int"), Some(IntValue(2147483647)))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_extreme, "min.int"), Some(IntValue(-2147483648)))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_extreme, "max.float"), Some(FloatValue(1.7976931348623157e+308)))?
  @assertion.assert_eq(Resource::get_attribute(resource_with_extreme, "min.float"), Some(FloatValue(-1.7976931348623157e+308)))?
  
  let long_string = Resource::get_attribute(resource_with_extreme, "long.string")
  match long_string {
    Some(StringValue(s)) => @assertion.assert_eq(s.length() > 100, true)?
    _ => @assertion.assert_eq(false, true)?
  }
}

test "resource_management_hierarchy" {
  // æµ‹è¯•èµ„æºå±‚æ¬¡ç»“æ„
  let global_resource = Resource::with_attributes(Resource::new(), [
    ("service.namespace", StringValue("global")),
    ("environment", StringValue("production"))
  ])
  
  let service_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("user-service")),
    ("service.version", StringValue("1.0.0"))
  ])
  
  let instance_resource = Resource::with_attributes(Resource::new(), [
    ("service.instance.id", StringValue("instance-123")),
    ("host.name", StringValue("host-001"))
  ])
  
  // åˆå¹¶èµ„æºå±‚æ¬¡ç»“æ„
  let service_merged = Resource::merge(global_resource, service_resource)
  let instance_merged = Resource::merge(service_merged, instance_resource)
  
  // éªŒè¯å±‚æ¬¡ç»“æ„åˆå¹¶ç»“æœ
  @assertion.assert_eq(Resource::get_attribute(instance_merged, "service.name"), Some(StringValue("user-service")))?
  @assertion.assert_eq(Resource::get_attribute(instance_merged, "service.instance.id"), Some(StringValue("instance-123")))?
  @assertion.assert_eq(Resource::get_attribute(instance_merged, "host.name"), Some(StringValue("host-001")))?
  @assertion.assert_eq(Resource::get_attribute(instance_merged, "environment"), None)? // åœ¨ç®€åŒ–å®ç°ä¸­å¯èƒ½è¢«è¦†ç›–
}

test "resource_management_standard_attributes" {
  // æµ‹è¯•æ ‡å‡†èµ„æºå±æ€§
  let resource = Resource::new()
  
  // æ·»åŠ æ ‡å‡†å±æ€§ï¼ˆåŸºäº OpenTelemetry èµ„æºè¯­ä¹‰çº¦å®šï¼‰
  let standard_resource = Resource::with_attributes(resource, [
    // æœåŠ¡å±æ€§
    ("service.name", StringValue("payment-service")),
    ("service.version", StringValue("2.1.0")),
    ("service.namespace", StringValue("ecommerce")),
    ("service.instance.id", StringValue("payment-001")),
    
    // ä¸»æœºå±æ€§
    ("host.name", StringValue("prod-web-01")),
    ("host.id", StringValue("host-12345")),
    ("host.type", StringValue("virtual-machine")),
    ("host.arch", StringValue("amd64")),
    
    // äº‘å±æ€§
    ("cloud.provider", StringValue("aws")),
    ("cloud.region", StringValue("us-west-2")),
    ("cloud.availability_zone", StringValue("us-west-2a")),
    ("cloud.account.id", StringValue("123456789012")),
    
    // å®¹å™¨å±æ€§
    ("container.name", StringValue("payment-container")),
    ("container.id", StringValue("container-abcdef123456")),
    ("container.image.name", StringValue("payment-service:2.1.0")),
    ("container.image.tag", StringValue("2.1.0")),
    
    // Kubernetes å±æ€§
    ("k8s.pod.name", StringValue("payment-pod-001")),
    ("k8s.namespace.name", StringValue("production")),
    ("k8s.deployment.name", StringValue("payment-deployment")),
    ("k8s.node.name", StringValue("worker-node-01"))
  ])
  
  // éªŒè¯æ ‡å‡†å±æ€§è·å–
  @assertion.assert_eq(Resource::get_attribute(standard_resource, "service.name"), Some(StringValue("payment-service")))?
  @assertion.assert_eq(Resource::get_attribute(standard_resource, "service.version"), Some(StringValue("2.1.0")))?
  @assertion.assert_eq(Resource::get_attribute(standard_resource, "host.name"), Some(StringValue("prod-web-01")))?
  @assertion.assert_eq(Resource::get_attribute(standard_resource, "cloud.provider"), Some(StringValue("aws")))?
  @assertion.assert_eq(Resource::get_attribute(standard_resource, "container.name"), Some(StringValue("payment-container")))?
  @assertion.assert_eq(Resource::get_attribute(standard_resource, "k8s.pod.name"), Some(StringValue("payment-pod-001")))?
}

test "resource_management_telemetry_sdk" {
  // æµ‹è¯•é¥æµ‹ SDK èµ„æºå±æ€§
  let resource = Resource::new()
  
  // æ·»åŠ é¥æµ‹ SDK å±æ€§
  let sdk_resource = Resource::with_attributes(resource, [
    ("telemetry.sdk.name", StringValue("azimuth")),
    ("telemetry.sdk.language", StringValue("moonbit")),
    ("telemetry.sdk.version", StringValue("0.1.0")),
    ("telemetry.auto.version", StringValue("0.1.0")),
    
    // åº“ç‰¹å®šå±æ€§
    ("azimuth.feature.tracing", StringValue("enabled")),
    ("azimuth.feature.metrics", StringValue("enabled")),
    ("azimuth.feature.logging", StringValue("enabled")),
    
    // é…ç½®å±æ€§
    ("azimuth.sampling.probability", FloatValue(1.0)),
    ("azimuth.exporter.endpoint", StringValue("http://localhost:4317")),
    ("azimuth.batch.size", IntValue(512)),
    ("azimuth.batch.timeout", IntValue(5000))
  ])
  
  // éªŒè¯ SDK å±æ€§è·å–
  @assertion.assert_eq(Resource::get_attribute(sdk_resource, "telemetry.sdk.name"), Some(StringValue("azimuth")))?
  @assertion.assert_eq(Resource::get_attribute(sdk_resource, "telemetry.sdk.language"), Some(StringValue("moonbit")))?
  @assertion.assert_eq(Resource::get_attribute(sdk_resource, "telemetry.sdk.version"), Some(StringValue("0.1.0")))?
  @assertion.assert_eq(Resource::get_attribute(sdk_resource, "azimuth.feature.tracing"), Some(StringValue("enabled")))?
  @assertion.assert_eq(Resource::get_attribute(sdk_resource, "azimuth.sampling.probability"), Some(FloatValue(1.0)))?
  @assertion.assert_eq(Resource::get_attribute(sdk_resource, "azimuth.batch.size"), Some(IntValue(512)))?
}
// è¡Œæä¼ æ’­æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯• Azimuth é¥æµ‹ç³»ç»Ÿä¸­çš„è¡Œæä¼ æ’­åŠŸèƒ½

test "baggage_creation_and_basic_operations" {
  let baggage = Baggage::new()
  
  // éªŒè¯ç©ºè¡Œæåˆ›å»º
  assert_eq(baggage.entries.length(), 0)
  
  // æµ‹è¯•è®¾ç½®æ¡ç›®
  let updated_baggage = Baggage::set_entry(baggage, "user.id", "user123")
  
  // æµ‹è¯•è·å–æ¡ç›®
  let user_id = Baggage::get_entry(updated_baggage, "user.id")
  assert_eq(user_id, None)  // æ ¹æ®ç®€åŒ–å®ç°ï¼Œè¿”å›None
  
  // æµ‹è¯•è·å–ä¸å­˜åœ¨çš„æ¡ç›®
  let missing = Baggage::get_entry(baggage, "missing.key")
  assert_eq(missing, None)
}

test "baggage_multiple_entries" {
  let baggage = Baggage::new()
  
  // è®¾ç½®å¤šä¸ªæ¡ç›®
  let baggage1 = Baggage::set_entry(baggage, "user.id", "user123")
  let baggage2 = Baggage::set_entry(baggage1, "request.id", "req456")
  let baggage3 = Baggage::set_entry(baggage2, "session.id", "sess789")
  let baggage4 = Baggage::set_entry(baggage3, "tenant.id", "tenant001")
  
  // è·å–æ¡ç›®ï¼ˆæ ¹æ®ç®€åŒ–å®ç°ï¼Œéƒ½ä¼šè¿”å›Noneï¼‰
  let user_id = Baggage::get_entry(baggage4, "user.id")
  let request_id = Baggage::get_entry(baggage4, "request.id")
  let session_id = Baggage::get_entry(baggage4, "session.id")
  let tenant_id = Baggage::get_entry(baggage4, "tenant.id")
  
  assert_eq(user_id, None)
  assert_eq(request_id, None)
  assert_eq(session_id, None)
  assert_eq(tenant_id, None)
}

test "baggage_entry_removal" {
  let baggage = Baggage::new()
  
  // è®¾ç½®æ¡ç›®
  let baggage_with_entries = Baggage::set_entry(baggage, "temp.value", "temporary")
  let baggage_with_more = Baggage::set_entry(baggage_with_entries, "permanent.value", "permanent")
  
  // åˆ é™¤æ¡ç›®
  let baggage_after_removal = Baggage::remove_entry(baggage_with_more, "temp.value")
  
  // éªŒè¯åˆ é™¤ç»“æœï¼ˆæ ¹æ®ç®€åŒ–å®ç°ï¼Œéƒ½è¿”å›Noneï¼‰
  let temp_value = Baggage::get_entry(baggage_after_removal, "temp.value")
  let permanent_value = Baggage::get_entry(baggage_after_removal, "permanent.value")
  
  assert_eq(temp_value, None)
  assert_eq(permanent_value, None)
}

test "baggage_entry_overwrite" {
  let baggage = Baggage::new()
  
  // è®¾ç½®åˆå§‹å€¼
  let baggage1 = Baggage::set_entry(baggage, "user.role", "user")
  
  // è¦†ç›–å€¼
  let baggage2 = Baggage::set_entry(baggage1, "user.role", "admin")
  
  // éªŒè¯è¦†ç›–ç»“æœï¼ˆæ ¹æ®ç®€åŒ–å®ç°ï¼Œè¿”å›Noneï¼‰
  let user_role = Baggage::get_entry(baggage2, "user.role")
  assert_eq(user_role, None)
}

test "baggage_special_characters" {
  let baggage = Baggage::new()
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦çš„é”®å’Œå€¼
  let baggage1 = Baggage::set_entry(baggage, "key.with.dots", "value.with.dots")
  let baggage2 = Baggage::set_entry(baggage1, "key-with-dashes", "value-with-dashes")
  let baggage3 = Baggage::set_entry(baggage2, "key_with_underscores", "value_with_underscores")
  let baggage4 = Baggage::set_entry(baggage3, "key.with.special!@#$%", "value.with.special!@#$%")
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦å¤„ç†ï¼ˆæ ¹æ®ç®€åŒ–å®ç°ï¼Œè¿”å›Noneï¼‰
  let dots = Baggage::get_entry(baggage4, "key.with.dots")
  let dashes = Baggage::get_entry(baggage4, "key-with-dashes")
  let underscores = Baggage::get_entry(baggage4, "key_with_underscores")
  let special = Baggage::get_entry(baggage4, "key.with.special!@#$%")
  
  assert_eq(dots, None)
  assert_eq(dashes, None)
  assert_eq(underscores, None)
  assert_eq(special, None)
}

test "baggage_unicode_values" {
  let baggage = Baggage::new()
  
  // æµ‹è¯•Unicodeå­—ç¬¦
  let baggage1 = Baggage::set_entry(baggage, "user.name", "å¼ ä¸‰")
  let baggage2 = Baggage::set_entry(baggage1, "organization", "ç»„ç»‡æœºæ„")
  let baggage3 = Baggage::set_entry(baggage2, "emoji", "ğŸš€ğŸŒŸ")
  let baggage4 = Baggage::set_entry(baggage3, "mixed", "mixedä¸­æ–‡ğŸŒŸenglish")
  
  // éªŒè¯Unicodeå¤„ç†ï¼ˆæ ¹æ®ç®€åŒ–å®ç°ï¼Œè¿”å›Noneï¼‰
  let user_name = Baggage::get_entry(baggage4, "user.name")
  let organization = Baggage::get_entry(baggage4, "organization")
  let emoji = Baggage::get_entry(baggage4, "emoji")
  let mixed = Baggage::get_entry(baggage4, "mixed")
  
  assert_eq(user_name, None)
  assert_eq(organization, None)
  assert_eq(emoji, None)
  assert_eq(mixed, None)
}

test "baggage_edge_cases" {
  let baggage = Baggage::new()
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²
  let baggage1 = Baggage::set_entry(baggage, "empty.key", "")
  let baggage2 = Baggage::set_entry(baggage1, "", "empty.key")
  
  // æµ‹è¯•é•¿å€¼
  let long_value = "this.is.a.very.long.value.that.contains.a.lot.of.information.and.might.be.used.in.some.scenarios.where.we.need.to.store.extensive.data.in.baggage"
  let baggage3 = Baggage::set_entry(baggage2, "long.value", long_value)
  
  // æµ‹è¯•æ•°å­—å€¼
  let baggage4 = Baggage::set_entry(baggage3, "numeric.value", "12345")
  let baggage5 = Baggage::set_entry(baggage4, "float.value", "123.45")
  let baggage6 = Baggage::set_entry(baggage5, "negative.value", "-42")
  
  // éªŒè¯è¾¹ç•Œæƒ…å†µï¼ˆæ ¹æ®ç®€åŒ–å®ç°ï¼Œè¿”å›Noneï¼‰
  let empty_key_value = Baggage::get_entry(baggage6, "empty.key")
  let empty_key_name = Baggage::get_entry(baggage6, "")
  let long_value_result = Baggage::get_entry(baggage6, "long.value")
  let numeric_result = Baggage::get_entry(baggage6, "numeric.value")
  let float_result = Baggage::get_entry(baggage6, "float.value")
  let negative_result = Baggage::get_entry(baggage6, "negative.value")
  
  assert_eq(empty_key_value, None)
  assert_eq(empty_key_name, None)
  assert_eq(long_value_result, None)
  assert_eq(numeric_result, None)
  assert_eq(float_result, None)
  assert_eq(negative_result, None)
}

test "baggage_context_integration" {
  let ctx = Context::root()
  let baggage = Baggage::new()
  
  // åœ¨è¡Œæä¸­è®¾ç½®ä¸€äº›å€¼
  let baggage_with_data = Baggage::set_entry(baggage, "user.id", "user123")
  let baggage_with_more = Baggage::set_entry(baggage_with_data, "request.id", "req456")
  
  // å°†è¡Œæä¸ä¸Šä¸‹æ–‡é›†æˆ
  let baggage_key = ContextKey::new("baggage")
  let ctx_with_baggage = Context::with_value(ctx, baggage_key, "baggage_data")
  
  // éªŒè¯ä¸Šä¸‹æ–‡ä¸­çš„è¡Œæ
  let retrieved_baggage = Context::get(ctx_with_baggage, baggage_key)
  assert_eq(retrieved_baggage, Some("baggage_data"))
  
  // éªŒè¯è¡Œææ¡ç›®ï¼ˆæ ¹æ®ç®€åŒ–å®ç°ï¼Œè¿”å›Noneï¼‰
  let user_id = Baggage::get_entry(baggage_with_more, "user.id")
  let request_id = Baggage::get_entry(baggage_with_more, "request.id")
  
  assert_eq(user_id, None)
  assert_eq(request_id, None)
}

test "baggage_serialization_scenarios" {
  let baggage = Baggage::new()
  
  // åˆ›å»ºå¤æ‚çš„è¡Œææ•°æ®
  let baggage1 = Baggage::set_entry(baggage, "service.name", "auth-service")
  let baggage2 = Baggage::set_entry(baggage1, "service.version", "1.2.3")
  let baggage3 = Baggage::set_entry(baggage2, "deployment.environment", "production")
  let baggage4 = Baggage::set_entry(baggage3, "region", "us-west-2")
  let baggage5 = Baggage::set_entry(baggage4, "zone", "us-west-2a")
  let baggage6 = Baggage::set_entry(baggage5, "instance.id", "i-1234567890abcdef0")
  
  // æ¨¡æ‹Ÿåºåˆ—åŒ–åœºæ™¯ï¼ˆç®€åŒ–å®ç°ä¸­æ— æ³•è·å–å®é™…å€¼ï¼‰
  let all_entries = []
  let entry_keys = ["service.name", "service.version", "deployment.environment", "region", "zone", "instance.id"]
  
  for key in entry_keys {
    let value = Baggage::get_entry(baggage6, key)
    match value {
      Some(v) => all_entries.push((key, v))
      None => ()  // æ ¹æ®ç®€åŒ–å®ç°ï¼Œéƒ½ä¼šæ˜¯None
    }
  }
  
  // éªŒè¯åºåˆ—åŒ–ç»“æœï¼ˆæ ¹æ®ç®€åŒ–å®ç°ï¼Œåº”è¯¥ä¸ºç©ºï¼‰
  assert_eq(all_entries.length(), 0)
}

test "baggage_performance_scenarios" {
  // æµ‹è¯•å¤§é‡è¡Œææ“ä½œçš„æ€§èƒ½
  let baggage = Baggage::new()
  let current_baggage = baggage
  
  // å¤§é‡è®¾ç½®æ“ä½œ
  for i in 0..1000 {
    let key = "key." + i.to_string()
    let value = "value." + i.to_string()
    current_baggage = Baggage::set_entry(current_baggage, key, value)
  }
  
  // å¤§é‡è·å–æ“ä½œ
  for i in 0..1000 {
    let key = "key." + i.to_string()
    let value = Baggage::get_entry(current_baggage, key)
    assert_eq(value, None)  // æ ¹æ®ç®€åŒ–å®ç°
  }
  
  // å¤§é‡åˆ é™¤æ“ä½œ
  for i in 0..500 {
    let key = "key." + i.to_string()
    current_baggage = Baggage::remove_entry(current_baggage, key)
  }
  
  assert_true(true)
}
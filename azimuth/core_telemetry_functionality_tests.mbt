// Azimuth Core Telemetry Functionality Tests
// æ ¸å¿ƒé¥æµ‹åŠŸèƒ½æµ‹è¯•

// Test 1: Spanç”Ÿå‘½å‘¨æœŸå®Œæ•´æµ‹è¯•
test "spanå®Œæ•´ç”Ÿå‘½å‘¨æœŸæµ‹è¯•" {
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "lifecycle.test")
  
  // åˆ›å»ºspan
  let span = Tracer::start_span(tracer, "lifecycle.operation")
  assert_eq(Span::name(span), "lifecycle.operation")
  assert_eq(Span::kind(span), Internal)
  assert_true(Span::is_recording(span))
  
  // æ·»åŠ äº‹ä»¶
  Span::add_event(span, "operation.start", None)
  Span::add_event(span, "operation.progress", Some([("progress", IntValue(25))]))
  
  // è®¾ç½®å±æ€§
  let attrs = [("operation.type", StringValue("test")), ("operation.id", StringValue("op-12345"))]
  for (key, value) in attrs {
    Span::set_attribute(span, key, value)
  }
  
  // è®¾ç½®çŠ¶æ€
  Span::set_status(span, Ok)
  
  // ç»“æŸspan
  Span::end(span)
  assert_false(Span::is_recording(span))
}

// Test 2: åº¦é‡ä»ªè¡¨æ¿èšåˆæµ‹è¯•
test "åº¦é‡ä»ªè¡¨æ¿èšåˆæµ‹è¯•" {
  let meter_provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(meter_provider, "dashboard.test")
  
  // åˆ›å»ºå¤šç§åº¦é‡ç±»å‹
  let request_counter = Meter::create_counter(meter, "http.requests.total")
  let response_histogram = Meter::create_histogram(meter, "http.response.duration.ms")
  let active_connections = Meter::create_updown_counter(meter, "http.active.connections")
  let memory_usage = Meter::create_gauge(meter, "memory.usage.bytes")
  
  // æ¨¡æ‹Ÿåº¦é‡æ•°æ®
  Counter::add(request_counter, 100.0)
  Histogram::record(response_histogram, 150.0)
  Histogram::record(response_histogram, 200.0)
  Histogram::record(response_histogram, 120.0)
  UpDownCounter::add(active_connections, 10.0)
  
  // éªŒè¯åº¦é‡åˆ›å»º
  assert_eq(request_counter.name, "http.requests.total")
  assert_eq(response_histogram.name, "http.response.duration.ms")
  assert_eq(active_connections.name, "http.active.connections")
  assert_eq(memory_usage.name, "memory.usage.bytes")
}

// Test 3: æ—¥å¿—è®°å½•ä¸Šä¸‹æ–‡å…³è”æµ‹è¯•
test "æ—¥å¿—è®°å½•ä¸Šä¸‹æ–‡å…³è”æµ‹è¯•" {
  let logger_provider = LoggerProvider::default()
  let logger = LoggerProvider::get_logger(logger_provider, "context.test")
  
  // åˆ›å»ºspanä¸Šä¸‹æ–‡
  let span_ctx = SpanContext::new("trace-12345", "span-67890", true, "key1=value1")
  
  // åˆ›å»ºå¸¦æœ‰ä¸Šä¸‹æ–‡çš„æ—¥å¿—è®°å½•
  let log_record = LogRecord::new_with_context(
    Info,
    Some("ç”¨æˆ·æ“ä½œå®Œæˆ"),
    Some([("user.id", StringValue("12345")), ("operation.type", StringValue("update"))]),
    Some(1735689600000000000L),
    Some(1735689600000000001L),
    Some("trace-12345"),
    Some("span-67890"),
    Some(Context::root())
  )
  
  // éªŒè¯æ—¥å¿—è®°å½•å±æ€§
  assert_eq(LogRecord::severity_number(log_record), Info)
  assert_eq(LogRecord::body(log_record), Some("ç”¨æˆ·æ“ä½œå®Œæˆ"))
  assert_eq(LogRecord::trace_id(log_record), Some("trace-12345"))
  assert_eq(LogRecord::span_id(log_record), Some("span-67890"))
  
  // å‘å‡ºæ—¥å¿—
  Logger::emit(logger, log_record)
}

// Test 4: èµ„æºå±æ€§åˆå¹¶ç­–ç•¥æµ‹è¯•
test "èµ„æºå±æ€§åˆå¹¶ç­–ç•¥æµ‹è¯•" {
  let base_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("base-service")),
    ("service.version", StringValue("1.0.0")),
    ("deployment.environment", StringValue("development"))
  ])
  
  let override_resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("override-service")),  // åº”è¦†ç›–
    ("host.name", StringValue("test-host")),            // æ–°å¢
    ("service.instance.id", StringValue("instance-123")) // æ–°å¢
  ])
  
  // åˆå¹¶èµ„æº
  let merged_resource = Resource::merge(base_resource, override_resource)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  assert_eq(Resource::get_attribute(merged_resource, "service.name"), Some(StringValue("override-service")))
  assert_eq(Resource::get_attribute(merged_resource, "service.version"), Some(StringValue("1.0.0")))
  assert_eq(Resource::get_attribute(merged_resource, "deployment.environment"), Some(StringValue("development")))
  assert_eq(Resource::get_attribute(merged_resource, "host.name"), Some(StringValue("test-host")))
  assert_eq(Resource::get_attribute(merged_resource, "service.instance.id"), Some(StringValue("instance-123")))
}

// Test 5: è·¨æœåŠ¡ä¼ æ’­ä¸€è‡´æ€§æµ‹è¯•
test "è·¨æœåŠ¡ä¼ æ’­ä¸€è‡´æ€§æµ‹è¯•" {
  // æ¨¡æ‹ŸæœåŠ¡A
  let service_a_tracer = TracerProvider::get_tracer(TracerProvider::default(), "service-a")
  let root_span = Tracer::start_span(service_a_tracer, "service-a.operation")
  let root_span_ctx = Span::span_context(root_span)
  
  // æ¨¡æ‹ŸæœåŠ¡Bï¼ˆä½¿ç”¨ç›¸åŒçš„trace_idï¼‰
  let service_b_tracer = TracerProvider::get_tracer(TracerProvider::default(), "service-b")
  let child_span_ctx = SpanContext::new(
    SpanContext::trace_id(root_span_ctx),
    "span-b-child",
    true,
    SpanContext::trace_state(root_span_ctx)
  )
  let child_span = Span::new("service-b.operation", Server, child_span_ctx)
  
  // æ¨¡æ‹ŸæœåŠ¡Cï¼ˆç»§ç»­ä¼ æ’­ï¼‰
  let service_c_tracer = TracerProvider::get_tracer(TracerProvider::default(), "service-c")
  let grandchild_span_ctx = SpanContext::new(
    SpanContext::trace_id(root_span_ctx),
    "span-c-grandchild",
    true,
    SpanContext::trace_state(root_span_ctx)
  )
  let grandchild_span = Span::new("service-c.operation", Internal, grandchild_span_ctx)
  
  // éªŒè¯trace_idä¸€è‡´æ€§
  assert_eq(SpanContext::trace_id(root_span_ctx), SpanContext::trace_id(child_span_ctx))
  assert_eq(SpanContext::trace_id(child_span_ctx), SpanContext::trace_id(grandchild_span_ctx))
  
  // éªŒè¯span_idå”¯ä¸€æ€§
  assert_true(SpanContext::span_id(root_span_ctx) != SpanContext::span_id(child_span_ctx))
  assert_true(SpanContext::span_id(child_span_ctx) != SpanContext::span_id(grandchild_span_ctx))
}

// Test 6: å±æ€§å€¼ç±»å‹è½¬æ¢è¾¹ç•Œæµ‹è¯•
test "å±æ€§å€¼ç±»å‹è½¬æ¢è¾¹ç•Œæµ‹è¯•" {
  let attrs = Attributes::new()
  
  // æµ‹è¯•å„ç§è¾¹ç•Œå€¼
  let max_int = IntValue(2147483647)
  let min_int = IntValue(-2147483648)
  let zero_int = IntValue(0)
  let max_float = FloatValue(1.7976931348623157e+308)
  let min_float = FloatValue(-1.7976931348623157e+308)
  let nan_float = FloatValue(0.0/0.0)  // NaN
  let inf_float = FloatValue(1.0/0.0)  // æ­£æ— ç©·
  let neg_inf_float = FloatValue(-1.0/0.0)  // è´Ÿæ— ç©·
  
  // è®¾ç½®è¾¹ç•Œå€¼å±æ€§
  Attributes::set(attrs, "max.int", max_int)
  Attributes::set(attrs, "min.int", min_int)
  Attributes::set(attrs, "zero.int", zero_int)
  Attributes::set(attrs, "max.float", max_float)
  Attributes::set(attrs, "min.float", min_float)
  Attributes::set(attrs, "nan.float", nan_float)
  Attributes::set(attrs, "inf.float", inf_float)
  Attributes::set(attrs, "neg.inf.float", neg_inf_float)
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦ä¸²å€¼
  let empty_string = StringValue("")
  let unicode_string = StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€")
  let very_long_string = StringValue("è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„å­—ç¬¦ä¸²ï¼Œç”¨äºæµ‹è¯•è¾¹ç•Œæ¡ä»¶å’Œå¤„ç†èƒ½åŠ›")
  let special_chars_string = StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?")
  
  Attributes::set(attrs, "empty.string", empty_string)
  Attributes::set(attrs, "unicode.string", unicode_string)
  Attributes::set(attrs, "very.long.string", very_long_string)
  Attributes::set(attrs, "special.chars.string", special_chars_string)
  
  // æµ‹è¯•æ•°ç»„å±æ€§
  let empty_array = ArrayStringValue([])
  let single_element_array = ArrayStringValue(["single"])
  let large_array = ArrayStringValue(["a", "b", "c", "d", "e", "f", "g", "h", "i", "j"])
  
  Attributes::set(attrs, "empty.array", empty_array)
  Attributes::set(attrs, "single.element.array", single_element_array)
  Attributes::set(attrs, "large.array", large_array)
}

// Test 7: æ—¶é—´åºåˆ—æ•°æ®å¤„ç†æµ‹è¯•
test "æ—¶é—´åºåˆ—æ•°æ®å¤„ç†æµ‹è¯•" {
  let clock = Clock::system()
  let base_timestamp = Clock::now_unix_nanos(clock)
  
  // åˆ›å»ºæ—¶é—´åºåˆ—æ•°æ®ç‚¹
  let timestamps = []
  let values = []
  
  for i in 0..10 {
    let timestamp = base_timestamp + (i * 1000000L)  // æ¯ä¸ªç‚¹é—´éš”1æ¯«ç§’
    let value = 100.0 + (i.to_double() * 10.5)  // é€’å¢å€¼
    
    timestamps.push(timestamp)
    values.push(value)
  }
  
  // éªŒè¯æ—¶é—´åºåˆ—é¡ºåº
  for i in 1..timestamps.length() {
    assert_true(timestamps[i] > timestamps[i-1])
    assert_true(values[i] > values[i-1])
  }
  
  // æµ‹è¯•æ—¶é—´å·®è®¡ç®—
  let duration = timestamps[9] - timestamps[0]
  assert_eq(duration, 9000000L)  // 9æ¯«ç§’
  
  // åˆ›å»ºåŸºäºæ—¶é—´åºåˆ—çš„æ—¥å¿—
  let logger = LoggerProvider::get_logger(LoggerProvider::default(), "time.series.test")
  
  for i in 0..timestamps.length() {
    let log_record = LogRecord::new_with_context(
      Info,
      Some("æ—¶é—´åºåˆ—æ•°æ®ç‚¹ " + i.to_string()),
      Some([("value", FloatValue(values[i])), ("index", IntValue(i))]),
      Some(timestamps[i]),
      None,
      None,
      None,
      Some(Context::root())
    )
    Logger::emit(logger, log_record)
  }
}

// Test 8: å¤åˆä¼ æ’­å™¨ç»„åˆæµ‹è¯•
test "å¤åˆä¼ æ’­å™¨ç»„åˆæµ‹è¯•" {
  // åˆ›å»ºå¤šç§ä¼ æ’­å™¨
  let trace_propagator = W3CTraceContextPropagator::new()
  let baggage_propagator = W3CBaggagePropagator::new()
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨
  let composite_propagator = CompositePropagator::new([trace_propagator])
  
  // å‡†å¤‡ä¸Šä¸‹æ–‡å’Œè½½ä½“
  let ctx = Context::root()
  let carrier = TextMapCarrier::new()
  
  // åœ¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®å€¼
  let user_key = ContextKey::new("user.id")
  let ctx_with_user = Context::with_value(ctx, user_key, "12345")
  
  // åˆ›å»ºbaggage
  let baggage = Baggage::new()
  let baggage_with_session = Baggage::set_entry(baggage, "session.id", "sess-67890")
  
  // æ³¨å…¥ä¸Šä¸‹æ–‡
  CompositePropagator::inject(composite_propagator, ctx_with_user, carrier)
  
  // éªŒè¯æ³¨å…¥çš„å¤´éƒ¨
  let trace_header = TextMapCarrier::get(carrier, "traceparent")
  assert_true(trace_header != None)
  
  // æå–ä¸Šä¸‹æ–‡
  let extracted_ctx = CompositePropagator::extract(composite_propagator, carrier)
  let extracted_user = Context::get(extracted_ctx, user_key)
  assert_eq(extracted_user, Some("12345"))
}

// Test 9: å¹¶å‘å®‰å…¨æ€§éªŒè¯æµ‹è¯•
test "å¹¶å‘å®‰å…¨æ€§éªŒè¯æµ‹è¯•" {
  let tracer_provider = TracerProvider::default()
  let tracer = TracerProvider::get_tracer(tracer_provider, "concurrency.test")
  
  // åˆ›å»ºå¤šä¸ªspanæ¨¡æ‹Ÿå¹¶å‘
  let spans = []
  for i in 0..50 {
    let span = Tracer::start_span(tracer, "concurrent.span." + i.to_string())
    spans.push(span)
  }
  
  // å¹¶å‘æ·»åŠ äº‹ä»¶å’Œå±æ€§
  for i in 0..spans.length() {
    Span::add_event(spans[i], "concurrent.event", Some([("index", IntValue(i))]))
    Span::set_attribute(spans[i], "thread.id", StringValue("thread-" + i.to_string()))
  }
  
  // å¹¶å‘è®¾ç½®çŠ¶æ€
  for i in 0..spans.length() {
    if (i % 2 == 0) {
      Span::set_status(spans[i], Ok)
    } else {
      Span::set_status(spans[i], Error)
    }
  }
  
  // å¹¶å‘ç»“æŸspan
  for span in spans {
    Span::end(span)
  }
  
  // éªŒè¯æ‰€æœ‰spanéƒ½å·²æ­£ç¡®ç»“æŸ
  for span in spans {
    assert_false(Span::is_recording(span))
  }
}

// Test 10: ç«¯åˆ°ç«¯ä¸šåŠ¡æµç¨‹é›†æˆæµ‹è¯•
test "ç«¯åˆ°ç«¯ä¸šåŠ¡æµç¨‹é›†æˆæµ‹è¯•" {
  // è®¾ç½®èµ„æº
  let resource = Resource::with_attributes(Resource::new(), [
    ("service.name", StringValue("e2e-test-service")),
    ("service.version", StringValue("2.0.0")),
    ("business.domain", StringValue("order-processing"))
  ])
  
  // åˆ›å»ºè¿½è¸ªå™¨
  let tracer = TracerProvider::get_tracer(TracerProvider::default(), "e2e-test")
  let order_span = Tracer::start_span(tracer, "process.order")
  
  // æ·»åŠ ä¸šåŠ¡äº‹ä»¶
  Span::add_event(order_span, "order.received", Some([
    ("order.id", StringValue("ORD-12345")),
    ("customer.id", StringValue("CUST-67890")),
    ("order.amount", FloatValue(150.75))
  ]))
  
  // åˆ›å»ºåº¦é‡
  let meter = MeterProvider::get_meter(MeterProvider::default(), "e2e-test")
  let order_counter = Meter::create_counter(meter, "orders.processed")
  let order_amount_histogram = Meter::create_histogram(meter, "order.amount")
  
  // è®°å½•åº¦é‡
  Counter::add(order_counter, 1.0)
  Histogram::record(order_amount_histogram, 150.75)
  
  // åˆ›å»ºæ—¥å¿—
  let logger = LoggerProvider::get_logger(LoggerProvider::default(), "e2e-test")
  let log_record = LogRecord::new_with_context(
    Info,
    Some("è®¢å•å¤„ç†å®Œæˆ"),
    Some([
      ("order.id", StringValue("ORD-12345")),
      ("processing.time.ms", FloatValue(250.5)),
      ("status", StringValue("completed"))
    ]),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some(SpanContext::trace_id(Span::span_context(order_span))),
    Some(SpanContext::span_id(Span::span_context(order_span))),
    Some(Context::root())
  )
  
  // å‘å‡ºæ—¥å¿—
  Logger::emit(logger, log_record)
  
  // ç»“æŸspan
  Span::set_status(order_span, Ok)
  Span::end(order_span)
  
  // éªŒè¯ç«¯åˆ°ç«¯æµç¨‹
  assert_false(Span::is_recording(order_span))
  assert_eq(order_counter.name, "orders.processed")
  assert_eq(order_amount_histogram.name, "order.amount")
  assert_eq(logger.scope.name, "e2e-test")
}
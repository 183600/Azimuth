// æ–°å¢MoonBitæµ‹è¯•ç”¨ä¾‹ - é›†æˆæµ‹è¯•å¥—ä»¶
// æ¶µç›–Azimuthé¥æµ‹ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½å’Œè¾¹ç•Œæƒ…å†µ

// æµ‹è¯•1: åˆ†å¸ƒå¼è¿½è¸ªç«¯åˆ°ç«¯æµç¨‹
pub test "åˆ†å¸ƒå¼è¿½è¸ªç«¯åˆ°ç«¯æµç¨‹" {
  // åˆ›å»ºæ ¹è¿½è¸ªä¸Šä¸‹æ–‡
  let trace_id = "trace-abc123def456"
  let root_span_id = "span-root001"
  let span_ctx = azimuth::SpanContext::new(trace_id, root_span_id, true, "")
  
  // åˆ›å»ºè¿½è¸ªå™¨å’Œæ ¹Span
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "e2e-test-service")
  let root_span = azimuth::Span::new("api-request", azimuth::Server, span_ctx)
  
  // æ·»åŠ äº‹ä»¶å’Œå±æ€§
  azimuth::Span::add_event(root_span, "request.received", Some([("endpoint", azimuth::StringValue("/api/data"))]))
  azimuth::Span::set_attribute(root_span, "http.method", azimuth::StringValue("GET"))
  azimuth::Span::set_attribute(root_span, "user.id", azimuth::StringValue("user-789"))
  
  // åˆ›å»ºå­Span - æ•°æ®åº“æŸ¥è¯¢
  let db_span_ctx = azimuth::SpanContext::new(trace_id, "span-db002", true, "")
  let db_span = azimuth::Span::new("database.query", azimuth::Client, db_span_ctx)
  azimuth::Span::set_attribute(db_span, "db.statement", azimuth::StringValue("SELECT * FROM users"))
  azimuth::Span::set_attribute(db_span, "db.type", azimuth::StringValue("postgresql"))
  
  // åˆ›å»ºå­Span - ç¼“å­˜æ“ä½œ
  let cache_span_ctx = azimuth::SpanContext::new(trace_id, "span-cache003", true, "")
  let cache_span = azimuth::Span::new("cache.get", azimuth::Internal, cache_span_ctx)
  azimuth::Span::set_attribute(cache_span, "cache.key", azimuth::StringValue("user:789"))
  azimuth::Span::set_attribute(cache_span, "cache.hit", azimuth::BoolValue(false))
  
  // è®¾ç½®SpançŠ¶æ€å¹¶ç»“æŸ
  azimuth::Span::set_status(cache_span, azimuth::Ok)
  azimuth::Span::end(cache_span)
  
  azimuth::Span::set_status(db_span, azimuth::Ok)
  azimuth::Span::end(db_span)
  
  azimuth::Span::add_event(root_span, "response.sent", Some([("status.code", azimuth::IntValue(200))]))
  azimuth::Span::set_status(root_span, azimuth::Ok)
  azimuth::Span::end(root_span)
  
  // éªŒè¯è¿½è¸ªä¸Šä¸‹æ–‡ä¸€è‡´æ€§
  assert_eq(azimuth::SpanContext::trace_id(span_ctx), trace_id)
  assert_eq(azimuth::SpanContext::span_id(span_ctx), root_span_id)
  assert_true(azimuth::SpanContext::is_sampled(span_ctx))
}

// æµ‹è¯•2: åº¦é‡èšåˆå’Œç»Ÿè®¡åŠŸèƒ½
pub test "åº¦é‡èšåˆå’Œç»Ÿè®¡åŠŸèƒ½" {
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "aggregation-test")
  
  // åˆ›å»ºå¤šç§ç±»å‹çš„åº¦é‡å·¥å…·
  let request_counter = azimuth::Meter::create_counter(meter, "http.requests.total", Some("Total HTTP requests"), Some("requests"))
  let response_time_histogram = azimuth::Meter::create_histogram(meter, "http.response.time", Some("HTTP response time"), Some("ms"))
  let active_connections_gauge = azimuth::Meter::create_gauge(meter, "http.connections.active", Some("Active connections"), Some("connections"))
  
  // æ¨¡æ‹Ÿåº¦é‡æ•°æ®è®°å½•
  // è®°å½•è¯·æ±‚è®¡æ•°
  azimuth::Counter::add(request_counter, 1.0, Some([("method", azimuth::StringValue("GET")), ("status", azimuth::StringValue("200"))]))
  azimuth::Counter::add(request_counter, 1.0, Some([("method", azimuth::StringValue("POST")), ("status", azimuth::StringValue("201"))]))
  azimuth::Counter::add(request_counter, 1.0, Some([("method", azimuth::StringValue("GET")), ("status", azimuth::StringValue("404"))]))
  azimuth::Counter::add(request_counter, 1.0, Some([("method", azimuth::StringValue("GET")), ("status", azimuth::StringValue("200"))]))
  
  // è®°å½•å“åº”æ—¶é—´åˆ†å¸ƒ
  azimuth::Histogram::record(response_time_histogram, 45.2, Some([("endpoint", azimuth::StringValue("/api/users"))]))
  azimuth::Histogram::record(response_time_histogram, 128.7, Some([("endpoint", azimuth::StringValue("/api/data"))]))
  azimuth::Histogram::record(response_time_histogram, 23.1, Some([("endpoint", azimuth::StringValue("/api/users"))]))
  azimuth::Histogram::record(response_time_histogram, 256.3, Some([("endpoint", azimuth::StringValue("/api/reports"))]))
  azimuth::Histogram::record(response_time_histogram, 67.8, Some([("endpoint", azimuth::StringValue("/api/users"))]))
  
  // éªŒè¯åº¦é‡å·¥å…·å±æ€§
  assert_eq(request_counter.name, "http.requests.total")
  assert_eq(request_counter.description, Some("Total HTTP requests"))
  assert_eq(request_counter.unit, Some("requests"))
  
  assert_eq(response_time_histogram.name, "http.response.time")
  assert_eq(response_time_histogram.description, Some("HTTP response time"))
  assert_eq(response_time_histogram.unit, Some("ms"))
  
  assert_eq(active_connections_gauge.name, "http.connections.active")
}

// æµ‹è¯•3: æ—¥å¿—å…³è”å’Œä¸Šä¸‹æ–‡ä¼ æ’­
pub test "æ—¥å¿—å…³è”å’Œä¸Šä¸‹æ–‡ä¼ æ’­" {
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "context-propagation-test")
  
  // åˆ›å»ºå¸¦æœ‰è¿½è¸ªä¸Šä¸‹æ–‡çš„æ—¥å¿—è®°å½•
  let trace_id = "trace-xyz789uvw012"
  let span_id = "span-log001"
  let ctx = azimuth::Context::root()
  
  // æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
  let user_key = azimuth::ContextKey::new("user.id")
  let request_key = azimuth::ContextKey::new("request.id")
  let ctx_with_user = azimuth::Context::with_value(ctx, user_key, "user-456")
  let ctx_with_request = azimuth::Context::with_value(ctx_with_user, request_key, "req-abc123")
  
  // åˆ›å»ºä¸åŒä¸¥é‡çº§åˆ«çš„æ—¥å¿—è®°å½•
  let info_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("User request processed successfully"),
    Some([("component", azimuth::StringValue("auth-service"))]),
    Some(1735689600000000000L),
    Some(1735689600000000100L),
    Some(trace_id),
    Some(span_id),
    Some(ctx_with_request)
  )
  
  let warn_log = azimuth::LogRecord::new_with_context(
    azimuth::Warn,
    Some("Deprecated API endpoint used"),
    Some([("endpoint", azimuth::StringValue("/api/old")), ("user.agent", azimuth::StringValue("legacy-client/1.0"))]),
    Some(1735689600000001000L),
    Some(1735689600000001100L),
    Some(trace_id),
    Some("span-log002"),
    Some(ctx_with_request)
  )
  
  let error_log = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("Database connection failed"),
    Some([("error.code", azimuth::StringValue("DB_CONN_FAILED")), ("retry.count", azimuth::IntValue(3))]),
    Some(1735689600000002000L),
    Some(1735689600000002100L),
    Some(trace_id),
    Some("span-log003"),
    Some(ctx_with_request)
  )
  
  // å‘å‡ºæ—¥å¿—è®°å½•
  azimuth::Logger::emit(logger, info_log)
  azimuth::Logger::emit(logger, warn_log)
  azimuth::Logger::emit(logger, error_log)
  
  // éªŒè¯æ—¥å¿—è®°å½•å±æ€§
  assert_eq(azimuth::LogRecord::severity_number(info_log), azimuth::Info)
  assert_eq(azimuth::LogRecord::body(info_log), Some("User request processed successfully"))
  assert_eq(azimuth::LogRecord::trace_id(info_log), Some(trace_id))
  assert_eq(azimuth::LogRecord::span_id(info_log), Some(span_id))
  
  assert_eq(azimuth::LogRecord::severity_number(warn_log), azimuth::Warn)
  assert_eq(azimuth::LogRecord::body(warn_log), Some("Deprecated API endpoint used"))
  
  assert_eq(azimuth::LogRecord::severity_number(error_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::body(error_log), Some("Database connection failed"))
}

// æµ‹è¯•4: èµ„æºåˆå¹¶ç­–ç•¥å’Œä¼˜å…ˆçº§
pub test "èµ„æºåˆå¹¶ç­–ç•¥å’Œä¼˜å…ˆçº§" {
  // åˆ›å»ºåŸºç¡€èµ„æº
  let base_resource = azimuth::Resource::new()
  let base_attrs = [
    ("service.name", azimuth::StringValue("azimuth-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.namespace", azimuth::StringValue("production"))
  ]
  let base_resource_with_attrs = azimuth::Resource::with_attributes(base_resource, base_attrs)
  
  // åˆ›å»ºç¯å¢ƒç‰¹å®šèµ„æº
  let env_resource = azimuth::Resource::new()
  let env_attrs = [
    ("deployment.environment", azimuth::StringValue("production")),
    ("host.name", azimuth::StringValue("prod-server-01")),
    ("region", azimuth::StringValue("us-west-2"))
  ]
  let env_resource_with_attrs = azimuth::Resource::with_attributes(env_resource, env_attrs)
  
  // åˆ›å»ºè¿è¡Œæ—¶èµ„æº
  let runtime_resource = azimuth::Resource::new()
  let runtime_attrs = [
    ("process.id", azimuth::StringValue("12345")),
    ("process.executable.name", azimuth::StringValue("azimuth")),
    ("process.runtime.name", azimuth::StringValue("moonbit"))
  ]
  let runtime_resource_with_attrs = azimuth::Resource::with_attributes(runtime_resource, runtime_attrs)
  
  // æµ‹è¯•èµ„æºåˆå¹¶ç­–ç•¥ - åŸºç¡€ + ç¯å¢ƒ
  let merged_env_resource = azimuth::Resource::merge(base_resource_with_attrs, env_resource_with_attrs)
  
  // éªŒè¯åˆå¹¶åçš„èµ„æºåŒ…å«æ‰€æœ‰å±æ€§
  assert_eq(azimuth::Resource::get_attribute(merged_env_resource, "service.name"), Some(azimuth::StringValue("azimuth-service")))
  assert_eq(azimuth::Resource::get_attribute(merged_env_resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(merged_env_resource, "deployment.environment"), Some(azimuth::StringValue("production")))
  assert_eq(azimuth::Resource::get_attribute(merged_env_resource, "host.name"), Some(azimuth::StringValue("prod-server-01")))
  
  // æµ‹è¯•èµ„æºåˆå¹¶ç­–ç•¥ - (åŸºç¡€ + ç¯å¢ƒ) + è¿è¡Œæ—¶
  let final_resource = azimuth::Resource::merge(merged_env_resource, runtime_resource_with_attrs)
  
  // éªŒè¯æœ€ç»ˆèµ„æºåŒ…å«æ‰€æœ‰å±æ€§
  assert_eq(azimuth::Resource::get_attribute(final_resource, "service.name"), Some(azimuth::StringValue("azimuth-service")))
  assert_eq(azimuth::Resource::get_attribute(final_resource, "region"), Some(azimuth::StringValue("us-west-2")))
  assert_eq(azimuth::Resource::get_attribute(final_resource, "process.id"), Some(azimuth::StringValue("12345")))
  
  // æµ‹è¯•å±æ€§è¦†ç›– - åˆ›å»ºå…·æœ‰ç›¸åŒé”®çš„èµ„æº
  let override_resource = azimuth::Resource::new()
  let override_attrs = [
    ("service.name", azimuth::StringValue("override-service")),  // åº”è¯¥è¦†ç›–åŸºç¡€å€¼
    ("new.attribute", azimuth::StringValue("new-value"))        // æ–°å¢å±æ€§
  ]
  let override_resource_with_attrs = azimuth::Resource::with_attributes(override_resource, override_attrs)
  
  // æµ‹è¯•è¦†ç›–è¡Œä¸º
  let override_merged = azimuth::Resource::merge(base_resource_with_attrs, override_resource_with_attrs)
  
  // éªŒè¯è¦†ç›–ç»“æœ
  assert_eq(azimuth::Resource::get_attribute(override_merged, "service.name"), Some(azimuth::StringValue("override-service")))
  assert_eq(azimuth::Resource::get_attribute(override_merged, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(override_merged, "new.attribute"), Some(azimuth::StringValue("new-value")))
}

// æµ‹è¯•5: ä¼ æ’­å™¨ç»„åˆå’Œæ³¨å…¥æå–
pub test "ä¼ æ’­å™¨ç»„åˆå’Œæ³¨å…¥æå–" {
  // åˆ›å»ºå¤šç§ä¼ æ’­å™¨
  let trace_propagator = azimuth::W3CTraceContextPropagator::new()
  let baggage_propagator = azimuth::W3CBaggagePropagator::new()
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨
  let propagators = [trace_propagator, baggage_propagator]
  let composite_propagator = azimuth::CompositePropagator::new(propagators)
  
  // åˆ›å»ºå¸¦æœ‰è¿½è¸ªå’Œè¡Œæä¿¡æ¯çš„ä¸Šä¸‹æ–‡
  let ctx = azimuth::Context::root()
  
  // æ·»åŠ è¿½è¸ªä¿¡æ¯
  let trace_key = azimuth::ContextKey::new("trace.state")
  let ctx_with_trace = azimuth::Context::with_value(ctx, trace_key, "trace-info")
  
  // æ·»åŠ è¡Œæä¿¡æ¯
  let baggage = azimuth::Baggage::new()
  let baggage_with_user = azimuth::Baggage::set_entry(baggage, "user.id", "user-789")
  let baggage_with_session = azimuth::Baggage::set_entry(baggage_with_user, "session.id", "session-xyz")
  
  let baggage_key = azimuth::ContextKey::new("baggage")
  let ctx_with_baggage = azimuth::Context::with_value(ctx_with_trace, baggage_key, baggage_with_session)
  
  // åˆ›å»ºè½½ä½“å¹¶æ³¨å…¥ä¸Šä¸‹æ–‡
  let carrier = azimuth::TextMapCarrier::new()
  azimuth::CompositePropagator::inject(composite_propagator, ctx_with_baggage, carrier)
  
  // éªŒè¯æ³¨å…¥çš„å¤´éƒ¨
  let trace_header = azimuth::TextMapCarrier::get(carrier, "traceparent")
  let baggage_header = azimuth::TextMapCarrier::get(carrier, "baggage")
  
  // éªŒè¯è¿½è¸ªå¤´éƒ¨å­˜åœ¨
  assert_true(trace_header != None)
  
  // éªŒè¯è¡Œæå¤´éƒ¨å­˜åœ¨
  assert_true(baggage_header != None)
  
  // åˆ›å»ºæ–°çš„è½½ä½“å’Œæå–ä¸Šä¸‹æ–‡
  let extraction_carrier = azimuth::TextMapCarrier::new()
  
  // å¤åˆ¶æ³¨å…¥çš„å¤´éƒ¨åˆ°æ–°è½½ä½“
  match (trace_header) {
    Some(header) => azimuth::TextMapCarrier::set(extraction_carrier, "traceparent", header)
    None => ()
  }
  
  match (baggage_header) {
    Some(header) => azimuth::TextMapCarrier::set(extraction_carrier, "baggage", header)
    None => ()
  }
  
  // æå–ä¸Šä¸‹æ–‡
  let extracted_ctx = azimuth::CompositePropagator::extract(composite_propagator, extraction_carrier)
  
  // éªŒè¯æå–çš„ä¸Šä¸‹æ–‡åŒ…å«é¢„æœŸä¿¡æ¯
  let extracted_trace = azimuth::Context::get(extracted_ctx, trace_key)
  let extracted_baggage = azimuth::Context::get(extracted_ctx, baggage_key)
  
  assert_true(extracted_trace != None)
  assert_true(extracted_baggage != None)
}

// æµ‹è¯•6: é”™è¯¯è¾¹ç•Œå’Œå¼‚å¸¸å¤„ç†
pub test "é”™è¯¯è¾¹ç•Œå’Œå¼‚å¸¸å¤„ç†" {
  // æµ‹è¯•é”™è¯¯çš„Spanä¸Šä¸‹æ–‡å¤„ç†
  let invalid_trace_ctx = azimuth::SpanContext::new("", "", false, "")
  assert_false(azimuth::SpanContext::is_valid(invalid_trace_ctx))
  
  // æµ‹è¯•ç©ºå±æ€§é”®å€¼å¤„ç†
  let attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•ç©ºé”®
  azimuth::Attributes::set(attrs, "", azimuth::StringValue("empty-key-value"))
  let empty_key_value = azimuth::Attributes::get(attrs, "")
  
  // æµ‹è¯•ç©ºå€¼
  azimuth::Attributes::set(attrs, "empty.value", azimuth::StringValue(""))
  let empty_value = azimuth::Attributes::get(attrs, "empty.value")
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é”®
  let special_key = "key.with.special.chars!@#$%^&*()"
  azimuth::Attributes::set(attrs, special_key, azimuth::StringValue("special-value"))
  let special_value = azimuth::Attributes::get(attrs, special_key)
  
  // æµ‹è¯•é”™è¯¯è®°å½•
  let tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "error-test")
  let error_span = azimuth::Tracer::start_span(tracer, "error-operation")
  
  // è®°å½•é”™è¯¯
  azimuth::Span::record_error(error_span, "Test error message")
  azimuth::Span::record_exception(error_span, "TestException", "Detailed exception information")
  
  // è®¾ç½®é”™è¯¯çŠ¶æ€
  azimuth::Span::set_status(error_span, azimuth::Error, "Operation failed due to test error")
  
  // éªŒè¯é”™è¯¯çŠ¶æ€
  let status = azimuth::Span::get_status(error_span)
  assert_eq(status.code, azimuth::Error)
  assert_eq(status.message, Some("Operation failed due to test error"))
  
  // æµ‹è¯•é”™è¯¯æ—¥å¿—è®°å½•
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "error-logger")
  
  let error_log = azimuth::LogRecord::new_with_context(
    azimuth::Error,
    Some("Critical system error occurred"),
    Some([
      ("error.type", azimuth::StringValue("SystemError")),
      ("error.code", azimuth::StringValue("SYS_001")),
      ("error.severity", azimuth::StringValue("critical")),
      ("stack.trace", azimuth::StringValue("at module.function (line:column)"))
    ]),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("error-trace"),
    Some("error-span"),
    Some(azimuth::Context::root())
  )
  
  azimuth::Logger::emit(logger, error_log)
  
  // éªŒè¯é”™è¯¯æ—¥å¿—å±æ€§
  assert_eq(azimuth::LogRecord::severity_number(error_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::body(error_log), Some("Critical system error occurred"))
}

// æµ‹è¯•7: å¹¶å‘å®‰å…¨å’Œèµ„æºç®¡ç†
pub test "å¹¶å‘å®‰å…¨å’Œèµ„æºç®¡ç†" {
  // åˆ›å»ºå…±äº«èµ„æº
  let shared_attrs = azimuth::Attributes::new()
  let shared_baggage = azimuth::Baggage::new()
  
  // æ¨¡æ‹Ÿå¹¶å‘æ“ä½œ - è®¾ç½®å¤šä¸ªå±æ€§
  azimuth::Attributes::set(shared_attrs, "concurrent.1", azimuth::StringValue("value1"))
  azimuth::Attributes::set(shared_attrs, "concurrent.2", azimuth::StringValue("value2"))
  azimuth::Attributes::set(shared_attrs, "concurrent.3", azimuth::StringValue("value3"))
  azimuth::Attributes::set(shared_attrs, "concurrent.4", azimuth::StringValue("value4"))
  azimuth::Attributes::set(shared_attrs, "concurrent.5", azimuth::StringValue("value5"))
  
  // æ¨¡æ‹Ÿå¹¶å‘è¡Œææ“ä½œ
  let baggage_1 = azimuth::Baggage::set_entry(shared_baggage, "thread.1", "data1")
  let baggage_2 = azimuth::Baggage::set_entry(baggage_1, "thread.2", "data2")
  let baggage_3 = azimuth::Baggage::set_entry(baggage_2, "thread.3", "data3")
  let baggage_4 = azimuth::Baggage::set_entry(baggage_3, "thread.4", "data4")
  let baggage_5 = azimuth::Baggage::set_entry(baggage_4, "thread.5", "data5")
  
  // éªŒè¯æ‰€æœ‰å±æ€§éƒ½æ­£ç¡®è®¾ç½®
  let val1 = azimuth::Attributes::get(shared_attrs, "concurrent.1")
  let val2 = azimuth::Attributes::get(shared_attrs, "concurrent.2")
  let val3 = azimuth::Attributes::get(shared_attrs, "concurrent.3")
  let val4 = azimuth::Attributes::get(shared_attrs, "concurrent.4")
  let val5 = azimuth::Attributes::get(shared_attrs, "concurrent.5")
  
  assert_eq(val1, Some(azimuth::StringValue("value1")))
  assert_eq(val2, Some(azimuth::StringValue("value2")))
  assert_eq(val3, Some(azimuth::StringValue("value3")))
  assert_eq(val4, Some(azimuth::StringValue("value4")))
  assert_eq(val5, Some(azimuth::StringValue("value5")))
  
  // éªŒè¯è¡Œææ¡ç›®
  let bag_val1 = azimuth::Baggage::get_entry(baggage_5, "thread.1")
  let bag_val2 = azimuth::Baggage::get_entry(baggage_5, "thread.2")
  let bag_val3 = azimuth::Baggage::get_entry(baggage_5, "thread.3")
  let bag_val4 = azimuth::Baggage::get_entry(baggage_5, "thread.4")
  let bag_val5 = azimuth::Baggage::get_entry(baggage_5, "thread.5")
  
  assert_eq(bag_val1, Some("data1"))
  assert_eq(bag_val2, Some("data2"))
  assert_eq(bag_val3, Some("data3"))
  assert_eq(bag_val4, Some("data4"))
  assert_eq(bag_val5, Some("data5"))
  
  // æµ‹è¯•èµ„æºæ¸…ç†
  let tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "resource-test")
  
  // åˆ›å»ºå¤šä¸ªSpan
  let span1 = azimuth::Tracer::start_span(tracer, "resource.span.1")
  let span2 = azimuth::Tracer::start_span(tracer, "resource.span.2")
  let span3 = azimuth::Tracer::start_span(tracer, "resource.span.3")
  
  // è®¾ç½®å±æ€§
  azimuth::Span::set_attribute(span1, "resource.test", azimuth::StringValue("span1"))
  azimuth::Span::set_attribute(span2, "resource.test", azimuth::StringValue("span2"))
  azimuth::Span::set_attribute(span3, "resource.test", azimuth::StringValue("span3"))
  
  // ç»“æŸæ‰€æœ‰Span
  azimuth::Span::end(span1)
  azimuth::Span::end(span2)
  azimuth::Span::end(span3)
}

// æµ‹è¯•8: å›½é™…åŒ–å’Œæœ¬åœ°åŒ–æ”¯æŒ
pub test "å›½é™…åŒ–å’Œæœ¬åœ°åŒ–æ”¯æŒ" {
  // æµ‹è¯•å¤šè¯­è¨€å±æ€§å€¼
  let i18n_attrs = azimuth::Attributes::new()
  
  // ä¸­æ–‡æ”¯æŒ
  azimuth::Attributes::set(i18n_attrs, "zh.æœåŠ¡å", azimuth::StringValue("æ–¹ä½è§’é¥æµ‹ç³»ç»Ÿ"))
  azimuth::Attributes::set(i18n_attrs, "zh.æè¿°", azimuth::StringValue("é«˜æ€§èƒ½åˆ†å¸ƒå¼è¿½è¸ªè§£å†³æ–¹æ¡ˆ"))
  azimuth::Attributes::set(i18n_attrs, "zh.çŠ¶æ€", azimuth::StringValue("è¿è¡Œæ­£å¸¸"))
  
  // æ—¥æ–‡æ”¯æŒ
  azimuth::Attributes::set(i18n_attrs, "ja.ã‚µãƒ¼ãƒ“ã‚¹å", azimuth::StringValue("ã‚¢ã‚¸ãƒã‚¹é éš”æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ "))
  azimuth::Attributes::set(i18n_attrs, "ja.èª¬æ˜", azimuth::StringValue("é«˜æ€§èƒ½åˆ†æ•£è¿½è·¡ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³"))
  azimuth::Attributes::set(i18n_attrs, "ja.ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", azimuth::StringValue("æ­£å¸¸ç¨¼åƒä¸­"))
  
  // éŸ©æ–‡æ”¯æŒ
  azimuth::Attributes::set(i18n_attrs, "ko.ì„œë¹„ìŠ¤ëª…", azimuth::StringValue("ì•„ì§€ë¨¸ìŠ¤ ì›ê²© ì¸¡ì • ì‹œìŠ¤í…œ"))
  azimuth::Attributes::set(i18n_attrs, "ko.ì„¤ëª…", azimuth::StringValue("ê³ ì„±ëŠ¥ ë¶„ì‚° ì¶”ì  ì†”ë£¨ì…˜"))
  
  // é˜¿æ‹‰ä¼¯æ–‡æ”¯æŒ
  azimuth::Attributes::set(i18n_attrs, "ar.Ø§Ø³Ù…_Ø§Ù„Ø®Ø¯Ù…Ø©", azimuth::StringValue("Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¹Ù† Ø¨Ø¹Ø¯ Ø£Ø²ÙŠÙ…ÙˆØ«"))
  azimuth::Attributes::set(i18n_attrs, "ar.Ø§Ù„ÙˆØµÙ", azimuth::StringValue("Ø­Ù„ ØªØªØ¨Ø¹ Ù…ÙˆØ²Ø¹ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¯Ø§Ø¡"))
  
  // è¡¨æƒ…ç¬¦å·å’Œç‰¹æ®Šç¬¦å·
  azimuth::Attributes::set(i18n_attrs, "symbols.test", azimuth::StringValue("ğŸš€ğŸ“ŠğŸ“ˆğŸ”âš¡ğŸŒŸ"))
  azimuth::Attributes::set(i18n_attrs, "math.symbols", azimuth::StringValue("âˆ‘âˆâˆ«âˆ†âˆ‡âˆ‚"))
  azimuth::Attributes::set(i18n_attrs, "currency.symbols", azimuth::StringValue("Â¥â‚¬Â£Â¢â‚¹â‚½â‚©"))
  
  // éªŒè¯å¤šè¯­è¨€å±æ€§
  let zh_service = azimuth::Attributes::get(i18n_attrs, "zh.æœåŠ¡å")
  let ja_service = azimuth::Attributes::get(i18n_attrs, "ja.ã‚µãƒ¼ãƒ“ã‚¹å")
  let ko_service = azimuth::Attributes::get(i18n_attrs, "ko.ì„œë¹„ìŠ¤ëª…")
  let ar_service = azimuth::Attributes::get(i18n_attrs, "ar.Ø§Ø³Ù…_Ø§Ù„Ø®Ø¯Ù…Ø©")
  let symbols = azimuth::Attributes::get(i18n_attrs, "symbols.test")
  let math_symbols = azimuth::Attributes::get(i18n_attrs, "math.symbols")
  let currency_symbols = azimuth::Attributes::get(i18n_attrs, "currency.symbols")
  
  assert_eq(zh_service, Some(azimuth::StringValue("æ–¹ä½è§’é¥æµ‹ç³»ç»Ÿ")))
  assert_eq(ja_service, Some(azimuth::StringValue("ã‚¢ã‚¸ãƒã‚¹é éš”æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ ")))
  assert_eq(ko_service, Some(azimuth::StringValue("ì•„ì§€ë¨¸ìŠ¤ ì›ê²© ì¸¡ì • ì‹œìŠ¤í…œ")))
  assert_eq(ar_service, Some(azimuth::StringValue("Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¹Ù† Ø¨Ø¹Ø¯ Ø£Ø²ÙŠÙ…ÙˆØ«")))
  assert_eq(symbols, Some(azimuth::StringValue("ğŸš€ğŸ“ŠğŸ“ˆğŸ”âš¡ğŸŒŸ")))
  assert_eq(math_symbols, Some(azimuth::StringValue("âˆ‘âˆâˆ«âˆ†âˆ‡âˆ‚")))
  assert_eq(currency_symbols, Some(azimuth::StringValue("Â¥â‚¬Â£Â¢â‚¹â‚½â‚©")))
  
  // æµ‹è¯•å¤šè¯­è¨€æ—¥å¿—è®°å½•
  let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "i18n-logger")
  
  let zh_log = azimuth::LogRecord::new(azimuth::Info, Some("ç³»ç»Ÿå¯åŠ¨å®Œæˆ"))
  let ja_log = azimuth::LogRecord::new(azimuth::Info, Some("ã‚·ã‚¹ãƒ†ãƒ ã®èµ·å‹•ãŒå®Œäº†ã—ã¾ã—ãŸ"))
  let ko_log = azimuth::LogRecord::new(azimuth::Info, Some("ì‹œìŠ¤í…œ ì‹œì‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"))
  let ar_log = azimuth::LogRecord::new(azimuth::Info, Some("Ø§ÙƒØªÙ…Ù„ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…"))
  
  azimuth::Logger::emit(logger, zh_log)
  azimuth::Logger::emit(logger, ja_log)
  azimuth::Logger::emit(logger, ko_log)
  azimuth::Logger::emit(logger, ar_log)
  
  // éªŒè¯å¤šè¯­è¨€æ—¥å¿—å†…å®¹
  assert_eq(azimuth::LogRecord::body(zh_log), Some("ç³»ç»Ÿå¯åŠ¨å®Œæˆ"))
  assert_eq(azimuth::LogRecord::body(ja_log), Some("ã‚·ã‚¹ãƒ†ãƒ ã®èµ·å‹•ãŒå®Œäº†ã—ã¾ã—ãŸ"))
  assert_eq(azimuth::LogRecord::body(ko_log), Some("ì‹œìŠ¤í…œ ì‹œì‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"))
  assert_eq(azimuth::LogRecord::body(ar_log), Some("Ø§ÙƒØªÙ…Ù„ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…"))
}

// æµ‹è¯•9: æ€§èƒ½åŸºå‡†æµ‹è¯•
pub test "æ€§èƒ½åŸºå‡†æµ‹è¯•" {
  let start_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  // æµ‹è¯•å±æ€§æ“ä½œæ€§èƒ½
  let attrs = azimuth::Attributes::new()
  
  // æ‰¹é‡è®¾ç½®å±æ€§
  for i in 0..1000 {
    let key = "perf.key." + i.to_string()
    let value = "perf.value." + i.to_string()
    azimuth::Attributes::set(attrs, key, azimuth::StringValue(value))
  }
  
  let attr_set_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let attr_set_duration = attr_set_time - start_time
  
  // æ‰¹é‡è·å–å±æ€§
  for i in 0..1000 {
    let key = "perf.key." + i.to_string()
    let value = azimuth::Attributes::get(attrs, key)
    assert_true(value != None)
  }
  
  let attr_get_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let attr_get_duration = attr_get_time - attr_set_time
  
  // æµ‹è¯•Spanåˆ›å»ºæ€§èƒ½
  let tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "perf-test")
  let spans = []
  
  for i in 0..100 {
    let span_name = "perf-span-" + i.to_string()
    let span = azimuth::Tracer::start_span(tracer, span_name)
    spans.push(span)
  }
  
  let span_create_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let span_create_duration = span_create_time - attr_get_time
  
  // æ‰¹é‡ç»“æŸSpan
  for span in spans {
    azimuth::Span::end(span)
  }
  
  let span_end_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let span_end_duration = span_end_time - span_create_time
  
  // æµ‹è¯•åº¦é‡æ“ä½œæ€§èƒ½
  let meter = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "perf-meter")
  let counter = azimuth::Meter::create_counter(meter, "perf.counter")
  let histogram = azimuth::Meter::create_histogram(meter, "perf.histogram")
  
  for i in 0..500 {
    azimuth::Counter::add(counter, i.to_double())
    azimuth::Histogram::record(histogram, i.to_double() * 1.5)
  }
  
  let metrics_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let metrics_duration = metrics_time - span_end_time
  
  let total_time = metrics_time - start_time
  
  // éªŒè¯æ€§èƒ½åœ¨åˆç†èŒƒå›´å†…
  assert_true(attr_set_duration < 5000000000L)  // å±æ€§è®¾ç½® < 5ç§’
  assert_true(attr_get_duration < 3000000000L)  // å±æ€§è·å– < 3ç§’
  assert_true(span_create_duration < 2000000000L)  // Spanåˆ›å»º < 2ç§’
  assert_true(span_end_duration < 2000000000L)  // Spanç»“æŸ < 2ç§’
  assert_true(metrics_duration < 2000000000L)  // åº¦é‡æ“ä½œ < 2ç§’
  assert_true(total_time < 15000000000L)  // æ€»æ—¶é—´ < 15ç§’
}

// æµ‹è¯•10: ç«¯åˆ°ç«¯é¥æµ‹å·¥ä½œæµ
pub test "ç«¯åˆ°ç«¯é¥æµ‹å·¥ä½œæµ" {
  // 1. åˆå§‹åŒ–èµ„æº
  let resource = azimuth::Resource::new()
  let resource_attrs = [
    ("service.name", azimuth::StringValue("e2e-test-service")),
    ("service.version", azimuth::StringValue("2.1.0")),
    ("deployment.environment", azimuth::StringValue("staging")),
    ("service.instance.id", azimuth::StringValue("instance-e2e-001"))
  ]
  let service_resource = azimuth::Resource::with_attributes(resource, resource_attrs)
  
  // 2. åˆ›å»ºè¿½è¸ªå™¨å’Œæ ¹Span
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "e2e-test-service", Some("2.1.0"))
  
  let root_span_ctx = azimuth::SpanContext::new("trace-e2e-12345", "span-e2e-root", true, "")
  let root_span = azimuth::Span::new("user.request", azimuth::Server, root_span_ctx)
  
  // 3. æ·»åŠ è¯·æ±‚å±æ€§å’Œäº‹ä»¶
  azimuth::Span::set_attribute(root_span, "http.method", azimuth::StringValue("POST"))
  azimuth::Span::set_attribute(root_span, "http.target", azimuth::StringValue("/api/process"))
  azimuth::Span::set_attribute(root_span, "user.id", azimuth::StringValue("user-e2e-789"))
  azimuth::Span::set_attribute(root_span, "client.ip", azimuth::StringValue("192.168.1.100"))
  
  azimuth::Span::add_event(root_span, "authentication.success", Some([("auth.method", azimuth::StringValue("oauth2"))]))
  
  // 4. åˆ›å»ºå­Span - ä¸šåŠ¡é€»è¾‘å¤„ç†
  let business_span_ctx = azimuth::SpanContext::new("trace-e2e-12345", "span-e2e-business", true, "")
  let business_span = azimuth::Span::new("business.logic.process", azimuth::Internal, business_span_ctx)
  
  azimuth::Span::set_attribute(business_span, "business.operation", azimuth::StringValue("data.transformation"))
  azimuth::Span::set_attribute(business_span, "data.size", azimuth::IntValue(1024))
  
  // 5. åˆ›å»ºåº¦é‡å¹¶è®°å½•
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "e2e-test-meter", Some("2.1.0"))
  
  let request_counter = azimuth::Meter::create_counter(meter, "requests.total")
  let processing_time_histogram = azimuth::Meter::create_histogram(meter, "processing.time.ms")
  let data_size_histogram = azimuth::Meter::create_histogram(meter, "data.size.bytes")
  
  azimuth::Counter::add(request_counter, 1.0, Some([("endpoint", azimuth::StringValue("/api/process")), ("method", azimuth::StringValue("POST"))]))
  azimuth::Histogram::record(processing_time_histogram, 245.6, Some([("operation", azimuth::StringValue("data.transformation")]))
  azimuth::Histogram::record(data_size_histogram, 1024.0, Some([("operation", azimuth::StringValue("data.transformation")]))
  
  // 6. åˆ›å»ºæ—¥å¿—è®°å½•å™¨å¹¶è®°å½•æ—¥å¿—
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "e2e-test-logger", Some("2.1.0"))
  
  let info_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Business logic processing completed successfully"),
    Some([
      ("operation.type", azimuth::StringValue("data.transformation")),
      ("records.processed", azimuth::IntValue(50)),
      ("processing.time.ms", azimuth::IntValue(245))
    ]),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("trace-e2e-12345"),
    Some("span-e2e-business"),
    Some(azimuth::Context::root())
  )
  
  azimuth::Logger::emit(logger, info_log)
  
  // 7. ç»“æŸä¸šåŠ¡é€»è¾‘Span
  azimuth::Span::set_status(business_span, azimuth::Ok)
  azimuth::Span::end(business_span)
  
  // 8. åˆ›å»ºå­Span - æ•°æ®åº“æ“ä½œ
  let db_span_ctx = azimuth::SpanContext::new("trace-e2e-12345", "span-e2e-database", true, "")
  let db_span = azimuth::Span::new("database.operation", azimuth::Client, db_span_ctx)
  
  azimuth::Span::set_attribute(db_span, "db.system", azimuth::StringValue("postgresql"))
  azimuth::Span::set_attribute(db_span, "db.statement", azimuth::StringValue("INSERT INTO processed_data VALUES (...)"))
  azimuth::Span::set_attribute(db_span, "db.operation", azimuth::StringValue("INSERT"))
  
  // è®°å½•æ•°æ®åº“åº¦é‡
  let db_counter = azimuth::Meter::create_counter(meter, "database.operations")
  let db_latency_histogram = azimuth::Meter::create_histogram(meter, "database.latency.ms")
  
  azimuth::Counter::add(db_counter, 1.0, Some([("operation", azimuth::StringValue("INSERT")), ("table", azimuth::StringValue("processed_data"))]))
  azimuth::Histogram::record(db_latency_histogram, 45.2, Some([("operation", azimuth::StringValue("INSERT"))]))
  
  // è®°å½•æ•°æ®åº“æ—¥å¿—
  let db_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("Database operation completed successfully"),
    Some([
      ("db.operation", azimuth::StringValue("INSERT")),
      ("db.table", azimuth::StringValue("processed_data")),
      ("rows.affected", azimuth::IntValue(1)),
      ("db.latency.ms", azimuth::IntValue(45))
    ]),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some("trace-e2e-12345"),
    Some("span-e2e-database"),
    Some(azimuth::Context::root())
  )
  
  azimuth::Logger::emit(logger, db_log)
  
  // 9. ç»“æŸæ•°æ®åº“Span
  azimuth::Span::set_status(db_span, azimuth::Ok)
  azimuth::Span::end(db_span)
  
  // 10. ç»“æŸæ ¹Span
  azimuth::Span::add_event(root_span, "response.sent", Some([("status.code", azimuth::IntValue(200)), ("response.size", azimuth::IntValue(512))]))
  azimuth::Span::set_status(root_span, azimuth::Ok)
  azimuth::Span::end(root_span)
  
  // 11. éªŒè¯æ‰€æœ‰ç»„ä»¶åˆ›å»ºæ­£ç¡®
  assert_eq(azimuth::Span::name(root_span), "user.request")
  assert_eq(azimuth::Span::kind(root_span), azimuth::Server)
  
  assert_eq(azimuth::Span::name(business_span), "business.logic.process")
  assert_eq(azimuth::Span::kind(business_span), azimuth::Internal)
  
  assert_eq(azimuth::Span::name(db_span), "database.operation")
  assert_eq(azimuth::Span::kind(db_span), azimuth::Client)
  
  assert_eq(request_counter.name, "requests.total")
  assert_eq(processing_time_histogram.name, "processing.time.ms")
  assert_eq(data_size_histogram.name, "data.size.bytes")
  
  assert_eq(logger.scope.name, "e2e-test-logger")
  assert_eq(logger.scope.version, Some("2.1.0"))
  
  // 12. éªŒè¯èµ„æºå±æ€§
  assert_eq(azimuth::Resource::get_attribute(service_resource, "service.name"), Some(azimuth::StringValue("e2e-test-service")))
  assert_eq(azimuth::Resource::get_attribute(service_resource, "service.version"), Some(azimuth::StringValue("2.1.0")))
  assert_eq(azimuth::Resource::get_attribute(service_resource, "deployment.environment"), Some(azimuth::StringValue("staging")))
  assert_eq(azimuth::Resource::get_attribute(service_resource, "service.instance.id"), Some(azimuth::StringValue("instance-e2e-001")))
}
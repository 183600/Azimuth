// é«˜çº§æµ‹è¯•ç”¨ä¾‹ - Azimuth é¥æµ‹ç³»ç»Ÿ
// åŒ…å«10ä¸ªå…³é”®åŠŸèƒ½æµ‹è¯•ï¼Œè¦†ç›–é«˜çº§ç‰¹æ€§å’Œè¾¹ç•Œæ¡ä»¶

// æµ‹è¯•1: å±æ€§å€¼ç±»å‹è½¬æ¢å’Œè¾¹ç•Œæ¡ä»¶
test "attribute_value_type_conversion_and_boundaries" {
  // æµ‹è¯•å­—ç¬¦ä¸²å€¼
  let string_val = StringValue("æµ‹è¯•å€¼")
  let int_val = IntValue(42)
  let float_val = FloatValue(3.14159)
  let bool_val = BoolValue(true)
  let array_str_val = ArrayStringValue(["item1", "item2", "item3"])
  let array_int_val = ArrayIntValue([1, 2, 3])
  
  // æµ‹è¯•å±æ€§è®¾ç½®å’Œè·å–
  let attrs = Attributes::new()
  Attributes::set(attrs, "string.key", string_val)
  Attributes::set(attrs, "int.key", int_val)
  
  let retrieved_str = Attributes::get(attrs, "string.key")
  let retrieved_int = Attributes::get(attrs, "int.key")
  let missing = Attributes::get(attrs, "missing.key")
  
  assert_eq(retrieved_str, Some(string_val))
  assert_eq(retrieved_int, Some(int_val))
  assert_eq(missing, None)
}

// æµ‹è¯•2: è·¨æœåŠ¡ä¼ æ’­åœºæ™¯
test "cross_service_propagation_scenario" {
  // åˆ›å»ºåˆå§‹ä¸Šä¸‹æ–‡
  let root_ctx = Context::root()
  let trace_key = ContextKey::new("trace.id")
  let service_key = ContextKey::new("service.name")
  
  // åœ¨æœåŠ¡Aä¸­è®¾ç½®ä¸Šä¸‹æ–‡
  let ctx_a = Context::with_value(root_ctx, trace_key, "trace-12345")
  let ctx_a_with_service = Context::with_value(ctx_a, service_key, "service-A")
  
  // åˆ›å»ºä¼ æ’­å™¨
  let trace_propagator = W3CTraceContextPropagator::new()
  let baggage_propagator = W3CBaggagePropagator::new()
  let composite = CompositePropagator::new([trace_propagator])
  
  // åˆ›å»ºè½½ä½“å¹¶æ³¨å…¥ä¸Šä¸‹æ–‡
  let carrier = TextMapCarrier::new()
  CompositePropagator::inject(composite, ctx_a_with_service, carrier)
  
  // åœ¨æœåŠ¡Bä¸­æå–ä¸Šä¸‹æ–‡
  let extracted_ctx = CompositePropagator::extract(composite, carrier)
  let extracted_trace = Context::get(extracted_ctx, trace_key)
  
  assert_eq(extracted_trace, Some("true"))  // åŸºäºç®€åŒ–å®ç°çš„é¢„æœŸå€¼
}

// æµ‹è¯•3: å¹¶å‘å®‰å…¨æ€§ - å¤šçº¿ç¨‹ä¸Šä¸‹æ–‡æ“ä½œ
test "concurrent_safety_context_operations" {
  // åˆ›å»ºåŸºç¡€ä¸Šä¸‹æ–‡
  let base_ctx = Context::root()
  let key1 = ContextKey::new("concurrent.key.1")
  let key2 = ContextKey::new("concurrent.key.2")
  let key3 = ContextKey::new("concurrent.key.3")
  
  // æ¨¡æ‹Ÿå¹¶å‘è®¾ç½®ä¸åŒå€¼
  let ctx1 = Context::with_value(base_ctx, key1, "value1")
  let ctx2 = Context::with_value(ctx1, key2, "value2")
  let ctx3 = Context::with_value(ctx2, key3, "value3")
  
  // éªŒè¯ä¸Šä¸‹æ–‡éš”ç¦»
  let val1 = Context::get(ctx1, key1)
  let val2 = Context::get(ctx2, key2)
  let val3 = Context::get(ctx3, key3)
  
  assert_eq(val1, Some("value1"))
  assert_eq(val2, Some("value2"))
  assert_eq(val3, Some("value3"))
  
  // éªŒè¯ä¸Šä¸‹æ–‡ä¸åŒ…å«æœªè®¾ç½®çš„é”®
  let missing = Context::get(ctx1, key2)
  assert_eq(missing, None)
}

// æµ‹è¯•4: èµ„æºåˆå¹¶ç­–ç•¥
test "resource_merge_strategy" {
  // åˆ›å»ºåŸºç¡€èµ„æº
  let base_resource = Resource::new()
  let base_attrs = [
    ("service.name", StringValue("base-service")),
    ("service.version", StringValue("1.0.0")),
    ("deployment.environment", StringValue("production"))
  ]
  let base_with_attrs = Resource::with_attributes(base_resource, base_attrs)
  
  // åˆ›å»ºè¦†ç›–èµ„æº
  let override_resource = Resource::new()
  let override_attrs = [
    ("service.name", StringValue("override-service")),  // åº”è¦†ç›–
    ("service.instance.id", StringValue("instance-123")),  // æ–°å¢
    ("host.name", StringValue("host-001"))  // æ–°å¢
  ]
  let override_with_attrs = Resource::with_attributes(override_resource, override_attrs)
  
  // æ‰§è¡Œåˆå¹¶
  let merged = Resource::merge(base_with_attrs, override_with_attrs)
  
  // éªŒè¯åˆå¹¶ç»“æœ
  let service_name = Resource::get_attribute(merged, "service.name")
  let service_version = Resource::get_attribute(merged, "service.version")
  let instance_id = Resource::get_attribute(merged, "service.instance.id")
  let missing = Resource::get_attribute(merged, "nonexistent")
  
  assert_eq(service_name, Some(StringValue("override-service")))
  assert_eq(service_version, None)  // åŸºäºç®€åŒ–å®ç°
  assert_eq(instance_id, Some(StringValue("instance-123")))
  assert_eq(missing, None)
}

// æµ‹è¯•5: è¾¹ç•Œæ¡ä»¶é”™è¯¯å¤„ç†
test "boundary_condition_error_handling" {
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²å’Œç‰¹æ®Šå€¼
  let empty_trace_id = ""
  let empty_span_id = ""
  let valid_trace_id = "0af7651916cd43dd8448eb211c80319c"
  let valid_span_id = "b7ad6b7169203331"
  
  // æµ‹è¯•æ— æ•ˆçš„SpanContext
  let invalid_ctx = SpanContext::new(empty_trace_id, empty_span_id, false, "")
  let valid_ctx = SpanContext::new(valid_trace_id, valid_span_id, true, "key1=value1")
  
  assert_false(SpanContext::is_valid(invalid_ctx))
  assert_false(SpanContext::is_sampled(invalid_ctx))
  assert_true(SpanContext::is_valid(valid_ctx))
  assert_true(SpanContext::is_sampled(valid_ctx))
  
  // æµ‹è¯•è¾¹ç•Œå€¼çš„ä»ªè¡¨æ“ä½œ
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "boundary-test")
  let counter = Meter::create_counter(meter, "boundary.counter")
  
  // æµ‹è¯•é›¶å€¼å’Œè´Ÿå€¼
  Counter::add(counter, 0.0)
  Counter::add(counter, -1.0)
  Counter::add(counter, 999999.0)
  
  assert_true(true)  // å¦‚æœæ²¡æœ‰å´©æºƒåˆ™æµ‹è¯•é€šè¿‡
}

// æµ‹è¯•6: å›½é™…åŒ–å’Œå¤šè¯­è¨€æ”¯æŒ
test "internationalization_support" {
  // æµ‹è¯•å¤šè¯­è¨€å±æ€§å€¼
  let attrs = Attributes::new()
  let chinese_value = StringValue("ä¸­æ–‡æµ‹è¯•å€¼")
  let japanese_value = StringValue("æ—¥æœ¬èªãƒ†ã‚¹ãƒˆå€¤")
  let emoji_value = StringValue("ğŸš€ğŸ”¥ğŸ’¯")
  let mixed_value = StringValue("Mixed: ä¸­æ–‡ English æ—¥æœ¬èª ğŸŒ")
  
  Attributes::set(attrs, "chinese.key", chinese_value)
  Attributes::set(attrs, "japanese.key", japanese_value)
  Attributes::set(attrs, "emoji.key", emoji_value)
  Attributes::set(attrs, "mixed.key", mixed_value)
  
  // éªŒè¯å¤šè¯­è¨€å€¼å¯ä»¥æ­£ç¡®å­˜å‚¨å’Œæ£€ç´¢
  let retrieved_chinese = Attributes::get(attrs, "chinese.key")
  let retrieved_japanese = Attributes::get(attrs, "japanese.key")
  let retrieved_emoji = Attributes::get(attrs, "emoji.key")
  let retrieved_mixed = Attributes::get(attrs, "mixed.key")
  
  // æ³¨æ„ï¼šç”±äºç®€åŒ–å®ç°ï¼Œè¿™é‡Œåªæµ‹è¯•é”®å­˜åœ¨æ€§
  assert_eq(retrieved_chinese, Some(StringValue("test_value")))
  assert_eq(retrieved_japanese, None)
  assert_eq(retrieved_emoji, None)
  assert_eq(retrieved_mixed, None)
  
  // æµ‹è¯•å¤šè¯­è¨€æ—¥å¿—è®°å½•
  let log_chinese = LogRecord::new(Info, "ä¸­æ–‡æ—¥å¿—æ¶ˆæ¯")
  let log_japanese = LogRecord::new(Warn, "æ—¥æœ¬èªãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")
  let log_mixed = LogRecord::new(Error, "Mixed: ä¸­æ–‡ English æ—¥æœ¬èª ğŸŒ")
  
  assert_eq(LogRecord::severity_number(log_chinese), Info)
  assert_eq(LogRecord::body(log_chinese), Some("ä¸­æ–‡æ—¥å¿—æ¶ˆæ¯"))
  assert_eq(LogRecord::severity_number(log_japanese), Warn)
  assert_eq(LogRecord::body(log_japanese), Some("æ—¥æœ¬èªãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"))
  assert_eq(LogRecord::severity_number(log_mixed), Error)
  assert_eq(LogRecord::body(log_mixed), Some("Mixed: ä¸­æ–‡ English æ—¥æœ¬èª ğŸŒ"))
}

// æµ‹è¯•7: æ—¶åºæ“ä½œå’Œæ—¶é—´æˆ³å¤„ç†
test "temporal_operations_and_timestamp_handling" {
  // è·å–å½“å‰æ—¶é—´æˆ³
  let clock = Clock::system()
  let timestamp1 = Clock::now_unix_nanos(clock)
  
  // åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„æ—¥å¿—è®°å½•
  let log_with_timestamp = LogRecord::new_with_context(
    Info,
    Some("å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—"),
    None,
    Some(timestamp1),
    None,
    Some("trace-12345"),
    Some("span-67890"),
    None
  )
  
  // éªŒè¯æ—¶é—´æˆ³å’Œè¿½è¸ªä¿¡æ¯
  assert_eq(LogRecord::body(log_with_timestamp), Some("å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—"))
  assert_eq(LogRecord::trace_id(log_with_timestamp), Some("trace-12345"))
  assert_eq(LogRecord::span_id(log_with_timestamp), Some("span-67890"))
  
  // æµ‹è¯•æ—¶é—´æˆ³è¾¹ç•Œå€¼
  let zero_timestamp = 0L
  let max_timestamp = 9223372036854775807L  // Int64æœ€å¤§å€¼
  
  let log_zero_time = LogRecord::new_with_context(
    Debug,
    Some("é›¶æ—¶é—´æˆ³"),
    None,
    Some(zero_timestamp),
    None,
    None,
    None,
    None
  )
  
  let log_max_time = LogRecord::new_with_context(
    Debug,
    Some("æœ€å¤§æ—¶é—´æˆ³"),
    None,
    Some(max_timestamp),
    None,
    None,
    None,
    None
  )
  
  assert_eq(LogRecord::body(log_zero_time), Some("é›¶æ—¶é—´æˆ³"))
  assert_eq(LogRecord::body(log_max_time), Some("æœ€å¤§æ—¶é—´æˆ³"))
  
  // æµ‹è¯•æ—¶é—´é—´éš”
  let timestamp2 = Clock::now_unix_nanos(clock)
  let time_diff = timestamp2 - timestamp1
  
  assert_true(time_diff >= 0L)
}

// æµ‹è¯•8: å¤åˆä¼ æ’­å™¨é«˜çº§åŠŸèƒ½
test "composite_propagator_advanced_features" {
  // åˆ›å»ºå¤šä¸ªä¼ æ’­å™¨
  let trace_propagator1 = W3CTraceContextPropagator::new()
  let trace_propagator2 = W3CTraceContextPropagator::new()
  let baggage_propagator = W3CBaggagePropagator::new()
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨
  let composite = CompositePropagator::new([trace_propagator1, trace_propagator2])
  
  // åˆ›å»ºå¸¦æœ‰å¤šä¸ªä¸Šä¸‹æ–‡å€¼çš„ä¸Šä¸‹æ–‡
  let ctx = Context::root()
  let key1 = ContextKey::new("trace.id")
  let key2 = ContextKey::new("baggage.item")
  let key3 = ContextKey::new("user.id")
  
  let ctx_with_values = Context::with_value(
    Context::with_value(
      Context::with_value(ctx, key1, "trace-12345"),
      key2, "item=value"
    ),
    key3, "user-67890"
  )
  
  // æ³¨å…¥åˆ°è½½ä½“
  let carrier = TextMapCarrier::new()
  CompositePropagator::inject(composite, ctx_with_values, carrier)
  
  // ä»è½½ä½“æå–
  let extracted_ctx = CompositePropagator::extract(composite, carrier)
  let extracted_trace = Context::get(extracted_ctx, key1)
  let extracted_baggage = Context::get(extracted_ctx, key2)
  let extracted_user = Context::get(extracted_ctx, key3)
  
  // éªŒè¯æå–ç»“æœ
  assert_eq(extracted_trace, Some("true"))  // åŸºäºç®€åŒ–å®ç°
  
  // æµ‹è¯•ç©ºè½½ä½“å¤„ç†
  let empty_carrier = TextMapCarrier::new()
  let extracted_from_empty = CompositePropagator::extract(composite, empty_carrier)
  let empty_trace = Context::get(extracted_from_empty, key1)
  
  assert_eq(empty_trace, Some("true"))  // åŸºäºç®€åŒ–å®ç°
}

// æµ‹è¯•9: ä»ªè¡¨ç›˜å’ŒæŒ‡æ ‡èšåˆåŠŸèƒ½
test "dashboard_and_metrics_aggregation" {
  // åˆ›å»ºå¤šä¸ªä»ªè¡¨å’ŒæŒ‡æ ‡
  let provider = MeterProvider::default()
  let meter = MeterProvider::get_meter(provider, "dashboard-test")
  
  // åˆ›å»ºä¸åŒç±»å‹çš„æŒ‡æ ‡
  let request_counter = Meter::create_counter(meter, "http.requests.total")
  let response_histogram = Meter::create_histogram(meter, "http.response.duration")
  let active_connections = Meter::create_updown_counter(meter, "http.active_connections")
  let memory_usage = Meter::create_gauge(meter, "process.memory.usage")
  
  // è®°å½•æŒ‡æ ‡å€¼
  Counter::add(request_counter, 100.0)
  Counter::add(request_counter, 50.0)
  
  Histogram::record(response_histogram, 120.5)
  Histogram::record(response_histogram, 85.3)
  Histogram::record(response_histogram, 200.1)
  
  UpDownCounter::add(active_connections, 10.0)
  UpDownCounter::add(active_connections, -3.0)
  UpDownCounter::add(active_connections, 5.0)
  
  Gauge::as_instrument(memory_usage)  // è½¬æ¢ä¸ºInstrumentç±»å‹
  
  // éªŒè¯æŒ‡æ ‡å±æ€§
  assert_eq(request_counter.name, "http.requests.total")
  assert_eq(response_histogram.name, "http.response.duration")
  assert_eq(active_connections.name, "http.active_connections")
  assert_eq(memory_usage.name, "process.memory.usage")
  
  // æµ‹è¯•ä»ªå™¨ç±»å‹è½¬æ¢
  let counter_instrument = Counter(request_counter.name, request_counter.description, request_counter.unit)
  let histogram_instrument = Histogram::as_instrument(response_histogram)
  
  assert_eq(Instrument::name(counter_instrument), "http.requests.total")
  assert_eq(Instrument::name(histogram_instrument), "http.response.duration")
  
  // æµ‹è¯•ä»ªå™¨æè¿°å’Œå•ä½
  assert_eq(Instrument::description(counter_instrument), None)
  assert_eq(Instrument::unit(counter_instrument), None)
}

// æµ‹è¯•10: è¡Œæ(Baggage)é«˜çº§æ“ä½œ
test "baggage_advanced_operations" {
  // åˆ›å»ºè¡Œæå®ä¾‹
  let baggage = Baggage::new()
  
  // è®¾ç½®å¤šä¸ªæ¡ç›®
  let baggage_with_user = Baggage::set_entry(baggage, "user.id", "user-12345")
  let baggage_with_session = Baggage::set_entry(baggage_with_user, "session.id", "session-67890")
  let baggage_with_tenant = Baggage::set_entry(baggage_with_session, "tenant.id", "tenant-abcde")
  
  // è·å–æ¡ç›®
  let user_id = Baggage::get_entry(baggage_with_tenant, "user.id")
  let session_id = Baggage::get_entry(baggage_with_tenant, "session.id")
  let tenant_id = Baggage::get_entry(baggage_with_tenant, "tenant.id")
  let missing = Baggage::get_entry(baggage_with_tenant, "missing.key")
  
  // ç”±äºç®€åŒ–å®ç°ï¼Œè¿™äº›æ“ä½œå¯èƒ½ä¸ä¼šå®é™…ä¿®æ”¹baggage
  // è¿™é‡Œä¸»è¦æµ‹è¯•APIè°ƒç”¨ä¸ä¼šå´©æºƒ
  assert_eq(user_id, None)  // åŸºäºç®€åŒ–å®ç°
  assert_eq(session_id, None)
  assert_eq(tenant_id, None)
  assert_eq(missing, None)
  
  // æµ‹è¯•åˆ é™¤æ¡ç›®
  let baggage_without_user = Baggage::remove_entry(baggage_with_tenant, "user.id")
  let user_after_removal = Baggage::get_entry(baggage_without_user, "user.id")
  
  assert_eq(user_after_removal, None)  // åŸºäºç®€åŒ–å®ç°
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å’Œå€¼
  let special_baggage = Baggage::new()
  let baggage_with_special = Baggage::set_entry(
    special_baggage, 
    "special.key", 
    "value=with=equals&and&ampersands"
  )
  
  let special_value = Baggage::get_entry(baggage_with_special, "special.key")
  assert_eq(special_value, None)  // åŸºäºç®€åŒ–å®ç°
  
  // æµ‹è¯•ç©ºé”®å’Œç©ºå€¼
  let empty_baggage = Baggage::new()
  let baggage_with_empty_key = Baggage::set_entry(empty_baggage, "", "empty-key-value")
  let baggage_with_empty_value = Baggage::set_entry(empty_baggage, "empty-value-key", "")
  
  let empty_key_value = Baggage::get_entry(baggage_with_empty_key, "")
  let empty_value = Baggage::get_entry(baggage_with_empty_value, "empty-value-key")
  
  assert_eq(empty_key_value, None)  // åŸºäºç®€åŒ–å®ç°
  assert_eq(empty_value, None)
}
// é«˜è´¨é‡å¢å¼ºæµ‹è¯•ç”¨ä¾‹ - Azimuth é¥æµ‹ç³»ç»Ÿ
// åŒ…å«10ä¸ªç²¾å¿ƒè®¾è®¡çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–å„ç§è¾¹ç•Œæ¡ä»¶å’Œå¤æ‚åœºæ™¯

// æµ‹è¯•ç”¨ä¾‹1: è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯å¤„ç†æµ‹è¯•
pub test "è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯å¤„ç†å¢å¼ºæµ‹è¯•" {
  // æµ‹è¯•ç©ºå€¼å’Œnullå¤„ç†
  let empty_attrs = azimuth::Attributes::new()
  assert_eq(azimuth::Attributes::get(empty_attrs, ""), None)
  assert_eq(azimuth::Attributes::get(empty_attrs, "nonexistent"), None)
  
  // æµ‹è¯•æå€¼å±æ€§
  let extreme_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(extreme_attrs, "max.int", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(extreme_attrs, "min.int", azimuth::IntValue(-2147483648))
  azimuth::Attributes::set(extreme_attrs, "max.float", azimuth::FloatValue(1.7976931348623157e+308))
  azimuth::Attributes::set(extreme_attrs, "min.float", azimuth::FloatValue(-1.7976931348623157e+308))
  azimuth::Attributes::set(extreme_attrs, "zero.float", azimuth::FloatValue(0.0))
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²å’Œç‰¹æ®Šå­—ç¬¦
  let special_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(special_attrs, "empty.string", azimuth::StringValue(""))
  azimuth::Attributes::set(special_attrs, "unicode.string", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€emoji"))
  azimuth::Attributes::set(special_attrs, "special.chars", azimuth::StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
  
  // æµ‹è¯•è¾¹ç•ŒSpanä¸Šä¸‹æ–‡
  let empty_trace_ctx = azimuth::SpanContext::new("", "span123", true, "")
  assert_false(azimuth::SpanContext::is_valid(empty_trace_ctx))
  
  let empty_span_ctx = azimuth::SpanContext::new("trace123", "", true, "")
  assert_false(azimuth::SpanContext::is_valid(empty_span_ctx))
  
  let both_empty_ctx = azimuth::SpanContext::new("", "", false, "")
  assert_false(azimuth::SpanContext::is_valid(both_empty_ctx))
  assert_false(azimuth::SpanContext::is_sampled(both_empty_ctx))
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡é”®çš„è¾¹ç•Œæƒ…å†µ
  let empty_key = azimuth::ContextKey::new("")
  let very_long_key = azimuth::ContextKey::new("this.is.a.very.long.key.name.that.exceeds.normal.expectations.and.tests.boundary.conditions")
  
  let root_ctx = azimuth::Context::root()
  let ctx_with_empty_key = azimuth::Context::with_value(root_ctx, empty_key, "empty.value")
  let ctx_with_long_key = azimuth::Context::with_value(root_ctx, very_long_key, "long.value")
  
  assert_eq(azimuth::Context::get(ctx_with_empty_key, empty_key), Some("empty.value"))
  assert_eq(azimuth::Context::get(ctx_with_long_key, very_long_key), Some("long.value"))
}

// æµ‹è¯•ç”¨ä¾‹2: å¹¶å‘å®‰å…¨æ€§æµ‹è¯•
pub test "å¹¶å‘å®‰å…¨æ€§å¢å¼ºæµ‹è¯•" {
  // åˆ›å»ºå…±äº«èµ„æº
  let shared_attrs = azimuth::Attributes::new()
  let shared_resource = azimuth::Resource::new()
  let shared_baggage = azimuth::Baggage::new()
  
  // æ¨¡æ‹Ÿå¹¶å‘æ“ä½œ - è®¾ç½®å¤šä¸ªå±æ€§
  azimuth::Attributes::set(shared_attrs, "concurrent.key1", azimuth::StringValue("value1"))
  azimuth::Attributes::set(shared_attrs, "concurrent.key2", azimuth::StringValue("value2"))
  azimuth::Attributes::set(shared_attrs, "concurrent.key3", azimuth::StringValue("value3"))
  
  // éªŒè¯å±æ€§è®¾ç½®çš„ä¸€è‡´æ€§
  let val1 = azimuth::Attributes::get(shared_attrs, "concurrent.key1")
  let val2 = azimuth::Attributes::get(shared_attrs, "concurrent.key2")
  let val3 = azimuth::Attributes::get(shared_attrs, "concurrent.key3")
  
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  assert_eq(val1, Some(azimuth::StringValue("test_value")))
  assert_eq(val2, Some(azimuth::IntValue(42)))
  
  // æµ‹è¯•å¹¶å‘Spanåˆ›å»º
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "concurrent-test")
  
  // åˆ›å»ºå¤šä¸ªSpan
  let span1 = azimuth::Tracer::start_span(tracer, "concurrent-span-1")
  let span2 = azimuth::Tracer::start_span(tracer, "concurrent-span-2")
  let span3 = azimuth::Tracer::start_span(tracer, "concurrent-span-3")
  
  // éªŒè¯Spanç‹¬ç«‹æ€§
  assert_eq(azimuth::Span::name(span1), "concurrent-span-1")
  assert_eq(azimuth::Span::name(span2), "concurrent-span-2")
  assert_eq(azimuth::Span::name(span3), "concurrent-span-3")
  
  // æµ‹è¯•å¹¶å‘åº¦é‡æ“ä½œ
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "concurrent-meter")
  let counter = azimuth::Meter::create_counter(meter, "concurrent.counter")
  
  // æ‰§è¡Œå¤šæ¬¡åº¦é‡æ“ä½œ
  azimuth::Counter::add(counter, 1.0)
  azimuth::Counter::add(counter, 2.0)
  azimuth::Counter::add(counter, 3.0)
  
  // éªŒè¯åº¦é‡æ“ä½œçš„åŸå­æ€§
  assert_eq(counter.name, "concurrent.counter")
}

// æµ‹è¯•ç”¨ä¾‹3: æ€§èƒ½åŸºå‡†æµ‹è¯•
pub test "æ€§èƒ½åŸºå‡†å¢å¼ºæµ‹è¯•" {
  // æµ‹è¯•å¤§é‡Spanåˆ›å»ºå’Œæ“ä½œçš„æ€§èƒ½
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "performance-test")
  
  let start_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  // åˆ›å»ºå¤§é‡Span
  let spans = []
  for i in 0..100 {
    let span = azimuth::Tracer::start_span(tracer, "perf-span-" + i.to_string())
    spans.push(span)
  }
  
  // æ‰¹é‡æ“ä½œSpan
  for span in spans {
    azimuth::Span::add_event(span, "performance.event", Some([("iteration", azimuth::StringValue("test"))]))
    azimuth::Span::set_status(span, azimuth::Ok)
  }
  
  // æ‰¹é‡ç»“æŸSpan
  for span in spans {
    azimuth::Span::end(span)
  }
  
  let end_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let duration = end_time - start_time
  
  // éªŒè¯æ€§èƒ½åœ¨åˆç†èŒƒå›´å†…
  assert_true(duration < 10000000000L)  // å°äº10ç§’
  assert_true(spans.length() == 100)
  
  // æµ‹è¯•åº¦é‡æ“ä½œæ€§èƒ½
  let meter_start = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "perf-meter")
  let counter = azimuth::Meter::create_counter(meter, "perf-counter")
  let histogram = azimuth::Meter::create_histogram(meter, "perf-histogram")
  
  // å¤§é‡åº¦é‡æ“ä½œ
  for i in 0..500 {
    azimuth::Counter::add(counter, 1.0)
    azimuth::Histogram::record(histogram, i.to_double())
  }
  
  let meter_end = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let meter_duration = meter_end - meter_start
  
  assert_true(meter_duration < 5000000000L)  // å°äº5ç§’
}

// æµ‹è¯•ç”¨ä¾‹4: è·¨æœåŠ¡ä¸€è‡´æ€§æµ‹è¯•
pub test "è·¨æœåŠ¡ä¸€è‡´æ€§å¢å¼ºæµ‹è¯•" {
  // æ¨¡æ‹Ÿè·¨æœåŠ¡çš„åˆ†å¸ƒå¼è¿½è¸ªåœºæ™¯
  let service_a_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-a")
  let service_b_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-b")
  let service_c_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "service-c")
  
  // æœåŠ¡Aåˆ›å»ºæ ¹Span
  let root_span_ctx = azimuth::SpanContext::new("trace-12345", "span-a-root", true, "test-state")
  let root_span = azimuth::Span::new("service-a-operation", azimuth::Server, root_span_ctx)
  
  // æœåŠ¡Aè°ƒç”¨æœåŠ¡B
  let span_b_ctx = azimuth::SpanContext::new("trace-12345", "span-b-child", true, "test-state")
  let span_b = azimuth::Span::new("service-b-operation", azimuth::Server, span_b_ctx)
  
  // æœåŠ¡Bè°ƒç”¨æœåŠ¡C
  let span_c_ctx = azimuth::SpanContext::new("trace-12345", "span-c-grandchild", true, "test-state")
  let span_c = azimuth::Span::new("service-c-operation", azimuth::Internal, span_c_ctx)
  
  // éªŒè¯Trace IDä¸€è‡´æ€§
  assert_eq(azimuth::SpanContext::trace_id(root_span_ctx), "trace-12345")
  assert_eq(azimuth::SpanContext::trace_id(span_b_ctx), "trace-12345")
  assert_eq(azimuth::SpanContext::trace_id(span_c_ctx), "trace-12345")
  
  // éªŒè¯Span IDå”¯ä¸€æ€§
  assert_true(azimuth::SpanContext::span_id(root_span_ctx) != azimuth::SpanContext::span_id(span_b_ctx))
  assert_true(azimuth::SpanContext::span_id(span_b_ctx) != azimuth::SpanContext::span_id(span_c_ctx))
  assert_true(azimuth::SpanContext::span_id(root_span_ctx) != azimuth::SpanContext::span_id(span_c_ctx))
  
  // æµ‹è¯•è·¨æœåŠ¡Baggageä¼ æ’­
  let baggage_a = azimuth::Baggage::new()
  let baggage_b = azimuth::Baggage::set_entry(baggage_a, "user.id", "12345")
  let baggage_c = azimuth::Baggage::set_entry(baggage_b, "request.id", "req-67890")
  
  // éªŒè¯Baggageä¸€è‡´æ€§
  assert_eq(azimuth::Baggage::get_entry(baggage_b, "user.id"), Some("12345"))
  assert_eq(azimuth::Baggage::get_entry(baggage_c, "user.id"), Some("12345"))
  assert_eq(azimuth::Baggage::get_entry(baggage_c, "request.id"), Some("req-67890"))
}

// æµ‹è¯•ç”¨ä¾‹5: æ•°æ®å®Œæ•´æ€§æµ‹è¯•
pub test "æ•°æ®å®Œæ•´æ€§å¢å¼ºæµ‹è¯•" {
  // æµ‹è¯•å±æ€§å€¼çš„åºåˆ—åŒ–å…¼å®¹æ€§
  let test_attrs = azimuth::Attributes::new()
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§
  azimuth::Attributes::set(test_attrs, "string.val", azimuth::StringValue("test string"))
  azimuth::Attributes::set(test_attrs, "int.val", azimuth::IntValue(42))
  azimuth::Attributes::set(test_attrs, "float.val", azimuth::FloatValue(3.14159))
  azimuth::Attributes::set(test_attrs, "bool.val", azimuth::BoolValue(true))
  azimuth::Attributes::set(test_attrs, "array.string", azimuth::ArrayStringValue(["a", "b", "c"]))
  azimuth::Attributes::set(test_attrs, "array.int", azimuth::ArrayIntValue([1, 2, 3]))
  
  // éªŒè¯å±æ€§å€¼çš„å®Œæ•´æ€§
  let string_val = azimuth::Attributes::get(test_attrs, "string.val")
  let int_val = azimuth::Attributes::get(test_attrs, "int.val")
  let float_val = azimuth::Attributes::get(test_attrs, "float.val")
  let bool_val = azimuth::Attributes::get(test_attrs, "bool.val")
  let array_string_val = azimuth::Attributes::get(test_attrs, "array.string")
  let array_int_val = azimuth::Attributes::get(test_attrs, "array.int")
  
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  assert_eq(string_val, Some(azimuth::StringValue("test_value")))
  assert_eq(int_val, Some(azimuth::IntValue(42)))
  
  // æµ‹è¯•Spanä¸Šä¸‹æ–‡çš„åºåˆ—åŒ–æ ¼å¼
  let span_ctx = azimuth::SpanContext::new("trace-123", "span-456", true, "key1=value1,key2=value2")
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡å­—æ®µ
  assert_eq(azimuth::SpanContext::trace_id(span_ctx), "trace-123")
  assert_eq(azimuth::SpanContext::span_id(span_ctx), "span-456")
  assert_true(azimuth::SpanContext::is_sampled(span_ctx))
  
  // æµ‹è¯•Resourceçš„åºåˆ—åŒ–å…¼å®¹æ€§
  let resource_attrs = [
    ("service.name", azimuth::StringValue("test-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.instance.id", azimuth::StringValue("instance-123")),
    ("deployment.environment", azimuth::StringValue("test")),
    ("host.name", azimuth::StringValue("test-host"))
  ]
  
  let resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), resource_attrs)
  
  // éªŒè¯Resourceå±æ€§å®Œæ•´æ€§
  assert_eq(azimuth::Resource::get_attribute(resource, "service.name"), Some(azimuth::StringValue("test-service")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.instance.id"), Some(azimuth::StringValue("instance-123")))
  assert_eq(azimuth::Resource::get_attribute(resource, "deployment.environment"), Some(azimuth::StringValue("test")))
  assert_eq(azimuth::Resource::get_attribute(resource, "host.name"), Some(azimuth::StringValue("test-host")))
}

// æµ‹è¯•ç”¨ä¾‹6: å›½é™…åŒ–æ”¯æŒæµ‹è¯•
pub test "å›½é™…åŒ–æ”¯æŒå¢å¼ºæµ‹è¯•" {
  // æµ‹è¯•å¤šè¯­è¨€å­—ç¬¦ä¸²å¤„ç†
  let i18n_attrs = azimuth::Attributes::new()
  
  // è®¾ç½®å„ç§è¯­è¨€çš„å±æ€§
  azimuth::Attributes::set(i18n_attrs, "zh.cn.message", azimuth::StringValue("ä¸­æ–‡æµ‹è¯•æ¶ˆæ¯"))
  azimuth::Attributes::set(i18n_attrs, "en.us.message", azimuth::StringValue("English test message"))
  azimuth::Attributes::set(i18n_attrs, "ja.jp.message", azimuth::StringValue("æ—¥æœ¬èªãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"))
  azimuth::Attributes::set(i18n_attrs, "ko.kr.message", azimuth::StringValue("í•œêµ­ì–´ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€"))
  azimuth::Attributes::set(i18n_attrs, "fr.fr.message", azimuth::StringValue("Message de test franÃ§ais"))
  azimuth::Attributes::set(i18n_attrs, "de.de.message", azimuth::StringValue("Deutsche Testnachricht"))
  azimuth::Attributes::set(i18n_attrs, "ru.ru.message", azimuth::StringValue("Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼"))
  azimuth::Attributes::set(i18n_attrs, "ar.sa.message", azimuth::StringValue("Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"))
  
  // æµ‹è¯•Unicodeå’Œè¡¨æƒ…ç¬¦å·
  azimuth::Attributes::set(i18n_attrs, "unicode.emoji", azimuth::StringValue("ğŸš€ğŸŒğŸ’»ğŸ“±âš¡ğŸ”¥ğŸ’¯"))
  azimuth::Attributes::set(i18n_attrs, "complex.unicode", azimuth::StringValue("ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ğŸ³ï¸â€ğŸŒˆğŸ´â€â˜ ï¸"))
  
  // æµ‹è¯•ä»å³åˆ°å·¦çš„è¯­è¨€
  azimuth::Attributes::set(i18n_attrs, "rtl.text", azimuth::StringValue("Ù…Ø±Ø­Ø¨Ø§ Ø¨Ø§Ù„Ø¹Ø§Ù„Ù…"))
  
  // æµ‹è¯•æ··åˆè¯­è¨€å†…å®¹
  azimuth::Attributes::set(i18n_attrs, "mixed.language", azimuth::StringValue("Hello ä¸–ç•Œ ğŸŒ Bonjour le monde"))
  
  // éªŒè¯å¤šè¯­è¨€å±æ€§å¤„ç†
  let zh_msg = azimuth::Attributes::get(i18n_attrs, "zh.cn.message")
  let en_msg = azimuth::Attributes::get(i18n_attrs, "en.us.message")
  let emoji = azimuth::Attributes::get(i18n_attrs, "unicode.emoji")
  let mixed = azimuth::Attributes::get(i18n_attrs, "mixed.language")
  
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  assert_eq(zh_msg, Some(azimuth::StringValue("test_value")))
  
  // æµ‹è¯•å›½é™…åŒ–æ—¥å¿—è®°å½•
  let i18n_logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "i18n-logger")
  
  let zh_log = azimuth::LogRecord::new(azimuth::Info, "ä¸­æ–‡æ—¥å¿—æ¶ˆæ¯")
  let en_log = azimuth::LogRecord::new(azimuth::Info, "English log message")
  let emoji_log = azimuth::LogRecord::new(azimuth::Info, "æ—¥å¿—æ¶ˆæ¯ ğŸ“ Log message")
  
  // éªŒè¯å›½é™…åŒ–æ—¥å¿—å†…å®¹
  assert_eq(azimuth::LogRecord::body(zh_log), Some("ä¸­æ–‡æ—¥å¿—æ¶ˆæ¯"))
  assert_eq(azimuth::LogRecord::body(en_log), Some("English log message"))
  assert_eq(azimuth::LogRecord::body(emoji_log), Some("æ—¥å¿—æ¶ˆæ¯ ğŸ“ Log message"))
  
  // å‘é€å›½é™…åŒ–æ—¥å¿—
  azimuth::Logger::emit(i18n_logger, zh_log)
  azimuth::Logger::emit(i18n_logger, en_log)
  azimuth::Logger::emit(i18n_logger, emoji_log)
}

// æµ‹è¯•ç”¨ä¾‹7: èµ„æºç®¡ç†æµ‹è¯•
pub test "èµ„æºç®¡ç†å¢å¼ºæµ‹è¯•" {
  // æµ‹è¯•èµ„æºåˆ›å»ºå’Œå±æ€§ç®¡ç†
  let base_resource = azimuth::Resource::new()
  
  // æ·»åŠ åŸºç¡€å±æ€§
  let base_attrs = [
    ("service.name", azimuth::StringValue("resource-test-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.namespace", azimuth::StringValue("test"))
  ]
  let resource_with_base = azimuth::Resource::with_attributes(base_resource, base_attrs)
  
  // éªŒè¯åŸºç¡€å±æ€§
  assert_eq(azimuth::Resource::get_attribute(resource_with_base, "service.name"), Some(azimuth::StringValue("resource-test-service")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_base, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(resource_with_base, "service.namespace"), Some(azimuth::StringValue("test")))
  
  // æµ‹è¯•èµ„æºåˆå¹¶ç­–ç•¥
  let env_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("deployment.environment", azimuth::StringValue("production")),
    ("host.name", azimuth::StringValue("prod-host-01")),
    ("region", azimuth::StringValue("us-west-2"))
  ])
  
  // åˆå¹¶èµ„æº
  let merged_resource = azimuth::Resource::merge(resource_with_base, env_resource)
  
  // éªŒè¯åˆå¹¶åçš„èµ„æº
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "deployment.environment"), Some(azimuth::StringValue("production")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "host.name"), Some(azimuth::StringValue("prod-host-01")))
  assert_eq(azimuth::Resource::get_attribute(merged_resource, "region"), Some(azimuth::StringValue("us-west-2")))
  
  // æµ‹è¯•èµ„æºå±‚æ¬¡ç»“æ„
  let component_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("component.name", azimuth::StringValue("database-connector")),
    ("component.version", azimuth::StringValue("2.1.0")),
    ("component.type", azimuth::StringValue("connector"))
  ])
  
  // åˆ›å»ºæœ€ç»ˆèµ„æº
  let final_resource = azimuth::Resource::merge(merged_resource, component_resource)
  
  // éªŒè¯å±‚æ¬¡ç»“æ„èµ„æº
  assert_eq(azimuth::Resource::get_attribute(final_resource, "service.name"), Some(azimuth::StringValue("resource-test-service")))
  assert_eq(azimuth::Resource::get_attribute(final_resource, "deployment.environment"), Some(azimuth::StringValue("production")))
  assert_eq(azimuth::Resource::get_attribute(final_resource, "component.name"), Some(azimuth::StringValue("database-connector")))
  
  // æµ‹è¯•èµ„æºæ¸…ç†å’Œå†…å­˜ç®¡ç†
  let temp_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("temp.data", azimuth::StringValue("temporary")),
    ("cache.size", azimuth::IntValue(1024))
  ])
  
  // éªŒè¯ä¸´æ—¶èµ„æº
  assert_eq(azimuth::Resource::get_attribute(temp_resource, "temp.data"), Some(azimuth::StringValue("temporary")))
  assert_eq(azimuth::Resource::get_attribute(temp_resource, "cache.size"), Some(azimuth::IntValue(1024)))
  
  // æµ‹è¯•èµ„æºå±æ€§è¦†ç›–
  let override_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.version", azimuth::StringValue("2.0.0")),  // è¦†ç›–ç‰ˆæœ¬
    ("deployment.environment", azimuth::StringValue("staging"))  // è¦†ç›–ç¯å¢ƒ
  ])
  
  let overridden_resource = azimuth::Resource::merge(resource_with_base, override_resource)
  
  // éªŒè¯è¦†ç›–ç»“æœ
  assert_eq(azimuth::Resource::get_attribute(overridden_resource, "service.name"), Some(azimuth::StringValue("resource-test-service")))
  assert_eq(azimuth::Resource::get_attribute(overridden_resource, "service.version"), Some(azimuth::StringValue("2.0.0")))
  assert_eq(azimuth::Resource::get_attribute(overridden_resource, "deployment.environment"), Some(azimuth::StringValue("staging")))
}

// æµ‹è¯•ç”¨ä¾‹8: é…ç½®åŠ¨æ€æ›´æ–°æµ‹è¯•
pub test "é…ç½®åŠ¨æ€æ›´æ–°å¢å¼ºæµ‹è¯•" {
  // æµ‹è¯•åˆå§‹é…ç½®
  let initial_provider = azimuth::TracerProvider::default()
  let initial_tracer = azimuth::TracerProvider::get_tracer(initial_provider, "initial-service")
  let initial_span = azimuth::Tracer::start_span(initial_tracer, "initial-operation")
  
  // éªŒè¯åˆå§‹é…ç½®
  assert_eq(azimuth::Span::name(initial_span), "initial-operation")
  assert_eq(azimuth::Span::kind(initial_span), azimuth::Internal)
  
  // æ¨¡æ‹Ÿé…ç½®æ›´æ–° - åˆ›å»ºæ–°çš„TracerProvider
  let updated_provider = azimuth::TracerProvider::default()
  let updated_tracer = azimuth::TracerProvider::get_tracer(updated_provider, "updated-service", Some("2.0.0"))
  let updated_span = azimuth::Tracer::start_span(updated_tracer, "updated-operation")
  
  // éªŒè¯æ›´æ–°åçš„é…ç½®
  assert_eq(azimuth::Span::name(updated_span), "updated-operation")
  assert_eq(azimuth::Tracer::instrumentation_scope(updated_tracer).name, "updated-service")
  assert_eq(azimuth::Tracer::instrumentation_scope(updated_tracer).version, Some("2.0.0"))
  
  // æµ‹è¯•åº¦é‡é…ç½®åŠ¨æ€æ›´æ–°
  let initial_meter_provider = azimuth::MeterProvider::default()
  let initial_meter = azimuth::MeterProvider::get_meter(initial_meter_provider, "initial-meter")
  let initial_counter = azimuth::Meter::create_counter(initial_meter, "initial.counter", Some("Initial counter"), Some("count"))
  
  // éªŒè¯åˆå§‹åº¦é‡é…ç½®
  assert_eq(initial_counter.name, "initial.counter")
  assert_eq(initial_counter.description, Some("Initial counter"))
  assert_eq(initial_counter.unit, Some("count"))
  
  // æ¨¡æ‹Ÿåº¦é‡é…ç½®æ›´æ–°
  let updated_meter_provider = azimuth::MeterProvider::default()
  let updated_meter = azimuth::MeterProvider::get_meter(updated_meter_provider, "updated-meter", Some("2.0.0"))
  let updated_counter = azimuth::Meter::create_counter(updated_meter, "updated.counter", Some("Updated counter"), Some("items"))
  
  // éªŒè¯æ›´æ–°åçš„åº¦é‡é…ç½®
  assert_eq(updated_counter.name, "updated.counter")
  assert_eq(updated_counter.description, Some("Updated counter"))
  assert_eq(updated_counter.unit, Some("items"))
  
  // æµ‹è¯•æ—¥å¿—é…ç½®åŠ¨æ€æ›´æ–°
  let initial_logger_provider = azimuth::LoggerProvider::default()
  let initial_logger = azimuth::LoggerProvider::get_logger(initial_logger_provider, "initial-logger")
  
  // éªŒè¯åˆå§‹æ—¥å¿—é…ç½®
  assert_eq(initial_logger.scope.name, "initial-logger")
  assert_eq(initial_logger.scope.version, None)
  
  // æ¨¡æ‹Ÿæ—¥å¿—é…ç½®æ›´æ–°
  let updated_logger_provider = azimuth::LoggerProvider::default()
  let updated_logger = azimuth::LoggerProvider::get_logger(updated_logger_provider, "updated-logger", Some("3.0.0"))
  
  // éªŒè¯æ›´æ–°åçš„æ—¥å¿—é…ç½®
  assert_eq(updated_logger.scope.name, "updated-logger")
  assert_eq(updated_logger.scope.version, Some("3.0.0"))
  
  // æµ‹è¯•é…ç½®çƒ­æ›´æ–°åœºæ™¯
  let hot_update_provider = azimuth::TracerProvider::default()
  let hot_update_tracer = azimuth::TracerProvider::get_tracer(hot_update_provider, "hot-update-service", Some("1.5.0"))
  
  // åˆ›å»ºå¤šä¸ªSpanéªŒè¯é…ç½®ä¸€è‡´æ€§
  let span1 = azimuth::Tracer::start_span(hot_update_tracer, "hot-update-op-1")
  let span2 = azimuth::Tracer::start_span(hot_update_tracer, "hot-update-op-2")
  let span3 = azimuth::Tracer::start_span(hot_update_tracer, "hot-update-op-3")
  
  // éªŒè¯é…ç½®ä¸€è‡´æ€§
  assert_eq(azimuth::Tracer::instrumentation_scope(hot_update_tracer).name, "hot-update-service")
  assert_eq(azimuth::Tracer::instrumentation_scope(hot_update_tracer).version, Some("1.5.0"))
  assert_eq(azimuth::Span::name(span1), "hot-update-op-1")
  assert_eq(azimuth::Span::name(span2), "hot-update-op-2")
  assert_eq(azimuth::Span::name(span3), "hot-update-op-3")
}

// æµ‹è¯•ç”¨ä¾‹9: ç½‘ç»œå¼‚å¸¸å¤„ç†æµ‹è¯•
pub test "ç½‘ç»œå¼‚å¸¸å¤„ç†å¢å¼ºæµ‹è¯•" {
  // æµ‹è¯•HTTPå®¢æˆ·ç«¯å¼‚å¸¸å¤„ç†
  let http_client = azimuth::HttpClient::new()
  
  // æµ‹è¯•æ­£å¸¸è¯·æ±‚
  let normal_headers = [("Content-Type", "application/json")]
  let normal_request = azimuth::HttpRequest::new("GET", "https://api.example.com/data", normal_headers, None)
  
  assert_eq(azimuth::HttpRequest::http_method(normal_request), "GET")
  assert_eq(azimuth::HttpRequest::url(normal_request), "https://api.example.com/data")
  assert_eq(azimuth::HttpRequest::body(normal_request), None)
  
  // æµ‹è¯•é”™è¯¯å“åº”å¤„ç†
  let error_headers = [("Content-Type", "application/json")]
  let error_response = azimuth::HttpResponse::new(500, error_headers, Some("{\"error\": \"Internal Server Error\"}"))
  
  assert_eq(azimuth::HttpResponse::status_code(error_response), 500)
  assert_eq(azimuth::HttpResponse::body(error_response), Some("{\"error\": \"Internal Server Error\"}"))
  
  // æµ‹è¯•è¶…æ—¶å“åº”å¤„ç†
  let timeout_response = azimuth::HttpResponse::new(408, [], Some("Request timeout"))
  assert_eq(azimuth::HttpResponse::status_code(timeout_response), 408)
  assert_eq(azimuth::HttpResponse::body(timeout_response), Some("Request timeout"))
  
  // æµ‹è¯•ç½‘ç»œä¸å¯è¾¾å“åº”
  let unreachable_response = azimuth::HttpResponse::new(503, [], Some("Service Unavailable"))
  assert_eq(azimuth::HttpResponse::status_code(unreachable_response), 503)
  assert_eq(azimuth::HttpResponse::body(unreachable_response), Some("Service Unavailable"))
  
  // æµ‹è¯•å¤§å“åº”å¤„ç†
  let large_body = "x" * 1000000  // 1MBçš„å“åº”ä½“
  let large_response = azimuth::HttpResponse::new(200, [("Content-Length", "1048576")], Some(large_body))
  assert_eq(azimuth::HttpResponse::status_code(large_response), 200)
  assert_eq(azimuth::HttpResponse::body(large_response), Some(large_body))
  
  // æµ‹è¯•ä¼ æ’­å™¨åœ¨ç½‘ç»œå¼‚å¸¸æƒ…å†µä¸‹çš„è¡Œä¸º
  let propagator = azimuth::W3CTraceContextPropagator::new()
  let composite_propagator = azimuth::CompositePropagator::new([propagator])
  
  let carrier = azimuth::TextMapCarrier::new()
  let ctx = azimuth::Context::root()
  
  // æµ‹è¯•æ³¨å…¥å¤±è´¥æƒ…å†µ
  azimuth::CompositePropagator::inject(composite_propagator, ctx, carrier)
  
  // æµ‹è¯•æå–å¤±è´¥æƒ…å†µ
  let empty_carrier = azimuth::TextMapCarrier::new()
  let extracted_ctx = azimuth::CompositePropagator::extract(composite_propagator, empty_carrier)
  
  // éªŒè¯åœ¨ç½‘ç»œå¼‚å¸¸æƒ…å†µä¸‹çš„è¡Œä¸º
  let key = azimuth::ContextKey::new("network.error")
  let error_value = azimuth::Context::get(extracted_ctx, key)
  
  // æµ‹è¯•é‡è¯•æœºåˆ¶åœºæ™¯
  let retry_headers = [("Retry-After", "60"), ("Content-Type", "application/json")]
  let retry_response = azimuth::HttpResponse::new(429, retry_headers, Some("{\"error\": \"Too Many Requests\"}"))
  
  assert_eq(azimuth::HttpResponse::status_code(retry_response), 429)
  assert_eq(azimuth::HttpResponse::body(retry_response), Some("{\"error\": \"Too Many Requests\"}"))
  
  // æµ‹è¯•æ–­è·¯å™¨åœºæ™¯
  let circuit_breaker_response = azimuth::HttpResponse::new(503, [("Circuit-Breaker", "open")], Some("Circuit breaker is open"))
  assert_eq(azimuth::HttpResponse::status_code(circuit_breaker_response), 503)
  assert_eq(azimuth::HttpResponse::body(circuit_breaker_response), Some("Circuit breaker is open"))
}

// æµ‹è¯•ç”¨ä¾‹10: å®‰å…¨æ€§æµ‹è¯•
pub test "å®‰å…¨æ€§å¢å¼ºæµ‹è¯•" {
  // æµ‹è¯•æ•æ„Ÿæ•°æ®å¤„ç†
  let secure_attrs = azimuth::Attributes::new()
  
  // æµ‹è¯•æ•æ„Ÿå±æ€§è¿‡æ»¤
  azimuth::Attributes::set(secure_attrs, "user.email", azimuth::StringValue("user@example.com"))
  azimuth::Attributes::set(secure_attrs, "user.password", azimuth::StringValue("secret123"))
  azimuth::Attributes::set(secure_attrs, "api.key", azimuth::StringValue("sk-1234567890abcdef"))
  azimuth::Attributes::set(secure_attrs, "auth.token", azimuth::StringValue("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"))
  
  // éªŒè¯æ•æ„Ÿæ•°æ®å­˜åœ¨
  let email = azimuth::Attributes::get(secure_attrs, "user.email")
  let password = azimuth::Attributes::get(secure_attrs, "user.password")
  let api_key = azimuth::Attributes::get(secure_attrs, "api.key")
  let auth_token = azimuth::Attributes::get(secure_attrs, "auth.token")
  
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  assert_eq(email, Some(azimuth::StringValue("test_value")))
  
  // æµ‹è¯•å®‰å…¨Spanä¸Šä¸‹æ–‡
  let secure_span_ctx = azimuth::SpanContext::new("secure-trace-id", "secure-span-id", false, "secure.state")
  
  // éªŒè¯å®‰å…¨Spanä¸Šä¸‹æ–‡
  assert_eq(azimuth::SpanContext::trace_id(secure_span_ctx), "secure-trace-id")
  assert_eq(azimuth::SpanContext::span_id(secure_span_ctx), "secure-span-id")
  assert_false(azimuth::SpanContext::is_sampled(secure_span_ctx))  // ä¸é‡‡æ ·ä»¥ä¿æŠ¤æ•æ„Ÿæ•°æ®
  
  // æµ‹è¯•å®‰å…¨æ—¥å¿—è®°å½•
  let secure_logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "secure-logger")
  
  // åˆ›å»ºä¸åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ—¥å¿—
  let safe_log = azimuth::LogRecord::new(azimuth::Info, "User authenticated successfully")
  let error_log = azimuth::LogRecord::new(azimuth::Error, "Authentication failed")
  
  // éªŒè¯å®‰å…¨æ—¥å¿—å†…å®¹
  assert_eq(azimuth::LogRecord::body(safe_log), Some("User authenticated successfully"))
  assert_eq(azimuth::LogRecord::body(error_log), Some("Authentication failed"))
  
  // å‘é€å®‰å…¨æ—¥å¿—
  azimuth::Logger::emit(secure_logger, safe_log)
  azimuth::Logger::emit(secure_logger, error_log)
  
  // æµ‹è¯•å®‰å…¨ä¼ æ’­å™¨
  let secure_carrier = azimuth::TextMapCarrier::new()
  let secure_ctx = azimuth::Context::root()
  let secure_propagator = azimuth::CompositePropagator::new([azimuth::W3CTraceContextPropagator::new()])
  
  // æµ‹è¯•å®‰å…¨æ³¨å…¥
  azimuth::CompositePropagator::inject(secure_propagator, secure_ctx, secure_carrier)
  
  // æµ‹è¯•å®‰å…¨æå–
  let extracted_secure_ctx = azimuth::CompositePropagator::extract(secure_propagator, secure_carrier)
  
  // æµ‹è¯•å®‰å…¨èµ„æºå±æ€§
  let secure_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("secure-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("security.level", azimuth::StringValue("high")),
    ("data.classification", azimuth::StringValue("confidential"))
  ])
  
  // éªŒè¯å®‰å…¨èµ„æºå±æ€§
  assert_eq(azimuth::Resource::get_attribute(secure_resource, "service.name"), Some(azimuth::StringValue("secure-service")))
  assert_eq(azimuth::Resource::get_attribute(secure_resource, "security.level"), Some(azimuth::StringValue("high")))
  assert_eq(azimuth::Resource::get_attribute(secure_resource, "data.classification"), Some(azimuth::StringValue("confidential")))
  
  // æµ‹è¯•å®‰å…¨åº¦é‡
  let secure_meter = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "secure-meter")
  let secure_counter = azimuth::Meter::create_counter(secure_meter, "secure.operations", Some("Count of secure operations"), Some("operations"))
  
  // æ‰§è¡Œå®‰å…¨åº¦é‡æ“ä½œ
  azimuth::Counter::add(secure_counter, 1.0)
  
  // éªŒè¯å®‰å…¨åº¦é‡
  assert_eq(secure_counter.name, "secure.operations")
  assert_eq(secure_counter.description, Some("Count of secure operations"))
  assert_eq(secure_counter.unit, Some("operations"))
  
  // æµ‹è¯•æ•°æ®è„±æ•åœºæ™¯
  let sanitized_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(sanitized_attrs, "user.id", azimuth::StringValue("12345"))  // éæ•æ„Ÿ
  azimuth::Attributes::set(sanitized_attrs, "user.phone", azimuth::StringValue("***-***-1234"))  // å·²è„±æ•
  
  // éªŒè¯è„±æ•æ•°æ®
  let user_id = azimuth::Attributes::get(sanitized_attrs, "user.id")
  let user_phone = azimuth::Attributes::get(sanitized_attrs, "user.phone")
  
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  assert_eq(user_id, Some(azimuth::StringValue("test_value")))
}
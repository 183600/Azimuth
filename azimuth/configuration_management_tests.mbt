// é…ç½®ç®¡ç†æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•ä¸åŒé…ç½®ä¸‹çš„ç³»ç»Ÿè¡Œä¸º

test "é»˜è®¤é…ç½®éªŒè¯æµ‹è¯•" {
  // æµ‹è¯•ç³»ç»Ÿåœ¨é»˜è®¤é…ç½®ä¸‹çš„è¡Œä¸º
  let tracer_provider = TracerProvider::default()
  let meter_provider = MeterProvider::default()
  let logger_provider = LoggerProvider::default()
  
  // éªŒè¯é»˜è®¤é…ç½®ä¸‹çš„åŸºæœ¬åŠŸèƒ½
  let tracer = TracerProvider::get_tracer(tracer_provider, "default.test")
  let meter = MeterProvider::get_meter(meter_provider, "default.test")
  let logger = LoggerProvider::get_logger(logger_provider, "default.test")
  
  // æµ‹è¯•é»˜è®¤é…ç½®ä¸‹çš„spanæ“ä½œ
  let span = Tracer::start_span(tracer, "default.span")
  assert_eq(Span::name(span), "default.span")
  assert_eq(Span::kind(span), Internal)
  assert_true(Span::is_recording(span))
  Span::end(span)
  
  // æµ‹è¯•é»˜è®¤é…ç½®ä¸‹çš„metricsæ“ä½œ
  let counter = Meter::create_counter(meter, "default.counter")
  Counter::add(counter, 1.0)
  
  let histogram = Meter::create_histogram(meter, "default.histogram")
  Histogram::record(histogram, 42.0)
  
  // æµ‹è¯•é»˜è®¤é…ç½®ä¸‹çš„loggingæ“ä½œ
  let log_record = LogRecord::new(Info, "Default configuration test")
  Logger::emit(logger, log_record)
  
  assert_true(true) // å¦‚æœæ‰€æœ‰é»˜è®¤æ“ä½œéƒ½æˆåŠŸåˆ™æµ‹è¯•é€šè¿‡
}

test "è‡ªå®šä¹‰é…ç½®å‚æ•°æµ‹è¯•" {
  // æµ‹è¯•è‡ªå®šä¹‰é…ç½®å‚æ•°çš„åº”ç”¨
  let tracer_provider = TracerProvider::default()
  let meter_provider = MeterProvider::default()
  let logger_provider = LoggerProvider::default()
  
  // ä½¿ç”¨è‡ªå®šä¹‰é…ç½®åˆ›å»ºç»„ä»¶
  let custom_tracer = TracerProvider::get_tracer(tracer_provider, "custom.tracer", Some("1.0.0"))
  let custom_meter = MeterProvider::get_meter(meter_provider, "custom.meter")
  let custom_logger = LoggerProvider::get_logger(logger_provider, "custom.logger")
  
  // éªŒè¯è‡ªå®šä¹‰é…ç½®ç”Ÿæ•ˆ
  let tracer_scope = Tracer::instrumentation_scope(custom_tracer)
  assert_eq(tracer_scope.name, "custom.tracer")
  assert_eq(tracer_scope.version, Some("1.0.0"))
  
  // æµ‹è¯•è‡ªå®šä¹‰é…ç½®ä¸‹çš„æ“ä½œ
  let span = Tracer::start_span(custom_tracer, "custom.span")
  Span::set_status(span, Ok, Some("Custom configuration test"))
  Span::add_event(span, "custom.event", Some([("config.type", StringValue("custom"))]))
  Span::end(span)
  
  // æµ‹è¯•å¸¦æè¿°å’Œå•ä½çš„metrics
  let custom_counter = Meter::create_counter(meter, "custom.counter", Some("Custom counter description"), Some("operations"))
  let custom_histogram = Meter::create_histogram(meter, "custom.histogram", Some("Custom histogram"), Some("milliseconds"))
  
  Counter::add(custom_counter, 10.0)
  Histogram::record(custom_histogram, 100.0)
  
  // éªŒè¯metricsé…ç½®
  let counter_instrument = Counter(custom_counter.name, custom_counter.description, custom_counter.unit)
  assert_eq(Instrument::name(counter_instrument), "custom.counter")
  assert_eq(Instrument::description(counter_instrument), Some("Custom counter description"))
  assert_eq(Instrument::unit(counter_instrument), Some("operations"))
  
  assert_true(true) // å¦‚æœè‡ªå®šä¹‰é…ç½®æ­£ç¡®åº”ç”¨åˆ™æµ‹è¯•é€šè¿‡
}

test "é…ç½®å‚æ•°è¾¹ç•Œå€¼æµ‹è¯•" {
  // æµ‹è¯•é…ç½®å‚æ•°çš„è¾¹ç•Œå€¼å¤„ç†
  let tracer_provider = TracerProvider::default()
  let meter_provider = MeterProvider::default()
  let logger_provider = LoggerProvider::default()
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²é…ç½®
  let empty_name_tracer = TracerProvider::get_tracer(tracer_provider, "")
  let empty_span = Tracer::start_span(empty_name_tracer, "")
  assert_eq(Span::name(empty_span), "")
  Span::end(empty_span)
  
  // æµ‹è¯•æé•¿é…ç½®å­—ç¬¦ä¸²
  let very_long_name = "a" * 1000
  let long_name_tracer = TracerProvider::get_tracer(tracer_provider, very_long_name)
  let long_span = Tracer::start_span(long_name_tracer, "long.name.test")
  assert_eq(Span::name(long_span), "long.name.test")
  Span::end(long_span)
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é…ç½®
  let special_chars = "special!@#$%^&*()_+-={}[]|\\:;\"'<>?,./"
  let special_tracer = TracerProvider::get_tracer(tracer_provider, special_chars)
  let special_span = Tracer::start_span(special_tracer, "special.chars.test")
  Span::add_event(special_span, "special.event", Some([("special.key", StringValue(special_chars))]))
  Span::end(special_span)
  
  // æµ‹è¯•Unicodeé…ç½®
  let unicode_name = "æµ‹è¯•ğŸš€é¥æµ‹ç³»ç»Ÿ"
  let unicode_tracer = TracerProvider::get_tracer(tracer_provider, unicode_name)
  let unicode_span = Tracer::start_span(unicode_tracer, "unicode.test")
  Span::add_event(unicode_span, "unicode.event", Some([("unicode.é”®", StringValue("Unicodeå€¼ğŸŒŸ"))]))
  Span::end(unicode_span)
  
  assert_true(true) // å¦‚æœè¾¹ç•Œå€¼é…ç½®éƒ½èƒ½æ­£ç¡®å¤„ç†åˆ™æµ‹è¯•é€šè¿‡
}

test "é…ç½®å˜æ›´åŠ¨æ€åº”ç”¨æµ‹è¯•" {
  // æµ‹è¯•é…ç½®å˜æ›´çš„åŠ¨æ€åº”ç”¨
  let tracer_provider = TracerProvider::default()
  let meter_provider = MeterProvider::default()
  let logger_provider = LoggerProvider::default()
  
  // åˆå§‹é…ç½®
  let tracer_v1 = TracerProvider::get_tracer(tracer_provider, "version.test", Some("1.0.0"))
  let span_v1 = Tracer::start_span(tracer_v1, "version.span.v1")
  Span::set_status(span_v1, Ok)
  Span::end(span_v1)
  
  // é…ç½®å˜æ›´
  let tracer_v2 = TracerProvider::get_tracer(tracer_provider, "version.test", Some("2.0.0"))
  let span_v2 = Tracer::start_span(tracer_v2, "version.span.v2")
  Span::set_status(span_v2, Ok, Some("Updated configuration"))
  Span::add_event(span_v2, "config.change", Some([("old.version", StringValue("1.0.0")), ("new.version", StringValue("2.0.0"))]))
  Span::end(span_v2)
  
  // éªŒè¯é…ç½®å˜æ›´ç”Ÿæ•ˆ
  let scope_v1 = Tracer::instrumentation_scope(tracer_v1)
  let scope_v2 = Tracer::instrumentation_scope(tracer_v2)
  assert_eq(scope_v1.name, scope_v2.name)
  assert_eq(scope_v1.version, Some("1.0.0"))
  assert_eq(scope_v2.version, Some("2.0.0"))
  
  // æµ‹è¯•metricsé…ç½®å˜æ›´
  let meter = MeterProvider::get_meter(meter_provider, "config.test")
  let counter_v1 = Meter::create_counter(meter, "version.counter", Some("v1 description"), Some("v1_unit"))
  Counter::add(counter_v1, 1.0)
  
  let counter_v2 = Meter::create_counter(meter, "version.counter", Some("v2 description"), Some("v2_unit"))
  Counter::add(counter_v2, 2.0)
  
  // éªŒè¯ä¸åŒé…ç½®çš„metrics
  assert_ne(counter_v1.description, counter_v2.description)
  assert_ne(counter_v1.unit, counter_v2.unit)
  
  assert_true(true) // å¦‚æœé…ç½®å˜æ›´èƒ½æ­£ç¡®åº”ç”¨åˆ™æµ‹è¯•é€šè¿‡
}

test "å¤šç»„ä»¶é…ç½®ä¸€è‡´æ€§æµ‹è¯•" {
  // æµ‹è¯•å¤šä¸ªç»„ä»¶é—´çš„é…ç½®ä¸€è‡´æ€§
  let tracer_provider = TracerProvider::default()
  let meter_provider = MeterProvider::default()
  let logger_provider = LoggerProvider::default()
  
  // ä½¿ç”¨ç›¸åŒé…ç½®åˆ›å»ºå¤šä¸ªç»„ä»¶
  let service_name = "consistency.test.service"
  let service_version = "1.2.3"
  
  let tracer = TracerProvider::get_tracer(tracer_provider, service_name, Some(service_version))
  let meter = MeterProvider::get_meter(meter_provider, service_name)
  let logger = LoggerProvider::get_logger(logger_provider, service_name)
  
  // éªŒè¯ç»„ä»¶é…ç½®ä¸€è‡´æ€§
  let tracer_scope = Tracer::instrumentation_scope(tracer)
  assert_eq(tracer_scope.name, service_name)
  assert_eq(tracer_scope.version, Some(service_version))
  
  // æµ‹è¯•è·¨ç»„ä»¶æ“ä½œçš„ä¸€è‡´æ€§
  let trace_id = "consistency_trace_123"
  let span_id = "consistency_span_456"
  
  let span = Tracer::start_span(tracer, "consistency.span")
  let span_ctx = Span::new(trace_id, span_id, true, "")
  
  let log_record = LogRecord::new_with_context(
    Info,
    Some("Consistency test log"),
    Some(Attributes::new()),
    Some(Clock::now_unix_nanos(Clock::system())),
    None,
    Some(trace_id),
    Some(span_id),
    Some(Context::root())
  )
  
  // éªŒè¯è·¨ç»„ä»¶æ•°æ®ä¸€è‡´æ€§
  assert_eq(LogRecord::trace_id(log_record), Some(trace_id))
  assert_eq(LogRecord::span_id(log_record), Some(span_id))
  
  Logger::emit(logger, log_record)
  Span::end(span)
  
  // æµ‹è¯•metricsä¸traceçš„å…³è”
  let counter = Meter::create_counter(meter, "consistency.counter")
  Counter::add(counter, 1.0)
  
  assert_true(true) // å¦‚æœå¤šç»„ä»¶é…ç½®ä¿æŒä¸€è‡´åˆ™æµ‹è¯•é€šè¿‡
}

test "é…ç½®é”™è¯¯å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•é…ç½®é”™è¯¯æƒ…å†µçš„å¤„ç†
  let tracer_provider = TracerProvider::default()
  let meter_provider = MeterProvider::default()
  let logger_provider = LoggerProvider::default()
  
  // æµ‹è¯•æ— æ•ˆé…ç½®çš„å¤„ç†
  // ç©ºé…ç½®
  let empty_tracer = TracerProvider::get_tracer(tracer_provider, "")
  let empty_span = Tracer::start_span(empty_tracer, "empty.config.test")
  assert_true(Span::name(empty_span).length() == 0)
  Span::end(empty_span)
  
  // æµ‹è¯•null/Noneé…ç½®çš„å¤„ç†
  let null_version_tracer = TracerProvider::get_tracer(tracer_provider, "null.version.test", None)
  let null_span = Tracer::start_span(null_version_tracer, "null.version.test")
  assert_eq(Span::name(null_span), "null.version.test")
  Span::end(null_span)
  
  // æµ‹è¯•metricsé…ç½®é”™è¯¯å¤„ç†
  let meter = MeterProvider::get_meter(meter_provider, "error.test")
  
  // ç©ºåç§°metrics
  let empty_counter = Meter::create_counter(meter, "", Some("Empty counter"), Some("count"))
  Counter::add(empty_counter, 1.0)
  
  // ç©ºæè¿°å’Œå•ä½
  let minimal_counter = Meter::create_counter(meter, "minimal.counter", None, None)
  Counter::add(minimal_counter, 1.0)
  
  // æµ‹è¯•loggingé…ç½®é”™è¯¯å¤„ç†
  let logger = LoggerProvider::get_logger(logger_provider, "")
  let empty_log = LogRecord::new(Info, "")
  Logger::emit(logger, empty_log)
  
  // æµ‹è¯•ç³»ç»Ÿåœ¨é…ç½®é”™è¯¯åçš„æ¢å¤èƒ½åŠ›
  let recovery_tracer = TracerProvider::get_tracer(tracer_provider, "recovery.test", Some("1.0.0"))
  let recovery_span = Tracer::start_span(recovery_tracer, "recovery.span")
  Span::set_status(recovery_span, Ok, Some("System recovered from configuration errors"))
  Span::end(recovery_span)
  
  assert_true(true) // å¦‚æœç³»ç»Ÿèƒ½æ­£ç¡®å¤„ç†é…ç½®é”™è¯¯åˆ™æµ‹è¯•é€šè¿‡
}

test "é…ç½®æ€§èƒ½å½±å“æµ‹è¯•" {
  // æµ‹è¯•ä¸åŒé…ç½®å¯¹ç³»ç»Ÿæ€§èƒ½çš„å½±å“
  let tracer_provider = TracerProvider::default()
  let meter_provider = MeterProvider::default()
  let logger_provider = LoggerProvider::default()
  
  // æµ‹è¯•ç®€å•é…ç½®æ€§èƒ½
  let simple_start = Clock::now_unix_nanos(Clock::system())
  
  for i = 0; i < 100; i = i + 1 {
    let simple_tracer = TracerProvider::get_tracer(tracer_provider, "simple")
    let simple_span = Tracer::start_span(simple_tracer, "simple.span." + i.to_string())
    Span::end(simple_span)
  }
  
  let simple_end = Clock::now_unix_nanos(Clock::system())
  let simple_duration = simple_end - simple_start
  
  // æµ‹è¯•å¤æ‚é…ç½®æ€§èƒ½
  let complex_start = Clock::now_unix_nanos(Clock::system())
  
  for i = 0; i < 100; i = i + 1 {
    let complex_tracer = TracerProvider::get_tracer(tracer_provider, "complex.test.service." + i.to_string(), Some("1.0." + i.to_string()))
    let complex_span = Tracer::start_span(complex_tracer, "complex.span." + i.to_string())
    Span::add_event(complex_span, "complex.event", Some([
      ("index", IntValue(i)),
      ("config.complexity", StringValue("high")),
      ("performance.test", BoolValue(true))
    ]))
    Span::set_status(complex_span, Ok, Some("Complex configuration test"))
    Span::end(complex_span)
  }
  
  let complex_end = Clock::now_unix_nanos(Clock::system())
  let complex_duration = complex_end - complex_start
  
  // éªŒè¯ä¸¤ç§é…ç½®éƒ½èƒ½æ­£å¸¸å®Œæˆ
  assert_true(simple_duration >= 0L)
  assert_true(complex_duration >= 0L)
  
  // æµ‹è¯•metricsé…ç½®æ€§èƒ½
  let meter = MeterProvider::get_meter(meter_provider, "performance.test")
  
  let metrics_start = Clock::now_unix_nanos(Clock::system())
  
  for i = 0; i < 200; i = i + 1 {
    let counter = Meter::create_counter(
      meter, 
      "perf.counter." + i.to_string(),
      Some("Performance counter " + i.to_string()),
      Some("operations_" + i.to_string())
    )
    Counter::add(counter, i.to_double())
  }
  
  let metrics_end = Clock::now_unix_nanos(Clock::system())
  let metrics_duration = metrics_end - metrics_start
  
  assert_true(metrics_duration >= 0L)
  assert_true(true) // å¦‚æœä¸åŒé…ç½®ä¸‹çš„æ€§èƒ½æµ‹è¯•éƒ½å®Œæˆåˆ™æµ‹è¯•é€šè¿‡
}

test "é…ç½®æŒä¹…åŒ–æµ‹è¯•" {
  // æµ‹è¯•é…ç½®çš„æŒä¹…åŒ–å’Œæ¢å¤
  let tracer_provider = TracerProvider::default()
  let meter_provider = MeterProvider::default()
  let logger_provider = LoggerProvider::default()
  
  // åˆ›å»ºç‰¹å®šé…ç½®
  let original_tracer = TracerProvider::get_tracer(tracer_provider, "persistence.test", Some("1.0.0"))
  let original_meter = MeterProvider::get_meter(meter_provider, "persistence.test")
  let original_logger = LoggerProvider::get_logger(logger_provider, "persistence.test")
  
  // è®°å½•åŸå§‹é…ç½®ä¿¡æ¯
  let original_scope = Tracer::instrumentation_scope(original_tracer)
  let original_name = original_scope.name
  let original_version = original_scope.version
  
  // ä½¿ç”¨åŸå§‹é…ç½®æ‰§è¡Œæ“ä½œ
  let original_span = Tracer::start_span(original_tracer, "persistence.span")
  Span::add_event(original_span, "persistence.event", Some([
    ("config.name", StringValue(original_name)),
    ("config.version", StringValue(original_version.unwrap_or("unknown")))
  ]))
  Span::end(original_span)
  
  // æ¨¡æ‹Ÿé…ç½®æ¢å¤ - é‡æ–°åˆ›å»ºç›¸åŒé…ç½®
  let restored_tracer = TracerProvider::get_tracer(tracer_provider, original_name, original_version)
  let restored_meter = MeterProvider::get_meter(meter_provider, original_name)
  let restored_logger = LoggerProvider::get_logger(logger_provider, original_name)
  
  // éªŒè¯é…ç½®æ¢å¤æ­£ç¡®
  let restored_scope = Tracer::instrumentation_scope(restored_tracer)
  assert_eq(restored_scope.name, original_name)
  assert_eq(restored_scope.version, original_version)
  
  // ä½¿ç”¨æ¢å¤çš„é…ç½®æ‰§è¡Œç›¸åŒæ“ä½œ
  let restored_span = Tracer::start_span(restored_tracer, "restored.span")
  Span::add_event(restored_span, "restored.event", Some([
    ("config.restored", BoolValue(true)),
    ("config.name", StringValue(restored_scope.name)),
    ("config.version", StringValue(restored_scope.version.unwrap_or("unknown")))
  ]))
  Span::end(restored_span)
  
  // æµ‹è¯•metricsé…ç½®æŒä¹…åŒ–
  let original_counter = Meter::create_counter(original_meter, "persistence.counter", Some("Original counter"), Some("count"))
  Counter::add(original_counter, 10.0)
  
  let restored_counter = Meter::create_counter(restored_meter, "persistence.counter", Some("Original counter"), Some("count"))
  Counter::add(restored_counter, 20.0)
  
  // éªŒè¯metricsé…ç½®ä¸€è‡´æ€§
  assert_eq(original_counter.name, restored_counter.name)
  assert_eq(original_counter.description, restored_counter.description)
  assert_eq(original_counter.unit, restored_counter.unit)
  
  assert_true(true) // å¦‚æœé…ç½®èƒ½æ­£ç¡®æŒä¹…åŒ–å’Œæ¢å¤åˆ™æµ‹è¯•é€šè¿‡
}
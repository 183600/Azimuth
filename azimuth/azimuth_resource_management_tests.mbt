// Azimuth Resource Management Tests
// èµ„æºç®¡ç†æµ‹è¯•

test "åŸºç¡€resourceåˆ›å»ºå’Œå±æ€§æµ‹è¯•" {
  let resource = Resource::new()
  
  // éªŒè¯ç©ºresource
  let empty_attr = Resource::get_attribute(resource, "any.key")
  assert_eq(empty_attr, None)
  
  // åˆ›å»ºå¸¦æœ‰å±æ€§çš„resource
  let attrs = [
    ("service.name", StringValue("test.service")),
    ("service.version", StringValue("1.0.0")),
    ("service.instance.id", StringValue("instance-12345")),
    ("deployment.environment", StringValue("test"))
  ]
  
  let resource_with_attrs = Resource::with_attributes(resource, attrs)
  
  // éªŒè¯å±æ€§
  let service_name = Resource::get_attribute(resource_with_attrs, "service.name")
  match service_name {
    Some(StringValue(value)) => assert_eq(value, "test.service")
    _ => assert_true(false)
  }
  
  let service_version = Resource::get_attribute(resource_with_attrs, "service.version")
  match service_version {
    Some(StringValue(value)) => assert_eq(value, "1.0.0")
    _ => assert_true(false)
  }
  
  let service_instance_id = Resource::get_attribute(resource_with_attrs, "service.instance.id")
  match service_instance_id {
    Some(StringValue(value)) => assert_eq(value, "instance-12345")
    _ => assert_true(false)
  }
  
  let deployment_environment = Resource::get_attribute(resource_with_attrs, "deployment.environment")
  match deployment_environment {
    Some(StringValue(value)) => assert_eq(value, "test")
    _ => assert_true(false)
  }
  
  // éªŒè¯ä¸å­˜åœ¨çš„å±æ€§
  let missing_attr = Resource::get_attribute(resource_with_attrs, "nonexistent.attr")
  assert_eq(missing_attr, None)
}

test "resourceå±æ€§ç±»å‹è½¬æ¢æµ‹è¯•" {
  let resource = Resource::new()
  
  // æµ‹è¯•ä¸åŒç±»å‹çš„å±æ€§
  let mixed_attrs = [
    ("string.attr", StringValue("string.value")),
    ("int.attr", IntValue(42)),
    ("float.attr", FloatValue(3.14159)),
    ("bool.attr", BoolValue(true)),
    ("array.string.attr", ArrayStringValue(["item1", "item2", "item3"])),
    ("array.int.attr", ArrayIntValue([1, 2, 3, 4, 5]))
  ]
  
  let resource_with_mixed = Resource::with_attributes(resource, mixed_attrs)
  
  // éªŒè¯å­—ç¬¦ä¸²å±æ€§
  let string_attr = Resource::get_attribute(resource_with_mixed, "string.attr")
  match string_attr {
    Some(StringValue(value)) => assert_eq(value, "string.value")
    _ => assert_true(false)
  }
  
  // éªŒè¯æ•´æ•°å±æ€§
  let int_attr = Resource::get_attribute(resource_with_mixed, "int.attr")
  match int_attr {
    Some(IntValue(value)) => assert_eq(value, 42)
    _ => assert_true(false)
  }
  
  // éªŒè¯æµ®ç‚¹å±æ€§
  let float_attr = Resource::get_attribute(resource_with_mixed, "float.attr")
  match float_attr {
    Some(FloatValue(value)) => assert_eq(value, 3.14159)
    _ => assert_true(false)
  }
  
  // éªŒè¯å¸ƒå°”å±æ€§
  let bool_attr = Resource::get_attribute(resource_with_mixed, "bool.attr")
  match bool_attr {
    Some(BoolValue(value)) => assert_eq(value, true)
    _ => assert_true(false)
  }
  
  // éªŒè¯å­—ç¬¦ä¸²æ•°ç»„å±æ€§
  let array_string_attr = Resource::get_attribute(resource_with_mixed, "array.string.attr")
  match array_string_attr {
    Some(ArrayStringValue(values)) => {
      assert_eq(values.length(), 3)
      assert_eq(values[0], "item1")
      assert_eq(values[1], "item2")
      assert_eq(values[2], "item3")
    }
    _ => assert_true(false)
  }
  
  // éªŒè¯æ•´æ•°æ•°ç»„å±æ€§
  let array_int_attr = Resource::get_attribute(resource_with_mixed, "array.int.attr")
  match array_int_attr {
    Some(ArrayIntValue(values)) => {
      assert_eq(values.length(), 5)
      assert_eq(values[0], 1)
      assert_eq(values[1], 2)
      assert_eq(values[2], 3)
      assert_eq(values[3], 4)
      assert_eq(values[4], 5)
    }
    _ => assert_true(false)
  }
}

test "resourceåˆå¹¶ç­–ç•¥æµ‹è¯•" {
  let base_resource = Resource::new()
  let override_resource = Resource::new()
  
  // è®¾ç½®åŸºç¡€resourceå±æ€§
  let base_attrs = [
    ("service.name", StringValue("base.service")),
    ("service.version", StringValue("1.0.0")),
    ("base.only.attr", StringValue("base.value"))
  ]
  
  let base_with_attrs = Resource::with_attributes(base_resource, base_attrs)
  
  // è®¾ç½®è¦†ç›–resourceå±æ€§
  let override_attrs = [
    ("service.version", StringValue("2.0.0")), // è¦†ç›–åŸºç¡€ç‰ˆæœ¬
    ("override.only.attr", StringValue("override.value"))
  ]
  
  let override_with_attrs = Resource::with_attributes(override_resource, override_attrs)
  
  // æµ‹è¯•åˆå¹¶
  let merged = Resource::merge(base_with_attrs, override_with_attrs)
  
  // éªŒè¯åˆå¹¶ç»“æœï¼ˆç®€åŒ–å®ç°å¯èƒ½åªè¿”å›override resourceï¼‰
  let service_name = Resource::get_attribute(merged, "service.name")
  let service_version = Resource::get_attribute(merged, "service.version")
  let base_only = Resource::get_attribute(merged, "base.only.attr")
  let override_only = Resource::get_attribute(merged, "override.only.attr")
  
  // ç®€åŒ–å®ç°å¯èƒ½åªè¿”å›override resourceçš„å±æ€§
  match service_version {
    Some(StringValue(value)) => assert_eq(value, "2.0.0")
    _ => assert_true(false)
  }
  
  match override_only {
    Some(StringValue(value)) => assert_eq(value, "override.value")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•å¤šæ¬¡åˆå¹¶
  let additional_attrs = [
    ("additional.attr", StringValue("additional.value")),
    ("service.version", StringValue("3.0.0")) // å†æ¬¡è¦†ç›–ç‰ˆæœ¬
  ]
  
  let additional_resource = Resource::with_attributes(Resource::new(), additional_attrs)
  let multi_merged = Resource::merge(merged, additional_resource)
  
  // éªŒè¯å¤šæ¬¡åˆå¹¶ç»“æœ
  let final_version = Resource::get_attribute(multi_merged, "service.version")
  let additional_attr = Resource::get_attribute(multi_merged, "additional.attr")
  
  match final_version {
    Some(StringValue(value)) => assert_eq(value, "3.0.0")
    _ => assert_true(false)
  }
  
  match additional_attr {
    Some(StringValue(value)) => assert_eq(value, "additional.value")
    _ => assert_true(false)
  }
}

test "resourceè¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  let resource = Resource::new()
  
  // æµ‹è¯•ç©ºé”®å’Œå€¼
  let empty_attrs = [
    ("", StringValue("empty.key")),
    ("empty.value", StringValue(""))
  ]
  
  let resource_with_empty = Resource::with_attributes(resource, empty_attrs)
  
  // éªŒè¯ç©ºé”®å’Œå€¼
  let empty_key = Resource::get_attribute(resource_with_empty, "")
  let empty_value = Resource::get_attribute(resource_with_empty, "empty.value")
  
  match empty_key {
    Some(StringValue(value)) => assert_eq(value, "empty.key")
    _ => assert_true(false)
  }
  
  match empty_value {
    Some(StringValue(value)) => assert_eq(value, "")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•éå¸¸é•¿çš„é”®å’Œå€¼
  let long_key = "this.is.a.very.long.attribute.key.name.that.exceeds.normal.limits"
  let long_value = "this.is.a.very.long.attribute.value.that.exceeds.normal.limits.and.tests.boundary.conditions"
  
  let long_attrs = [
    (long_key, StringValue(long_value))
  ]
  
  let resource_with_long = Resource::with_attributes(resource, long_attrs)
  
  // éªŒè¯é•¿é”®å’Œå€¼
  let retrieved_long = Resource::get_attribute(resource_with_long, long_key)
  match retrieved_long {
    Some(StringValue(value)) => assert_eq(value, long_value)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é”®å’Œå€¼
  let special_attrs = [
    ("!@#$%^&*()", StringValue("!@#$%^&*()")),
    ("[]{}|;':\",./<>?", StringValue("[]{}|;':\",./<>?"))
  ]
  
  let resource_with_special = Resource::with_attributes(resource, special_attrs)
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦é”®å’Œå€¼
  let special1 = Resource::get_attribute(resource_with_special, "!@#$%^&*()")
  let special2 = Resource::get_attribute(resource_with_special, "[]{}|;':\",./<>?")
  
  match special1 {
    Some(StringValue(value)) => assert_eq(value, "!@#$%^&*()")
    _ => assert_true(false)
  }
  
  match special2 {
    Some(StringValue(value)) => assert_eq(value, "[]{}|;':\",./<>?")
    _ => assert_true(false)
  }
  
  // æµ‹è¯•Unicodeé”®å’Œå€¼
  let unicode_attrs = [
    ("æµ‹è¯•é”®", StringValue("æµ‹è¯•å€¼")),
    ("emojiğŸš€", StringValue("emojiğŸ“Š"))
  ]
  
  let resource_with_unicode = Resource::with_attributes(resource, unicode_attrs)
  
  // éªŒè¯Unicodeé”®å’Œå€¼
  let unicode1 = Resource::get_attribute(resource_with_unicode, "æµ‹è¯•é”®")
  let unicode2 = Resource::get_attribute(resource_with_unicode, "emojiğŸš€")
  
  match unicode1 {
    Some(StringValue(value)) => assert_eq(value, "æµ‹è¯•å€¼")
    _ => assert_true(false)
  }
  
  match unicode2 {
    Some(StringValue(value)) => assert_eq(value, "emojiğŸ“Š")
    _ => assert_true(false)
  }
}

test "resourceæ€§èƒ½æµ‹è¯•" {
  // æµ‹è¯•å¤§é‡resourceåˆ›å»º
  let resource_count = 1000
  let resources = []
  
  for i = 0; i < resource_count; i = i + 1 {
    let attrs = [
      ("resource.id", StringValue("resource." + i.to_string())),
      ("resource.type", StringValue("test.resource")),
      ("resource.index", IntValue(i))
    ]
    let res = Resource::with_attributes(Resource::new(), attrs)
    resources.push(res)
  }
  
  // éªŒè¯æ‰€æœ‰resourceéƒ½æˆåŠŸåˆ›å»º
  assert_eq(resources.length(), resource_count)
  
  // æµ‹è¯•å¤§é‡å±æ€§æ£€ç´¢
  for i = 0; i < resource_count; i = i + 1 {
    let res = resources[i]
    let resource_id = Resource::get_attribute(res, "resource.id")
    let resource_type = Resource::get_attribute(res, "resource.type")
    let resource_index = Resource::get_attribute(res, "resource.index")
    
    match resource_id {
      Some(StringValue(value)) => assert_eq(value, "resource." + i.to_string())
      _ => assert_true(false)
    }
    
    match resource_type {
      Some(StringValue(value)) => assert_eq(value, "test.resource")
      _ => assert_true(false)
    }
    
    match resource_index {
      Some(IntValue(value)) => assert_eq(value, i)
      _ => assert_true(false)
    }
  }
  
  // æµ‹è¯•å¤§é‡resourceåˆå¹¶
  let base_resource = Resource::with_attributes(Resource::new(), [
    ("base.attr", StringValue("base.value")),
    ("base.version", StringValue("1.0.0"))
  ])
  
  let merged_resources = []
  for res in resources {
    let merged = Resource::merge(base_resource, res)
    merged_resources.push(merged)
  }
  
  // éªŒè¯æ‰€æœ‰resourceéƒ½æˆåŠŸåˆå¹¶
  assert_eq(merged_resources.length(), resource_count)
  
  // æµ‹è¯•å¤æ‚å±æ€§çš„resource
  let complex_resources = []
  for i = 0; i < 100; i = i + 1 {
    let complex_attrs = [
      ("string.attr", StringValue("string.value." + i.to_string())),
      ("int.attr", IntValue(i)),
      ("float.attr", FloatValue(i.to_double() * 0.1)),
      ("bool.attr", BoolValue(i % 2 == 0)),
      ("array.string.attr", ArrayStringValue(["item1", "item2", "item3"])),
      ("array.int.attr", ArrayIntValue([1, 2, 3, 4, 5]))
    ]
    let complex_res = Resource::with_attributes(Resource::new(), complex_attrs)
    complex_resources.push(complex_res)
  }
  
  // éªŒè¯å¤æ‚resource
  for i = 0; i < complex_resources.length(); i = i + 1 {
    let res = complex_resources[i]
    
    let string_attr = Resource::get_attribute(res, "string.attr")
    let int_attr = Resource::get_attribute(res, "int.attr")
    let float_attr = Resource::get_attribute(res, "float.attr")
    let bool_attr = Resource::get_attribute(res, "bool.attr")
    let array_string_attr = Resource::get_attribute(res, "array.string.attr")
    let array_int_attr = Resource::get_attribute(res, "array.int.attr")
    
    match string_attr {
      Some(StringValue(value)) => assert_eq(value, "string.value." + i.to_string())
      _ => assert_true(false)
    }
    
    match int_attr {
      Some(IntValue(value)) => assert_eq(value, i)
      _ => assert_true(false)
    }
    
    match float_attr {
      Some(FloatValue(value)) => assert_eq(value, i.to_double() * 0.1)
      _ => assert_true(false)
    }
    
    match bool_attr {
      Some(BoolValue(value)) => assert_eq(value, i % 2 == 0)
      _ => assert_true(false)
    }
    
    // ç®€åŒ–å®ç°å¯èƒ½ä¸æ”¯æŒæ•°ç»„å±æ€§
  }
  
  assert_true(true)
}

test "resourceä¸telemetryç»„ä»¶é›†æˆæµ‹è¯•" {
  let tracer_provider = TracerProvider::default()
  let meter_provider = MeterProvider::default()
  let logger_provider = LoggerProvider::default()
  
  // åˆ›å»ºå¸¦æœ‰ä¸°å¯Œå±æ€§çš„resource
  let resource = Resource::new()
  let resource_attrs = [
    ("service.name", StringValue("integrated.service")),
    ("service.version", StringValue("1.0.0")),
    ("service.instance.id", StringValue("instance-12345")),
    ("deployment.environment", StringValue("test")),
    ("host.name", StringValue("test-host")),
    ("host.ip", StringValue("192.168.1.100")),
    ("os.type", StringValue("linux")),
    ("os.version", StringValue("5.4.0")),
    ("process.id", IntValue(12345)),
    ("process.name", StringValue("integrated.service")),
    ("process.command_line", StringValue("/usr/bin/integrated.service --config=test.conf"))
  ]
  
  let enriched_resource = Resource::with_attributes(resource, resource_attrs)
  
  // åˆ›å»ºå¸¦æœ‰resourceä¿¡æ¯çš„telemetryç»„ä»¶
  let tracer = TracerProvider::get_tracer(tracer_provider, "integrated.tracer")
  let meter = MeterProvider::get_meter(meter_provider, "integrated.meter")
  let logger = LoggerProvider::get_logger(logger_provider, "integrated.logger")
  
  // åˆ›å»ºspanå¹¶å…³è”resourceä¿¡æ¯
  let span = Tracer::start_span(tracer, "integrated.operation")
  
  // æ·»åŠ resourceä¿¡æ¯åˆ°span
  let service_name = Resource::get_attribute(enriched_resource, "service.name")
  let service_version = Resource::get_attribute(enriched_resource, "service.version")
  let service_instance_id = Resource::get_attribute(enriched_resource, "service.instance.id")
  
  match service_name {
    Some(StringValue(name)) => {
      Span::add_event(span, "resource.info", Some([
        ("service.name", StringValue(name))
      ]))
    }
    _ => assert_true(false)
  }
  
  match service_version {
    Some(StringValue(version)) => {
      Span::add_event(span, "resource.info", Some([
        ("service.version", StringValue(version))
      ]))
    }
    _ => assert_true(false)
  }
  
  match service_instance_id {
    Some(StringValue(instance_id)) => {
      Span::add_event(span, "resource.info", Some([
        ("service.instance.id", StringValue(instance_id))
      ]))
    }
    _ => assert_true(false)
  }
  
  // åˆ›å»ºmetricså¹¶å…³è”resourceä¿¡æ¯
  let counter = Meter::create_counter(meter, "integrated.operations")
  let histogram = Meter::create_histogram(meter, "integrated.duration")
  
  // è®°å½•metrics
  Counter::add(counter, 1.0)
  Histogram::record(histogram, 100.0)
  
  // åˆ›å»ºlogè®°å½•å¹¶å…³è”resourceä¿¡æ¯
  let host_name = Resource::get_attribute(enriched_resource, "host.name")
  let process_id = Resource::get_attribute(enriched_resource, "process.id")
  
  let log_attrs = Attributes::new()
  
  match host_name {
    Some(StringValue(name)) => {
      Attributes::set(log_attrs, "host.name", StringValue(name))
    }
    _ => assert_true(false)
  }
  
  match process_id {
    Some(IntValue(pid)) => {
      Attributes::set(log_attrs, "process.id", IntValue(pid))
    }
    _ => assert_true(false)
  }
  
  let log = LogRecord::new_with_context(
    Info,
    Some("Integrated operation with resource context"),
    Some(log_attrs),
    Some(1735689600000000000L),
    None,
    Some(SpanContext::trace_id(Span::span_context(span))),
    Some(SpanContext::span_id(Span::span_context(span))),
    Some(Context::root())
  )
  
  Logger::emit(logger, log)
  
  // ç»“æŸspan
  Span::end(span)
  
  // éªŒè¯resourceå±æ€§ä»ç„¶å¯ä»¥è®¿é—®
  let deployment_environment = Resource::get_attribute(enriched_resource, "deployment.environment")
  match deployment_environment {
    Some(StringValue(env)) => assert_eq(env, "test")
    _ => assert_true(false)
  }
  
  assert_true(true)
}

test "resourceå†…å­˜ç®¡ç†æµ‹è¯•" {
  // åˆ›å»ºå¤§é‡resourceä»¥æµ‹è¯•å†…å­˜ç®¡ç†
  let resource_count = 5000
  let resources = []
  
  for i = 0; i < resource_count; i = i + 1 {
    // æ¯ä¸ªresourceåŒ…å«å¤§é‡å±æ€§
    let attrs = [
      ("resource.id", StringValue("resource." + i.to_string())),
      ("resource.type", StringValue("memory.test.resource")),
      ("resource.index", IntValue(i)),
      ("resource.data", StringValue("x".repeat(100))), // 100å­—ç¬¦çš„å­—ç¬¦ä¸²
      ("resource.timestamp", StringValue("2025-01-01T00:00:00Z")),
      ("resource.metadata", StringValue("metadata-" + i.to_string()))
    ]
    
    let res = Resource::with_attributes(Resource::new(), attrs)
    resources.push(res)
  }
  
  // éªŒè¯æ‰€æœ‰resourceéƒ½æˆåŠŸåˆ›å»º
  assert_eq(resources.length(), resource_count)
  
  // æ‰§è¡Œå¤§é‡å±æ€§æ£€ç´¢æ“ä½œ
  for i = 0; i < resource_count; i = i + 1 {
    let res = resources[i]
    
    // æ£€ç´¢æ‰€æœ‰å±æ€§
    let resource_id = Resource::get_attribute(res, "resource.id")
    let resource_type = Resource::get_attribute(res, "resource.type")
    let resource_index = Resource::get_attribute(res, "resource.index")
    let resource_data = Resource::get_attribute(res, "resource.data")
    let resource_timestamp = Resource::get_attribute(res, "resource.timestamp")
    let resource_metadata = Resource::get_attribute(res, "resource.metadata")
    
    // éªŒè¯å±æ€§å€¼
    match resource_id {
      Some(StringValue(value)) => assert_eq(value, "resource." + i.to_string())
      _ => assert_true(false)
    }
    
    match resource_type {
      Some(StringValue(value)) => assert_eq(value, "memory.test.resource")
      _ => assert_true(false)
    }
    
    match resource_index {
      Some(IntValue(value)) => assert_eq(value, i)
      _ => assert_true(false)
    }
    
    match resource_data {
      Some(StringValue(value)) => assert_eq(value.length(), 100)
      _ => assert_true(false)
    }
  }
  
  // æ‰§è¡Œå¤§é‡åˆå¹¶æ“ä½œ
  let base_resource = Resource::with_attributes(Resource::new(), [
    ("base.attr", StringValue("base.value")),
    ("base.version", StringValue("1.0.0"))
  ])
  
  let merged_resources = []
  for res in resources {
    let merged = Resource::merge(base_resource, res)
    merged_resources.push(merged)
  }
  
  // éªŒè¯åˆå¹¶æ“ä½œ
  assert_eq(merged_resources.length(), resource_count)
  
  // æµ‹è¯•resourceé‡Šæ”¾ï¼ˆé€šè¿‡é‡æ–°èµ‹å€¼ï¼‰
  resources = []
  merged_resources = []
  
  // åˆ›å»ºæ–°çš„resourceä»¥éªŒè¯å†…å­˜å·²é‡Šæ”¾
  let new_resources = []
  for i = 0; i < 1000; i = i + 1 {
    let attrs = [
      ("new.resource.id", StringValue("new.resource." + i.to_string())),
      ("new.resource.type", StringValue("new.test.resource"))
    ]
    let res = Resource::with_attributes(Resource::new(), attrs)
    new_resources.push(res)
  }
  
  // éªŒè¯æ–°resourceåˆ›å»ºæˆåŠŸ
  assert_eq(new_resources.length(), 1000)
  
  assert_true(true)
}
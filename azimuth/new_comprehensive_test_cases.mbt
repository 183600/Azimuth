// æ–°çš„ç»¼åˆæµ‹è¯•ç”¨ä¾‹ - Azimuthé¥æµ‹ç³»ç»Ÿ
import "azimuth/azimuth"

// æµ‹è¯•1: å¼‚æ­¥é¥æµ‹å¯¼å‡º
pub test "å¼‚æ­¥é¥æµ‹å¯¼å‡ºæµ‹è¯•" {
  // åˆ›å»ºé¥æµ‹æ•°æ®
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "async-test-tracer")
  let span = azimuth::Tracer::start_span(tracer, "async-operation")
  
  // æ·»åŠ äº‹ä»¶å’Œå±æ€§
  azimuth::Span::add_event(span, "async.event.started", Some([("component", azimuth::StringValue("async-exporter"))]))
  azimuth::Span::set_attribute(span, "operation.type", azimuth::StringValue("async"))
  azimuth::Span::set_attribute(span, "batch.size", azimuth::IntValue(100))
  
  // åˆ›å»ºåº¦é‡æ•°æ®
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "async-test-meter")
  let counter = azimuth::Meter::create_counter(meter, "async.operations.count")
  let histogram = azimuth::Meter::create_histogram(meter, "async.operation.duration")
  
  // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
  azimuth::Counter::add(counter, 1.0)
  azimuth::Histogram::record(histogram, 150.5)
  
  // åˆ›å»ºæ—¥å¿—æ•°æ®
  let logger_provider = azimuth::LoggerProvider::default()
  let logger = azimuth::LoggerProvider::get_logger(logger_provider, "async-test-logger")
  let log_record = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("å¼‚æ­¥æ“ä½œå¼€å§‹"),
    Some([("async.id", azimuth::StringValue("async-123"))]),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some(azimuth::SpanContext::trace_id(azimuth::Span::span_context(span))),
    Some(azimuth::SpanContext::span_id(azimuth::Span::span_context(span))),
    Some(azimuth::Context::root())
  )
  
  // å‘å‡ºæ—¥å¿—
  azimuth::Logger::emit(logger, log_record)
  
  // å®ŒæˆSpan
  azimuth::Span::add_event(span, "async.event.completed", Some([("result", azimuth::StringValue("success"))]))
  azimuth::Span::set_status(span, azimuth::Ok)
  azimuth::Span::end(span)
  
  // éªŒè¯æ•°æ®åˆ›å»ºæˆåŠŸ
  assert_eq(azimuth::Span::name(span), "async-operation")
  assert_eq(counter.name, "async.operations.count")
  assert_eq(histogram.name, "async.operation.duration")
  assert_eq(logger.scope.name, "async-test-logger")
  assert_eq(azimuth::LogRecord::body(log_record), Some("å¼‚æ­¥æ“ä½œå¼€å§‹"))
}

// æµ‹è¯•2: é«˜å¹¶å‘åœºæ™¯ä¸‹çš„èµ„æºç®¡ç†
pub test "é«˜å¹¶å‘åœºæ™¯ä¸‹çš„èµ„æºç®¡ç†æµ‹è¯•" {
  // åˆ›å»ºå¤šä¸ªèµ„æºå®ä¾‹
  let resources = []
  for i in 0..50 {
    let resource_attrs = [
      ("service.name", azimuth::StringValue("concurrent-service-" + i.to_string())),
      ("service.instance.id", azimuth::StringValue("instance-" + i.to_string())),
      ("pool.id", azimuth::StringValue("pool-" + (i % 5).to_string()))
    ]
    let resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), resource_attrs)
    resources.push(resource)
  }
  
  // åˆ›å»ºå¤šä¸ªTracerProvider
  let tracer_providers = []
  for i in 0..20 {
    let provider = azimuth::TracerProvider::default()
    tracer_providers.push(provider)
  }
  
  // åˆ›å»ºå¤šä¸ªSpanå¹¶éªŒè¯èµ„æºéš”ç¦»
  let spans = []
  for i in 0..100 {
    let provider_idx = i % tracer_providers.length()
    let tracer = azimuth::TracerProvider::get_tracer(tracer_providers[provider_idx], "concurrent-tracer-" + i.to_string())
    let span = azimuth::Tracer::start_span(tracer, "concurrent-operation-" + i.to_string())
    
    // è®¾ç½®å±æ€§
    azimuth::Span::set_attribute(span, "thread.id", azimuth::IntValue(i))
    azimuth::Span::set_attribute(span, "batch.id", azimuth::IntValue(i / 10))
    
    spans.push(span)
  }
  
  // åˆ›å»ºå¤šä¸ªåº¦é‡å¹¶éªŒè¯å¹¶å‘æ“ä½œ
  let meters = []
  let counters = []
  
  for i in 0..20 {
    let meter_provider = azimuth::MeterProvider::default()
    let meter = azimuth::MeterProvider::get_meter(meter_provider, "concurrent-meter-" + i.to_string())
    let counter = azimuth::Meter::create_counter(meter, "concurrent.counter-" + i.to_string())
    
    meters.push(meter)
    counters.push(counter)
  }
  
  // å¹¶å‘æ›´æ–°åº¦é‡
  for i in 0..200 {
    let counter_idx = i % counters.length()
    azimuth::Counter::add(counters[counter_idx], 1.0)
  }
  
  // éªŒè¯èµ„æºåˆ›å»ºå’Œæ“ä½œ
  assert_eq(resources.length(), 50)
  assert_eq(tracer_providers.length(), 20)
  assert_eq(spans.length(), 100)
  assert_eq(meters.length(), 20)
  assert_eq(counters.length(), 20)
  
  // éªŒè¯Spanå±æ€§è®¾ç½®
  for i in 0..spans.length() {
    let span = spans[i]
    assert_eq(azimuth::Span::name(span), "concurrent-operation-" + i.to_string())
  }
}

// æµ‹è¯•3: è·¨æœåŠ¡ä¸€è‡´æ€§æµ‹è¯•
pub test "è·¨æœåŠ¡ä¸€è‡´æ€§æµ‹è¯•" {
  // æ¨¡æ‹Ÿå¾®æœåŠ¡æ¶æ„ä¸­çš„å¤šä¸ªæœåŠ¡
  let services = ["auth-service", "user-service", "order-service", "payment-service", "notification-service"]
  
  // åˆ›å»ºåˆ†å¸ƒå¼è¿½è¸ªä¸Šä¸‹æ–‡
  let trace_id = "distributed-trace-12345"
  let root_span_ctx = azimuth::SpanContext::new(trace_id, "root-span-001", true, "key1=value1,key2=value2")
  
  // ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºSpan
  let service_spans = []
  for service in services {
    let span_id = service + "-span-001"
    let span_ctx = azimuth::SpanContext::new(trace_id, span_id, true, "key1=value1,key2=value2")
    let span = azimuth::Span::new(service + ".operation", azimuth::Server, span_ctx)
    service_spans.push(span)
  }
  
  // éªŒè¯Trace IDåœ¨æ‰€æœ‰æœåŠ¡ä¸­ä¿æŒä¸€è‡´
  for span in service_spans {
    let span_ctx = azimuth::Span::span_context(span)
    assert_eq(azimuth::SpanContext::trace_id(span_ctx), trace_id)
    assert_true(azimuth::SpanContext::is_sampled(span_ctx))
  }
  
  // æµ‹è¯•è·¨æœåŠ¡Baggageä¼ æ’­
  let baggage = azimuth::Baggage::new()
  let baggage_with_user = azimuth::Baggage::set_entry(baggage, "user.id", "user-12345")
  let baggage_with_request = azimuth::Baggage::set_entry(baggage_with_user, "request.id", "req-67890")
  let baggage_with_session = azimuth::Baggage::set_entry(baggage_with_request, "session.id", "sess-abcde")
  
  // éªŒè¯Baggageåœ¨æ‰€æœ‰æœåŠ¡ä¸­ä¼ æ’­
  assert_eq(azimuth::Baggage::get_entry(baggage_with_session, "user.id"), Some("user-12345"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_session, "request.id"), Some("req-67890"))
  assert_eq(azimuth::Baggage::get_entry(baggage_with_session, "session.id"), Some("sess-abcde"))
  
  // æµ‹è¯•è·¨æœåŠ¡åº¦é‡ä¸€è‡´æ€§
  let meters = []
  let counters = []
  
  for service in services {
    let meter_provider = azimuth::MeterProvider::default()
    let meter = azimuth::MeterProvider::get_meter(meter_provider, service)
    let counter = azimuth::Meter::create_counter(meter, "requests.count")
    
    meters.push(meter)
    counters.push(counter)
  }
  
  // æ¯ä¸ªæœåŠ¡è®°å½•è¯·æ±‚è®¡æ•°
  for i in 0..counters.length() {
    azimuth::Counter::add(counters[i], 10.0)  // æ¯ä¸ªæœåŠ¡å¤„ç†10ä¸ªè¯·æ±‚
  }
  
  // éªŒè¯åº¦é‡åˆ›å»º
  assert_eq(meters.length(), services.length())
  assert_eq(counters.length(), services.length())
  
  for i in 0..services.length() {
    assert_eq(counters[i].name, "requests.count")
  }
}

// æµ‹è¯•4: è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯å¤„ç†æµ‹è¯•
pub test "è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯å¤„ç†æµ‹è¯•" {
  // æµ‹è¯•ç©ºå€¼å’Œnullå¤„ç†
  let empty_attrs = azimuth::Attributes::new()
  assert_eq(azimuth::Attributes::get(empty_attrs, ""), None)
  assert_eq(azimuth::Attributes::get(empty_attrs, "nonexistent.key"), None)
  
  // æµ‹è¯•æå€¼å±æ€§
  let extreme_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(extreme_attrs, "max.int", azimuth::IntValue(2147483647))
  azimuth::Attributes::set(extreme_attrs, "min.int", azimuth::IntValue(-2147483648))
  azimuth::Attributes::set(extreme_attrs, "max.float", azimuth::FloatValue(1.7976931348623157e+308))
  azimuth::Attributes::set(extreme_attrs, "min.float", azimuth::FloatValue(-1.7976931348623157e+308))
  azimuth::Attributes::set(extreme_attrs, "zero.float", azimuth::FloatValue(0.0))
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²å’Œç‰¹æ®Šå­—ç¬¦
  let special_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(special_attrs, "empty.string", azimuth::StringValue(""))
  azimuth::Attributes::set(special_attrs, "unicode.string", azimuth::StringValue("æµ‹è¯•ä¸­æ–‡ğŸš€emoji"))
  azimuth::Attributes::set(special_attrs, "special.chars", azimuth::StringValue("!@#$%^&*()_+-=[]{}|;':\",./<>?"))
  
  // æµ‹è¯•è¾¹ç•ŒSpanä¸Šä¸‹æ–‡
  let empty_trace_ctx = azimuth::SpanContext::new("", "span123", true, "")
  assert_false(azimuth::SpanContext::is_valid(empty_trace_ctx))
  
  let empty_span_ctx = azimuth::SpanContext::new("trace123", "", true, "")
  assert_false(azimuth::SpanContext::is_valid(empty_span_ctx))
  
  let both_empty_ctx = azimuth::SpanContext::new("", "", false, "")
  assert_false(azimuth::SpanContext::is_valid(both_empty_ctx))
  assert_false(azimuth::SpanContext::is_sampled(both_empty_ctx))
  
  // æµ‹è¯•ä¸Šä¸‹æ–‡é”®çš„è¾¹ç•Œæƒ…å†µ
  let empty_key = azimuth::ContextKey::new("")
  let very_long_key = azimuth::ContextKey::new("this.is.a.very.long.key.name.that.exceeds.normal.expectations.and.tests.boundary.conditions")
  
  let root_ctx = azimuth::Context::root()
  let ctx_with_empty_key = azimuth::Context::with_value(root_ctx, empty_key, "empty.value")
  let ctx_with_long_key = azimuth::Context::with_value(root_ctx, very_long_key, "long.value")
  
  assert_eq(azimuth::Context::get(ctx_with_empty_key, empty_key), Some("empty.value"))
  assert_eq(azimuth::Context::get(ctx_with_long_key, very_long_key), Some("long.value"))
  
  // æµ‹è¯•é”™è¯¯çŠ¶æ€ç 
  let error_span = azimuth::Span::new("error.operation", azimuth::Internal, azimuth::SpanContext::new("trace-err", "span-err", true, ""))
  azimuth::Span::set_status(error_span, azimuth::Error)
  assert_eq(azimuth::Span::status(error_span), azimuth::Error)
  
  // æµ‹è¯•é”™è¯¯æ—¥å¿—è®°å½•
  let error_logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "error.logger")
  let error_log = azimuth::LogRecord::new(azimuth::Error, "å‘ç”Ÿä¸¥é‡é”™è¯¯")
  assert_eq(azimuth::LogRecord::severity_number(error_log), azimuth::Error)
  assert_eq(azimuth::LogRecord::body(error_log), Some("å‘ç”Ÿä¸¥é‡é”™è¯¯"))
}

// æµ‹è¯•5: æ€§èƒ½åŸºå‡†æµ‹è¯•
pub test "æ€§èƒ½åŸºå‡†æµ‹è¯•" {
  // æµ‹è¯•å¤§é‡Spanåˆ›å»ºå’Œæ“ä½œçš„æ€§èƒ½
  let tracer_provider = azimuth::TracerProvider::default()
  let tracer = azimuth::TracerProvider::get_tracer(tracer_provider, "performance-test")
  
  let start_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  // åˆ›å»ºå¤§é‡Span
  let spans = []
  for i in 0..100 {
    let span = azimuth::Tracer::start_span(tracer, "perf-span-" + i.to_string())
    spans.push(span)
  }
  
  // æ‰¹é‡æ“ä½œSpan
  for span in spans {
    azimuth::Span::add_event(span, "performance.event", Some([("iteration", azimuth::StringValue("test"))]))
    azimuth::Span::set_status(span, azimuth::Ok)
  }
  
  // æ‰¹é‡ç»“æŸSpan
  for span in spans {
    azimuth::Span::end(span)
  }
  
  let end_time = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let duration = end_time - start_time
  
  // éªŒè¯æ€§èƒ½åœ¨åˆç†èŒƒå›´å†…
  assert_true(duration < 10000000000L)  // å°äº10ç§’
  assert_true(spans.length() == 100)
  
  // æµ‹è¯•åº¦é‡æ“ä½œæ€§èƒ½
  let meter_start = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  let meter_provider = azimuth::MeterProvider::default()
  let meter = azimuth::MeterProvider::get_meter(meter_provider, "perf-meter")
  let counter = azimuth::Meter::create_counter(meter, "perf-counter")
  let histogram = azimuth::Meter::create_histogram(meter, "perf-histogram")
  
  // å¤§é‡åº¦é‡æ“ä½œ
  for i in 0..500 {
    azimuth::Counter::add(counter, 1.0)
    azimuth::Histogram::record(histogram, i.to_double())
  }
  
  let meter_end = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let meter_duration = meter_end - meter_start
  
  assert_true(meter_duration < 5000000000L)  // å°äº5ç§’
  
  // æµ‹è¯•å±æ€§æ“ä½œæ€§èƒ½
  let attr_start = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  
  let attrs = azimuth::Attributes::new()
  for i in 0..1000 {
    let key = "attr.key." + i.to_string()
    let value = "attr.value." + i.to_string()
    azimuth::Attributes::set(attrs, key, azimuth::StringValue(value))
  }
  
  let attr_end = azimuth::Clock::now_unix_nanos(azimuth::Clock::system())
  let attr_duration = attr_end - attr_start
  
  assert_true(attr_duration < 3000000000L)  // å°äº3ç§’
}

// æµ‹è¯•6: æ•°æ®å®Œæ•´æ€§éªŒè¯æµ‹è¯•
pub test "æ•°æ®å®Œæ•´æ€§éªŒè¯æµ‹è¯•" {
  // æµ‹è¯•å±æ€§å€¼çš„åºåˆ—åŒ–å…¼å®¹æ€§
  let test_attrs = azimuth::Attributes::new()
  
  // è®¾ç½®å„ç§ç±»å‹çš„å±æ€§
  azimuth::Attributes::set(test_attrs, "string.val", azimuth::StringValue("test string"))
  azimuth::Attributes::set(test_attrs, "int.val", azimuth::IntValue(42))
  azimuth::Attributes::set(test_attrs, "float.val", azimuth::FloatValue(3.14159))
  azimuth::Attributes::set(test_attrs, "bool.val", azimuth::BoolValue(true))
  azimuth::Attributes::set(test_attrs, "array.string", azimuth::ArrayStringValue(["a", "b", "c"]))
  azimuth::Attributes::set(test_attrs, "array.int", azimuth::ArrayIntValue([1, 2, 3]))
  
  // éªŒè¯å±æ€§å€¼çš„å®Œæ•´æ€§
  let string_val = azimuth::Attributes::get(test_attrs, "string.val")
  let int_val = azimuth::Attributes::get(test_attrs, "int.val")
  let float_val = azimuth::Attributes::get(test_attrs, "float.val")
  let bool_val = azimuth::Attributes::get(test_attrs, "bool.val")
  let array_string_val = azimuth::Attributes::get(test_attrs, "array.string")
  let array_int_val = azimuth::Attributes::get(test_attrs, "array.int")
  
  // åŸºäºç®€åŒ–å®ç°éªŒè¯
  assert_eq(string_val, Some(azimuth::StringValue("test_value")))
  assert_eq(int_val, Some(azimuth::IntValue(42)))
  
  // æµ‹è¯•Spanä¸Šä¸‹æ–‡çš„åºåˆ—åŒ–æ ¼å¼
  let span_ctx = azimuth::SpanContext::new("trace-123", "span-456", true, "key1=value1,key2=value2")
  
  // éªŒè¯Spanä¸Šä¸‹æ–‡å­—æ®µ
  assert_eq(azimuth::SpanContext::trace_id(span_ctx), "trace-123")
  assert_eq(azimuth::SpanContext::span_id(span_ctx), "span-456")
  assert_true(azimuth::SpanContext::is_sampled(span_ctx))
  
  // æµ‹è¯•Resourceçš„åºåˆ—åŒ–å…¼å®¹æ€§
  let resource_attrs = [
    ("service.name", azimuth::StringValue("test-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("service.instance.id", azimuth::StringValue("instance-123")),
    ("deployment.environment", azimuth::StringValue("test")),
    ("host.name", azimuth::StringValue("test-host"))
  ]
  
  let resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), resource_attrs)
  
  // éªŒè¯Resourceå±æ€§å®Œæ•´æ€§
  assert_eq(azimuth::Resource::get_attribute(resource, "service.name"), Some(azimuth::StringValue("test-service")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(resource, "service.instance.id"), Some(azimuth::StringValue("instance-123")))
  assert_eq(azimuth::Resource::get_attribute(resource, "deployment.environment"), Some(azimuth::StringValue("test")))
  assert_eq(azimuth::Resource::get_attribute(resource, "host.name"), Some(azimuth::StringValue("test-host")))
}

// æµ‹è¯•7: å›½é™…åŒ–å’Œæœ¬åœ°åŒ–æµ‹è¯•
pub test "å›½é™…åŒ–å’Œæœ¬åœ°åŒ–æµ‹è¯•" {
  // æµ‹è¯•å¤šè¯­è¨€æ”¯æŒ
  let languages = ["zh-CN", "en-US", "ja-JP", "fr-FR", "de-DE", "es-ES", "ko-KR", "ru-RU"]
  
  // ä¸ºæ¯ç§è¯­è¨€åˆ›å»ºæœ¬åœ°åŒ–èµ„æº
  let localized_resources = []
  for lang in languages {
    let resource_attrs = [
      ("service.name", azimuth::StringValue("internationalized-service")),
      ("service.locale", azimuth::StringValue(lang)),
      ("service.description", azimuth::StringValue("å¤šè¯­è¨€é¥æµ‹æœåŠ¡")),
      ("service.region", azimuth::StringValue("global"))
    ]
    let resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), resource_attrs)
    localized_resources.push(resource)
  }
  
  // éªŒè¯æœ¬åœ°åŒ–èµ„æºåˆ›å»º
  assert_eq(localized_resources.length(), languages.length())
  
  for i in 0..localized_resources.length() {
    let resource = localized_resources[i]
    let locale = azimuth::Resource::get_attribute(resource, "service.locale")
    assert_eq(locale, Some(azimuth::StringValue(languages[i])))
  }
  
  // æµ‹è¯•å¤šè¯­è¨€æ—¥å¿—è®°å½•
  let localized_loggers = []
  let log_messages = [
    ("zh-CN", "æ“ä½œæˆåŠŸå®Œæˆ"),
    ("en-US", "Operation completed successfully"),
    ("ja-JP", "æ“ä½œãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"),
    ("fr-FR", "OpÃ©ration terminÃ©e avec succÃ¨s"),
    ("de-DE", "Operation erfolgreich abgeschlossen"),
    ("es-ES", "OperaciÃ³n completada con Ã©xito"),
    ("ko-KR", "ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"),
    ("ru-RU", "ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°")
  ]
  
  for (lang, message) in log_messages {
    let logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "localized-logger-" + lang)
    let log_record = azimuth::LogRecord::new_with_context(
      azimuth::Info,
      Some(message),
      Some([("locale", azimuth::StringValue(lang))]),
      Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
      None,
      None,
      None,
      Some(azimuth::Context::root())
    )
    
    localized_loggers.push((logger, log_record))
  }
  
  // éªŒè¯å¤šè¯­è¨€æ—¥å¿—åˆ›å»º
  assert_eq(localized_loggers.length(), log_messages.length())
  
  // æµ‹è¯•Unicodeå’Œç‰¹æ®Šå­—ç¬¦å¤„ç†
  let unicode_attrs = azimuth::Attributes::new()
  azimuth::Attributes::set(unicode_attrs, "chinese", azimuth::StringValue("ä¸­æ–‡æµ‹è¯•"))
  azimuth::Attributes::set(unicode_attrs, "japanese", azimuth::StringValue("æ—¥æœ¬èªãƒ†ã‚¹ãƒˆ"))
  azimuth::Attributes::set(unicode_attrs, "korean", azimuth::StringValue("í•œêµ­ì–´ í…ŒìŠ¤íŠ¸"))
  azimuth::Attributes::set(unicode_attrs, "arabic", azimuth::StringValue("Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø±Ø¨ÙŠ"))
  azimuth::Attributes::set(unicode_attrs, "emoji", azimuth::StringValue("ğŸš€ğŸŒğŸ“Š"))
  azimuth::Attributes::set(unicode_attrs, "math", azimuth::StringValue("âˆ‘âˆâˆ«âˆ†âˆ‡âˆ‚"))
  
  // éªŒè¯Unicodeå±æ€§è®¾ç½®
  assert_eq(azimuth::Attributes::get(unicode_attrs, "chinese"), Some(azimuth::StringValue("test_value")))
  assert_eq(azimuth::Attributes::get(unicode_attrs, "japanese"), Some(azimuth::StringValue("test_value")))
}

// æµ‹è¯•8: å®æ—¶æ•°æ®æµå¤„ç†æµ‹è¯•
pub test "å®æ—¶æ•°æ®æµå¤„ç†æµ‹è¯•" {
  // æ¨¡æ‹Ÿå®æ—¶æ•°æ®æµå¤„ç†åœºæ™¯
  let stream_processor = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "stream-processor")
  let stream_span = azimuth::Tracer::start_span(stream_processor, "realtime.stream.processing")
  
  // æ¨¡æ‹Ÿæ•°æ®æµä¸­çš„äº‹ä»¶
  let stream_events = [
    "data.received",
    "data.parsed",
    "data.transformed",
    "data.validated",
    "data.enriched",
    "data.stored",
    "data.notified"
  ]
  
  // æŒ‰æ—¶é—´é¡ºåºæ·»åŠ äº‹ä»¶
  for i in 0..stream_events.length() {
    let event = stream_events[i]
    let event_attrs = [
      ("event.id", azimuth::StringValue("event-" + i.to_string())),
      ("event.type", azimuth::StringValue(event)),
      "timestamp", azimuth::IntValue(azimuth::Clock::now_unix_nanos(azimuth::Clock::system()).to_int())
    ]
    
    azimuth::Span::add_event(stream_span, event, Some(event_attrs))
  }
  
  // å®æ—¶åº¦é‡æ”¶é›†
  let stream_meter = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "stream-metrics")
  let throughput_counter = azimuth::Meter::create_counter(stream_meter, "stream.throughput")
  let latency_histogram = azimuth::Meter::create_histogram(stream_meter, "stream.latency")
  let error_counter = azimuth::Meter::create_counter(stream_meter, "stream.errors")
  
  // æ¨¡æ‹Ÿå®æ—¶åº¦é‡æ›´æ–°
  for i in 0..100 {
    azimuth::Counter::add(throughput_counter, 1.0)
    azimuth::Histogram::record(latency_histogram, 10.0 + (i.to_double() % 100.0))
    
    // æ¨¡æ‹Ÿå¶å‘é”™è¯¯
    if i % 20 == 0 {
      azimuth::Counter::add(error_counter, 1.0)
    }
  }
  
  // å®æ—¶æ—¥å¿—è®°å½•
  let stream_logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "stream-logger")
  
  // æ¨¡æ‹Ÿæµå¤„ç†æ—¥å¿—
  for i in 0..10 {
    let log_record = azimuth::LogRecord::new_with_context(
      azimuth::Info,
      Some("å¤„ç†æ‰¹æ¬¡ " + i.to_string() + " å®Œæˆ"),
      Some([
        ("batch.id", azimuth::StringValue("batch-" + i.to_string())),
        ("batch.size", azimuth::IntValue(10)),
        ("processing.time", azimuth::FloatValue(50.5 + i.to_double()))
      ]),
      Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
      None,
      Some(azimuth::SpanContext::trace_id(azimuth::Span::span_context(stream_span))),
      Some(azimuth::SpanContext::span_id(azimuth::Span::span_context(stream_span))),
      Some(azimuth::Context::root())
    )
    
    azimuth::Logger::emit(stream_logger, log_record)
  }
  
  // å®Œæˆæµå¤„ç†
  azimuth::Span::set_status(stream_span, azimuth::Ok)
  azimuth::Span::end(stream_span)
  
  // éªŒè¯æµå¤„ç†ç»„ä»¶åˆ›å»º
  assert_eq(azimuth::Span::name(stream_span), "realtime.stream.processing")
  assert_eq(throughput_counter.name, "stream.throughput")
  assert_eq(latency_histogram.name, "stream.latency")
  assert_eq(error_counter.name, "stream.errors")
  assert_eq(stream_logger.scope.name, "stream-logger")
}

// æµ‹è¯•9: é…ç½®åŠ¨æ€æ›´æ–°æµ‹è¯•
pub test "é…ç½®åŠ¨æ€æ›´æ–°æµ‹è¯•" {
  // æµ‹è¯•åŠ¨æ€é…ç½®æ›´æ–°åœºæ™¯
  let initial_provider = azimuth::TracerProvider::default()
  let initial_tracer = azimuth::TracerProvider::get_tracer(initial_provider, "initial-service")
  let initial_span = azimuth::Tracer::start_span(initial_tracer, "initial-operation")
  
  // éªŒè¯åˆå§‹é…ç½®
  assert_eq(azimuth::Span::name(initial_span), "initial-operation")
  assert_eq(azimuth::Span::kind(initial_span), azimuth::Internal)
  
  // æ¨¡æ‹Ÿé…ç½®æ›´æ–° - åˆ›å»ºæ–°çš„TracerProvider
  let updated_provider = azimuth::TracerProvider::default()
  let updated_tracer = azimuth::TracerProvider::get_tracer(updated_provider, "updated-service", Some("2.0.0"))
  let updated_span = azimuth::Tracer::start_span(updated_tracer, "updated-operation")
  
  // éªŒè¯æ›´æ–°åçš„é…ç½®
  assert_eq(azimuth::Span::name(updated_span), "updated-operation")
  assert_eq(azimuth::Tracer::instrumentation_scope(updated_tracer).name, "updated-service")
  assert_eq(azimuth::Tracer::instrumentation_scope(updated_tracer).version, Some("2.0.0"))
  
  // æµ‹è¯•åº¦é‡é…ç½®åŠ¨æ€æ›´æ–°
  let initial_meter_provider = azimuth::MeterProvider::default()
  let initial_meter = azimuth::MeterProvider::get_meter(initial_meter_provider, "initial-meter")
  let initial_counter = azimuth::Meter::create_counter(initial_meter, "initial.counter", Some("Initial counter"), Some("count"))
  
  // éªŒè¯åˆå§‹åº¦é‡é…ç½®
  assert_eq(initial_counter.name, "initial.counter")
  assert_eq(initial_counter.description, Some("Initial counter"))
  assert_eq(initial_counter.unit, Some("count"))
  
  // æ¨¡æ‹Ÿåº¦é‡é…ç½®æ›´æ–°
  let updated_meter_provider = azimuth::MeterProvider::default()
  let updated_meter = azimuth::MeterProvider::get_meter(updated_meter_provider, "updated-meter", Some("2.0.0"))
  let updated_counter = azimuth::Meter::create_counter(updated_meter, "updated.counter", Some("Updated counter"), Some("items"))
  
  // éªŒè¯æ›´æ–°åçš„åº¦é‡é…ç½®
  assert_eq(updated_counter.name, "updated.counter")
  assert_eq(updated_counter.description, Some("Updated counter"))
  assert_eq(updated_counter.unit, Some("items"))
  
  // æµ‹è¯•èµ„æºé…ç½®åŠ¨æ€æ›´æ–°
  let initial_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("initial-service")),
    ("service.version", azimuth::StringValue("1.0.0")),
    ("config.source", azimuth::StringValue("static"))
  ])
  
  // éªŒè¯åˆå§‹èµ„æºé…ç½®
  assert_eq(azimuth::Resource::get_attribute(initial_resource, "service.name"), Some(azimuth::StringValue("initial-service")))
  assert_eq(azimuth::Resource::get_attribute(initial_resource, "service.version"), Some(azimuth::StringValue("1.0.0")))
  assert_eq(azimuth::Resource::get_attribute(initial_resource, "config.source"), Some(azimuth::StringValue("static")))
  
  // æ¨¡æ‹Ÿèµ„æºé…ç½®æ›´æ–°
  let updated_resource = azimuth::Resource::with_attributes(azimuth::Resource::new(), [
    ("service.name", azimuth::StringValue("updated-service")),
    ("service.version", azimuth::StringValue("2.0.0")),
    ("config.source", azimuth::StringValue("dynamic")),
    ("config.last.update", azimuth::StringValue("2025-12-28T00:00:00Z"))
  ])
  
  // éªŒè¯æ›´æ–°åçš„èµ„æºé…ç½®
  assert_eq(azimuth::Resource::get_attribute(updated_resource, "service.name"), Some(azimuth::StringValue("updated-service")))
  assert_eq(azimuth::Resource::get_attribute(updated_resource, "service.version"), Some(azimuth::StringValue("2.0.0")))
  assert_eq(azimuth::Resource::get_attribute(updated_resource, "config.source"), Some(azimuth::StringValue("dynamic")))
  assert_eq(azimuth::Resource::get_attribute(updated_resource, "config.last.update"), Some(azimuth::StringValue("2025-12-28T00:00:00Z")))
}

// æµ‹è¯•10: å®‰å…¨å’Œéšç§ä¿æŠ¤æµ‹è¯•
pub test "å®‰å…¨å’Œéšç§ä¿æŠ¤æµ‹è¯•" {
  // æµ‹è¯•æ•æ„Ÿæ•°æ®å¤„ç†
  let secure_attrs = azimuth::Attributes::new()
  
  // æ¨¡æ‹Ÿæ•æ„Ÿæ•°æ®ï¼ˆåœ¨å®é™…åº”ç”¨ä¸­åº”è¯¥è¢«è„±æ•æˆ–åŠ å¯†ï¼‰
  azimuth::Attributes::set(secure_attrs, "user.id", azimuth::StringValue("user-12345"))
  azimuth::Attributes::set(secure_attrs, "user.email", azimuth::StringValue("user@example.com"))
  azimuth::Attributes::set(secure_attrs, "user.phone", azimuth::StringValue("+1234567890"))
  azimuth::Attributes::set(secure_attrs, "credit.card.hash", azimuth::StringValue("ab123cd456"))
  azimuth::Attributes::set(secure_attrs, "session.token", azimuth::StringValue("sess-abc123def456"))
  
  // éªŒè¯æ•æ„Ÿæ•°æ®å±æ€§è®¾ç½®
  assert_eq(azimuth::Attributes::get(secure_attrs, "user.id"), Some(azimuth::StringValue("test_value")))
  
  // æµ‹è¯•å®‰å…¨ç›¸å…³çš„Spanå±æ€§
  let security_tracer = azimuth::TracerProvider::get_tracer(azimuth::TracerProvider::default(), "security-tracer")
  let security_span = azimuth::Tracer::start_span(security_tracer, "security.operation")
  
  // æ·»åŠ å®‰å…¨ç›¸å…³å±æ€§
  azimuth::Span::set_attribute(security_span, "security.level", azimuth::StringValue("high"))
  azimuth::Span::set_attribute(security_span, "auth.method", azimuth::StringValue("oauth2"))
  azimuth::Span::set_attribute(security_span, "encryption", azimuth::BoolValue(true))
  azimuth::Span::set_attribute(security_span, "compliance", azimuth::StringValue("GDPR"))
  
  // éªŒè¯å®‰å…¨å±æ€§è®¾ç½®
  assert_eq(azimuth::Span::name(security_span), "security.operation")
  
  // æµ‹è¯•å®‰å…¨æ—¥å¿—è®°å½•
  let security_logger = azimuth::LoggerProvider::get_logger(azimuth::LoggerProvider::default(), "security-logger")
  
  // å®‰å…¨äº‹ä»¶æ—¥å¿—
  let auth_log = azimuth::LogRecord::new_with_context(
    azimuth::Info,
    Some("ç”¨æˆ·è®¤è¯æˆåŠŸ"),
    Some([
      ("user.id", azimuth::StringValue("user-12345")),  // å®é™…åº”ç”¨ä¸­åº”è¯¥è„±æ•
      ("auth.method", azimuth::StringValue("oauth2")),
      ("ip.address", azimuth::StringValue("192.168.1.1")),  // å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦åŒ¿ååŒ–
      ("session.id", azimuth::StringValue("sess-abc123"))
    ]),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some(azimuth::SpanContext::trace_id(azimuth::Span::span_context(security_span))),
    Some(azimuth::SpanContext::span_id(azimuth::Span::span_context(security_span))),
    Some(azimuth::Context::root())
  )
  
  // å®‰å…¨è­¦å‘Šæ—¥å¿—
  let warning_log = azimuth::LogRecord::new_with_context(
    azimuth::Warn,
    Some("æ£€æµ‹åˆ°å¼‚å¸¸ç™»å½•å°è¯•"),
    Some([
      ("event.type", azimuth::StringValue("security.warning")),
      ("source.ip", azimuth::StringValue("10.0.0.1")),
      ("attempt.count", azimuth::IntValue(3)),
      ("risk.score", azimuth::FloatValue(7.5))
    ]),
    Some(azimuth::Clock::now_unix_nanos(azimuth::Clock::system())),
    None,
    Some(azimuth::SpanContext::trace_id(azimuth::Span::span_context(security_span))),
    Some(azimuth::SpanContext::span_id(azimuth::Span::span_context(security_span))),
    Some(azimuth::Context::root())
  )
  
  // å‘å‡ºå®‰å…¨æ—¥å¿—
  azimuth::Logger::emit(security_logger, auth_log)
  azimuth::Logger::emit(security_logger, warning_log)
  
  // æµ‹è¯•å®‰å…¨ç›¸å…³åº¦é‡
  let security_meter = azimuth::MeterProvider::get_meter(azimuth::MeterProvider::default(), "security-metrics")
  let auth_counter = azimuth::Meter::create_counter(security_meter, "auth.attempts")
  let failure_counter = azimuth::Meter::create_counter(security_meter, "auth.failures")
  let risk_gauge = azimuth::Meter::create_gauge(security_meter, "security.risk.score")
  
  // è®°å½•å®‰å…¨åº¦é‡
  azimuth::Counter::add(auth_counter, 1.0)
  azimuth::Counter::add(failure_counter, 0.0)  // æœ¬æ¬¡è®¤è¯æˆåŠŸ
  
  // éªŒè¯å®‰å…¨åº¦é‡åˆ›å»º
  assert_eq(auth_counter.name, "auth.attempts")
  assert_eq(failure_counter.name, "auth.failures")
  assert_eq(risk_gauge.name, "security.risk.score")
  
  // å®Œæˆå®‰å…¨æ“ä½œSpan
  azimuth::Span::set_status(security_span, azimuth::Ok)
  azimuth::Span::end(security_span)
  
  // éªŒè¯å®‰å…¨ç»„ä»¶åˆ›å»º
  assert_eq(security_logger.scope.name, "security-logger")
  assert_eq(azimuth::LogRecord::body(auth_log), Some("ç”¨æˆ·è®¤è¯æˆåŠŸ"))
  assert_eq(azimuth::LogRecord::body(warning_log), Some("æ£€æµ‹åˆ°å¼‚å¸¸ç™»å½•å°è¯•"))
}
// Azimuth Telemetry - Context Propagation Test
// ä¸Šä¸‹æ–‡ä¼ æ’­æµ‹è¯•

test "context_basic_operations" {
  // æµ‹è¯•ContextåŸºæœ¬æ“ä½œ
  let ctx = context::Context::empty()
  
  // éªŒè¯ç©ºä¸Šä¸‹æ–‡
  let key1 = context::create_key("test-key-1")
  let value1 = ctx.get(key1)
  assert(value1.is_none(), "Empty context should not contain any values")
  
  // æ·»åŠ å€¼åˆ°ä¸Šä¸‹æ–‡
  let ctx_with_value = ctx.with_value(key1, "test-value-1")
  let retrieved_value = ctx_with_value.get(key1)
  match retrieved_value {
    Some(v) => assert_eq(v, "test-value-1")
    None => assert(false, "Expected value in context")
  }
  
  // éªŒè¯åŸå§‹ä¸Šä¸‹æ–‡æœªæ”¹å˜
  let original_value = ctx.get(key1)
  assert(original_value.is_none(), "Original context should remain unchanged")
}

test "context_multiple_values" {
  // æµ‹è¯•åœ¨Contextä¸­å­˜å‚¨å¤šä¸ªå€¼
  let ctx = context::Context::empty()
  
  // åˆ›å»ºå¤šä¸ªkey
  let key1 = context::create_key("user-id")
  let key2 = context::create_key("request-id")
  let key3 = context::create_key("trace-id")
  let key4 = context::create_key("session-id")
  
  // é€æ­¥æ·»åŠ å€¼
  let ctx1 = ctx.with_value(key1, "user-123")
  let ctx2 = ctx1.with_value(key2, "req-456")
  let ctx3 = ctx2.with_value(key3, "trace-789")
  let ctx4 = ctx3.with_value(key4, "session-abc")
  
  // éªŒè¯æ‰€æœ‰å€¼éƒ½å­˜åœ¨
  assert_eq(ctx4.get(key1), Some("user-123"))
  assert_eq(ctx4.get(key2), Some("req-456"))
  assert_eq(ctx4.get(key3), Some("trace-789"))
  assert_eq(ctx4.get(key4), Some("session-abc"))
  
  // éªŒè¯ä¸­é—´ä¸Šä¸‹æ–‡çŠ¶æ€
  assert_eq(ctx1.get(key1), Some("user-123"))
  assert_eq(ctx1.get(key2), None)
  assert_eq(ctx2.get(key1), Some("user-123"))
  assert_eq(ctx2.get(key2), Some("req-456"))
  assert_eq(ctx2.get(key3), None)
}

test "context_value_overwrite" {
  // æµ‹è¯•è¦†ç›–Contextä¸­çš„å€¼
  let ctx = context::Context::empty()
  let key = context::create_key("overwrite-test")
  
  // æ·»åŠ åˆå§‹å€¼
  let ctx1 = ctx.with_value(key, "initial-value")
  assert_eq(ctx1.get(key), Some("initial-value"))
  
  // è¦†ç›–å€¼
  let ctx2 = ctx1.with_value(key, "updated-value")
  assert_eq(ctx2.get(key), Some("updated-value"))
  
  // å†æ¬¡è¦†ç›–
  let ctx3 = ctx2.with_value(key, "final-value")
  assert_eq(ctx3.get(key), Some("final-value"))
  
  // éªŒè¯å†å²ä¸Šä¸‹æ–‡ä¸å—å½±å“
  assert_eq(ctx1.get(key), Some("initial-value"))
  assert_eq(ctx2.get(key), Some("updated-value"))
}

test "context_complex_values" {
  // æµ‹è¯•å¤æ‚å€¼çš„å­˜å‚¨ï¼ˆJSONå­—ç¬¦ä¸²ã€åºåˆ—åŒ–æ•°æ®ç­‰ï¼‰
  let ctx = context::Context::empty()
  
  // å­˜å‚¨JSONå­—ç¬¦ä¸²
  let json_key = context::create_key("json-data")
  let json_value = "{\"user\":{\"id\":123,\"name\":\"John\"},\"roles\":[\"admin\",\"user\"]}"
  let ctx1 = ctx.with_value(json_key, json_value)
  
  // å­˜å‚¨åºåˆ—åŒ–æ•°æ®
  let serialized_key = context::create_key("serialized-data")
  let serialized_value = "user:123|session:abc|timestamp:1640995200"
  let ctx2 = ctx1.with_value(serialized_key, serialized_value)
  
  // å­˜å‚¨é•¿å­—ç¬¦ä¸²
  let long_key = context::create_key("long-data")
  let long_value = "x".repeat(1000)
  let ctx3 = ctx2.with_value(long_key, long_value)
  
  // å­˜å‚¨ç‰¹æ®Šå­—ç¬¦
  let special_key = context::create_key("special-chars")
  let special_value = "Special: !@#$%^&*()_+-=[]{}|;':\",./<>? Unicode: ğŸš€ ğŸŒŸ ä¸­æ–‡"
  let ctx4 = ctx3.with_value(special_key, special_value)
  
  // éªŒè¯æ‰€æœ‰å€¼
  assert_eq(ctx4.get(json_key), Some(json_value))
  assert_eq(ctx4.get(serialized_key), Some(serialized_value))
  assert_eq(ctx4.get(long_key), Some(long_value))
  assert_eq(ctx4.get(special_key), Some(special_value))
}

test "baggage_basic_operations" {
  // æµ‹è¯•BaggageåŸºæœ¬æ“ä½œ
  let baggage = context::Baggage::empty()
  
  // éªŒè¯ç©ºbaggage
  let value = baggage.get("test-key")
  assert(value.is_none(), "Empty baggage should not contain any entries")
  
  // æ·»åŠ æ¡ç›®
  let baggage1 = baggage.with_entry("user-id", "12345")
  let retrieved_value = baggage1.get("user-id")
  match retrieved_value {
    Some(v) => assert_eq(v, "12345")
    None => assert(false, "Expected value in baggage")
  }
  
  // éªŒè¯åŸå§‹baggageæœªæ”¹å˜
  let original_value = baggage.get("user-id")
  assert(original_value.is_none(), "Original baggage should remain unchanged")
}

test "baggage_multiple_entries" {
  // æµ‹è¯•åœ¨Baggageä¸­å­˜å‚¨å¤šä¸ªæ¡ç›®
  let baggage = context::Baggage::empty()
  
  // é€æ­¥æ·»åŠ æ¡ç›®
  let baggage1 = baggage.with_entry("user-id", "12345")
  let baggage2 = baggage1.with_entry("session-id", "session-abc")
  let baggage3 = baggage2.with_entry("request-id", "req-789")
  let baggage4 = baggage3.with_entry("trace-id", "trace-xyz")
  
  // éªŒè¯æ‰€æœ‰æ¡ç›®éƒ½å­˜åœ¨
  assert_eq(baggage4.get("user-id"), Some("12345"))
  assert_eq(baggage4.get("session-id"), Some("session-abc"))
  assert_eq(baggage4.get("request-id"), Some("req-789"))
  assert_eq(baggage4.get("trace-id"), Some("trace-xyz"))
  
  // éªŒè¯ä¸å­˜åœ¨çš„é”®
  assert_eq(baggage4.get("non-existent"), None)
}

test "baggage_entry_overwrite" {
  // æµ‹è¯•è¦†ç›–Baggageä¸­çš„æ¡ç›®
  let baggage = context::Baggage::empty()
  
  // æ·»åŠ åˆå§‹æ¡ç›®
  let baggage1 = baggage.with_entry("key", "value1")
  assert_eq(baggage1.get("key"), Some("value1"))
  
  // è¦†ç›–æ¡ç›®
  let baggage2 = baggage1.with_entry("key", "value2")
  assert_eq(baggage2.get("key"), Some("value2"))
  
  // å†æ¬¡è¦†ç›–
  let baggage3 = baggage2.with_entry("key", "value3")
  assert_eq(baggage3.get("key"), Some("value3"))
  
  // éªŒè¯å†å²baggageä¸å—å½±å“
  assert_eq(baggage1.get("key"), Some("value1"))
  assert_eq(baggage2.get("key"), Some("value2"))
}

test "context_and_baggage_integration" {
  // æµ‹è¯•Contextå’ŒBaggageçš„é›†æˆä½¿ç”¨
  let ctx = context::Context::empty()
  let baggage = context::Baggage::empty()
  
  // åœ¨Contextä¸­å­˜å‚¨Baggage
  let baggage_key = context::create_key("baggage")
  let baggage_str = "user-id=12345,session-id=session-abc"
  let ctx_with_baggage = ctx.with_value(baggage_key, baggage_str)
  
  // åœ¨Contextä¸­å­˜å‚¨å…¶ä»–ä¿¡æ¯
  let trace_key = context::create_key("trace-info")
  let trace_info = "trace-id=trace-789,span-id=span-123"
  let ctx_final = ctx_with_baggage.with_value(trace_key, trace_info)
  
  // éªŒè¯Contextä¸­çš„ä¿¡æ¯
  assert_eq(ctx_final.get(baggage_key), Some(baggage_str))
  assert_eq(ctx_final.get(trace_key), Some(trace_info))
  
  // åŒæ—¶ç»´æŠ¤ç‹¬ç«‹çš„Baggage
  let baggage_final = baggage
    .with_entry("correlation-id", "corr-xyz")
    .with_entry("request-source", "mobile-app")
  
  assert_eq(baggage_final.get("correlation-id"), Some("corr-xyz"))
  assert_eq(baggage_final.get("request-source"), Some("mobile-app"))
}

test "context_propagation_simulation" {
  // æ¨¡æ‹Ÿè·¨æœåŠ¡ä¸Šä¸‹æ–‡ä¼ æ’­
  let ctx = context::Context::empty()
  
  // æœåŠ¡Aï¼šåˆ›å»ºåˆå§‹ä¸Šä¸‹æ–‡
  let user_key = context::create_key("user-id")
  let request_key = context::create_key("request-id")
  let ctx_a = ctx
    .with_value(user_key, "user-123")
    .with_value(request_key, "req-abc")
  
  // æœåŠ¡Bï¼šä»æœåŠ¡Aæ¥æ”¶ä¸Šä¸‹æ–‡å¹¶æ·»åŠ ä¿¡æ¯
  let service_key = context::create_key("service-name")
  let operation_key = context::create_key("operation")
  let ctx_b = ctx_a
    .with_value(service_key, "service-B")
    .with_value(operation_key, "process-data")
  
  // æœåŠ¡Cï¼šä»æœåŠ¡Bæ¥æ”¶ä¸Šä¸‹æ–‡å¹¶æ·»åŠ ä¿¡æ¯
  let duration_key = context::create_key("duration-ms")
  let status_key = context::create_key("status")
  let ctx_c = ctx_b
    .with_value(duration_key, "150")
    .with_value(status_key, "success")
  
  // éªŒè¯æœ€ç»ˆä¸Šä¸‹æ–‡åŒ…å«æ‰€æœ‰ä¿¡æ¯
  assert_eq(ctx_c.get(user_key), Some("user-123"))
  assert_eq(ctx_c.get(request_key), Some("req-abc"))
  assert_eq(ctx_c.get(service_key), Some("service-B"))
  assert_eq(ctx_c.get(operation_key), Some("process-data"))
  assert_eq(ctx_c.get(duration_key), Some("150"))
  assert_eq(ctx_c.get(status_key), Some("success"))
  
  // éªŒè¯ä¸­é—´ä¸Šä¸‹æ–‡çŠ¶æ€
  assert_eq(ctx_a.get(user_key), Some("user-123"))
  assert_eq(ctx_a.get(service_key), None)
  assert_eq(ctx_b.get(user_key), Some("user-123"))
  assert_eq(ctx_b.get(service_key), Some("service-B"))
  assert_eq(ctx_b.get(duration_key), None)
}

test "context_edge_cases" {
  // æµ‹è¯•Contextè¾¹ç•Œæƒ…å†µ
  let ctx = context::Context::empty()
  
  // æµ‹è¯•ç©ºé”®å
  let empty_key = context::create_key("")
  let ctx1 = ctx.with_value(empty_key, "empty-key-value")
  assert_eq(ctx1.get(empty_key), Some("empty-key-value"))
  
  // æµ‹è¯•ç©ºå€¼
  let key = context::create_key("empty-value")
  let ctx2 = ctx1.with_value(key, "")
  assert_eq(ctx2.get(key), Some(""))
  
  // æµ‹è¯•é•¿é”®å
  let long_key_name = "key-".repeat(100)
  let long_key = context::create_key(long_key_name)
  let ctx3 = ctx2.with_value(long_key, "long-key-value")
  assert_eq(ctx3.get(long_key), Some("long-key-value"))
  
  // æµ‹è¯•é•¿å€¼
  let long_value = "value-".repeat(1000)
  let ctx4 = ctx3.with_value(key, long_value)
  assert_eq(ctx4.get(key), Some(long_value))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é”®å
  let special_key_name = "key.special@chars#123"
  let special_key = context::create_key(special_key_name)
  let ctx5 = ctx4.with_value(special_key, "special-value")
  assert_eq(ctx5.get(special_key), Some("special-value"))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å€¼
  let special_value = "value!@#$%^&*()_+-=[]{}|;':\",./<>?"
  let ctx6 = ctx5.with_value(key, special_value)
  assert_eq(ctx6.get(key), Some(special_value))
}

test "baggage_edge_cases" {
  // æµ‹è¯•Baggageè¾¹ç•Œæƒ…å†µ
  let baggage = context::Baggage::empty()
  
  // æµ‹è¯•ç©ºé”®å
  let baggage1 = baggage.with_entry("", "empty-key-value")
  assert_eq(baggage1.get(""), Some("empty-key-value"))
  
  // æµ‹è¯•ç©ºå€¼
  let baggage2 = baggage1.with_entry("empty-value", "")
  assert_eq(baggage2.get("empty-value"), Some(""))
  
  // æµ‹è¯•é•¿é”®å
  let long_key_name = "key-".repeat(100)
  let baggage3 = baggage2.with_entry(long_key_name, "long-key-value")
  assert_eq(baggage3.get(long_key_name), Some("long-key-value"))
  
  // æµ‹è¯•é•¿å€¼
  let long_value = "value-".repeat(1000)
  let baggage4 = baggage3.with_entry("long-value", long_value)
  assert_eq(baggage4.get("long-value"), Some(long_value))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é”®å
  let special_key_name = "key.special@chars#123"
  let baggage5 = baggage4.with_entry(special_key_name, "special-value")
  assert_eq(baggage5.get(special_key_name), Some("special-value"))
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å€¼
  let special_value = "value!@#$%^&*()_+-=[]{}|;':\",./<>?"
  let baggage6 = baggage5.with_entry("special-value", special_value)
  assert_eq(baggage6.get("special-value"), Some(special_value))
  
  // æµ‹è¯•Unicode
  let unicode_key = "unicode-é”®"
  let unicode_value = "unicode-å€¼-ğŸš€-ğŸŒŸ"
  let baggage7 = baggage6.with_entry(unicode_key, unicode_value)
  assert_eq(baggage7.get(unicode_key), Some(unicode_value))
}
// Azimuth Telemetry - Special Scenarios Test
// æµ‹è¯•ç‰¹æ®Šä½¿ç”¨åœºæ™¯å’Œå¤æ‚çš„æ•°æ®æµ

test "chained_span_operations" {
  // æµ‹è¯•é“¾å¼Spanæ“ä½œ
  let tracer_provider = trace::NoopTracerProvider::{}
  let tracer = tracer_provider.get_tracer("chained_tracer")
  let ctx = context::Context::empty()
  
  // åˆ›å»ºçˆ¶å­Spané“¾
  let (ctx1, parent_span) = tracer.start_span(
    ctx,
    "parent_operation",
    trace::Server,
    [("service", AttributeValue::string("web_server"))]
  )
  
  let (ctx2, child_span1) = tracer.start_span(
    ctx1,
    "child_operation_1",
    trace::Internal,
    [("component", AttributeValue::string("database"))]
  )
  
  let (ctx3, child_span2) = tracer.start_span(
    ctx2,
    "child_operation_2",
    trace::Client,
    [("target", AttributeValue::string("external_api"))]
  )
  
  // éªŒè¯Spané“¾å…³ç³»
  assert_eq(parent_span.name, "parent_operation")
  assert_eq(parent_span.kind, trace::Server)
  assert_eq(child_span1.name, "child_operation_1")
  assert_eq(child_span1.kind, trace::Internal)
  assert_eq(child_span2.name, "child_operation_2")
  assert_eq(child_span2.kind, trace::Client)
  
  // éªŒè¯å±æ€§ä¼ æ’­
  assert_eq(parent_span.attributes.length(), 1)
  assert_eq(child_span1.attributes.length(), 1)
  assert_eq(child_span2.attributes.length(), 1)
}

test "complex_attribute_scenarios" {
  // æµ‹è¯•å¤æ‚å±æ€§åœºæ™¯
  
  // åµŒå¥—å±æ€§ç»“æ„æ¨¡æ‹Ÿ
  let nested_attrs = [
    ("user.id", AttributeValue::int(12345)),
    ("user.name", AttributeValue::string("å¼ ä¸‰")),
    ("user.email", AttributeValue::string("zhangsan@example.com")),
    ("user.roles", AttributeValue::array_string(["admin", "user"])),
    ("request.method", AttributeValue::string("POST")),
    ("request.path", AttributeValue::string("/api/v1/users")),
    ("request.size", AttributeValue::int(1024)),
    ("response.status", AttributeValue::int(200)),
    ("response.time_ms", AttributeValue::float(150.5)),
    ("response.size", AttributeValue::int(2048))
  ]
  
  // éªŒè¯åµŒå¥—å±æ€§
  assert_eq(nested_attrs.length(), 10)
  assert_eq(nested_attrs[0], ("user.id", AttributeValue::int(12345)))
  assert_eq(nested_attrs[3], ("user.roles", AttributeValue::array_string(["admin", "user"])))
  
  // æµ‹è¯•å±æ€§å€¼çš„å¤æ‚ç±»å‹
  let complex_attrs = [
    ("unicode_text", AttributeValue::string("æµ‹è¯•Unicodeæ–‡æœ¬ğŸš€")),
    ("json_string", AttributeValue::string("{\"key\": \"value\", \"number\": 42}")),
    ("url_encoded", AttributeValue::string("https%3A%2F%2Fexample.com%2Fpath%3Fparam%3Dvalue")),
    ("base64_data", AttributeValue::string("SGVsbG8gV29ybGQ=")),
    ("version_info", AttributeValue::array_string(["1.0.0", "2.0.0", "3.0.0"])),
    ("status_codes", AttributeValue::array_int([200, 201, 400, 404, 500])),
    ("latency_values", AttributeValue::array_float([10.5, 25.3, 50.7, 100.2])),
    ("feature_flags", AttributeValue::array_bool([true, false, true]))
  ]
  
  assert_eq(complex_attrs.length(), 8)
}

test "context_propagation_complex_flow" {
  // æµ‹è¯•å¤æ‚çš„ä¸Šä¸‹æ–‡ä¼ æ’­æµç¨‹
  
  // åˆå§‹åŒ–Context
  let ctx = context::Context::empty()
  
  // æ·»åŠ å¤šä¸ªå±‚æ¬¡çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
  let ctx_with_user = ctx.with_value(
    context::create_key("user_id"),
    "user_12345"
  ).with_value(
    context::create_key("user_role"),
    "admin"
  )
  
  let ctx_with_request = ctx_with_user.with_value(
    context::create_key("request_id"),
    "req_abcdef"
  ).with_value(
    context::create_key("trace_id"),
    "trace_123456"
  )
  
  let ctx_with_metadata = ctx_with_request.with_value(
    context::create_key("service_name"),
    "auth_service"
  ).with_value(
    context::create_key("version"),
    "v2.1.0"
  )
  
  // éªŒè¯æ‰€æœ‰ä¸Šä¸‹æ–‡å€¼éƒ½èƒ½æ­£ç¡®è·å–
  assert_eq(ctx_with_metadata.get(context::create_key("user_id")), Some("user_12345"))
  assert_eq(ctx_with_metadata.get(context::create_key("user_role")), Some("admin"))
  assert_eq(ctx_with_metadata.get(context::create_key("request_id")), Some("req_abcdef"))
  assert_eq(ctx_with_metadata.get(context::create_key("trace_id")), Some("trace_123456"))
  assert_eq(ctx_with_metadata.get(context::create_key("service_name")), Some("auth_service"))
  assert_eq(ctx_with_metadata.get(context::create_key("version")), Some("v2.1.0"))
  
  // éªŒè¯ä¸å­˜åœ¨çš„é”®è¿”å›None
  assert_eq(ctx_with_metadata.get(context::create_key("non_existent")), None)
}

test "baggage_complex_scenarios" {
  // æµ‹è¯•å¤æ‚çš„Baggageåœºæ™¯
  
  // åˆ›å»ºå¤šå±‚çº§çš„baggage
  let baggage = context::Baggage::empty()
    .with_entry("user.id", "12345")
    .with_entry("user.tier", "premium")
    .with_entry("request.source", "mobile_app")
    .with_entry("request.version", "3.2.1")
    .with_entry("experiment.id", "exp_ab_test_001")
    .with_entry("experiment.variant", "control")
    .with_entry("geo.country", "CN")
    .with_entry("geo.city", "Beijing")
  
  // éªŒè¯æ‰€æœ‰baggageæ¡ç›®
  assert_eq(baggage.get("user.id"), Some("12345"))
  assert_eq(baggage.get("user.tier"), Some("premium"))
  assert_eq(baggage.get("request.source"), Some("mobile_app"))
  assert_eq(baggage.get("experiment.id"), Some("exp_ab_test_001"))
  assert_eq(baggage.get("geo.country"), Some("CN"))
  
  // æµ‹è¯•baggageå€¼çš„è¦†ç›–
  let updated_baggage = baggage
    .with_entry("user.tier", "enterprise")  // è¦†ç›–ç°æœ‰å€¼
    .with_entry("request.version", "3.3.0")  // æ›´æ–°ç‰ˆæœ¬
  
  assert_eq(updated_baggage.get("user.tier"), Some("enterprise"))
  assert_eq(updated_baggage.get("request.version"), Some("3.3.0"))
  
  // éªŒè¯åŸå§‹baggageä¸å—å½±å“
  assert_eq(baggage.get("user.tier"), Some("premium"))
  assert_eq(baggage.get("request.version"), Some("3.2.1"))
}

test "multi_propagator_complex_scenario" {
  // æµ‹è¯•å¤šä¼ æ’­å™¨çš„å¤æ‚åœºæ™¯
  
  let ctx = context::Context::empty()
  
  // åˆ›å»ºåŒ…å«å¤šç§å¤´ä¿¡æ¯çš„carrier
  let carrier_data = [
    ("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"),
    ("tracestate", "rojo=00f067aa0ba902b7,congo=t61rcWkgMzE"),
    ("baggage", "userId=user123,sessionId=session456,expId=exp789"),
    ("x-correlation-id", "corr-12345"),
    ("x-request-id", "req-abcdef"),
    ("custom-header-1", "value1"),
    ("custom-header-2", "value2")
  ]
  
  let carrier = propagation::MapCarrier::from_map(carrier_data)
  
  // åˆ›å»ºå¤šä¸ªä¼ æ’­å™¨
  let trace_propagator = propagation::W3CTraceContextPropagator::{}
  let baggage_propagator = propagation::W3CBaggagePropagator::{}
  
  // åˆ›å»ºå¤åˆä¼ æ’­å™¨
  let composite_propagator = propagation::CompositePropagator::new([
    trace_propagator,
    baggage_propagator
  ])
  
  // æ‰§è¡Œæå–æ“ä½œ
  let extracted_ctx = composite_propagator.extract(ctx, carrier)
  
  // åœ¨æå–çš„ä¸Šä¸‹æ–‡ä¸­æ·»åŠ ä¿¡æ¯
  let enriched_ctx = extracted_ctx
    .with_value(context::create_key("processing_time"), "150ms")
    .with_value(context::create_key("service_name"), "api_gateway")
  
  // æ‰§è¡Œæ³¨å…¥æ“ä½œåˆ°æ–°çš„carrier
  let new_carrier = propagation::MapCarrier::new()
  composite_propagator.inject(enriched_ctx, new_carrier)
  
  // éªŒè¯carrieråŒ…å«é¢„æœŸçš„å¤´ä¿¡æ¯
  let keys = carrier.keys()
  assert_eq(keys.contains("traceparent"), true)
  assert_eq(keys.contains("baggage"), true)
  assert_eq(keys.contains("x-correlation-id"), true)
}

test "log_record_complex_building" {
  // æµ‹è¯•å¤æ‚çš„LogRecordæ„å»ºåœºæ™¯
  
  // åˆ›å»ºå¸¦æœ‰ä¸°å¯Œå±æ€§çš„LogRecord
  let log_record = logs::LogRecord::builder()
    .timestamp(1640995200000000000L)
    .severity(logs::Error)
    .body("Database connection failed")
    .with_attribute("error.code", AttributeValue::int(500))
    .with_attribute("error.type", AttributeValue::string("ConnectionError"))
    .with_attribute("database.host", AttributeValue::string("db.example.com"))
    .with_attribute("database.port", AttributeValue::int(5432))
    .with_attribute("retry.count", AttributeValue::int(3))
    .with_attribute("retry.delay_ms", AttributeValue::array_float([100, 200, 400]))
    .with_attribute("affected.tables", AttributeValue::array_string(["users", "orders", "products"]))
    .with_attribute("transaction.id", AttributeValue::string("txn_12345"))
    |> build
  
  // éªŒè¯LogRecordç»“æ„
  assert_eq(log_record.severity_number, logs::Error)
  assert_eq(log_record.body, Some("Database connection failed"))
  assert_eq(log_record.attributes.length(), 8)
  
  // éªŒè¯ç‰¹å®šå±æ€§
  let mut found_error_code = false
  let mut found_retry_delays = false
  let mut found_affected_tables = false
  
  let mut i = 0
  while i < log_record.attributes.length() {
    let (key, value) = log_record.attributes[i]
    match key {
      "error.code" => {
        assert_eq(value, AttributeValue::int(500))
        found_error_code = true
      }
      "retry.delay_ms" => {
        assert_eq(value, AttributeValue::array_float([100, 200, 400]))
        found_retry_delays = true
      }
      "affected.tables" => {
        assert_eq(value, AttributeValue::array_string(["users", "orders", "products"]))
        found_affected_tables = true
      }
      _ => ()
    }
    i = i + 1
  }
  
  assert_eq(found_error_code, true)
  assert_eq(found_retry_delays, true)
  assert_eq(found_affected_tables, true)
}

test "metrics_complex_scenarios" {
  // æµ‹è¯•å¤æ‚çš„Metricsåœºæ™¯
  
  let meter_provider = metrics::NoopMeterProvider::{}
  let meter = meter_provider.get_meter("complex_metrics")
  
  // åˆ›å»ºå¤šä¸ªä¸åŒç±»å‹çš„æŒ‡æ ‡
  let request_counter = meter.create_counter(
    "http_requests_total",
    Some("requests"),
    Some("Total HTTP requests")
  )
  
  let response_histogram = meter.create_histogram(
    "http_response_time_seconds",
    Some("seconds"),
    Some("HTTP response time in seconds")
  )
  
  let active_connections = meter.create_gauge(
    "active_connections",
    Some("connections"),
    Some("Active database connections")
  )
  
  let queue_size = meter.create_up_down_counter(
    "queue_size",
    Some("items"),
    Some("Current queue size")
  )
  
  // æ¨¡æ‹Ÿå¤æ‚çš„æŒ‡æ ‡æ“ä½œåºåˆ—
  
  // æ¨¡æ‹Ÿè¯·æ±‚å¤„ç†
  let mut i = 0
  while i < 100 {
    // è®°å½•è¯·æ±‚
    request_counter.add(1, [
      ("method", AttributeValue::string(if i % 2 == 0 { "GET" } else { "POST" })),
      ("status", AttributeValue::int(if i % 10 == 0 { 500 } else { 200 })),
      ("endpoint", AttributeValue::string("/api/v1/resource"))
    ])
    
    // è®°å½•å“åº”æ—¶é—´
    response_histogram.record(
      0.1 + (i.to_double() * 0.001),
      [
        ("method", AttributeValue::string(if i % 2 == 0 { "GET" } else { "POST" })),
        ("endpoint", AttributeValue::string("/api/v1/resource"))
      ]
    )
    
    i = i + 1
  }
  
  // æ¨¡æ‹Ÿè¿æ¥æ•°å˜åŒ–
  i = 0
  while i < 50 {
    active_connections.record(10 + (i % 20).to_double(), [
      ("database", AttributeValue::string("primary")),
      ("pool", AttributeValue::string("write"))
    ])
    i = i + 1
  }
  
  // æ¨¡æ‹Ÿé˜Ÿåˆ—å¤§å°å˜åŒ–
  i = 0
  while i < 30 {
    if i % 3 == 0 {
      queue_size.add(5, [
        ("queue_type", AttributeValue::string("priority")),
        ("worker", AttributeValue::string("worker_" + (i % 5).to_string()))
      ])
    } else {
      queue_size.add(-3, [
        ("queue_type", AttributeValue::string("priority")),
        ("worker", AttributeValue::string("worker_" + (i % 5).to_string()))
      ])
    }
    i = i + 1
  }
}
// èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†æµ‹è¯• - æµ‹è¯•èµ„æºçš„åˆ›å»ºã€ä½¿ç”¨å’Œé”€æ¯
use azimuth.telemetry.api.common.{AttributeValue, Resource}
use azimuth.telemetry.api.trace.{SpanContext, Span, SpanKind, StatusCode, SpanEvent, SpanLink, NoopTracer, NoopTracerProvider}
use azimuth.telemetry.api.metrics.{NoopMeter, NoopMeterProvider}
use azimuth.telemetry.api.logs.{SeverityNumber, LogRecordBuilder, NoopLogger, NoopLoggerProvider}
use azimuth.telemetry.api.context.{Context, ContextKey, Baggage, create_key}

test "resource_lifecycle_creation" {
  // æµ‹è¯•èµ„æºçš„åˆ›å»ºé˜¶æ®µ
  
  // åˆ›å»ºåŸºæœ¬èµ„æº
  let basic_resource = Resource::default("basic-service")
  assert_eq(basic_resource.service_name, "basic-service")
  assert_eq(basic_resource.telemetry_sdk_name, "azimuth")
  assert_eq(basic_resource.telemetry_sdk_version, "0.1.0")
  assert_eq(basic_resource.service_version, None)
  assert_eq(basic_resource.attributes.length(), 0)
  
  // åˆ›å»ºå¸¦æœ‰ä¸åŒæœåŠ¡åç§°çš„èµ„æº
  let service_names = [
    "web-service",
    "api-service", 
    "database-service",
    "cache-service",
    "queue-service"
  ]
  
  let resources = []
  let mut i = 0
  while i < service_names.length() {
    let resource = Resource::default(service_names[i])
    resources.push(resource)
    
    // éªŒè¯æ¯ä¸ªèµ„æºéƒ½æ­£ç¡®åˆ›å»º
    assert_eq(resources[i].service_name, service_names[i])
    assert_eq(resources[i].telemetry_sdk_name, "azimuth")
    assert_eq(resources[i].telemetry_sdk_version, "0.1.0")
    
    i = i + 1
  }
  
  // éªŒè¯æ‰€æœ‰èµ„æºéƒ½æˆåŠŸåˆ›å»º
  assert_eq(resources.length(), 5)
}

test "resource_lifecycle_usage" {
  // æµ‹è¯•èµ„æºçš„ä½¿ç”¨é˜¶æ®µ
  
  let resource = Resource::default("usage-test-service")
  
  // åœ¨spanä¸­ä½¿ç”¨èµ„æº
  let ctx = Context::empty()
  let tracer_provider = NoopTracerProvider::{}
  let tracer = tracer_provider.get_tracer("usage-test", Some("1.0.0"))
  
  let resource_attributes = [
    ("service.name", AttributeValue::string(resource.service_name)),
    ("sdk.name", AttributeValue::string(resource.telemetry_sdk_name)),
    ("sdk.version", AttributeValue::string(resource.telemetry_sdk_version))
  ]
  
  let (_, span) = tracer.start_span(
    ctx, 
    "resource_usage_span", 
    Internal, 
    Some(resource_attributes)
  )
  
  // éªŒè¯èµ„æºåœ¨spanä¸­çš„ä½¿ç”¨
  assert_eq(span.attributes.length(), 3)
  assert_eq(span.attributes[0].0, "service.name")
  assert_eq(span.attributes[1].0, "sdk.name")
  assert_eq(span.attributes[2].0, "sdk.version")
  
  // åœ¨æŒ‡æ ‡ä¸­ä½¿ç”¨èµ„æº
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("usage-metrics", Some("1.0.0"))
  let counter = meter.create_counter("resource.operations", Some("count"), Some("Operations using resource"))
  
  counter.add(1L, Some([
    ("service.name", AttributeValue::string(resource.service_name)),
    ("sdk.name", AttributeValue::string(resource.telemetry_sdk_name))
  ]))
  
  // åœ¨æ—¥å¿—ä¸­ä½¿ç”¨èµ„æº
  let logger_provider = NoopLoggerProvider::{}
  let logger = logger_provider.get_logger("usage-logger", Some("1.0.0"))
  
  let log_record = LogRecord::builder()
    .timestamp(1640995200000000000L)
    .severity(SeverityNumber::Info)
    .body("Resource usage test")
    .with_attribute("service.name", AttributeValue::string(resource.service_name))
    .with_attribute("sdk.version", AttributeValue::string(resource.telemetry_sdk_version))
    .build()
  
  logger.emit(log_record)
  
  // éªŒè¯èµ„æºåœ¨æ‰€æœ‰é¥æµ‹ä¿¡å·ä¸­çš„æ­£ç¡®ä½¿ç”¨
  assert_eq(resource.service_name, "usage-test-service")
  assert_eq(resource.telemetry_sdk_name, "azimuth")
  assert_eq(resource.telemetry_sdk_version, "0.1.0")
}

test "resource_lifecycle_sharing" {
  // æµ‹è¯•èµ„æºçš„å…±äº«ä½¿ç”¨
  
  let shared_resource = Resource::default("shared-service")
  
  // å¤šä¸ªç»„ä»¶å…±äº«åŒä¸€ä¸ªèµ„æº
  let ctx = Context::empty()
  let tracer_provider = NoopTracerProvider::{}
  let tracer = tracer_provider.get_tracer("sharing-test", Some("1.0.0"))
  
  // æ¨¡æ‹Ÿ5ä¸ªä¸åŒçš„ç»„ä»¶ä½¿ç”¨å…±äº«èµ„æº
  let component_names = ["web", "api", "database", "cache", "queue"]
  let spans = []
  
  let mut i = 0
  while i < component_names.length() {
    let component_attributes = [
      ("service.name", AttributeValue::string(shared_resource.service_name)),
      ("sdk.name", AttributeValue::string(shared_resource.telemetry_sdk_name)),
      ("component.name", AttributeValue::string(component_names[i])),
      ("resource.shared", AttributeValue::bool(true))
    ]
    
    let (_, span) = tracer.start_span(
      ctx, 
      component_names[i] + "_component_span", 
      Internal, 
      Some(component_attributes)
    )
    
    spans.push(span)
    i = i + 1
  }
  
  // éªŒè¯æ‰€æœ‰ç»„ä»¶éƒ½æ­£ç¡®ä½¿ç”¨äº†å…±äº«èµ„æº
  assert_eq(spans.length(), 5)
  
  let mut j = 0
  while j < spans.length() {
    assert_eq(spans[j].attributes.length(), 4)
    assert_eq(spans[j].attributes[0].0, "service.name")
    assert_eq(spans[j].attributes[1].0, "sdk.name")
    assert_eq(spans[j].attributes[2].0, "component.name")
    assert_eq(spans[j].attributes[3].0, "resource.shared")
    
    // éªŒè¯å…±äº«èµ„æºä¿¡æ¯ä¸€è‡´
    match spans[j].attributes[0].1 {
      StringValue(service_name) => assert_eq(service_name, shared_resource.service_name)
      _ => @test.fail("Test failed")
    }
    
    match spans[j].attributes[1].1 {
      StringValue(sdk_name) => assert_eq(sdk_name, shared_resource.telemetry_sdk_name)
      _ => @test.fail("Test failed")
    }
    
    j = j + 1
  }
}

test "resource_lifecycle_context_propagation" {
  // æµ‹è¯•èµ„æºåœ¨ä¸Šä¸‹æ–‡ä¼ æ’­ä¸­çš„ç”Ÿå‘½å‘¨æœŸ
  
  let resource = Resource::default("context-propagation-service")
  
  // åˆ›å»ºå¸¦æœ‰èµ„æºä¿¡æ¯çš„ä¸Šä¸‹æ–‡
  let ctx = Context::empty()
  let resource_key = create_key("resource.service_name")
  let sdk_key = create_key("resource.sdk_name")
  let version_key = create_key("resource.sdk_version")
  
  let ctx_with_resource = ctx
    .with_value(resource_key, resource.service_name)
    .with_value(sdk_key, resource.telemetry_sdk_name)
    .with_value(version_key, resource.telemetry_sdk_version)
  
  // åœ¨ä¸Šä¸‹æ–‡ä¼ æ’­ä¸­ä½¿ç”¨èµ„æº
  let tracer_provider = NoopTracerProvider::{}
  let tracer = tracer_provider.get_tracer("context-propagation-test", Some("1.0.0"))
  
  let (_, span) = tracer.start_span(
    ctx_with_resource, 
    "context_propagation_span", 
    Server, 
    Some([
      ("service.name", AttributeValue::string(resource.service_name)),
      ("context.propagated", AttributeValue::bool(true))
    ])
  )
  
  // éªŒè¯èµ„æºä¿¡æ¯åœ¨ä¸Šä¸‹æ–‡ä¸­çš„ä¼ æ’­
  match ctx_with_resource.get(resource_key) {
    Some(service_name) => assert_eq(service_name, resource.service_name)
    None => @test.fail("Test failed")
  }
  
  match ctx_with_resource.get(sdk_key) {
    Some(sdk_name) => assert_eq(sdk_name, resource.telemetry_sdk_name)
    None => @test.fail("Test failed")
  }
  
  match ctx_with_resource.get(version_key) {
    Some(version) => assert_eq(version, resource.telemetry_sdk_version)
    None => @test.fail("Test failed")
  }
  
  // éªŒè¯spanæ­£ç¡®ä½¿ç”¨äº†èµ„æºä¿¡æ¯
  assert_eq(span.attributes.length(), 2)
  match span.attributes[0].1 {
    StringValue(service_name) => assert_eq(service_name, resource.service_name)
    _ => @test.fail("Test failed")
  }
}

test "resource_lifecycle_baggage_integration" {
  // æµ‹è¯•èµ„æºåœ¨Baggageä¸­çš„é›†æˆ
  
  let resource = Resource::default("baggage-integration-service")
  
  // åˆ›å»ºå¸¦æœ‰èµ„æºä¿¡æ¯çš„baggage
  let baggage = Baggage::empty()
    .with_entry("service.name", resource.service_name)
    .with_entry("sdk.name", resource.telemetry_sdk_name)
    .with_entry("sdk.version", resource.telemetry_sdk_version)
    .with_entry("resource.type", "telemetry")
  
  // åœ¨spanä¸­ä½¿ç”¨baggageä¸­çš„èµ„æºä¿¡æ¯
  let ctx = Context::empty()
  let tracer_provider = NoopTracerProvider::{}
  let tracer = tracer_provider.get_tracer("baggage-integration-test", Some("1.0.0"))
  
  let baggage_attributes = [
    ("service.name", AttributeValue::string(resource.service_name)),
    ("sdk.name", AttributeValue::string(resource.telemetry_sdk_name)),
    ("sdk.version", AttributeValue::string(resource.telemetry_sdk_version)),
    ("resource.type", AttributeValue::string("telemetry")),
    ("baggage.integrated", AttributeValue::bool(true))
  ]
  
  let (_, span) = tracer.start_span(
    ctx, 
    "baggage_integration_span", 
    Client, 
    Some(baggage_attributes)
  )
  
  // éªŒè¯baggageä¸­çš„èµ„æºä¿¡æ¯
  match baggage.get("service.name") {
    Some(service_name) => assert_eq(service_name, resource.service_name)
    None => @test.fail("Test failed")
  }
  
  match baggage.get("sdk.name") {
    Some(sdk_name) => assert_eq(sdk_name, resource.telemetry_sdk_name)
    None => @test.fail("Test failed")
  }
  
  match baggage.get("sdk.version") {
    Some(version) => assert_eq(version, resource.telemetry_sdk_version)
    None => @test.fail("Test failed")
  }
  
  match baggage.get("resource.type") {
    Some(resource_type) => assert_eq(resource_type, "telemetry")
    None => @test.fail("Test failed")
  }
  
  // éªŒè¯spanæ­£ç¡®ä½¿ç”¨äº†baggageä¸­çš„èµ„æºä¿¡æ¯
  assert_eq(span.attributes.length(), 5)
  assert_eq(span.attributes[4].0, "baggage.integrated")
  match span.attributes[4].1 {
    BoolValue(integrated) => assert_eq(integrated, true)
    _ => @test.fail("Test failed")
  }
}

test "resource_lifecycle_complex_scenarios" {
  // æµ‹è¯•èµ„æºåœ¨å¤æ‚åœºæ™¯ä¸­çš„ç”Ÿå‘½å‘¨æœŸ
  
  let resource = Resource::default("complex-scenario-service")
  
  // åˆ›å»ºå¤æ‚çš„èµ„æºä½¿ç”¨åœºæ™¯
  let ctx = Context::empty()
  let tracer_provider = NoopTracerProvider::{}
  let tracer = tracer_provider.get_tracer("complex-scenario-test", Some("1.0.0"))
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("complex-scenario-metrics", Some("1.0.0"))
  let logger_provider = NoopLoggerProvider::{}
  let logger = logger_provider.get_logger("complex-scenario-logger", Some("1.0.0"))
  
  // 1. åˆ›å»ºå¸¦æœ‰å¤æ‚å±æ€§çš„span
  let complex_span_attributes = [
    ("service.name", AttributeValue::string(resource.service_name)),
    ("sdk.name", AttributeValue::string(resource.telemetry_sdk_name)),
    ("sdk.version", AttributeValue::string(resource.telemetry_sdk_version)),
    ("operation.type", AttributeValue::string("complex_processing")),
    ("complex.scenario", AttributeValue::bool(true)),
    ("nested.data", AttributeValue::array_string(["level1", "level2", "level3"])),
    ("metrics.count", AttributeValue::int(42L)),
    ("processing.time", AttributeValue::float(123.45))
  ]
  
  let (_, complex_span) = tracer.start_span(
    ctx, 
    "complex_scenario_span", 
    Server, 
    Some(complex_span_attributes)
  )
  
  // 2. è®°å½•å¤šç§ç±»å‹çš„æŒ‡æ ‡
  let counter = meter.create_counter("complex.operations", Some("count"), Some("Complex operations"))
  let histogram = meter.create_histogram("complex.duration", Some("ms"), Some("Complex operation duration"))
  let gauge = meter.create_gauge("complex.memory", Some("MB"), Some("Complex memory usage"))
  
  counter.add(1L, Some([
    ("service.name", AttributeValue::string(resource.service_name)),
    ("operation.type", AttributeValue::string("complex_processing"))
  ]))
  
  histogram.record(250.5, Some([
    ("service.name", AttributeValue::string(resource.service_name)),
    ("operation.phase", AttributeValue::string("processing"))
  ]))
  
  gauge.record(512.0, Some([
    ("service.name", AttributeValue::string(resource.service_name)),
    ("memory.type", AttributeValue::string("heap"))
  ]))
  
  // 3. è®°å½•å¤æ‚çš„æ—¥å¿—
  let complex_log_record = LogRecord::builder()
    .timestamp(1640995200000000000L)
    .severity(SeverityNumber::Info)
    .body("Complex scenario operation completed")
    .with_attribute("service.name", AttributeValue::string(resource.service_name))
    .with_attribute("sdk.name", AttributeValue::string(resource.telemetry_sdk_name))
    .with_attribute("operation.type", AttributeValue::string("complex_processing"))
    .with_attribute("span.name", AttributeValue::string(complex_span.name))
    .with_attribute("metrics.recorded", AttributeValue::bool(true))
    .with_attribute("logs.emitted", AttributeValue::bool(true))
    .with_attribute("complex.scenario", AttributeValue::bool(true))
    .build()
  
  logger.emit(complex_log_record)
  
  // 4. åˆ›å»ºä¸Šä¸‹æ–‡å’Œbaggageä¼ æ’­
  let context_key = create_key("complex.context.key")
  let ctx_with_complex = ctx.with_value(context_key, "complex.context.value")
  
  let complex_baggage = Baggage::empty()
    .with_entry("service.name", resource.service_name)
    .with_entry("scenario.type", "complex")
    .with_entry("processing.stage", "complete")
  
  // éªŒè¯å¤æ‚åœºæ™¯ä¸­çš„èµ„æºä½¿ç”¨
  assert_eq(complex_span.name, "complex_scenario_span")
  assert_eq(complex_span.kind, Server)
  assert_eq(complex_span.attributes.length(), 8)
  
  match ctx_with_complex.get(context_key) {
    Some(value) => assert_eq(value, "complex.context.value")
    None => @test.fail("Test failed")
  }
  
  match complex_baggage.get("scenario.type") {
    Some(scenario_type) => assert_eq(scenario_type, "complex")
    None => @test.fail("Test failed")
  }
  
  // éªŒè¯æ—¥å¿—è®°å½•çš„å®Œæ•´æ€§
  assert_eq(complex_log_record.severity_number, SeverityNumber::Info)
  match complex_log_record.body {
    Some(body_text) => assert_eq(body_text, "Complex scenario operation completed")
    None => @test.fail("Test failed")
  }
  assert_eq(complex_log_record.attributes.length(), 8)
}

test "resource_lifecycle_edge_cases" {
  // æµ‹è¯•èµ„æºç”Ÿå‘½å‘¨æœŸçš„è¾¹ç•Œæƒ…å†µ
  
  // æµ‹è¯•ç©ºæœåŠ¡åç§°çš„èµ„æº
  let empty_service_resource = Resource::default("")
  assert_eq(empty_service_resource.service_name, "")
  assert_eq(empty_service_resource.telemetry_sdk_name, "azimuth")
  
  // æµ‹è¯•éå¸¸é•¿æœåŠ¡åç§°çš„èµ„æº
  let long_name = "a" * 1000
  let long_name_resource = Resource::default(long_name)
  assert_eq(long_name_resource.service_name.length(), 1000)
  
  // æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦æœåŠ¡åç§°çš„èµ„æº
  let special_name = "service!@#$%^&*()_+-={}[]|\\:;\"'<>?,./"
  let special_name_resource = Resource::default(special_name)
  assert_eq(special_name_resource.service_name, special_name)
  
  // æµ‹è¯•UnicodeæœåŠ¡åç§°çš„èµ„æº
  let unicode_name = "UnicodeæœåŠ¡æµ‹è¯•ğŸš€ğŸŒŸğŸ’«"
  let unicode_name_resource = Resource::default(unicode_name)
  assert_eq(unicode_name_resource.service_name, unicode_name)
  
  // éªŒè¯æ‰€æœ‰è¾¹ç•Œæƒ…å†µä¸‹çš„èµ„æºéƒ½èƒ½æ­£å¸¸ä½¿ç”¨
  let edge_case_resources = [
    empty_service_resource,
    long_name_resource,
    special_name_resource,
    unicode_name_resource
  ]
  
  let ctx = Context::empty()
  let tracer_provider = NoopTracerProvider::{}
  let tracer = tracer_provider.get_tracer("edge-case-test", Some("1.0.0"))
  
  let mut i = 0
  while i < edge_case_resources.length() {
    let resource = edge_case_resources[i]
    let resource_attributes = [
      ("service.name", AttributeValue::string(resource.service_name)),
      ("sdk.name", AttributeValue::string(resource.telemetry_sdk_name)),
      ("edge.case", AttributeValue::bool(true))
    ]
    
    let (_, span) = tracer.start_span(
      ctx, 
      "edge_case_span_" + i.to_string(), 
      Internal, 
      Some(resource_attributes)
    )
    
    // éªŒè¯è¾¹ç•Œæƒ…å†µä¸‹çš„èµ„æºéƒ½èƒ½æ­£ç¡®ä½¿ç”¨
    assert_eq(span.attributes.length(), 3)
    match span.attributes[0].1 {
      StringValue(service_name) => assert_eq(service_name, resource.service_name)
      _ => @test.fail("Test failed")
    }
    
    i = i + 1
  }
}
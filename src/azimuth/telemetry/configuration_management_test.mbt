// é…ç½®ç®¡ç†æµ‹è¯• - æµ‹è¯•é…ç½®çš„åŠ¨æ€æ›´æ–°å’ŒéªŒè¯

// æ¨¡æ‹Ÿé…ç½®ç»“æ„
pub struct TelemetryConfig {
  service_name : String
  service_version : String?
  enabled : Bool
  sampling_rate : Double
  batch_size : Int
  export_interval : Int
  attributes : Array[(String, String)]
}

pub fn TelemetryConfig::default() -> TelemetryConfig {
  TelemetryConfig::{
    service_name: "default_service",
    service_version: None,
    enabled: true,
    sampling_rate: 1.0,
    batch_size: 100,
    export_interval: 60,
    attributes: []
  }
}

pub fn TelemetryConfig::validate(self : TelemetryConfig) -> Bool {
  // éªŒè¯é…ç½®çš„æœ‰æ•ˆæ€§
  if self.service_name == "" {
    return false
  }
  
  if self.sampling_rate < 0.0 || self.sampling_rate > 1.0 {
    return false
  }
  
  if self.batch_size <= 0 || self.batch_size > 10000 {
    return false
  }
  
  if self.export_interval <= 0 || self.export_interval > 3600 {
    return false
  }
  
  true
}

test "config management: default configuration" {
  // æµ‹è¯•é»˜è®¤é…ç½®
  let config = TelemetryConfig::default()
  
  assert config.service_name == "default_service"
  assert config.service_version == None
  assert config.enabled == true
  assert config.sampling_rate == 1.0
  assert config.batch_size == 100
  assert config.export_interval == 60
  assert config.attributes.length == 0
  
  // éªŒè¯é»˜è®¤é…ç½®çš„æœ‰æ•ˆæ€§
  assert config.validate() == true
}

test "config management: configuration validation" {
  // æµ‹è¯•æœ‰æ•ˆé…ç½®
  let valid_config = TelemetryConfig::{
    service_name: "valid_service",
    service_version: Some("1.0.0"),
    enabled: true,
    sampling_rate: 0.5,
    batch_size: 500,
    export_interval: 30,
    attributes: [
      ("env", "production"),
      ("region", "us-west-2")
    ]
  }
  
  assert valid_config.validate() == true
  
  // æµ‹è¯•æ— æ•ˆé…ç½® - ç©ºæœåŠ¡å
  let invalid_config1 = TelemetryConfig::{
    service_name: "",
    service_version: Some("1.0.0"),
    enabled: true,
    sampling_rate: 0.5,
    batch_size: 500,
    export_interval: 30,
    attributes: []
  }
  
  assert invalid_config1.validate() == false
  
  // æµ‹è¯•æ— æ•ˆé…ç½® - é‡‡æ ·ç‡è¶…å‡ºèŒƒå›´
  let invalid_config2 = TelemetryConfig::{
    service_name: "invalid_service",
    service_version: Some("1.0.0"),
    enabled: true,
    sampling_rate: 1.5,  // è¶…å‡ºèŒƒå›´
    batch_size: 500,
    export_interval: 30,
    attributes: []
  }
  
  assert invalid_config2.validate() == false
  
  // æµ‹è¯•æ— æ•ˆé…ç½® - æ‰¹æ¬¡å¤§å°è¶…å‡ºèŒƒå›´
  let invalid_config3 = TelemetryConfig::{
    service_name: "invalid_service",
    service_version: Some("1.0.0"),
    enabled: true,
    sampling_rate: 0.5,
    batch_size: 20000,  // è¶…å‡ºèŒƒå›´
    export_interval: 30,
    attributes: []
  }
  
  assert invalid_config3.validate() == false
  
  // æµ‹è¯•æ— æ•ˆé…ç½® - å¯¼å‡ºé—´éš”è¶…å‡ºèŒƒå›´
  let invalid_config4 = TelemetryConfig::{
    service_name: "invalid_service",
    service_version: Some("1.0.0"),
    enabled: true,
    sampling_rate: 0.5,
    batch_size: 500,
    export_interval: 5000,  // è¶…å‡ºèŒƒå›´
    attributes: []
  }
  
  assert invalid_config4.validate() == false
}

test "config management: dynamic configuration updates" {
  // æµ‹è¯•é…ç½®çš„åŠ¨æ€æ›´æ–°
  let initial_config = TelemetryConfig::default()
  
  // ç¬¬ä¸€æ¬¡æ›´æ–°
  let updated_config1 = TelemetryConfig::{
    service_name: initial_config.service_name,
    service_version: Some("1.0.0"),
    enabled: initial_config.enabled,
    sampling_rate: 0.8,
    batch_size: 200,
    export_interval: 45,
    attributes: [
      ("env", "development")
    ]
  }
  
  assert updated_config1.validate() == true
  assert match (updated_config1.service_version) {
    Some(v) => v == "1.0.0"
    None => false
  }
  assert updated_config1.sampling_rate == 0.8
  assert updated_config1.batch_size == 200
  assert updated_config1.export_interval == 45
  assert updated_config1.attributes.length == 1
  
  // ç¬¬äºŒæ¬¡æ›´æ–°
  let updated_config2 = TelemetryConfig::{
    service_name: updated_config1.service_name,
    service_version: updated_config1.service_version,
    enabled: false,  // ç¦ç”¨é¥æµ‹
    sampling_rate: 0.3,
    batch_size: 300,
    export_interval: 120,
    attributes: [
      ("env", "staging"),
      ("region", "us-east-1"),
      ("instance.id", "instance-123")
    ]
  }
  
  assert updated_config2.validate() == true
  assert updated_config2.enabled == false
  assert updated_config2.sampling_rate == 0.3
  assert updated_config2.batch_size == 300
  assert updated_config2.export_interval == 120
  assert updated_config2.attributes.length == 3
}

test "config management: configuration to resource mapping" {
  // æµ‹è¯•é…ç½®åˆ°Resourceçš„æ˜ å°„
  let config = TelemetryConfig::{
    service_name: "mapped_service",
    service_version: Some("2.1.0"),
    enabled: true,
    sampling_rate: 0.7,
    batch_size: 150,
    export_interval: 90,
    attributes: [
      ("env", "production"),
      ("region", "eu-west-1"),
      ("datacenter", "dc-01")
    ]
  }
  
  // å°†é…ç½®æ˜ å°„åˆ°Resource
  let mut resource_attributes = []
  
  let mut i = 0
  while i < config.attributes.length {
    let (key, value) = config.attributes[i]
    resource_attributes.push((key, AttributeValue::string(value)))
    i = i + 1
  }
  
  // æ·»åŠ é…ç½®ç›¸å…³çš„å±æ€§
  resource_attributes.push(("telemetry.enabled", AttributeValue::bool(config.enabled)))
  resource_attributes.push(("telemetry.sampling_rate", AttributeValue::float(config.sampling_rate)))
  resource_attributes.push(("telemetry.batch_size", AttributeValue::int(config.batch_size.to_int64())))
  resource_attributes.push(("telemetry.export_interval", AttributeValue::int(config.export_interval.to_int64())))
  
  let resource = Resource::{
    service_name: config.service_name,
    service_version: config.service_version,
    telemetry_sdk_name: "azimuth",
    telemetry_sdk_version: "0.1.0",
    attributes: resource_attributes
  }
  
  // éªŒè¯æ˜ å°„ç»“æœ
  assert resource.service_name == "mapped_service"
  assert match (resource.service_version) {
    Some(v) => v == "2.1.0"
    None => false
  }
  
  // éªŒè¯é…ç½®å±æ€§
  let mut found_enabled = false
  let mut found_sampling_rate = false
  let mut found_batch_size = false
  let mut found_export_interval = false
  let mut found_env = false
  
  let mut j = 0
  while j < resource.attributes.length {
    let (key, value) = resource.attributes[j]
    match (key) {
      "telemetry.enabled" => {
        assert match (value) {
          BoolValue(enabled) => enabled == true
          _ => false
        }
        found_enabled = true
      }
      "telemetry.sampling_rate" => {
        assert match (value) {
          FloatValue(rate) => rate == 0.7
          _ => false
        }
        found_sampling_rate = true
      }
      "telemetry.batch_size" => {
        assert match (value) {
          IntValue(size) => size == 150L
          _ => false
        }
        found_batch_size = true
      }
      "telemetry.export_interval" => {
        assert match (value) {
          IntValue(interval) => interval == 90L
          _ => false
        }
        found_export_interval = true
      }
      "env" => {
        assert match (value) {
          StringValue(env) => env == "production"
          _ => false
        }
        found_env = true
      }
      _ => ()
    }
    j = j + 1
  }
  
  assert found_enabled
  assert found_sampling_rate
  assert found_batch_size
  assert found_export_interval
  assert found_env
}

test "config management: configuration inheritance and override" {
  // æµ‹è¯•é…ç½®çš„ç»§æ‰¿å’Œè¦†ç›–
  let base_config = TelemetryConfig::{
    service_name: "base_service",
    service_version: Some("1.0.0"),
    enabled: true,
    sampling_rate: 0.5,
    batch_size: 100,
    export_interval: 60,
    attributes: [
      ("env", "base"),
      ("region", "base-region")
    ]
  }
  
  // ç»§æ‰¿åŸºç¡€é…ç½®å¹¶è¦†ç›–éƒ¨åˆ†è®¾ç½®
  let inherited_config = TelemetryConfig::{
    service_name: base_config.service_name,
    service_version: base_config.service_version,
    enabled: base_config.enabled,
    sampling_rate: 0.8,  // è¦†ç›–åŸºç¡€é…ç½®
    batch_size: base_config.batch_size,
    export_interval: base_config.export_interval,
    attributes: [
      ("env", "inherited"),  // è¦†ç›–åŸºç¡€é…ç½®
      ("region", "base-region"),  // ç»§æ‰¿åŸºç¡€é…ç½®
      ("feature", "new-feature")  // æ–°å¢å±æ€§
    ]
  }
  
  // éªŒè¯ç»§æ‰¿ç»“æœ
  assert inherited_config.service_name == base_config.service_name
  assert inherited_config.service_version == base_config.service_version
  assert inherited_config.enabled == base_config.enabled
  assert inherited_config.sampling_rate != base_config.sampling_rate  // è¢«è¦†ç›–
  assert inherited_config.batch_size == base_config.batch_size  // ç»§æ‰¿
  assert inherited_config.export_interval == base_config.export_interval  // ç»§æ‰¿
  
  // éªŒè¯å±æ€§çš„ç»§æ‰¿å’Œè¦†ç›–
  let mut found_env = false
  let mut found_region = false
  let mut found_feature = false
  
  let mut i = 0
  while i < inherited_config.attributes.length {
    let (key, value) = inherited_config.attributes[i]
    match (key) {
      "env" => {
        assert value == "inherited"  // è¢«è¦†ç›–
        found_env = true
      }
      "region" => {
        assert value == "base-region"  // ç»§æ‰¿
        found_region = true
      }
      "feature" => {
        assert value == "new-feature"  // æ–°å¢
        found_feature = true
      }
      _ => ()
    }
    i = i + 1
  }
  
  assert found_env
  assert found_region
  assert found_feature
}

test "config management: configuration hot reload simulation" {
  // æ¨¡æ‹Ÿé…ç½®çƒ­é‡è½½åœºæ™¯
  let initial_config = TelemetryConfig::default()
  
  // æ¨¡æ‹Ÿé…ç½®æ–‡ä»¶æ›´æ–°
  let config_updates = [
    // ç¬¬ä¸€æ¬¡æ›´æ–°
    TelemetryConfig::{
      service_name: "hot_reload_service",
      service_version: Some("1.0.0"),
      enabled: true,
      sampling_rate: 0.5,
      batch_size: 100,
      export_interval: 60,
      attributes: [
        ("env", "development")
      ]
    },
    // ç¬¬äºŒæ¬¡æ›´æ–°
    TelemetryConfig::{
      service_name: "hot_reload_service",
      service_version: Some("1.0.1"),
      enabled: true,
      sampling_rate: 0.7,
      batch_size: 200,
      export_interval: 30,
      attributes: [
        ("env", "staging"),
        ("region", "us-west-2")
      ]
    },
    // ç¬¬ä¸‰æ¬¡æ›´æ–°
    TelemetryConfig::{
      service_name: "hot_reload_service",
      service_version: Some("1.1.0"),
      enabled: false,  // ç¦ç”¨é¥æµ‹
      sampling_rate: 0.1,
      batch_size: 50,
      export_interval: 120,
      attributes: [
        ("env", "maintenance"),
        ("region", "us-west-2"),
        ("maintenance.mode", "true")
      ]
    }
  ]
  
  // éªŒè¯æ¯æ¬¡æ›´æ–°
  let mut current_config = initial_config
  
  // ç¬¬ä¸€æ¬¡æ›´æ–°
  current_config = config_updates[0]
  assert current_config.service_name == "hot_reload_service"
  assert match (current_config.service_version) {
    Some(v) => v == "1.0.0"
    None => false
  }
  assert current_config.enabled == true
  assert current_config.sampling_rate == 0.5
  assert current_config.attributes.length == 1
  
  // ç¬¬äºŒæ¬¡æ›´æ–°
  current_config = config_updates[1]
  assert current_config.service_name == "hot_reload_service"
  assert match (current_config.service_version) {
    Some(v) => v == "1.0.1"
    None => false
  }
  assert current_config.enabled == true
  assert current_config.sampling_rate == 0.7
  assert current_config.batch_size == 200
  assert current_config.export_interval == 30
  assert current_config.attributes.length == 2
  
  // ç¬¬ä¸‰æ¬¡æ›´æ–°
  current_config = config_updates[2]
  assert current_config.service_name == "hot_reload_service"
  assert match (current_config.service_version) {
    Some(v) => v == "1.1.0"
    None => false
  }
  assert current_config.enabled == false
  assert current_config.sampling_rate == 0.1
  assert current_config.batch_size == 50
  assert current_config.export_interval == 120
  assert current_config.attributes.length == 3
  
  // éªŒè¯æ‰€æœ‰é…ç½®éƒ½æ˜¯æœ‰æ•ˆçš„
  let mut i = 0
  while i < config_updates.length {
    assert config_updates[i].validate() == true
    i = i + 1
  }
}

test "config management: configuration edge cases" {
  // æµ‹è¯•é…ç½®çš„è¾¹ç•Œæƒ…å†µ
  // æœ€å°æœ‰æ•ˆå€¼
  let min_config = TelemetryConfig::{
    service_name: "min_service",
    service_version: None,
    enabled: true,
    sampling_rate: 0.0,  // æœ€å°å€¼
    batch_size: 1,  // æœ€å°å€¼
    export_interval: 1,  // æœ€å°å€¼
    attributes: []
  }
  
  assert min_config.validate() == true
  
  // æœ€å¤§æœ‰æ•ˆå€¼
  let max_config = TelemetryConfig::{
    service_name: "max_service",
    service_version: Some("999.999.999"),
    enabled: true,
    sampling_rate: 1.0,  // æœ€å¤§å€¼
    batch_size: 10000,  // æœ€å¤§å€¼
    export_interval: 3600,  // æœ€å¤§å€¼
    attributes: [
      ("max.attr", "max_value")
    ]
  }
  
  assert max_config.validate() == true
  
  // ç©ºå±æ€§æ•°ç»„
  let empty_attrs_config = TelemetryConfig::{
    service_name: "empty_attrs_service",
    service_version: None,
    enabled: true,
    sampling_rate: 0.5,
    batch_size: 100,
    export_interval: 60,
    attributes: []
  }
  
  assert empty_attrs_config.validate() == true
  assert empty_attrs_config.attributes.length == 0
  
  // å¤§é‡å±æ€§
  let mut many_attrs = []
  let mut i = 0
  while i < 100 {
    many_attrs.push(("attr_" + i.to_string(), "value_" + i.to_string()))
    i = i + 1
  }
  
  let many_attrs_config = TelemetryConfig::{
    service_name: "many_attrs_service",
    service_version: None,
    enabled: true,
    sampling_rate: 0.5,
    batch_size: 100,
    export_interval: 60,
    attributes: many_attrs
  }
  
  assert many_attrs_config.validate() == true
  assert many_attrs_config.attributes.length == 100
  
  // ç‰¹æ®Šå­—ç¬¦å±æ€§å€¼
  let special_chars_config = TelemetryConfig::{
    service_name: "special_service",
    service_version: None,
    enabled: true,
    sampling_rate: 0.5,
    batch_size: 100,
    export_interval: 60,
    attributes: [
      ("empty", ""),
      ("whitespace", "   "),
      ("special.chars", "!@#$%^&*()"),
      ("unicode", "æµ‹è¯•é…ç½®"),
      ("emoji", "ğŸš€ğŸ“Š")
    ]
  }
  
  assert special_chars_config.validate() == true
  assert special_chars_config.attributes.length == 5
}
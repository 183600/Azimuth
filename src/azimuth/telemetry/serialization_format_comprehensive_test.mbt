// åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»¼åˆæµ‹è¯•
test "attribute_value_serialization" {
  // æµ‹è¯•AttributeValueçš„åºåˆ—åŒ–æ ¼å¼
  
  // å­—ç¬¦ä¸²å±æ€§åºåˆ—åŒ–
  let string_attr = AttributeValue::string("test-value")
  let string_serialized = match string_attr {
    StringValue(s) => "string:" + s
    _ => "unknown"
  }
  assert_eq(string_serialized, "string:test-value")
  
  // æ•´æ•°å±æ€§åºåˆ—åŒ–
  let int_attr = AttributeValue::int(42L)
  let int_serialized = match int_attr {
    IntValue(i) => "int:" + i.to_string()
    _ => "unknown"
  }
  assert_eq(int_serialized, "int:42")
  
  // æµ®ç‚¹æ•°å±æ€§åºåˆ—åŒ–
  let float_attr = AttributeValue::float(3.14)
  let float_serialized = match float_attr {
    FloatValue(f) => "float:" + f.to_string()
    _ => "unknown"
  }
  assert_eq(float_serialized.has_prefix("float:3.14"), true)
  
  // å¸ƒå°”å±æ€§åºåˆ—åŒ–
  let bool_attr = AttributeValue::bool(true)
  let bool_serialized = match bool_attr {
    BoolValue(b) => "bool:" + (if b { "true" } else { "false" })
    _ => "unknown"
  }
  assert_eq(bool_serialized, "bool:true")
  
  // å­—ç¬¦ä¸²æ•°ç»„å±æ€§åºåˆ—åŒ–
  let string_array_attr = AttributeValue::array_string(["a", "b", "c"])
  let string_array_serialized = match string_array_attr {
    ArrayStringValue(arr) => {
      let result = "array_string:"
      let mut i = 0
      while i < arr.length() {
        if i > 0 { result = result + "," }
        result = result + arr[i]
        i = i + 1
      }
      result
    }
    _ => "unknown"
  }
  assert_eq(string_array_serialized, "array_string:a,b,c")
  
  // æ•´æ•°æ•°ç»„å±æ€§åºåˆ—åŒ–
  let int_array_attr = AttributeValue::array_int([1L, 2L, 3L])
  let int_array_serialized = match int_array_attr {
    ArrayIntValue(arr) => {
      let result = "array_int:"
      let mut i = 0
      while i < arr.length() {
        if i > 0 { result = result + "," }
        result = result + arr[i].to_string()
        i = i + 1
      }
      result
    }
    _ => "unknown"
  }
  assert_eq(int_array_serialized, "array_int:1,2,3")
}

test "span_context_serialization" {
  // æµ‹è¯•SpanContextçš„åºåˆ—åŒ–æ ¼å¼
  
  let trace_id = Array::make(16, 0x00_byte)
  trace_id[0] = 0x0a_byte
  trace_id[1] = 0xf7_byte
  trace_id[2] = 0x65_byte
  trace_id[3] = 0x19_byte
  
  let span_id = Array::make(8, 0x00_byte)
  span_id[0] = 0xb7_byte
  span_id[1] = 0xad_byte
  span_id[2] = 0x6b_byte
  span_id[3] = 0x71_byte
  
  let span_context = SpanContext::{
    trace_id: trace_id,
    span_id: span_id,
    trace_flags: 0x01_byte,
    trace_state: "rojo=00f067aa0ba902b7,congo=t61rcWkgMzE"
  }
  
  // åºåˆ—åŒ–SpanContextä¸ºW3C traceparentæ ¼å¼
  let trace_id_hex = "0af7651916cd43dd8448eb211c80319c"
  let span_id_hex = "b7ad6b7169203331"
  let trace_flags_hex = "01"
  
  let traceparent_serialized = "00-" + trace_id_hex + "-" + span_id_hex + "-" + trace_flags_hex
  assert_eq(traceparent_serialized, "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  
  // åºåˆ—åŒ–trace_state
  let trace_state_serialized = span_context.trace_state
  assert_eq(trace_state_serialized, "rojo=00f067aa0ba902b7,congo=t61rcWkgMzE")
  
  // éªŒè¯åºåˆ—åŒ–æ ¼å¼
  assert_eq(traceparent_serialized.has_prefix("00-"), true)
  assert_eq(traceparent_serialized.contains("-"), true)
  assert_eq(traceparent_serialized.length(), 55)
  
  assert_eq(trace_state_serialized.contains("rojo="), true)
  assert_eq(trace_state_serialized.contains("congo="), true)
  assert_eq(trace_state_serialized.contains(","), true)
}

test "log_record_serialization" {
  // æµ‹è¯•LogRecordçš„åºåˆ—åŒ–æ ¼å¼
  
  let log_record = LogRecord::builder()
    .timestamp(1234567890L)
    .severity(Error)
    .body("Error processing request")
    .with_attribute("error.code", AttributeValue::int(500L))
    .with_attribute("error.message", AttributeValue::string("Internal server error"))
    .with_attribute("user.id", AttributeValue::int(12345L))
    .build()
  
  // åºåˆ—åŒ–LogRecordä¸ºJSONæ ¼å¼ï¼ˆæ¨¡æ‹Ÿï¼‰
  let log_json = "{"
    + "\"timestamp\":" + log_record.timestamp_unix_nanos.to_string() + ","
    + "\"severity\":\"ERROR\","
    + "\"body\":\"Error processing request\","
    + "\"attributes\":["
    + "{\"key\":\"error.code\",\"value\":\"int:500\"},"
    + "{\"key\":\"error.message\",\"value\":\"string:Internal server error\"},"
    + "{\"key\":\"user.id\",\"value\":\"int:12345\"}"
    + "]}"
  
  // éªŒè¯JSONæ ¼å¼
  assert_eq(log_json.contains("\"timestamp\":1234567890"), true)
  assert_eq(log_json.contains("\"severity\":\"ERROR\""), true)
  assert_eq(log_json.contains("\"body\":\"Error processing request\""), true)
  assert_eq(log_json.contains("\"attributes\""), true)
  assert_eq(log_json.contains("\"key\":\"error.code\""), true)
  assert_eq(log_json.contains("\"value\":\"int:500\""), true)
  
  // åºåˆ—åŒ–ä¸¥é‡æ€§çº§åˆ«
  let severity_serialized = match log_record.severity_number {
    Trace => "TRACE"
    Debug => "DEBUG"
    Info => "INFO"
    Warn => "WARN"
    Error => "ERROR"
    Fatal => "FATAL"
  }
  assert_eq(severity_serialized, "ERROR")
}

test "metrics_serialization" {
  // æµ‹è¯•Metricsçš„åºåˆ—åŒ–æ ¼å¼
  
  // åºåˆ—åŒ–Measurement
  let measurement = Measurement::{
    value: 99.5,
    attributes: [
      ("service.name", AttributeValue::string("payment-service")),
      ("operation.type", AttributeValue::string("transaction")),
      ("status", AttributeValue::string("success"))
    ]
  }
  
  let measurement_json = "{"
    + "\"value\":99.5,"
    + "\"attributes\":["
    + "{\"key\":\"service.name\",\"value\":\"string:payment-service\"},"
    + "{\"key\":\"operation.type\",\"value\":\"string:transaction\"},"
    + "{\"key\":\"status\",\"value\":\"string:success\"}"
    + "]}"
  
  // éªŒè¯Measurementåºåˆ—åŒ–
  assert_eq(measurement_json.contains("\"value\":99.5"), true)
  assert_eq(measurement_json.contains("\"service.name\""), true)
  assert_eq(measurement_json.contains("\"payment-service\""), true)
  
  // åºåˆ—åŒ–InstrumentType
  let counter_type = "Counter"
  let histogram_type = "Histogram"
  let up_down_counter_type = "UpDownCounter"
  let gauge_type = "Gauge"
  
  assert_eq(counter_type, "Counter")
  assert_eq(histogram_type, "Histogram")
  assert_eq(up_down_counter_type, "UpDownCounter")
  assert_eq(gauge_type, "Gauge")
}

test "resource_serialization" {
  // æµ‹è¯•Resourceçš„åºåˆ—åŒ–æ ¼å¼
  
  let resource = Resource::default("order-service")
  let resource_json = "{"
    + "\"service_name\":\"order-service\","
    + "\"service_version\":null,"
    + "\"telemetry_sdk_name\":\"azimuth\","
    + "\"telemetry_sdk_version\":\"0.1.0\","
    + "\"attributes\":[]}"
  
  // éªŒè¯Resourceåºåˆ—åŒ–
  assert_eq(resource_json.contains("\"service_name\":\"order-service\""), true)
  assert_eq(resource_json.contains("\"telemetry_sdk_name\":\"azimuth\""), true)
  assert_eq(resource_json.contains("\"telemetry_sdk_version\":\"0.1.0\""), true)
  assert_eq(resource_json.contains("\"attributes\":[]"), true)
  
  // åºåˆ—åŒ–å¸¦æœ‰å±æ€§çš„Resource
  let resource_with_attrs = Resource::default("user-service")
  let attrs = [
    ("service.namespace", AttributeValue::string("production")),
    ("service.instance.id", AttributeValue::string("instance-123")),
    ("deployment.environment", AttributeValue::string("prod"))
  ]
  
  let attrs_json = â€œ["
    + "{\"key\":\"service.namespace\",\"value\":\"string:production\"},"
    + "{\"key\":\"service.instance.id\",\"value\":\"string:instance-123\"},"
    + "{\"key\":\"deployment.environment\",\"value\":\"string:prod\"}"
    + "]"
  
  // éªŒè¯å±æ€§åºåˆ—åŒ–
  assert_eq(attrs_json.contains("service.namespace"), true)
  assert_eq(attrs_json.contains("production"), true)
  assert_eq(attrs_json.contains("instance-123"), true)
  assert_eq(attrs_json.contains("prod"), true)
}

test "baggage_serialization" {
  // æµ‹è¯•Baggageçš„åºåˆ—åŒ–æ ¼å¼
  
  let baggage = Baggage::empty()
    .with_entry("user.id", "12345")
    .with_entry("session.id", "session-abcdef")
    .with_entry("request.id", "req-123456")
  
  // åºåˆ—åŒ–ä¸ºW3C baggageæ ¼å¼
  let baggage_serialized = "user.id=12345,session.id=session-abcdef,request.id=req-123456"
  
  // éªŒè¯baggageåºåˆ—åŒ–
  assert_eq(baggage_serialized.contains("user.id=12345"), true)
  assert_eq(baggage_serialized.contains("session.id=session-abcdef"), true)
  assert_eq(baggage_serialized.contains("request.id=req-123456"), true)
  assert_eq(baggage_serialized.contains(","), true)
  
  // æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„baggageåºåˆ—åŒ–
  let special_baggage = Baggage::empty()
    .with_entry("special.key", "value with spaces")
    .with_entry("unicode.key", "å€¼æµ‹è¯•ğŸš€")
    .with_entry("empty.value", "")
  
  let special_baggage_serialized = "special.key=value with spaces,unicode.key=å€¼æµ‹è¯•ğŸš€,empty.value="
  
  assert_eq(special_baggage_serialized.contains("value with spaces"), true)
  assert_eq(special_baggage_serialized.contains("å€¼æµ‹è¯•ğŸš€"), true)
  assert_eq(special_baggage_serialized.contains("empty.value="), true)
}

test "context_serialization" {
  // æµ‹è¯•Contextçš„åºåˆ—åŒ–æ ¼å¼
  
  let ctx = context::Context::empty()
  let user_key = create_key("user-id")
  let session_key = create_key("session-id")
  
  let ctx_with_values = ctx
    .with_value(user_key, "user-12345")
    .with_value(session_key, "session-abcdef")
  
  // åºåˆ—åŒ–Contextä¸ºé”®å€¼å¯¹æ ¼å¼
  let ctx_serialized = "user-id=user-12345;session-id=session-abcdef"
  
  // éªŒè¯Contextåºåˆ—åŒ–
  assert_eq(ctx_serialized.contains("user-id=user-12345"), true)
  assert_eq(ctx_serialized.contains("session-id=session-abcdef"), true)
  assert_eq(ctx_serialized.contains(";"), true)
  
  // æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„Contextåºåˆ—åŒ–
  let special_key = create_key("special.key!@#$%")
  let special_value = "special value æµ‹è¯•ğŸš€"
  
  let ctx_with_special = ctx.with_value(special_key, special_value)
  let special_ctx_serialized = "special.key!@#$%=special value æµ‹è¯•ğŸš€"
  
  assert_eq(special_ctx_serialized.contains("special.key!@#$%"), true)
  assert_eq(special_ctx_serialized.contains("special value æµ‹è¯•ğŸš€"), true)
}

test "complex_span_serialization" {
  // æµ‹è¯•å¤æ‚Spançš„åºåˆ—åŒ–æ ¼å¼
  
  let trace_id = Array::make(16, 0x01_byte)
  let span_id = Array::make(8, 0x02_byte)
  let parent_span_id = Array::make(8, 0x03_byte)
  
  let span = Span::{
    name: "complex-operation",
    context: SpanContext::{
      trace_id: trace_id,
      span_id: span_id,
      trace_flags: 0x01_byte,
      trace_state: "test=value"
    },
    kind: Server,
    parent_span_id: Some(parent_span_id),
    start_time_unix_nanos: 1234567890L,
    end_time_unix_nanos: Some(1234567990L),
    status: Ok,
    status_description: Some("Operation completed successfully"),
    attributes: [
      ("service.name", AttributeValue::string("api-service")),
      ("operation.type", AttributeValue::string("database_query")),
      ("db.statement", AttributeValue::string("SELECT * FROM users")),
      ("db.rows_affected", AttributeValue::int(10L))
    ],
    events: [
      SpanEvent::{
        name: "db.query.start",
        timestamp_unix_nanos: 1234567950L,
        attributes: [
          ("db.query", AttributeValue::string("SELECT * FROM users"))
        ]
      },
      SpanEvent::{
        name: "db.query.complete",
        timestamp_unix_nanos: 1234567980L,
        attributes: [
          ("db.duration_ms", AttributeValue::float(30.5))
        ]
      }
    ],
    links: []
  }
  
  // åºåˆ—åŒ–Spanä¸ºJSONæ ¼å¼
  let span_json = "{"
    + "\"name\":\"complex-operation\","
    + "\"kind\":\"Server\","
    + "\"start_time_unix_nanos\":1234567890,"
    + "\"end_time_unix_nanos\":1234567990,"
    + "\"status\":\"Ok\","
    + "\"status_description\":\"Operation completed successfully\","
    + "\"attributes\":["
    + "{\"key\":\"service.name\",\"value\":\"string:api-service\"},"
    + "{\"key\":\"operation.type\",\"value\":\"string:database_query\"},"
    + "{\"key\":\"db.statement\",\"value\":\"string:SELECT * FROM users\"},"
    + "{\"key\":\"db.rows_affected\",\"value\":\"int:10\"}"
    + "],"
    + "\"events\":["
    + "{\"name\":\"db.query.start\",\"timestamp_unix_nanos\":1234567950,\"attributes\":[{\"key\":\"db.query\",\"value\":\"string:SELECT * FROM users\"}]},"
    + "{\"name\":\"db.query.complete\",\"timestamp_unix_nanos\":1234567980,\"attributes\":[{\"key\":\"db.duration_ms\",\"value\":\"float:30.5\"}]}"
    + "],"
    + "\"links\":[]}"
  
  // éªŒè¯å¤æ‚Spanåºåˆ—åŒ–
  assert_eq(span_json.contains("\"name\":\"complex-operation\""), true)
  assert_eq(span_json.contains("\"kind\":\"Server\""), true)
  assert_eq(span_json.contains("\"status\":\"Ok\""), true)
  assert_eq(span_json.contains("\"attributes\""), true)
  assert_eq(span_json.contains("\"events\""), true)
  assert_eq(span_json.contains("\"db.query.start\""), true)
  assert_eq(span_json.contains("\"db.query.complete\""), true)
  assert_eq(span_json.contains("\"SELECT * FROM users\""), true)
}

test "serialization_format_consistency" {
  // æµ‹è¯•åºåˆ—åŒ–æ ¼å¼çš„ä¸€è‡´æ€§
  
  // åˆ›å»ºç›¸åŒçš„å¯¹è±¡å¹¶éªŒè¯åºåˆ—åŒ–ç»“æœçš„ä¸€è‡´æ€§
  let attr1 = AttributeValue::string("test-value")
  let attr2 = AttributeValue::string("test-value")
  
  let serialized1 = match attr1 {
    StringValue(s) => "string:" + s
    _ => "unknown"
  }
  
  let serialized2 = match attr2 {
    StringValue(s) => "string:" + s
    _ => "unknown"
  }
  
  assert_eq(serialized1, serialized2)
  assert_eq(serialized1, "string:test-value")
  
  // æµ‹è¯•ä¸åŒç±»å‹å±æ€§çš„åºåˆ—åŒ–åŒºåˆ†
  let string_attr = AttributeValue::string("123")
  let int_attr = AttributeValue::int(123L)
  
  let string_serialized = match string_attr {
    StringValue(s) => "string:" + s
    _ => "unknown"
  }
  
  let int_serialized = match int_attr {
    IntValue(i) => "int:" + i.to_string()
    _ => "unknown"
  }
  
  assert_eq(string_serialized, "string:123")
  assert_eq(int_serialized, "int:123")
  assert_eq(string_serialized != int_serialized, true) // ä¸åŒç±»å‹åº”è¯¥æœ‰ä¸åŒçš„åºåˆ—åŒ–æ ¼å¼
  
  // æµ‹è¯•æ•°ç»„åºåˆ—åŒ–çš„é¡ºåºä¸€è‡´æ€§
  let array_attr = AttributeValue::array_string(["a", "b", "c"])
  let array_serialized = match array_attr {
    ArrayStringValue(arr) => {
      let result = "array_string:"
      let mut i = 0
      while i < arr.length() {
        if i > 0 { result = result + "," }
        result = result + arr[i]
        i = i + 1
      }
      result
    }
    _ => "unknown"
  }
  
  assert_eq(array_serialized, "array_string:a,b,c")
  assert_eq(array_serialized.contains("a,b,c"), true)
  assert_eq(array_serialized.contains("b,c"), false) // éªŒè¯é¡ºåºæ­£ç¡®
}
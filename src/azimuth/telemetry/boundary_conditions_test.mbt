// è¾¹ç•Œæ¡ä»¶æµ‹è¯•
// æµ‹è¯•å„ç§è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µçš„å¤„ç†

test "attribute_value_edge_cases" {
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²
  let empty_string = @azimuth.telemetry.api.common.AttributeValue::string("")
  match empty_string {
    @azimuth.telemetry.api.common.StringValue(value) => assert_eq(value, "")
    _ => @test.fail("Expected empty string")
  }
  
  // æµ‹è¯•æå€¼
  let max_int = @azimuth.telemetry.api.common.AttributeValue::int(9223372036854775807L)  // Int64æœ€å¤§å€¼
  let min_int = @azimuth.telemetry.api.common.AttributeValue::int(-9223372036854775808L)  // Int64æœ€å°å€¼
  let max_double = @azimuth.telemetry.api.common.AttributeValue::float(1.7976931348623157e308)  // Doubleæœ€å¤§å€¼
  let min_double = @azimuth.telemetry.api.common.AttributeValue::float(-1.7976931348623157e308)  // Doubleæœ€å°å€¼
  
  match max_int {
    @azimuth.telemetry.api.common.IntValue(value) => assert_eq(value, 9223372036854775807L)
    _ => @test.fail("Expected max int value")
  }
  
  match min_int {
    @azimuth.telemetry.api.common.IntValue(value) => assert_eq(value, -9223372036854775808L)
    _ => @test.fail("Expected min int value")
  }
  
  // æµ‹è¯•ç©ºæ•°ç»„
  let empty_string_array = @azimuth.telemetry.api.common.AttributeValue::array_string([])
  let empty_int_array = @azimuth.telemetry.api.common.AttributeValue::array_int([])
  
  match empty_string_array {
    @azimuth.telemetry.api.common.ArrayStringValue(values) => assert_eq(values.length(), 0)
    _ => @test.fail("Expected empty string array")
  }
  
  match empty_int_array {
    @azimuth.telemetry.api.common.ArrayIntValue(values) => assert_eq(values.length(), 0)
    _ => @test.fail("Expected empty int array")
  }
}

test "context_edge_cases" {
  // æµ‹è¯•ç©ºé”®å
  let empty_key = @azimuth.telemetry.api.context.create_key("")
  let ctx = @azimuth.telemetry.api.context.Context::empty()
  let ctx_with_empty_key = ctx.with_value(empty_key, "value")
  
  match ctx_with_empty_key.get(empty_key) {
    Some(value) => assert_eq(value, "value")
    None => @test.fail("Expected value for empty key")
  }
  
  // æµ‹è¯•é•¿é”®åå’Œå€¼
  let long_key_name = "a".repeat(1000)
  let long_value = "b".repeat(1000)
  let long_key = @azimuth.telemetry.api.context.create_key(long_key_name)
  let ctx_with_long = ctx.with_value(long_key, long_value)
  
  match ctx_with_long.get(long_key) {
    Some(value) => assert_eq(value, long_value)
    None => @test.fail("Expected value for long key")
  }
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦
  let special_key = @azimuth.telemetry.api.context.create_key("key with spaces & symbols!@#$%^&*()")
  let special_value = "value with \n newlines \t tabs and \"quotes\""
  let ctx_with_special = ctx.with_value(special_key, special_value)
  
  match ctx_with_special.get(special_key) {
    Some(value) => assert_eq(value, special_value)
    None => @test.fail("Expected value for special key")
  }
}

test "span_edge_cases" {
  let ctx = @azimuth.telemetry.api.context.Context::empty()
  let tracer = NoopTracer::{}
  
  // æµ‹è¯•ç©ºåç§°
  let (_, empty_name_span) = tracer.start_span(ctx, "")
  assert_eq(empty_name_span.name, "")
  
  // æµ‹è¯•é•¿åç§°
  let long_name = "span_name_".repeat(100)
  let (_, long_name_span) = tracer.start_span(ctx, long_name)
  assert_eq(long_name_span.name, long_name)
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦åç§°
  let special_name = "span/with\\special:chars?and#symbols"
  let (_, special_name_span) = tracer.start_span(ctx, special_name)
  assert_eq(special_name_span.name, special_name)
  
  // æµ‹è¯•è´Ÿæ—¶é—´æˆ³
  let negative_time = -1640995200000000000L
  let (_, negative_time_span) = tracer.start_span(ctx, "negative_time", start_time_unix_nanos: Some(negative_time))
  assert_eq(negative_time_span.start_time_unix_nanos, negative_time)
  
  // æµ‹è¯•å¤§é‡å±æ€§
  let many_attributes = []
  let mut i = 0
  while i < 100 {
    many_attributes.push(("attr_" + i.to_string(), @azimuth.telemetry.api.common.AttributeValue::int(i.to_int64())))
    i = i + 1
  }
  let (_, many_attrs_span) = tracer.start_span(ctx, "many_attributes", attributes: Some(many_attributes))
  assert_eq(many_attrs_span.attributes.length(), 100)
}

test "metrics_edge_cases" {
  let provider = NoopMeterProvider::{}
  let meter = provider.get_meter("edge_case_meter")
  
  // æµ‹è¯•æå€¼
  let counter = meter.create_counter("extreme_counter")
  counter.add(9223372036854775807L)  // Int64æœ€å¤§å€¼
  counter.add(-9223372036854775808L)  // Int64æœ€å°å€¼
  
  // æµ‹è¯•æå€¼æµ®ç‚¹æ•°
  let histogram = meter.create_histogram("extreme_histogram")
  histogram.record(1.7976931348623157e308)  // Doubleæœ€å¤§å€¼
  histogram.record(-1.7976931348623157e308)  // Doubleæœ€å°å€¼
  histogram.record(0.0)
  histogram.record(1.0e-10)  // éå¸¸å°çš„æ­£æ•°
  histogram.record(-1.0e-10)  // éå¸¸å°çš„è´Ÿæ•°
  
  // æµ‹è¯•ç‰¹æ®Šæµ®ç‚¹å€¼ï¼ˆå¦‚æœç³»ç»Ÿæ”¯æŒï¼‰
  histogram.record(1.0e300)  // å¾ˆå¤§çš„æ•°
  histogram.record(1.0e-300)  // å¾ˆå°çš„æ•°
  
  @test.succeed()
}

test "logs_edge_cases" {
  let provider = NoopLoggerProvider::{}
  let logger = provider.get_logger("edge_case_logger")
  
  // æµ‹è¯•ç©ºæ¶ˆæ¯
  logger.debug("")
  logger.info("")
  logger.warn("")
  logger.error("")
  logger.fatal("")
  
  // æµ‹è¯•é•¿æ¶ˆæ¯
  let long_message = "x".repeat(10000)
  logger.info(long_message)
  
  // æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ¶ˆæ¯
  let special_message = "Message with newlines\nand tabs\tand \"quotes\" and 'apostrophes' and \x00 null byte"
  logger.error(special_message)
  
  // æµ‹è¯•Unicodeå­—ç¬¦
  let unicode_message = "Unicode test: ä½ å¥½ä¸–ç•Œ ğŸŒ cafÃ© rÃ©sumÃ© naÃ¯ve"
  logger.info(unicode_message)
  
  // æµ‹è¯•å¤§é‡å±æ€§
  let many_attributes = []
  let mut i = 0
  while i < 50 {
    many_attributes.push(("log_attr_" + i.to_string(), AttributeValue::string("value_" + i.to_string())))
    i = i + 1
  }
  logger.warn("Log with many attributes", Some(many_attributes))
  
  @test.succeed()
}

test "propagation_edge_cases" {
  let ctx = Context::empty()
  let carrier = MapCarrier::from_map([
    ("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"),
    ("baggage", "key1=value1,key2=value2"),
    ("custom-header", "custom-value"),
    ("empty-header", ""),
    ("another-traceparent", "00-1234567890abcdef1234567890abcdef-fedcba9876543210-01")
  ])
  
  let composite = CompositePropagator::new([
    W3CTraceContextPropagator::{},
    W3CBaggagePropagator::{}
  ])
  
  // æµ‹è¯•ä»åŒ…å«å¤šä¸ªå¤´å’Œå¼‚å¸¸å€¼çš„carrierä¸­æå–
  let extracted_ctx = composite.extract(ctx, carrier)
  
  // æµ‹è¯•å‘å·²æœ‰æ•°æ®çš„carrieræ³¨å…¥
  let populated_carrier = MapCarrier::from_map([
    ("existing-header", "existing-value")
  ])
  composite.inject(ctx, populated_carrier)
  
  // éªŒè¯æ³¨å…¥ä¸ä¼šç ´åç°æœ‰æ•°æ®
  match populated_carrier.get("existing-header") {
    Some(value) => assert_eq(value, "existing-value")
    None => @test.fail("Expected existing header to be preserved")
  }
  
  match populated_carrier.get("traceparent") {
    Some(_) => @test.succeed()
    None => @test.fail("Expected traceparent header")
  }
}

test "resource_edge_cases" {
  // æµ‹è¯•ç©ºæœåŠ¡å
  let empty_service_resource = @azimuth.telemetry.api.common.Resource::default("")
  assert_eq(empty_service_resource.service_name, "")
  
  // æµ‹è¯•é•¿æœåŠ¡å
  let long_service_name = "service_name_".repeat(100)
  let long_service_resource = @azimuth.telemetry.api.common.Resource::default(long_service_name)
  assert_eq(long_service_resource.service_name, long_service_name)
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦æœåŠ¡å
  let special_service_name = "service/with\\special:chars"
  let special_service_resource = @azimuth.telemetry.api.common.Resource::default(special_service_name)
  assert_eq(special_service_resource.service_name, special_service_name)
  
  // æµ‹è¯•å¤§é‡å±æ€§
  let many_attributes = []
  let mut i = 0
  while i < 200 {
    many_attributes.push(("resource_attr_" + i.to_string(), @azimuth.telemetry.api.common.AttributeValue::string("value_" + i.to_string())))
    i = i + 1
  }
  let many_attrs_resource = @azimuth.telemetry.api.common.Resource::{
    service_name: "many_attrs_service",
    service_version: Some("1.0.0"),
    telemetry_sdk_name: "azimuth",
    telemetry_sdk_version: "0.1.0",
    attributes: many_attributes
  }
  assert_eq(many_attrs_resource.attributes.length(), 200)
}

test "error_handling_and_resilience" {
  // æµ‹è¯•å„ç§å¼‚å¸¸æƒ…å†µä¸‹çš„ç³»ç»Ÿç¨³å®šæ€§
  
  // 1. Contextæ“ä½œä¸­çš„å¼‚å¸¸æƒ…å†µ
  let ctx = @azimuth.telemetry.api.context.Context::empty()
  let normal_key = @azimuth.telemetry.api.context.create_key("normal_key")
  let ctx_with_data = ctx.with_value(normal_key, "normal_value")
  
  // å³ä½¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼ŒåŸºæœ¬æ“ä½œä¹Ÿåº”è¯¥æ­£å¸¸å·¥ä½œ
  match ctx_with_data.get(normal_key) {
    Some(value) => assert_eq(value, "normal_value")
    None => @test.fail("Expected normal value")
  }
  
  // 2. Traceæ“ä½œä¸­çš„å¼‚å¸¸æƒ…å†µ
  let tracer = NoopTracer::{}
  let (_, span) = tracer.start_span(ctx_with_data, "resilience_test")
  
  // éªŒè¯å³ä½¿åœ¨å¼‚å¸¸ä¸Šä¸‹æ–‡ä¸­ï¼Œspanä¹Ÿèƒ½æ­£å¸¸åˆ›å»º
  assert_eq(span.name, "resilience_test")
  
  // 3. Metricsæ“ä½œä¸­çš„å¼‚å¸¸æƒ…å†µ
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("resilience_meter")
  let counter = meter.create_counter("resilience_counter")
  
  // å³ä½¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œæ“ä½œä¹Ÿä¸åº”è¯¥å´©æºƒ
  counter.add(1L)
  
  // 4. Logsæ“ä½œä¸­çš„å¼‚å¸¸æƒ…å†µ
  let logger_provider = NoopLoggerProvider::{}
  let logger = logger_provider.get_logger("resilience_logger")
  
  // å³ä½¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œæ—¥å¿—è®°å½•ä¹Ÿä¸åº”è¯¥å´©æºƒ
  logger.error("Error in resilience test")
  
  @test.succeed()
}

test "performance_edge_cases" {
  // æµ‹è¯•æ€§èƒ½è¾¹ç•Œæƒ…å†µ
  
  // 1. å¤§é‡ä¸Šä¸‹æ–‡æ“ä½œ
  let ctx = @azimuth.telemetry.api.context.Context::empty()
  let mut current_ctx = ctx
  let mut i = 0
  while i < 1000 {
    let key = @azimuth.telemetry.api.context.create_key("perf_key_" + i.to_string())
    current_ctx = current_ctx.with_value(key, "perf_value_" + i.to_string())
    i = i + 1
  }
  
  // éªŒè¯å¤§é‡æ“ä½œåç³»ç»Ÿä»ç„¶æ­£å¸¸
  let test_key = @azimuth.telemetry.api.context.create_key("perf_key_500")
  match current_ctx.get(test_key) {
    Some(value) => assert_eq(value, "perf_value_500")
    None => @test.fail("Expected value after many operations")
  }
  
  // 2. å¤§é‡Baggageæ“ä½œ
  let baggage = @azimuth.telemetry.api.context.Baggage::empty()
  let mut current_baggage = baggage
  let mut j = 0
  while j < 500 {
    current_baggage = current_baggage.with_entry("baggage_key_" + j.to_string(), "baggage_value_" + j.to_string())
    j = j + 1
  }
  
  // éªŒè¯å¤§é‡æ“ä½œåç³»ç»Ÿä»ç„¶æ­£å¸¸
  match current_baggage.get("baggage_key_250") {
    Some(value) => assert_eq(value, "baggage_value_250")
    None => @test.fail("Expected baggage entry after many operations")
  }
  
  @test.succeed()
}
// Metricså„ç§InstrumentTypeèšåˆæµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•ä¸åŒInstrumentTypeçš„èšåˆåŠŸèƒ½å’Œå¤æ‚åœºæ™¯

test "instrument_type_counter_aggregation" {
  // æµ‹è¯•Counterç±»å‹æŒ‡æ ‡çš„èšåˆ
  
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("test-meter", Some("1.0.0"))
  
  // åˆ›å»ºCounter
  let counter = meter.create_counter("http.requests.total", Some("requests"), Some("Total HTTP requests"))
  
  // æµ‹è¯•Counterçš„åŸºæœ¬æ“ä½œ
  counter.add(1L, Some([("http.method", AttributeValue::string("GET"))]))
  counter.add(2L, Some([("http.method", AttributeValue::string("POST"))]))
  counter.add(3L, Some([("http.method", AttributeValue::string("GET"))]))
  counter.add(5L, Some([("http.method", AttributeValue::string("PUT"))]))
  counter.add(10L, Some([("http.method", AttributeValue::string("GET"))]))
  
  // éªŒè¯Counterç±»å‹
  assert_eq(true, true)  // Noopå®ç°ä¸­æ— æ³•éªŒè¯å®é™…èšåˆ
  
  // æµ‹è¯•è´Ÿå€¼å¤„ç†ï¼ˆCounteré€šå¸¸ä¸å…è®¸è´Ÿå€¼ï¼‰
  counter.add(-1L, Some([("http.method", AttributeValue::string("DELETE"))]))
  
  // æµ‹è¯•é›¶å€¼
  counter.add(0L, Some([("http.method", AttributeValue::string("OPTIONS"))]))
  
  // æµ‹è¯•å¤§å€¼
  counter.add(9223372036854775807L, Some([("http.method", AttributeValue::string("PATCH"))]))
  
  // æµ‹è¯•å¤æ‚å±æ€§
  let complex_attributes = [
    ("http.method", AttributeValue::string("GET")),
    ("http.status_code", AttributeValue::int(200L)),
    ("http.route", AttributeValue::string("/api/users")),
    ("service.name", AttributeValue::string("api-gateway")),
    ("service.version", AttributeValue::string("2.1.0")),
    ("deployment.environment", AttributeValue::string("production"))
  ]
  
  counter.add(100L, Some(complex_attributes))
}

test "instrument_type_histogram_aggregation" {
  // æµ‹è¯•Histogramç±»å‹æŒ‡æ ‡çš„èšåˆ
  
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("test-meter", Some("1.0.0"))
  
  // åˆ›å»ºHistogram
  let histogram = meter.create_histogram("http.request.duration", Some("ms"), Some("HTTP request duration"))
  
  // æµ‹è¯•Histogramçš„åŸºæœ¬æ“ä½œ
  histogram.record(100.0, Some([("http.method", AttributeValue::string("GET"))]))
  histogram.record(200.5, Some([("http.method", AttributeValue::string("POST"))]))
  histogram.record(50.25, Some([("http.method", AttributeValue::string("GET"))]))
  histogram.record(1000.0, Some([("http.method", AttributeValue::string("PUT"))]))
  histogram.record(75.75, Some([("http.method", AttributeValue::string("GET"))]))
  
  // æµ‹è¯•è¾¹ç•Œå€¼
  histogram.record(0.0, Some([("http.method", AttributeValue::string("DELETE"))]))
  histogram.record(-1.0, Some([("http.method", AttributeValue::string("OPTIONS"))]))  // è´Ÿå€¼
  histogram.record(1.7976931348623157e+308, Some([("http.method", AttributeValue::string("PATCH"))]))  // æœ€å¤§å€¼
  
  // æµ‹è¯•ç‰¹æ®Šæµ®ç‚¹å€¼
  histogram.record(1.0/0.0, Some([("http.method", AttributeValue::string("HEAD"))]))  // æ­£æ— ç©·
  histogram.record(-1.0/0.0, Some([("http.method", AttributeValue::string("TRACE"))]))  // è´Ÿæ— ç©·
  histogram.record(0.0/0.0, Some([("http.method", AttributeValue::string("CONNECT"))]))  // NaN
  
  // æµ‹è¯•ç§‘å­¦è®¡æ•°æ³•
  histogram.record(1.23e-10, Some([("http.method", AttributeValue::string("CUSTOM1"))]))
  histogram.record(1.23e+20, Some([("http.method", AttributeValue::string("CUSTOM2"))]))
  
  // æµ‹è¯•å¤æ‚å±æ€§
  let complex_attributes = [
    ("http.method", AttributeValue::string("GET")),
    ("http.status_code", AttributeValue::int(200L)),
    ("http.route", AttributeValue::string("/api/data")),
    ("user.id", AttributeValue::string("user-123")),
    ("session.id", AttributeValue::string("session-456")),
    ("request.size", AttributeValue::int(1024L)),
    ("response.size", AttributeValue::int(2048L))
  ]
  
  histogram.record(150.5, Some(complex_attributes))
}

test "instrument_type_up_down_counter_aggregation" {
  // æµ‹è¯•UpDownCounterç±»å‹æŒ‡æ ‡çš„èšåˆ
  
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("test-meter", Some("1.0.0"))
  
  // åˆ›å»ºUpDownCounter
  let up_down_counter = meter.create_up_down_counter("active.connections", Some("connections"), Some("Active connections"))
  
  // æµ‹è¯•UpDownCounterçš„åŸºæœ¬æ“ä½œï¼ˆå…è®¸è´Ÿå€¼ï¼‰
  up_down_counter.add(10L, Some([("connection.type", AttributeValue::string("http"))]))
  up_down_counter.add(-5L, Some([("connection.type", AttributeValue::string("http"))]))
  up_down_counter.add(3L, Some([("connection.type", AttributeValue::string("websocket"))]))
  up_down_counter.add(-2L, Some([("connection.type", AttributeValue::string("websocket"))]))
  
  // æµ‹è¯•é›¶å€¼
  up_down_counter.add(0L, Some([("connection.type", AttributeValue::string("grpc"))]))
  
  // æµ‹è¯•æå€¼
  up_down_counter.add(9223372036854775807L, Some([("connection.type", AttributeValue::string("tcp"))]))
  up_down_counter.add(-9223372036854775808L, Some([("connection.type", AttributeValue::string("udp"))]))
  
  // æµ‹è¯•å¤æ‚åœºæ™¯
  let complex_attributes = [
    ("connection.type", AttributeValue::string("http")),
    ("connection.state", AttributeValue::string("active")),
    ("client.ip", AttributeValue::string("192.168.1.100")),
    ("client.user_agent", AttributeValue::string("Mozilla/5.0")),
    ("server.endpoint", AttributeValue::string("/api/long-polling")),
    ("connection.duration", AttributeValue::int(30000L))
  ]
  
  up_down_counter.add(1L, Some(complex_attributes))
  up_down_counter.add(-1L, Some(complex_attributes))
}

test "instrument_type_gauge_aggregation" {
  // æµ‹è¯•Gaugeç±»å‹æŒ‡æ ‡çš„èšåˆ
  
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("test-meter", Some("1.0.0"))
  
  // åˆ›å»ºGauge
  let gauge = meter.create_gauge("memory.usage", Some("bytes"), Some("Memory usage"))
  
  // æµ‹è¯•Gaugeçš„åŸºæœ¬æ“ä½œ
  gauge.record(1024.0, Some([("memory.type", AttributeValue::string("heap"))]))
  gauge.record(2048.5, Some([("memory.type", AttributeValue::string("stack"))]))
  gauge.record(512.25, Some([("memory.type", AttributeValue::string("heap"))]))
  gauge.record(4096.0, Some([("memory.type", AttributeValue::string("native"))]))
  
  // æµ‹è¯•è¾¹ç•Œå€¼
  gauge.record(0.0, Some([("memory.type", AttributeValue::string("code_cache"))]))
  gauge.record(-1.0, Some([("memory.type", AttributeValue::string("free"))]))  // è´Ÿå€¼å¯èƒ½è¡¨ç¤ºé‡Šæ”¾
  gauge.record(1.7976931348623157e+308, Some([("memory.type", AttributeValue::string("total_available"))]))
  
  // æµ‹è¯•ç‰¹æ®Šæµ®ç‚¹å€¼
  gauge.record(1.0/0.0, Some([("memory.type", AttributeValue::string("unlimited"))))
  gauge.record(0.0/0.0, Some([("memory.type", AttributeValue::string("unknown"))))
  
  // æµ‹è¯•å¤æ‚å±æ€§
  let complex_attributes = [
    ("memory.type", AttributeValue::string("heap")),
    ("memory.pool", AttributeValue::string("eden")),
    ("process.id", AttributeValue::int(12345L)),
    ("process.name", AttributeValue::string("java")),
    ("container.id", AttributeValue::string("container-abc123")),
    ("node.name", AttributeValue::string("worker-node-1")),
    ("availability.zone", AttributeValue::string("us-west-2a"))
  ]
  
  gauge.record(8192.0, Some(complex_attributes))
}

test "instrument_type_observable_counter_aggregation" {
  // æµ‹è¯•ObservableCounterç±»å‹æŒ‡æ ‡çš„èšåˆ
  
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("test-meter", Some("1.0.0"))
  
  // æ³¨æ„ï¼šåœ¨å½“å‰å®ç°ä¸­ï¼ŒObservableCounterçš„åˆ›å»ºæ–¹æ³•ä¸Counterç›¸åŒ
  // åœ¨å®é™…å®ç°ä¸­ï¼ŒObservableCounteråº”è¯¥æœ‰ä¸åŒçš„åˆ›å»ºæ–¹æ³•
  let observable_counter = meter.create_counter("cache.hits.total", Some("hits"), Some("Total cache hits"))
  
  // ObservableCounteré€šå¸¸é€šè¿‡å›è°ƒå‡½æ•°æä¾›å€¼ï¼Œè¿™é‡Œæˆ‘ä»¬æµ‹è¯•åŸºæœ¬ç»“æ„
  observable_counter.add(100L, Some([("cache.type", AttributeValue::string("redis"))]))
  observable_counter.add(200L, Some([("cache.type", AttributeValue::string("memcached"))]))
  
  // æµ‹è¯•å¤æ‚åœºæ™¯
  let complex_attributes = [
    ("cache.type", AttributeValue::string("redis")),
    ("cache.cluster", AttributeValue::string("cluster-1")),
    ("cache.node", AttributeValue::string("redis-node-1")),
    ("cache.shard", AttributeValue::int(0L)),
    ("cache.key.pattern", AttributeValue::string("user:*")),
    ("cache.ttl", AttributeValue::int(3600L))
  ]
  
  observable_counter.add(500L, Some(complex_attributes))
}

test "instrument_type_observable_gauge_aggregation" {
  // æµ‹è¯•ObservableGaugeç±»å‹æŒ‡æ ‡çš„èšåˆ
  
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("test-meter", Some("1.0.0"))
  
  // æ³¨æ„ï¼šåœ¨å½“å‰å®ç°ä¸­ï¼ŒObservableGaugeçš„åˆ›å»ºæ–¹æ³•ä¸Gaugeç›¸åŒ
  let observable_gauge = meter.create_gauge("cpu.usage", Some("percent"), Some("CPU usage percentage"))
  
  // æµ‹è¯•ä¸åŒç±»å‹çš„CPUä½¿ç”¨ç‡
  observable_gauge.record(75.5, Some([("cpu.core", AttributeValue::int(0L))]))
  observable_gauge.record(80.0, Some([("cpu.core", AttributeValue::int(1L))]))
  observable_gauge.record(60.25, Some([("cpu.core", AttributeValue::int(2L))]))
  observable_gauge.record(90.75, Some([("cpu.core", AttributeValue::int(3L))]))
  
  // æµ‹è¯•è¾¹ç•Œå€¼
  observable_gauge.record(0.0, Some([("cpu.core", AttributeValue::int(4L))]))
  observable_gauge.record(100.0, Some([("cpu.core", AttributeValue::int(5L))]))
  observable_gauge.record(150.0, Some([("cpu.core", AttributeValue::int(6L))]))  // è¶…è¿‡100%
  
  // æµ‹è¯•å¤æ‚å±æ€§
  let complex_attributes = [
    ("cpu.core", AttributeValue::int(7L)),
    ("cpu.mode", AttributeValue::string("user")),
    ("process.name", AttributeValue::string("web-server")),
    ("process.id", AttributeValue::int(12345L)),
    ("container.name", AttributeValue::string("web-server-container")),
    ("k8s.pod.name", AttributeValue::string("web-server-pod-abc123")),
    ("k8s.namespace", AttributeValue::string("production"))
  ]
  
  observable_gauge.record(85.5, Some(complex_attributes))
}

test "instrument_type_observable_up_down_counter_aggregation" {
  // æµ‹è¯•ObservableUpDownCounterç±»å‹æŒ‡æ ‡çš„èšåˆ
  
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("test-meter", Some("1.0.0"))
  
  // æ³¨æ„ï¼šåœ¨å½“å‰å®ç°ä¸­ï¼ŒObservableUpDownCounterçš„åˆ›å»ºæ–¹æ³•ä¸UpDownCounterç›¸åŒ
  let observable_up_down_counter = meter.create_up_down_counter("queue.size", Some("messages"), Some("Queue size"))
  
  // æµ‹è¯•é˜Ÿåˆ—å¤§å°å˜åŒ–
  observable_up_down_counter.add(100L, Some([("queue.name", AttributeValue::string("priority"))]))
  observable_up_down_counter.add(-20L, Some([("queue.name", AttributeValue::string("priority"))]))
  observable_up_down_counter.add(50L, Some([("queue.name", AttributeValue::string("normal"))]))
  observable_up_down_counter.add(-10L, Some([("queue.name", AttributeValue::string("normal"))]))
  
  // æµ‹è¯•å¤æ‚åœºæ™¯
  let complex_attributes = [
    ("queue.name", AttributeValue::string("bulk")),
    ("queue.priority", AttributeValue::string("low")),
    ("queue.type", AttributeValue::string("fifo")),
    ("consumer.group", AttributeValue::string("processor-1")),
    ("partition.id", AttributeValue::int(0L)),
    ("broker.name", AttributeValue::string("kafka-broker-1")),
    ("topic.name", AttributeValue::string("events"))
  ]
  
  observable_up_down_counter.add(1000L, Some(complex_attributes))
  observable_up_down_counter.add(-200L, Some(complex_attributes))
}

test "metrics_complex_aggregation_scenarios" {
  // æµ‹è¯•æŒ‡æ ‡çš„å¤æ‚èšåˆåœºæ™¯
  
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("complex-meter", Some("2.0.0"))
  
  // åˆ›å»ºå¤šç§ç±»å‹çš„æŒ‡æ ‡
  let request_counter = meter.create_counter("http.requests.total", Some("requests"), Some("Total HTTP requests"))
  let request_duration = meter.create_histogram("http.request.duration", Some("ms"), Some("HTTP request duration"))
  let active_connections = meter.create_up_down_counter("active.connections", Some("connections"), Some("Active connections"))
  let memory_usage = meter.create_gauge("memory.usage", Some("bytes"), Some("Memory usage"))
  
  // æ¨¡æ‹Ÿå¤æ‚çš„ä¸šåŠ¡åœºæ™¯
  
  // åœºæ™¯1ï¼šå¤„ç†HTTPè¯·æ±‚
  let base_attributes = [
    ("service.name", AttributeValue::string("api-gateway")),
    ("service.version", AttributeValue::string("2.1.0")),
    ("deployment.environment", AttributeValue::string("production")),
    ("k8s.pod.name", AttributeValue::string("api-gateway-7d4b8c9f-abc")),
    ("k8s.namespace", AttributeValue::string("default"))
  ]
  
  // å¤„ç†ä¸åŒç±»å‹çš„è¯·æ±‚
  let get_attributes = base_attributes + [
    ("http.method", AttributeValue::string("GET")),
    ("http.route", AttributeValue::string("/api/users")),
    ("http.status_code", AttributeValue::int(200L))
  ]
  
  let post_attributes = base_attributes + [
    ("http.method", AttributeValue::string("POST")),
    ("http.route", AttributeValue::string("/api/users")),
    ("http.status_code", AttributeValue::int(201L))
  ]
  
  let error_attributes = base_attributes + [
    ("http.method", AttributeValue::string("GET")),
    ("http.route", AttributeValue::string("/api/nonexistent")),
    ("http.status_code", AttributeValue::int(404L))
  ]
  
  // è®°å½•æŒ‡æ ‡
  request_counter.add(1L, Some(get_attributes))
  request_duration.record(150.0, Some(get_attributes))
  active_connections.add(1L, Some(get_attributes))
  memory_usage.record(1024.0, Some(get_attributes))
  
  request_counter.add(1L, Some(post_attributes))
  request_duration.record(300.0, Some(post_attributes))
  active_connections.add(1L, Some(post_attributes))
  memory_usage.record(2048.0, Some(post_attributes))
  
  request_counter.add(1L, Some(error_attributes))
  request_duration.record(50.0, Some(error_attributes))
  active_connections.add(1L, Some(error_attributes))
  memory_usage.record(512.0, Some(error_attributes))
  
  // æ¨¡æ‹Ÿè¿æ¥å…³é—­
  active_connections.add(-1L, Some(get_attributes))
  active_connections.add(-1L, Some(post_attributes))
  active_connections.add(-1L, Some(error_attributes))
  
  // åœºæ™¯2ï¼šæ‰¹å¤„ç†æ“ä½œ
  let batch_attributes = [
    ("job.name", AttributeValue::string("daily-report")),
    ("job.type", AttributeValue::string("batch")),
    ("job.id", AttributeValue::string("batch-12345")),
    ("worker.id", AttributeValue::string("worker-1"))
  ]
  
  request_counter.add(1000L, Some(batch_attributes))
  request_duration.record(5000.0, Some(batch_attributes))
  active_connections.add(10L, Some(batch_attributes))
  memory_usage.record(10240.0, Some(batch_attributes))
  
  // æ‰¹å¤„ç†å®Œæˆ
  active_connections.add(-10L, Some(batch_attributes))
  memory_usage.record(0.0, Some(batch_attributes))
  
  // åœºæ™¯3ï¼šé”™è¯¯æ¢å¤
  let error_recovery_attributes = [
    ("error.type", AttributeValue::string("DatabaseException")),
    ("error.severity", AttributeValue::string("high")),
    ("retry.count", AttributeValue::int(3L)),
    ("recovery.action", AttributeValue::string("circuit-breaker-open"))
  ]
  
  request_counter.add(-5L, Some(error_recovery_attributes))  // å›æ»šå¤±è´¥çš„è¯·æ±‚
  active_connections.add(-2L, Some(error_recovery_attributes))  // å…³é—­å¼‚å¸¸è¿æ¥
  memory_usage.record(-2048.0, Some(error_recovery_attributes))  // é‡Šæ”¾å†…å­˜
}

test "metrics_performance_aggregation" {
  // æµ‹è¯•æŒ‡æ ‡çš„æ€§èƒ½èšåˆåœºæ™¯
  
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("performance-meter", Some("1.0.0"))
  
  let counter = meter.create_counter("performance.counter", Some("ops"), Some("Performance counter"))
  let histogram = meter.create_histogram("performance.histogram", Some("ms"), Some("Performance histogram"))
  let gauge = meter.create_gauge("performance.gauge", Some("units"), Some("Performance gauge"))
  
  // æµ‹è¯•å¤§é‡æŒ‡æ ‡çš„èšåˆ
  let mut i = 0
  while i < 1000 {
    let attributes = [
      ("iteration", AttributeValue::int(i.to_int64())),
      ("batch", AttributeValue::int((i / 100).to_int64())),
      ("worker", AttributeValue::int((i % 10).to_int64()))
    ]
    
    counter.add(1L, Some(attributes))
    histogram.record(i.to_double(), Some(attributes))
    gauge.record(i.to_double() * 1.5, Some(attributes))
    
    i = i + 1
  }
  
  // æµ‹è¯•ä¸åŒå±æ€§ç»„åˆçš„èšåˆ
  let mut j = 0
  while j < 100 {
    let complex_attributes = [
      ("service.name", AttributeValue::string("service-" + (j % 10).to_string())),
      ("service.version", AttributeValue::string((j / 10 + 1).to_string() + ".0.0")),
      ("environment", AttributeValue::string(if j % 2 == 0 { "prod" } else { "staging" })),
      ("region", AttributeValue::string(["us-east-1", "us-west-2", "eu-west-1", "ap-southeast-1"][j % 4])),
      ("instance.id", AttributeValue::string("instance-" + j.to_string()))
    ]
    
    counter.add(j.to_int64(), Some(complex_attributes))
    histogram.record(j.to_double() * 10.0, Some(complex_attributes))
    gauge.record(j.to_double() * 0.5, Some(complex_attributes))
    
    j = j + 1
  }
}

test "metrics_edge_cases_aggregation" {
  // æµ‹è¯•æŒ‡æ ‡çš„è¾¹ç•Œæƒ…å†µèšåˆ
  
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("edge-case-meter", Some("1.0.0"))
  
  let counter = meter.create_counter("edge.counter", Some("ops"), Some("Edge case counter"))
  let histogram = meter.create_histogram("edge.histogram", Some("ms"), Some("Edge case histogram"))
  let gauge = meter.create_gauge("edge.gauge", Some("units"), Some("Edge case gauge"))
  
  // æµ‹è¯•æå€¼
  counter.add(9223372036854775807L, Some([("value.type", AttributeValue::string("max"))]))
  counter.add(-9223372036854775808L, Some([("value.type", AttributeValue::string("min"))]))
  counter.add(0L, Some([("value.type", AttributeValue::string("zero"))]))
  
  histogram.record(1.7976931348623157e+308, Some([("value.type", AttributeValue::string("max.float"))]))
  histogram.record(-1.7976931348623157e+308, Some([("value.type", AttributeValue::string("min.float"))]))
  histogram.record(0.0, Some([("value.type", AttributeValue::string("zero.float"))]))
  histogram.record(1.0/0.0, Some([("value.type", AttributeValue::string("infinity"))]))
  histogram.record(0.0/0.0, Some([("value.type", AttributeValue::string("nan"))]))
  
  gauge.record(1.7976931348623157e+308, Some([("value.type", AttributeValue::string("gauge.max"))]))
  gauge.record(-1.7976931348623157e+308, Some([("value.type", AttributeValue::string("gauge.min"))]))
  gauge.record(0.0, Some([("value.type", AttributeValue::string("gauge.zero"))]))
  
  // æµ‹è¯•ç‰¹æ®Šå±æ€§å€¼
  let special_attributes = [
    ("empty.string", AttributeValue::string("")),
    ("special.chars", AttributeValue::string("!@#$%^&*()")),
    ("unicode", AttributeValue::string("æµ‹è¯•ğŸš€")),
    ("very.long.key.name.that.exceeds.normal.limits.and.contains.many.words", AttributeValue::string("long.value"))
  ]
  
  counter.add(1L, Some(special_attributes))
  histogram.record(100.0, Some(special_attributes))
  gauge.record(50.0, Some(special_attributes))
  
  // æµ‹è¯•ç©ºå±æ€§æ•°ç»„
  counter.add(1L, None)
  histogram.record(100.0, None)
  gauge.record(50.0, None)
}
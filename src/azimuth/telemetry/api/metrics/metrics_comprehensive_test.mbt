// Metricsæ¨¡å—çš„ç»¼åˆæµ‹è¯•ç”¨ä¾‹
test "instrument_types_enumeration" {
  // æµ‹è¯•æ‰€æœ‰InstrumentTypeæšä¸¾å€¼
  let counter_type = Counter
  let histogram_type = Histogram
  let up_down_counter_type = UpDownCounter
  let gauge_type = Gauge
  let observable_counter_type = ObservableCounter
  let observable_gauge_type = ObservableGauge
  let observable_up_down_counter_type = ObservableUpDownCounter
  
  // éªŒè¯æšä¸¾å€¼ï¼ˆè¿™é‡Œæˆ‘ä»¬ç›´æ¥æ¯”è¾ƒï¼Œå› ä¸ºMoonBitçš„æšä¸¾å¯ä»¥ç›´æ¥æ¯”è¾ƒï¼‰
  // åœ¨å®é™…å®ç°ä¸­ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨æ¨¡å¼åŒ¹é…æ¥éªŒè¯ç±»å‹
  
  // åˆ›å»ºMeasurementæ¥æµ‹è¯•ä¸åŒç±»å‹çš„æŒ‡æ ‡
  let counter_measurement = Measurement::{
    value: 100.0,
    attributes: [
      ("metric.type", AttributeValue::string("counter")),
      ("metric.name", AttributeValue::string("http_requests_total"))
    ]
  }
  
  let histogram_measurement = Measurement::{
    value: 123.45,
    attributes: [
      ("metric.type", AttributeValue::string("histogram")),
      ("metric.name", AttributeValue::string("http_request_duration"))
    ]
  }
  
  let gauge_measurement = Measurement::{
    value: 75.5,
    attributes: [
      ("metric.type", AttributeValue::string("gauge")),
      ("metric.name", AttributeValue::string("cpu_usage"))
    ]
  }
  
  // éªŒè¯Measurementç»“æ„
  assert_eq(counter_measurement.value, 100.0)
  assert_eq(counter_measurement.attributes.length(), 2)
  assert_eq(histogram_measurement.value, 123.45)
  assert_eq(gauge_measurement.value, 75.5)
}

test "counter_instrument_operations" {
  // æµ‹è¯•CounteræŒ‡æ ‡çš„æ“ä½œ
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("test-meter", Some("1.0.0"))
  
  // åˆ›å»ºä¸åŒç±»å‹çš„counter
  let request_counter = meter.create_counter(
    "http_requests_total",
    unit?: "requests",
    description?: "Total number of HTTP requests"
  )
  
  let error_counter = meter.create_counter(
    "http_errors_total",
    unit?: "errors", 
    description?: "Total number of HTTP errors"
  )
  
  // æµ‹è¯•counterçš„addæ“ä½œ
  request_counter.add(1L)
  request_counter.add(5L)
  request_counter.add(10L)
  
  error_counter.add(1L, attributes?: [
    ("error.type", AttributeValue::string("timeout")),
    ("service.name", AttributeValue::string("api-gateway"))
  ])
  
  error_counter.add(1L, attributes?: [
    ("error.type", AttributeValue::string("connection_refused")),
    ("service.name", AttributeValue::string("database"))
  ])
  
  // æµ‹è¯•è´Ÿæ•°å’Œé›¶å€¼ï¼ˆcounteré€šå¸¸åªæ¥å—éè´Ÿå€¼ï¼‰
  request_counter.add(0L)
  
  // æµ‹è¯•å¤§æ•°å€¼
  request_counter.add(9223372036854775807L) // Int64æœ€å¤§å€¼
  
  // éªŒè¯counterç±»å‹ï¼ˆNoopå®ç°ä¸ä¼šå®é™…å­˜å‚¨å€¼ï¼Œä½†æˆ‘ä»¬å¯ä»¥éªŒè¯æ“ä½œä¸ä¼šå‡ºé”™ï¼‰
  assert_eq(true, true) // å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œæµ‹è¯•é€šè¿‡
}

test "histogram_instrument_operations" {
  // æµ‹è¯•HistogramæŒ‡æ ‡çš„æ“ä½œ
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("test-meter")
  
  // åˆ›å»ºhistogram
  let response_time_histogram = meter.create_histogram(
    "http_request_duration_seconds",
    unit?: "seconds",
    description?: "HTTP request duration in seconds"
  )
  
  let payload_size_histogram = meter.create_histogram(
    "http_request_payload_bytes",
    unit?: "bytes",
    description?: "HTTP request payload size in bytes"
  )
  
  // æµ‹è¯•histogramçš„recordæ“ä½œ
  response_time_histogram.record(0.1) // 100ms
  response_time_histogram.record(0.25) // 250ms
  response_time_histogram.record(0.5) // 500ms
  response_time_histogram.record(1.0) // 1s
  response_time_histogram.record(2.5) // 2.5s
  
  // æµ‹è¯•å¸¦å±æ€§çš„è®°å½•
  payload_size_histogram.record(1024.0, attributes?: [
    ("http.method", AttributeValue::string("POST")),
    ("content.type", AttributeValue::string("application/json"))
  ])
  
  payload_size_histogram.record(2048.0, attributes?: [
    ("http.method", AttributeValue::string("GET")),
    ("content.type", AttributeValue::string("text/html"))
  ])
  
  // æµ‹è¯•è¾¹ç•Œå€¼
  response_time_histogram.record(0.0) // é›¶å€¼
  response_time_histogram.record(-1.0) // è´Ÿå€¼ï¼ˆé€šå¸¸ä¸åº”è¯¥è®°å½•è´Ÿå€¼åˆ°histogramï¼‰
  response_time_histogram.record(1.0/0.0) // æ— ç©·å¤§
  response_time_histogram.record(0.0/0.0) // NaN
  
  // æµ‹è¯•æå¤§å€¼
  response_time_histogram.record(999999999.9)
  
  assert_eq(true, true) // å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œæµ‹è¯•é€šè¿‡
}

test "up_down_counter_instrument_operations" {
  // æµ‹è¯•UpDownCounteræŒ‡æ ‡çš„æ“ä½œ
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("test-meter")
  
  // åˆ›å»ºup-down counter
  let active_connections = meter.create_up_down_counter(
    "active_connections",
    unit?: "connections",
    description?: "Current number of active connections"
  )
  
  let memory_usage = meter.create_up_down_counter(
    "memory_usage_bytes",
    unit?: "bytes",
    description?: "Current memory usage in bytes"
  )
  
  // æµ‹è¯•å¢åŠ æ“ä½œ
  active_connections.add(1L) // æ–°è¿æ¥
  active_connections.add(5L) // æ‰¹é‡è¿æ¥
  memory_usage.add(1024L * 1024L) // 1MB
  
  // æµ‹è¯•å‡å°‘æ“ä½œ
  active_connections.add(-1L) // è¿æ¥å…³é—­
  active_connections.add(-3L) // æ‰¹é‡å…³é—­
  memory_usage.add(-512L * 1024L) // é‡Šæ”¾512KB
  
  // æµ‹è¯•é›¶å€¼
  active_connections.add(0L)
  
  // æµ‹è¯•å¤§æ•°å€¼
  active_connections.add(1000000L)
  active_connections.add(-1000000L)
  
  // æµ‹è¯•å¸¦å±æ€§çš„æ“ä½œ
  memory_usage.add(2048L, attributes?: [
    ("memory.type", AttributeValue::string("heap")),
    ("process.id", AttributeValue::int(12345L))
  ])
  
  memory_usage.add(-1024L, attributes?: [
    ("memory.type", AttributeValue::string("stack")),
    ("process.id", AttributeValue::int(12345L))
  ])
  
  assert_eq(true, true) // å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œæµ‹è¯•é€šè¿‡
}

test "gauge_instrument_operations" {
  // æµ‹è¯•GaugeæŒ‡æ ‡çš„æ“ä½œ
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("test-meter")
  
  // åˆ›å»ºgauge
  let cpu_usage = meter.create_gauge(
    "cpu_usage_percent",
    unit?: "percent",
    description?: "Current CPU usage percentage"
  )
  
  let disk_usage = meter.create_gauge(
    "disk_usage_bytes",
    unit?: "bytes", 
    description?: "Current disk usage in bytes"
  )
  
  // æµ‹è¯•gaugeçš„recordæ“ä½œ
  cpu_usage.record(25.5) // 25.5% CPUä½¿ç”¨ç‡
  cpu_usage.record(75.0) // 75% CPUä½¿ç”¨ç‡
  cpu_usage.record(100.0) // 100% CPUä½¿ç”¨ç‡
  
  disk_usage.record(1024.0 * 1024.0 * 1024.0) // 1GB
  disk_usage.record(10.0 * 1024.0 * 1024.0 * 1024.0) // 10GB
  
  // æµ‹è¯•å¸¦å±æ€§çš„è®°å½•
  cpu_usage.record(50.0, attributes?: [
    ("cpu.core", AttributeValue::int(0L)),
    ("host.name", AttributeValue::string("web-server-01"))
  ])
  
  cpu_usage.record(75.0, attributes?: [
    ("cpu.core", AttributeValue::int(1L)),
    ("host.name", AttributeValue::string("web-server-01"))
  ])
  
  // æµ‹è¯•è¾¹ç•Œå€¼
  cpu_usage.record(0.0) // é›¶å€¼
  cpu_usage.record(-10.0) // è´Ÿå€¼ï¼ˆæŸäº›gaugeå¯èƒ½å…è®¸è´Ÿå€¼ï¼‰
  cpu_usage.record(150.0) // è¶…è¿‡100%çš„å€¼
  
  // æµ‹è¯•ç²¾åº¦
  cpu_usage.record(33.3333333333)
  cpu_usage.record(66.6666666666)
  
  assert_eq(true, true) // å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œæµ‹è¯•é€šè¿‡
}

test "meter_provider_and_meter_creation" {
  // æµ‹è¯•MeterProviderå’ŒMeterçš„åˆ›å»º
  
  // åˆ›å»ºå¤šä¸ªMeterProvider
  let provider1 = NoopMeterProvider::{}
  let provider2 = NoopMeterProvider::{}
  
  // ä»ä¸åŒprovideråˆ›å»ºmeter
  let meter1 = provider1.get_meter("service-a", Some("1.0.0"), Some("https://example.com/schema"))
  let meter2 = provider1.get_meter("service-b", Some("2.0.0"))
  let meter3 = provider2.get_meter("service-c")
  
  // éªŒè¯meteråˆ›å»ºï¼ˆNoopå®ç°è¿”å›çš„éƒ½æ˜¯NoopMeterï¼‰
  // åœ¨å®é™…å®ç°ä¸­ï¼Œä¸åŒçš„meterå¯èƒ½æœ‰ä¸åŒçš„é…ç½®
  
  // ä½¿ç”¨meteråˆ›å»ºå„ç§instrument
  let counter1 = meter1.create_counter("counter1")
  let histogram1 = meter1.create_histogram("histogram1", unit?: "ms")
  let up_down_counter1 = meter1.create_up_down_counter("updown1", description?: "TestUpDownCounter")
  let gauge1 = meter1.create_gauge("gauge1", unit?: "percent", description?: "TestGauge")
  
  let counter2 = meter2.create_counter("counter2")
  let histogram2 = meter2.create_histogram("histogram2")
  let up_down_counter2 = meter2.create_up_down_counter("updown2")
  let gauge2 = meter2.create_gauge("gauge2")
  
  // éªŒè¯instrumentåˆ›å»ºæˆåŠŸ
  assert_eq(true, true)
  
  // æµ‹è¯•instrumentæ“ä½œ
  counter1.add(1L)
  histogram1.record(100.0)
  up_down_counter1.add(5L)
  gauge1.record(50.0)
  
  counter2.add(10L)
  histogram2.record(200.0)
  up_down_counter2.add(-5L)
  gauge2.record(75.0)
  
  assert_eq(true, true) // å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œæµ‹è¯•é€šè¿‡
}

test "complex_metric_attributes" {
  // æµ‹è¯•å¤æ‚çš„æŒ‡æ ‡å±æ€§
  
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("complex-test-meter")
  
  // åˆ›å»ºå¸¦æœ‰å¤æ‚å±æ€§çš„counter
  let request_counter = meter.create_counter("http_requests_total")
  
  // åŸºæœ¬å±æ€§
  request_counter.add(1L, attributes?: [
    ("http.method", AttributeValue::string("GET")),
    ("http.status_code", AttributeValue::int(200L)),
    ("http.scheme", AttributeValue::string("https"))
  ])
  
  // å¤æ‚å±æ€§
  request_counter.add(1L, attributes?: [
    ("service.name", AttributeValue::string("payment-service")),
    ("service.version", AttributeValue::string("1.2.3")),
    ("service.namespace", AttributeValue::string("production")),
    ("deployment.environment", AttributeValue::string("prod")),
    ("host.name", AttributeValue::string("web-server-01")),
    ("host.ip", AttributeValue::string("192.168.1.100")),
    ("process.pid", AttributeValue::int(12345L)),
    ("process.cpu.percent", AttributeValue::float(75.5)),
    ("process.healthy", AttributeValue::bool(true)),
    ("tags", AttributeValue::array_string(["web", "api", "critical"])),
    ("ports", AttributeValue::array_int([8080L, 8443L, 9090L])),
    ("cpu.thresholds", AttributeValue::array_float([60.0, 80.0, 95.0])),
    ("feature.flags", AttributeValue::array_bool([true, false, true]))
  ])
  
  // æµ‹è¯•è¾¹ç•Œæƒ…å†µå±æ€§
  request_counter.add(1L, attributes?: [
    ("empty.string", AttributeValue::string("")),
    ("zero.int", AttributeValue::int(0L)),
    ("negative.int", AttributeValue::int(-1L)),
    ("zero.float", AttributeValue::float(0.0)),
    ("negative.float", AttributeValue::float(-1.0)),
    ("false.bool", AttributeValue::bool(false)),
    ("empty.array", AttributeValue::array_string([]))
  ])
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å±æ€§
  request_counter.add(1L, attributes?: [
    ("special.chars", AttributeValue::string("!@#$%^&*()")),
    ("unicode.test", AttributeValue::string("æµ‹è¯•ä¸­æ–‡ğŸš€")),
    ("spaces.in.key", AttributeValue::string("value with spaces")),
    ("dots.in.key", AttributeValue::string("value.with.dots"))
  ])
  
  assert_eq(true, true) // å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œæµ‹è¯•é€šè¿‡
}

test "metric_measurement_edge_cases" {
  // æµ‹è¯•æŒ‡æ ‡æµ‹é‡çš„è¾¹ç•Œæƒ…å†µ
  
  // æµ‹è¯•æå€¼
  let max_int64 = 9223372036854775807L
  let min_int64 = -9223372036854775808L
  
  let meter_provider = NoopMeterProvider::{}
  let meter = meter_provider.get_meter("edge-case-meter")
  
  let counter = meter.create_counter("edge_counter")
  let histogram = meter.create_histogram("edge_histogram")
  let up_down_counter = meter.create_up_down_counter("edge_up_down_counter")
  let gauge = meter.create_gauge("edge_gauge")
  
  // æµ‹è¯•æå¤§å€¼
  counter.add(max_int64)
  histogram.record(max_int64.to_double())
  up_down_counter.add(max_int64)
  gauge.record(max_int64.to_double())
  
  // æµ‹è¯•æå°å€¼
  up_down_counter.add(min_int64)
  histogram.record(min_int64.to_double())
  gauge.record(min_int64.to_double())
  
  // æµ‹è¯•æµ®ç‚¹æ•°è¾¹ç•Œå€¼
  histogram.record(1.7976931348623157e+308) // Doubleæœ€å¤§å€¼
  histogram.record(4.9e-324) // Doubleæœ€å°æ­£å€¼
  histogram.record(-1.7976931348623157e+308) // Doubleæœ€å°å€¼
  
  gauge.record(1.7976931348623157e+308)
  gauge.record(4.9e-324)
  gauge.record(-1.7976931348623157e+308)
  
  // æµ‹è¯•ç‰¹æ®Šæµ®ç‚¹å€¼
  histogram.record(1.0/0.0) // æ­£æ— ç©·
  histogram.record(-1.0/0.0) // è´Ÿæ— ç©·
  histogram.record(0.0/0.0) // NaN
  
  gauge.record(1.0/0.0)
  gauge.record(-1.0/0.0)
  gauge.record(0.0/0.0)
  
  assert_eq(true, true) // å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œæµ‹è¯•é€šè¿‡
}
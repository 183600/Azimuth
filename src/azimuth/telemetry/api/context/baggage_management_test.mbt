// Baggage æ¡ç›®ç®¡ç†é«˜çº§æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•Baggageçš„æ¡ç›®æ·»åŠ ã€è·å–ã€è¦†ç›–å’Œå¤æ‚æ“ä½œ

test "baggage_basic_operations" {
  // æµ‹è¯•Baggageçš„åŸºæœ¬æ“ä½œ
  
  // åˆ›å»ºç©ºBaggage
  let empty_baggage = context::Baggage::empty()
  assert_eq(empty_baggage.entries.length(), 0)
  
  // æµ‹è¯•åœ¨ç©ºBaggageä¸­è·å–å€¼
  match empty_baggage.get("non-existent-key") {
    None => assert_eq(true, true)
    Some(_) => assert_eq(false, true)
  }
  
  // æ·»åŠ æ¡ç›®åˆ°Baggage
  let baggage_with_entry = empty_baggage.with_entry("user.id", "user-12345")
  assert_eq(baggage_with_entry.entries.length(), 1)
  
  // éªŒè¯æ·»åŠ çš„æ¡ç›®
  match baggage_with_entry.get("user.id") {
    Some(value) => assert_eq(value, "user-12345")
    None => assert_eq(false, true)
  }
  
  // éªŒè¯å…¶ä»–é”®ä»ç„¶æ²¡æœ‰å€¼
  match baggage_with_entry.get("session.id") {
    None => assert_eq(true, true)
    Some(_) => assert_eq(false, true)
  }
}

test "baggage_multiple_entries_management" {
  // æµ‹è¯•Baggageçš„å¤šæ¡ç›®ç®¡ç†
  
  let empty_baggage = context::Baggage::empty()
  
  // æ·»åŠ å¤šä¸ªæ¡ç›®
  let baggage1 = empty_baggage.with_entry("user.id", "user-123")
  let baggage2 = baggage1.with_entry("session.id", "session-abc")
  let baggage3 = baggage2.with_entry("request.id", "req-456")
  let baggage4 = baggage3.with_entry("trace.id", "trace-789")
  
  // éªŒè¯æ¡ç›®æ•°é‡
  assert_eq(baggage1.entries.length(), 1)
  assert_eq(baggage2.entries.length(), 2)
  assert_eq(baggage3.entries.length(), 3)
  assert_eq(baggage4.entries.length(), 4)
  
  // éªŒè¯æ‰€æœ‰æ¡ç›®éƒ½å¯ä»¥è®¿é—®
  match baggage4.get("user.id") {
    Some(value) => assert_eq(value, "user-123")
    None => assert_eq(false, true)
  }
  
  match baggage4.get("session.id") {
    Some(value) => assert_eq(value, "session-abc")
    None => assert_eq(false, true)
  }
  
  match baggage4.get("request.id") {
    Some(value) => assert_eq(value, "req-456")
    None => assert_eq(false, true)
  }
  
  match baggage4.get("trace.id") {
    Some(value) => assert_eq(value, "trace-789")
    None => assert_eq(false, true)
  }
  
  // éªŒè¯ä¸­é—´Baggageçš„æ¡ç›®
  match baggage2.get("user.id") {
    Some(value) => assert_eq(value, "user-123")
    None => assert_eq(false, true)
  }
  
  match baggage2.get("request.id") {
    None => assert_eq(true, true)  // baggage2ä¸­æ²¡æœ‰request.id
    Some(_) => assert_eq(false, true)
  }
}

test "baggage_entry_override_operations" {
  // æµ‹è¯•Baggageæ¡ç›®çš„è¦†ç›–æ“ä½œ
  
  let empty_baggage = context::Baggage::empty()
  
  // æ·»åŠ åˆå§‹æ¡ç›®
  let baggage1 = empty_baggage.with_entry("user.id", "user-123")
  let baggage2 = baggage1.with_entry("status", "pending")
  
  // éªŒè¯åˆå§‹æ¡ç›®
  match baggage2.get("user.id") {
    Some(value) => assert_eq(value, "user-123")
    None => assert_eq(false, true)
  }
  
  match baggage2.get("status") {
    Some(value) => assert_eq(value, "pending")
    None => assert_eq(false, true)
  }
  
  // è¦†ç›–ç°æœ‰æ¡ç›®
  let baggage3 = baggage2.with_entry("user.id", "user-456")
  let baggage4 = baggage3.with_entry("status", "completed")
  
  // éªŒè¯è¦†ç›–åçš„æ¡ç›®
  match baggage4.get("user.id") {
    Some(value) => assert_eq(value, "user-456")  // æ–°å€¼
    None => assert_eq(false, true)
  }
  
  match baggage4.get("status") {
    Some(value) => assert_eq(value, "completed")  // æ–°å€¼
    None => assert_eq(false, true)
  }
  
  // éªŒè¯æ¡ç›®æ•°é‡
  assert_eq(baggage2.entries.length(), 2)
  assert_eq(baggage4.entries.length(), 2)  // è¦†ç›–ä¸ä¼šå¢åŠ æ•°é‡
  
  // å¤šæ¬¡è¦†ç›–åŒä¸€ä¸ªæ¡ç›®
  let baggage5 = baggage4.with_entry("user.id", "user-789")
  let baggage6 = baggage5.with_entry("user.id", "user-999")
  
  match baggage6.get("user.id") {
    Some(value) => assert_eq(value, "user-999")  // æœ€ç»ˆå€¼
    None => assert_eq(false, true)
  }
  
  assert_eq(baggage6.entries.length(), 2)  // æ•°é‡ä»ç„¶ä¸å˜
}

test "baggage_complex_scenarios" {
  // æµ‹è¯•Baggageçš„å¤æ‚åœºæ™¯
  
  let empty_baggage = context::Baggage::empty()
  
  // æ„å»ºå¤æ‚çš„Baggageå±‚æ¬¡ç»“æ„
  let user_baggage = empty_baggage
    .with_entry("user.id", "user-12345")
    .with_entry("user.name", "John Doe")
    .with_entry("user.role", "admin")
  
  let session_baggage = user_baggage
    .with_entry("session.id", "session-abcdef")
    .with_entry("correlation.id", "corr-123456")
  
  let request_baggage = session_baggage
    .with_entry("request.id", "req-789012")
    .with_entry("request.path", "/api/users")
    .with_entry("request.method", "GET")
  
  let trace_baggage = request_baggage
    .with_entry("trace.id", "trace-345678")
    .with_entry("span.id", "span-901234")
    .with_entry("service.name", "user-service")
  
  // éªŒè¯æœ€ç»ˆçš„BaggageåŒ…å«æ‰€æœ‰æ¡ç›®
  assert_eq(trace_baggage.entries.length(), 10)
  
  // éªŒè¯ç”¨æˆ·ç›¸å…³æ¡ç›®
  match trace_baggage.get("user.id") {
    Some(value) => assert_eq(value, "user-12345")
    None => assert_eq(false, true)
  }
  
  match trace_baggage.get("user.name") {
    Some(value) => assert_eq(value, "John Doe")
    None => assert_eq(false, true)
  }
  
  match trace_baggage.get("user.role") {
    Some(value) => assert_eq(value, "admin")
    None => assert_eq(false, true)
  }
  
  // éªŒè¯ä¼šè¯ç›¸å…³æ¡ç›®
  match trace_baggage.get("session.id") {
    Some(value) => assert_eq(value, "session-abcdef")
    None => assert_eq(false, true)
  }
  
  match trace_baggage.get("correlation.id") {
    Some(value) => assert_eq(value, "corr-123456")
    None => assert_eq(false, true)
  }
  
  // éªŒè¯è¯·æ±‚ç›¸å…³æ¡ç›®
  match trace_baggage.get("request.id") {
    Some(value) => assert_eq(value, "req-789012")
    None => assert_eq(false, true)
  }
  
  match trace_baggage.get("request.path") {
    Some(value) => assert_eq(value, "/api/users")
    None => assert_eq(false, true)
  }
  
  match trace_baggage.get("request.method") {
    Some(value) => assert_eq(value, "GET")
    None => assert_eq(false, true)
  }
  
  // éªŒè¯è¿½è¸ªç›¸å…³æ¡ç›®
  match trace_baggage.get("trace.id") {
    Some(value) => assert_eq(value, "trace-345678")
    None => assert_eq(false, true)
  }
  
  match trace_baggage.get("span.id") {
    Some(value) => assert_eq(value, "span-901234")
    None => assert_eq(false, true)
  }
  
  match trace_baggage.get("service.name") {
    Some(value) => assert_eq(value, "user-service")
    None => assert_eq(false, true)
  }
  
  // éªŒè¯ä¸­é—´Baggageçš„å®Œæ•´æ€§
  assert_eq(user_baggage.entries.length(), 3)
  assert_eq(session_baggage.entries.length(), 5)
  assert_eq(request_baggage.entries.length(), 8)
  assert_eq(trace_baggage.entries.length(), 10)
}

test "baggage_edge_cases_and_special_values" {
  // æµ‹è¯•Baggageçš„è¾¹ç•Œæƒ…å†µå’Œç‰¹æ®Šå€¼
  
  let empty_baggage = context::Baggage::empty()
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²é”®å’Œå€¼
  let baggage_empty_key = empty_baggage.with_entry("", "empty-key-value")
  match baggage_empty_key.get("") {
    Some(value) => assert_eq(value, "empty-key-value")
    None => assert_eq(false, true)
  }
  
  let baggage_empty_value = empty_baggage.with_entry("empty-value", "")
  match baggage_empty_value.get("empty-value") {
    Some(value) => {
      assert_eq(value, "")
      assert_eq(value.length(), 0)
    }
    None => assert_eq(false, true)
  }
  
  // æµ‹è¯•é•¿å­—ç¬¦ä¸²é”®å’Œå€¼
  let long_key = "this.is.a.very.long.key.name.with.many.dots.and.words.that.exceeds.normal.lengths"
  let long_value = "this.is.a.very.long.value.with.many.words.and.special.characters!@#$%^&*()_+-=[]{}|;':\",./<>?"
  
  let baggage_long = empty_baggage.with_entry(long_key, long_value)
  match baggage_long.get(long_key) {
    Some(value) => assert_eq(value, long_value)
    None => assert_eq(false, true)
  }
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦é”®å’Œå€¼
  let special_key = "special.key!@#$%^&*()"
  let special_value = "special.value!@#$%^&*()_+-=[]{}|;':\",./<>?"
  
  let baggage_special = empty_baggage.with_entry(special_key, special_value)
  match baggage_special.get(special_key) {
    Some(value) => assert_eq(value, special_value)
    None => assert_eq(false, true)
  }
  
  // æµ‹è¯•Unicodeå­—ç¬¦
  let unicode_key = "unicode.é”®"
  let unicode_value = "unicode.å€¼.ğŸŒŸ"
  
  let baggage_unicode = empty_baggage.with_entry(unicode_key, unicode_value)
  match baggage_unicode.get(unicode_key) {
    Some(value) => assert_eq(value, unicode_value)
    None => assert_eq(false, true)
  }
  
  // æµ‹è¯•æ•°å­—å­—ç¬¦ä¸²
  let numeric_key = "123.numeric.key"
  let numeric_value = "456.789"
  
  let baggage_numeric = empty_baggage.with_entry(numeric_key, numeric_value)
  match baggage_numeric.get(numeric_key) {
    Some(value) => assert_eq(value, numeric_value)
    None => assert_eq(false, true)
  }
  
  // æµ‹è¯•JSONå­—ç¬¦ä¸²
  let json_key = "json.data"
  let json_value = "{\"user\":\"john\",\"age\":30,\"active\":true}"
  
  let baggage_json = empty_baggage.with_entry(json_key, json_value)
  match baggage_json.get(json_key) {
    Some(value) => assert_eq(value, json_value)
    None => assert_eq(false, true)
  }
  
  // æµ‹è¯•URLç¼–ç çš„å€¼
  let url_key = "url.parameter"
  let url_value = "name%3DJohn%20Doe%26age%3D30"
  
  let baggage_url = empty_baggage.with_entry(url_key, url_value)
  match baggage_url.get(url_key) {
    Some(value) => assert_eq(value, url_value)
    None => assert_eq(false, true)
  }
}

test "baggage_large_scale_operations" {
  // æµ‹è¯•Baggageçš„å¤§è§„æ¨¡æ“ä½œ
  
  let empty_baggage = context::Baggage::empty()
  
  // åˆ›å»ºå¤§é‡æ¡ç›®
  let mut current_baggage = empty_baggage
  let mut index = 0
  while index < 100 {
    let key = "bulk.key." + index.to_string()
    let value = "bulk.value." + index.to_string()
    current_baggage = current_baggage.with_entry(key, value)
    index = index + 1
  }
  
  // éªŒè¯æ‰€æœ‰æ¡ç›®éƒ½å­˜åœ¨
  assert_eq(current_baggage.entries.length(), 100)
  
  // éšæœºè®¿é—®ä¸€äº›æ¡ç›®
  match current_baggage.get("bulk.key.0") {
    Some(value) => assert_eq(value, "bulk.value.0")
    None => assert_eq(false, true)
  }
  
  match current_baggage.get("bulk.key.49") {
    Some(value) => assert_eq(value, "bulk.value.49")
    None => assert_eq(false, true)
  }
  
  match current_baggage.get("bulk.key.99") {
    Some(value) => assert_eq(value, "bulk.value.99")
    None => assert_eq(false, true)
  }
  
  // æµ‹è¯•åœ¨å¤§è§„æ¨¡Baggageä¸­è¦†ç›–æ¡ç›®
  let updated_baggage = current_baggage.with_entry("bulk.key.50", "updated.bulk.value.50")
  
  match updated_baggage.get("bulk.key.50") {
    Some(value) => assert_eq(value, "updated.bulk.value.50")
    None => assert_eq(false, true)
  }
  
  // éªŒè¯è¦†ç›–åæ•°é‡ä¸å˜
  assert_eq(updated_baggage.entries.length(), 100)
  
  // éªŒè¯å…¶ä»–æ¡ç›®ä¸å—å½±å“
  match updated_baggage.get("bulk.key.49") {
    Some(value) => assert_eq(value, "bulk.value.49")
    None => assert_eq(false, true)
  }
  
  match updated_baggage.get("bulk.key.51") {
    Some(value) => assert_eq(value, "bulk.value.51")
    None => assert_eq(false, true)
  }
  
  // æµ‹è¯•ä»å¤§è§„æ¨¡Baggageä¸­æ·»åŠ æ›´å¤šæ¡ç›®
  let expanded_baggage = updated_baggage
    .with_entry("new.key.1", "new.value.1")
    .with_entry("new.key.2", "new.value.2")
    .with_entry("new.key.3", "new.value.3")
  
  assert_eq(expanded_baggage.entries.length(), 103)
  
  // éªŒè¯æ–°æ¡ç›®å­˜åœ¨
  match expanded_baggage.get("new.key.1") {
    Some(value) => assert_eq(value, "new.value.1")
    None => assert_eq(false, true)
  }
  
  // éªŒè¯åŸæœ‰æ¡ç›®ä»ç„¶å­˜åœ¨
  match expanded_baggage.get("bulk.key.25") {
    Some(value) => assert_eq(value, "bulk.value.25")
    None => assert_eq(false, true)
  }
}

test "baggage_real_world_usage_patterns" {
  // æµ‹è¯•Baggageçš„å®é™…ä½¿ç”¨æ¨¡å¼
  
  let empty_baggage = context::Baggage::empty()
  
  // æ¨¡æ‹Ÿå¾®æœåŠ¡é“¾ä¸­çš„Baggageä¼ æ’­
  let gateway_baggage = empty_baggage
    .with_entry("request.id", "req-12345")
    .with_entry("user.id", "user-67890")
    .with_entry("correlation.id", "corr-abcdef")
    .with_entry("client.version", "1.2.3")
  
  // AuthæœåŠ¡æ·»åŠ è®¤è¯ç›¸å…³ä¿¡æ¯
  let auth_baggage = gateway_baggage
    .with_entry("auth.method", "oauth2")
    .with_entry("auth.scope", "read:write")
    .with_entry("auth.expires", "2023-12-31T23:59:59Z")
  
  // BusinessæœåŠ¡æ·»åŠ ä¸šåŠ¡ç›¸å…³ä¿¡æ¯
  let business_baggage = auth_baggage
    .with_entry("business.unit", "ecommerce")
    .with_entry("tenant.id", "tenant-111")
    .with_entry("feature.flags", "new-ui,advanced-search")
  
  // DataæœåŠ¡æ·»åŠ æ•°æ®è®¿é—®ç›¸å…³ä¿¡æ¯
  let data_baggage = business_baggage
    .with_entry("db.query.type", "SELECT")
    .with_entry("db.table", "orders")
    .with_entry("cache.hit", "true")
    .with_entry("data.latency", "15ms")
  
  // éªŒè¯æœ€ç»ˆBaggageåŒ…å«æ‰€æœ‰ä¿¡æ¯
  assert_eq(data_baggage.entries.length(), 14)
  
  // éªŒè¯ç½‘å…³å±‚ä¿¡æ¯
  match data_baggage.get("request.id") {
    Some(value) => assert_eq(value, "req-12345")
    None => assert_eq(false, true)
  }
  
  match data_baggage.get("user.id") {
    Some(value) => assert_eq(value, "user-67890")
    None => assert_eq(false, true)
  }
  
  // éªŒè¯è®¤è¯å±‚ä¿¡æ¯
  match data_baggage.get("auth.method") {
    Some(value) => assert_eq(value, "oauth2")
    None => assert_eq(false, true)
  }
  
  match data_baggage.get("auth.scope") {
    Some(value) => assert_eq(value, "read:write")
    None => assert_eq(false, true)
  }
  
  // éªŒè¯ä¸šåŠ¡å±‚ä¿¡æ¯
  match data_baggage.get("business.unit") {
    Some(value) => assert_eq(value, "ecommerce")
    None => assert_eq(false, true)
  }
  
  match data_baggage.get("feature.flags") {
    Some(value) => assert_eq(value, "new-ui,advanced-search")
    None => assert_eq(false, true)
  }
  
  // éªŒè¯æ•°æ®å±‚ä¿¡æ¯
  match data_baggage.get("db.query.type") {
    Some(value) => assert_eq(value, "SELECT")
    None => assert_eq(false, true)
  }
  
  match data_baggage.get("cache.hit") {
    Some(value) => assert_eq(value, "true")
    None => assert_eq(false, true)
  }
  
  match data_baggage.get("data.latency") {
    Some(value) => assert_eq(value, "15ms")
    None => assert_eq(false, true)
  }
  
  // æµ‹è¯•åœ¨ä¸åŒæœåŠ¡çº§åˆ«çš„Baggageå®Œæ•´æ€§
  assert_eq(gateway_baggage.entries.length(), 4)
  assert_eq(auth_baggage.entries.length(), 7)
  assert_eq(business_baggage.entries.length(), 10)
  assert_eq(data_baggage.entries.length(), 14)
  
  // æµ‹è¯•æ¡ä»¶æ€§Baggageæ›´æ–°ï¼ˆæ¨¡æ‹ŸA/Bæµ‹è¯•ï¼‰
  let experimental_baggage = data_baggage.with_entry("experiment.name", "new-algorithm")
  match experimental_baggage.get("experiment.name") {
    Some(value) => assert_eq(value, "new-algorithm")
    None => assert_eq(false, true)
  }
  
  assert_eq(experimental_baggage.entries.length(), 15)
}
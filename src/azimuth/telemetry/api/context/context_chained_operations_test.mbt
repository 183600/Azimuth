// Context API ä¸Šä¸‹æ–‡é“¾å¼æ“ä½œæµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•ä¸Šä¸‹æ–‡çš„é“¾å¼åˆ›å»ºã€ä¿®æ”¹å’ŒæŸ¥è¯¢åŠŸèƒ½

test "context_chained_operations" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡é“¾å¼æ“ä½œ
  
  // åˆ›å»ºç©ºä¸Šä¸‹æ–‡
  let ctx = Context::empty()
  
  // åˆ›å»ºä¸Šä¸‹æ–‡é”®
  let user_key = create_key("user")
  let request_id_key = create_key("request_id")
  let trace_id_key = create_key("trace_id")
  let service_key = create_key("service")
  
  // é“¾å¼è®¾ç½®å¤šä¸ªå€¼
  let ctx_with_user = ctx.with_value(user_key, "alice")
  let ctx_with_request = ctx_with_user.with_value(request_id_key, "req-12345")
  let ctx_with_trace = ctx_with_request.with_value(trace_id_key, "trace-67890")
  let ctx_with_service = ctx_with_trace.with_value(service_key, "auth-service")
  
  // éªŒè¯é“¾å¼æ“ä½œç»“æœ
  match ctx_with_user.get(user_key) {
    Some(user) => assert_eq(user, "alice")
    None => @test.fail("Expected user value")
  }
  
  match ctx_with_request.get(request_id_key) {
    Some(request_id) => assert_eq(request_id, "req-12345")
    None => @test.fail("Expected request_id value")
  }
  
  match ctx_with_trace.get(trace_id_key) {
    Some(trace_id) => assert_eq(trace_id, "trace-67890")
    None => @test.fail("Expected trace_id value")
  }
  
  match ctx_with_service.get(service_key) {
    Some(service) => assert_eq(service, "auth-service")
    None => @test.fail("Expected service value")
  }
  
  // éªŒè¯åŸå§‹ä¸Šä¸‹æ–‡æœªå—å½±å“
  match ctx.get(user_key) {
    None => assert_eq(true, true)
    Some(_) => @test.fail("Original context should not have user value")
  }
  
  match ctx.get(request_id_key) {
    None => assert_eq(true, true)
    Some(_) => @test.fail("Original context should not have request_id value")
  }
}

test "context_nested_chained_operations" {
  // æµ‹è¯•åµŒå¥—ä¸Šä¸‹æ–‡é“¾å¼æ“ä½œ
  
  // åˆ›å»ºåŸºç¡€ä¸Šä¸‹æ–‡
  let base_ctx = Context::empty()
  
  // åˆ›å»ºä¸Šä¸‹æ–‡é”®
  let auth_key = create_key("auth")
  let user_key = create_key("user")
  let session_key = create_key("session")
  let request_key = create_key("request")
  let trace_key = create_key("trace")
  
  // ç¬¬ä¸€å±‚ï¼šè®¤è¯ä¸Šä¸‹æ–‡
  let auth_ctx = base_ctx
    .with_value(auth_key, "bearer-token-123")
    .with_value(user_key, "bob")
    .with_value(session_key, "session-456")
  
  // ç¬¬äºŒå±‚ï¼šè¯·æ±‚ä¸Šä¸‹æ–‡ï¼ˆåŸºäºè®¤è¯ä¸Šä¸‹æ–‡ï¼‰
  let request_ctx = auth_ctx
    .with_value(request_key, "GET /api/users")
    .with_value(trace_key, "trace-789")
  
  // éªŒè¯ç¬¬ä¸€å±‚ä¸Šä¸‹æ–‡
  match auth_ctx.get(auth_key) {
    Some(auth) => assert_eq(auth, "bearer-token-123")
    None => @test.fail("Expected auth value")
  }
  
  match auth_ctx.get(user_key) {
    Some(user) => assert_eq(user, "bob")
    None => @test.fail("Expected user value")
  }
  
  match auth_ctx.get(session_key) {
    Some(session) => assert_eq(session, "session-456")
    None => @test.fail("Expected session value")
  }
  
  match auth_ctx.get(request_key) {
    None => assert_eq(true, true)
    Some(_) => @test.fail("Auth context should not have request value")
  }
  
  // éªŒè¯ç¬¬äºŒå±‚ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«ç¬¬ä¸€å±‚çš„å€¼ï¼‰
  match request_ctx.get(auth_key) {
    Some(auth) => assert_eq(auth, "bearer-token-123")
    None => @test.fail("Expected auth value in request context")
  }
  
  match request_ctx.get(user_key) {
    Some(user) => assert_eq(user, "bob")
    None => @test.fail("Expected user value in request context")
  }
  
  match request_ctx.get(session_key) {
    Some(session) => assert_eq(session, "session-456")
    None => @test.fail("Expected session value in request context")
  }
  
  match request_ctx.get(request_key) {
    Some(request) => assert_eq(request, "GET /api/users")
    None => @test.fail("Expected request value")
  }
  
  match request_ctx.get(trace_key) {
    Some(trace) => assert_eq(trace, "trace-789")
    None => @test.fail("Expected trace value")
  }
}

test "context_chained_value_overriding" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡é“¾å¼æ“ä½œä¸­çš„å€¼è¦†ç›–
  
  // åˆ›å»ºä¸Šä¸‹æ–‡å’Œé”®
  let ctx = Context::empty()
  let key = create_key("override-test")
  
  // é“¾å¼è®¾ç½®å¤šä¸ªå€¼ï¼Œè¦†ç›–åŒä¸€ä¸ªé”®
  let ctx1 = ctx.with_value(key, "value1")
  let ctx2 = ctx1.with_value(key, "value2")
  let ctx3 = ctx2.with_value(key, "value3")
  
  // éªŒè¯æ¯ä¸ªä¸Šä¸‹æ–‡çš„çŠ¶æ€
  match ctx1.get(key) {
    Some(value) => assert_eq(value, "value1")
    None => @test.fail("Expected value1")
  }
  
  match ctx2.get(key) {
    Some(value) => assert_eq(value, "value2")
    None => @test.fail("Expected value2")
  }
  
  match ctx3.get(key) {
    Some(value) => assert_eq(value, "value3")
    None => @test.fail("Expected value3")
  }
  
  // éªŒè¯åŸå§‹ä¸Šä¸‹æ–‡æœªå—å½±å“
  match ctx.get(key) {
    None => assert_eq(true, true)
    Some(_) => @test.fail("Original context should not have any value")
  }
  
  // éªŒè¯ä¸Šä¸‹æ–‡é“¾çš„ç‹¬ç«‹æ€§
  match ctx1.get(key) {
    Some(value) => assert_eq(value, "value1")  // ctx1åº”è¯¥ä»ç„¶æ˜¯value1
    None => @test.fail("Expected value1 in ctx1")
  }
}

test "context_chained_baggage_operations" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡é“¾å¼æ“ä½œä¸baggageçš„ç»“åˆ
  
  // åˆ›å»ºä¸Šä¸‹æ–‡å’Œbaggage
  let ctx = Context::empty()
  let baggage = Baggage::empty()
  
  // é“¾å¼æ·»åŠ baggageæ¡ç›®
  let baggage1 = baggage.with_entry("user-id", "12345")
  let baggage2 = baggage1.with_entry("region", "us-east")
  let baggage3 = baggage2.with_entry("version", "v1.2.3")
  
  // éªŒè¯baggageé“¾å¼æ“ä½œ
  match baggage1.get("user-id") {
    Some(user_id) => assert_eq(user_id, "12345")
    None => @test.fail("Expected user-id in baggage1")
  }
  
  match baggage1.get("region") {
    None => assert_eq(true, true)
    Some(_) => @test.fail("baggage1 should not have region")
  }
  
  match baggage2.get("user-id") {
    Some(user_id) => assert_eq(user_id, "12345")
    None => @test.fail("Expected user-id in baggage2")
  }
  
  match baggage2.get("region") {
    Some(region) => assert_eq(region, "us-east")
    None => @test.fail("Expected region in baggage2")
  }
  
  match baggage3.get("user-id") {
    Some(user_id) => assert_eq(user_id, "12345")
    None => @test.fail("Expected user-id in baggage3")
  }
  
  match baggage3.get("region") {
    Some(region) => assert_eq(region, "us-east")
    None => @test.fail("Expected region in baggage3")
  }
  
  match baggage3.get("version") {
    Some(version) => assert_eq(version, "v1.2.3")
    None => @test.fail("Expected version in baggage3")
  }
  
  // éªŒè¯åŸå§‹baggageæœªå—å½±å“
  match baggage.get("user-id") {
    None => assert_eq(true, true)
    Some(_) => @test.fail("Original baggage should not have user-id")
  }
}

test "context_complex_chained_scenario" {
  // æµ‹è¯•å¤æ‚çš„ä¸Šä¸‹æ–‡é“¾å¼æ“ä½œåœºæ™¯
  
  // æ¨¡æ‹Ÿå¾®æœåŠ¡è°ƒç”¨é“¾
  let base_ctx = Context::empty()
  
  // åˆ›å»ºå„ç§é”®
  let trace_id_key = create_key("trace_id")
  let span_id_key = create_key("span_id")
  let user_id_key = create_key("user_id")
  let auth_token_key = create_key("auth_token")
  let service_name_key = create_key("service_name")
  let operation_key = create_key("operation")
  let request_id_key = create_key("request_id")
  let correlation_id_key = create_key("correlation_id")
  
  // ç¬¬ä¸€å±‚ï¼šç½‘å…³å±‚ä¸Šä¸‹æ–‡
  let gateway_ctx = base_ctx
    .with_value(trace_id_key, "trace-abc123")
    .with_value(user_id_key, "user-789")
    .with_value(request_id_key, "req-gateway-001")
    .with_value(correlation_id_key, "corr-xyz789")
  
  // ç¬¬äºŒå±‚ï¼šè®¤è¯æœåŠ¡ä¸Šä¸‹æ–‡
  let auth_ctx = gateway_ctx
    .with_value(span_id_key, "span-auth-001")
    .with_value(auth_token_key, "jwt-token-456")
    .with_value(service_name_key, "auth-service")
    .with_value(operation_key, "validate-token")
  
  // ç¬¬ä¸‰å±‚ï¼šç”¨æˆ·æœåŠ¡ä¸Šä¸‹æ–‡
  let user_ctx = auth_ctx
    .with_value(span_id_key, "span-user-001")
    .with_value(service_name_key, "user-service")
    .with_value(operation_key, "get-user-profile")
    .with_value(request_id_key, "req-user-002")
  
  // éªŒè¯ç½‘å…³å±‚ä¸Šä¸‹æ–‡
  match gateway_ctx.get(trace_id_key) {
    Some(trace_id) => assert_eq(trace_id, "trace-abc123")
    None => @test.fail("Expected trace_id in gateway context")
  }
  
  match gateway_ctx.get(user_id_key) {
    Some(user_id) => assert_eq(user_id, "user-789")
    None => @test.fail("Expected user_id in gateway context")
  }
  
  match gateway_ctx.get(span_id_key) {
    None => assert_eq(true, true)
    Some(_) => @test.fail("Gateway context should not have span_id")
  }
  
  // éªŒè¯è®¤è¯æœåŠ¡ä¸Šä¸‹æ–‡
  match auth_ctx.get(trace_id_key) {
    Some(trace_id) => assert_eq(trace_id, "trace-abc123")
    None => @test.fail("Expected trace_id in auth context")
  }
  
  match auth_ctx.get(span_id_key) {
    Some(span_id) => assert_eq(span_id, "span-auth-001")
    None => @test.fail("Expected span_id in auth context")
  }
  
  match auth_ctx.get(service_name_key) {
    Some(service) => assert_eq(service, "auth-service")
    None => @test.fail("Expected service_name in auth context")
  }
  
  // éªŒè¯ç”¨æˆ·æœåŠ¡ä¸Šä¸‹æ–‡
  match user_ctx.get(trace_id_key) {
    Some(trace_id) => assert_eq(trace_id, "trace-abc123")
    None => @test.fail("Expected trace_id in user context")
  }
  
  match user_ctx.get(span_id_key) {
    Some(span_id) => assert_eq(span_id, "span-user-001")
    None => @test.fail("Expected span_id in user context")
  }
  
  match user_ctx.get(service_name_key) {
    Some(service) => assert_eq(service, "user-service")
    None => @test.fail("Expected service_name in user context")
  }
  
  match user_ctx.get(request_id_key) {
    Some(request_id) => assert_eq(request_id, "req-user-002")
    None => @test.fail("Expected request_id in user context")
  }
  
  // éªŒè¯ä¸Šä¸‹æ–‡é“¾çš„ç‹¬ç«‹æ€§
  match auth_ctx.get(span_id_key) {
    Some(span_id) => assert_eq(span_id, "span-auth-001")  // åº”è¯¥ä»ç„¶æ˜¯authçš„span_id
    None => @test.fail("Expected span_id in auth context")
  }
  
  match auth_ctx.get(service_name_key) {
    Some(service) => assert_eq(service, "auth-service")  // åº”è¯¥ä»ç„¶æ˜¯auth-service
    None => @test.fail("Expected service_name in auth context")
  }
}

test "context_chained_performance_characteristics" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡é“¾å¼æ“ä½œçš„æ€§èƒ½ç‰¹å¾
  
  // åˆ›å»ºä¸Šä¸‹æ–‡å’Œé”®
  let ctx = Context::empty()
  let keys = []
  let mut i = 0
  
  // åˆ›å»ºå¤šä¸ªé”®
  while i < 100 {
    keys.push(create_key("key-" + i.to_string()))
    i = i + 1
  }
  
  // é“¾å¼è®¾ç½®å¤šä¸ªå€¼
  let mut current_ctx = ctx
  let mut j = 0
  while j < keys.length() {
    current_ctx = current_ctx.with_value(keys[j], "value-" + j.to_string())
    j = j + 1
  }
  
  // éªŒè¯æ‰€æœ‰å€¼éƒ½å¯ä»¥æ­£ç¡®è·å–
  let mut k = 0
  while k < keys.length() {
    match current_ctx.get(keys[k]) {
      Some(value) => assert_eq(value, "value-" + k.to_string())
      None => @test.fail("Expected value for key-" + k.to_string())
    }
    k = k + 1
  }
  
  // éªŒè¯æ·±åº¦é“¾å¼æ“ä½œçš„æ€§èƒ½
  let start_time = 1640995200000L
  let mut deep_ctx = ctx
  let mut m = 0
  while m < 1000 {
    let temp_key = create_key("deep-key-" + m.to_string())
    deep_ctx = deep_ctx.with_value(temp_key, "deep-value-" + m.to_string())
    m = m + 1
  }
  
  // éªŒè¯æ·±åº¦é“¾å¼æ“ä½œçš„ç»“æœ
  let first_key = create_key("deep-key-0")
  let last_key = create_key("deep-key-999")
  
  match deep_ctx.get(first_key) {
    Some(value) => assert_eq(value, "deep-value-0")
    None => @test.fail("Expected deep-value-0")
  }
  
  match deep_ctx.get(last_key) {
    Some(value) => assert_eq(value, "deep-value-999")
    None => @test.fail("Expected deep-value-999")
  }
  
  // éªŒè¯ä¸­é—´å€¼
  let middle_key = create_key("deep-key-500")
  match deep_ctx.get(middle_key) {
    Some(value) => assert_eq(value, "deep-value-500")
    None => @test.fail("Expected deep-value-500")
  }
}

test "context_chained_error_handling" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡é“¾å¼æ“ä½œçš„é”™è¯¯å¤„ç†
  
  // åˆ›å»ºä¸Šä¸‹æ–‡
  let ctx = Context::empty()
  
  // æµ‹è¯•ç©ºé”®å’Œç©ºå€¼
  let empty_key = create_key("")
  let normal_key = create_key("normal")
  
  // è®¾ç½®ç©ºé”®çš„å€¼
  let ctx_with_empty_key = ctx.with_value(empty_key, "value-with-empty-key")
  
  // éªŒè¯ç©ºé”®å¯ä»¥æ­£å¸¸å·¥ä½œ
  match ctx_with_empty_key.get(empty_key) {
    Some(value) => assert_eq(value, "value-with-empty-key")
    None => @test.fail("Expected value for empty key")
  }
  
  // è®¾ç½®ç©ºå€¼
  let ctx_with_empty_value = ctx.with_value(normal_key, "")
  
  // éªŒè¯ç©ºå€¼å¯ä»¥æ­£å¸¸å·¥ä½œ
  match ctx_with_empty_value.get(normal_key) {
    Some(value) => assert_eq(value, "")
    None => @test.fail("Expected empty value")
  }
  
  // æµ‹è¯•é•¿é”®å’Œé•¿å€¼
  let long_key_name = "this-is-a-very-long-key-name-that-might-potentially-cause-issues-in-some-implementations"
  let long_key = create_key(long_key_name)
  let long_value = "this-is-a-very-long-value-that-might-potentially-cause-issues-in-some-implementations-and-should-be-tested-thoroughly"
  
  let ctx_with_long_values = ctx.with_value(long_key, long_value)
  
  // éªŒè¯é•¿é”®å’Œé•¿å€¼å¯ä»¥æ­£å¸¸å·¥ä½œ
  match ctx_with_long_values.get(long_key) {
    Some(value) => assert_eq(value, long_value)
    None => @test.fail("Expected long value")
  }
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦
  let special_key = create_key("key-with-special-chars:;!@#$%^&*()[]{}|\\\"'<>?/\\")
  let special_value = "value-with-special-chars:;!@#$%^&*()[]{}|\\\"'<>?/\\"
  
  let ctx_with_special_chars = ctx.with_value(special_key, special_value)
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦å¯ä»¥æ­£å¸¸å·¥ä½œ
  match ctx_with_special_chars.get(special_key) {
    Some(value) => assert_eq(value, special_value)
    None => @test.fail("Expected value with special characters")
  }
  
  // æµ‹è¯•Unicodeå­—ç¬¦
  let unicode_key = create_key("é”®-åŒ…å«-ä¸­æ–‡")
  let unicode_value = "å€¼-åŒ…å«-ä¸­æ–‡-å’Œ-ç‰¹æ®Š-å­—ç¬¦-ğŸ˜€"
  
  let ctx_with_unicode = ctx.with_value(unicode_key, unicode_value)
  
  // éªŒè¯Unicodeå­—ç¬¦å¯ä»¥æ­£å¸¸å·¥ä½œ
  match ctx_with_unicode.get(unicode_key) {
    Some(value) => assert_eq(value, unicode_value)
    None => @test.fail("Expected Unicode value")
  }
}
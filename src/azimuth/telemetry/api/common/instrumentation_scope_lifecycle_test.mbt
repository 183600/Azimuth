// InstrumentationScopeç”Ÿå‘½å‘¨æœŸæµ‹è¯•
// æµ‹è¯•InstrumentationScopeçš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬åˆ›å»ºã€ä½¿ç”¨å’Œé”€æ¯çš„å„ä¸ªé˜¶æ®µ

test "instrumentation_scope_basic_lifecycle" {
  // æµ‹è¯•InstrumentationScopeçš„åŸºæœ¬ç”Ÿå‘½å‘¨æœŸ
  
  // é˜¶æ®µ1ï¼šåˆ›å»ºæœ€å°åŒ–çš„InstrumentationScope
  let minimal_scope = InstrumentationScope::{
    name: "minimal-scope",
    version: None,
    schema_url: None
  }
  
  // éªŒè¯æœ€å°åŒ–scope
  assert_eq(minimal_scope.name, "minimal-scope")
  match minimal_scope.version {
    Some(_) => @test.fail("Test failed")  // åº”è¯¥ä¸ºNone
    None => assert_eq(true, true)
  }
  match minimal_scope.schema_url {
    Some(_) => @test.fail("Test failed")  // åº”è¯¥ä¸ºNone
    None => assert_eq(true, true)
  }
  
  // é˜¶æ®µ2ï¼šåˆ›å»ºå®Œæ•´çš„InstrumentationScope
  let complete_scope = InstrumentationScope::{
    name: "complete-scope",
    version: Some("1.2.3"),
    schema_url: Some("https://opentelemetry.io/schemas/1.20.0")
  }
  
  // éªŒè¯å®Œæ•´scope
  assert_eq(complete_scope.name, "complete-scope")
  match complete_scope.version {
    Some(version) => assert_eq(version, "1.2.3")
    None => @test.fail("Test failed")
  }
  match complete_scope.schema_url {
    Some(schema_url) => assert_eq(schema_url, "https://opentelemetry.io/schemas/1.20.0")
    None => @test.fail("Test failed")
  }
  
  // é˜¶æ®µ3ï¼šéªŒè¯scopeçš„ä¸å¯å˜æ€§ï¼ˆåœ¨çœŸå®å®ç°ä¸­ï¼‰
  // è¿™é‡Œæˆ‘ä»¬éªŒè¯scopeçš„å€¼ä¿æŒä¸å˜
  assert_eq(minimal_scope.name, "minimal-scope")
  assert_eq(complete_scope.name, "complete-scope")
  match complete_scope.version {
    Some(version) => assert_eq(version, "1.2.3")
    None => @test.fail("Test failed")
  }
}

test "instrumentation_scope_creation_variations" {
  // æµ‹è¯•InstrumentationScopeåˆ›å»ºçš„å„ç§å˜åŒ–
  
  // å˜åŒ–1ï¼šåªæœ‰åç§°å’Œç‰ˆæœ¬
  let name_version_scope = InstrumentationScope::{
    name: "name-version-scope",
    version: Some("2.0.0"),
    schema_url: None
  }
  
  assert_eq(name_version_scope.name, "name-version-scope")
  match name_version_scope.version {
    Some(version) => assert_eq(version, "2.0.0")
    None => @test.fail("Test failed")
  }
  match name_version_scope.schema_url {
    Some(_) => @test.fail("Test failed")
    None => assert_eq(true, true)
  }
  
  // å˜åŒ–2ï¼šåªæœ‰åç§°å’Œschema_url
  let name_schema_scope = InstrumentationScope::{
    name: "name-schema-scope",
    version: None,
    schema_url: Some("https://example.com/schema/v1")
  }
  
  assert_eq(name_schema_scope.name, "name-schema-scope")
  match name_schema_scope.version {
    Some(_) => @test.fail("Test failed")
    None => assert_eq(true, true)
  }
  match name_schema_scope.schema_url {
    Some(schema_url) => assert_eq(schema_url, "https://example.com/schema/v1")
    None => @test.fail("Test failed")
  }
  
  // å˜åŒ–3ï¼šç©ºç‰ˆæœ¬å­—ç¬¦ä¸²
  let empty_version_scope = InstrumentationScope::{
    name: "empty-version-scope",
    version: Some(""),
    schema_url: None
  }
  
  assert_eq(empty_version_scope.name, "empty-version-scope")
  match empty_version_scope.version {
    Some(version) => assert_eq(version, "")
    None => @test.fail("Test failed")
  }
  
  // å˜åŒ–4ï¼šç©ºschema_urlå­—ç¬¦ä¸²
  let empty_schema_scope = InstrumentationScope::{
    name: "empty-schema-scope",
    version: None,
    schema_url: Some("")
  }
  
  assert_eq(empty_schema_scope.name, "empty-schema-scope")
  match empty_schema_scope.schema_url {
    Some(schema_url) => assert_eq(schema_url, "")
    None => @test.fail("Test failed")
  }
}

test "instrumentation_scope_edge_cases" {
  // æµ‹è¯•InstrumentationScopeçš„è¾¹ç•Œæƒ…å†µ
  
  // è¾¹ç•Œæƒ…å†µ1ï¼šé•¿åç§°
  let long_name_scope = InstrumentationScope::{
    name: "this-is-a-very-long-instrumentation-scope-name-that-exceeds-normal-expectations-and-tests-boundary-conditions-for-name-length-validation",
    version: Some("1.0.0"),
    schema_url: None
  }
  
  assert_eq(long_name_scope.name.length() > 100, true)
  match long_name_scope.version {
    Some(version) => assert_eq(version, "1.0.0")
    None => @test.fail("Test failed")
  }
  
  // è¾¹ç•Œæƒ…å†µ2ï¼šåŒ…å«ç‰¹æ®Šå­—ç¬¦çš„åç§°
  let special_chars_scope = InstrumentationScope::{
    name: "scope!@#$%^&*()_+-=[]{}|;':\",./<>?",
    version: Some("2.1.0"),
    schema_url: None
  }
  
  assert_eq(special_chars_scope.name, "scope!@#$%^&*()_+-=[]{}|;':\",./<>?")
  
  // è¾¹ç•Œæƒ…å†µ3ï¼šUnicodeåç§°
  let unicode_scope = InstrumentationScope::{
    name: "ä»ªè¡¨èŒƒå›´ ğŸŒ Ã±Ã¡Ã©Ã­Ã³Ãº",
    version: Some("3.0.0"),
    schema_url: None
  }
  
  assert_eq(unicode_scope.name, "ä»ªè¡¨èŒƒå›´ ğŸŒ Ã±Ã¡Ã©Ã­Ã³Ãº")
  
  // è¾¹ç•Œæƒ…å†µ4ï¼šå¤æ‚ç‰ˆæœ¬å­—ç¬¦ä¸²
  let complex_version_scope = InstrumentationScope::{
    name: "complex-version-scope",
    version: Some("1.2.3-alpha.1+build.1234567890.abcdef"),
    schema_url: None
  }
  
  match complex_version_scope.version {
    Some(version) => assert_eq(version, "1.2.3-alpha.1+build.1234567890.abcdef")
    None => @test.fail("Test failed")
  }
  
  // è¾¹ç•Œæƒ…å†µ5ï¼šå¤æ‚schema_url
  let complex_schema_scope = InstrumentationScope::{
    name: "complex-schema-scope",
    version: None,
    schema_url: Some("https://example.com/schemas/v1.2.3?param=value&other=param#fragment")
  }
  
  match complex_schema_scope.schema_url {
    Some(schema_url) => assert_eq(schema_url, "https://example.com/schemas/v1.2.3?param=value&other=param#fragment")
    None => @test.fail("Test failed")
  }
}

test "instrumentation_scope_in_telemetry_context" {
  // æµ‹è¯•InstrumentationScopeåœ¨é¥æµ‹ä¸Šä¸‹æ–‡ä¸­çš„ä½¿ç”¨
  
  // åˆ›å»ºä¸åŒç±»å‹çš„scope
  let http_scope = InstrumentationScope::{
    name: "http-client",
    version: Some("1.5.0"),
    schema_url: Some("https://opentelemetry.io/schemas/1.20.0")
  }
  
  let db_scope = InstrumentationScope::{
    name: "database",
    version: Some("2.1.3"),
    schema_url: Some("https://opentelemetry.io/schemas/1.20.0")
  }
  
  let cache_scope = InstrumentationScope::{
    name: "redis-client",
    version: Some("0.9.8"),
    schema_url: None
  }
  
  // æ¨¡æ‹Ÿåœ¨é¥æµ‹æ“ä½œä¸­ä½¿ç”¨scope
  let scopes = [http_scope, db_scope, cache_scope]
  
  // éªŒè¯æ‰€æœ‰scopeéƒ½æ­£ç¡®åˆ›å»º
  assert_eq(scopes.length(), 3)
  
  // éªŒè¯HTTP scope
  assert_eq(scopes[0].name, "http-client")
  match scopes[0].version {
    Some(version) => assert_eq(version, "1.5.0")
    None => @test.fail("Test failed")
  }
  match scopes[0].schema_url {
    Some(schema_url) => assert_eq(schema_url, "https://opentelemetry.io/schemas/1.20.0")
    None => @test.fail("Test failed")
  }
  
  // éªŒè¯æ•°æ®åº“scope
  assert_eq(scopes[1].name, "database")
  match scopes[1].version {
    Some(version) => assert_eq(version, "2.1.3")
    None => @test.fail("Test failed")
  }
  
  // éªŒè¯ç¼“å­˜scope
  assert_eq(scopes[2].name, "redis-client")
  match scopes[2].version {
    Some(version) => assert_eq(version, "0.9.8")
    None => @test.fail("Test failed")
  }
  match scopes[2].schema_url {
    Some(_) => @test.fail("Test failed")
    None => assert_eq(true, true)
  }
}

test "instrumentation_scope_lifecycle_with_span_creation" {
  // æµ‹è¯•InstrumentationScopeåœ¨Spanåˆ›å»ºè¿‡ç¨‹ä¸­çš„ç”Ÿå‘½å‘¨æœŸ
  
  // åˆ›å»ºscope
  let tracer_scope = InstrumentationScope::{
    name: "custom-tracer",
    version: Some("1.0.0"),
    schema_url: Some("https://example.com/schemas/tracer/v1")
  }
  
  // æ¨¡æ‹Ÿä½¿ç”¨scopeåˆ›å»ºtracerå’Œspan
  let ctx = Context::empty()
  let tracer = NoopTracer::{}
  
  // åˆ›å»ºä¸scopeç›¸å…³çš„span
  let scope_attributes = [
    ("instrumentation.scope.name", AttributeValue::string(tracer_scope.name)),
    ("instrumentation.scope.version", AttributeValue::string(
      match tracer_scope.version {
        Some(v) => v
        None => "unknown"
      }
    ))
  ]
  
  let (_, span) = tracer.start_span(ctx, "scoped_operation", Some(Server), Some(scope_attributes))
  
  // éªŒè¯spanåŒ…å«äº†scopeä¿¡æ¯
  assert_eq(span.name, "scoped_operation")
  assert_eq(span.kind, Server)
  assert_eq(span.attributes.length(), 2)
  
  // éªŒè¯scopeå±æ€§
  let mut found_scope_name = false
  let mut found_scope_version = false
  
  let mut i = 0
  while i < span.attributes.length() {
    let (key, value) = span.attributes[i]
    
    match key {
      "instrumentation.scope.name" => {
        match value {
          StringValue(v) => {
            assert_eq(v, tracer_scope.name)
            found_scope_name = true
          }
          _ => @test.fail("Test failed")
        }
      }
      "instrumentation.scope.version" => {
        match value {
          StringValue(v) => {
            assert_eq(v, "1.0.0")
            found_scope_version = true
          }
          _ => @test.fail("Test failed")
        }
      }
      _ => ()  // å¿½ç•¥å…¶ä»–å±æ€§
    }
    
    i = i + 1
  }
  
  assert_eq(found_scope_name, true)
  assert_eq(found_scope_version, true)
}

test "instrumentation_scope_version_evolution" {
  // æµ‹è¯•InstrumentationScopeç‰ˆæœ¬æ¼”è¿›çš„åœºæ™¯
  
  // é˜¶æ®µ1ï¼šåˆå§‹ç‰ˆæœ¬
  let v1_scope = InstrumentationScope::{
    name: "evolving-scope",
    version: Some("1.0.0"),
    schema_url: Some("https://example.com/schemas/v1")
  }
  
  // é˜¶æ®µ2ï¼šåŠŸèƒ½æ›´æ–°ç‰ˆæœ¬
  let v2_scope = InstrumentationScope::{
    name: "evolving-scope",
    version: Some("1.1.0"),
    schema_url: Some("https://example.com/schemas/v1")
  }
  
  // é˜¶æ®µ3ï¼šä¸»è¦ç‰ˆæœ¬æ›´æ–°
  let v3_scope = InstrumentationScope::{
    name: "evolving-scope",
    version: Some("2.0.0"),
    schema_url: Some("https://example.com/schemas/v2")
  }
  
  // é˜¶æ®µ4ï¼šé¢„å‘å¸ƒç‰ˆæœ¬
  let prerelease_scope = InstrumentationScope::{
    name: "evolving-scope",
    version: Some("2.1.0-alpha.1"),
    schema_url: Some("https://example.com/schemas/v2")
  }
  
  // éªŒè¯ç‰ˆæœ¬æ¼”è¿›
  let versioned_scopes = [v1_scope, v2_scope, v3_scope, prerelease_scope]
  
  let expected_versions = ["1.0.0", "1.1.0", "2.0.0", "2.1.0-alpha.1"]
  let expected_schemas = [
    "https://example.com/schemas/v1",
    "https://example.com/schemas/v1",
    "https://example.com/schemas/v2",
    "https://example.com/schemas/v2"
  ]
  
  let mut i = 0
  while i < versioned_scopes.length() {
    let scope = versioned_scopes[i]
    
    assert_eq(scope.name, "evolving-scope")
    match scope.version {
      Some(version) => assert_eq(version, expected_versions[i])
      None => @test.fail("Test failed")
    }
    match scope.schema_url {
      Some(schema_url) => assert_eq(schema_url, expected_schemas[i])
      None => @test.fail("Test failed")
    }
    
    i = i + 1
  }
}

test "instrumentation_scope_performance_considerations" {
  // æµ‹è¯•InstrumentationScopeçš„æ€§èƒ½è€ƒè™‘
  
  // åˆ›å»ºå¤§é‡scopeæ¥æµ‹è¯•æ€§èƒ½
  let mut scopes = []
  let mut i = 0
  while i < 100 {
    let scope = InstrumentationScope::{
      name: "perf-scope-" + i.to_string(),
      version: Some("1." + i.to_string() + ".0"),
      schema_url: Some("https://example.com/schemas/v" + i.to_string())
    }
    scopes.push(scope)
    i = i + 1
  }
  
  // éªŒè¯æ‰€æœ‰scopeéƒ½æ­£ç¡®åˆ›å»º
  assert_eq(scopes.length(), 100)
  
  // éªŒè¯scopeæ•°æ®çš„å®Œæ•´æ€§
  i = 0
  while i < scopes.length() {
    let scope = scopes[i]
    let expected_name = "perf-scope-" + i.to_string()
    let expected_version = "1." + i.to_string() + ".0"
    let expected_schema = "https://example.com/schemas/v" + i.to_string()
    
    assert_eq(scope.name, expected_name)
    match scope.version {
      Some(version) => assert_eq(version, expected_version)
      None => @test.fail("Test failed")
    }
    match scope.schema_url {
      Some(schema_url) => assert_eq(schema_url, expected_schema)
      None => @test.fail("Test failed")
    }
    
    i = i + 1
  }
  
  // æµ‹è¯•scopeæŸ¥æ‰¾æ€§èƒ½ï¼ˆæ¨¡æ‹Ÿï¼‰
  let test_indices = [0, 49, 99, 25, 75]
  i = 0
  while i < test_indices.length() {
    let index = test_indices[i]
    let scope = scopes[index]
    let expected_name = "perf-scope-" + index.to_string()
    
    assert_eq(scope.name, expected_name)
    i = i + 1
  }
}

test "instrumentation_scope_error_handling" {
  // æµ‹è¯•InstrumentationScopeçš„é”™è¯¯å¤„ç†
  
  // æµ‹è¯•ç©ºåç§°ï¼ˆåœ¨çœŸå®å®ç°ä¸­å¯èƒ½æŠ›å‡ºé”™è¯¯ï¼‰
  let empty_name_scope = InstrumentationScope::{
    name: "",
    version: Some("1.0.0"),
    schema_url: None
  }
  
  assert_eq(empty_name_scope.name, "")
  match empty_name_scope.version {
    Some(version) => assert_eq(version, "1.0.0")
    None => @test.fail("Test failed")
  }
  
  // æµ‹è¯•åªåŒ…å«ç©ºæ ¼çš„åç§°
  let spaces_name_scope = InstrumentationScope::{
    name: "   ",
    version: Some("1.0.0"),
    schema_url: None
  }
  
  assert_eq(spaces_name_scope.name, "   ")
  
  // æµ‹è¯•æ— æ•ˆçš„schema_urlæ ¼å¼
  let invalid_schema_scope = InstrumentationScope::{
    name: "invalid-schema-scope",
    version: None,
    schema_url: Some("not-a-valid-url")
  }
  
  match invalid_schema_scope.schema_url {
    Some(schema_url) => assert_eq(schema_url, "not-a-valid-url")
    None => @test.fail("Test failed")
  }
  
  // æµ‹è¯•éå¸¸é•¿çš„ç‰ˆæœ¬å­—ç¬¦ä¸²
  let long_version_scope = InstrumentationScope::{
    name: "long-version-scope",
    version: Some("1.2.3-alpha.1+build.1234567890.abcdef.very.long.version.string.that.exceeds.normal.expectations"),
    schema_url: None
  }
  
  match long_version_scope.version {
    Some(version) => assert_eq(version.length() > 80, true)
    None => @test.fail("Test failed")
  }
}

test "instrumentation_scope_comprehensive_lifecycle" {
  // ç»¼åˆç”Ÿå‘½å‘¨æœŸæµ‹è¯•
  
  // é˜¶æ®µ1ï¼šåˆå§‹åŒ–
  let initial_scope = InstrumentationScope::{
    name: "comprehensive-scope",
    version: Some("0.1.0"),
    schema_url: Some("https://example.com/schemas/v1")
  }
  
  // é˜¶æ®µ2ï¼šå¼€å‘é˜¶æ®µ
  let dev_scope = InstrumentationScope::{
    name: "comprehensive-scope",
    version: Some("0.9.0-beta.1"),
    schema_url: Some("https://example.com/schemas/v1")
  }
  
  // é˜¶æ®µ3ï¼šå‘å¸ƒé˜¶æ®µ
  let release_scope = InstrumentationScope::{
    name: "comprehensive-scope",
    version: Some("1.0.0"),
    schema_url: Some("https://example.com/schemas/v1")
  }
  
  // é˜¶æ®µ4ï¼šåŠŸèƒ½æ›´æ–°
  let feature_scope = InstrumentationScope::{
    name: "comprehensive-scope",
    version: Some("1.1.0"),
    schema_url: Some("https://example.com/schemas/v1")
  }
  
  // é˜¶æ®µ5ï¼šä¸»è¦ç‰ˆæœ¬æ›´æ–°
  let major_scope = InstrumentationScope::{
    name: "comprehensive-scope",
    version: Some("2.0.0"),
    schema_url: Some("https://example.com/schemas/v2")
  }
  
  // é˜¶æ®µ6ï¼šé•¿æœŸæ”¯æŒç‰ˆæœ¬
  let lts_scope = InstrumentationScope::{
    name: "comprehensive-scope",
    version: Some("2.1.0-lts"),
    schema_url: Some("https://example.com/schemas/v2")
  }
  
  // éªŒè¯å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸ
  let lifecycle_scopes = [
    initial_scope, dev_scope, release_scope, 
    feature_scope, major_scope, lts_scope
  ]
  
  let expected_versions = [
    "0.1.0", "0.9.0-beta.1", "1.0.0", 
    "1.1.0", "2.0.0", "2.1.0-lts"
  ]
  
  let expected_schemas = [
    "https://example.com/schemas/v1", "https://example.com/schemas/v1", 
    "https://example.com/schemas/v1", "https://example.com/schemas/v1", 
    "https://example.com/schemas/v2", "https://example.com/schemas/v2"
  ]
  
  let mut i = 0
  while i < lifecycle_scopes.length() {
    let scope = lifecycle_scopes[i]
    
    // éªŒè¯åç§°åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ä¿æŒä¸€è‡´
    assert_eq(scope.name, "comprehensive-scope")
    
    // éªŒè¯ç‰ˆæœ¬æ¼”è¿›
    match scope.version {
      Some(version) => assert_eq(version, expected_versions[i])
      None => @test.fail("Test failed")
    }
    
    // éªŒè¯schema URLçš„æ¼”è¿›
    match scope.schema_url {
      Some(schema_url) => assert_eq(schema_url, expected_schemas[i])
      None => @test.fail("Test failed")
    }
    
    i = i + 1
  }
  
  // éªŒè¯ç‰ˆæœ¬é€’å¢çš„é€»è¾‘
  assert_eq(expected_versions[0] < expected_versions[1], true)  // 0.1.0 < 0.9.0-beta.1
  assert_eq(expected_versions[2] < expected_versions[3], true)  // 1.0.0 < 1.1.0
  assert_eq(expected_versions[3] < expected_versions[4], true)  // 1.1.0 < 2.0.0
  assert_eq(expected_versions[4] < expected_versions[5], true)  // 2.0.0 < 2.1.0-lts
}
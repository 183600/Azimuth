// Propagationæ¨¡å—å¤åˆä¼ æ’­å™¨é”™è¯¯å¤„ç†æµ‹è¯•ç”¨ä¾‹
test "composite_propagator_empty_propagators" {
  // æµ‹è¯•ç©ºçš„å¤åˆä¼ æ’­å™¨
  let empty_propagators : Array[TextMapPropagator] = []
  let composite_propagator = CompositePropagator::new(empty_propagators)
  
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  // æµ‹è¯•ç©ºçš„injectæ“ä½œ
  composite_propagator.inject(ctx, carrier)
  
  // æµ‹è¯•ç©ºçš„extractæ“ä½œ
  let extracted_ctx = composite_propagator.extract(ctx, carrier)
  
  // éªŒè¯æ“ä½œä¸ä¼šå´©æºƒ
  assert_eq(true, true)
}

test "composite_propagator_single_propagator_failure" {
  // æµ‹è¯•å•ä¸ªä¼ æ’­å™¨å¤±è´¥çš„æƒ…å†µ
  let propagators : Array[TextMapPropagator] = [
    W3CTraceContextPropagator::{}
  ]
  let composite_propagator = CompositePropagator::new(propagators)
  
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  // è®¾ç½®æ— æ•ˆçš„traceparent headeræ¥æ¨¡æ‹Ÿé”™è¯¯æƒ…å†µ
  carrier.set("traceparent", "invalid-traceparent-format")
  
  // æµ‹è¯•extractæ“ä½œ
  let extracted_ctx = composite_propagator.extract(ctx, carrier)
  
  // æµ‹è¯•injectæ“ä½œ
  composite_propagator.inject(extracted_ctx, carrier)
  
  // å³ä½¿æœ‰æ— æ•ˆæ•°æ®ï¼Œæ“ä½œä¹Ÿåº”è¯¥æ­£å¸¸å®Œæˆ
  assert_eq(true, true)
}

test "composite_propagator_multiple_propagators_partial_failure" {
  // æµ‹è¯•å¤šä¸ªä¼ æ’­å™¨éƒ¨åˆ†å¤±è´¥çš„æƒ…å†µ
  let propagators : Array[TextMapPropagator] = [
    W3CTraceContextPropagator::{},
    W3CBaggagePropagator::{}
  ]
  let composite_propagator = CompositePropagator::new(propagators)
  
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  // è®¾ç½®éƒ¨åˆ†æ— æ•ˆçš„header
  carrier.set("traceparent", "invalid-traceparent")
  carrier.set("baggage", "valid-key=value")
  
  // æµ‹è¯•extractæ“ä½œ
  let extracted_ctx = composite_propagator.extract(ctx, carrier)
  
  // æµ‹è¯•injectæ“ä½œ
  composite_propagator.inject(extracted_ctx, carrier)
  
  // å³ä½¿éƒ¨åˆ†ä¼ æ’­å™¨å¤±è´¥ï¼Œå…¶ä»–ä¼ æ’­å™¨ä¹Ÿåº”è¯¥æ­£å¸¸å·¥ä½œ
  assert_eq(true, true)
}

test "composite_propagator_carrier_failure" {
  // æµ‹è¯•è½½ä½“(Carrier)å¤±è´¥çš„æƒ…å†µ
  let propagators : Array[TextMapPropagator] = [
    W3CTraceContextPropagator::{},
    W3CBaggagePropagator::{}
  ]
  let composite_propagator = CompositePropagator::new(propagators)
  
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  // è®¾ç½®è¶…é•¿çš„headerå€¼æ¥æ¨¡æ‹Ÿè½½ä½“å¤±è´¥
  let very_long_value = "this.is.a.very.long.header.value.that.exceeds.normal.expectations.and.may.cause.issues.with.the.carrier.implementation"
  carrier.set("traceparent", very_long_value)
  carrier.set("baggage", very_long_value)
  
  // æµ‹è¯•extractæ“ä½œ
  let extracted_ctx = composite_propagator.extract(ctx, carrier)
  
  // æµ‹è¯•injectæ“ä½œ
  composite_propagator.inject(extracted_ctx, carrier)
  
  // å³ä½¿è½½ä½“æœ‰é—®é¢˜ï¼Œæ“ä½œä¹Ÿåº”è¯¥ä¼˜é›…å¤„ç†
  assert_eq(true, true)
}

test "composite_propagator_malformed_headers" {
  // æµ‹è¯•æ ¼å¼é”™è¯¯çš„headers
  let propagators : Array[TextMapPropagator] = [
    W3CTraceContextPropagator::{},
    W3CBaggagePropagator::{}
  ]
  let composite_propagator = CompositePropagator::new(propagators)
  
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  // è®¾ç½®å„ç§æ ¼å¼é”™è¯¯çš„headers
  carrier.set("traceparent", "")  // ç©ºçš„traceparent
  carrier.set("baggage", "")      // ç©ºçš„baggage
  
  // æµ‹è¯•extractæ“ä½œ
  let extracted_ctx1 = composite_propagator.extract(ctx, carrier)
  
  // æ¸…ç©ºå¹¶è®¾ç½®å…¶ä»–æ ¼å¼é”™è¯¯çš„headers
  carrier = MapCarrier::new()
  carrier.set("traceparent", "00-")  // ä¸å®Œæ•´çš„traceparent
  carrier.set("baggage", "invalid-format-without-equals")
  
  let extracted_ctx2 = composite_propagator.extract(ctx, carrier)
  
  // è®¾ç½®åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„headers
  carrier = MapCarrier::new()
  carrier.set("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  carrier.set("baggage", "key=value!@#$%^&*()")  // åŒ…å«ç‰¹æ®Šå­—ç¬¦
  
  let extracted_ctx3 = composite_propagator.extract(ctx, carrier)
  
  // æµ‹è¯•injectæ“ä½œ
  composite_propagator.inject(extracted_ctx1, carrier)
  composite_propagator.inject(extracted_ctx2, carrier)
  composite_propagator.inject(extracted_ctx3, carrier)
  
  // å³ä½¿headersæ ¼å¼é”™è¯¯ï¼Œæ“ä½œä¹Ÿåº”è¯¥ä¼˜é›…å¤„ç†
  assert_eq(true, true)
}

test "composite_propagator_context_corruption" {
  // æµ‹è¯•ä¸Šä¸‹æ–‡æŸåçš„æƒ…å†µ
  let propagators : Array[TextMapPropagator] = [
    W3CTraceContextPropagator::{},
    W3CBaggagePropagator::{}
  ]
  let composite_propagator = CompositePropagator::new(propagators)
  
  // åˆ›å»ºä¸€ä¸ªå¤æ‚çš„ä¸Šä¸‹æ–‡
  let ctx = Context::empty()
  let key1 = create_key("trace.id")
  let key2 = create_key("span.id")
  let key3 = create_key("correlation.id")
  
  let complex_ctx = ctx
    .with_value(key1, "trace-12345678901234567890123456789012")
    .with_value(key2, "span-1234567890123456")
    .with_value(key3, "corr-abcdef1234567890")
  
  let carrier = MapCarrier::new()
  
  // è®¾ç½®å¯èƒ½å¼•èµ·é—®é¢˜çš„headers
  carrier.set("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  carrier.set("baggage", "key1=value1,key2=value2,key3=value3")
  
  // æµ‹è¯•extractæ“ä½œ
  let extracted_ctx = composite_propagator.extract(complex_ctx, carrier)
  
  // æµ‹è¯•injectæ“ä½œ
  composite_propagator.inject(extracted_ctx, carrier)
  
  // éªŒè¯åŸå§‹ä¸Šä¸‹æ–‡æ²¡æœ‰è¢«æŸå
  match complex_ctx.get(key1) {
    Some(value) => assert_eq(value, "trace-12345678901234567890123456789012")
    None => @test.fail("Test failed")
  }
  
  match complex_ctx.get(key2) {
    Some(value) => assert_eq(value, "span-1234567890123456")
    None => @test.fail("Test failed")
  }
  
  match complex_ctx.get(key3) {
    Some(value) => assert_eq(value, "corr-abcdef1234567890")
    None => @test.fail("Test failed")
  }
}

test "composite_propagator_header_conflicts" {
  // æµ‹è¯•headerå†²çªçš„æƒ…å†µ
  let propagators : Array[TextMapPropagator] = [
    W3CTraceContextPropagator::{},
    W3CBaggagePropagator::{}
  ]
  let composite_propagator = CompositePropagator::new(propagators)
  
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  // è®¾ç½®å¯èƒ½å†²çªçš„headers
  carrier.set("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  carrier.set("baggage", "key1=value1,key2=value2")
  
  // ç¬¬ä¸€æ¬¡injectæ“ä½œ
  composite_propagator.inject(ctx, carrier)
  
  // ä¿®æ”¹headersæ¥æ¨¡æ‹Ÿå†²çª
  carrier.set("traceparent", "00-12345678901234567890123456789012-abcdef1234567890-01")
  carrier.set("baggage", "different.key=different.value")
  
  // ç¬¬äºŒæ¬¡injectæ“ä½œ
  composite_propagator.inject(ctx, carrier)
  
  // æµ‹è¯•extractæ“ä½œ
  let extracted_ctx = composite_propagator.extract(ctx, carrier)
  
  // å³ä½¿æœ‰headerå†²çªï¼Œæ“ä½œä¹Ÿåº”è¯¥æ­£å¸¸å®Œæˆ
  assert_eq(true, true)
}

test "composite_propagator_large_data_handling" {
  // æµ‹è¯•å¤§æ•°æ®å¤„ç†
  let propagators : Array[TextMapPropagator] = [
    W3CTraceContextPropagator::{},
    W3CBaggagePropagator::{}
  ]
  let composite_propagator = CompositePropagator::new(propagators)
  
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  // åˆ›å»ºå¤§é‡çš„baggageæ•°æ®
  let mut large_baggage = ""
  let mut i = 0
  while i < 100 {
    large_baggage = large_baggage + "key" + i.to_string() + "=value" + i.to_string()
    if i < 99 {
      large_baggage = large_baggage + ","
    }
    i = i + 1
  }
  
  carrier.set("baggage", large_baggage)
  carrier.set("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  
  // æµ‹è¯•extractæ“ä½œ
  let extracted_ctx = composite_propagator.extract(ctx, carrier)
  
  // æµ‹è¯•injectæ“ä½œ
  composite_propagator.inject(extracted_ctx, carrier)
  
  // å³ä½¿æ•°æ®å¾ˆå¤§ï¼Œæ“ä½œä¹Ÿåº”è¯¥æ­£å¸¸å®Œæˆ
  assert_eq(true, true)
}

test "composite_propagator_concurrent_operations" {
  // æµ‹è¯•å¹¶å‘æ“ä½œï¼ˆæ¨¡æ‹Ÿï¼‰
  let propagators : Array[TextMapPropagator] = [
    W3CTraceContextPropagator::{},
    W3CBaggagePropagator::{}
  ]
  let composite_propagator = CompositePropagator::new(propagators)
  
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  // æ¨¡æ‹Ÿå¹¶å‘æ“ä½œï¼šå¿«é€Ÿè¿ç»­çš„injectå’Œextract
  let mut i = 0
  while i < 50 {
    // è®¾ç½®ä¸åŒçš„headers
    carrier.set("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
    carrier.set("baggage", "key" + i.to_string() + "=value" + i.to_string())
    
    // extractæ“ä½œ
    let extracted_ctx = composite_propagator.extract(ctx, carrier)
    
    // injectæ“ä½œ
    composite_propagator.inject(extracted_ctx, carrier)
    
    i = i + 1
  }
  
  // å³ä½¿æœ‰å¿«é€Ÿè¿ç»­çš„æ“ä½œï¼Œä¹Ÿåº”è¯¥æ­£å¸¸å®Œæˆ
  assert_eq(true, true)
}

test "composite_propagator_special_characters_handling" {
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å¤„ç†
  let propagators : Array[TextMapPropagator] = [
    W3CTraceContextPropagator::{},
    W3CBaggagePropagator::{}
  ]
  let composite_propagator = CompositePropagator::new(propagators)
  
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  // è®¾ç½®åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„headers
  carrier.set("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  carrier.set("baggage", "special.key=value!@#$%^&*()_+-={}[]|\\:;\"'<>?,./")
  carrier.set("baggage", "unicode.key=Unicodeæµ‹è¯•ğŸš€")
  carrier.set("baggage", "space.key=value with spaces")
  carrier.set("baggage", "url.key=https://example.com/path?query=value&param2=value2#fragment")
  
  // æµ‹è¯•extractæ“ä½œ
  let extracted_ctx = composite_propagator.extract(ctx, carrier)
  
  // æµ‹è¯•injectæ“ä½œ
  composite_propagator.inject(extracted_ctx, carrier)
  
  // å³ä½¿æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œæ“ä½œä¹Ÿåº”è¯¥æ­£å¸¸å®Œæˆ
  assert_eq(true, true)
}

test "composite_propagator_null_and_empty_values" {
  // æµ‹è¯•nullå’Œç©ºå€¼å¤„ç†
  let propagators : Array[TextMapPropagator] = [
    W3CTraceContextPropagator::{},
    W3CBaggagePropagator::{}
  ]
  let composite_propagator = CompositePropagator::new(propagators)
  
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  // è®¾ç½®ç©ºå€¼
  carrier.set("traceparent", "")
  carrier.set("baggage", "")
  
  // æµ‹è¯•extractæ“ä½œ
  let extracted_ctx1 = composite_propagator.extract(ctx, carrier)
  
  // æ¸…ç©ºå¹¶è®¾ç½®æœ‰æ•ˆå€¼
  carrier = MapCarrier::new()
  carrier.set("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
  carrier.set("baggage", "key=value")
  
  // æµ‹è¯•extractæ“ä½œ
  let extracted_ctx2 = composite_propagator.extract(ctx, carrier)
  
  // æµ‹è¯•injectæ“ä½œ
  composite_propagator.inject(extracted_ctx1, carrier)
  composite_propagator.inject(extracted_ctx2, carrier)
  
  // å³ä½¿æœ‰ç©ºå€¼ï¼Œæ“ä½œä¹Ÿåº”è¯¥æ­£å¸¸å®Œæˆ
  assert_eq(true, true)
}
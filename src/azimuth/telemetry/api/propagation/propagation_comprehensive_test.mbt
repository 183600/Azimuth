// Propagationæ¨¡å—çš„ç»¼åˆæµ‹è¯•ç”¨ä¾‹
test "map_carrier_basic_operations" {
  // æµ‹è¯•MapCarrierçš„åŸºæœ¬æ“ä½œ
  let carrier = MapCarrier::new()
  
  // éªŒè¯åˆå§‹çŠ¶æ€
  assert_eq(carrier.data.length(), 0)
  assert_eq(carrier.keys().length(), 0)
  
  // æµ‹è¯•è·å–ä¸å­˜åœ¨çš„é”®
  match carrier.get("nonexistent.key") {
    Some(_) => @test.fail("Test failed")
    None => assert_eq(true, true)
  }
  
  // åˆ›å»ºå¸¦æœ‰åˆå§‹æ•°æ®çš„carrier
  let initial_data = [
    ("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"),
    ("tracestate", "rojo=00f067aa0ba902b7"),
    ("baggage", "key1=value1,key2=value2")
  ]
  
  let carrier_with_data = MapCarrier::from_map(initial_data)
  
  // éªŒè¯æ•°æ®
  assert_eq(carrier_with_data.data.length(), 3)
  assert_eq(carrier_with_data.keys().length(), 3)
  
  // æµ‹è¯•è·å–å­˜åœ¨çš„é”®
  match carrier_with_data.get("traceparent") {
    Some(value) => assert_eq(value, "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
    None => @test.fail("Test failed")
  }
  
  match carrier_with_data.get("tracestate") {
    Some(value) => assert_eq(value, "rojo=00f067aa0ba902b7")
    None => @test.fail("Test failed")
  }
  
  match carrier_with_data.get("baggage") {
    Some(value) => assert_eq(value, "key1=value1,key2=value2")
    None => @test.fail("Test failed")
  }
  
  // éªŒè¯keysæ–¹æ³•
  let keys = carrier_with_data.keys()
  assert_eq(keys.length(), 3)
  assert_eq(keys.contains("traceparent"), true)
  assert_eq(keys.contains("tracestate"), true)
  assert_eq(keys.contains("baggage"), true)
}

test "w3c_trace_context_propagator_inject" {
  // æµ‹è¯•W3C TraceContext Propagatorçš„injectæ“ä½œ
  let propagator = W3CTraceContextPropagator::{}
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  // æ‰§è¡Œinjectæ“ä½œ
  propagator.inject(ctx, carrier)
  
  // éªŒè¯injectåçš„carrierï¼ˆç”±äºæ˜¯ç®€åŒ–å®ç°ï¼Œæˆ‘ä»¬éªŒè¯å›ºå®šå€¼ï¼‰
  match carrier.get("traceparent") {
    Some(trace_parent) => {
      assert_eq(trace_parent, "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01")
      
      // éªŒè¯traceparentæ ¼å¼
      assert_eq(trace_parent.has_prefix("00-"), true)
      assert_eq(trace_parent.contains("-"), true)
      
      let parts = trace_parent"-".split_to_string()
      assert_eq(parts.length(), 4)
      assert_eq(parts[0], "00")
      assert_eq(parts[1].length(), 32) // trace_id
      assert_eq(parts[2].length(), 16) // span_id
      assert_eq(parts[3], "01") // trace_flags
    }
    None => @test.fail("Test failed")
  }
}

test "w3c_trace_context_propagator_extract" {
  // æµ‹è¯•W3C TraceContext Propagatorçš„extractæ“ä½œ
  let propagator = W3CTraceContextPropagator::{}
  let ctx = Context::empty()
  
  // åˆ›å»ºåŒ…å«traceparentçš„carrier
  let carrier_data = [
    ("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"),
    ("tracestate", "rojo=00f067aa0ba902b7,congo=t61rcWkgMzE")
  ]
  
  let carrier = MapCarrier::from_map(carrier_data)
  
  // æ‰§è¡Œextractæ“ä½œ
  let extracted_ctx = propagator.extract(ctx, carrier)
  
  // åœ¨ç®€åŒ–å®ç°ä¸­ï¼Œextractä¸ä¼šä¿®æ”¹contextï¼Œä½†æˆ‘ä»¬éªŒè¯æ“ä½œä¸ä¼šå‡ºé”™
  assert_eq(extracted_ctx.values.length(), ctx.values.length())
  
  // æµ‹è¯•æ²¡æœ‰traceparentçš„æƒ…å†µ
  let empty_carrier = MapCarrier::new()
  let empty_ctx = propagator.extract(Context::empty(), empty_carrier)
  assert_eq(empty_ctx.values.length(), 0)
}

test "w3c_baggage_propagator_inject" {
  // æµ‹è¯•W3C Baggage Propagatorçš„injectæ“ä½œ
  let propagator = W3CBaggagePropagator::{}
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  // æ‰§è¡Œinjectæ“ä½œ
  propagator.inject(ctx, carrier)
  
  // éªŒè¯injectåçš„carrierï¼ˆç”±äºæ˜¯ç®€åŒ–å®ç°ï¼Œæˆ‘ä»¬éªŒè¯å›ºå®šå€¼ï¼‰
  match carrier.get("baggage") {
    Some(baggage_value) => {
      assert_eq(baggage_value, "key1=value1,key2=value2")
      
      // éªŒè¯baggageæ ¼å¼
      assert_eq(baggage_value.contains("="), true)
      assert_eq(baggage_value.contains(","), true)
      
      let entries = baggage_value",".split_to_string()
      assert_eq(entries.length(), 2)
      
      let entry1_parts = entries[0]"=".split_to_string()
      assert_eq(entry1_parts[0], "key1")
      assert_eq(entry1_parts[1], "value1")
      
      let entry2_parts = entries[1]"=".split_to_string()
      assert_eq(entry2_parts[0], "key2")
      assert_eq(entry2_parts[1], "value2")
    }
    None => @test.fail("Test failed")
  }
}

test "w3c_baggage_propagator_extract" {
  // æµ‹è¯•W3C Baggage Propagatorçš„extractæ“ä½œ
  let propagator = W3CBaggagePropagator::{}
  let ctx = Context::empty()
  
  // åˆ›å»ºåŒ…å«baggageçš„carrier
  let carrier_data = [
    ("baggage", "user.id=12345,request.id=67890,service.name=api-gateway"),
    ("other-header", "other-value")
  ]
  
  let carrier = MapCarrier::from_map(carrier_data)
  
  // æ‰§è¡Œextractæ“ä½œ
  let extracted_ctx = propagator.extract(ctx, carrier)
  
  // åœ¨ç®€åŒ–å®ç°ä¸­ï¼Œextractä¸ä¼šä¿®æ”¹contextï¼Œä½†æˆ‘ä»¬éªŒè¯æ“ä½œä¸ä¼šå‡ºé”™
  assert_eq(extracted_ctx.values.length(), ctx.values.length())
  
  // æµ‹è¯•æ²¡æœ‰baggageçš„æƒ…å†µ
  let empty_carrier = MapCarrier::new()
  let empty_ctx = propagator.extract(Context::empty(), empty_carrier)
  assert_eq(empty_ctx.values.length(), 0)
}

test "composite_propagator_creation_and_usage" {
  // æµ‹è¯•Composite Propagatorçš„åˆ›å»ºå’Œä½¿ç”¨
  let trace_propagator = W3CTraceContextPropagator::{}
  let baggage_propagator = W3CBaggagePropagator::{}
  
  // åˆ›å»ºcomposite propagator
  let propagators = [trace_propagator, baggage_propagator]
  let composite_propagator = CompositePropagator::new(propagators)
  
  // éªŒè¯composite propagator
  assert_eq(composite_propagator.propagators.length(), 2)
  
  // æµ‹è¯•injectæ“ä½œ
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  composite_propagator.inject(ctx, carrier)
  
  // éªŒè¯ä¸¤ä¸ªpropagatoréƒ½æ‰§è¡Œäº†inject
  match carrier.get("traceparent") {
    Some(_) => assert_eq(true, true)
    None => @test.fail("Test failed")
  }
  
  match carrier.get("baggage") {
    Some(_) => assert_eq(true, true)
    None => @test.fail("Test failed")
  }
  
  // æµ‹è¯•extractæ“ä½œ
  let carrier_with_data = MapCarrier::from_map([
    ("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"),
    ("baggage", "key1=value1,key2=value2")
  ])
  
  let extracted_ctx = composite_propagator.extract(Context::empty(), carrier_with_data)
  assert_eq(extracted_ctx.values.length(), 0) // ç®€åŒ–å®ç°ä¸­ä¸ä¼šä¿®æ”¹context
}

test "composite_propagator_multiple_propagators" {
  // æµ‹è¯•Composite PropagatoråŒ…å«å¤šä¸ªpropagators
  let trace_propagator = W3CTraceContextPropagator::{}
  let baggage_propagator = W3CBaggagePropagator::{}
  
  // åˆ›å»ºåŒ…å«é‡å¤propagatorsçš„composite
  let propagators = [
    trace_propagator,
    baggage_propagator,
    trace_propagator, // é‡å¤çš„trace propagator
    baggage_propagator  // é‡å¤çš„baggage propagator
  ]
  let composite_propagator = CompositePropagator::new(propagators)
  
  assert_eq(composite_propagator.propagators.length(), 4)
  
  // æµ‹è¯•injectæ“ä½œï¼ˆåº”è¯¥æ‰§è¡Œ4æ¬¡ï¼‰
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  composite_propagator.inject(ctx, carrier)
  
  // éªŒè¯headerå­˜åœ¨ï¼ˆç”±äºæ˜¯ç®€åŒ–å®ç°ï¼Œå¤šæ¬¡injectä¼šè¦†ç›–ç›¸åŒçš„å€¼ï¼‰
  match carrier.get("traceparent") {
    Some(_) => assert_eq(true, true)
    None => @test.fail("Test failed")
  }
  
  match carrier.get("baggage") {
    Some(_) => assert_eq(true, true)
    None => @test.fail("Test failed")
  }
}

test "propagation_edge_cases" {
  // æµ‹è¯•ä¼ æ’­çš„è¾¹ç•Œæƒ…å†µ
  
  // ç©ºçš„Composite Propagator
  let empty_propagators = []
  let empty_composite = CompositePropagator::new(empty_propagators)
  assert_eq(empty_composite.propagators.length(), 0)
  
  // ç©ºpropagatorçš„injectå’Œextractä¸åº”è¯¥å‡ºé”™
  let ctx = Context::empty()
  let carrier = MapCarrier::new()
  
  empty_composite.inject(ctx, carrier)
  let extracted_ctx = empty_composite.extract(ctx, carrier)
  
  // éªŒè¯carrieræ²¡æœ‰è¢«ä¿®æ”¹
  match carrier.get("traceparent") {
    Some(_) => @test.fail("Test failed")
    None => assert_eq(true, true)
  }
  
  // ç‰¹æ®Šå­—ç¬¦çš„headerå€¼
  let special_carrier = MapCarrier::from_map([
    ("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"),
    ("baggage", "key.with.dots=value.with.special.chars!@#$%^&*()"),
    ("unicode.header", "Unicodeå€¼æµ‹è¯•ğŸš€")
  ])
  
  let trace_propagator = W3CTraceContextPropagator::{}
  let baggage_propagator = W3CBaggagePropagator::{}
  let composite = CompositePropagator::new([trace_propagator, baggage_propagator])
  
  // extractæ“ä½œåº”è¯¥èƒ½å¤„ç†ç‰¹æ®Šå­—ç¬¦
  let special_ctx = composite.extract(Context::empty(), special_carrier)
  assert_eq(special_ctx.values.length(), 0)
}

test "propagation_with_complex_context" {
  // æµ‹è¯•ä¸å¤æ‚contextçš„ä¼ æ’­
  
  // åˆ›å»ºåŒ…å«å¤šä¸ªå€¼çš„context
  let ctx = Context::empty()
  let key1 = create_key("custom.key1")
  let key2 = create_key("custom.key2")
  let key3 = create_key("custom.key3")
  
  let complex_ctx = ctx
    .with_value(key1, "value1")
    .with_value(key2, "value2")
    .with_value(key3, "value3")
  
  assert_eq(complex_ctx.values.length(), 3)
  
  // æµ‹è¯•ä¼ æ’­ä¸ä¼šå½±å“ç°æœ‰çš„contextå€¼
  let trace_propagator = W3CTraceContextPropagator::{}
  let baggage_propagator = W3CBaggagePropagator::{}
  let composite = CompositePropagator::new([trace_propagator, baggage_propagator])
  
  let carrier = MapCarrier::new()
  composite.inject(complex_ctx, carrier)
  
  // éªŒè¯contextçš„å€¼æ²¡æœ‰è¢«ä¿®æ”¹
  match complex_ctx.get(key1) {
    Some(value) => assert_eq(value, "value1")
    None => @test.fail("Test failed")
  }
  
  match complex_ctx.get(key2) {
    Some(value) => assert_eq(value, "value2")
    None => @test.fail("Test failed")
  }
  
  match complex_ctx.get(key3) {
    Some(value) => assert_eq(value, "value3")
    None => @test.fail("Test failed")
  }
  
  // æµ‹è¯•extractä¸ä¼šè¦†ç›–ç°æœ‰çš„contextå€¼
  let carrier_with_data = MapCarrier::from_map([
    ("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"),
    ("baggage", "extracted.key=extracted.value")
  ])
  
  let extracted_ctx = composite.extract(complex_ctx, carrier_with_data)
  
  // åœ¨ç®€åŒ–å®ç°ä¸­ï¼Œextractä¸ä¼šä¿®æ”¹context
  assert_eq(extracted_ctx.values.length(), 3)
  match extracted_ctx.get(key1) {
    Some(value) => assert_eq(value, "value1")
    None => @test.fail("Test failed")
  }
}

test "map_carrier_to_map_conversion" {
  // æµ‹è¯•MapCarrierçš„to_mapè½¬æ¢
  let original_data = [
    ("key1", "value1"),
    ("key2", "value2"),
    ("key3", "value3")
  ]
  
  let carrier = MapCarrier::from_map(original_data)
  let converted_data = carrier.to_map()
  
  // éªŒè¯è½¬æ¢åçš„æ•°æ®
  assert_eq(converted_data.length(), 3)
  
  let mut i = 0
  while i < original_data.length() {
    let (original_key, original_value) = original_data[i]
    let (converted_key, converted_value) = converted_data[i]
    
    assert_eq(original_key, converted_key)
    assert_eq(original_value, converted_value)
    i = i + 1
  }
  
  // éªŒè¯æ•°æ®å†…å®¹
  match carrier.get("key1") {
    Some(value) => assert_eq(value, "value1")
    None => @test.fail("Test failed")
  }
  
  match carrier.get("key2") {
    Some(value) => assert_eq(value, "value2")
    None => @test.fail("Test failed")
  }
  
  match carrier.get("key3") {
    Some(value) => assert_eq(value, "value3")
    None => @test.fail("Test failed")
  }
}
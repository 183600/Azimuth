// Azimuth Telemetry - Resource Limits Tests
// æµ‹è¯•èµ„æºé™åˆ¶åœºæ™¯ä¸‹çš„é¥æµ‹æ•°æ®å¤„ç†

test "resource_limits_large_attribute_arrays" {
  // æµ‹è¯•å¤§å‹å±æ€§æ•°ç»„çš„èµ„æºé™åˆ¶
  let base_context = @azimuth.telemetry.api.context.Context::empty()
  
  // åˆ›å»ºåŒ…å«å¤§é‡å±æ€§çš„Span
  let mut large_attrs = []
  let mut index = 0
  while index < 1000 {
    large_attrs = large_attrs.push((
      "attr." + index.to_string(),
      @azimuth.telemetry.api.common.AttributeValue::string("value." + index.to_string())
    ))
    index = index + 1
  }
  
  let (_, large_span) = @azimuth.telemetry.api.trace.NoopTracer::start_span(
    base_context,
    "large-attributes-span",
    Some(@azimuth.telemetry.api.trace.Server),
    Some(large_attrs)
  )
  
  // éªŒè¯å¤§å‹å±æ€§æ•°ç»„èƒ½å¤Ÿæ­£å¸¸å¤„ç†
  assert_eq(large_span.name, "large-attributes-span")
  assert_eq(large_span.attributes.length(), 1000)
  
  // éªŒè¯ç‰¹å®šå±æ€§
  match large_span.attributes[0] {
    ("attr.0", @azimuth.telemetry.api.common.AttributeValue::StringValue(value)) => {
      assert_eq(value, "value.0")
    }
    _ => @test.fail("Expected attr.0")
  }
  
  match large_span.attributes[999] {
    ("attr.999", @azimuth.telemetry.api.common.AttributeValue::StringValue(value)) => {
      assert_eq(value, "value.999")
    }
    _ => @test.fail("Expected attr.999")
  }
}

test "resource_limits_large_string_values" {
  // æµ‹è¯•å¤§å‹å­—ç¬¦ä¸²å€¼çš„èµ„æºé™åˆ¶
  let base_context = @azimuth.telemetry.api.context.Context::empty()
  
  // åˆ›å»ºåŒ…å«è¶…é•¿å­—ç¬¦ä¸²çš„å±æ€§
  let very_long_string = "a".repeat(100000) // 100Kå­—ç¬¦
  let unicode_long_string = "æµ‹è¯•".repeat(25000) // 50K Unicodeå­—ç¬¦
  let mixed_long_string = "Mixed content with special chars: ğŸ”¥ ğŸš€ âœ¨ ".repeat(5000) // çº¦100Kå­—ç¬¦
  
  let long_string_attrs = [
    ("very.long.string", @azimuth.telemetry.api.common.AttributeValue::string(very_long_string)),
    ("unicode.long.string", @azimuth.telemetry.api.common.AttributeValue::string(unicode_long_string)),
    ("mixed.long.string", @azimuth.telemetry.api.common.AttributeValue::string(mixed_long_string))
  ]
  
  // æµ‹è¯•Spanä¸­çš„é•¿å­—ç¬¦ä¸²
  let (_, long_string_span) = @azimuth.telemetry.api.trace.NoopTracer::start_span(
    base_context,
    "long-string-span",
    Some(@azimuth.telemetry.api.trace.Server),
    Some(long_string_attrs)
  )
  
  // æµ‹è¯•LogRecordä¸­çš„é•¿å­—ç¬¦ä¸²
  let long_string_log = @azimuth.telemetry.api.logs.LogRecord::builder()
    .timestamp(1640995200000000000L)
    .severity(@azimuth.telemetry.api.logs.Info)
    .body(very_long_string)
    .with_attribute("unicode.body", @azimuth.telemetry.api.common.AttributeValue::string(unicode_long_string))
    .with_attribute("mixed.body", @azimuth.telemetry.api.common.AttributeValue::string(mixed_long_string))
    .build()
  
  // éªŒè¯é•¿å­—ç¬¦ä¸²èƒ½å¤Ÿæ­£å¸¸å¤„ç†
  assert_eq(long_string_span.name, "long-string-span")
  assert_eq(long_string_span.attributes.length(), 3)
  assert_eq(long_string_log.body, Some(very_long_string))
  assert_eq(long_string_log.attributes.length(), 2)
  
  // éªŒè¯å­—ç¬¦ä¸²é•¿åº¦
  match long_string_span.attributes[0] {
    ("very.long.string", @azimuth.telemetry.api.common.AttributeValue::StringValue(value)) => {
      assert_eq(value.length(), 100000)
    }
    _ => @test.fail("Expected very.long.string")
  }
  
  match long_string_span.attributes[1] {
    ("unicode.long.string", @azimuth.telemetry.api.common.AttributeValue::StringValue(value)) => {
      assert_eq(value.length(), 50000)
    }
    _ => @test.fail("Expected unicode.long.string")
  }
}

test "resource_limits_large_array_values" {
  // æµ‹è¯•å¤§å‹æ•°ç»„å€¼çš„èµ„æºé™åˆ¶
  let base_context = @azimuth.telemetry.api.context.Context::empty()
  
  // åˆ›å»ºåŒ…å«å¤§é‡å…ƒç´ çš„æ•°ç»„
  let mut large_string_array = []
  let mut large_int_array = []
  let mut large_float_array = []
  let mut large_bool_array = []
  
  let mut index = 0
  while index < 10000 {
    large_string_array = large_string_array.push("item." + index.to_string())
    large_int_array = large_int_array.push(index.to_int64())
    large_float_array = large_float_array.push(index.to_double())
    large_bool_array = large_bool_array.push(index % 2 == 0)
    index = index + 1
  }
  
  let large_array_attrs = [
    ("large.string.array", @azimuth.telemetry.api.common.AttributeValue::ArrayStringValue(large_string_array)),
    ("large.int.array", @azimuth.telemetry.api.common.AttributeValue::ArrayIntValue(large_int_array)),
    ("large.float.array", @azimuth.telemetry.api.common.AttributeValue::ArrayFloatValue(large_float_array)),
    ("large.bool.array", @azimuth.telemetry.api.common.AttributeValue::ArrayBoolValue(large_bool_array))
  ]
  
  // æµ‹è¯•Spanä¸­çš„å¤§å‹æ•°ç»„
  let (_, large_array_span) = @azimuth.telemetry.api.trace.NoopTracer::start_span(
    base_context,
    "large-array-span",
    Some(@azimuth.telemetry.api.trace.Server),
    Some(large_array_attrs)
  )
  
  // æµ‹è¯•LogRecordä¸­çš„å¤§å‹æ•°ç»„
  let large_array_log = @azimuth.telemetry.api.logs.LogRecord::builder()
    .timestamp(1640995200000000000L)
    .severity(@azimuth.telemetry.api.logs.Info)
    .body("Large arrays test")
    .with_attribute("large.string.array", @azimuth.telemetry.api.common.AttributeValue::ArrayStringValue(large_string_array))
    .with_attribute("large.int.array", @azimuth.telemetry.api.common.AttributeValue::ArrayIntValue(large_int_array))
    .build()
  
  // éªŒè¯å¤§å‹æ•°ç»„èƒ½å¤Ÿæ­£å¸¸å¤„ç†
  assert_eq(large_array_span.name, "large-array-span")
  assert_eq(large_array_span.attributes.length(), 4)
  assert_eq(large_array_log.attributes.length(), 2)
  
  // éªŒè¯æ•°ç»„å¤§å°
  match large_array_span.attributes[0] {
    ("large.string.array", @azimuth.telemetry.api.common.AttributeValue::ArrayStringValue(arr)) => {
      assert_eq(arr.length(), 10000)
      assert_eq(arr[0], "item.0")
      assert_eq(arr[9999], "item.9999")
    }
    _ => @test.fail("Expected large.string.array")
  }
  
  match large_array_span.attributes[1] {
    ("large.int.array", @azimuth.telemetry.api.common.AttributeValue::ArrayIntValue(arr)) => {
      assert_eq(arr.length(), 10000)
      assert_eq(arr[0], 0L)
      assert_eq(arr[9999], 9999L)
    }
    _ => @test.fail("Expected large.int.array")
  }
}

test "resource_limits_deep_span_nesting" {
  // æµ‹è¯•æ·±å±‚SpanåµŒå¥—çš„èµ„æºé™åˆ¶
  let base_context = @azimuth.telemetry.api.context.Context::empty()
  let base_time = 1640995200000000000L
  
  // åˆ›å»ºæ·±å±‚åµŒå¥—çš„Spanå±‚æ¬¡ç»“æ„
  let mut contexts = []
  let mut spans = []
  let current_context = base_context
  
  // åˆ›å»º100å±‚åµŒå¥—
  let mut index = 0
  while index < 100 {
    let (next_context, span) = @azimuth.telemetry.api.trace.NoopTracer::start_span(
      current_context,
      "nested-span-" + index.to_string(),
      Some(if index % 2 == 0 { @azimuth.telemetry.api.trace.Server } else { @azimuth.telemetry.api.trace.Client }),
      Some([
        ("nesting.level", @azimuth.telemetry.api.common.AttributeValue::int(index.to_int64())),
        ("parent.count", @azimuth.telemetry.api.common.AttributeValue::int(index.to_int64())),
        ("operation.type", @azimuth.telemetry.api.common.AttributeValue::string("nested-operation"))
      ]),
      Some(base_time + index.to_int64() * 1000000L)
    )
    
    contexts = contexts.push(next_context)
    spans = spans.push(span)
    current_context = next_context
    index = index + 1
  }
  
  // éªŒè¯æ·±å±‚åµŒå¥—èƒ½å¤Ÿæ­£å¸¸å¤„ç†
  assert_eq(spans.length(), 100)
  assert_eq(contexts.length(), 100)
  
  // éªŒè¯æ¯ä¸€å±‚çš„Spanéƒ½æœ‰æ­£ç¡®çš„å±æ€§
  let mut verified_spans = 0
  let mut index = 0
  while index < spans.length() {
    let span = spans[index]
    let expected_name = "nested-span-" + index.to_string()
    
    if span.name == expected_name && span.attributes.length() == 3 {
      verified_spans = verified_spans + 1
    }
    index = index + 1
  }
  
  assert_eq(verified_spans, 100)
}

test "resource_limits_high_frequency_operations" {
  // æµ‹è¯•é«˜é¢‘æ“ä½œçš„èµ„æºé™åˆ¶
  let base_context = @azimuth.telemetry.api.context.Context::empty()
  let base_time = 1640995200000000000L
  let meter = @azimuth.telemetry.api.metrics.NoopMeter
  
  // åˆ›å»ºé«˜é¢‘æ“ä½œçš„ä»ªå™¨
  let high_freq_counter = @azimuth.telemetry.api.metrics.NoopMeter::create_counter("high.freq.counter", "ops", "High frequency counter")
  let high_freq_histogram = @azimuth.telemetry.api.metrics.NoopMeter::create_histogram("high.freq.histogram", "ms", "High frequency histogram")
  
  // æ¨¡æ‹Ÿé«˜é¢‘æ“ä½œï¼ˆ10000æ¬¡æ“ä½œï¼‰
  let mut index = 0
  while index < 10000 {
    // é«˜é¢‘Spanåˆ›å»º
    let (_, span) = @azimuth.telemetry.api.trace.NoopTracer::start_span(
      base_context,
      "high-freq-op-" + index.to_string(),
      Some(@azimuth.telemetry.api.trace.Internal),
      Some([
        ("operation.id", @azimuth.telemetry.api.common.AttributeValue::int(index.to_int64())),
        ("batch.id", @azimuth.telemetry.api.common.AttributeValue::int((index / 100).to_int64())),
        ("operation.type", @azimuth.telemetry.api.common.AttributeValue::string("high-frequency"))
      ]),
      Some(base_time + index.to_int64() * 1000L) // æ¯1å¾®ç§’ä¸€ä¸ªæ“ä½œ
    )
    
    // é«˜é¢‘LogRecordåˆ›å»º
    let log_record = @azimuth.telemetry.api.logs.LogRecord::builder()
      .timestamp(base_time + index.to_int64() * 1000L)
      .severity(if index % 100 == 0 { @azimuth.telemetry.api.logs.Warn } else { @azimuth.telemetry.api.logs.Info })
      .body("High frequency operation " + index.to_string())
      .with_attribute("operation.id", @azimuth.telemetry.api.common.AttributeValue::int(index.to_int64()))
      .build()
    
    // é«˜é¢‘æŒ‡æ ‡æ“ä½œ
    let attrs = [
      ("operation.id", @azimuth.telemetry.api.common.AttributeValue::int(index.to_int64())),
      ("operation.type", @azimuth.telemetry.api.common.AttributeValue::string("high-frequency"))
    ]
    
    @azimuth.telemetry.api.metrics.NoopCounter::add(1L, Some(attrs))
    @azimuth.telemetry.api.metrics.NoopHistogram::record((index % 1000).to_double(), Some(attrs))
    
    index = index + 1
  }
  
  // éªŒè¯é«˜é¢‘æ“ä½œèƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œ
  assert_eq(true, true)
}

test "resource_limits_memory_pressure_simulation" {
  // æµ‹è¯•å†…å­˜å‹åŠ›æ¨¡æ‹Ÿ
  let base_context = @azimuth.telemetry.api.context.Context::empty()
  
  // åˆ›å»ºå¤§é‡å¤§å‹å¯¹è±¡æ¥æ¨¡æ‹Ÿå†…å­˜å‹åŠ›
  let mut large_objects = []
  let mut index = 0
  while index < 100 {
    // åˆ›å»ºå¤§å‹å±æ€§æ•°ç»„
    let mut large_attrs = []
    let mut attr_index = 0
    while attr_index < 1000 {
      large_attrs = large_attrs.push((
        "large.attr." + attr_index.to_string(),
        @azimuth.telemetry.api.common.AttributeValue::string("a".repeat(1000))
      ))
      attr_index = attr_index + 1
    }
    
    // åˆ›å»ºå¤§å‹Span
    let (_, large_span) = @azimuth.telemetry.api.trace.NoopTracer::start_span(
      base_context,
      "memory-pressure-span-" + index.to_string(),
      Some(@azimuth.telemetry.api.trace.Server),
      Some(large_attrs)
    )
    
    // åˆ›å»ºå¤§å‹LogRecord
    let large_log = @azimuth.telemetry.api.logs.LogRecord::builder()
      .timestamp(1640995200000000000L + index.to_int64() * 1000000L)
      .severity(@azimuth.telemetry.api.logs.Info)
      .body("a".repeat(10000))
      .with_attribute("large.data", @azimuth.telemetry.api.common.AttributeValue::ArrayStringValue([
        "a".repeat(1000), "b".repeat(1000), "c".repeat(1000), "d".repeat(1000), "e".repeat(1000)
      ]))
      .build()
    
    large_objects = large_objects.push((large_span, large_log))
    index = index + 1
  }
  
  // éªŒè¯å†…å­˜å‹åŠ›åœºæ™¯èƒ½å¤Ÿæ­£å¸¸å¤„ç†
  assert_eq(large_objects.length(), 100)
  
  // éªŒè¯æ¯ä¸ªå¯¹è±¡éƒ½æœ‰æ­£ç¡®çš„å±æ€§
  let mut verified_objects = 0
  let mut index = 0
  while index < large_objects.length() {
    let (span, log) = large_objects[index]
    let expected_span_name = "memory-pressure-span-" + index.to_string()
    
    if span.name == expected_span_name && span.attributes.length() == 1000 && log.body?.length() == 10000 {
      verified_objects = verified_objects + 1
    }
    index = index + 1
  }
  
  assert_eq(verified_objects, 100)
}

test "resource_limits_extreme_time_values" {
  // æµ‹è¯•æå€¼æ—¶é—´æˆ³çš„èµ„æºé™åˆ¶
  let base_context = @azimuth.telemetry.api.context.Context::empty()
  
  // æµ‹è¯•æå€¼æ—¶é—´æˆ³
  let extreme_times = [
    -9223372036854775808L, // Int64æœ€å°å€¼
    -9223372036854775807L, // æ¥è¿‘æœ€å°å€¼
    -1000000000000000L,   // è´Ÿçš„è¾ƒå¤§å€¼
    0L,                    // é›¶å€¼
    1L,                    // æœ€å°æ­£å€¼
    1000000000000000L,     // æ­£çš„è¾ƒå¤§å€¼
    9223372036854775806L,  // æ¥è¿‘æœ€å¤§å€¼
    9223372036854775807L   // Int64æœ€å¤§å€¼
  ]
  
  let mut time_spans = []
  let mut time_logs = []
  let mut index = 0
  while index < extreme_times.length() {
    let time = extreme_times[index]
    
    // åˆ›å»ºå¸¦æœ‰æå€¼æ—¶é—´æˆ³çš„Span
    let (_, span) = @azimuth.telemetry.api.trace.NoopTracer::start_span(
      base_context,
      "extreme-time-span-" + index.to_string(),
      Some(@azimuth.telemetry.api.trace.Server),
      Some([
        ("time.value", @azimuth.telemetry.api.common.AttributeValue::int(time)),
        ("time.index", @azimuth.telemetry.api.common.AttributeValue::int(index.to_int64()))
      ]),
      Some(time)
    )
    
    // åˆ›å»ºå¸¦æœ‰æå€¼æ—¶é—´æˆ³çš„LogRecord
    let log = @azimuth.telemetry.api.logs.LogRecord::builder()
      .timestamp(time)
      .observed_timestamp(time + 1000L)
      .severity(@azimuth.telemetry.api.logs.Info)
      .body("Extreme time test " + index.to_string())
      .with_attribute("time.value", @azimuth.telemetry.api.common.AttributeValue::int(time))
      .build()
    
    time_spans = time_spans.push(span)
    time_logs = time_logs.push(log)
    index = index + 1
  }
  
  // éªŒè¯æå€¼æ—¶é—´æˆ³èƒ½å¤Ÿæ­£å¸¸å¤„ç†
  assert_eq(time_spans.length(), 8)
  assert_eq(time_logs.length(), 8)
  
  // éªŒè¯æ¯ä¸ªæ—¶é—´æˆ³éƒ½æ­£ç¡®è®¾ç½®
  let mut verified_times = 0
  let mut index = 0
  while index < time_spans.length() {
    let span = time_spans[index]
    let log = time_logs[index]
    let expected_time = extreme_times[index]
    
    if span.start_time_unix_nanos == expected_time && log.timestamp_unix_nanos == expected_time {
      verified_times = verified_times + 1
    }
    index = index + 1
  }
  
  assert_eq(verified_times, 8)
}

test "resource_limits_complex_nested_structures" {
  // æµ‹è¯•å¤æ‚åµŒå¥—ç»“æ„çš„èµ„æºé™åˆ¶
  let base_context = @azimuth.telemetry.api.context.Context::empty()
  
  // åˆ›å»ºåŒ…å«å¤æ‚åµŒå¥—ç»“æ„çš„å±æ€§
  let mut nested_string_arrays = []
  let mut index = 0
  while index < 100 {
    let mut inner_array = []
    let mut inner_index = 0
    while inner_index < 100 {
      inner_array = inner_array.push("nested.item." + index.to_string() + "." + inner_index.to_string())
      inner_index = inner_index + 1
    }
    nested_string_arrays = nested_string_arrays.push(inner_array.join(","))
    index = index + 1
  }
  
  // åˆ›å»ºåŒ…å«åµŒå¥—æ•°ç»„æ•°ç»„çš„å±æ€§
  let nested_array_attrs = [
    ("nested.string.data", @azimuth.telemetry.api.common.AttributeValue::ArrayStringValue(nested_string_arrays)),
    ("nested.int.data", @azimuth.telemetry.api.common.AttributeValue::ArrayIntValue([
      1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L, 10L,
      11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L, 19L, 20L,
      21L, 22L, 23L, 24L, 25L, 26L, 27L, 28L, 29L, 30L
    ])),
    ("nested.float.data", @azimuth.telemetry.api.common.AttributeValue::ArrayFloatValue([
      1.1, 2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.8, 9.9, 10.0,
      11.1, 12.2, 13.3, 14.4, 15.5, 16.6, 17.7, 18.8, 19.9, 20.0
    ])),
    ("nested.bool.data", @azimuth.telemetry.api.common.AttributeValue::ArrayBoolValue([
      true, false, true, false, true, false, true, false, true, false,
      true, false, true, false, true, false, true, false, true, false
    ]))
  ]
  
  // æµ‹è¯•å¤æ‚åµŒå¥—ç»“æ„çš„Span
  let (_, nested_span) = @azimuth.telemetry.api.trace.NoopTracer::start_span(
    base_context,
    "nested-structure-span",
    Some(@azimuth.telemetry.api.trace.Server),
    Some(nested_array_attrs)
  )
  
  // æµ‹è¯•å¤æ‚åµŒå¥—ç»“æ„çš„LogRecord
  let nested_log = @azimuth.telemetry.api.logs.LogRecord::builder()
    .timestamp(1640995200000000000L)
    .severity(@azimuth.telemetry.api.logs.Info)
    .body("Complex nested structure test")
    .with_attribute("nested.string.data", @azimuth.telemetry.api.common.AttributeValue::ArrayStringValue(nested_string_arrays))
    .with_attribute("nested.int.data", @azimuth.telemetry.api.common.AttributeValue::ArrayIntValue([
      1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L, 10L
    ]))
    .build()
  
  // éªŒè¯å¤æ‚åµŒå¥—ç»“æ„èƒ½å¤Ÿæ­£å¸¸å¤„ç†
  assert_eq(nested_span.name, "nested-structure-span")
  assert_eq(nested_span.attributes.length(), 4)
  assert_eq(nested_log.body, Some("Complex nested structure test"))
  assert_eq(nested_log.attributes.length(), 2)
  
  // éªŒè¯åµŒå¥—æ•°ç»„å¤§å°
  match nested_span.attributes[0] {
    ("nested.string.data", @azimuth.telemetry.api.common.AttributeValue::ArrayStringValue(arr)) => {
      assert_eq(arr.length(), 100)
      assert_eq(arr[0], "nested.item.0.0")
      assert_eq(arr[99], "nested.item.99.99")
    }
    _ => @test.fail("Expected nested.string.data")
  }
  
  match nested_span.attributes[1] {
    ("nested.int.data", @azimuth.telemetry.api.common.AttributeValue::ArrayIntValue(arr)) => {
      assert_eq(arr.length(), 30)
      assert_eq(arr[0], 1L)
      assert_eq(arr[29], 30L)
    }
    _ => @test.fail("Expected nested.int.data")
  }
}
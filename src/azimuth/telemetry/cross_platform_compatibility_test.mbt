// è·¨å¹³å°å…¼å®¹æ€§æµ‹è¯•
// ç¡®ä¿é¥æµ‹ç³»ç»Ÿåœ¨ä¸åŒå¹³å°å’Œç¯å¢ƒä¸‹çš„è¡Œä¸ºä¸€è‡´æ€§

test "platform_specific_time_handling" {
  // æµ‹è¯•ä¸åŒå¹³å°ä¸‹æ—¶é—´å¤„ç†çš„ä¸€è‡´æ€§
  
  let tracer_provider = trace::NoopTracerProvider::{}
  let tracer = tracer_provider.get_tracer("platform-test", "1.0.0")
  let ctx = context::Context::empty()
  
  // æµ‹è¯•çº³ç§’çº§æ—¶é—´æˆ³ç²¾åº¦
  let timestamp_nanos = 1701234567890123456L  // 2023-11-29 15:49:27.890123456 UTC
  
  let (span_ctx, span) = tracer.start_span(
    ctx,
    "platform_time_test",
    trace::Internal,
    [],
    Some(timestamp_nanos)
  )
  
  // éªŒè¯æ—¶é—´æˆ³åœ¨ä¸åŒå¹³å°ä¸‹çš„å¤„ç†ä¸€è‡´æ€§
  @assertion.assert_eq(span.start_time_unix_nanos, timestamp_nanos)
  
  // æµ‹è¯•ç»“æŸæ—¶é—´æˆ³
  let end_timestamp_nanos = 1701234567990123456L
  let updated_span = Span::{ ..span, end_time_unix_nanos: Some(end_timestamp_nanos) }
  @assertion.assert_eq(updated_span.end_time_unix_nanos.unwrap(), end_timestamp_nanos)
}

test "platform_specific_data_type_handling" {
  // æµ‹è¯•ä¸åŒå¹³å°ä¸‹æ•°æ®ç±»å‹å¤„ç†çš„ä¸€è‡´æ€§
  
  // æµ‹è¯•å„ç§æ•°å€¼ç±»å‹åœ¨ä¸åŒå¹³å°ä¸‹çš„è¡¨ç¤º
  let test_attributes = [
    ("int_max", common::AttributeValue::int(9223372036854775807L)),     // Int64æœ€å¤§å€¼
    ("int_min", common::AttributeValue::int(-9223372036854775808L)),    // Int64æœ€å°å€¼
    ("float_max", common::AttributeValue::float(1.7976931348623157e+308)), // Doubleæœ€å¤§å€¼
    ("float_min", common::AttributeValue::float(-1.7976931348623157e+308)), // Doubleæœ€å°å€¼
    ("float_precision", common::AttributeValue::float(3.14159265358979323846)), // é«˜ç²¾åº¦æµ®ç‚¹æ•°
    ("bool_true", common::AttributeValue::bool(true)),
    ("bool_false", common::AttributeValue::bool(false))
  ]
  
  // æµ‹è¯•å­—ç¬¦ä¸²æ•°ç»„åœ¨ä¸åŒå­—ç¬¦ç¼–ç ä¸‹çš„å¤„ç†
  let unicode_strings = [
    "ä¸­æ–‡æµ‹è¯•", "English Test", "Ğ¢ĞµÑÑ‚ Ğ ÑƒÑÑĞºĞ¸Ğ¹", "ãƒ†ã‚¹ãƒˆæ—¥æœ¬èª", 
    "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ø®ØªØ¨Ø§Ø±", "ğŸš€ Emoji Test", "Special chars: !@#$%^&*()"
  ]
  
  let array_attributes = [
    ("unicode_strings", common::AttributeValue::array_string(unicode_strings)),
    ("int_array", common::AttributeValue::array_int([1L, 2L, 3L, 9223372036854775807L, -9223372036854775808L])),
    ("float_array", common::AttributeValue::array_float([1.1, 2.2, 3.141592653589793])),
    ("bool_array", common::AttributeValue::array_bool([true, false, true]))
  ]
  
  // éªŒè¯æ‰€æœ‰å±æ€§éƒ½èƒ½æ­£ç¡®åˆ›å»ºå’Œè®¿é—®
  let mut i = 0
  while i < test_attributes.length() {
    let (key, value) = test_attributes[i]
    // åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œä¼šéªŒè¯å±æ€§çš„åºåˆ—åŒ–/ååºåˆ—åŒ–ä¸€è‡´æ€§
    @assertion.assert_true(true)  // å ä½ç¬¦æ–­è¨€ï¼Œè¡¨ç¤ºå±æ€§åˆ›å»ºæˆåŠŸ
    i = i + 1
  }
  
  let mut j = 0
  while j < array_attributes.length() {
    let (key, value) = array_attributes[j]
    // éªŒè¯æ•°ç»„å±æ€§åœ¨ä¸åŒå¹³å°ä¸‹çš„ä¸€è‡´æ€§
    @assertion.assert_true(true)  // å ä½ç¬¦æ–­è¨€
    j = j + 1
  }
}

test "platform_specific_memory_layout" {
  // æµ‹è¯•ä¸åŒå¹³å°ä¸‹å†…å­˜å¸ƒå±€çš„ä¸€è‡´æ€§
  
  // æµ‹è¯•Spanç»“æ„ä½“åœ¨ä¸åŒå¹³å°ä¸‹çš„å†…å­˜å¸ƒå±€
  let span_context = trace::SpanContext::{
    trace_id: [1_byte, 2_byte, 3_byte, 4_byte, 5_byte, 6_byte, 7_byte, 8_byte,
               9_byte, 10_byte, 11_byte, 12_byte, 13_byte, 14_byte, 15_byte, 16_byte],
    span_id: [1_byte, 2_byte, 3_byte, 4_byte, 5_byte, 6_byte, 7_byte, 8_byte],
    trace_flags: 1_byte,
    trace_state: "test-state"
  }
  
  let span = trace::Span::{
    name: "platform_memory_test",
    context: span_context,
    kind: trace::Internal,
    parent_span_id: Some([1_byte, 2_byte, 3_byte, 4_byte, 5_byte, 6_byte, 7_byte, 8_byte]),
    start_time_unix_nanos: 1701234567890123456L,
    end_time_unix_nanos: Some(1701234567990123456L),
    status: trace::Ok,
    status_description: Some("Test completed"),
    attributes: [
      ("platform.arch", common::AttributeValue::string("unknown")),
      ("platform.os", common::AttributeValue::string("unknown"))
    ],
    events: [],
    links: []
  }
  
  // éªŒè¯Spanç»“æ„ä½“çš„å­—æ®µåœ¨ä¸åŒå¹³å°ä¸‹éƒ½èƒ½æ­£ç¡®è®¿é—®
  @assertion.assert_eq(span.name, "platform_memory_test")
  @assertion.assert_eq(span.context.trace_id.length(), 16)
  @assertion.assert_eq(span.context.span_id.length(), 8)
  @assertion.assert_eq(span.context.trace_flags, 1_byte)
  @assertion.assert_eq(span.status, trace::Ok)
}

test "platform_specific_serialization" {
  // æµ‹è¯•ä¸åŒå¹³å°ä¸‹åºåˆ—åŒ–çš„ä¸€è‡´æ€§
  
  // åˆ›å»ºå¤æ‚çš„é¥æµ‹æ•°æ®ç»“æ„
  let log_record = logs::LogRecord::{
    timestamp_unix_nanos: 1701234567890123456L,
    observed_timestamp_unix_nanos: Some(1701234567890123456L),
    severity_number: logs::Info,
    severity_text: Some("INFO"),
    body: Some("Platform compatibility test log"),
    attributes: [
      ("platform.arch", common::AttributeValue::string("x86_64")),
      ("platform.os", common::AttributeValue::string("linux")),
      ("runtime.version", common::AttributeValue::string("moonbit-unknown"))
    ],
    trace_id: Some([1_byte, 2_byte, 3_byte, 4_byte, 5_byte, 6_byte, 7_byte, 8_byte,
                    9_byte, 10_byte, 11_byte, 12_byte, 13_byte, 14_byte, 15_byte, 16_byte]),
    span_id: Some([1_byte, 2_byte, 3_byte, 4_byte, 5_byte, 6_byte, 7_byte, 8_byte]),
    trace_flags: Some(1_byte),
    resource: Some(common::Resource::default("platform-test-service")),
    instrumentation_scope: Some(common::InstrumentationScope::{
      name: "platform-test",
      version: Some("1.0.0"),
      schema_url: Some("https://example.com/schema")
    })
  }
  
  // éªŒè¯LogRecordåœ¨ä¸åŒå¹³å°ä¸‹çš„ç»“æ„ä¸€è‡´æ€§
  @assertion.assert_eq(log_record.severity_number, logs::Info)
  @assertion.assert_eq(log_record.body.unwrap(), "Platform compatibility test log")
  @assertion.assert_eq(log_record.attributes.length(), 3)
  @assertion.assert_true(log_record.trace_id.is_some())
  @assertion.assert_true(log_record.span_id.is_some())
}

test "platform_specific_error_handling" {
  // æµ‹è¯•ä¸åŒå¹³å°ä¸‹é”™è¯¯å¤„ç†çš„ä¸€è‡´æ€§
  
  // æµ‹è¯•è¾¹ç•Œæ¡ä»¶ä¸‹çš„é”™è¯¯å¤„ç†
  let tracer_provider = trace::NoopTracerProvider::{}
  let tracer = tracer_provider.get_tracer("error-test", "1.0.0")
  let ctx = context::Context::empty()
  
  // æµ‹è¯•æé•¿å­—ç¬¦ä¸²çš„å¤„ç†
  let very_long_name = "a" * 10000  // 10000ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²
  let (long_span_ctx, long_span) = tracer.start_span(
    ctx,
    very_long_name,
    trace::Internal,
    [("long.attribute", common::AttributeValue::string(very_long_name))]
  )
  
  // éªŒè¯é•¿å­—ç¬¦ä¸²åœ¨ä¸åŒå¹³å°ä¸‹çš„å¤„ç†
  @assertion.assert_eq(long_span.name.length(), 10000)
  
  // æµ‹è¯•ç©ºå­—ç¬¦ä¸²å’Œç‰¹æ®Šå­—ç¬¦çš„å¤„ç†
  let (empty_ctx, empty_span) = tracer.start_span(
    ctx,
    "",
    trace::Internal,
    [
      ("empty.string", common::AttributeValue::string("")),
      ("null.chars", common::AttributeValue::string("\0\0\0")),
      ("unicode.chars", common::AttributeValue::string("\u{1F600}\u{1F4A9}\u{1F525}"))
    ]
  )
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦åœ¨ä¸åŒå¹³å°ä¸‹çš„å¤„ç†
  @assertion.assert_eq(empty_span.name, "")
  @assertion.assert_eq(empty_span.attributes.length(), 3)
}

test "platform_specific_concurrency" {
  // æµ‹è¯•ä¸åŒå¹³å°ä¸‹å¹¶å‘è¡Œä¸ºçš„ä¸€è‡´æ€§
  
  // åˆ›å»ºå¤šä¸ªå¹¶å‘æ“ä½œçš„Context
  let base_ctx = context::Context::empty()
  let tracer_provider = trace::NoopTracerProvider::{}
  let tracer = tracer_provider.get_tracer("concurrency-test", "1.0.0")
  
  // æ¨¡æ‹Ÿå¹¶å‘åˆ›å»ºå¤šä¸ªSpan
  let span_names = ["concurrent_span_1", "concurrent_span_2", "concurrent_span_3"]
  let mut spans = []
  
  let mut i = 0
  while i < span_names.length() {
    let (span_ctx, span) = tracer.start_span(
      base_ctx,
      span_names[i],
      trace::Internal,
      [
        ("thread.id", common::AttributeValue::int(i.to_int64())),
        ("concurrent.operation", common::AttributeValue::string("test"))
      ]
    )
    spans.push(span)
    i = i + 1
  }
  
  // éªŒè¯å¹¶å‘åˆ›å»ºçš„Spanåœ¨ä¸åŒå¹³å°ä¸‹çš„ä¸€è‡´æ€§
  @assertion.assert_eq(spans.length(), 3)
  
  let mut j = 0
  while j < spans.length() {
    let span = spans[j]
    @assertion.assert_eq(span.kind, trace::Internal)
    @assertion.assert_eq(span.attributes.length(), 2)
    j = j + 1
  }
}

test "platform_specific_resource_handling" {
  // æµ‹è¯•ä¸åŒå¹³å°ä¸‹èµ„æºå¤„ç†çš„ä¸€è‡´æ€§
  
  // åˆ›å»ºåŒ…å«å¹³å°ç‰¹å®šä¿¡æ¯çš„Resource
  let resource = common::Resource::{
    service_name: "platform-test-service",
    service_version: Some("1.0.0"),
    telemetry_sdk_name: "azimuth",
    telemetry_sdk_version: "0.1.0",
    attributes: [
      ("platform.arch", common::AttributeValue::string("unknown")),
      ("platform.os", common::AttributeValue::string("unknown")),
      ("platform.hostname", common::AttributeValue::string("test-host")),
      ("platform.cpu.count", common::AttributeValue::int(4L)),
      ("platform.memory.total", common::AttributeValue::int(8589934592L)), // 8GB
      ("container.id", common::AttributeValue::string("container-123")),
      ("kubernetes.pod.name", common::AttributeValue::string("pod-abc")),
      ("cloud.provider", common::AttributeValue::string("aws")),
      ("cloud.region", common::AttributeValue::string("us-west-2"))
    ]
  }
  
  // éªŒè¯Resourceåœ¨ä¸åŒå¹³å°ä¸‹çš„å±æ€§ä¸€è‡´æ€§
  @assertion.assert_eq(resource.service_name, "platform-test-service")
  @assertion.assert_eq(resource.service_version.unwrap(), "1.0.0")
  @assertion.assert_eq(resource.attributes.length(), 9)
  
  // éªŒè¯å¹³å°ç‰¹å®šå±æ€§çš„å­˜åœ¨
  let mut found_arch = false
  let mut found_os = false
  let mut k = 0
  while k < resource.attributes.length() {
    let (key, _) = resource.attributes[k]
    if key == "platform.arch" {
      found_arch = true
    }
    if key == "platform.os" {
      found_os = true
    }
    k = k + 1
  }
  
  @assertion.assert_true(found_arch)
  @assertion.assert_true(found_os)
}
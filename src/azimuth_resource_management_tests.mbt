// Azimuth Resource Management Test Suite
// æµ‹è¯•èµ„æºç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬èµ„æºåˆ›å»ºã€åˆå¹¶ã€æ¸…ç†å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†

test "åŸºæœ¬èµ„æºåˆ›å»ºå’Œå±žæ€§è®¿é—®" {
  // åˆ›å»ºåŸºæœ¬èµ„æº
  let resource = azimuth::Resource {
    attributes: [
      ("service.name", azimuth::AttributeValue::StringValue("payment-service")),
      ("service.version", azimuth::AttributeValue::StringValue("2.1.0")),
      ("service.instance.id", azimuth::AttributeValue::StringValue("instance-001"))
    ]
  }
  
  // éªŒè¯èµ„æºå±žæ€§æ•°é‡
  assert_eq(resource.attributes.length(), 3)
  
  // éªŒè¯èµ„æºå±žæ€§å†…å®¹
  let mut found_service_name = false
  let mut found_service_version = false
  let mut found_instance_id = false
  
  for (key, value) in resource.attributes {
    match key {
      "service.name" => {
        found_service_name = true
        match value {
          azimuth::AttributeValue::StringValue(name) => assert_eq(name, "payment-service")
          _ => assert_true(false)
        }
      }
      "service.version" => {
        found_service_version = true
        match value {
          azimuth::AttributeValue::StringValue(version) => assert_eq(version, "2.1.0")
          _ => assert_true(false)
        }
      }
      "service.instance.id" => {
        found_instance_id = true
        match value {
          azimuth::AttributeValue::StringValue(id) => assert_eq(id, "instance-001")
          _ => assert_true(false)
        }
      }
      _ => assert_true(false)
    }
  }
  
  assert_true(found_service_name)
  assert_true(found_service_version)
  assert_true(found_instance_id)
}

test "ç©ºèµ„æºå’Œé»˜è®¤èµ„æº" {
  // åˆ›å»ºç©ºèµ„æº
  let empty_resource = azimuth::Resource { attributes: [] }
  assert_eq(empty_resource.attributes.length(), 0)
  
  // åˆ›å»ºé»˜è®¤æœåŠ¡èµ„æº
  let default_resource = azimuth::Resource {
    attributes: [
      ("service.name", azimuth::AttributeValue::StringValue("unknown-service")),
      ("service.version", azimuth::AttributeValue::StringValue("0.0.0")),
      ("telemetry.sdk.name", azimuth::AttributeValue::StringValue("azimuth")),
      ("telemetry.sdk.version", azimuth::AttributeValue::StringValue("1.0.0")),
      ("telemetry.sdk.language", azimuth::AttributeValue::StringValue("moonbit"))
    ]
  }
  
  assert_eq(default_resource.attributes.length(), 5)
  
  // éªŒè¯SDKå±žæ€§
  let mut found_sdk_name = false
  let mut found_sdk_version = false
  let mut found_sdk_language = false
  
  for (key, value) in default_resource.attributes {
    match key {
      "telemetry.sdk.name" => {
        found_sdk_name = true
        match value {
          azimuth::AttributeValue::StringValue(name) => assert_eq(name, "azimuth")
          _ => assert_true(false)
        }
      }
      "telemetry.sdk.version" => {
        found_sdk_version = true
        match value {
          azimuth::AttributeValue::StringValue(version) => assert_eq(version, "1.0.0")
          _ => assert_true(false)
        }
      }
      "telemetry.sdk.language" => {
        found_sdk_language = true
        match value {
          azimuth::AttributeValue::StringValue(lang) => assert_eq(lang, "moonbit")
          _ => assert_true(false)
        }
      }
      _ => () // å…¶ä»–å±žæ€§
    }
  }
  
  assert_true(found_sdk_name)
  assert_true(found_sdk_version)
  assert_true(found_sdk_language)
}

test "ä¸»æœºèµ„æºåˆ›å»º" {
  // åˆ›å»ºä¸»æœºç›¸å…³èµ„æº
  let host_resource = azimuth::Resource {
    attributes: [
      ("host.name", azimuth::AttributeValue::StringValue("web-server-01")),
      ("host.id", azimuth::AttributeValue::StringValue("host-abc123")),
      ("host.type", azimuth::AttributeValue::StringValue("virtual-machine")),
      ("host.arch", azimuth::AttributeValue::StringValue("x86_64")),
      ("host.image.name", azimuth::AttributeValue::StringValue("ubuntu-20.04")),
      ("host.image.id", azimuth::AttributeValue::StringValue("ami-12345678")),
      ("host.ip", azimuth::AttributeValue::StringValue("10.0.1.100")),
      ("host.mac", azimuth::AttributeValue::StringValue("00:1b:44:11:3a:b7"))
    ]
  }
  
  assert_eq(host_resource.attributes.length(), 8)
  
  // éªŒè¯ä¸»æœºå±žæ€§
  let mut found_host_name = false
  let mut found_host_ip = false
  let mut found_host_arch = false
  
  for (key, value) in host_resource.attributes {
    match key {
      "host.name" => {
        found_host_name = true
        match value {
          azimuth::AttributeValue::StringValue(name) => assert_eq(name, "web-server-01")
          _ => assert_true(false)
        }
      }
      "host.ip" => {
        found_host_ip = true
        match value {
          azimuth::AttributeValue::StringValue(ip) => assert_eq(ip, "10.0.1.100")
          _ => assert_true(false)
        }
      }
      "host.arch" => {
        found_host_arch = true
        match value {
          azimuth::AttributeValue::StringValue(arch) => assert_eq(arch, "x86_64")
          _ => assert_true(false)
        }
      }
      _ => () // å…¶ä»–å±žæ€§
    }
  }
  
  assert_true(found_host_name)
  assert_true(found_host_ip)
  assert_true(found_host_arch)
}

test "å®¹å™¨èµ„æºåˆ›å»º" {
  // åˆ›å»ºå®¹å™¨ç›¸å…³èµ„æº
  let container_resource = azimuth::Resource {
    attributes: [
      ("container.name", azimuth::AttributeValue::StringValue("payment-api-container")),
      ("container.id", azimuth::AttributeValue::StringValue("container-123456789")),
      ("container.image.name", azimuth::AttributeValue::StringValue("payment-api:latest")),
      ("container.image.tag", azimuth::AttributeValue::StringValue("latest")),
      ("container.runtime", azimuth::AttributeValue::StringValue("docker")),
      ("container.command", azimuth::AttributeValue::StringValue("/usr/bin/payment-api")),
      ("container.args", azimuth::AttributeValue::ArrayStringValue(["--port", "8080", "--config", "/etc/config.yaml"]))
    ]
  }
  
  assert_eq(container_resource.attributes.length(), 7)
  
  // éªŒè¯å®¹å™¨å±žæ€§
  let mut found_container_name = false
  let mut found_container_id = false
  let mut found_container_runtime = false
  let mut found_container_args = false
  
  for (key, value) in container_resource.attributes {
    match key {
      "container.name" => {
        found_container_name = true
        match value {
          azimuth::AttributeValue::StringValue(name) => assert_eq(name, "payment-api-container")
          _ => assert_true(false)
        }
      }
      "container.id" => {
        found_container_id = true
        match value {
          azimuth::AttributeValue::StringValue(id) => assert_eq(id, "container-123456789")
          _ => assert_true(false)
        }
      }
      "container.runtime" => {
        found_container_runtime = true
        match value {
          azimuth::AttributeValue::StringValue(runtime) => assert_eq(runtime, "docker")
          _ => assert_true(false)
        }
      }
      "container.args" => {
        found_container_args = true
        match value {
          azimuth::AttributeValue::ArrayStringValue(args) => {
            assert_eq(args.length(), 4)
            assert_eq(args[0], "--port")
            assert_eq(args[1], "8080")
            assert_eq(args[2], "--config")
            assert_eq(args[3], "/etc/config.yaml")
          }
          _ => assert_true(false)
        }
      }
      _ => () // å…¶ä»–å±žæ€§
    }
  }
  
  assert_true(found_container_name)
  assert_true(found_container_id)
  assert_true(found_container_runtime)
  assert_true(found_container_args)
}

test "Kubernetesèµ„æºåˆ›å»º" {
  // åˆ›å»ºKubernetesç›¸å…³èµ„æº
  let k8s_resource = azimuth::Resource {
    attributes: [
      ("k8s.namespace.name", azimuth::AttributeValue::StringValue("production")),
      ("k8s.pod.name", azimuth::AttributeValue::StringValue("payment-api-7d4f8c9b5-abcde")),
      ("k8s.pod.uid", azimuth::AttributeValue::StringValue("12345678-1234-1234-1234-123456789abc")),
      ("k8s.deployment.name", azimuth::AttributeValue::StringValue("payment-api")),
      ("k8s.replicaset.name", azimuth::AttributeValue::StringValue("payment-api-7d4f8c9b5")),
      ("k8s.node.name", azimuth::AttributeValue::StringValue("worker-node-01")),
      ("k8s.service.name", azimuth::AttributeValue::StringValue("payment-api-service")),
      ("k8s.cluster.name", azimuth::AttributeValue::StringValue("prod-cluster"))
    ]
  }
  
  assert_eq(k8s_resource.attributes.length(), 8)
  
  // éªŒè¯Kuberneteså±žæ€§
  let mut found_namespace = false
  let mut found_pod_name = false
  let mut found_deployment = false
  let mut found_cluster = false
  
  for (key, value) in k8s_resource.attributes {
    match key {
      "k8s.namespace.name" => {
        found_namespace = true
        match value {
          azimuth::AttributeValue::StringValue(ns) => assert_eq(ns, "production")
          _ => assert_true(false)
        }
      }
      "k8s.pod.name" => {
        found_pod_name = true
        match value {
          azimuth::AttributeValue::StringValue(pod) => assert_eq(pod, "payment-api-7d4f8c9b5-abcde")
          _ => assert_true(false)
        }
      }
      "k8s.deployment.name" => {
        found_deployment = true
        match value {
          azimuth::AttributeValue::StringValue(deployment) => assert_eq(deployment, "payment-api")
          _ => assert_true(false)
        }
      }
      "k8s.cluster.name" => {
        found_cluster = true
        match value {
          azimuth::AttributeValue::StringValue(cluster) => assert_eq(cluster, "prod-cluster")
          _ => assert_true(false)
        }
      }
      _ => () // å…¶ä»–å±žæ€§
    }
  }
  
  assert_true(found_namespace)
  assert_true(found_pod_name)
  assert_true(found_deployment)
  assert_true(found_cluster)
}

test "äº‘å¹³å°èµ„æºåˆ›å»º" {
  // åˆ›å»ºäº‘å¹³å°ç›¸å…³èµ„æº
  let cloud_resource = azimuth::Resource {
    attributes: [
      ("cloud.provider", azimuth::AttributeValue::StringValue("aws")),
      ("cloud.account.id", azimuth::AttributeValue::StringValue("123456789012")),
      ("cloud.region", azimuth::AttributeValue::StringValue("us-west-2")),
      ("cloud.availability_zone", azimuth::AttributeValue::StringValue("us-west-2a")),
      ("cloud.platform", azimuth::AttributeValue::StringValue("aws_ec2")),
      ("aws.ec2.instance.id", azimuth::AttributeValue::StringValue("i-1234567890abcdef0")),
      ("aws.ec2.instance.type", azimuth::AttributeValue::StringValue("t3.medium")),
      ("aws.ec2.instance.life_cycle", azimuth::AttributeValue::StringValue("on-demand"))
    ]
  }
  
  assert_eq(cloud_resource.attributes.length(), 8)
  
  // éªŒè¯äº‘å¹³å°å±žæ€§
  let mut found_provider = false
  let mut found_region = false
  let mut found_instance_id = false
  let mut found_instance_type = false
  
  for (key, value) in cloud_resource.attributes {
    match key {
      "cloud.provider" => {
        found_provider = true
        match value {
          azimuth::AttributeValue::StringValue(provider) => assert_eq(provider, "aws")
          _ => assert_true(false)
        }
      }
      "cloud.region" => {
        found_region = true
        match value {
          azimuth::AttributeValue::StringValue(region) => assert_eq(region, "us-west-2")
          _ => assert_true(false)
        }
      }
      "aws.ec2.instance.id" => {
        found_instance_id = true
        match value {
          azimuth::AttributeValue::StringValue(id) => assert_eq(id, "i-1234567890abcdef0")
          _ => assert_true(false)
        }
      }
      "aws.ec2.instance.type" => {
        found_instance_type = true
        match value {
          azimuth::AttributeValue::StringValue(type) => assert_eq(type, "t3.medium")
          _ => assert_true(false)
        }
      }
      _ => () // å…¶ä»–å±žæ€§
    }
  }
  
  assert_true(found_provider)
  assert_true(found_region)
  assert_true(found_instance_id)
  assert_true(found_instance_type)
}

test "èµ„æºåˆå¹¶æ“ä½œ" {
  // åˆ›å»ºç¬¬ä¸€ä¸ªèµ„æº
  let resource1 = azimuth::Resource {
    attributes: [
      ("service.name", azimuth::AttributeValue::StringValue("user-service")),
      ("service.version", azimuth::AttributeValue::StringValue("1.0.0")),
      ("host.name", azimuth::AttributeValue::StringValue("host-001"))
    ]
  }
  
  // åˆ›å»ºç¬¬äºŒä¸ªèµ„æº
  let resource2 = azimuth::Resource {
    attributes: [
      ("service.version", azimuth::AttributeValue::StringValue("1.1.0")), // è¦†ç›–ç‰ˆæœ¬
      ("deployment.environment", azimuth::AttributeValue::StringValue("staging")),
      ("cloud.provider", azimuth::AttributeValue::StringValue("gcp"))
    ]
  }
  
  // æ¨¡æ‹Ÿåˆå¹¶æ“ä½œï¼šç¬¬ä¸€ä¸ªèµ„æºçš„å±žæ€§ä¼˜å…ˆ
  let mut merged_attributes = resource1.attributes
  
  // æ·»åŠ ç¬¬äºŒä¸ªèµ„æºä¸­ä¸å­˜åœ¨çš„å±žæ€§
  for (key2, value2) in resource2.attributes {
    let mut found = false
    for (key1, _) in resource1.attributes {
      if key1 == key2 {
        found = true
        break
      }
    }
    
    if not found {
      merged_attributes = merged_attributes + [(key2, value2)]
    }
  }
  
  let merged_resource = azimuth::Resource { attributes: merged_attributes }
  
  // éªŒè¯åˆå¹¶ç»“æžœ
  assert_eq(merged_resource.attributes.length(), 5)
  
  // éªŒè¯service.versionä¿æŒåŽŸå€¼
  let mut found_version = false
  for (key, value) in merged_resource.attributes {
    if key == "service.version" {
      found_version = true
      match value {
        azimuth::AttributeValue::StringValue(v) => assert_eq(v, "1.0.0") // ä¿æŒåŽŸå€¼
        _ => assert_true(false)
      }
    }
  }
  assert_true(found_version)
  
  // éªŒè¯æ–°æ·»åŠ çš„å±žæ€§
  let mut found_env = false
  let mut found_provider = false
  for (key, value) in merged_resource.attributes {
    if key == "deployment.environment" {
      found_env = true
      match value {
        azimuth::AttributeValue::StringValue(env) => assert_eq(env, "staging")
        _ => assert_true(false)
      }
    } else if key == "cloud.provider" {
      found_provider = true
      match value {
        azimuth::AttributeValue::StringValue(p) => assert_eq(p, "gcp")
        _ => assert_true(false)
      }
    }
  }
  assert_true(found_env)
  assert_true(found_provider)
}

test "èµ„æºå±žæ€§è¿‡æ»¤" {
  // åˆ›å»ºå®Œæ•´çš„èµ„æº
  let resource = azimuth::Resource {
    attributes: [
      ("service.name", azimuth::AttributeValue::StringValue("order-service")),
      ("service.version", azimuth::AttributeValue::StringValue("2.1.0")),
      ("host.name", azimuth::AttributeValue::StringValue("order-host-01")),
      ("host.ip", azimuth::AttributeValue::StringValue("10.0.2.100")),
      ("deployment.environment", azimuth::AttributeValue::StringValue("production")),
      ("cloud.provider", azimuth::AttributeValue::StringValue("azure")),
      ("k8s.namespace.name", azimuth::AttributeValue::StringValue("orders")),
      ("k8s.pod.name", azimuth::AttributeValue::StringValue("order-service-7d4f8c9b5-abcde"))
    ]
  }
  
  // è¿‡æ»¤ä»¥"service."å¼€å¤´çš„å±žæ€§
  let mut service_attrs = []
  for (key, value) in resource.attributes {
    if key.starts_with("service.") {
      service_attrs = service_attrs + [(key, value)]
    }
  }
  
  assert_eq(service_attrs.length(), 2)
  
  // è¿‡æ»¤ä»¥"host."å¼€å¤´çš„å±žæ€§
  let mut host_attrs = []
  for (key, value) in resource.attributes {
    if key.starts_with("host.") {
      host_attrs = host_attrs + [(key, value)]
    }
  }
  
  assert_eq(host_attrs.length(), 2)
  
  // è¿‡æ»¤ä»¥"k8s."å¼€å¤´çš„å±žæ€§
  let mut k8s_attrs = []
  for (key, value) in resource.attributes {
    if key.starts_with("k8s.") {
      k8s_attrs = k8s_attrs + [(key, value)]
    }
  }
  
  assert_eq(k8s_attrs.length(), 2)
}

test "èµ„æºå±žæ€§æ›´æ–°" {
  // åˆ›å»ºåˆå§‹èµ„æº
  let mut resource = azimuth::Resource {
    attributes: [
      ("service.name", azimuth::AttributeValue::StringValue("auth-service")),
      ("service.version", azimuth::AttributeValue::StringValue("1.0.0")),
      ("host.name", azimuth::AttributeValue::StringValue("auth-host-01"))
    ]
  }
  
  // æ›´æ–°serviceç‰ˆæœ¬
  let mut updated_attributes = []
  for (key, value) in resource.attributes {
    if key == "service.version" {
      updated_attributes = updated_attributes + [("service.version", azimuth::AttributeValue::StringValue("1.1.0"))]
    } else {
      updated_attributes = updated_attributes + [(key, value)]
    }
  }
  
  // æ·»åŠ æ–°çš„äº‘å±žæ€§
  updated_attributes = updated_attributes + [
    ("cloud.provider", azimuth::AttributeValue::StringValue("aws")),
    ("cloud.region", azimuth::AttributeValue::StringValue("us-east-1"))
  ]
  
  resource.attributes = updated_attributes
  
  // éªŒè¯æ›´æ–°ç»“æžœ
  assert_eq(resource.attributes.length(), 5)
  
  // éªŒè¯ç‰ˆæœ¬å·²æ›´æ–°
  let mut found_updated_version = false
  let mut found_cloud_provider = false
  let mut found_cloud_region = false
  
  for (key, value) in resource.attributes {
    match key {
      "service.version" => {
        match value {
          azimuth::AttributeValue::StringValue(version) => {
            if version == "1.1.0" {
              found_updated_version = true
            }
          }
          _ => assert_true(false)
        }
      }
      "cloud.provider" => {
        found_cloud_provider = true
        match value {
          azimuth::AttributeValue::StringValue(provider) => assert_eq(provider, "aws")
          _ => assert_true(false)
        }
      }
      "cloud.region" => {
        found_cloud_region = true
        match value {
          azimuth::AttributeValue::StringValue(region) => assert_eq(region, "us-east-1")
          _ => assert_true(false)
        }
      }
      _ => () // å…¶ä»–å±žæ€§
    }
  }
  
  assert_true(found_updated_version)
  assert_true(found_cloud_provider)
  assert_true(found_cloud_region)
}

test "èµ„æºè¾¹ç•Œæ¡ä»¶æµ‹è¯•" {
  // æµ‹è¯•ç©ºèµ„æº
  let empty_resource = azimuth::Resource { attributes: [] }
  assert_eq(empty_resource.attributes.length(), 0)
  
  // æµ‹è¯•åŒ…å«ç©ºå€¼çš„å±žæ€§
  let nullish_resource = azimuth::Resource {
    attributes: [
      ("empty.string", azimuth::AttributeValue::StringValue("")),
      ("zero.int", azimuth::AttributeValue::IntValue(0)),
      ("zero.float", azimuth::AttributeValue::FloatValue(0.0)),
      ("false.bool", azimuth::AttributeValue::BoolValue(false))
    ]
  }
  
  // éªŒè¯ç©ºå€¼å±žæ€§
  for (key, value) in nullish_resource.attributes {
    match key {
      "empty.string" => {
        match value {
          azimuth::AttributeValue::StringValue(s) => assert_eq(s, "")
          _ => assert_true(false)
        }
      }
      "zero.int" => {
        match value {
          azimuth::AttributeValue::IntValue(i) => assert_eq(i, 0)
          _ => assert_true(false)
        }
      }
      "zero.float" => {
        match value {
          azimuth::AttributeValue::FloatValue(f) => assert_true(f == 0.0)
          _ => assert_true(false)
        }
      }
      "false.bool" => {
        match value {
          azimuth::AttributeValue::BoolValue(b) => assert_false(b)
          _ => assert_true(false)
        }
      }
      _ => assert_true(false)
    }
  }
  
  // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å’Œé•¿å­—ç¬¦ä¸²
  let special_resource = azimuth::Resource {
    attributes: [
      ("special.chars", azimuth::AttributeValue::StringValue("!@#$%^&*()_+-={}[]|\\:;\"'<>?,./")),
      ("unicode.chars", azimuth::AttributeValue::StringValue("æµ‹è¯•ä¸­æ–‡ðŸš€emoji")),
      ("very.long.key.name.that.exceeds.normal.expectations.and.tests.boundary.conditions", 
       azimuth::AttributeValue::StringValue("long-key-value"))
    ]
  }
  
  // éªŒè¯ç‰¹æ®Šå­—ç¬¦å¤„ç†
  for (key, value) in special_resource.attributes {
    match value {
      azimuth::AttributeValue::StringValue(s) => {
        assert_true(s.length() > 0)
        // éªŒè¯å­—ç¬¦ä¸²å†…å®¹ä¸ä¸ºç©º
        assert_false(s == "")
      }
      _ => assert_true(false)
    }
  }
}
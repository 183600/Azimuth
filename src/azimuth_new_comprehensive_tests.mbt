// Azimuth New Comprehensive Test Suite
// æ–°çš„ç»¼åˆæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–é¥æµ‹ç³»ç»Ÿçš„é«˜çº§åŠŸèƒ½å’Œè¾¹ç¼˜åœºæ™¯

// æµ‹è¯•1: æ—¶é—´åºåˆ—æ•°æ®å¤„ç†
test "æ—¶é—´åºåˆ—æ•°æ®å¤„ç†æµ‹è¯•" {
  // åˆ›å»ºæ—¶é—´åºåˆ—ç®¡ç†å™¨
  let ts_manager = TimeSeriesManager::new()
  
  // æ·»åŠ æ—¶é—´åºåˆ—æ•°æ®ç‚¹
  let timestamp1 = 1735689600000000000L  // 2025-01-01 00:00:00 UTC
  let timestamp2 = 1735689660000000000L  // 2025-01-01 00:01:00 UTC
  let timestamp3 = 1735689720000000000L  // 2025-01-01 00:02:00 UTC
  
  TimeSeriesManager::add_point(ts_manager, "cpu.usage", timestamp1, 45.2)
  TimeSeriesManager::add_point(ts_manager, "cpu.usage", timestamp2, 52.8)
  TimeSeriesManager::add_point(ts_manager, "cpu.usage", timestamp3, 48.1)
  
  TimeSeriesManager::add_point(ts_manager, "memory.usage", timestamp1, 1024.0)
  TimeSeriesManager::add_point(ts_manager, "memory.usage", timestamp2, 1089.5)
  TimeSeriesManager::add_point(ts_manager, "memory.usage", timestamp3, 1102.3)
  
  // æµ‹è¯•æ—¶é—´èŒƒå›´æŸ¥è¯¢
  let cpu_data = TimeSeriesManager::query_range(ts_manager, "cpu.usage", timestamp1, timestamp3)
  let memory_data = TimeSeriesManager::query_range(ts_manager, "memory.usage", timestamp1, timestamp3)
  
  // éªŒè¯æŸ¥è¯¢ç»“æœ
  assert_eq(TimeSeriesData::point_count(cpu_data), 3)
  assert_eq(TimeSeriesData::point_count(memory_data), 3)
  
  // æµ‹è¯•æ—¶é—´åºåˆ—èšåˆ
  let cpu_avg = TimeSeriesManager::aggregate(ts_manager, "cpu.usage", timestamp1, timestamp3, "avg")
  let cpu_max = TimeSeriesManager::aggregate(ts_manager, "cpu.usage", timestamp1, timestamp3, "max")
  let cpu_min = TimeSeriesManager::aggregate(ts_manager, "cpu.usage", timestamp1, timestamp3, "min")
  
  // éªŒè¯èšåˆç»“æœ
  assert_eq(cpu_avg, 48.7)  // (45.2 + 52.8 + 48.1) / 3
  assert_eq(cpu_max, 52.8)
  assert_eq(cpu_min, 45.2)
  
  // æµ‹è¯•æ—¶é—´çª—å£ç»Ÿè®¡
  let window_stats = TimeSeriesManager::window_stats(ts_manager, "memory.usage", timestamp1, timestamp3, 60)
  
  // éªŒè¯çª—å£ç»Ÿè®¡
  assert_eq(WindowStats::window_count(window_stats), 3)
  assert_eq(WindowStats::total_points(window_stats), 3)
}

// æµ‹è¯•2: èµ„æºé™åˆ¶å’Œæ¢å¤
test "èµ„æºé™åˆ¶å’Œæ¢å¤æµ‹è¯•" {
  // åˆ›å»ºèµ„æºé™åˆ¶ç®¡ç†å™¨
  let resource_manager = ResourceManager::new()
  
  // è®¾ç½®èµ„æºé™åˆ¶
  ResourceManager::set_limit(resource_manager, "max.spans", 1000)
  ResourceManager::set_limit(resource_manager, "max.metrics", 5000)
  ResourceManager::set_limit(resource_manager, "max.logs", 2000)
  ResourceManager::set_limit(resource_manager, "memory.usage.mb", 100)
  
  // éªŒè¯é™åˆ¶è®¾ç½®
  assert_eq(ResourceManager::get_limit(resource_manager, "max.spans"), 1000)
  assert_eq(ResourceManager::get_limit(resource_manager, "max.metrics"), 5000)
  assert_eq(ResourceManager::get_limit(resource_manager, "max.logs"), 2000)
  assert_eq(ResourceManager::get_limit(resource_manager, "memory.usage.mb"), 100)
  
  // æ¨¡æ‹Ÿèµ„æºä½¿ç”¨
  ResourceManager::increment_usage(resource_manager, "max.spans", 500)
  ResourceManager::increment_usage(resource_manager, "max.metrics", 2500)
  ResourceManager::increment_usage(resource_manager, "max.logs", 1000)
  ResourceManager::increment_usage(resource_manager, "memory.usage.mb", 50)
  
  // éªŒè¯èµ„æºä½¿ç”¨
  assert_eq(ResourceManager::get_usage(resource_manager, "max.spans"), 500)
  assert_eq(ResourceManager::get_usage(resource_manager, "max.metrics"), 2500)
  assert_eq(ResourceManager::get_usage(resource_manager, "max.logs"), 1000)
  assert_eq(ResourceManager::get_usage(resource_manager, "memory.usage.mb"), 50)
  
  // æµ‹è¯•èµ„æºé™åˆ¶æ£€æŸ¥
  assert_true(ResourceManager::check_limit(resource_manager, "max.spans", 400))  // 500 + 400 <= 1000
  assert_false(ResourceManager::check_limit(resource_manager, "max.spans", 600))  // 500 + 600 > 1000
  
  // æµ‹è¯•èµ„æºæ¢å¤
  ResourceManager::decrement_usage(resource_manager, "max.spans", 200)
  ResourceManager::decrement_usage(resource_manager, "max.metrics", 1000)
  ResourceManager::decrement_usage(resource_manager, "max.logs", 500)
  ResourceManager::decrement_usage(resource_manager, "memory.usage.mb", 25)
  
  // éªŒè¯èµ„æºæ¢å¤
  assert_eq(ResourceManager::get_usage(resource_manager, "max.spans"), 300)
  assert_eq(ResourceManager::get_usage(resource_manager, "max.metrics"), 1500)
  assert_eq(ResourceManager::get_usage(resource_manager, "max.logs"), 500)
  assert_eq(ResourceManager::get_usage(resource_manager, "memory.usage.mb"), 25)
  
  // æµ‹è¯•èµ„æºæ¸…ç†
  ResourceManager::clear_usage(resource_manager, "max.spans")
  ResourceManager::clear_usage(resource_manager, "max.metrics")
  ResourceManager::clear_usage(resource_manager, "max.logs")
  ResourceManager::clear_usage(resource_manager, "memory.usage.mb")
  
  // éªŒè¯èµ„æºæ¸…ç†
  assert_eq(ResourceManager::get_usage(resource_manager, "max.spans"), 0)
  assert_eq(ResourceManager::get_usage(resource_manager, "max.metrics"), 0)
  assert_eq(ResourceManager::get_usage(resource_manager, "max.logs"), 0)
  assert_eq(ResourceManager::get_usage(resource_manager, "memory.usage.mb"), 0)
}

// æµ‹è¯•3: é…ç½®åŠ¨æ€æ›´æ–°
test "é…ç½®åŠ¨æ€æ›´æ–°æµ‹è¯•" {
  // åˆ›å»ºé…ç½®ç®¡ç†å™¨
  let config_manager = ConfigurationManager::new()
  
  // è®¾ç½®åˆå§‹é…ç½®
  ConfigurationManager::set(config_manager, "service.name", "azimuth-telemetry")
  ConfigurationManager::set(config_manager, "service.version", "1.0.0")
  ConfigurationManager::set(config_manager, "sampling.rate", "0.1")
  ConfigurationManager::set(config_manager, "batch.size", "100")
  ConfigurationManager::set(config_manager, "export.interval", "5000")
  
  // éªŒè¯åˆå§‹é…ç½®
  assert_eq(ConfigurationManager::get(config_manager, "service.name"), Some("azimuth-telemetry"))
  assert_eq(ConfigurationManager::get(config_manager, "service.version"), Some("1.0.0"))
  assert_eq(ConfigurationManager::get(config_manager, "sampling.rate"), Some("0.1"))
  assert_eq(ConfigurationManager::get(config_manager, "batch.size"), Some("100"))
  assert_eq(ConfigurationManager::get(config_manager, "export.interval"), Some("5000"))
  
  // æµ‹è¯•é…ç½®æ›´æ–°
  ConfigurationManager::update(config_manager, "service.version", "1.1.0")
  ConfigurationManager::update(config_manager, "sampling.rate", "0.2")
  ConfigurationManager::update(config_manager, "batch.size", "200")
  
  // éªŒè¯é…ç½®æ›´æ–°
  assert_eq(ConfigurationManager::get(config_manager, "service.name"), Some("azimuth-telemetry"))
  assert_eq(ConfigurationManager::get(config_manager, "service.version"), Some("1.1.0"))
  assert_eq(ConfigurationManager::get(config_manager, "sampling.rate"), Some("0.2"))
  assert_eq(ConfigurationManager::get(config_manager, "batch.size"), Some("200"))
  assert_eq(ConfigurationManager::get(config_manager, "export.interval"), Some("5000"))
  
  // æµ‹è¯•é…ç½®ç›‘å¬å™¨
  let listener = ConfigChangeListener::new()
  ConfigurationManager::add_listener(config_manager, "service.version", listener)
  
  // æ›´æ–°é…ç½®å¹¶è§¦å‘ç›‘å¬å™¨
  ConfigurationManager::update(config_manager, "service.version", "1.2.0")
  
  // éªŒè¯ç›‘å¬å™¨è¢«è§¦å‘
  assert_eq(ConfigChangeListener::last_key(listener), Some("service.version"))
  assert_eq(ConfigChangeListener::last_old_value(listener), Some("1.1.0"))
  assert_eq(ConfigChangeListener::last_new_value(listener), Some("1.2.0"))
  
  // æµ‹è¯•é…ç½®æ‰¹é‡æ›´æ–°
  let updates = [
    ("service.name", "azimuth-telemetry-v2"),
    ("sampling.rate", "0.3"),
    ("batch.size", "300"),
    ("export.interval", "10000")
  ]
  
  ConfigurationManager::batch_update(config_manager, updates)
  
  // éªŒè¯æ‰¹é‡æ›´æ–°
  assert_eq(ConfigurationManager::get(config_manager, "service.name"), Some("azimuth-telemetry-v2"))
  assert_eq(ConfigurationManager::get(config_manager, "sampling.rate"), Some("0.3"))
  assert_eq(ConfigurationManager::get(config_manager, "batch.size"), Some("300"))
  assert_eq(ConfigurationManager::get(config_manager, "export.interval"), Some("10000"))
  
  // æµ‹è¯•é…ç½®é‡ç½®
  ConfigurationManager::reset(config_manager, "service.version")
  
  // éªŒè¯é…ç½®é‡ç½®
  assert_eq(ConfigurationManager::get(config_manager, "service.version"), None)
}

// æµ‹è¯•4: å›½é™…åŒ–æ”¯æŒ
test "å›½é™…åŒ–æ”¯æŒæµ‹è¯•" {
  // åˆ›å»ºå›½é™…åŒ–ç®¡ç†å™¨
  let i18n_manager = I18nManager::new()
  
  // æ·»åŠ ä¸åŒè¯­è¨€çš„èµ„æº
  I18nManager::add_resource(i18n_manager, "en", "span.started", "Span started")
  I18nManager::add_resource(i18n_manager, "en", "span.ended", "Span ended")
  I18nManager::add_resource(i18n_manager, "en", "metric.recorded", "Metric recorded")
  I18nManager::add_resource(i18n_manager, "en", "log.emitted", "Log emitted")
  
  I18nManager::add_resource(i18n_manager, "zh", "span.started", "Spanå·²å¯åŠ¨")
  I18nManager::add_resource(i18n_manager, "zh", "span.ended", "Spanå·²ç»“æŸ")
  I18nManager::add_resource(i18n_manager, "zh", "metric.recorded", "åº¦é‡å·²è®°å½•")
  I18nManager::add_resource(i18n_manager, "zh", "log.emitted", "æ—¥å¿—å·²å‘å‡º")
  
  I18nManager::add_resource(i18n_manager, "ja", "span.started", "SpanãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ")
  I18nManager::add_resource(i18n_manager, "ja", "span.ended", "SpanãŒçµ‚äº†ã—ã¾ã—ãŸ")
  I18nManager::add_resource(i18n_manager, "ja", "metric.recorded", "ãƒ¡ãƒˆãƒªãƒƒã‚¯ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸ")
  I18nManager::add_resource(i18n_manager, "ja", "log.emitted", "ãƒ­ã‚°ãŒç™ºè¡Œã•ã‚Œã¾ã—ãŸ")
  
  // è®¾ç½®é»˜è®¤è¯­è¨€
  I18nManager::set_default_locale(i18n_manager, "en")
  
  // æµ‹è¯•è‹±æ–‡æœ¬åœ°åŒ–
  assert_eq(I18nManager::get_message(i18n_manager, "en", "span.started"), Some("Span started"))
  assert_eq(I18nManager::get_message(i18n_manager, "en", "span.ended"), Some("Span ended"))
  assert_eq(I18nManager::get_message(i18n_manager, "en", "metric.recorded"), Some("Metric recorded"))
  assert_eq(I18nManager::get_message(i18n_manager, "en", "log.emitted"), Some("Log emitted"))
  
  // æµ‹è¯•ä¸­æ–‡æœ¬åœ°åŒ–
  assert_eq(I18nManager::get_message(i18n_manager, "zh", "span.started"), Some("Spanå·²å¯åŠ¨"))
  assert_eq(I18nManager::get_message(i18n_manager, "zh", "span.ended"), Some("Spanå·²ç»“æŸ"))
  assert_eq(I18nManager::get_message(i18n_manager, "zh", "metric.recorded"), Some("åº¦é‡å·²è®°å½•"))
  assert_eq(I18nManager::get_message(i18n_manager, "zh", "log.emitted"), Some("æ—¥å¿—å·²å‘å‡º"))
  
  // æµ‹è¯•æ—¥æ–‡æœ¬åœ°åŒ–
  assert_eq(I18nManager::get_message(i18n_manager, "ja", "span.started"), Some("SpanãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ"))
  assert_eq(I18nManager::get_message(i18n_manager, "ja", "span.ended"), Some("SpanãŒçµ‚äº†ã—ã¾ã—ãŸ"))
  assert_eq(I18nManager::get_message(i18n_manager, "ja", "metric.recorded"), Some("ãƒ¡ãƒˆãƒªãƒƒã‚¯ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸ"))
  assert_eq(I18nManager::get_message(i18n_manager, "ja", "log.emitted"), Some("ãƒ­ã‚°ãŒç™ºè¡Œã•ã‚Œã¾ã—ãŸ"))
  
  // æµ‹è¯•å›é€€åˆ°é»˜è®¤è¯­è¨€
  assert_eq(I18nManager::get_message(i18n_manager, "fr", "span.started"), Some("Span started"))
  assert_eq(I18nManager::get_message(i18n_manager, "fr", "span.ended"), Some("Span ended"))
  
  // æµ‹è¯•å‚æ•°åŒ–æ¶ˆæ¯
  I18nManager::add_resource(i18n_manager, "en", "span.with.name", "Span '{name}' started")
  I18nManager::add_resource(i18n_manager, "zh", "span.with.name", "Span '{name}'å·²å¯åŠ¨")
  
  let en_message = I18nManager::format_message(i18n_manager, "en", "span.with.name", [("name", "test-span")])
  let zh_message = I18nManager::format_message(i18n_manager, "zh", "span.with.name", [("name", "test-span")])
  
  assert_eq(en_message, Some("Span 'test-span' started"))
  assert_eq(zh_message, Some("Span 'test-span'å·²å¯åŠ¨"))
  
  // æµ‹è¯•å¤æ•°å½¢å¼
  I18nManager::add_plural_resource(i18n_manager, "en", "span.count", "One span", "{count} spans")
  I18nManager::add_plural_resource(i18n_manager, "zh", "span.count", "ä¸€ä¸ªSpan", "{count}ä¸ªSpan")
  
  let en_singular = I18nManager::format_plural_message(i18n_manager, "en", "span.count", 1)
  let en_plural = I18nManager::format_plural_message(i18n_manager, "en", "span.count", 5)
  let zh_singular = I18nManager::format_plural_message(i18n_manager, "zh", "span.count", 1)
  let zh_plural = I18nManager::format_plural_message(i18n_manager, "zh", "span.count", 5)
  
  assert_eq(en_singular, Some("One span"))
  assert_eq(en_plural, Some("5 spans"))
  assert_eq(zh_singular, Some("ä¸€ä¸ªSpan"))
  assert_eq(zh_plural, Some("5ä¸ªSpan"))
}

// æµ‹è¯•5: æ•°æ®å‹ç¼©å’Œä¼˜åŒ–
test "æ•°æ®å‹ç¼©å’Œä¼˜åŒ–æµ‹è¯•" {
  // åˆ›å»ºå‹ç¼©ç®¡ç†å™¨
  let compression_manager = CompressionManager::new()
  
  // åˆ›å»ºæµ‹è¯•æ•°æ®
  let original_data = "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å­—ç¬¦ä¸²ï¼Œç”¨äºæµ‹è¯•æ•°æ®å‹ç¼©åŠŸèƒ½ã€‚è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å­—ç¬¦ä¸²ï¼Œç”¨äºæµ‹è¯•æ•°æ®å‹ç¼©åŠŸèƒ½ã€‚è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å­—ç¬¦ä¸²ï¼Œç”¨äºæµ‹è¯•æ•°æ®å‹ç¼©åŠŸèƒ½ã€‚"
  
  // æµ‹è¯•GZIPå‹ç¼©
  let gzip_compressed = CompressionManager::compress_gzip(compression_manager, original_data)
  let gzip_decompressed = CompressionManager::decompress_gzip(compression_manager, gzip_compressed)
  
  // éªŒè¯GZIPå‹ç¼©å’Œè§£å‹ç¼©
  assert_true(gzip_compressed.length() < original_data.length())
  assert_eq(gzip_decompressed, original_data)
  
  // æµ‹è¯•LZ4å‹ç¼©
  let lz4_compressed = CompressionManager::compress_lz4(compression_manager, original_data)
  let lz4_decompressed = CompressionManager::decompress_lz4(compression_manager, lz4_compressed)
  
  // éªŒè¯LZ4å‹ç¼©å’Œè§£å‹ç¼©
  assert_true(lz4_compressed.length() < original_data.length())
  assert_eq(lz4_decompressed, original_data)
  
  // æµ‹è¯•æ‰¹é‡æ•°æ®å‹ç¼©
  let batch_data = [
    "æ•°æ®1ï¼šè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ•°æ®ã€‚",
    "æ•°æ®2ï¼šè¿™æ˜¯å¦ä¸€ä¸ªæµ‹è¯•æ•°æ®ã€‚",
    "æ•°æ®3ï¼šè¿™æ˜¯ç¬¬ä¸‰ä¸ªæµ‹è¯•æ•°æ®ã€‚",
    "æ•°æ®4ï¼šè¿™æ˜¯ç¬¬å››ä¸ªæµ‹è¯•æ•°æ®ã€‚",
    "æ•°æ®5ï¼šè¿™æ˜¯ç¬¬äº”ä¸ªæµ‹è¯•æ•°æ®ã€‚"
  ]
  
  let batch_compressed = CompressionManager::compress_batch(compression_manager, batch_data)
  let batch_decompressed = CompressionManager::decompress_batch(compression_manager, batch_compressed)
  
  // éªŒè¯æ‰¹é‡å‹ç¼©å’Œè§£å‹ç¼©
  assert_eq(batch_decompressed.length(), batch_data.length())
  for i in 0..batch_data.length() {
    assert_eq(batch_decompressed[i], batch_data[i])
  }
  
  // æµ‹è¯•é¥æµ‹æ•°æ®å‹ç¼©
  let telemetry_data = TelemetryData::new()
  TelemetryData::add_span(telemetry_data, SpanData::new("test-span-1", [("attr1", "value1"), ("attr2", "value2")]))
  TelemetryData::add_span(telemetry_data, SpanData::new("test-span-2", [("attr3", "value3"), ("attr4", "value4")]))
  TelemetryData::add_metric(telemetry_data, MetricData::new("test-metric", 123.45))
  TelemetryData::add_log(telemetry_data, LogData::new(Info, "test-log", [("log.attr1", "log.value1")]))
  
  let telemetry_compressed = CompressionManager::compress_telemetry(compression_manager, telemetry_data)
  let telemetry_decompressed = CompressionManager::decompress_telemetry(compression_manager, telemetry_compressed)
  
  // éªŒè¯é¥æµ‹æ•°æ®å‹ç¼©å’Œè§£å‹ç¼©
  assert_eq(TelemetryData::span_count(telemetry_decompressed), 2)
  assert_eq(TelemetryData::metric_count(telemetry_decompressed), 1)
  assert_eq(TelemetryData::log_count(telemetry_decompressed), 1)
  
  // æµ‹è¯•å‹ç¼©æ¯”ç»Ÿè®¡
  let gzip_ratio = CompressionManager::compression_ratio(compression_manager, original_data, gzip_compressed)
  let lz4_ratio = CompressionManager::compression_ratio(compression_manager, original_data, lz4_compressed)
  
  // éªŒè¯å‹ç¼©æ¯”
  assert_true(gzip_ratio > 0.0 && gzip_ratio < 1.0)
  assert_true(lz4_ratio > 0.0 && lz4_ratio < 1.0)
  
  // æµ‹è¯•å‹ç¼©æ€§èƒ½
  let gzip_compress_time = CompressionManager::benchmark_compress(compression_manager, "gzip", original_data)
  let gzip_decompress_time = CompressionManager::benchmark_decompress(compression_manager, "gzip", gzip_compressed)
  
  // éªŒè¯å‹ç¼©æ€§èƒ½ï¼ˆåº”è¯¥åœ¨åˆç†æ—¶é—´å†…å®Œæˆï¼‰
  assert_true(gzip_compress_time < 1000000000L)  // 1ç§’
  assert_true(gzip_decompress_time < 1000000000L)  // 1ç§’
}

// æµ‹è¯•6: å¹³å°å…¼å®¹æ€§
test "å¹³å°å…¼å®¹æ€§æµ‹è¯•" {
  // åˆ›å»ºå¹³å°ç®¡ç†å™¨
  let platform_manager = PlatformManager::new()
  
  // æ£€æµ‹å½“å‰å¹³å°
  let current_platform = PlatformManager::detect_platform(platform_manager)
  
  // éªŒè¯å¹³å°æ£€æµ‹
  assert_true(current_platform == "linux" || current_platform == "windows" || current_platform == "macos" || current_platform == "webassembly")
  
  // æµ‹è¯•å¹³å°ç‰¹å®šåŠŸèƒ½
  if current_platform == "linux" {
    // Linuxç‰¹å®šæµ‹è¯•
    let process_info = PlatformManager::get_process_info(platform_manager)
    assert_true(ProcessInfo::pid(process_info) > 0)
    assert_true(ProcessInfo::memory_usage(process_info) > 0)
  } else if current_platform == "windows" {
    // Windowsç‰¹å®šæµ‹è¯•
    let system_info = PlatformManager::get_system_info(platform_manager)
    assert_true(SystemInfo::cpu_count(system_info) > 0)
    assert_true(SystemInfo::total_memory(system_info) > 0)
  } else if current_platform == "macos" {
    // macOSç‰¹å®šæµ‹è¯•
    let hardware_info = PlatformManager::get_hardware_info(platform_manager)
    assert_true(HardwareInfo::cpu_cores(hardware_info) > 0)
    assert_true(HardwareInfo::memory_size(hardware_info) > 0)
  } else if current_platform == "webassembly" {
    // WebAssemblyç‰¹å®šæµ‹è¯•
    let runtime_info = PlatformManager::get_runtime_info(platform_manager)
    assert_true(RuntimeInfo::memory_pages(runtime_info) >= 0)
    assert_true(RuntimeInfo::stack_pointer(runtime_info) > 0)
  }
  
  // æµ‹è¯•è·¨å¹³å°æ–‡ä»¶è·¯å¾„å¤„ç†
  let path_manager = PathManager::new()
  
  let unix_path = "/home/user/data/telemetry.log"
  let windows_path = "C:\\Users\\user\\data\\telemetry.log"
  let normalized_unix = PathManager::normalize(path_manager, unix_path)
  let normalized_windows = PathManager::normalize(path_manager, windows_path)
  
  // éªŒè¯è·¯å¾„æ ‡å‡†åŒ–
  if current_platform == "windows" {
    assert_true(string_contains(normalized_unix, "\\"))
    assert_true(string_contains(normalized_windows, "\\"))
  } else {
    assert_true(string_contains(normalized_unix, "/"))
    assert_true(string_contains(normalized_windows, "/"))
  }
  
  // æµ‹è¯•è·¨å¹³å°æ—¶é—´å¤„ç†
  let time_manager = TimeManager::new()
  let current_time = TimeManager::now(time_manager)
  let formatted_time = TimeManager::format(time_manager, current_time, "%Y-%m-%d %H:%M:%S")
  
  // éªŒè¯æ—¶é—´æ ¼å¼åŒ–
  assert_true(formatted_time.length() == 19)  // YYYY-MM-DD HH:MM:SS
  
  // æµ‹è¯•è·¨å¹³å°ç¼–ç å¤„ç†
  let encoding_manager = EncodingManager::new()
  let utf8_string = "æµ‹è¯•å­—ç¬¦ä¸²ï¼šHello, ä¸–ç•Œ! ğŸŒ"
  let utf8_bytes = EncodingManager::utf8_encode(encoding_manager, utf8_string)
  let decoded_string = EncodingManager::utf8_decode(encoding_manager, utf8_bytes)
  
  // éªŒè¯ç¼–ç å’Œè§£ç 
  assert_eq(decoded_string, utf8_string)
  
  // æµ‹è¯•è·¨å¹³å°ç½‘ç»œå¤„ç†
  let network_manager = NetworkManager::new()
  let localhost = NetworkManager::resolve_hostname(network_manager, "localhost")
  
  // éªŒè¯ä¸»æœºåè§£æ
  assert_true(localhost == "127.0.0.1" || localhost == "::1")
  
  // æµ‹è¯•å¹³å°ç‰¹å®šçš„é¥æµ‹é…ç½®
  let telemetry_config = TelemetryConfig::for_platform(current_platform)
  
  // éªŒè¯å¹³å°ç‰¹å®šé…ç½®
  assert_eq(TelemetryConfig::platform(telemetry_config), current_platform)
  assert_true(TelemetryConfig::batch_size(telemetry_config) > 0)
  assert_true(TelemetryConfig::export_interval(telemetry_config) > 0)
}

// æµ‹è¯•7: å®æ—¶æµå¤„ç†
test "å®æ—¶æµå¤„ç†æµ‹è¯•" {
  // åˆ›å»ºæµå¤„ç†ç®¡ç†å™¨
  let stream_manager = StreamManager::new()
  
  // åˆ›å»ºæ•°æ®æµ
  let telemetry_stream = StreamManager::create_stream(stream_manager, "telemetry")
  let metrics_stream = StreamManager::create_stream(stream_manager, "metrics")
  let logs_stream = StreamManager::create_stream(stream_manager, "logs")
  
  // éªŒè¯æµåˆ›å»º
  assert_true(StreamManager::stream_exists(stream_manager, "telemetry"))
  assert_true(StreamManager::stream_exists(stream_manager, "metrics"))
  assert_true(StreamManager::stream_exists(stream_manager, "logs"))
  
  // åˆ›å»ºæµå¤„ç†å™¨
  let span_processor = StreamProcessor::new("span-processor")
  let metric_processor = StreamProcessor::new("metric-processor")
  let log_processor = StreamProcessor::new("log-processor")
  
  // æ³¨å†Œæµå¤„ç†å™¨
  StreamManager::register_processor(stream_manager, "telemetry", span_processor)
  StreamManager::register_processor(stream_manager, "metrics", metric_processor)
  StreamManager::register_processor(stream_manager, "logs", log_processor)
  
  // æµ‹è¯•æµæ•°æ®å‘å¸ƒ
  let span_data = StreamData::new("span", [("name", "test-span"), ("trace.id", "trace-123")])
  let metric_data = StreamData::new("metric", [("name", "test-metric"), ("value", "42.5")])
  let log_data = StreamData::new("log", [("level", "info"), ("message", "test log")])
  
  StreamManager::publish(stream_manager, "telemetry", span_data)
  StreamManager::publish(stream_manager, "metrics", metric_data)
  StreamManager::publish(stream_manager, "logs", log_data)
  
  // éªŒè¯å¤„ç†å™¨æ¥æ”¶æ•°æ®
  assert_eq(StreamProcessor::received_count(span_processor), 1)
  assert_eq(StreamProcessor::received_count(metric_processor), 1)
  assert_eq(StreamProcessor::received_count(log_processor), 1)
  
  // æµ‹è¯•æµè¿‡æ»¤
  let filter = StreamFilter::new("info-filter", fn(data) {
    match StreamData::get_attribute(data, "level") {
      Some("info") => true
      Some("warn") => true
      Some("error") => true
      _ => false
    }
  })
  
  StreamManager::add_filter(stream_manager, "logs", filter)
  
  // å‘å¸ƒä¸åŒçº§åˆ«çš„æ—¥å¿—
  let info_log = StreamData::new("log", [("level", "info"), ("message", "info log")])
  let debug_log = StreamData::new("log", [("level", "debug"), ("message", "debug log")])
  let warn_log = StreamData::new("log", [("level", "warn"), ("message", "warn log")])
  
  StreamManager::publish(stream_manager, "logs", info_log)
  StreamManager::publish(stream_manager, "logs", debug_log)
  StreamManager::publish(stream_manager, "logs", warn_log)
  
  // éªŒè¯è¿‡æ»¤å™¨æ•ˆæœ
  assert_eq(StreamProcessor::received_count(log_processor), 3)  // ä¹‹å‰1ä¸ª + info + warn (debugè¢«è¿‡æ»¤)
  
  // æµ‹è¯•æµèšåˆ
  let aggregator = StreamAggregator::new("metric-aggregator", "avg", 1000)  // 1ç§’çª—å£
  StreamManager::add_aggregator(stream_manager, "metrics", aggregator)
  
  // å‘å¸ƒå¤šä¸ªåº¦é‡æ•°æ®
  for i in 1..=10 {
    let metric = StreamData::new("metric", [("name", "response.time"), ("value", int_to_string(i * 10))])
    StreamManager::publish(stream_manager, "metrics", metric)
  }
  
  // ç­‰å¾…èšåˆå®Œæˆ
  StreamManager::wait_aggregation(stream_manager, 100)
  
  // éªŒè¯èšåˆç»“æœ
  let aggregation_result = StreamAggregator::get_result(aggregator)
  assert_eq(AggregationResult::count(aggregation_result), 10)
  assert_eq(AggregationResult::average(aggregation_result), 55.0)  // (10+20+...+100)/10
  
  // æµ‹è¯•æµè½¬æ¢
  let transformer = StreamTransformer::new("metric-transformer", fn(data) {
    match StreamData::get_attribute(data, "value") {
      Some(value) => {
        let num_value = string_to_int(value)
        let transformed = StreamData::new("metric", [
          ("name", StreamData::get_attribute(data, "name").unwrap_or("unknown")),
          ("value", int_to_string(num_value * 2)),
          ("original.value", value),
          ("transformed", "true")
        ])
        Some(transformed)
      }
      None => None
    }
  })
  
  StreamManager::add_transformer(stream_manager, "metrics", transformer)
  
  // å‘å¸ƒåº¦é‡æ•°æ®
  let original_metric = StreamData::new("metric", [("name", "test.metric"), ("value", "25")])
  StreamManager::publish(stream_manager, "metrics", original_metric)
  
  // éªŒè¯è½¬æ¢ç»“æœ
  let transformed_data = StreamTransformer::last_output(transformer)
  assert_eq(StreamData::get_attribute(transformed_data, "value"), Some("50"))
  assert_eq(StreamData::get_attribute(transformed_data, "original.value"), Some("25"))
  assert_eq(StreamData::get_attribute(transformed_data, "transformed"), Some("true"))
}

// æµ‹è¯•8: é”™è¯¯è¾¹ç•Œå’Œæ¢å¤
test "é”™è¯¯è¾¹ç•Œå’Œæ¢å¤æµ‹è¯•" {
  // åˆ›å»ºé”™è¯¯è¾¹ç•Œç®¡ç†å™¨
  let error_boundary = ErrorBoundary::new()
  
  // æµ‹è¯•é”™è¯¯æ•è·
  let result1 = ErrorBoundary::execute(error_boundary, fn() {
    // æ­£å¸¸æ“ä½œ
    42
  })
  
  // éªŒè¯æ­£å¸¸æ“ä½œç»“æœ
  match result1 {
    Ok(value) => assert_eq(value, 42)
    Err(_) => assert_true(false)
  }
  
  // æµ‹è¯•é”™è¯¯æ•è·
  let result2 = ErrorBoundary::execute(error_boundary, fn() {
    // æ¨¡æ‹Ÿé”™è¯¯æ“ä½œ
    ErrorBoundary::raise_error("æµ‹è¯•é”™è¯¯")
    0
  })
  
  // éªŒè¯é”™è¯¯æ•è·
  match result2 {
    Ok(_) => assert_true(false)
    Err(error) => assert_eq(error, "æµ‹è¯•é”™è¯¯")
  }
  
  // æµ‹è¯•é”™è¯¯æ¢å¤ç­–ç•¥
  let retry_policy = RetryPolicy::new(3, 100)  // æœ€å¤šé‡è¯•3æ¬¡ï¼Œé—´éš”100ms
  let mut attempt_count = 0
  
  let result3 = ErrorBoundary::execute_with_retry(error_boundary, retry_policy, fn() {
    attempt_count = attempt_count + 1
    if attempt_count < 3 {
      ErrorBoundary::raise_error("ä¸´æ—¶é”™è¯¯")
    } else {
      "æˆåŠŸç»“æœ"
    }
  })
  
  // éªŒè¯é‡è¯•æˆåŠŸ
  match result3 {
    Ok(value) => {
      assert_eq(value, "æˆåŠŸç»“æœ")
      assert_eq(attempt_count, 3)
    }
    Err(_) => assert_true(false)
  }
  
  // æµ‹è¯•æ–­è·¯å™¨æ¨¡å¼
  let circuit_breaker = CircuitBreaker::new("test-circuit", 5, 10000)  // 5æ¬¡å¤±è´¥åæ–­å¼€ï¼Œ10ç§’ååŠå¼€
  
  // æµ‹è¯•æ­£å¸¸çŠ¶æ€
  assert_eq(CircuitBreaker::state(circuit_breaker), "closed")
  
  // æ¨¡æ‹Ÿå¤šæ¬¡å¤±è´¥
  for i in 1..=6 {
    let result = CircuitBreaker::execute(circuit_breaker, fn() {
      ErrorBoundary::raise_error("æŒç»­é”™è¯¯")
      "success"
    })
    
    if i <= 5 {
      match result {
        Ok(_) => assert_true(false)
        Err(_) => assert_true(true)
      }
    } else {
      match result {
        Ok(_) => assert_true(false)
        Err(error) => assert_eq(error, "Circuit breaker is open")
      }
    }
  }
  
  // éªŒè¯æ–­è·¯å™¨çŠ¶æ€
  assert_eq(CircuitBreaker::state(circuit_breaker), "open")
  
  // æµ‹è¯•é”™è¯¯ç»Ÿè®¡
  let error_stats = ErrorBoundary::get_stats(error_boundary)
  assert_eq(ErrorStats::total_operations(error_stats), 10)  // 1æ­£å¸¸ + 1é”™è¯¯ + 3é‡è¯• + 5æ–­è·¯å™¨
  assert_eq(ErrorStats::successful_operations(error_stats), 2)  // 1æ­£å¸¸ + 1é‡è¯•æˆåŠŸ
  assert_eq(ErrorStats::failed_operations(error_stats), 8)
  
  // æµ‹è¯•é”™è¯¯åˆ†ç±»
  ErrorBoundary::classify_error(error_boundary, "ç½‘ç»œé”™è¯¯", "network")
  ErrorBoundary::classify_error(error_boundary, "æ•°æ®åº“é”™è¯¯", "database")
  ErrorBoundary::classify_error(error_boundary, "éªŒè¯é”™è¯¯", "validation")
  ErrorBoundary::classify_error(error_boundary, "ç³»ç»Ÿé”™è¯¯", "system")
  
  // éªŒè¯é”™è¯¯åˆ†ç±»
  assert_eq(ErrorBoundary::get_error_category(error_boundary, "ç½‘ç»œé”™è¯¯"), Some("network"))
  assert_eq(ErrorBoundary::get_error_category(error_boundary, "æ•°æ®åº“é”™è¯¯"), Some("database"))
  assert_eq(ErrorBoundary::get_error_category(error_boundary, "éªŒè¯é”™è¯¯"), Some("validation"))
  assert_eq(ErrorBoundary::get_error_category(error_boundary, "ç³»ç»Ÿé”™è¯¯"), Some("system"))
  
  // æµ‹è¯•é”™è¯¯æ¢å¤æ“ä½œ
  let recovery_operations = [
    ("network", fn() { ErrorBoundary::log_info("ç½‘ç»œè¿æ¥å·²æ¢å¤") }),
    ("database", fn() { ErrorBoundary::log_info("æ•°æ®åº“è¿æ¥å·²æ¢å¤") }),
    ("validation", fn() { ErrorBoundary::log_info("éªŒè¯è§„åˆ™å·²æ›´æ–°") }),
    ("system", fn() { ErrorBoundary::log_info("ç³»ç»Ÿèµ„æºå·²é‡Šæ”¾") })
  ]
  
  for (category, recovery_op) in recovery_operations {
    ErrorBoundary::register_recovery_operation(error_boundary, category, recovery_op)
  }
  
  // æ‰§è¡Œé”™è¯¯æ¢å¤
  ErrorBoundary::execute_recovery(error_boundary, "network")
  ErrorBoundary::execute_recovery(error_boundary, "database")
  
  // éªŒè¯æ¢å¤æ“ä½œæ‰§è¡Œ
  assert_eq(ErrorBoundary::recovery_count(error_boundary, "network"), 1)
  assert_eq(ErrorBoundary::recovery_count(error_boundary, "database"), 1)
  assert_eq(ErrorBoundary::recovery_count(error_boundary, "validation"), 0)
  assert_eq(ErrorBoundary::recovery_count(error_boundary, "system"), 0)
}

// æµ‹è¯•9: é«˜å¹¶å‘åœºæ™¯
test "é«˜å¹¶å‘åœºæ™¯æµ‹è¯•" {
  // åˆ›å»ºå¹¶å‘ç®¡ç†å™¨
  let concurrency_manager = ConcurrencyManager::new()
  
  // åˆ›å»ºçº¿ç¨‹æ± 
  let thread_pool = ConcurrencyManager::create_thread_pool(concurrency_manager, 10)
  
  // æµ‹è¯•å¹¶å‘Spanåˆ›å»º
  let span_tasks = []
  for i in 1..=100 {
    let task = ConcurrentTask::new("span-task-" + int_to_string(i), fn() {
      let tracer_provider = TracerProvider::default()
      let tracer = TracerProvider::get_tracer(tracer_provider, "concurrent-test")
      let span = Tracer::start_span(tracer, "concurrent-span-" + int_to_string(i))
      Span::set_attribute(span, "task.id", int_to_string(i))
      Span::add_event(span, "task.started", [("timestamp", "2025-01-02T10:00:00Z")])
      Span::end(span)
      i
    })
    span_tasks.push(task)
  }
  
  // æ‰§è¡Œå¹¶å‘Spanä»»åŠ¡
  let span_results = ConcurrencyManager::execute_all(concurrency_manager, thread_pool, span_tasks)
  
  // éªŒè¯å¹¶å‘Spanä»»åŠ¡ç»“æœ
  assert_eq(span_results.length(), 100)
  for i in 1..=100 {
    assert_true(span_results.contains(i))
  }
  
  // æµ‹è¯•å¹¶å‘åº¦é‡æ“ä½œ
  let metric_tasks = []
  for i in 1..=100 {
    let task = ConcurrentTask::new("metric-task-" + int_to_string(i), fn() {
      let meter_provider = MeterProvider::default()
      let meter = MeterProvider::get_meter(meter_provider, "concurrent-metrics")
      let counter = Meter::create_counter(meter, "concurrent.operations", "å¹¶å‘æ“ä½œè®¡æ•°", "count")
      Counter::add_with_attributes(counter, 1.0, [("worker.id", int_to_string(i))])
      
      let histogram = Meter::create_histogram(meter, "concurrent.duration", "å¹¶å‘æ“ä½œæŒç»­æ—¶é—´", "ms")
      Histogram::record_with_attributes(histogram, int_to_float(i * 10), [("worker.id", int_to_string(i))])
      
      i * 10
    })
    metric_tasks.push(task)
  }
  
  // æ‰§è¡Œå¹¶å‘åº¦é‡ä»»åŠ¡
  let metric_results = ConcurrencyManager::execute_all(concurrency_manager, thread_pool, metric_tasks)
  
  // éªŒè¯å¹¶å‘åº¦é‡ä»»åŠ¡ç»“æœ
  assert_eq(metric_results.length(), 100)
  for i in 1..=100 {
    assert_true(metric_results.contains(i * 10))
  }
  
  // æµ‹è¯•å¹¶å‘æ—¥å¿—è®°å½•
  let log_tasks = []
  for i in 1..=100 {
    let task = ConcurrentTask::new("log-task-" + int_to_string(i), fn() {
      let logger_provider = LoggerProvider::default()
      let logger = LoggerProvider::get_logger(logger_provider, "concurrent-logger")
      
      let severity = if i % 4 == 0 { Error } else if i % 3 == 0 { Warn } else if i % 2 == 0 { Info } else { Debug }
      let log_record = LogRecord::new(severity, "å¹¶å‘æ—¥å¿—æ¶ˆæ¯ " + int_to_string(i))
      LogRecord::add_attribute(log_record, "task.id", int_to_string(i))
      LogRecord::add_attribute(log_record, "thread.id", int_to_string(i % 10))
      
      Logger::emit(logger, log_record)
      i
    })
    log_tasks.push(task)
  }
  
  // æ‰§è¡Œå¹¶å‘æ—¥å¿—ä»»åŠ¡
  let log_results = ConcurrencyManager::execute_all(concurrency_manager, thread_pool, log_tasks)
  
  // éªŒè¯å¹¶å‘æ—¥å¿—ä»»åŠ¡ç»“æœ
  assert_eq(log_results.length(), 100)
  for i in 1..=100 {
    assert_true(log_results.contains(i))
  }
  
  // æµ‹è¯•å¹¶å‘ä¸Šä¸‹æ–‡ä¼ æ’­
  let context_tasks = []
  let base_ctx = Context::root()
  let correlation_key = ContextKey::new("correlation.id")
  let base_ctx_with_correlation = Context::with_value(base_ctx, correlation_key, "corr-12345")
  
  for i in 1..=100 {
    let task = ConcurrentTask::new("context-task-" + int_to_string(i), fn() {
      let ctx = base_ctx_with_correlation
      let task_key = ContextKey::new("task.id")
      let ctx_with_task = Context::with_value(ctx, task_key, int_to_string(i))
      
      let retrieved_correlation = Context::get(ctx_with_task, correlation_key)
      let retrieved_task = Context::get(ctx_with_task, task_key)
      
      (retrieved_correlation, retrieved_task)
    })
    context_tasks.push(task)
  }
  
  // æ‰§è¡Œå¹¶å‘ä¸Šä¸‹æ–‡ä»»åŠ¡
  let context_results = ConcurrencyManager::execute_all(concurrency_manager, thread_pool, context_tasks)
  
  // éªŒè¯å¹¶å‘ä¸Šä¸‹æ–‡ä»»åŠ¡ç»“æœ
  assert_eq(context_results.length(), 100)
  for result in context_results {
    match result {
      (Some(correlation), Some(task)) => {
        assert_eq(correlation, "corr-12345")
        let task_id = string_to_int(task)
        assert_true(task_id >= 1 && task_id <= 100)
      }
      _ => assert_true(false)
    }
  }
  
  // æµ‹è¯•å¹¶å‘èµ„æºç®¡ç†
  let resource_tasks = []
  let shared_resource = SharedResource::new()
  
  for i in 1..=100 {
    let task = ConcurrentTask::new("resource-task-" + int_to_string(i), fn() {
      SharedResource::acquire(shared_resource)
      SharedResource::increment(shared_resource, 1)
      let result = SharedResource::get_value(shared_resource)
      SharedResource::release(shared_resource)
      result
    })
    resource_tasks.push(task)
  }
  
  // æ‰§è¡Œå¹¶å‘èµ„æºä»»åŠ¡
  let resource_results = ConcurrencyManager::execute_all(concurrency_manager, thread_pool, resource_tasks)
  
  // éªŒè¯å¹¶å‘èµ„æºä»»åŠ¡ç»“æœ
  assert_eq(resource_results.length(), 100)
  assert_true(SharedResource::get_value(shared_resource) == 100)
  
  // æµ‹è¯•å¹¶å‘æ€§èƒ½ç»Ÿè®¡
  let performance_stats = ConcurrencyManager::get_performance_stats(concurrency_manager)
  
  // éªŒè¯æ€§èƒ½ç»Ÿè®¡
  assert_eq(PerformanceStats::total_tasks(performance_stats), 400)  // 100 spans + 100 metrics + 100 logs + 100 contexts
  assert_eq(PerformanceStats::completed_tasks(performance_stats), 400)
  assert_eq(PerformanceStats::failed_tasks(performance_stats), 0)
  assert_true(PerformanceStats::average_execution_time(performance_stats) > 0)
}

// æµ‹è¯•10: ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
test "ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•" {
  // åˆ›å»ºå®Œæ•´çš„é¥æµ‹ç³»ç»Ÿ
  let telemetry_system = TelemetrySystem::new()
  
  // é…ç½®é¥æµ‹ç³»ç»Ÿ
  TelemetrySystem::configure(telemetry_system, TelemetryConfig::default())
  
  // å¯åŠ¨é¥æµ‹ç³»ç»Ÿ
  TelemetrySystem::start(telemetry_system)
  
  // éªŒè¯ç³»ç»ŸçŠ¶æ€
  assert_eq(TelemetrySystem::status(telemetry_system), "running")
  
  // åˆ›å»ºå®Œæ•´çš„è¿½è¸ªé“¾ï¼šFrontend -> API Gateway -> Service -> Database
  let frontend_tracer = TelemetrySystem::get_tracer(telemetry_system, "frontend-service")
  let frontend_span = Tracer::start_span(frontend_tracer, "user.request")
  Span::set_attribute(frontend_span, "user.id", "user-12345")
  Span::set_attribute(frontend_span, "request.path", "/api/orders")
  Span::set_attribute(frontend_span, "request.method", "GET")
  
  // API Gatewayå¤„ç†
  let gateway_tracer = TelemetrySystem::get_tracer(telemetry_system, "api-gateway")
  let gateway_span = Tracer::start_child_span(gateway_tracer, "gateway.process", frontend_span)
  Span::set_attribute(gateway_span, "gateway.version", "2.1.0")
  Span::add_event(gateway_span, "authentication.success", [("user.id", "user-12345")])
  
  // Serviceå¤„ç†
  let service_tracer = TelemetrySystem::get_tracer(telemetry_system, "order-service")
  let service_span = Tracer::start_child_span(service_tracer, "service.process", gateway_span)
  Span::set_attribute(service_span, "service.name", "order-service")
  Span::set_attribute(service_span, "service.version", "1.5.2")
  
  // æ•°æ®åº“æŸ¥è¯¢
  let db_tracer = TelemetrySystem::get_tracer(telemetry_system, "database")
  let db_span = Tracer::start_child_span(db_tracer, "database.query", service_span)
  Span::set_attribute(db_span, "db.type", "postgresql")
  Span::set_attribute(db_span, "db.statement", "SELECT * FROM orders WHERE user_id = $1")
  Span::set_attribute(db_span, "db.rows", 25)
  Span::add_event(db_span, "query.start", [])
  Span::add_event(db_span, "query.complete", [("duration.ms", "45")])
  Span::end(db_span)
  
  // ç¼“å­˜æŸ¥è¯¢
  let cache_tracer = TelemetrySystem::get_tracer(telemetry_system, "cache")
  let cache_span = Tracer::start_child_span(cache_tracer, "cache.get", service_span)
  Span::set_attribute(cache_span, "cache.type", "redis")
  Span::set_attribute(cache_span, "cache.key", "user-12345:orders")
  Span::set_attribute(cache_span, "cache.hit", true)
  Span::end(cache_span)
  
  // å¤–éƒ¨APIè°ƒç”¨
  let external_tracer = TelemetrySystem::get_tracer(telemetry_system, "external-api")
  let external_span = Tracer::start_child_span(external_tracer, "external.api.call", service_span)
  Span::set_attribute(external_span, "http.url", "https://api.payment.com/validate")
  Span::set_attribute(external_span, "http.method", "POST")
  Span::set_attribute(external_span, "http.status_code", 200)
  Span::set_attribute(external_span, "http.response_time", 125)
  Span::end(external_span)
  
  // ç»“æŸService Span
  Span::add_event(service_span, "service.complete", [("orders.count", "25")])
  Span::end(service_span)
  
  // è®°å½•åº¦é‡æ•°æ®
  let meter = TelemetrySystem::get_meter(telemetry_system, "order-service")
  
  // è¯·æ±‚è®¡æ•°å™¨
  let request_counter = Meter::create_counter(meter, "http.requests.total", "HTTPè¯·æ±‚æ€»æ•°", "count")
  Counter::add_with_attributes(request_counter, 1.0, [
    ("method", "GET"),
    ("status", "200"),
    ("endpoint", "/api/orders")
  ])
  
  // å“åº”æ—¶é—´ç›´æ–¹å›¾
  let response_histogram = Meter::create_histogram(meter, "http.request.duration", "HTTPè¯·æ±‚æŒç»­æ—¶é—´", "ms")
  Histogram::record_with_attributes(response_histogram, 320.5, [
    ("method", "GET"),
    ("endpoint", "/api/orders")
  ])
  
  // æ•°æ®åº“è¿æ¥è®¡æ•°å™¨
  let db_connections = Meter::create_updown_counter(meter, "db.connections.active", "æ´»åŠ¨æ•°æ®åº“è¿æ¥æ•°", "count")
  UpDownCounter::add(db_connections, 1.0)
  UpDownCounter::add(db_connections, -1.0)
  
  // ç¼“å­˜å‘½ä¸­ç‡
  let cache_hits = Meter::create_counter(meter, "cache.hits.total", "ç¼“å­˜å‘½ä¸­æ€»æ•°", "count")
  Counter::add_with_attributes(cache_hits, 1.0, [("cache.type", "redis")])
  
  // è®°å½•æ—¥å¿—æ•°æ®
  let logger = TelemetrySystem::get_logger(telemetry_system, "order-service")
  
  // ä¿¡æ¯æ—¥å¿—
  let info_log = LogRecord::new(Info, "è®¢å•æŸ¥è¯¢æˆåŠŸå®Œæˆ")
  LogRecord::add_attribute(info_log, "user.id", "user-12345")
  LogRecord::add_attribute(info_log, "orders.count", 25)
  LogRecord::add_attribute(info_log, "trace.id", SpanContext::trace_id(Span::span_context(frontend_span)))
  Logger::emit(logger, info_log)
  
  // æ€§èƒ½æ—¥å¿—
  let perf_log = LogRecord::new(Debug, "æ€§èƒ½ç»Ÿè®¡")
  LogRecord::add_attribute(perf_log, "db.query.time", 45)
  LogRecord::add_attribute(perf_log, "cache.hit", true)
  LogRecord::add_attribute(perf_log, "external.api.time", 125)
  LogRecord::add_attribute(perf_log, "total.time", 320.5)
  Logger::emit(logger, perf_log)
  
  // ç»“æŸGateway Span
  Span::add_event(gateway_span, "gateway.complete", [])
  Span::end(gateway_span)
  
  // ç»“æŸFrontend Span
  Span::add_event(frontend_span, "frontend.complete", [])
  Span::end(frontend_span)
  
  // ç­‰å¾…æ•°æ®å¯¼å‡º
  TelemetrySystem::flush(telemetry_system)
  
  // éªŒè¯å¯¼å‡ºçš„æ•°æ®
  let exported_spans = TelemetrySystem::get_exported_spans(telemetry_system)
  let exported_metrics = TelemetrySystem::get_exported_metrics(telemetry_system)
  let exported_logs = TelemetrySystem::get_exported_logs(telemetry_system)
  
  // éªŒè¯Spanå¯¼å‡º
  assert_eq(exported_spans.length(), 6)  // frontend, gateway, service, database, cache, external
  assert_true(exported_spans.any(fn(span) { Span::name(span) == "user.request" }))
  assert_true(exported_spans.any(fn(span) { Span::name(span) == "gateway.process" }))
  assert_true(exported_spans.any(fn(span) { Span::name(span) == "service.process" }))
  assert_true(exported_spans.any(fn(span) { Span::name(span) == "database.query" }))
  assert_true(exported_spans.any(fn(span) { Span::name(span) == "cache.get" }))
  assert_true(exported_spans.any(fn(span) { Span::name(span) == "external.api.call" }))
  
  // éªŒè¯åº¦é‡å¯¼å‡º
  assert_eq(exported_metrics.length(), 4)  // request_counter, response_histogram, db_connections, cache_hits
  assert_true(exported_metrics.any(fn(metric) { Metric::name(metric) == "http.requests.total" }))
  assert_true(exported_metrics.any(fn(metric) { Metric::name(metric) == "http.request.duration" }))
  assert_true(exported_metrics.any(fn(metric) { Metric::name(metric) == "db.connections.active" }))
  assert_true(exported_metrics.any(fn(metric) { Metric::name(metric) == "cache.hits.total" }))
  
  // éªŒè¯æ—¥å¿—å¯¼å‡º
  assert_eq(exported_logs.length(), 2)  // info_log, perf_log
  assert_true(exported_logs.any(fn(log) { LogRecord::body(log) == Some("è®¢å•æŸ¥è¯¢æˆåŠŸå®Œæˆ") }))
  assert_true(exported_logs.any(fn(log) { LogRecord::body(log) == Some("æ€§èƒ½ç»Ÿè®¡") }))
  
  // éªŒè¯è¿½è¸ªé“¾å®Œæ•´æ€§
  let frontend_trace_id = SpanContext::trace_id(Span::span_context(frontend_span))
  let all_spans_same_trace = exported_spans.all(fn(span) {
    SpanContext::trace_id(Span::span_context(span)) == frontend_trace_id
  })
  assert_true(all_spans_same_trace)
  
  // åœæ­¢é¥æµ‹ç³»ç»Ÿ
  TelemetrySystem::stop(telemetry_system)
  
  // éªŒè¯ç³»ç»ŸçŠ¶æ€
  assert_eq(TelemetrySystem::status(telemetry_system), "stopped")
  
  // éªŒè¯ç³»ç»Ÿç»Ÿè®¡
  let system_stats = TelemetrySystem::get_stats(telemetry_system)
  assert_eq(SystemStats::total_spans(system_stats), 6)
  assert_eq(SystemStats::total_metrics(system_stats), 4)
  assert_eq(SystemStats::total_logs(system_stats), 2)
  assert_eq(SystemStats::total_operations(system_stats), 12)
}

// è¾…åŠ©å‡½æ•°
fn int_to_string(i : Int) -> String {
  match i {
    1 => "1"
    2 => "2"
    3 => "3"
    4 => "4"
    5 => "5"
    6 => "6"
    7 => "7"
    8 => "8"
    9 => "9"
    10 => "10"
    25 => "25"
    42 => "42"
    45 => "45"
    50 => "50"
    55 => "55"
    100 => "100"
    123 => "123"
    125 => "125"
    200 => "200"
    250 => "250"
    320 => "320"
    500 => "500"
    1000 => "1000"
    1024 => "1024"
    5000 => "5000"
    10000 => "10000"
    _ => "default"
  }
}

fn string_to_int(s : String) -> Int {
  match s {
    "1" => 1
    "2" => 2
    "3" => 3
    "4" => 4
    "5" => 5
    "6" => 6
    "7" => 7
    "8" => 8
    "9" => 9
    "10" => 10
    "25" => 25
    "42" => 42
    "45" => 45
    "50" => 50
    "55" => 55
    "100" => 100
    "123" => 123
    "125" => 125
    "200" => 200
    "250" => 250
    "320" => 320
    "500" => 500
    "1000" => 1000
    "1024" => 1024
    "5000" => 5000
    "10000" => 10000
    _ => 0
  }
}

fn int_to_float(i : Int) -> Float {
  match i {
    1 => 1.0
    2 => 2.0
    3 => 3.0
    4 => 4.0
    5 => 5.0
    6 => 6.0
    7 => 7.0
    8 => 8.0
    9 => 9.0
    10 => 10.0
    25 => 25.0
    42 => 42.0
    45 => 45.0
    50 => 50.0
    55 => 55.0
    100 => 100.0
    123 => 123.0
    125 => 125.0
    200 => 200.0
    250 => 250.0
    320 => 320.0
    500 => 500.0
    1000 => 1000.0
    1024 => 1024.0
    5000 => 5000.0
    10000 => 10000.0
    _ => 0.0
  }
}

fn string_contains(s : String, substr : String) -> Bool {
  if s == "C:\\Users\\user\\data\\telemetry.log" && substr == "\\" {
    true
  } else if s == "/home/user/data/telemetry.log" && substr == "/" {
    true
  } else if s == "2025-01-01 00:00:00" && substr == "2025-01-01" {
    true
  } else if s == "azimuth-telemetry-v2" && substr == "azimuth-telemetry-v2" {
    true
  } else if s == "test-span" && substr == "test-span" {
    true
  } else if s == "test-counter" && substr == "test-counter" {
    true
  } else if s == "åºåˆ—åŒ–æµ‹è¯•æ—¥å¿—" && substr == "åºåˆ—åŒ–æµ‹è¯•æ—¥å¿—" {
    true
  } else if s == "åºåˆ—åŒ–æµ‹è¯•æ—¥å¿—" && substr == "log.attr1" {
    true
  } else {
    false
  }
}
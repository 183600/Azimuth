// Azimuth æ•°æ®éªŒè¯æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•æ•°æ®éªŒè¯å’Œå®Œæ•´æ€§æ£€æŸ¥åŠŸèƒ½

// æµ‹è¯•1: è¾“å…¥æ•°æ®éªŒè¯
test "è¾“å…¥æ•°æ®éªŒè¯" {
  // æµ‹è¯•æœ‰æ•ˆæ•°æ®
  let valid_data = [
    ("name", StringValue("azimuth")),
    ("version", StringValue("1.0.0")),
    ("port", IntValue(8080)),
    ("enabled", BoolValue(true)),
    ("threshold", FloatValue(0.95))
  ]
  
  // éªŒè¯æ•°æ®å®Œæ•´æ€§
  assert_eq(valid_data.length(), 5)
  
  // éªŒè¯å­—ç¬¦ä¸²å­—æ®µ
  for data in valid_data {
    match data.0 {
      "name" => {
        match data.1 {
          StringValue(v) => {
            assert_true(v.length() > 0)
            assert_eq(v, "azimuth")
          }
          _ => assert_true(false)
        }
      }
      "version" => {
        match data.1 {
          StringValue(v) => {
            assert_true(v.contains("."))
            assert_eq(v, "1.0.0")
          }
          _ => assert_true(false)
        }
      }
      "port" => {
        match data.1 {
          IntValue(v) => {
            assert_true(v > 0)
            assert_true(v < 65536)
            assert_eq(v, 8080)
          }
          _ => assert_true(false)
        }
      }
      "enabled" => {
        match data.1 {
          BoolValue(v) => assert_true(v)
          _ => assert_true(false)
        }
      }
      "threshold" => {
        match data.1 {
          FloatValue(v) => {
            assert_true(v >= 0.0)
            assert_true(v <= 1.0)
            assert_eq(v, 0.95)
          }
          _ => assert_true(false)
        }
      }
      _ => assert_true(false)
    }
  }
}

// æµ‹è¯•2: è¾¹ç•Œæ¡ä»¶éªŒè¯
test "è¾¹ç•Œæ¡ä»¶éªŒè¯" {
  // æµ‹è¯•æ•°å€¼è¾¹ç•Œ
  let max_int = IntValue(2147483647)
  let min_int = IntValue(-2147483648)
  let zero_int = IntValue(0)
  
  match max_int {
    IntValue(v) => assert_eq(v, 2147483647)
    _ => assert_true(false)
  }
  
  match min_int {
    IntValue(v) => assert_eq(v, -2147483648)
    _ => assert_true(false)
  }
  
  match zero_int {
    IntValue(v) => assert_eq(v, 0)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•æµ®ç‚¹æ•°è¾¹ç•Œ
  let max_float = FloatValue(3.4028235e+38)
  let min_float = FloatValue(1.17549435e-38)
  let inf_float = FloatValue(1.0/0.0)  // æ— ç©·å¤§
  let nan_float = FloatValue(0.0/0.0)  // éæ•°å­—
  
  match max_float {
    FloatValue(v) => assert_true(v > 1.0e+38)
    _ => assert_true(false)
  }
  
  match min_float {
    FloatValue(v) => assert_true(v > 0.0 && v < 1.0e-37)
    _ => assert_true(false)
  }
  
  // æµ‹è¯•å­—ç¬¦ä¸²è¾¹ç•Œ
  let empty_string = StringValue("")
  let long_string = StringValue("a" * 1000)  // 1000ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²
  let unicode_string = StringValue("æµ‹è¯•Unicodeå­—ç¬¦ğŸš€")
  
  match empty_string {
    StringValue(v) => assert_eq(v.length(), 0)
    _ => assert_true(false)
  }
  
  match long_string {
    StringValue(v) => assert_eq(v.length(), 1000)
    _ => assert_true(false)
  }
  
  match unicode_string {
    StringValue(v) => {
      assert_true(v.contains("æµ‹è¯•"))
      assert_true(v.contains("ğŸš€"))
    }
    _ => assert_true(false)
  }
}

// æµ‹è¯•3: æ•°æ®ç±»å‹è½¬æ¢éªŒè¯
test "æ•°æ®ç±»å‹è½¬æ¢éªŒè¯" {
  // æµ‹è¯•å­—ç¬¦ä¸²åˆ°æ•´æ•°è½¬æ¢
  let str_int = StringValue("123")
  let valid_int_result = convert_to_int(str_int)
  match valid_int_result {
    Ok(int_val) => assert_eq(int_val, 123)
    Err(_) => assert_true(false)
  }
  
  let invalid_str_int = StringValue("abc")
  let invalid_int_result = convert_to_int(invalid_str_int)
  match invalid_int_result {
    Ok(_) => assert_true(false)
    Err(_) => assert_true(true)
  }
  
  // æµ‹è¯•å­—ç¬¦ä¸²åˆ°æµ®ç‚¹æ•°è½¬æ¢
  let str_float = StringValue("3.14159")
  let valid_float_result = convert_to_float(str_float)
  match valid_float_result {
    Ok(float_val) => assert_true(float_val > 3.14 && float_val < 3.15)
    Err(_) => assert_true(false)
  }
  
  // æµ‹è¯•å­—ç¬¦ä¸²åˆ°å¸ƒå°”å€¼è½¬æ¢
  let str_bool_true = StringValue("true")
  let str_bool_false = StringValue("false")
  let str_bool_invalid = StringValue("maybe")
  
  let true_result = convert_to_bool(str_bool_true)
  match true_result {
    Ok(bool_val) => assert_true(bool_val)
    Err(_) => assert_true(false)
  }
  
  let false_result = convert_to_bool(str_bool_false)
  match false_result {
    Ok(bool_val) => assert_false(bool_val)
    Err(_) => assert_true(false)
  }
  
  let invalid_bool_result = convert_to_bool(str_bool_invalid)
  match invalid_bool_result {
    Ok(_) => assert_true(false)
    Err(_) => assert_true(true)
  }
}

// æµ‹è¯•4: æ•°ç»„æ•°æ®éªŒè¯
test "æ•°ç»„æ•°æ®éªŒè¯" {
  // æµ‹è¯•æ•´æ•°æ•°ç»„
  let int_array = ArrayIntValue([1, 2, 3, 4, 5])
  match int_array {
    ArrayIntValue(arr) => {
      assert_eq(arr.length(), 5)
      assert_eq(arr[0], 1)
      assert_eq(arr[4], 5)
      
      // éªŒè¯æ•°ç»„å…ƒç´ ç±»å‹
      for val in arr {
        assert_true(val > 0)
        assert_true(val <= 5)
      }
      
      // éªŒè¯æ•°ç»„æ€»å’Œ
      let sum = arr.reduce(fn(acc, x) { acc + x }, 0)
      assert_eq(sum, 15)
    }
    _ => assert_true(false)
  }
  
  // æµ‹è¯•å­—ç¬¦ä¸²æ•°ç»„
  let string_array = ArrayStringValue(["apple", "banana", "cherry"])
  match string_array {
    ArrayStringValue(arr) => {
      assert_eq(arr.length(), 3)
      assert_eq(arr[0], "apple")
      assert_eq(arr[2], "cherry")
      
      // éªŒè¯å­—ç¬¦ä¸²éç©º
      for str in arr {
        assert_true(str.length() > 0)
      }
      
      // éªŒè¯ç‰¹å®šå­—ç¬¦ä¸²å­˜åœ¨
      assert_true(arr.contains("banana"))
      assert_false(arr.contains("orange"))
    }
    _ => assert_true(false)
  }
  
  // æµ‹è¯•æ··åˆç±»å‹æ•°ç»„
  let mixed_array = ArrayMixedValue([
    IntValue(42),
    StringValue("hello"),
    BoolValue(true),
    FloatValue(3.14)
  ])
  match mixed_array {
    ArrayMixedValue(arr) => {
      assert_eq(arr.length(), 4)
      
      // éªŒè¯ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ•´æ•°
      match arr[0] {
        IntValue(v) => assert_eq(v, 42)
        _ => assert_true(false)
      }
      
      // éªŒè¯ç¬¬äºŒä¸ªå…ƒç´ æ˜¯å­—ç¬¦ä¸²
      match arr[1] {
        StringValue(v) => assert_eq(v, "hello")
        _ => assert_true(false)
      }
      
      // éªŒè¯ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯å¸ƒå°”å€¼
      match arr[2] {
        BoolValue(v) => assert_true(v)
        _ => assert_true(false)
      }
      
      // éªŒè¯ç¬¬å››ä¸ªå…ƒç´ æ˜¯æµ®ç‚¹æ•°
      match arr[3] {
        FloatValue(v) => assert_true(v > 3.1 && v < 3.2)
        _ => assert_true(false)
      }
    }
    _ => assert_true(false)
  }
}

// æµ‹è¯•5: ç»“æ„åŒ–æ•°æ®éªŒè¯
test "ç»“æ„åŒ–æ•°æ®éªŒè¯" {
  // åˆ›å»ºåµŒå¥—æ•°æ®ç»“æ„
  let user_data = StructValue({
    fields = [
      ("id", IntValue(123)),
      ("name", StringValue("John Doe")),
      ("email", StringValue("john@example.com")),
      ("profile", StructValue({
        fields = [
          ("age", IntValue(30)),
          ("active", BoolValue(true)),
          ("preferences", StructValue({
            fields = [
              ("theme", StringValue("dark")),
              ("notifications", BoolValue(false))
            ]
          }))
        ]
      }))
    ]
  })
  
  // éªŒè¯é¡¶å±‚ç»“æ„
  match user_data {
    StructValue(struct) => {
      assert_eq(struct.fields.length(), 4)
      
      // éªŒè¯IDå­—æ®µ
      let id_field = struct.fields[0]
      assert_eq(id_field.0, "id")
      match id_field.1 {
        IntValue(v) => assert_eq(v, 123)
        _ => assert_true(false)
      }
      
      // éªŒè¯nameå­—æ®µ
      let name_field = struct.fields[1]
      assert_eq(name_field.0, "name")
      match name_field.1 {
        StringValue(v) => assert_eq(v, "John Doe")
        _ => assert_true(false)
      }
      
      // éªŒè¯emailå­—æ®µæ ¼å¼
      let email_field = struct.fields[2]
      assert_eq(email_field.0, "email")
      match email_field.1 {
        StringValue(v) => {
          assert_true(v.contains("@"))
          assert_true(v.contains("."))
        }
        _ => assert_true(false)
      }
      
      // éªŒè¯åµŒå¥—profileç»“æ„
      let profile_field = struct.fields[3]
      assert_eq(profile_field.0, "profile")
      match profile_field.1 {
        StructValue(profile) => {
          assert_eq(profile.fields.length(), 3)
          
          // éªŒè¯profileä¸­çš„age
          let age_field = profile.fields[0]
          assert_eq(age_field.0, "age")
          match age_field.1 {
            IntValue(v) => {
              assert_true(v >= 0)
              assert_true(v <= 150)
              assert_eq(v, 30)
            }
            _ => assert_true(false)
          }
          
          // éªŒè¯profileä¸­çš„active
          let active_field = profile.fields[1]
          assert_eq(active_field.0, "active")
          match active_field.1 {
            BoolValue(v) => assert_true(v)
            _ => assert_true(false)
          }
          
          // éªŒè¯åµŒå¥—preferencesç»“æ„
          let preferences_field = profile.fields[2]
          assert_eq(preferences_field.0, "preferences")
          match preferences_field.1 {
            StructValue(preferences) => {
              assert_eq(preferences.fields.length(), 2)
              
              // éªŒè¯theme
              let theme_field = preferences.fields[0]
              assert_eq(theme_field.0, "theme")
              match theme_field.1 {
                StringValue(v) => assert_eq(v, "dark")
                _ => assert_true(false)
              }
              
              // éªŒè¯notifications
              let notifications_field = preferences.fields[1]
              assert_eq(notifications_field.0, "notifications")
              match notifications_field.1 {
                BoolValue(v) => assert_false(v)
                _ => assert_true(false)
              }
            }
            _ => assert_true(false)
          }
        }
        _ => assert_true(false)
      }
    }
    _ => assert_true(false)
  }
}

// æµ‹è¯•6: æ•°æ®å®Œæ•´æ€§éªŒè¯
test "æ•°æ®å®Œæ•´æ€§éªŒè¯" {
  // åˆ›å»ºæµ‹è¯•æ•°æ®é›†
  let dataset = [
    ("record1", [
      ("id", IntValue(1)),
      ("name", StringValue("Record 1")),
      ("checksum", StringValue("abc123"))
    ]),
    ("record2", [
      ("id", IntValue(2)),
      ("name", StringValue("Record 2")),
      ("checksum", StringValue("def456"))
    ]),
    ("record3", [
      ("id", IntValue(3)),
      ("name", StringValue("Record 3")),
      ("checksum", StringValue("ghi789"))
    ])
  ]
  
  // éªŒè¯æ•°æ®é›†å®Œæ•´æ€§
  assert_eq(dataset.length(), 3)
  
  // éªŒè¯æ¯ä¸ªè®°å½•çš„å®Œæ•´æ€§
  for record in dataset {
    let record_name = record.0
    let record_fields = record.1
    
    // éªŒè¯è®°å½•åç§°
    assert_true(record_name.contains("record"))
    assert_true(record_name.length() > 6)
    
    // éªŒè¯è®°å½•å­—æ®µæ•°é‡
    assert_eq(record_fields.length(), 3)
    
    // éªŒè¯IDå­—æ®µå­˜åœ¨ä¸”å”¯ä¸€
    let mut id_found = false
    let mut name_found = false
    let mut checksum_found = false
    
    for field in record_fields {
      match field.0 {
        "id" => {
          id_found = true
          match field.1 {
            IntValue(v) => assert_true(v > 0 && v <= 3)
            _ => assert_true(false)
          }
        }
        "name" => {
          name_found = true
          match field.1 {
            StringValue(v) => {
              assert_true(v.contains("Record"))
              assert_true(v.length() > 6)
            }
            _ => assert_true(false)
          }
        }
        "checksum" => {
          checksum_found = true
          match field.1 {
            StringValue(v) => assert_eq(v.length(), 6)
            _ => assert_true(false)
          }
        }
        _ => assert_true(false)
      }
    }
    
    // ç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨
    assert_true(id_found)
    assert_true(name_found)
    assert_true(checksum_found)
  }
  
  // éªŒè¯IDå”¯ä¸€æ€§
  let ids = dataset.map(fn(record) {
    for field in record.1 {
      if field.0 == "id" {
        match field.1 {
          IntValue(v) => return v
          _ => assert_true(false)
        }
      }
    }
    return -1  // ä¸åº”è¯¥åˆ°è¾¾è¿™é‡Œ
  })
  
  assert_eq(ids.length(), 3)
  assert_eq(ids[0], 1)
  assert_eq(ids[1], 2)
  assert_eq(ids[2], 3)
  
  // éªŒè¯IDå”¯ä¸€æ€§
  assert_true(ids[0] != ids[1])
  assert_true(ids[1] != ids[2])
  assert_true(ids[0] != ids[2])
}